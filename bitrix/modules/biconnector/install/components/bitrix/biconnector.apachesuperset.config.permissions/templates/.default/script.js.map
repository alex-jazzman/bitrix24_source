{"version":3,"file":"script.js","sources":["src/permissions-app.js","src/store.js","src/permissions.js"],"sourcesContent":["import { Loc, Runtime } from 'main.core';\nimport type { BitrixVueComponentProps } from 'ui.vue3';\nimport { EventEmitter, BaseEvent } from 'main.core.events';\nimport { DashboardGroup, type Group, type Dashboard, GroupType } from 'biconnector.dashboard-group';\nimport { PermissionsAnalytics, PermissionsAnalyticsSource } from 'biconnector.apache-superset-analytics';\n\nexport const PermissionsApp: BitrixVueComponentProps = {\n\tprops: {},\n\tmounted(): void\n\t{\n\t\tEventEmitter.subscribe('BX.UI.AccessRights.V2:onSectionHeaderClick', this.handleOnSectionHeaderClick);\n\t\tEventEmitter.subscribe('BX.UI.AccessRights.V2:onRightClick', this.handleOnRightClick);\n\t\tEventEmitter.subscribe('BX.UI.AccessRights.V2:onRightDelete', this.handleOnRightDelete);\n\t\tEventEmitter.subscribe('BX.UI.AccessRights.V2:additionalRightData', this.getRightDataForSave);\n\t\tEventEmitter.subscribe('BX.UI.AccessRights.V2:afterSave', this.afterSaveRights);\n\t\tEventEmitter.subscribe('BX.UI.AccessRights.V2:onResetState', this.handleResetState);\n\t\tEventEmitter.subscribe('BIConnector.GroupPopup:onGroupUpdated', this.handleGroupChange);\n\t\tEventEmitter.subscribe('BIConnector.GroupPopup:onPopupClose', this.handleGroupPopupClose);\n\t\tEventEmitter.subscribe('BIConnector.GroupPopup.DashboardScopeSelector:onDialogHide', this.handleDashboardScopeSelectorClose);\n\t\tEventEmitter.subscribe('BIConnector.GroupPopup.ScopeSelector:onDialogHide', this.handleScopeSelectorClose);\n\t\tEventEmitter.subscribe('BIConnector.GroupPopup.DashboardSelector:onDialogHide', this.handleDashboardListEdit);\n\t\tEventEmitter.subscribe('BIConnector.GroupPopup.DashboardList:onDashboardRemove', this.handleDashboardListEdit);\n\t},\n\tbeforeUnmount(): void\n\t{\n\t\tEventEmitter.unsubscribe('BX.UI.AccessRights.V2:onSectionHeaderClick', this.handleOnSectionHeaderClick);\n\t\tEventEmitter.unsubscribe('BX.UI.AccessRights.V2:onRightClick', this.handleOnRightClick);\n\t\tEventEmitter.unsubscribe('BX.UI.AccessRights.V2:onRightDelete', this.handleOnRightDelete);\n\t\tEventEmitter.unsubscribe('BX.UI.AccessRights.V2:additionalRightData', this.getRightDataForSave);\n\t\tEventEmitter.unsubscribe('BX.UI.AccessRights.V2:afterSave', this.afterSaveRights);\n\t\tEventEmitter.unsubscribe('BX.UI.AccessRights.V2:onResetState', this.handleResetState);\n\t\tEventEmitter.unsubscribe('BIConnector.GroupPopup:onGroupUpdated', this.handleGroupChange);\n\t\tEventEmitter.unsubscribe('BIConnector.GroupPopup:onPopupClose', this.handleGroupPopupClose);\n\t\tEventEmitter.unsubscribe('BIConnector.GroupPopup.DashboardScopeSelector:onDialogHide', this.handleDashboardScopeSelectorClose);\n\t\tEventEmitter.unsubscribe('BIConnector.GroupPopup.ScopeSelector:onDialogHide', this.handleScopeSelectorClose);\n\t\tEventEmitter.unsubscribe('BIConnector.GroupPopup.DashboardSelector:onDialogHide', this.handleDashboardListEdit);\n\t\tEventEmitter.unsubscribe('BIConnector.GroupPopup.DashboardList:onDashboardRemove', this.handleDashboardListEdit);\n\t},\n\tcomputed: {},\n\tmethods: {\n\t\thandleDashboardScopeSelectorClose(event: BaseEvent): void\n\t\t{\n\t\t\tif (!event.getData()?.isScopeListEdited)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tPermissionsAnalytics.sendGroupDashboardScopeEditAnalytics(\n\t\t\t\tPermissionsAnalyticsSource.permissionsSlider,\n\t\t\t);\n\t\t},\n\t\thandleDashboardListEdit(event: BaseEvent): void\n\t\t{\n\t\t\tif (!event.getData()?.isDashboardListEdited)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tPermissionsAnalytics.sendGroupDashboardEditAnalytics(\n\t\t\t\tPermissionsAnalyticsSource.permissionsSlider,\n\t\t\t);\n\t\t},\n\t\thandleScopeSelectorClose(event: BaseEvent): void\n\t\t{\n\t\t\tif (!event.getData()?.isScopeListEdited)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tPermissionsAnalytics.sendGroupScopeEditAnalytics(\n\t\t\t\tPermissionsAnalyticsSource.permissionsSlider,\n\t\t\t);\n\t\t},\n\t\thandleGroupPopupClose(event: BaseEvent): void\n\t\t{\n\t\t\tconst eventData = event.getData();\n\t\t\tconst group = eventData?.group;\n\t\t\tconst isTitleEdited = eventData?.isTitleEdited;\n\t\t\tconst isDashboardListEdited = eventData?.isDashboardListEdited;\n\t\t\tconst isScopeListEdited = eventData?.isScopeListEdited;\n\n\t\t\tif (!group || (!isTitleEdited && !isDashboardListEdited && !isScopeListEdited))\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tPermissionsAnalytics.sendGroupActionAnalytics(\n\t\t\t\tPermissionsAnalyticsSource.permissionsSlider,\n\t\t\t\tfalse,\n\t\t\t\tisDashboardListEdited,\n\t\t\t\tisScopeListEdited,\n\t\t\t);\n\t\t},\n\t\thandleOnSectionHeaderClick(event: BaseEvent): void\n\t\t{\n\t\t\tPermissionsAnalytics.sendClickGroupActionAnalytics(\n\t\t\t\tPermissionsAnalyticsSource.permissionsSlider,\n\t\t\t\ttrue,\n\t\t\t);\n\n\t\t\tconst eventData = event.getData();\n\t\t\tif (eventData.section.sectionCode === 'SECTION_RIGHTS_GROUP')\n\t\t\t{\n\t\t\t\tconst rightCodes = new Set(eventData.section.rights.keys());\n\t\t\t\tlet groupIndex = 0;\n\t\t\t\twhile (rightCodes.has(`new_G${groupIndex}`))\n\t\t\t\t{\n\t\t\t\t\tgroupIndex++;\n\t\t\t\t}\n\t\t\t\tconst newGroupCode = `new_G${groupIndex}`;\n\t\t\t\tconst right = { ...this.$store.getters.newGroupPermissions };\n\t\t\t\tright.id = newGroupCode;\n\t\t\t\tconst group: Group = {\n\t\t\t\t\tid: right.id,\n\t\t\t\t\tname: this.$Bitrix.Loc.getMessage('BI_GROUP_NEW_TITLE'),\n\t\t\t\t\ttype: GroupType.custom,\n\t\t\t\t\tdashboardIds: [],\n\t\t\t\t\tscopes: [],\n\t\t\t\t};\n\t\t\t\tthis.$store.commit('addGroup', group);\n\t\t\t\tEventEmitter.emit('BX.UI.AccessRights.V2:addRight', {\n\t\t\t\t\tguid: this.$store.getters.appGuid,\n\t\t\t\t\tsectionCode: 'SECTION_RIGHTS_GROUP',\n\t\t\t\t\tright,\n\t\t\t\t});\n\t\t\t\tthis.right = right;\n\t\t\t\tDashboardGroup.open({\n\t\t\t\t\tgroupId: Runtime.clone(right.id),\n\t\t\t\t\tgroups: Runtime.clone(this.$store.getters.groups),\n\t\t\t\t\tdashboards: Runtime.clone(this.$store.getters.dashboards),\n\t\t\t\t\tsaveEnabled: false,\n\t\t\t\t\tuser: this.$store.getters.user,\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\t\thandleOnRightClick(event: BaseEvent): void\n\t\t{\n\t\t\tPermissionsAnalytics.sendClickGroupActionAnalytics(\n\t\t\t\tPermissionsAnalyticsSource.permissionsSlider,\n\t\t\t\tfalse,\n\t\t\t);\n\n\t\t\tconst eventData = event.getData();\n\t\t\tif (eventData.right)\n\t\t\t{\n\t\t\t\t/** @type AccessRightItem */\n\t\t\t\tthis.right = eventData.right;\n\t\t\t\tconst rightId = eventData.right.id;\n\t\t\t\tDashboardGroup.open({\n\t\t\t\t\tgroupId: Runtime.clone(rightId),\n\t\t\t\t\tgroups: Runtime.clone(this.$store.getters.groups),\n\t\t\t\t\tdashboards: Runtime.clone(this.$store.getters.dashboards),\n\t\t\t\t\tsaveEnabled: false,\n\t\t\t\t\tuser: this.$store.getters.user,\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\t\thandleOnRightDelete(event: BaseEvent): void\n\t\t{\n\t\t\tPermissionsAnalytics.sendGroupDeleteAnalytics(PermissionsAnalyticsSource.permissionsSlider);\n\n\t\t\tconst eventData = event.getData();\n\t\t\tif (eventData.right)\n\t\t\t{\n\t\t\t\tthis.$store.commit('deleteGroup', eventData.right.id);\n\t\t\t}\n\t\t},\n\t\thandleGroupChange(event: BaseEvent): void\n\t\t{\n\t\t\tconst group: Group = event.getData()?.group;\n\t\t\tconst dashboards: Map<number, Dashboard> = event.getData()?.dashboards;\n\t\t\tif (!group && !dashboards)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t/** @type AccessRightItem */\n\t\t\tconst right = this.right;\n\t\t\tif (right)\n\t\t\t{\n\t\t\t\tthis.$store.commit('updateGroup', { group, dashboards });\n\t\t\t\tEventEmitter.emit('BX.UI.AccessRights.V2:updateRightTitle', {\n\t\t\t\t\tguid: this.$store.getters.appGuid,\n\t\t\t\t\tsectionCode: 'SECTION_RIGHTS_GROUP',\n\t\t\t\t\trightId: right.id,\n\t\t\t\t\trightTitle: group.name,\n\t\t\t\t});\n\t\t\t\tEventEmitter.emit('BX.UI.AccessRights.V2:updateRightSubtitle', {\n\t\t\t\t\tguid: this.$store.getters.appGuid,\n\t\t\t\t\tsectionCode: 'SECTION_RIGHTS_GROUP',\n\t\t\t\t\trightId: right.id,\n\t\t\t\t\trightSubtitle: Loc.getMessagePlural('BI_GROUP_SUBTITLE', group.dashboardIds.length, {\n\t\t\t\t\t\t'#COUNT#': group.dashboardIds.length,\n\t\t\t\t\t}),\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\t\tgetRightDataForSave(event: BaseEvent): BaseEvent\n\t\t{\n\t\t\tconst eventData = event.getData();\n\t\t\tif (eventData.right)\n\t\t\t{\n\t\t\t\tconst rightId = eventData.right.id;\n\t\t\t\tconst group = this.$store.getters.groupForSave(rightId);\n\t\t\t\tif (group)\n\t\t\t\t{\n\t\t\t\t\teventData.additionalRightData = { group };\n\t\t\t\t\tevent.setCompatData(eventData);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn event;\n\t\t},\n\t\tafterSaveRights(event: BaseEvent): void\n\t\t{\n\t\t\tconst eventData = event.getData();\n\t\t\tif (eventData.accessRights)\n\t\t\t{\n\t\t\t\tconst savedRights: [] = [...eventData.accessRights?.get('SECTION_RIGHTS_GROUP')?.rights?.values() ?? []];\n\t\t\t\tconst savedRightIds = new Set(savedRights.map((item) => item.id));\n\t\t\t\tconst groupIds = new Set();\n\t\t\t\tconst groups = this.$store.getters.groups;\n\t\t\t\tfor (const group: Group of this.$store.getters.groups)\n\t\t\t\t{\n\t\t\t\t\tgroupIds.add(group.id);\n\t\t\t\t}\n\n\t\t\t\tconst newGroupsBeforeSave = groups.filter((group: Group) => !savedRightIds.has(group.id));\n\t\t\t\tconst newGroupsAfterSave = savedRights.filter((right) => !groupIds.has(right.id));\n\n\t\t\t\tif (newGroupsBeforeSave.length > 0 && newGroupsAfterSave.length > 0)\n\t\t\t\t{\n\t\t\t\t\tfor (const newGroupBeforeSave of newGroupsBeforeSave)\n\t\t\t\t\t{\n\t\t\t\t\t\tconst possibleNewIds = newGroupsAfterSave\n\t\t\t\t\t\t\t.filter((item) => item.title === newGroupBeforeSave.name)\n\t\t\t\t\t\t\t.map((item) => item.id)\n\t\t\t\t\t\t;\n\t\t\t\t\t\tif (possibleNewIds.length === 1)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.$store.commit('updateGroupId', { oldId: newGroupBeforeSave.id, newId: possibleNewIds[0] });\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\twindow.location.reload();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis.$store.commit('setStateAsInitial');\n\t\t\t}\n\n\t\t\tif (parent?.BX)\n\t\t\t{\n\t\t\t\tparent.BX.Event.EventEmitter.emit('BIConnector.AccessRights:onRightsSaved');\n\t\t\t}\n\t\t},\n\t\thandleResetState(): void\n\t\t{\n\t\t\tthis.$store.commit('resetState');\n\t\t},\n\t},\n\ttemplate: '<template/>',\n};\n","/* eslint-disable no-param-reassign */\nimport { createStore } from 'ui.vue3.vuex';\nimport type { Group, GroupForSave, Dashboard, Scope, PermissionAppState, User } from './type';\nimport type { Group as PopupGroup } from 'biconnector.dashboard-group';\nimport { EventEmitter } from 'main.core.events';\nimport { Runtime } from 'main.core';\n\nexport class Store\n{\n\tstatic initialGroups: Group[];\n\tstatic initialDashboards: Map<number, Dashboard>;\n\n\t// eslint-disable-next-line max-lines-per-function\n\tstatic buildStore(defaultValues: PermissionAppState)\n\t{\n\t\tStore.initialGroups = Runtime.clone(defaultValues.groups);\n\t\tStore.initialDashboards = Runtime.clone(defaultValues.dashboards);\n\n\t\treturn createStore({\n\t\t\tstate(): PermissionAppState\n\t\t\t{\n\t\t\t\treturn defaultValues;\n\t\t\t},\n\t\t\tmutations: {\n\t\t\t\taddGroup(state: PermissionAppState, group: Group): void\n\t\t\t\t{\n\t\t\t\t\tstate.groups.push(group);\n\t\t\t\t},\n\t\t\t\tupdateGroup(\n\t\t\t\t\tstate: PermissionAppState,\n\t\t\t\t\tdata: { group: PopupGroup, dashboards: Map<number, Dashboard> },\n\t\t\t\t): void\n\t\t\t\t{\n\t\t\t\t\tconst updatedGroup = data.group;\n\t\t\t\t\tconst updatedDashboards = data.dashboards;\n\t\t\t\t\tconst groupIndex = state.groups.findIndex((item: Group) => item.id === updatedGroup.id);\n\t\t\t\t\tif (groupIndex < 0)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst group: Group = state.groups[groupIndex];\n\n\t\t\t\t\tgroup.name = updatedGroup.name;\n\t\t\t\t\tgroup.scopes = updatedGroup.scopes;\n\t\t\t\t\tgroup.dashboardIds = updatedGroup.dashboardIds;\n\t\t\t\t\tstate.dashboards = updatedDashboards;\n\n\t\t\t\t\tStore.checkModifiedGroups(state.groups, state.dashboards, state.appGuid);\n\t\t\t\t},\n\t\t\t\tupdateGroupId(\n\t\t\t\t\tstate: PermissionAppState,\n\t\t\t\t\tdata: { oldId: string, newId: string },\n\t\t\t\t): void\n\t\t\t\t{\n\t\t\t\t\tconst group: Group = state.groups.find((item: Group) => item.id === data.oldId);\n\t\t\t\t\tif (group)\n\t\t\t\t\t{\n\t\t\t\t\t\tgroup.id = data.newId;\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tdeleteGroup(state: PermissionAppState, groupId: string): void\n\t\t\t\t{\n\t\t\t\t\tstate.groups = state.groups.filter((group: Group) => group.id !== groupId);\n\t\t\t\t},\n\t\t\t\tresetState(state: PermissionAppState): void\n\t\t\t\t{\n\t\t\t\t\tstate.groups = Store.initialGroups;\n\t\t\t\t\tstate.dashboards = Store.initialDashboards;\n\t\t\t\t},\n\t\t\t\tsetStateAsInitial(state: PermissionAppState): void\n\t\t\t\t{\n\t\t\t\t\tStore.initialGroups = state.groups;\n\t\t\t\t\tStore.initialDashboards = state.dashboards;\n\t\t\t\t},\n\t\t\t},\n\t\t\tgetters: {\n\t\t\t\tuser(state: PermissionAppState): User\n\t\t\t\t{\n\t\t\t\t\treturn state.user;\n\t\t\t\t},\n\t\t\t\tnewGroupPermissions(state: PermissionAppState): Object\n\t\t\t\t{\n\t\t\t\t\treturn state.newGroupPermissions;\n\t\t\t\t},\n\t\t\t\tgroups(state: PermissionAppState): Group[]\n\t\t\t\t{\n\t\t\t\t\treturn state.groups;\n\t\t\t\t},\n\t\t\t\tgroup(state: PermissionAppState): (number) => ?Group\n\t\t\t\t{\n\t\t\t\t\treturn (groupId) => {\n\t\t\t\t\t\tconst group: Group = Runtime.clone(state.groups.find((item: Group) => item.id === groupId));\n\t\t\t\t\t\tif (!group)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn null;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn group;\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t\tgroupForSave(state: PermissionAppState): (number) => ?GroupForSave\n\t\t\t\t{\n\t\t\t\t\treturn (groupId) => {\n\t\t\t\t\t\tconst group = Runtime.clone(state.groups.find((item: Group) => item.id === groupId));\n\t\t\t\t\t\tif (!group)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn null;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tgroup.dashboards = [];\n\t\t\t\t\t\tfor (const dashboardId: number of group.dashboardIds)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tgroup.dashboards.push(state.dashboards.get(dashboardId));\n\t\t\t\t\t\t}\n\t\t\t\t\t\tdelete group.dashboardIds;\n\n\t\t\t\t\t\treturn group;\n\t\t\t\t\t};\n\t\t\t\t},\n\t\t\t\tdashboards(state: PermissionAppState): Map<number, Dashboard>\n\t\t\t\t{\n\t\t\t\t\treturn state.dashboards;\n\t\t\t\t},\n\t\t\t\tdashboardScopes(state: PermissionAppState): (number) => Scope[]\n\t\t\t\t{\n\t\t\t\t\treturn (dashboardId): Scope[] => state.dashboards.get(dashboardId)?.scopes ?? null;\n\t\t\t\t},\n\t\t\t\tappGuid(state: PermissionAppState): string\n\t\t\t\t{\n\t\t\t\t\treturn state.appGuid;\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t}\n\n\tstatic checkModifiedGroups(currentGroups: Group[], currentDashboards: Dashboard[], appGuid: string)\n\t{\n\t\tconst modifiedGroupIds = new Set();\n\t\tfor (const currentGroup: Group of currentGroups)\n\t\t{\n\t\t\tconst initialGroup = Store.initialGroups.find((item: Group) => item.id === currentGroup.id);\n\t\t\tif (!initialGroup)\n\t\t\t{\n\t\t\t\tmodifiedGroupIds.add(currentGroup.id);\n\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (currentGroup.name !== initialGroup.name)\n\t\t\t{\n\t\t\t\tmodifiedGroupIds.add(currentGroup.id);\n\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (initialGroup.dashboardIds.length !== currentGroup.dashboardIds.length)\n\t\t\t{\n\t\t\t\tmodifiedGroupIds.add(currentGroup.id);\n\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (!Store.areSetsEqual(\n\t\t\t\tnew Set(initialGroup.scopes.map((scope: Scope) => scope.code)),\n\t\t\t\tnew Set(currentGroup.scopes.map((scope: Scope) => scope.code)),\n\t\t\t))\n\t\t\t{\n\t\t\t\tmodifiedGroupIds.add(currentGroup.id);\n\t\t\t}\n\t\t}\n\n\t\tconst modifiedDashboardIds = new Set();\n\t\tfor (const currentDashboard: Dashboard of currentDashboards.values())\n\t\t{\n\t\t\tconst initialDashboard = Store.initialDashboards.get(currentDashboard.id);\n\t\t\tif (!initialDashboard)\n\t\t\t{\n\t\t\t\tmodifiedDashboardIds.add(currentDashboard.id);\n\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (!Store.areSetsEqual(\n\t\t\t\tnew Set(initialDashboard.scopes.map((scope: Scope) => scope.code)),\n\t\t\t\tnew Set(currentDashboard.scopes.map((scope: Scope) => scope.code)),\n\t\t\t))\n\t\t\t{\n\t\t\t\tmodifiedDashboardIds.add(currentDashboard.id);\n\t\t\t}\n\t\t}\n\n\t\tfor (const group: Group of currentGroups)\n\t\t{\n\t\t\tlet hasModifiedDashboards = false;\n\t\t\tfor (const dashboardId: number of group.dashboardIds)\n\t\t\t{\n\t\t\t\thasModifiedDashboards = hasModifiedDashboards || modifiedDashboardIds.has(dashboardId);\n\t\t\t}\n\n\t\t\tEventEmitter.emit('BX.UI.AccessRights.V2:markRightAsModified', {\n\t\t\t\tguid: appGuid,\n\t\t\t\tsectionCode: 'SECTION_RIGHTS_GROUP',\n\t\t\t\trightId: group.id,\n\t\t\t\tisModified: modifiedGroupIds.has(group.id) || hasModifiedDashboards,\n\t\t\t});\n\t\t}\n\t}\n\n\tstatic areSetsEqual(setA: Set, setB: Set): boolean\n\t{\n\t\tif (setA.size !== setB.size)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tfor (const item of setA)\n\t\t{\n\t\t\tif (!setB.has(item))\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n}\n","import { BitrixVue } from 'ui.vue3';\nimport type { Dashboard, Group, PermissionAppState } from './type';\nimport { PermissionsApp } from './permissions-app';\nimport { Store } from './store';\n\ntype initPermissionParams = {\n\tnewGroupPermissions: Object,\n\tdashboardGroups: Group[],\n\tdashboards: Map<number, Dashboard>,\n\tappGuid: string,\n}\n\nexport class Permissions\n{\n\tstatic init(params: initPermissionParams)\n\t{\n\t\tconst {\n\t\t\tnewGroupPermissions,\n\t\t\tdashboardGroups,\n\t\t\tdashboards,\n\t\t\tuser,\n\t\t\tappGuid,\n\t\t} = params;\n\t\tconst state: PermissionAppState = {\n\t\t\tgroups: dashboardGroups,\n\t\t\tdashboards: new Map(Object.entries(dashboards).map(([key, value]) => [Number(key), value])),\n\t\t\tnewGroupPermissions,\n\t\t\tappGuid,\n\t\t\tuser,\n\t\t};\n\n\t\tconst permissionsApp = BitrixVue.createApp({\n\t\t\tname: 'BIConnectorRights',\n\t\t\tdata()\n\t\t\t{\n\t\t\t\treturn {};\n\t\t\t},\n\t\t\tcomponents: {\n\t\t\t\tPermissionsApp,\n\t\t\t},\n\t\t\tcomputed: {\n\t\t\t\tcomponentName()\n\t\t\t\t{\n\t\t\t\t\treturn PermissionsApp;\n\t\t\t\t},\n\t\t\t},\n\t\t\ttemplate: `\n\t\t\t\t<PermissionsApp/>\n\t\t\t`,\n\t\t});\n\n\t\tconst store = Store.buildStore(state);\n\t\tpermissionsApp.use(store);\n\t\tpermissionsApp.mount('#bx-biconnector-role-main2');\n\t}\n}\n"],"names":["PermissionsApp","props","mounted","EventEmitter","subscribe","this","handleOnSectionHeaderClick","handleOnRightClick","handleOnRightDelete","getRightDataForSave","afterSaveRights","handleResetState","handleGroupChange","handleGroupPopupClose","handleDashboardScopeSelectorClose","handleScopeSelectorClose","handleDashboardListEdit","beforeUnmount","unsubscribe","computed","methods","event","getData","_event$getData","isScopeListEdited","PermissionsAnalytics","sendGroupDashboardScopeEditAnalytics","PermissionsAnalyticsSource","permissionsSlider","_event$getData2","isDashboardListEdited","sendGroupDashboardEditAnalytics","_event$getData3","sendGroupScopeEditAnalytics","eventData","group","isTitleEdited","sendGroupActionAnalytics","sendClickGroupActionAnalytics","section","sectionCode","rightCodes","Set","rights","keys","groupIndex","has","newGroupCode","right","$store","getters","newGroupPermissions","id","name","$Bitrix","Loc","getMessage","type","GroupType","custom","dashboardIds","scopes","commit","emit","guid","appGuid","DashboardGroup","open","groupId","Runtime","clone","groups","dashboards","saveEnabled","user","rightId","sendGroupDeleteAnalytics","_event$getData4","_event$getData5","rightTitle","rightSubtitle","getMessagePlural","length","#COUNT#","groupForSave","additionalRightData","setCompatData","_parent","accessRights","_step","savedRights","_eventData$accessRigh2","get","_eventData$accessRigh3","_eventData$accessRigh4","values","savedRightIds","map","item","groupIds","add","_iterator","newGroupsBeforeSave","filter","newGroupsAfterSave","_step2","newGroupBeforeSave","possibleNewIds","title","_this","oldId","newId","window","location","reload","_loop","_iterator2","parent","BX","Event","template","Store","babelHelpers","key","value","defaultValues","initialGroups","initialDashboards","createStore","state","mutations","addGroup","push","updateGroup","data","updatedGroup","updatedDashboards","findIndex","checkModifiedGroups","updateGroupId","find","deleteGroup","resetState","setStateAsInitial","dashboardId","dashboardScopes","_state$dashboards$get2","currentGroups","currentDashboards","modifiedGroupIds","currentGroup","initialGroup","areSetsEqual","scope","code","_step3","modifiedDashboardIds","currentDashboard","initialDashboard","_iterator3","_step4","_step5","hasModifiedDashboards","_iterator5","isModified","_iterator4","setA","setB","size","_step6","_iterator6","Permissions","params","dashboardGroups","Map","Object","entries","Number","permissionsApp","BitrixVue","createApp","components","componentName","store","buildStore","use","mount"],"mappings":"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"}