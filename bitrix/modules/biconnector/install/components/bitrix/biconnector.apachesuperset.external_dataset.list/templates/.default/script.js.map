{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import { FileExport } from 'biconnector.dataset-import.file-export';\nimport { Popup as MainPopup } from 'main.popup';\nimport { Reflection, Loc, Text, ajax as Ajax, Tag } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport { AirButtonStyle, Button, ButtonSize } from 'ui.buttons';\nimport { Dialog } from 'ui.system.dialog';\n\ntype Props = {\n\tgridId: ?string,\n\tisNeedShowTopMenuGuide: boolean,\n\tisNeedShowDraftGuide: boolean,\n};\n\n/**\n * @namespace BX.BIConnector\n */\nclass ExternalDatasetManager\n{\n\t#grid: BX.Main.grid;\n\t#filter: BX.Main.Filter;\n\n\tconstructor(props: Props)\n\t{\n\t\tthis.#grid = BX.Main.gridManager.getById(props.gridId)?.instance;\n\t\tthis.#filter = BX.Main.filterManager.getById(props.gridId);\n\t\tthis.#subscribeToEvents();\n\t\tthis.#initHints();\n\t}\n\n\t#initHints(): void\n\t{\n\t\tconst manager = BX.UI.Hint.createInstance({\n\t\t\tpopupParameters: {\n\t\t\t\tautoHide: true,\n\t\t\t},\n\t\t});\n\t\tmanager.init(this.#grid.getContainer());\n\t}\n\n\t#subscribeToEvents()\n\t{\n\t\tEventEmitter.subscribe('SidePanel.Slider:onMessage', (event) => {\n\t\t\tconst [messageEvent] = event.getData();\n\t\t\tif (messageEvent.getEventId() === 'BIConnector.dataset-import:onDatasetCreated')\n\t\t\t{\n\t\t\t\tthis.#grid.reload();\n\t\t\t}\n\t\t});\n\n\t\tEventEmitter.subscribe('Grid::updated', () => {\n\t\t\tthis.#initHints();\n\t\t});\n\t}\n\n\thandleCreatedByClick(ownerData: Object)\n\t{\n\t\tthis.handleDatasetFilterChange({\n\t\t\tfieldId: 'CREATED_BY_ID',\n\t\t\t...ownerData,\n\t\t});\n\t}\n\n\thandleUpdatedByClick(ownerData: Object)\n\t{\n\t\tthis.handleDatasetFilterChange({\n\t\t\tfieldId: 'UPDATED_BY_ID',\n\t\t\t...ownerData,\n\t\t});\n\t}\n\n\thandleSourceClick(sourceData: Object)\n\t{\n\t\tthis.handleDatasetFilterChange({\n\t\t\tfieldId: 'SOURCE.ID',\n\t\t\t...sourceData,\n\t\t});\n\t}\n\n\thandleDatasetFilterChange(fieldData: Object)\n\t{\n\t\tconst filterFieldsValues = this.#filter.getFilterFieldsValues();\n\t\tlet currentFilteredField = filterFieldsValues[fieldData.fieldId] ?? [];\n\t\tlet currentFilteredFieldLabel = filterFieldsValues[`${fieldData.fieldId}_label`] ?? [];\n\n\t\tif (fieldData.IS_FILTERED)\n\t\t{\n\t\t\tcurrentFilteredField = currentFilteredField.filter((value) => parseInt(value, 10) !== fieldData.ID);\n\t\t\tcurrentFilteredFieldLabel = currentFilteredFieldLabel.filter((value) => value !== fieldData.TITLE);\n\t\t}\n\t\telse if (!currentFilteredField.includes(fieldData.ID))\n\t\t{\n\t\t\tcurrentFilteredField.push(fieldData.ID);\n\t\t\tcurrentFilteredFieldLabel.push(fieldData.TITLE);\n\t\t}\n\n\t\tconst filterApi = this.#filter.getApi();\n\t\tconst filterToExtend = {};\n\t\tfilterToExtend[fieldData.fieldId] = currentFilteredField;\n\t\tfilterToExtend[`${fieldData.fieldId}_label`] = currentFilteredFieldLabel;\n\n\t\tfilterApi.extendFilter(filterToExtend);\n\t\tfilterApi.apply();\n\t}\n\n\texportDataset(id)\n\t{\n\t\tthis.#grid.tableFade();\n\t\tFileExport.getInstance().downloadOnce(id)\n\t\t\t.then(() => {\n\t\t\t\tthis.#grid.tableUnfade();\n\t\t\t})\n\t\t\t.catch(() => {\n\t\t\t\tthis.#grid.tableUnfade();\n\t\t\t});\n\t}\n\n\tdeleteDataset(id: number) {\n\t\tthis.#getDeleteDatasetPopup(id).show();\n\t}\n\n\t#getDeleteDatasetPopup(id: number): MainPopup\n\t{\n\t\tconst deleteDatasetPopupInstance = new Dialog({\n\t\t\ttitle: Loc.getMessage('BICONNECTOR_SUPERSET_EXTERNAL_DATASET_GRID_DELETE_POPUP_TITLE_MSGVER_1'),\n\t\t\tcontent: this.#getDeleteDatasetPopupContent(),\n\t\t\tcenterButtons: [\n\t\t\t\tnew Button({\n\t\t\t\t\ttext: Loc.getMessage('BICONNECTOR_SUPERSET_EXTERNAL_DATASET_GRID_DELETE_POPUP_CAPTION_YES'),\n\t\t\t\t\tsize: ButtonSize.LARGE,\n\t\t\t\t\tstyle: AirButtonStyle.FILLED,\n\t\t\t\t\tuseAirDesign: true,\n\t\t\t\t\tonclick: (button) => {\n\t\t\t\t\t\tbutton.setWaiting();\n\t\t\t\t\t\tthis.deleteDatasetAjaxAction(id)\n\t\t\t\t\t\t\t.then(() => {\n\t\t\t\t\t\t\t\tthis.#grid.reload();\n\t\t\t\t\t\t\t\tdeleteDatasetPopupInstance.hide();\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.catch((response) => {\n\t\t\t\t\t\t\t\tdeleteDatasetPopupInstance.hide();\n\t\t\t\t\t\t\t\tif (response.errors)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.#notifyErrors(response.errors);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t;\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t\tnew Button({\n\t\t\t\t\ttext: Loc.getMessage('BICONNECTOR_SUPERSET_EXTERNAL_DATASET_GRID_DELETE_POPUP_CAPTION_NO'),\n\t\t\t\t\tsize: ButtonSize.LARGE,\n\t\t\t\t\tstyle: AirButtonStyle.PLAIN,\n\t\t\t\t\tuseAirDesign: true,\n\t\t\t\t\tonclick: () => deleteDatasetPopupInstance.hide(),\n\t\t\t\t}),\n\t\t\t],\n\t\t\thasOverlay: true,\n\t\t\twidth: 400,\n\t\t});\n\n\t\treturn deleteDatasetPopupInstance;\n\t}\n\n\t#getDeleteDatasetPopupContent(): HTMLElement\n\t{\n\t\treturn Tag.render`\n\t\t\t<div class=\"biconnector-delete-dataset-popup-content\">\n\t\t\t\t${Loc.getMessage('BICONNECTOR_SUPERSET_EXTERNAL_DATASET_GRID_DELETE_POPUP_DESCRIPTION_MSGVER_1')}\n\t\t\t</div>\n\t\t`;\n\t}\n\n\tdeleteDatasetAjaxAction(datasetId: number): Promise\n\t{\n\t\treturn Ajax.runAction('biconnector.externalsource.dataset.delete', {\n\t\t\tdata: {\n\t\t\t\tid: datasetId,\n\t\t\t},\n\t\t});\n\t}\n\n\tcreateChart(datasetId: number): void\n\t{\n\t\tthis.#grid.tableFade();\n\t\tAjax.runAction(\n\t\t\t'biconnector.externalsource.dataset.getEditUrl',\n\t\t\t{\n\t\t\t\tdata: {\n\t\t\t\t\tid: datasetId,\n\t\t\t\t},\n\t\t\t},\n\t\t)\n\t\t\t.then((response) => {\n\t\t\t\tconst link = response.data;\n\t\t\t\tif (link)\n\t\t\t\t{\n\t\t\t\t\twindow.open(link, '_blank').focus();\n\t\t\t\t}\n\t\t\t\tthis.#grid.tableUnfade();\n\t\t\t})\n\t\t\t.catch((response) => {\n\t\t\t\tthis.#grid.tableUnfade();\n\t\t\t\tif (response.errors)\n\t\t\t\t{\n\t\t\t\t\tthis.#notifyErrors(response.errors);\n\t\t\t\t}\n\t\t\t})\n\t\t;\n\t}\n\n\tshowSupersetError(): void\n\t{\n\t\tBX.UI.Notification.Center.notify({\n\t\t\tcontent: Text.encode(Loc.getMessage('BICONNECTOR_SUPERSET_EXTERNAL_DATASET_GRID_ERROR_SUPERSET')),\n\t\t});\n\t}\n\n\t#notifyErrors(errors: Array): void\n\t{\n\t\tif (errors[0] && errors[0].message)\n\t\t{\n\t\t\tBX.UI.Notification.Center.notify({\n\t\t\t\tcontent: Text.encode(errors[0].message),\n\t\t\t});\n\t\t}\n\t}\n}\n\nReflection.namespace('BX.BIConnector').ExternalDatasetManager = ExternalDatasetManager;\n"],"names":["ExternalDatasetManager","props","BX","Main","gridManager","getById","gridId","instance","filterManager","ownerData","handleDatasetFilterChange","fieldId","sourceData","fieldData","filterFieldsValues","getFilterFieldsValues","currentFilteredField","currentFilteredFieldLabel","IS_FILTERED","filter","value","parseInt","ID","TITLE","includes","push","filterApi","getApi","filterToExtend","extendFilter","apply","id","tableFade","FileExport","getInstance","downloadOnce","then","tableUnfade","show","datasetId","Ajax","runAction","data","response","link","window","open","focus","errors","UI","Notification","Center","notify","content","Text","encode","Loc","getMessage","manager","Hint","createInstance","popupParameters","autoHide","init","getContainer","EventEmitter","subscribe","event","getData","messageEvent","getEventId","reload","deleteDatasetPopupInstance","Dialog","title","centerButtons","Button","text","size","ButtonSize","LARGE","style","AirButtonStyle","FILLED","useAirDesign","onclick","button","setWaiting","deleteDatasetAjaxAction","hide","PLAIN","hasOverlay","width","Tag","render","message","Reflection","namespace"],"mappings":"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"}