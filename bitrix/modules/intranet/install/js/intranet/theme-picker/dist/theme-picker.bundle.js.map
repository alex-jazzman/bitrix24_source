{"version":3,"file":"theme-picker.bundle.js","sources":["../src/theme-picker.js"],"sourcesContent":["import { Type, Event, Dom, Runtime, Loc, Reflection } from 'main.core';\nimport { BaseCache, MemoryCache } from 'main.core.cache';\nimport { EventEmitter } from 'main.core.events';\nimport { Popup } from 'main.popup';\nimport { ThemePickerDialog } from 'intranet.theme-picker.dialog';\nimport { Loader } from 'main.loader';\nimport { SidePanel, type SliderManager, type Slider } from 'main.sidepanel';\n\nexport type ThemePickerOptions = {\n\tthemeId?: string,\n\ttemplateId?: string,\n\ttheme?: Record<string, any>,\n\tsiteId?: string,\n\tentityType?: string,\n\tentityId?: string | number,\n\tmaxUploadSize?: number,\n\tajaxHandlerPath?: string,\n\tisAdmin?: boolean,\n\tallowSetDefaultTheme?: boolean,\n\tisVideo?: boolean,\n\tlink?: HTMLElement,\n\tbehaviour?: string,\n};\n\nexport type BaseTheme = {\n\tid: string,\n\tcss: string[],\n};\n\nexport type Theme = {\n\tid: string,\n\tcss: string[],\n\tprefetchImages?: string[],\n\tpreviewImage?: string,\n\tpreviewColor?: string,\n\twidth?: number,\n\theight?: number,\n\tresizable?: boolean,\n\tremovable: boolean,\n\tnew: boolean,\n\tcustom: boolean,\n\tstyle?: string,\n\tsort?: number,\n\tdefault?: boolean,\n\tbgImageUrlToBlur?: string,\n}\n\ntype ThemePickerInternalOptions = {\n\tthemeId?: string,\n\ttemplateId?: string,\n\tappliedThemeId?: string,\n\tappliedTheme?: Record<string, any> | null,\n\tsiteId?: string,\n\tentityType?: string,\n\tentityId?: string | number,\n\tmaxUploadSize?: number,\n\tajaxHandlerPath?: string | null,\n\tisAdmin?: boolean,\n\tallowSetDefaultTheme?: boolean,\n\tisVideo?: boolean,\n\tisBodyClassRemoved?: boolean,\n\tremovedContextClassname?: string,\n\tbehaviour?: string,\n\treturnValue?: string,\n};\n\nexport class ThemePicker\n{\n\t#cache: BaseCache<any> = new MemoryCache();\n\t#dialog: ThemePickerDialog | null = null;\n\n\tconstructor(options: ThemePickerOptions)\n\t{\n\t\tthis.#cache.set('options', {\n\t\t\tthemeId: options.themeId,\n\t\t\ttemplateId: options.templateId,\n\t\t\tappliedThemeId: options.themeId,\n\t\t\tappliedTheme: Type.isPlainObject(options.theme) ? options.theme : null,\n\t\t\tsiteId: options.siteId,\n\t\t\tentityType: options.entityType,\n\t\t\tentityId: options.entityId,\n\t\t\tmaxUploadSize: Type.isNumber(options.maxUploadSize) ? options.maxUploadSize : 5 * 1024 * 1024,\n\t\t\tajaxHandlerPath: Type.isStringFilled(options.ajaxHandlerPath) ? options.ajaxHandlerPath : null,\n\t\t\tisAdmin: options.isAdmin === true,\n\t\t\tallowSetDefaultTheme: options.allowSetDefaultTheme === true,\n\t\t\tisVideo: options.isVideo === true,\n\t\t\tbehaviour: Type.isStringFilled(options.behaviour) ? options.behaviour : 'apply',\n\t\t\treturnValue: options.behaviour === 'return' ? options.themeId : null,\n\t\t\tisBodyClassRemoved: false,\n\t\t});\n\n\t\tif (Type.isStringFilled(options?.theme.bgImageUrlToBlur))\n\t\t{\n\t\t\tthis.#trySaveBlurredImage(options.theme);\n\t\t}\n\n\t\tif (this.#getOptions().isVideo)\n\t\t{\n\t\t\tthis.#setVideoEventHandlers();\n\t\t}\n\n\t\tconst iframeMode = window !== window.top;\n\t\tif (iframeMode)\n\t\t{\n\t\t\tEventEmitter.subscribe('SidePanel.Slider:onLoad', this.#handleSliderLoad.bind(this));\n\t\t\tEventEmitter.subscribe('BX.Intranet.Bitrix24:ThemePicker:onThemeApply', this.#handleThemeApply.bind(this));\n\t\t\tEventEmitter.subscribe('BX.Intranet.Bitrix24:ThemePicker:onThemeAfterApply', this.#handleThemeAfterApply.bind(this));\n\t\t}\n\n\t\tthis.#setPrintEventHandlers();\n\t}\n\n\tshowDialog(scrollToTop: boolean = true): void\n\t{\n\t\tif (scrollToTop)\n\t\t{\n\t\t\twindow.scrollTo({\n\t\t\t\ttop: 0,\n\t\t\t\tleft: 0,\n\t\t\t});\n\t\t}\n\n\t\tconst dialogPopup = this.getDialogPopup();\n\t\tif (dialogPopup.isShown())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tdialogPopup.show();\n\t\tthis.#getLoader().show(dialogPopup.getContentContainer());\n\t\tthis.#loadThemeDialog();\n\t}\n\n\tcloseDialog(): void\n\t{\n\t\tthis.#dialog?.close();\n\t\tthis.#dialog = null;\n\n\t\tthis.getDialogPopup().close();\n\t}\n\n\tenableThemeListDialog(): void\n\t{\n\t\tDom.removeClass(\n\t\t\tthis.getDialogPopup().popupContainer,\n\t\t\t'theme-dialog-popup-window-container-disabled',\n\t\t);\n\t}\n\n\tdisableThemeListDialog()\n\t{\n\t\tDom.addClass(\n\t\t\tthis.getDialogPopup().popupContainer,\n\t\t\t'theme-dialog-popup-window-container-disabled',\n\t\t);\n\t}\n\n\tgetDialogPopup(): Popup\n\t{\n\t\treturn this.#cache.remember('dialogPopup', () => {\n\t\t\treturn new Popup({\n\t\t\t\twidth: 800,\n\t\t\t\theight: 500,\n\t\t\t\ttitleBar: Loc.getMessage('BITRIX24_THEME_DIALOG_TITLE'),\n\t\t\t\tfixed: true,\n\t\t\t\tcloseByEsc: true,\n\t\t\t\tcacheable: false,\n\t\t\t\tbindOnResize: false,\n\t\t\t\tcloseIcon: true,\n\t\t\t\tdraggable: true,\n\t\t\t\tevents: {\n\t\t\t\t\tonAfterClose: () => {\n\t\t\t\t\t\tthis.closeDialog();\n\t\t\t\t\t},\n\t\t\t\t\tonDestroy: () => {\n\t\t\t\t\t\tthis.#cache.delete('dialogPopup');\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t});\n\t\t});\n\t}\n\n\thideLoader(): void\n\t{\n\t\tthis.#getLoader().hide();\n\t}\n\n\tgetTemplateId(): ?string\n\t{\n\t\treturn this.#getOptions().templateId;\n\t}\n\n\tgetSiteId(): ?string\n\t{\n\t\treturn this.#getOptions().siteId;\n\t}\n\n\tgetEntityType(): ?string\n\t{\n\t\treturn this.#getOptions().entityType;\n\t}\n\n\tgetEntityId(): string | number | null\n\t{\n\t\treturn this.#getOptions().entityId;\n\t}\n\n\tgetAjaxHandlerPath(): ?string\n\t{\n\t\treturn this.#getOptions().ajaxHandlerPath;\n\t}\n\n\tgetVideoElement(): HTMLVideoElement\n\t{\n\t\treturn document.querySelector('.theme-video');\n\t}\n\n\tgetMaxUploadSize(): number\n\t{\n\t\treturn this.#getOptions().maxUploadSize;\n\t}\n\n\tisCurrentUserAdmin(): boolean\n\t{\n\t\treturn this.#getOptions().isAdmin;\n\t}\n\n\tcanSetDefaultTheme(): boolean\n\t{\n\t\treturn this.#getOptions().allowSetDefaultTheme;\n\t}\n\n\tgetThemeId(): string\n\t{\n\t\treturn this.#getOptions().themeId;\n\t}\n\n\tsetThemeId(themeId: string): void\n\t{\n\t\tconst options = this.#getOptions();\n\t\toptions.themeId = themeId;\n\t}\n\n\tgetAppliedThemeId(): string\n\t{\n\t\treturn this.#getOptions().appliedThemeId;\n\t}\n\n\tsetAppliedThemeId(themeId: string): void\n\t{\n\t\tconst options = this.#getOptions();\n\t\toptions.appliedThemeId = themeId;\n\t}\n\n\tgetAppliedTheme(): ?Record<string, any>\n\t{\n\t\treturn this.#getOptions().appliedTheme;\n\t}\n\n\tsetThemes(themes: Theme[]): void\n\t{\n\t\tif (Type.isArray(themes))\n\t\t{\n\t\t\tthis.#cache.set('themes', themes);\n\t\t}\n\t}\n\n\tgetThemes(): Theme[]\n\t{\n\t\treturn this.#cache.get('themes', []);\n\t}\n\n\tsetBaseThemes(themes: Object<string, BaseTheme>): void\n\t{\n\t\tif (Type.isPlainObject(themes))\n\t\t{\n\t\t\tthis.#cache.set('baseTheme', themes);\n\t\t}\n\t}\n\n\tgetBaseThemes(): Object<string, BaseTheme>\n\t{\n\t\treturn this.#cache.get('baseTheme', {});\n\t}\n\n\tgetTheme(themeId: string): Theme | null\n\t{\n\t\tconst themes = this.getThemes();\n\t\tfor (const theme of themes)\n\t\t{\n\t\t\tif (theme.id === themeId)\n\t\t\t{\n\t\t\t\treturn theme;\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tremoveTheme(themeId: string): void\n\t{\n\t\tthis.setThemes(this.getThemes().filter((theme) => theme.id !== themeId));\n\t}\n\n\tupdateTheme(themeId: string, theme: Theme): void\n\t{\n\t\tconst themes = this.getThemes();\n\t\tconst themeIndex = themes.findIndex((t) => t.id === themeId);\n\n\t\tif (themeIndex === -1 || !Type.isPlainObject(theme))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tfor (const [key, value] of Object.entries(theme))\n\t\t{\n\t\t\tthemes[themeIndex][key] = value;\n\t\t}\n\t}\n\n\tsetReturnValue(themeId: string): void\n\t{\n\t\tconst options = this.#getOptions();\n\t\toptions.returnValue = themeId;\n\t}\n\n\tgetReturnValue(): ?string\n\t{\n\t\treturn this.#getOptions().returnValue;\n\t}\n\n\tneedReturnValue(): boolean\n\t{\n\t\treturn this.#getOptions().behaviour === 'return';\n\t}\n\n\tshouldPlayVideo(): boolean\n\t{\n\t\tconst iframeMode = window !== window.top;\n\n\t\tif (iframeMode)\n\t\t{\n\t\t\treturn SidePanel.Instance.getSliderByWindow(window) === SidePanel.Instance.getTopSlider();\n\t\t}\n\n\t\treturn !SidePanel.Instance.isOpen();\n\t}\n\n\tplayVideo(): void\n\t{\n\t\tconst video = this.getVideoElement();\n\n\t\tif (video)\n\t\t{\n\t\t\tvideo.play().catch(() => {});\n\t\t}\n\t}\n\n\tpauseVideo(): void\n\t{\n\t\tconst video = this.getVideoElement();\n\n\t\tif (video)\n\t\t{\n\t\t\tvideo.pause();\n\t\t}\n\t}\n\n\thandleWindowFocus(): void\n\t{\n\t\tif (this.shouldPlayVideo())\n\t\t{\n\t\t\tthis.playVideo();\n\t\t}\n\t}\n\n\thandleWindowBlur(): void\n\t{\n\t\tthis.pauseVideo();\n\t}\n\n\thandleSliderOpen(): void\n\t{\n\t\tthis.handleWindowBlur();\n\t}\n\n\thandleSliderClose(): void\n\t{\n\t\tthis.handleWindowFocus();\n\t}\n\n\thandleVisibilityChange(): void\n\t{\n\t\tconst video = this.getVideoElement();\n\n\t\tif (video)\n\t\t{\n\t\t\tif (document.visibilityState === 'hidden')\n\t\t\t{\n\t\t\t\tthis.handleWindowBlur();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.handleWindowFocus();\n\t\t\t}\n\t\t}\n\t}\n\n\thandleBeforePrint(event): void\n\t{\n\t\twindow.scroll(0, 0);\n\n\t\tif (Dom.hasClass(document.body, 'bitrix24-light-theme'))\n\t\t{\n\t\t\tDom.removeClass(document.body, 'bitrix24-light-theme');\n\t\t\tthis.#getOptions().isBodyClassRemoved = true;\n\t\t}\n\n\t\tconst contextsToRemove = [\n\t\t\t'--ui-context-edge-dark',\n\t\t\t'--ui-context-edge-light',\n\t\t\t'--ui-context-content-dark',\n\t\t];\n\n\t\tcontextsToRemove.forEach((contextToRemove) => {\n\t\t\tif (Dom.hasClass(document.body, contextToRemove))\n\t\t\t{\n\t\t\t\tDom.removeClass(document.body, contextToRemove);\n\t\t\t\tthis.#getOptions().removedContextClassname = contextToRemove;\n\t\t\t}\n\t\t});\n\n\t\tif (this.#getOptions().removedContextClassname)\n\t\t{\n\t\t\tDom.addClass(document.body, '--ui-context-content-light');\n\t\t}\n\t}\n\n\thandleAfterPrint(): void\n\t{\n\t\tif (this.#getOptions().isBodyClassRemoved)\n\t\t{\n\t\t\tDom.addClass(document.body, 'bitrix24-light-theme');\n\t\t\tthis.#getOptions().isBodyClassRemoved = false;\n\t\t}\n\n\t\tif (this.#getOptions().removedContextClassname)\n\t\t{\n\t\t\tDom.removeClass(document.body, 'ui-context-content-light');\n\t\t\tDom.addClass(document.body, this.#getOptions().removedContextClassname);\n\t\t\tthis.#getOptions().removedContextClassname = null;\n\t\t}\n\t}\n\n\thandleMediaPrint(mql): void\n\t{\n\t\tif (mql.matches)\n\t\t{\n\t\t\tthis.handleBeforePrint();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.handleAfterPrint();\n\t\t}\n\t}\n\n\t#getCurrentSlider(): Slider | null\n\t{\n\t\tconst sliderManager: SliderManager = Reflection.getClass('top.BX.SidePanel.Instance');\n\t\tif (sliderManager === null)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn sliderManager.getSliderByWindow(window);\n\t}\n\n\t#handleSliderLoad(): void\n\t{\n\t\tthis.#applySliderTheme();\n\t}\n\n\t#handleThemeApply(): void\n\t{\n\t\tthis.#resetSliderTheme();\n\t}\n\n\t#handleThemeAfterApply(): void\n\t{\n\t\tthis.#applySliderTheme();\n\t}\n\n\t#applySliderTheme(): void\n\t{\n\t\tconst currentSlider = this.#getCurrentSlider();\n\t\tif (currentSlider === null)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst background = Dom.style(document.body, '--air-theme-background');\n\t\tif (Type.isStringFilled(background))\n\t\t{\n\t\t\tDom.style(currentSlider.getContentContainer(), 'background', background);\n\t\t\tDom.style(document.body, '--air-theme-background', 'transparent');\n\t\t}\n\t\telse\n\t\t{\n\t\t\tDom.style(currentSlider.getContentContainer(), 'background', null);\n\t\t}\n\t}\n\n\t#resetSliderTheme(): void\n\t{\n\t\tconst currentSlider = this.#getCurrentSlider();\n\t\tif (currentSlider === null)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tDom.style(document.body, '--air-theme-background', null);\n\t\tDom.style(currentSlider.getContentContainer(), 'background', null);\n\t}\n\n\tgetVideoContainer(): HTMLElement\n\t{\n\t\treturn document.querySelector('.theme-video-container');\n\t}\n\n\t#getOptions(): ThemePickerInternalOptions\n\t{\n\t\treturn this.#cache.get('options', {});\n\t}\n\n\t#setVideoEventHandlers(): void\n\t{\n\t\tEvent.bind(window, 'focus', this.handleWindowFocus.bind(this));\n\t\tEvent.bind(window, 'blur', this.handleWindowBlur.bind(this));\n\n\t\tEventEmitter.subscribe('OnIframeFocus', this.handleWindowFocus.bind(this));\n\t\tEventEmitter.subscribe('SidePanel.Slider:onOpenComplete', this.handleSliderOpen.bind(this));\n\t\tEventEmitter.subscribe('SidePanel.Slider:onCloseComplete', this.handleSliderClose.bind(this));\n\n\t\tconst eventHandler = this.handleVisibilityChange.bind(this);\n\t\tEvent.bind(window, 'load', eventHandler);\n\t\tEvent.bind(document, 'visibilitychange', eventHandler);\n\t}\n\n\t#setPrintEventHandlers(): void\n\t{\n\t\tif ('onbeforeprint' in window)\n\t\t{\n\t\t\tEvent.bind(window, 'beforeprint', this.handleBeforePrint.bind(this));\n\t\t\tEvent.bind(window, 'afterprint', this.handleAfterPrint.bind(this));\n\t\t}\n\t\telse if (window.matchMedia)\n\t\t{\n\t\t\twindow.matchMedia('print').addListener(this.handleMediaPrint.bind(this));\n\t\t}\n\t}\n\n\t#loadThemeDialog(): void\n\t{\n\t\tRuntime.loadExtension('intranet.theme-picker.dialog').then((exports) => {\n\t\t\tconst { ThemePickerDialog: Dialog } = exports;\n\t\t\tthis.#dialog ??= new Dialog(this);\n\t\t\tthis.#dialog.show();\n\t\t}).catch((error) => {\n\t\t\tconsole.error(error);\n\t\t});\n\t}\n\n\t#getLoader(): Loader\n\t{\n\t\treturn this.#cache.remember('loader', () => {\n\t\t\treturn new Loader({\n\t\t\t\tsize: 120,\n\t\t\t});\n\t\t});\n\t}\n\n\t#trySaveBlurredImage(theme: Theme): void\n\t{\n\t\tconst saveBlurredImage = async () => {\n\t\t\ttry\n\t\t\t{\n\t\t\t\tconst { ThemePickerDialog: Dialog } = await Runtime.loadExtension('intranet.theme-picker.dialog');\n\t\t\t\tconst dialog = new Dialog(this);\n\t\t\t\tawait dialog.makeCustomThemeBlurred(theme, { ignoreErrors: true, applyTheme: true });\n\t\t\t\tawait new Promise(() => {}); // Keep the lock exclusive between browser tabs\n\t\t\t}\n\t\t\tcatch (ex)\n\t\t\t{\n\t\t\t\tconsole.error(ex);\n\t\t\t}\n\t\t};\n\n\t\tif (window.navigator.locks)\n\t\t{\n\t\t\twindow.navigator.locks.request('save-blurred-image', saveBlurredImage);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tvoid saveBlurredImage();\n\t\t}\n\t}\n}\n"],"names":["ThemePicker","constructor","options","MemoryCache","set","themeId","templateId","appliedThemeId","appliedTheme","Type","isPlainObject","theme","siteId","entityType","entityId","maxUploadSize","isNumber","ajaxHandlerPath","isStringFilled","isAdmin","allowSetDefaultTheme","isVideo","behaviour","returnValue","isBodyClassRemoved","bgImageUrlToBlur","iframeMode","window","top","EventEmitter","subscribe","bind","showDialog","scrollToTop","scrollTo","left","dialogPopup","getDialogPopup","isShown","show","getContentContainer","closeDialog","close","enableThemeListDialog","Dom","removeClass","popupContainer","disableThemeListDialog","addClass","remember","Popup","width","height","titleBar","Loc","getMessage","fixed","closeByEsc","cacheable","bindOnResize","closeIcon","draggable","events","onAfterClose","onDestroy","delete","hideLoader","hide","getTemplateId","getSiteId","getEntityType","getEntityId","getAjaxHandlerPath","getVideoElement","document","querySelector","getMaxUploadSize","isCurrentUserAdmin","canSetDefaultTheme","getThemeId","setThemeId","getAppliedThemeId","setAppliedThemeId","getAppliedTheme","setThemes","themes","isArray","getThemes","get","setBaseThemes","getBaseThemes","getTheme","id","removeTheme","filter","updateTheme","themeIndex","findIndex","t","key","value","Object","entries","setReturnValue","getReturnValue","needReturnValue","shouldPlayVideo","SidePanel","Instance","getSliderByWindow","getTopSlider","isOpen","playVideo","video","play","catch","pauseVideo","pause","handleWindowFocus","handleWindowBlur","handleSliderOpen","handleSliderClose","handleVisibilityChange","visibilityState","handleBeforePrint","event","scroll","hasClass","body","contextsToRemove","forEach","contextToRemove","removedContextClassname","handleAfterPrint","handleMediaPrint","mql","matches","getVideoContainer","sliderManager","Reflection","getClass","currentSlider","background","style","Event","eventHandler","matchMedia","addListener","Runtime","loadExtension","then","exports","ThemePickerDialog","Dialog","error","console","Loader","size","saveBlurredImage","dialog","makeCustomThemeBlurred","ignoreErrors","applyTheme","Promise","ex","navigator","locks","request"],"mappings":"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"}