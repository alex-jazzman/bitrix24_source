this.BX=this.BX||{};(function(e,t,s,n,o,i,r,a){"use strict";let c=e=>e,u,l,p,d;var m=babelHelpers.classPrivateFieldLooseKey("getLoader");class h{constructor(e){Object.defineProperty(this,m,{value:_});this.accounts=[];this.currentUser=null;this.contextPopup=[];this.popup=null;this.allCounters={};this.wrapper=null;this.loader=null;this.wrapper=document.getElementById("history-items");this.loader=null;this.checkCounters(e);this.reload();this.viewDesktopUser();this.initPopup()}hideLoader(){babelHelpers.classPrivateFieldLooseBase(this,m)[m]().hide()}checkCounters(e){for(const t of Object.keys(e)){let s=t;if(t==="**"){s="live-feed"}this.allCounters[s]=e[t]}}getSumCounters(){let e=0;for(const t of Object.keys(this.allCounters)){if(t==="tasks_effective"||t==="invited_users"){continue}const s=this.allCounters[t]?parseInt(this.allCounters[t],10):0;e+=s}return e}getTabUsers(){var e;return a.Type.isUndefined(BXDesktopSystem)?[]:(e=BXDesktopSystem)==null?void 0:e.TabList()}reload(){this.reloadAccounts();this.viewPopupAccounts()}reloadAccounts(){const e=parseInt(a.Loc.getMessage("USER_ID"),10);this.accounts=a.Type.isUndefined(BXDesktopSystem)?[]:r.DesktopApi.getAccountList();this.currentUser=this.accounts.find((t=>parseInt(t.id,10)===e&&t.portal===location.hostname))}getAccountBy(e){return this.accounts.find((t=>parseInt(t.id,10)===parseInt(e.id,10)&&t.portal===e.portal))}initPopup(){const e=document.querySelector(".intranet__desktop-menu_popup");const t=document.querySelector(".intranet__desktop-menu_user-block");this.popup=new s.Popup({content:e,bindElement:t,width:320,background:"#282e39",closeIcon:true,closeByEsc:true});a.Event.bind(t,"click",(e=>{if(this.popup.isShown()){this.popup.close()}else{e.stopPropagation();this.popup.show();babelHelpers.classPrivateFieldLooseBase(this,m)[m]().hide();this.reload()}}));a.Event.bind(document,"click",(t=>{const s=t.composedPath().includes(e);if(!s){this.popup.close()}}))}setCounters(e){let t=e;if(e.data){t=e.data;if(t[0]&&a.Type.isObject(t[0])){t=t[0]}}for(const e of Object.keys(t)){let s=e;if(e==="**"){s="live-feed"}this.allCounters[s]=t[e]}const s=this.getSumCounters();const n=document.getElementsByClassName("intranet__desktop-menu_user-block")[0];const o=n==null?void 0:n.querySelector('[data-role="counter"]');if(o){if(s>0){o.innerHTML=s>99?"99+":s;if(!a.Dom.hasClass(n,"intranet__desktop-menu_item_counters")){a.Dom.addClass(n,"intranet__desktop-menu_item_counters")}}else{o.innerHTML="";a.Dom.addClass(n,"intranet__desktop-menu_item_counters")}}}removeElements(e){const t=document.getElementsByClassName(e);[...t].forEach((e=>{e.remove()}))}viewDesktopUser(){if(this.currentUser===null){return}const e=document.getElementsByClassName("intranet__desktop-menu_user")[0];const t=this.getSumCounters();let s=null;if(t>0){const e=t>99?"99+":t;s=a.Tag.render(u||(u=c`
				<div class="intranet__desktop-menu_user-counter ui-counter ui-counter-md ui-counter-danger">
					<div class="ui-counter-inner" data-role="counter">${0}</div>
				</div>
			`),e)}this.removeElements("intranet__desktop-menu_user-block");const n=a.Tag.render(l||(l=c`
			<div class="intranet__desktop-menu_user-block ${0}">
							<span class="intranet__desktop-menu_user-avatar ui-icon ui-icon-common-user ui-icon-common-user-desktop">
								<i></i>
								${0}
							</span>
							<span class="intranet__desktop-menu_user-inner">
								<span class="intranet__desktop-menu_user-name">${0}</span>
								<span class="intranet__desktop-menu_user-post">${0}</span>
							</span>
							<span class="intranet__desktop-menu_user-inner-after"></span>
						</div>
		`),t>0?"intranet__desktop-menu_item_counters":"",s,this.currentUser.portal,this.currentUser.work_position);a.Dom.append(n,e);const o=document.getElementsByClassName("ui-icon-common-user-desktop")[0];const i=this.getAvatarUrl(this.currentUser);a.Dom.style(o,"--ui-icon-service-bg-image",i)}getAvatarUrl(e){let t="";if(e.avatar.includes("http://")||e.avatar.includes("https://")){t=e.avatar}else{t=`${e.protocol}://${e.portal}${e.avatar}`}return`url('${BX.util.htmlspecialchars(e.avatar===h.defaultAvatar?h.defaultAvatarDesktop:BX.util.htmlspecialchars(t))}')`}viewPopupAccounts(){if(this.currentUser===null){return}const e=document.getElementsByClassName("intranet__desktop-menu_popup")[0];let t="";if(a.Type.isStringFilled(this.currentUser.work_position)){t=`<span class="intranet__desktop-menu_popup-post">${this.currentUser.work_position}</span>`}this.removeElements("intranet__desktop-menu_popup-header");const s=a.Tag.render(p||(p=c`
			<div class="intranet__desktop-menu_popup-header">
				<span class="intranet__desktop-menu_user-avatar ui-icon ui-icon-common-user ui-icon-common-user-popup">
					<i></i>
				</span>
				<span class="intranet__desktop-menu_popup-label">${0}</span>
				<div class="intranet__desktop-menu_popup-header-user" onclick="BX.SidePanel.Instance.open('${0}')">
					<span class="intranet__desktop-menu_popup-name intranet__desktop-menu_popup-name--chevron">
						${0}
					</span>
					${0}
				</div>
			</div>
		`),this.currentUser.portal,this.currentUser.profile,`${this.currentUser.first_name} ${this.currentUser.last_name}`,t);a.Dom.insertBefore(s,e.firstElementChild);const n=document.getElementsByClassName("ui-icon-common-user-popup")[0];const o=this.getAvatarUrl(this.currentUser);a.Dom.style(n,"--ui-icon-service-bg-image",o);const i=document.getElementsByClassName("intranet__desktop-menu_popup-list")[0];this.removeElements("intranet__desktop-menu_popup-item-account");let r=0;const u=this.getTabUsers();for(const e of this.accounts){let t="";let s="";let n=0;const o=u.some((t=>parseInt(t.id,10)===parseInt(e.id,10)&&t.portal===e.portal));if(o){if(parseInt(e.id,10)===parseInt(this.currentUser.id,10)&&e.portal===this.currentUser.portal){n=this.getSumCounters();s="--selected"}t="--connected"}const l=n>99?"99+":n;const p=a.Tag.render(d||(d=c`
				<li class="intranet__desktop-menu_popup-item intranet__desktop-menu_popup-item-account ${0} ${0} ${0}">
					<span class="intranet__desktop-menu_user-avatar ui-icon ui-icon-common-user ui-icon-common-user-${0}">
						<i></i>
						<div class="intranet__desktop-menu_user-counter ui-counter ui-counter-md ui-counter-danger">
							<div class="ui-counter-inner">${0}</div>
						</div>	
					</span>
					<span class="intranet__desktop-menu_popup-user">
						<span class="intranet__desktop-menu_popup-name">${0}</span>
						<span class="intranet__desktop-menu_popup-post">${0}</span>
					</span>
					<span class="intranet__desktop-menu_popup-btn ui-icon-set --more" id="ui-icon-set-${0}"></span>
				</li>
			`),n>0?"intranet__desktop-menu_item_counters":"",t,s,r,l,e.portal,e.login,r);a.Dom.insertBefore(p,i.children[r]);this.openTabOrConnectAccount(e,p);this.addContextMenu(e,r,o);const m=document.getElementsByClassName(`ui-icon-common-user-${r}`)[0];const h=this.getAvatarUrl(e);a.Dom.style(m,"--ui-icon-service-bg-image",h);r++}}openTabOrConnectAccount(e,t){const s=t.querySelector(".intranet__desktop-menu_popup-user");a.Event.bind(s,"click",(()=>{const t=`${e.protocol}://${e.portal}`;if(this.isAccountConnected(e)){window.open(t,"_blank");return}babelHelpers.classPrivateFieldLooseBase(this,m)[m]().show();this.connectAccount(e,(()=>{this.checkConnectedAccountAndStopLoader(e,0,this.hideLoader)}))}))}connectAccount(e,t){const{host:s,login:n,protocol:o}=e;const i=navigator.language;r.DesktopApi.connectAccount(s,n,o,i);t()}isAccountConnected(e){const t=this.getTabUsers();return t.some((t=>parseInt(t.id,10)===parseInt(e.id,10)&&t.portal===e.portal))}checkConnectedAccountAndStopLoader(e,t,s){if(t>=5){this.reload();s();return}setTimeout((()=>{this.reloadAccounts();const n=this.getAccountBy(e);if(n.connected){s()}else{this.checkConnectedAccountAndStopLoader(e,t+1,s)}}),1e3)}addContextMenu(e,t,n){const o=document.getElementById(`ui-icon-set-${t}`);if(this.contextPopup[t]){this.contextPopup[t].destroy()}this.contextPopup[t]=new s.Menu({bindElement:o,className:"intranet__desktop-menu_context",items:[n?{text:a.Loc.getMessage("MENU_ACCOUNT_POPUP_DISCONNECT"),onclick:()=>this.disconnectAccount(e,t)}:{text:a.Loc.getMessage("MENU_ACCOUNT_POPUP_CONNECT"),onclick:s=>this.connectAccountFromMenu(e,s,t)},{text:a.Loc.getMessage("MENU_ACCOUNT_POPUP_REMOVE"),onclick:async()=>this.removeAccount(e,t)}]});a.Event.bind(o,"click",(e=>this.handleContextMenu(e)))}removeAccount(e,o){t.showDesktopDeleteConfirm().then((t=>{if(t){var i;const{host:t,login:o}=e;r.DesktopApi.deleteAccount(t,o);(i=s.PopupManager.getPopupById(n.PopupType.userProfile))==null?void 0:i.close();this.reload()}this.closeContextMenu(o)}))}disconnectAccount(e,t){var s;const{host:n}=e;(s=BXDesktopSystem)==null?void 0:s.AccountDisconnect(n);this.closeContextMenu(t)}connectAccountFromMenu(e,t,s){const{host:n,login:o,protocol:i}=e;const a=navigator.language;babelHelpers.classPrivateFieldLooseBase(this,m)[m]().show();r.DesktopApi.connectAccount(n,o,i,a);t.stopPropagation();this.checkConnectedAccountAndStopLoader(e,0,(()=>{babelHelpers.classPrivateFieldLooseBase(this,m)[m]().hide();this.closeContextMenu(s)}))}handleContextMenu(e){const t=parseInt(e.target.id.replace("ui-icon-set-",""),10);if(this.contextPopup[t]){this.contextPopup[t].show()}}closeContextMenu(e){if(this.contextPopup[e]){this.contextPopup[e].close()}this.popup.close()}openLoginTab(){r.DesktopApi.openAddAccountTab()}}function _(){if(this.loader){return this.loader}this.loader=new o.Loader({target:document.querySelector(".intranet__desktop-menu_popup"),size:80,mode:"absolute",strokeWidth:4});return this.loader}h.defaultAvatar="/bitrix/js/im/images/blank.gif";h.defaultAvatarDesktop="/bitrix/js/ui/icons/b24/images/ui-user.svg?v2";class f{init(){i.EventEmitter.subscribe("onPullEvent-main",(e=>{const[t,s]=e.getCompatData();if(t==="user_counter"&&s[Loc.getMessage("SITE_ID")]){const e={...s[Loc.getMessage("SITE_ID")]};this.updateCounters(e,false)}}));BX.addCustomEvent("onPullEvent-tasks",((e,t)=>{if(e==="user_counter"&&Number(t.userId)===Number(BX.Loc.getMessage("USER_ID"))){let e={};if(!BX.Type.isUndefined(t.projects_major)){e.projects_major=t.projects_major}if(!BX.Type.isUndefined(t.scrum_total_comments)){e.scrum_total_comments=t.scrum_total_comments}this.updateCounters(e,false)}}));i.EventEmitter.subscribe("onImUpdateCounter",(e=>{const[t]=e.getCompatData();this.updateCounters(t,false)}));i.EventEmitter.subscribe("onImUpdateCounterMessage",(e=>{const[t]=e.getCompatData();this.updateCounters({"im-message":t},false)}));if(BX.browser.SupportLocalStorage()){BX.addCustomEvent(window,"onLocalStorageSet",(e=>{if(e.key.substring(0,4)==="lmc-"){let t={};t[e.key.substring(4)]=e.value;this.updateCounters(t,false)}}))}i.EventEmitter.subscribe("onCounterDecrement",(e=>{const[t]=e.getCompatData();this.decrementCounter(document.getElementById("menu-counter-live-feed"),t)}))}updateCounters(e,t){BX.ready((function(){if(BX.getClass("BX.Intranet.DescktopLeftMenu")){BX.Intranet.DescktopLeftMenu.updateCounters(e,t)}}))}decrementCounter(e,t){BX.ready((function(){if(BX.getClass("BX.Intranet.DescktopLeftMenu")){BX.Intranet.DescktopLeftMenu.decrementCounter(e,t)}}))}}class g{constructor(e,t){this.parentContainer=e;this.container=t;this.init()}init(){this.makeTextIcons()}getId(){return this.container.dataset.id}getCode(){return this.constructor.code}getName(){return this.container.querySelector("[data-role='item-text']").textContent}static detect(e){return e.getAttribute("data-role")!=="group"&&e.getAttribute("data-type")===this.code}makeTextIcons(){if(!this.container.classList.contains("menu-item-no-icon-state")){return}const e=this.container.querySelector(".menu-item-icon");const t=this.container.querySelector(".menu-item-link-text");if(e&&t){e.textContent=this.getShortName(t.textContent)}}getCounterValue(){const e=this.container.querySelector('[data-role="counter"]');if(!e){return null}return parseInt(e.dataset.counterValue)}updateCounter(e){const t=this.container.querySelector('[data-role="counter"]');if(!t){return}const s=parseInt(t.dataset.counterValue)||0;t.dataset.counterValue=e;if(e>0){t.innerHTML=e>99?"99+":e;this.container.classList.add("intranet__desktop-menu_item_counters")}else{t.innerHTML="";this.container.classList.remove("menu-item-with-index")}return{oldValue:s,newValue:e}}getShortName(e){if(!a.Type.isStringFilled(e)){return"..."}e=e.replace(/['`".,:;~|{}*^$#@&+\-=?!()[\]<>\n\r]+/g,"").trim();if(e.length<=0){return"..."}let t;let s=e.split(/[\s,]+/);if(s.length<=1){t=e.substring(0,1)}else if(s.length===2){t=s[0].substring(0,1)+s[1].substring(0,1)}else{let e=s[0];let n=s[1];for(let e=1;e<s.length;e++){if(s[e].length>3){n=s[e];break}}t=e.substring(0,1)+n.substring(0,1)}return t.toUpperCase()}}class b extends g{}b.code="admin";class v extends g{}v.code="custom";class k extends g{}k.code="standard";class C extends g{}C.code="self";class y extends g{}y.code="default";const B=[g,b,k,v,C,y];function I(e){let t=g;B.forEach((s=>{if(s.detect(e)){t=s}}));return t}var E=babelHelpers.classPrivateFieldLooseKey("updateCountersLastValue");var A=babelHelpers.classPrivateFieldLooseKey("getItemsByCounterId");class P{constructor(e){Object.defineProperty(this,A,{value:L});this.items=new Map;Object.defineProperty(this,E,{writable:true,value:null});this.parentContainer=e;this.container=e.querySelector(".menu-items");e.querySelectorAll("li.menu-item-block").forEach(this.registerItem.bind(this))}registerItem(e){const t=I(e);const s=new t(this.container,e);this.items.set(s.getId(),s);return s}updateCounters(e,t){let s=null;t=t!==false;[...Object.entries(e)].forEach((([e,n])=>{[...babelHelpers.classPrivateFieldLooseBase(this,A)[A](e)].forEach((t=>{const{oldValue:o,newValue:i}=t.updateCounter(n);if((e.indexOf("crm_")<0||e.indexOf("crm_all")>=0)&&(e.indexOf("tasks_")<0||e.indexOf("tasks_total")>=0)){s=s||0;s+=i-o}}));if(t){BX.localStorage.set("lmc-"+e,n,5)}if(typeof BXIM!=="undefined"){if(babelHelpers.classPrivateFieldLooseBase(this,E)[E]===null){babelHelpers.classPrivateFieldLooseBase(this,E)[E]=0;[...this.items.entries()].forEach((([e,t])=>{const s=t.getCounterValue();if(s>0){let n="doesNotMatter";if(e.indexOf("menu_crm")>=0||e.indexOf("menu_tasks")>=0){const e=t.container.querySelector('[data-role="counter"]');if(e){n=e.id}}if(n==="doesNotMatter"||n.indexOf("crm_all")>=0||n.indexOf("tasks_total")>=0){babelHelpers.classPrivateFieldLooseBase(this,E)[E]+=s}}}))}else{babelHelpers.classPrivateFieldLooseBase(this,E)[E]+=s!==null?s:0}const e=babelHelpers.classPrivateFieldLooseBase(this,E)[E]>99?"99+":babelHelpers.classPrivateFieldLooseBase(this,E)[E]<0?"0":babelHelpers.classPrivateFieldLooseBase(this,E)[E];if(r.DesktopApi.isDesktop()){r.DesktopApi.setBrowserIconBadge(e)}}}))}decrementCounter(e){[...Object.entries(e)].forEach((([t,s])=>{const n=babelHelpers.classPrivateFieldLooseBase(this,A)[A](t).shift();if(n){const o=n.getCounterValue();e[t]=o>s?o-s:0}else{delete e[t]}}));this.updateCounters(e,false)}}function L(e){const t=[];[...this.items.values()].forEach((s=>{const n=s.container.querySelector('[data-role="counter"]');if(n&&n.id.indexOf(e)>=0){t.push(s)}}));return t}let S=e=>e,M;class w{constructor(){this.items=[];this.wrapper=document.getElementById("history-items")}init(){var e;if("object"!=typeof BXDesktopSystem){console.log("BXDesktopSystem is empty");return}this.items=(e=BXDesktopSystem)==null?void 0:e.BrowserHistory();this.showHistory()}showHistory(){let e=0;this.items.forEach((t=>{if(e>15||!t.url.startsWith(location.origin)){return true}let s="";let n="";if(a.Type.isStringFilled(t.title)){s=this.getShortName(a.Text.encode(t.title));n=a.Text.encode(t.title)}else{if(t.url.includes("/desktop_app/")){s=Loc.getMessage("MENU_HISTORY_ITEM_ICON");n=Loc.getMessage("MENU_HISTORY_ITEM_NAME")}else{return}}if(t.url.includes("/desktop/menu")){return}let o=a.Text.encode(t.url);let i=a.Tag.render(M||(M=S`
				<li class="intranet__desktop-menu_item">
					<a class="intranet__desktop-menu_item-link" href="${0}">
						<span class="intranet__desktop-menu_item-icon --custom">${0}</span>
						<span class="intranet__desktop-menu_item-title">${0}</span>
					</a>
				</li>
			`),o,s,n);this.wrapper.appendChild(i);e++}))}getShortName(e){if(!a.Type.isStringFilled(e)){return"..."}e=e.replace(/['`".,:;~|{}*^$#@&+\-=?!()[\]<>\n\r]+/g,"").trim();if(e.length<=0){return"..."}let t;let s=e.split(/[\s,]+/);if(s.length<=1){t=e.substring(0,1)}else if(s.length===2){t=s[0].substring(0,1)+s[1].substring(0,1)}else{let e=s[0];let n=s[1];for(let e=1;e<s.length;e++){if(s[e].length>3){n=s[e];break}}t=e.substring(0,1)+n.substring(0,1)}return t.toUpperCase()}}var x=babelHelpers.classPrivateFieldLooseKey("specialLiveFeedDecrement");class D{constructor(e){this.cache=new a.Cache.MemoryCache;this.browserHistory=null;this.account=null;this.theme=null;Object.defineProperty(this,x,{writable:true,value:0});this.menuContainer=document.getElementById("menu-items-block");if(!this.menuContainer){return}this.getItemsController();this.getHistoryItems();this.showAccount(e);this.runAPICounters()}getItemsController(){return this.cache.remember("itemsMenuController",(()=>new P(this.menuContainer)))}getHistoryItems(){this.browserHistory=new w;this.browserHistory.init()}showAccount(e){this.account=new h(e);BX.Intranet.Account=this.account}runAPICounters(){BX.Intranet.Counters=new f;BX.Intranet.Counters.init()}decrementCounter(e,t){if(!e||e.id!=="menu-counter-live-feed"){return}babelHelpers.classPrivateFieldLooseBase(this,x)[x]+=parseInt(t);this.getItemsController().decrementCounter({"live-feed":parseInt(t)})}updateCounters(e,t){if(!e){return}if(e["**"]!==undefined){e["live-feed"]=e["**"];delete e["**"]}if(e["live-feed"]){if(e["live-feed"]<=0){babelHelpers.classPrivateFieldLooseBase(this,x)[x]=0}else{e["live-feed"]-=babelHelpers.classPrivateFieldLooseBase(this,x)[x]}}this.getItemsController().updateCounters(e,t);BX.Intranet.Account.setCounters(e)}}e.DesktopMenu=D})(this.BX.Intranet=this.BX.Intranet||{},BX.Messenger.v2.Lib,BX.Main,BX.Messenger.v2.Const,BX,BX.Event,BX.Messenger.v2.Lib,BX);
//# sourceMappingURL=script.map.js