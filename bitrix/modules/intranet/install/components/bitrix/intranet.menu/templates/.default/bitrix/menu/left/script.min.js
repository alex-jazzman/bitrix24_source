this.BX=this.BX||{};(function(e,t,s,n,i,o,r){"use strict";let a=e=>e,l,c,u,p;class d{constructor(e){this.accounts=[];this.currentUser=null;this.contextPopup=[];this.popup=null;this.allCounters={};this.wrapper=null;this.wrapper=document.getElementById("history-items");this.checkCounters(e);this.reload();this.viewDesktopUser();this.initPopup()}checkCounters(e){for(let t of Object.keys(e)){let s=t;if(t==="**"){s="live-feed"}this.allCounters[s]=e[t]}}getSumCounters(){let e=0;for(const t of Object.keys(this.allCounters)){if(t==="tasks_effective"||t==="invited_users"){continue}const s=this.allCounters[t]?parseInt(this.allCounters[t],10):0;e+=s}return e}getTabUses(){return"undefined"!==typeof BXDesktopSystem?BXDesktopSystem.TabList():[]}reload(){const e=parseInt(r.Loc.getMessage("USER_ID"),10);this.accounts="undefined"!==typeof BXDesktopSystem?o.DesktopApi.getAccountList():[];this.currentUser=this.accounts.find((t=>parseInt(t.id,10)===e&&t.portal===location.hostname));this.viewPopupAccounts()}initPopup(){const e=document.querySelector(".intranet__desktop-menu_user-block");this.popup=new s.Popup({content:document.querySelector(".intranet__desktop-menu_popup"),bindElement:e,width:320,background:"#282e39",closeIcon:true,closeByEsc:true});r.Event.bind(e,"click",(()=>{if(this.popup.isShown()){this.popup.close()}else{this.popup.show();this.reload()}}))}setCounters(e){let t=e;if(e["data"]){t=e.data;if(t[0]&&typeof t[0]==="object"){t=t[0]}}for(let e of Object.keys(t)){let s=e;if(e==="**"){s="live-feed"}this.allCounters[s]=t[e]}const s=this.getSumCounters();const n=document.getElementsByClassName("intranet__desktop-menu_user-block")[0];const i=n.querySelector('[data-role="counter"]');if(s>0){i.innerHTML=s>99?"99+":s;if(!r.Dom.hasClass(n,"intranet__desktop-menu_item_counters")){r.Dom.addClass(n,"intranet__desktop-menu_item_counters")}}else{i.innerHTML="";r.Dom.addClass(n,"intranet__desktop-menu_item_counters")}}removeElements(e){const t=document.getElementsByClassName(e);[...t].forEach((e=>{e.remove()}))}viewDesktopUser(){const e=document.getElementsByClassName("intranet__desktop-menu_user")[0];const t=this.getSumCounters();let s=null;if(t>0){const e=t>99?"99+":t;s=r.Tag.render(l||(l=a`
				<div class="intranet__desktop-menu_user-counter ui-counter ui-counter-md ui-counter-danger">
					<div class="ui-counter-inner" data-role="counter">${0}</div>
				</div>`),e)}this.removeElements("intranet__desktop-menu_user-block");let n=r.Tag.render(c||(c=a`<div class="intranet__desktop-menu_user-block ${0}">
				<span class="intranet__desktop-menu_user-avatar ui-icon ui-icon-common-user ui-icon-common-user-desktop">
					<i></i>
					${0}
				</span>
				<span class="intranet__desktop-menu_user-inner">
					<span class="intranet__desktop-menu_user-name">${0}</span>
					<span class="intranet__desktop-menu_user-post">${0}</span>
				</span>
			</div>`),t>0?"intranet__desktop-menu_item_counters":"",s,this.currentUser.portal,this.currentUser.work_position);r.Dom.append(n,e);const i=document.getElementsByClassName("ui-icon-common-user-desktop")[0];const o=this.getAvatarUrl(this.currentUser);r.Dom.style(i,"--ui-icon-service-bg-image",o)}getAvatarUrl(e){let t="";if(e.avatar.includes("http://")||e.avatar.includes("https://")){t=e.avatar}else{t=e.protocol+"://"+e.portal+e.avatar}return`url('${BX.util.htmlspecialchars(e.avatar===d.defaultAvatar?d.defaultAvatarDesctop:BX.util.htmlspecialchars(t))}')`}viewPopupAccounts(){const e=document.getElementsByClassName("intranet__desktop-menu_popup")[0];let t="";if(this.currentUser.work_position!==""){t=`<span class="intranet__desktop-menu_popup-post">${this.currentUser.work_position}</span>`}this.removeElements("intranet__desktop-menu_popup-header");let s=r.Tag.render(u||(u=a`<div class="intranet__desktop-menu_popup-header">
			<span class="intranet__desktop-menu_user-avatar ui-icon ui-icon-common-user ui-icon-common-user-popup">
				<i></i>
			</span>
			<span class="intranet__desktop-menu_popup-label">${0}</span>
			<div class="intranet__desktop-menu_popup-header-user">
				<span class="intranet__desktop-menu_popup-name">${0}</span>
				${0}
			</div>
		</div>`),this.currentUser.portal,this.currentUser.first_name+" "+this.currentUser.last_name,t);r.Dom.insertBefore(s,e.firstElementChild);const n=document.getElementsByClassName("ui-icon-common-user-popup")[0];const i=this.getAvatarUrl(this.currentUser);r.Dom.style(n,"--ui-icon-service-bg-image",i);const o=document.getElementsByClassName("intranet__desktop-menu_popup-list")[0];this.removeElements("intranet__desktop-menu_popup-item-account");let l=0;const c=this.getTabUses();for(let e of this.accounts){let t="";let s="";let n=0;const i=c.some((t=>parseInt(t.id,10)===parseInt(e.id,10)&&t.portal===e.portal));if(i){if(parseInt(e.id,10)===parseInt(this.currentUser.id,10)&&e.portal===this.currentUser.portal){n=this.getSumCounters();s="--selected"}t="--connected"}const u=n>99?"99+":n;let d=r.Tag.render(p||(p=a`<li class="intranet__desktop-menu_popup-item intranet__desktop-menu_popup-item-account ${0} ${0} ${0}">
					<span class="intranet__desktop-menu_user-avatar ui-icon ui-icon-common-user ui-icon-common-user-${0}">
						<i></i>
						<div class="intranet__desktop-menu_user-counter ui-counter ui-counter-md ui-counter-danger">
							<div class="ui-counter-inner">${0}</div>
						</div>	
					</span>
					<span class="intranet__desktop-menu_popup-user">
						<span class="intranet__desktop-menu_popup-name">${0}</span>
						<span class="intranet__desktop-menu_popup-post">${0}</span>
					</span>
					<span class="intranet__desktop-menu_popup-btn ui-icon-set --more" id="ui-icon-set-${0}"></span>
				</li>`),n>0?"intranet__desktop-menu_item_counters":"",t,s,l,u,e.portal,e.login,l);r.Dom.insertBefore(d,o.children[l]);this.addContextMenu(e,l,i);let m=document.getElementsByClassName("ui-icon-common-user-"+l)[0];let h=this.getAvatarUrl(e);r.Dom.style(m,"--ui-icon-service-bg-image",h);l++}}addContextMenu(e,i,a){const l=document.getElementById(`ui-icon-set-${i}`);const c=this.popup;const u=this.contextPopup;if(u[i]){u[i].destroy()}u[i]=new s.Menu({bindElement:l,className:"intranet__desktop-menu_context",items:[a?{text:r.Loc.getMessage("MENU_ACCOUNT_POPUP_DISCONNECT"),onclick:function(t,s){var n;const{host:o}=e;(n=BXDesktopSystem)==null?void 0:n.AccountDisconnect(o);if(u[i]){u[i].close()}c.close()}}:{text:r.Loc.getMessage("MENU_ACCOUNT_POPUP_CONNECT"),onclick:function(t,s){const{host:n,login:r,protocol:a}=e;const l=navigator.language;o.DesktopApi.connectAccount(n,r,a,l);if(u[i]){u[i].close()}c.close()}},{text:r.Loc.getMessage("MENU_ACCOUNT_POPUP_REMOVE"),onclick:async function(r,a){const l=await t.showDesktopDeleteConfirm();if(l===true){var p;const{host:t,login:i}=e;o.DesktopApi.deleteAccount(t,i);(p=s.PopupManager.getPopupById(n.PopupType.userProfile))==null?void 0:p.close()}if(u[i]){u[i].close()}c.close()}}]});r.Event.bind(l,"click",(e=>{const t=parseInt(e.target.id.replace("ui-icon-set-",""));if(u[t]){u[t].show()}}))}openLoginTab(){o.DesktopApi.openAddAccountTab()}}d.defaultAvatar="/bitrix/js/im/images/blank.gif";d.defaultAvatarDesctop="/bitrix/js/ui/icons/b24/images/ui-user.svg?v2";var m=babelHelpers.classPrivateFieldLooseKey("getThemePicker");var h=babelHelpers.classPrivateFieldLooseKey("applyTheme");var f=babelHelpers.classPrivateFieldLooseKey("applyPictureTheme");var _=babelHelpers.classPrivateFieldLooseKey("applyVideoTheme");class g{constructor(){var e;Object.defineProperty(this,_,{value:C});Object.defineProperty(this,f,{value:k});Object.defineProperty(this,h,{value:v});Object.defineProperty(this,m,{value:b});this.backgroundNode=null;const t=(e=babelHelpers.classPrivateFieldLooseBase(this,m)[m]())==null?void 0:e.getAppliedTheme();this.backgroundNode=document.querySelector("body");if(t){babelHelpers.classPrivateFieldLooseBase(this,h)[h](t)}i.EventEmitter.subscribe("BX.Intranet.Bitrix24:ThemePicker:onThemeApply",(e=>{babelHelpers.classPrivateFieldLooseBase(this,h)[h](e.data.theme)}))}}function b(){var e,t,s,n,i;return(e=(t=BX.Intranet)==null?void 0:(s=t.Bitrix24)==null?void 0:s.ThemePicker.Singleton)!=null?e:(n=top.BX.Intranet)==null?void 0:(i=n.Bitrix24)==null?void 0:i.ThemePicker.Singleton}function v(e){e.video?babelHelpers.classPrivateFieldLooseBase(this,_)[_](e):babelHelpers.classPrivateFieldLooseBase(this,f)[f](e);r.Dom.removeClass(this.backgroundNode,"bitrix24-theme-default bitrix24-theme-dark bitrix24-theme-light");let t="bitrix24-theme-default";if(e.id!=="default"&&String(e.id).indexOf("default:")!==0){t=String(e.id).indexOf("dark:")===0?"bitrix24-theme-dark":"bitrix24-theme-light"}r.Dom.addClass(this.backgroundNode,t)}function k(e){let t=e.previewImage;if(r.Type.isArrayFilled(e.prefetchImages)){t=e.prefetchImages[e.prefetchImages.length-1]}const s=`url('${r.Text.encode(t)}')`;r.Dom.style(this.backgroundNode,"backgroundImage",s)}function C(e){const t=[];for(let s in e.video.sources){t.push(BX.create("source",{attrs:{type:`video/${s}`,src:e.video.sources[s]}}))}const s=r.Dom.create("div",{props:{className:"theme-video-container"},dataset:{themeId:e.id},children:[r.Dom.create("video",{props:{className:"theme-video"},attrs:{poster:e.video.poster,autoplay:true,loop:true,muted:true,playsinline:true},dataset:{themeId:e.id},children:t})]});r.Dom.prepend(s,this.backgroundNode)}class y{init(){i.EventEmitter.subscribe("onPullEvent-main",(e=>{const[t,s]=e.getCompatData();if(t==="user_counter"&&s[Loc.getMessage("SITE_ID")]){const e={...s[Loc.getMessage("SITE_ID")]};this.updateCounters(e,false)}}));BX.addCustomEvent("onPullEvent-tasks",((e,t)=>{if(e==="user_counter"&&Number(t.userId)===Number(BX.Loc.getMessage("USER_ID"))){let e={};if(!BX.Type.isUndefined(t.projects_major)){e.projects_major=t.projects_major}if(!BX.Type.isUndefined(t.scrum_total_comments)){e.scrum_total_comments=t.scrum_total_comments}this.updateCounters(e,false)}}));i.EventEmitter.subscribe("onImUpdateCounter",(e=>{const[t]=e.getCompatData();this.updateCounters(t,false)}));i.EventEmitter.subscribe("onImUpdateCounterMessage",(e=>{const[t]=e.getCompatData();this.updateCounters({"im-message":t},false)}));if(BX.browser.SupportLocalStorage()){BX.addCustomEvent(window,"onLocalStorageSet",(e=>{if(e.key.substring(0,4)==="lmc-"){let t={};t[e.key.substring(4)]=e.value;this.updateCounters(t,false)}}))}i.EventEmitter.subscribe("onCounterDecrement",(e=>{const[t]=e.getCompatData();this.decrementCounter(document.getElementById("menu-counter-live-feed"),t)}))}updateCounters(e,t){BX.ready((function(){if(BX.getClass("BX.Intranet.DescktopLeftMenu")){BX.Intranet.DescktopLeftMenu.updateCounters(e,t)}}))}decrementCounter(e,t){BX.ready((function(){if(BX.getClass("BX.Intranet.DescktopLeftMenu")){BX.Intranet.DescktopLeftMenu.decrementCounter(e,t)}}))}}class B{constructor(e,t){this.parentContainer=e;this.container=t;this.init()}init(){this.makeTextIcons()}getId(){return this.container.dataset.id}getCode(){return this.constructor.code}getName(){return this.container.querySelector("[data-role='item-text']").textContent}static detect(e){return e.getAttribute("data-role")!=="group"&&e.getAttribute("data-type")===this.code}makeTextIcons(){if(!this.container.classList.contains("menu-item-no-icon-state")){return}const e=this.container.querySelector(".menu-item-icon");const t=this.container.querySelector(".menu-item-link-text");if(e&&t){e.textContent=this.getShortName(t.textContent)}}getCounterValue(){const e=this.container.querySelector('[data-role="counter"]');if(!e){return null}return parseInt(e.dataset.counterValue)}updateCounter(e){const t=this.container.querySelector('[data-role="counter"]');if(!t){return}const s=parseInt(t.dataset.counterValue)||0;t.dataset.counterValue=e;if(e>0){t.innerHTML=e>99?"99+":e;this.container.classList.add("intranet__desktop-menu_item_counters")}else{t.innerHTML="";this.container.classList.remove("menu-item-with-index")}return{oldValue:s,newValue:e}}getShortName(e){if(!r.Type.isStringFilled(e)){return"..."}e=e.replace(/['`".,:;~|{}*^$#@&+\-=?!()[\]<>\n\r]+/g,"").trim();if(e.length<=0){return"..."}let t;let s=e.split(/[\s,]+/);if(s.length<=1){t=e.substring(0,1)}else if(s.length===2){t=s[0].substring(0,1)+s[1].substring(0,1)}else{let e=s[0];let n=s[1];for(let e=1;e<s.length;e++){if(s[e].length>3){n=s[e];break}}t=e.substring(0,1)+n.substring(0,1)}return t.toUpperCase()}}class I extends B{}I.code="admin";class E extends B{}E.code="custom";class P extends B{}P.code="standard";class L extends B{}L.code="self";class D extends B{}D.code="default";const T=[B,I,P,E,L,D];function x(e){let t=B;T.forEach((s=>{if(s.detect(e)){t=s}}));return t}var S=babelHelpers.classPrivateFieldLooseKey("updateCountersLastValue");var w=babelHelpers.classPrivateFieldLooseKey("getItemsByCounterId");class X{constructor(e){Object.defineProperty(this,w,{value:M});this.items=new Map;Object.defineProperty(this,S,{writable:true,value:null});this.parentContainer=e;this.container=e.querySelector(".menu-items");e.querySelectorAll("li.menu-item-block").forEach(this.registerItem.bind(this))}registerItem(e){const t=x(e);const s=new t(this.container,e);this.items.set(s.getId(),s);return s}updateCounters(e,t){let s=null;t=t!==false;[...Object.entries(e)].forEach((([e,n])=>{[...babelHelpers.classPrivateFieldLooseBase(this,w)[w](e)].forEach((t=>{const{oldValue:i,newValue:o}=t.updateCounter(n);if((e.indexOf("crm_")<0||e.indexOf("crm_all")>=0)&&(e.indexOf("tasks_")<0||e.indexOf("tasks_total")>=0)){s=s||0;s+=o-i}}));if(t){BX.localStorage.set("lmc-"+e,n,5)}if(typeof BXIM!=="undefined"){if(babelHelpers.classPrivateFieldLooseBase(this,S)[S]===null){babelHelpers.classPrivateFieldLooseBase(this,S)[S]=0;[...this.items.entries()].forEach((([e,t])=>{const s=t.getCounterValue();if(s>0){let n="doesNotMatter";if(e.indexOf("menu_crm")>=0||e.indexOf("menu_tasks")>=0){const e=t.container.querySelector('[data-role="counter"]');if(e){n=e.id}}if(n==="doesNotMatter"||n.indexOf("crm_all")>=0||n.indexOf("tasks_total")>=0){babelHelpers.classPrivateFieldLooseBase(this,S)[S]+=s}}}))}else{babelHelpers.classPrivateFieldLooseBase(this,S)[S]+=s!==null?s:0}const e=babelHelpers.classPrivateFieldLooseBase(this,S)[S]>99?"99+":babelHelpers.classPrivateFieldLooseBase(this,S)[S]<0?"0":babelHelpers.classPrivateFieldLooseBase(this,S)[S];if(o.DesktopApi.isDesktop()){o.DesktopApi.setBrowserIconBadge(e)}}}))}decrementCounter(e){[...Object.entries(e)].forEach((([t,s])=>{const n=babelHelpers.classPrivateFieldLooseBase(this,w)[w](t).shift();if(n){const i=n.getCounterValue();e[t]=i>s?i-s:0}else{delete e[t]}}));this.updateCounters(e,false)}}function M(e){const t=[];[...this.items.values()].forEach((s=>{const n=s.container.querySelector('[data-role="counter"]');if(n&&n.id.indexOf(e)>=0){t.push(s)}}));return t}let A=e=>e,N;class U{constructor(e){this.isAir=false;this.items=[];this.isAir=e;this.wrapper=document.getElementById("history-items")}init(){var e;if("object"!=typeof BXDesktopSystem){console.log("BXDesktopSystem is empty");return}this.items=(e=BXDesktopSystem)==null?void 0:e.BrowserHistory();this.showHistory()}showHistory(){let e=0;this.items.forEach((t=>{if(e>15){return true}let s="";let n="";if(r.Type.isStringFilled(t.title)){s=this.getShortName(r.Text.encode(t.title));n=r.Text.encode(t.title)}else{if(t.url.includes("/desktop_app/")){s=Loc.getMessage("MENU_HISTORY_ITEM_ICON");n=Loc.getMessage("MENU_HISTORY_ITEM_NAME")}else{return}}if(t.url.includes("/desktop/menu")){return}let i=r.Text.encode(t.url);if(!this.isAir&&t.url.includes("/online/")){i="bx://v2/"+location.hostname+"/chat/"}let o=r.Tag.render(N||(N=A`
				<li class="intranet__desktop-menu_item">
					<a class="intranet__desktop-menu_item-link" href="${0}">
						<span class="intranet__desktop-menu_item-icon --custom">${0}</span>
						<span class="intranet__desktop-menu_item-title">${0}</span>
					</a>
				</li>
			`),i,s,n);this.wrapper.appendChild(o);e++}))}getShortName(e){if(!r.Type.isStringFilled(e)){return"..."}e=e.replace(/['`".,:;~|{}*^$#@&+\-=?!()[\]<>\n\r]+/g,"").trim();if(e.length<=0){return"..."}let t;let s=e.split(/[\s,]+/);if(s.length<=1){t=e.substring(0,1)}else if(s.length===2){t=s[0].substring(0,1)+s[1].substring(0,1)}else{let e=s[0];let n=s[1];for(let e=1;e<s.length;e++){if(s[e].length>3){n=s[e];break}}t=e.substring(0,1)+n.substring(0,1)}return t.toUpperCase()}}var H=babelHelpers.classPrivateFieldLooseKey("specialLiveFeedDecrement");class O{constructor(e,t){this.cache=new r.Cache.MemoryCache;this.browserHistory=null;this.account=null;this.theme=null;Object.defineProperty(this,H,{writable:true,value:0});this.menuContainer=document.getElementById("menu-items-block");if(!this.menuContainer){return false}this.initTheme();this.getItemsController();this.getHistoryItems(t);this.showAccount(e);this.runAPICounters()}initTheme(){this.theme=new g}getItemsController(){return this.cache.remember("itemsMenuController",(()=>new X(this.menuContainer)))}getHistoryItems(e){this.browserHistory=new U(e);this.browserHistory.init()}showAccount(e){this.account=new d(e);BX.Intranet.Account=this.account}runAPICounters(){BX.Intranet.Counters=new y;BX.Intranet.Counters.init()}decrementCounter(e,t){if(!e||e.id!=="menu-counter-live-feed"){return}babelHelpers.classPrivateFieldLooseBase(this,H)[H]+=parseInt(t);this.getItemsController().decrementCounter({"live-feed":parseInt(t)})}updateCounters(e,t){if(!e){return}if(e["**"]!==undefined){e["live-feed"]=e["**"];delete e["**"]}if(e["live-feed"]){if(e["live-feed"]<=0){babelHelpers.classPrivateFieldLooseBase(this,H)[H]=0}else{e["live-feed"]-=babelHelpers.classPrivateFieldLooseBase(this,H)[H]}}this.getItemsController().updateCounters(e,t);BX.Intranet.Account.setCounters(e)}}e.DesktopMenu=O})(this.BX.Intranet=this.BX.Intranet||{},BX.Messenger.v2.Lib,BX.Main,BX.Messenger.v2.Const,BX.Event,BX.Messenger.v2.Lib,BX);
//# sourceMappingURL=script.map.js