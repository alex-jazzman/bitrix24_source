this.BX=this.BX||{};(function(e,t,s,n,o,i,r){"use strict";let a=e=>e,u,l,c,p;class d{constructor(e){this.accounts=[];this.currentUser=null;this.contextPopup=[];this.popup=null;this.allCounters={};this.wrapper=null;this.wrapper=document.getElementById("history-items");this.checkCounters(e);this.reload();this.viewDesktopUser();this.initPopup()}checkCounters(e){for(let t of Object.keys(e)){let s=t;if(t==="**"){s="live-feed"}this.allCounters[s]=e[t]}}getSumCounters(){let e=0;for(const t of Object.keys(this.allCounters)){if(t==="tasks_effective"||t==="invited_users"){continue}const s=this.allCounters[t]?parseInt(this.allCounters[t],10):0;e+=s}return e}getTabUses(){return"undefined"!==typeof BXDesktopSystem?BXDesktopSystem.TabList():[]}reload(){const e=parseInt(r.Loc.getMessage("USER_ID"),10);this.accounts="undefined"!==typeof BXDesktopSystem?i.DesktopApi.getAccountList():[];this.currentUser=this.accounts.find((t=>parseInt(t.id,10)===e&&t.portal===location.hostname))||null;this.viewPopupAccounts()}initPopup(){const e=document.querySelector(".intranet__desktop-menu_user-block");this.popup=new s.Popup({content:document.querySelector(".intranet__desktop-menu_popup"),bindElement:e,width:320,background:"#282e39",closeIcon:true,closeByEsc:true});r.Event.bind(e,"click",(()=>{if(this.popup.isShown()){this.popup.close()}else{this.popup.show();this.reload()}}))}setCounters(e){let t=e;if(e["data"]){t=e.data;if(t[0]&&typeof t[0]==="object"){t=t[0]}}for(let e of Object.keys(t)){let s=e;if(e==="**"){s="live-feed"}this.allCounters[s]=t[e]}const s=this.getSumCounters();const n=document.getElementsByClassName("intranet__desktop-menu_user-block")[0];const o=n==null?void 0:n.querySelector('[data-role="counter"]');if(o){if(s>0){o.innerHTML=s>99?"99+":s;if(!r.Dom.hasClass(n,"intranet__desktop-menu_item_counters")){r.Dom.addClass(n,"intranet__desktop-menu_item_counters")}}else{o.innerHTML="";r.Dom.addClass(n,"intranet__desktop-menu_item_counters")}}}removeElements(e){const t=document.getElementsByClassName(e);[...t].forEach((e=>{e.remove()}))}viewDesktopUser(){if(this.currentUser===null){return}const e=document.getElementsByClassName("intranet__desktop-menu_user")[0];const t=this.getSumCounters();let s=null;if(t>0){const e=t>99?"99+":t;s=r.Tag.render(u||(u=a`
				<div class="intranet__desktop-menu_user-counter ui-counter ui-counter-md ui-counter-danger">
					<div class="ui-counter-inner" data-role="counter">${0}</div>
				</div>`),e)}this.removeElements("intranet__desktop-menu_user-block");let n=r.Tag.render(l||(l=a`<div class="intranet__desktop-menu_user-block ${0}">
				<span class="intranet__desktop-menu_user-avatar ui-icon ui-icon-common-user ui-icon-common-user-desktop">
					<i></i>
					${0}
				</span>
				<span class="intranet__desktop-menu_user-inner">
					<span class="intranet__desktop-menu_user-name">${0}</span>
					<span class="intranet__desktop-menu_user-post">${0}</span>
				</span>
			</div>`),t>0?"intranet__desktop-menu_item_counters":"",s,this.currentUser.portal,this.currentUser.work_position);r.Dom.append(n,e);const o=document.getElementsByClassName("ui-icon-common-user-desktop")[0];const i=this.getAvatarUrl(this.currentUser);r.Dom.style(o,"--ui-icon-service-bg-image",i)}getAvatarUrl(e){let t="";if(e.avatar.includes("http://")||e.avatar.includes("https://")){t=e.avatar}else{t=e.protocol+"://"+e.portal+e.avatar}return`url('${BX.util.htmlspecialchars(e.avatar===d.defaultAvatar?d.defaultAvatarDesctop:BX.util.htmlspecialchars(t))}')`}viewPopupAccounts(){if(this.currentUser===null){return}const e=document.getElementsByClassName("intranet__desktop-menu_popup")[0];let t="";if(this.currentUser.work_position!==""){t=`<span class="intranet__desktop-menu_popup-post">${this.currentUser.work_position}</span>`}this.removeElements("intranet__desktop-menu_popup-header");let s=r.Tag.render(c||(c=a`<div class="intranet__desktop-menu_popup-header">
			<span class="intranet__desktop-menu_user-avatar ui-icon ui-icon-common-user ui-icon-common-user-popup">
				<i></i>
			</span>
			<span class="intranet__desktop-menu_popup-label">${0}</span>
			<div class="intranet__desktop-menu_popup-header-user">
				<span class="intranet__desktop-menu_popup-name">${0}</span>
				${0}
			</div>
		</div>`),this.currentUser.portal,this.currentUser.first_name+" "+this.currentUser.last_name,t);r.Dom.insertBefore(s,e.firstElementChild);const n=document.getElementsByClassName("ui-icon-common-user-popup")[0];const o=this.getAvatarUrl(this.currentUser);r.Dom.style(n,"--ui-icon-service-bg-image",o);const i=document.getElementsByClassName("intranet__desktop-menu_popup-list")[0];this.removeElements("intranet__desktop-menu_popup-item-account");let u=0;const l=this.getTabUses();for(let e of this.accounts){let t="";let s="";let n=0;const o=l.some((t=>parseInt(t.id,10)===parseInt(e.id,10)&&t.portal===e.portal));if(o){if(parseInt(e.id,10)===parseInt(this.currentUser.id,10)&&e.portal===this.currentUser.portal){n=this.getSumCounters();s="--selected"}t="--connected"}const c=n>99?"99+":n;let d=r.Tag.render(p||(p=a`<li class="intranet__desktop-menu_popup-item intranet__desktop-menu_popup-item-account ${0} ${0} ${0}">
					<span class="intranet__desktop-menu_user-avatar ui-icon ui-icon-common-user ui-icon-common-user-${0}">
						<i></i>
						<div class="intranet__desktop-menu_user-counter ui-counter ui-counter-md ui-counter-danger">
							<div class="ui-counter-inner">${0}</div>
						</div>	
					</span>
					<span class="intranet__desktop-menu_popup-user">
						<span class="intranet__desktop-menu_popup-name">${0}</span>
						<span class="intranet__desktop-menu_popup-post">${0}</span>
					</span>
					<span class="intranet__desktop-menu_popup-btn ui-icon-set --more" id="ui-icon-set-${0}"></span>
				</li>`),n>0?"intranet__desktop-menu_item_counters":"",t,s,u,c,e.portal,e.login,u);r.Dom.insertBefore(d,i.children[u]);this.addContextMenu(e,u,o);let m=document.getElementsByClassName("ui-icon-common-user-"+u)[0];let h=this.getAvatarUrl(e);r.Dom.style(m,"--ui-icon-service-bg-image",h);u++}}addContextMenu(e,o,a){const u=document.getElementById(`ui-icon-set-${o}`);const l=this.popup;const c=this.contextPopup;if(c[o]){c[o].destroy()}c[o]=new s.Menu({bindElement:u,className:"intranet__desktop-menu_context",items:[a?{text:r.Loc.getMessage("MENU_ACCOUNT_POPUP_DISCONNECT"),onclick:function(t,s){var n;const{host:i}=e;(n=BXDesktopSystem)==null?void 0:n.AccountDisconnect(i);if(c[o]){c[o].close()}l.close()}}:{text:r.Loc.getMessage("MENU_ACCOUNT_POPUP_CONNECT"),onclick:function(t,s){const{host:n,login:r,protocol:a}=e;const u=navigator.language;i.DesktopApi.connectAccount(n,r,a,u);if(c[o]){c[o].close()}l.close()}},{text:r.Loc.getMessage("MENU_ACCOUNT_POPUP_REMOVE"),onclick:async function(r,a){const u=await t.showDesktopDeleteConfirm();if(u===true){var p;const{host:t,login:o}=e;i.DesktopApi.deleteAccount(t,o);(p=s.PopupManager.getPopupById(n.PopupType.userProfile))==null?void 0:p.close()}if(c[o]){c[o].close()}l.close()}}]});r.Event.bind(u,"click",(e=>{const t=parseInt(e.target.id.replace("ui-icon-set-",""));if(c[t]){c[t].show()}}))}openLoginTab(){i.DesktopApi.openAddAccountTab()}}d.defaultAvatar="/bitrix/js/im/images/blank.gif";d.defaultAvatarDesctop="/bitrix/js/ui/icons/b24/images/ui-user.svg?v2";class m{init(){o.EventEmitter.subscribe("onPullEvent-main",(e=>{const[t,s]=e.getCompatData();if(t==="user_counter"&&s[Loc.getMessage("SITE_ID")]){const e={...s[Loc.getMessage("SITE_ID")]};this.updateCounters(e,false)}}));BX.addCustomEvent("onPullEvent-tasks",((e,t)=>{if(e==="user_counter"&&Number(t.userId)===Number(BX.Loc.getMessage("USER_ID"))){let e={};if(!BX.Type.isUndefined(t.projects_major)){e.projects_major=t.projects_major}if(!BX.Type.isUndefined(t.scrum_total_comments)){e.scrum_total_comments=t.scrum_total_comments}this.updateCounters(e,false)}}));o.EventEmitter.subscribe("onImUpdateCounter",(e=>{const[t]=e.getCompatData();this.updateCounters(t,false)}));o.EventEmitter.subscribe("onImUpdateCounterMessage",(e=>{const[t]=e.getCompatData();this.updateCounters({"im-message":t},false)}));if(BX.browser.SupportLocalStorage()){BX.addCustomEvent(window,"onLocalStorageSet",(e=>{if(e.key.substring(0,4)==="lmc-"){let t={};t[e.key.substring(4)]=e.value;this.updateCounters(t,false)}}))}o.EventEmitter.subscribe("onCounterDecrement",(e=>{const[t]=e.getCompatData();this.decrementCounter(document.getElementById("menu-counter-live-feed"),t)}))}updateCounters(e,t){BX.ready((function(){if(BX.getClass("BX.Intranet.DescktopLeftMenu")){BX.Intranet.DescktopLeftMenu.updateCounters(e,t)}}))}decrementCounter(e,t){BX.ready((function(){if(BX.getClass("BX.Intranet.DescktopLeftMenu")){BX.Intranet.DescktopLeftMenu.decrementCounter(e,t)}}))}}class h{constructor(e,t){this.parentContainer=e;this.container=t;this.init()}init(){this.makeTextIcons()}getId(){return this.container.dataset.id}getCode(){return this.constructor.code}getName(){return this.container.querySelector("[data-role='item-text']").textContent}static detect(e){return e.getAttribute("data-role")!=="group"&&e.getAttribute("data-type")===this.code}makeTextIcons(){if(!this.container.classList.contains("menu-item-no-icon-state")){return}const e=this.container.querySelector(".menu-item-icon");const t=this.container.querySelector(".menu-item-link-text");if(e&&t){e.textContent=this.getShortName(t.textContent)}}getCounterValue(){const e=this.container.querySelector('[data-role="counter"]');if(!e){return null}return parseInt(e.dataset.counterValue)}updateCounter(e){const t=this.container.querySelector('[data-role="counter"]');if(!t){return}const s=parseInt(t.dataset.counterValue)||0;t.dataset.counterValue=e;if(e>0){t.innerHTML=e>99?"99+":e;this.container.classList.add("intranet__desktop-menu_item_counters")}else{t.innerHTML="";this.container.classList.remove("menu-item-with-index")}return{oldValue:s,newValue:e}}getShortName(e){if(!r.Type.isStringFilled(e)){return"..."}e=e.replace(/['`".,:;~|{}*^$#@&+\-=?!()[\]<>\n\r]+/g,"").trim();if(e.length<=0){return"..."}let t;let s=e.split(/[\s,]+/);if(s.length<=1){t=e.substring(0,1)}else if(s.length===2){t=s[0].substring(0,1)+s[1].substring(0,1)}else{let e=s[0];let n=s[1];for(let e=1;e<s.length;e++){if(s[e].length>3){n=s[e];break}}t=e.substring(0,1)+n.substring(0,1)}return t.toUpperCase()}}class _ extends h{}_.code="admin";class f extends h{}f.code="custom";class g extends h{}g.code="standard";class v extends h{}v.code="self";class b extends h{}b.code="default";const k=[h,_,g,f,v,b];function C(e){let t=h;k.forEach((s=>{if(s.detect(e)){t=s}}));return t}var y=babelHelpers.classPrivateFieldLooseKey("updateCountersLastValue");var B=babelHelpers.classPrivateFieldLooseKey("getItemsByCounterId");class I{constructor(e){Object.defineProperty(this,B,{value:E});this.items=new Map;Object.defineProperty(this,y,{writable:true,value:null});this.parentContainer=e;this.container=e.querySelector(".menu-items");e.querySelectorAll("li.menu-item-block").forEach(this.registerItem.bind(this))}registerItem(e){const t=C(e);const s=new t(this.container,e);this.items.set(s.getId(),s);return s}updateCounters(e,t){let s=null;t=t!==false;[...Object.entries(e)].forEach((([e,n])=>{[...babelHelpers.classPrivateFieldLooseBase(this,B)[B](e)].forEach((t=>{const{oldValue:o,newValue:i}=t.updateCounter(n);if((e.indexOf("crm_")<0||e.indexOf("crm_all")>=0)&&(e.indexOf("tasks_")<0||e.indexOf("tasks_total")>=0)){s=s||0;s+=i-o}}));if(t){BX.localStorage.set("lmc-"+e,n,5)}if(typeof BXIM!=="undefined"){if(babelHelpers.classPrivateFieldLooseBase(this,y)[y]===null){babelHelpers.classPrivateFieldLooseBase(this,y)[y]=0;[...this.items.entries()].forEach((([e,t])=>{const s=t.getCounterValue();if(s>0){let n="doesNotMatter";if(e.indexOf("menu_crm")>=0||e.indexOf("menu_tasks")>=0){const e=t.container.querySelector('[data-role="counter"]');if(e){n=e.id}}if(n==="doesNotMatter"||n.indexOf("crm_all")>=0||n.indexOf("tasks_total")>=0){babelHelpers.classPrivateFieldLooseBase(this,y)[y]+=s}}}))}else{babelHelpers.classPrivateFieldLooseBase(this,y)[y]+=s!==null?s:0}const e=babelHelpers.classPrivateFieldLooseBase(this,y)[y]>99?"99+":babelHelpers.classPrivateFieldLooseBase(this,y)[y]<0?"0":babelHelpers.classPrivateFieldLooseBase(this,y)[y];if(i.DesktopApi.isDesktop()){i.DesktopApi.setBrowserIconBadge(e)}}}))}decrementCounter(e){[...Object.entries(e)].forEach((([t,s])=>{const n=babelHelpers.classPrivateFieldLooseBase(this,B)[B](t).shift();if(n){const o=n.getCounterValue();e[t]=o>s?o-s:0}else{delete e[t]}}));this.updateCounters(e,false)}}function E(e){const t=[];[...this.items.values()].forEach((s=>{const n=s.container.querySelector('[data-role="counter"]');if(n&&n.id.indexOf(e)>=0){t.push(s)}}));return t}let D=e=>e,L;class w{constructor(e){this.isAir=false;this.items=[];this.isAir=e;this.wrapper=document.getElementById("history-items")}init(){var e;if("object"!=typeof BXDesktopSystem){console.log("BXDesktopSystem is empty");return}this.items=(e=BXDesktopSystem)==null?void 0:e.BrowserHistory();this.showHistory()}showHistory(){let e=0;this.items.forEach((t=>{if(e>15){return true}let s="";let n="";if(r.Type.isStringFilled(t.title)){s=this.getShortName(r.Text.encode(t.title));n=r.Text.encode(t.title)}else{if(t.url.includes("/desktop_app/")){s=Loc.getMessage("MENU_HISTORY_ITEM_ICON");n=Loc.getMessage("MENU_HISTORY_ITEM_NAME")}else{return}}if(t.url.includes("/desktop/menu")){return}let o=r.Text.encode(t.url);if(!this.isAir&&t.url.includes("/online/")){o="bx://v2/"+location.hostname+"/chat/"}let i=r.Tag.render(L||(L=D`
				<li class="intranet__desktop-menu_item">
					<a class="intranet__desktop-menu_item-link" href="${0}">
						<span class="intranet__desktop-menu_item-icon --custom">${0}</span>
						<span class="intranet__desktop-menu_item-title">${0}</span>
					</a>
				</li>
			`),o,s,n);this.wrapper.appendChild(i);e++}))}getShortName(e){if(!r.Type.isStringFilled(e)){return"..."}e=e.replace(/['`".,:;~|{}*^$#@&+\-=?!()[\]<>\n\r]+/g,"").trim();if(e.length<=0){return"..."}let t;let s=e.split(/[\s,]+/);if(s.length<=1){t=e.substring(0,1)}else if(s.length===2){t=s[0].substring(0,1)+s[1].substring(0,1)}else{let e=s[0];let n=s[1];for(let e=1;e<s.length;e++){if(s[e].length>3){n=s[e];break}}t=e.substring(0,1)+n.substring(0,1)}return t.toUpperCase()}}var S=babelHelpers.classPrivateFieldLooseKey("specialLiveFeedDecrement");class M{constructor(e,t){this.cache=new r.Cache.MemoryCache;this.browserHistory=null;this.account=null;this.theme=null;Object.defineProperty(this,S,{writable:true,value:0});this.menuContainer=document.getElementById("menu-items-block");if(!this.menuContainer){return}this.getItemsController();this.getHistoryItems(t);this.showAccount(e);this.runAPICounters()}getItemsController(){return this.cache.remember("itemsMenuController",(()=>new I(this.menuContainer)))}getHistoryItems(e){this.browserHistory=new w(e);this.browserHistory.init()}showAccount(e){this.account=new d(e);BX.Intranet.Account=this.account}runAPICounters(){BX.Intranet.Counters=new m;BX.Intranet.Counters.init()}decrementCounter(e,t){if(!e||e.id!=="menu-counter-live-feed"){return}babelHelpers.classPrivateFieldLooseBase(this,S)[S]+=parseInt(t);this.getItemsController().decrementCounter({"live-feed":parseInt(t)})}updateCounters(e,t){if(!e){return}if(e["**"]!==undefined){e["live-feed"]=e["**"];delete e["**"]}if(e["live-feed"]){if(e["live-feed"]<=0){babelHelpers.classPrivateFieldLooseBase(this,S)[S]=0}else{e["live-feed"]-=babelHelpers.classPrivateFieldLooseBase(this,S)[S]}}this.getItemsController().updateCounters(e,t);BX.Intranet.Account.setCounters(e)}}e.DesktopMenu=M})(this.BX.Intranet=this.BX.Intranet||{},BX.Messenger.v2.Lib,BX.Main,BX.Messenger.v2.Const,BX.Event,BX.Messenger.v2.Lib,BX);
//# sourceMappingURL=script.map.js