{"version":3,"file":"onboarding-popup.bundle.js","sources":["../src/onboarding-popup.js"],"sourcesContent":["import { Builder, Dictionary } from 'crm.integration.analytics';\nimport { BannerDispatcher, Priority } from 'crm.integration.ui.banner-dispatcher';\nimport { Dom, Extension, Loc, Tag } from 'main.core';\nimport type { PopupOptions } from 'main.popup';\nimport { Popup } from 'main.popup';\nimport { sendData } from 'ui.analytics';\nimport { AirButtonStyle, Button as UiButton } from 'ui.buttons';\nimport { Icon, Outline as OutlineIconSet } from 'ui.icon-set.api.core';\nimport 'ui.icon-set.actions';\nimport 'ui.design-tokens';\nimport 'ui.design-tokens.air';\nimport './onboarding-popup.css';\n\nconst MAX_STEP_NUMBER = 3;\n\ntype OnboardingPopupOptions = {\n\tcloseOptionName: string;\n\tcloseOptionCategory: string;\n\tanalytics?: Object;\n};\n\nexport class OnboardingPopup\n{\n\t#bannerDispatcher: ?BannerDispatcher = null;\n\t#popup: ?Popup = null;\n\t#originalOverflowValue: ?string = null;\n\t#targetContainer: ?HTMLElement = null;\n\t#step: number = 0;\n\t#closeOptionName: ?string = null;\n\t#closeOptionCategory: ?string = null;\n\t#analytics: ?Object = null;\n\n\tconstructor(params: OnboardingPopupOptions)\n\t{\n\t\tthis.#closeOptionName = params?.closeOptionName ?? null;\n\t\tthis.#closeOptionCategory = params?.closeOptionCategory ?? null;\n\t\tthis.#analytics = params?.analytics ?? {};\n\t}\n\n\tshow(): void\n\t{\n\t\tif (this.#getPopup().isShown())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#bannerDispatcher = new BannerDispatcher();\n\n\t\tthis.#bannerDispatcher.toQueue(\n\t\t\t(onDone: Function): void => {\n\t\t\t\tthis.#setTargetOverflow('hidden');\n\t\t\t\tthis.#getPopup().subscribe('onAfterClose', onDone);\n\t\t\t\tthis.#getPopup().show();\n\t\t\t},\n\t\t\tPriority.CRITICAL,\n\t\t);\n\t}\n\n\t#getPopup(): Popup\n\t{\n\t\tif (this.#popup === null)\n\t\t{\n\t\t\tthis.#popup = this.#createPopup();\n\t\t}\n\n\t\treturn this.#popup;\n\t}\n\n\t#createPopup(): Popup\n\t{\n\t\treturn new Popup(this.#getPopupParams());\n\t}\n\n\t#getPopupParams(): PopupOptions\n\t{\n\t\treturn {\n\t\t\tid: 'crm_repeat_sale_onboarding_popup',\n\t\t\ttargetContainer: this.#getTarget(),\n\t\t\tcontent: this.#getPopupContent(),\n\t\t\tcacheable: true,\n\t\t\tisScrollBlock: false,\n\t\t\tclassName: 'crm-repeat-sale-onboarding-popup',\n\t\t\tcloseByEsc: true,\n\t\t\tcloseIcon: true,\n\t\t\tpadding: 16,\n\t\t\twidth: 733,\n\t\t\toverlay: {\n\t\t\t\topacity: 40,\n\t\t\t\tbackgroundColor: '#000000',\n\t\t\t},\n\t\t\tanimation: 'fading-slide',\n\t\t\tautoHide: false,\n\t\t\tevents: {\n\t\t\t\tonFirstShow: () => {\n\t\t\t\t\tthis.#sendViewAnalytics();\n\t\t\t\t},\n\t\t\t\tonclose: () => {\n\t\t\t\t\tthis.#resetTargetOverflow();\n\t\t\t\t\tBX.userOptions.save(this.#closeOptionCategory, this.#closeOptionName, 'closed', 'Y');\n\n\t\t\t\t\tthis.#sendCloseAnalytics();\n\t\t\t\t},\n\t\t\t},\n\t\t};\n\t}\n\n\t#getPopupContent(): HTMLElement\n\t{\n\t\tconst icon = new Icon({\n\t\t\tsize: 29,\n\t\t\tcolor: '#853AF5',\n\t\t\ticon: OutlineIconSet.COPILOT,\n\t\t});\n\n\t\treturn Tag.render`\n\t\t\t<div class=\"crm-repeat-sale__onboarding-popup-container\">\n\t\t\t\t<div class=\"crm-repeat-sale__onboarding-popup-title\">\n\t\t\t\t\t${Loc.getMessage('CRM_REPEAT_SALE_ONBOARDING_TITLE')}\n\t\t\t\t\t${icon.render()}\n\t\t\t\t</div>\n\t\t\t\t<div class=\"crm-repeat-sale__onboarding-popup-video\">\n\t\t\t\t\t<div>\n\t\t\t\t\t\t${this.#renderVideo()}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"crm-repeat-sale__onboarding-popup-content\">\n\t\t\t\t\t${this.#getStepContent()}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t#renderVideo(): HTMLElement\n\t{\n\t\tconst videoElement = Tag.render`\n\t\t\t<video\n\t\t\t\tsrc=\"${this.#getVideoPath()}\"\n\t\t\t\tautoplay\n\t\t\t\tpreload\n\t\t\t\tloop\n\t\t\t></video>\n\t\t`;\n\n\t\t// eslint-disable-next-line @bitrix24/bitrix24-rules/no-native-events-binding\n\t\tvideoElement.addEventListener('canplay', () => {\n\t\t\tvideoElement.muted = true;\n\t\t\tvideoElement.play();\n\t\t});\n\n\t\treturn videoElement;\n\t}\n\n\t#getVideoPath(): string\n\t{\n\t\tconst region = Extension.getSettings('crm.repeat-sale.onboarding-popup').get('region');\n\n\t\tlet name = 'how-it-work-en';\n\t\tif (['kz', 'ru', 'by'].includes(region))\n\t\t{\n\t\t\tname = 'how-it-work-ru';\n\t\t}\n\n\t\treturn `/bitrix/js/crm/repeat-sale/onboarding-popup/video/${name}.webm`;\n\t}\n\n\t#getStepContent(): HTMLElement\n\t{\n\t\treturn Tag.render`\n\t\t\t<div class=\"crm-repeat-sale__onboarding-popup-step-container\">\n\t\t\t\t<div class=\"crm-repeat-sale__onboarding-popup-step-text\">\n\t\t\t\t\t${Loc.getMessage(`CRM_REPEAT_SALE_ONBOARDING_TEXT_STEP_${this.#step}`)}\n\t\t\t\t</div>\n\t\t\t\t<div class=\"crm-repeat-sale__onboarding-popup-button\">\n\t\t\t\t\t${this.#getButton().render()}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t#getButton(): UiButton\n\t{\n\t\tconst style = this.#isLastStep() ? AirButtonStyle.TINTED : AirButtonStyle.FILLED_COPILOT;\n\t\tconst icon = this.#isLastStep() ? OutlineIconSet.CHECK_M : OutlineIconSet.NEXT;\n\n\t\treturn new UiButton({\n\t\t\tuseAirDesign: true,\n\t\t\ttext: this.#getButtonText(),\n\t\t\tround: true,\n\t\t\tsize: BX.UI.Button.Size.LARGE,\n\t\t\ticon,\n\t\t\tstyle,\n\t\t\tonclick: () => {\n\t\t\t\tif (this.#isLastStep())\n\t\t\t\t{\n\t\t\t\t\tthis.#getPopup().close();\n\t\t\t\t\tthis.#getPopup().destroy();\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.#goToNextStep();\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\t}\n\n\t#getButtonText(): string\n\t{\n\t\tconst code = (\n\t\t\tthis.#isLastStep()\n\t\t\t\t? 'CRM_REPEAT_SALE_ONBOARDING_BUTTON_CLOSE'\n\t\t\t\t: 'CRM_REPEAT_SALE_ONBOARDING_BUTTON_NEXT'\n\t\t);\n\n\t\treturn Loc.getMessage(code);\n\t}\n\n\t#isLastStep(): boolean\n\t{\n\t\treturn this.#step === MAX_STEP_NUMBER;\n\t}\n\n\t#goToNextStep(): void\n\t{\n\t\tthis.#step++;\n\n\t\tDom.replace(\n\t\t\tdocument.querySelector('.crm-repeat-sale__onboarding-popup-step-container'),\n\t\t\tthis.#getStepContent(),\n\t\t);\n\n\t\tthis.#sendClickAnalytics();\n\t}\n\n\t#setTargetOverflow(value: string): void\n\t{\n\t\tthis.#originalOverflowValue = Dom.style(this.#getTarget(), 'overflow');\n\t\tDom.style(this.#getTarget(), 'overflow', value);\n\t}\n\n\t#resetTargetOverflow(): void\n\t{\n\t\tif (this.#originalOverflowValue === null)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tDom.style(this.#getTarget(), 'overflow', this.#originalOverflowValue);\n\t\tthis.#originalOverflowValue = null;\n\t}\n\n\t#getTarget(): HTMLElement\n\t{\n\t\tif (this.#targetContainer === null)\n\t\t{\n\t\t\tthis.#targetContainer = document.body;\n\t\t}\n\n\t\treturn this.#targetContainer;\n\t}\n\n\t#sendViewAnalytics(): void\n\t{\n\t\tthis.#sendAnalytics('view');\n\t}\n\n\t#sendCloseAnalytics(): void\n\t{\n\t\tthis.#sendAnalytics('close');\n\t}\n\n\t#sendClickAnalytics(): void\n\t{\n\t\tthis.#sendAnalytics('click');\n\t}\n\n\t#sendAnalytics(eventName: string): void\n\t{\n\t\tconst type = Dictionary.TYPE_REPEAT_SALE_BANNER_NULL;\n\t\tconst subSection = this.#analytics.c_sub_section ?? Dictionary.SUB_SECTION_KANBAN;\n\n\t\tlet instance = null;\n\t\tif (eventName === 'view')\n\t\t{\n\t\t\tinstance = Builder.RepeatSale.Banner.ViewEvent.createDefault(type, subSection);\n\t\t}\n\t\telse if (eventName === 'close')\n\t\t{\n\t\t\tinstance = Builder.RepeatSale.Banner.CloseEvent.createDefault(type, subSection);\n\t\t}\n\t\telse if (eventName === 'click')\n\t\t{\n\t\t\tinstance = Builder.RepeatSale.Banner.ClickEvent.createDefault(type, subSection);\n\t\t}\n\n\t\tif (instance)\n\t\t{\n\t\t\tconst section = this.#analytics.c_section ?? '';\n\n\t\t\tsendData(instance.setSection(section).buildData());\n\t\t}\n\t}\n}"],"names":["MAX_STEP_NUMBER","OnboardingPopup","constructor","params","closeOptionName","closeOptionCategory","analytics","show","isShown","BannerDispatcher","toQueue","onDone","subscribe","Priority","CRITICAL","Popup","id","targetContainer","content","cacheable","isScrollBlock","className","closeByEsc","closeIcon","padding","width","overlay","opacity","backgroundColor","animation","autoHide","events","onFirstShow","onclose","BX","userOptions","save","icon","Icon","size","color","OutlineIconSet","COPILOT","Tag","render","Loc","getMessage","videoElement","addEventListener","muted","play","region","Extension","getSettings","get","name","includes","style","AirButtonStyle","TINTED","FILLED_COPILOT","CHECK_M","NEXT","UiButton","useAirDesign","text","round","UI","Button","Size","LARGE","onclick","close","destroy","code","Dom","replace","document","querySelector","value","body","eventName","type","Dictionary","TYPE_REPEAT_SALE_BANNER_NULL","subSection","c_sub_section","SUB_SECTION_KANBAN","instance","Builder","RepeatSale","Banner","ViewEvent","createDefault","CloseEvent","ClickEvent","section","c_section","sendData","setSection","buildData"],"mappings":"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"}