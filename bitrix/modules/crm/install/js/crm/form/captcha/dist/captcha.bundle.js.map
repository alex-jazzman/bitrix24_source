{"version":3,"file":"captcha.bundle.js","sources":["../src/captcha.js"],"sourcesContent":["import { Tag, Type, Loc, ajax } from 'main.core';\nimport { Layout } from 'ui.sidepanel.layout';\nimport 'ui.notification';\n\nconst YANDEX_CAPTCHA_SERVICE = 'yandex';\nconst GOOGLE_CAPTCHA_SERVICE = 'google';\n\nexport class Captcha\n{\n\tstatic open(type: string = GOOGLE_CAPTCHA_SERVICE): Promise\n\t{\n\t\tlet resolver = null;\n\t\tconst promise = new Promise((resolve): void => {\n\t\t\tresolver = resolve;\n\t\t});\n\n\t\tconst instance = new Captcha(type);\n\t\tBX.SidePanel.Instance.open('crm.webform:captcha', {\n\t\t\twidth: 700,\n\t\t\tcacheable: false,\n\t\t\tevents: {\n\t\t\t\tonCloseComplete: () => {\n\t\t\t\t\tresolver({ ...instance.getValue() });\n\t\t\t\t},\n\t\t\t},\n\t\t\tcontentCallback: () => {\n\t\t\t\treturn Layout.createContent({\n\t\t\t\t\textensions: ['crm.form.captcha', 'ui.forms', 'ui.sidepanel-content'],\n\t\t\t\t\ttitle: Loc.getMessage('CRM_FORM_CAPTCHA_JS_TITLE'),\n\t\t\t\t\tdesign: {\n\t\t\t\t\t\tsection: false,\n\t\t\t\t\t},\n\t\t\t\t\tcontent(): Promise\n\t\t\t\t\t{\n\t\t\t\t\t\treturn instance.load();\n\t\t\t\t\t},\n\t\t\t\t\tbuttons({ SaveButton, closeButton }): [any, any]\n\t\t\t\t\t{\n\t\t\t\t\t\treturn [\n\t\t\t\t\t\t\tnew SaveButton({\n\t\t\t\t\t\t\t\tonclick: (btn) => {\n\t\t\t\t\t\t\t\t\tif (!instance.canChange())\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tbtn.setDisabled(true);\n\t\t\t\t\t\t\t\t\t\tBX.UI.Notification.Center.notify({\n\t\t\t\t\t\t\t\t\t\t\tcontent: Loc.getMessage('CRM_FORM_CAPTCHA_JS_ACCESS_DENIED'),\n\t\t\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\tbtn.setWaiting(true);\n\t\t\t\t\t\t\t\t\tinstance.save()\n\t\t\t\t\t\t\t\t\t\t.then(() => {\n\t\t\t\t\t\t\t\t\t\t\tbtn.setWaiting(false);\n\t\t\t\t\t\t\t\t\t\t\tBX.SidePanel.Instance.close();\n\t\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t\t.catch(() => {\n\t\t\t\t\t\t\t\t\t\t\tbtn.setWaiting(false);\n\t\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t;\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\tcloseButton,\n\t\t\t\t\t\t];\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t},\n\t\t});\n\n\t\treturn promise;\n\t}\n\n\tconstructor(type: string = GOOGLE_CAPTCHA_SERVICE)\n\t{\n\t\tthis.#type = type;\n\t}\n\n\t#data: Object = {\n\t\tkey: null,\n\t\tsecret: null,\n\t\tcanChange: false,\n\t\thasDefaults: false,\n\t};\n\n\t#type: string;\n\n\t#container: HTMLElement;\n\n\t#render(): HTMLElement\n\t{\n\t\tconst key = Tag.safe`${this.#data.key}`;\n\t\tconst secret = Tag.safe`${this.#data.secret}`;\n\t\tthis.#container = Tag.render`\n\t\t\t<div>\n\t\t\t\t<div class=\"ui-slider-section\" ${this.#data.hasDefaults ? '' : 'hidden'}>\n\t\t\t\t\t<div class=\"ui-slider-content-box\">\n\t\t\t\t\t\t<div class=\"ui-slider-heading-4\">${Loc.getMessage('CRM_FORM_CAPTCHA_JS_STD_TITLE')}</div>\n\t\t\t\t\t\t<div class=\"ui-alert ui-alert-success\">\n\t\t\t\t\t\t\t<span class=\"ui-alert-message\">${Loc.getMessage('CRM_FORM_CAPTCHA_JS_STD_TEXT')}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"ui-slider-section\">\n\t\t\t\t\t<div class=\"ui-slider-content-box\">\n\t\t\t\t\t\t<div class=\"ui-slider-heading-4\">\n\t\t\t\t\t\t\t${\n\t\t\t\t\t\t\t\tthis.#type === YANDEX_CAPTCHA_SERVICE\n\t\t\t\t\t\t\t\t\t? Loc.getMessage('CRM_FORM_CAPTCHA_JS_YANDEX_CUSTOM_TITLE')\n\t\t\t\t\t\t\t\t\t: Loc.getMessage('CRM_FORM_CAPTCHA_JS_CUSTOM_TITLE_MSGVER_1')\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<p class=\"ui-slider-paragraph-2\">\n\t\t\t\t\t\t\t${Loc.getMessage('CRM_FORM_CAPTCHA_JS_CUSTOM_TEXT')}\n\t\t\t\t\t\t\t<br>\n\t\t\t\t\t\t\t<a href=\"${\n\t\t\t\t\t\t\t\tthis.#type === YANDEX_CAPTCHA_SERVICE\n\t\t\t\t\t\t\t\t\t? 'https://yandex.cloud/ru/docs/smartcaptcha/operations/get-keys'\n\t\t\t\t\t\t\t\t\t: 'https://www.google.com/recaptcha/about/'\n\t\t\t\t\t\t\t}\" target=\"_blank\">${Loc.getMessage('CRM_FORM_CAPTCHA_JS_CUSTOM_HOWTO')}</a>\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\t\t\t\t\t\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<div class=\"ui-form-row\">\n\t\t\t\t\t\t\t<div class=\"ui-form-label\">\n\t\t\t\t\t\t\t\t<div class=\"ui-ctl-label-text\">Key</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class=\"ui-form-content\">\n\t\t\t\t\t\t\t\t<div class=\"ui-ctl ui-ctl-textbox ui-ctl-w100\">\n\t\t\t\t\t\t\t\t\t<input \n\t\t\t\t\t\t\t\t\t\ttype=\"text\" \n\t\t\t\t\t\t\t\t\t\tname=\"key\"\n\t\t\t\t\t\t\t\t\t\tvalue=\"${key}\"\n\t\t\t\t\t\t\t\t\t\tclass=\"ui-ctl-element\"\n\t\t\t\t\t\t\t\t\t\tonfocus=\"this.parentElement.classList.remove('ui-ctl-danger')\"\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"ui-form-row\" style=\"margin: 20px 0 0;\">\n\t\t\t\t\t\t\t<div class=\"ui-form-label\">\n\t\t\t\t\t\t\t\t<div class=\"ui-ctl-label-text\">Secret</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class=\"ui-form-content\">\n\t\t\t\t\t\t\t\t<div class=\"ui-ctl ui-ctl-textbox ui-ctl-w100\">\n\t\t\t\t\t\t\t\t\t<input \n\t\t\t\t\t\t\t\t\t\ttype=\"text\" \n\t\t\t\t\t\t\t\t\t\tname=\"secret\"\n\t\t\t\t\t\t\t\t\t\tvalue=\"${secret}\"\n\t\t\t\t\t\t\t\t\t\tclass=\"ui-ctl-element\"\n\t\t\t\t\t\t\t\t\t\tonfocus=\"this.parentElement.classList.remove('ui-ctl-danger')\"\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\n\t\treturn this.#container;\n\t}\n\n\thasKeys(): boolean\n\t{\n\t\tconst data = this.#data;\n\n\t\treturn data.hasDefaults || (data.key && data.secret);\n\t}\n\n\tcanChange(): boolean\n\t{\n\t\treturn this.#data.canChange;\n\t}\n\n\tload(): Promise\n\t{\n\t\treturn ajax.runAction('crm.form.getCaptcha', { json: { type: this.#type } }).then((response) => {\n\t\t\tthis.#data = response.data;\n\n\t\t\treturn this.#render();\n\t\t});\n\t}\n\n\tsave(): Promise\n\t{\n\t\tconst keyNode = this.#container.querySelector('input[name=\"key\"]');\n\t\tconst secretNode = this.#container.querySelector('input[name=\"secret\"]');\n\n\t\tconst key = keyNode.value || '';\n\t\tconst secret = secretNode.value || '';\n\n\t\tkeyNode.parentElement.classList.remove('ui-ctl-danger');\n\t\tsecretNode.parentElement.classList.remove('ui-ctl-danger');\n\t\tif (Type.isStringFilled(key) !== Type.isStringFilled(secret))\n\t\t{\n\t\t\tif (!key)\n\t\t\t{\n\t\t\t\tkeyNode.parentElement.classList.add('ui-ctl-danger');\n\t\t\t}\n\n\t\t\tif (!secret)\n\t\t\t{\n\t\t\t\tsecretNode.parentElement.classList.add('ui-ctl-danger');\n\t\t\t}\n\n\t\t\treturn Promise.reject();\n\t\t}\n\n\t\treturn ajax\n\t\t\t.runAction('crm.form.setCaptcha', { json: { key, secret, type: this.#type } })\n\t\t\t.then((response) => {\n\t\t\t\tthis.#data = response.data;\n\n\t\t\t\treturn this.#data;\n\t\t\t})\n\t\t;\n\t}\n\n\tgetValue(): {[key: string]: any}\n\t{\n\t\treturn this.#data;\n\t}\n}\n"],"names":["YANDEX_CAPTCHA_SERVICE","GOOGLE_CAPTCHA_SERVICE","Captcha","type","resolver","promise","Promise","resolve","instance","BX","SidePanel","Instance","open","width","cacheable","events","onCloseComplete","getValue","contentCallback","Layout","createContent","extensions","title","Loc","getMessage","design","section","content","load","buttons","SaveButton","closeButton","onclick","btn","canChange","setDisabled","UI","Notification","Center","notify","setWaiting","save","then","close","key","secret","hasDefaults","data","ajax","runAction","json","response","keyNode","querySelector","secretNode","value","parentElement","classList","remove","Type","isStringFilled","add","reject","Tag","safe","render"],"mappings":"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"}