this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,s,a,i,l,r,o){"use strict";async function n(e,t){const s=await BX.ajax.runAction("crm.activity.sms.getTemplates",{data:{senderId:G,context:{module:"crm",entityTypeId:e,entityCategoryId:t,entityId:null}}});return s.data.templates}async function c(){const e=await r.ajax.runAction("crm.api.messagesender.providersConfig",{data:{providerName:G}});return e.data||[]}var d=babelHelpers.classPrivateFieldLooseKey("instance");var b=babelHelpers.classPrivateFieldLooseKey("currentFromNumberId");var p=babelHelpers.classPrivateFieldLooseKey("rawProviders");var P=babelHelpers.classPrivateFieldLooseKey("getEdnaProviderFromRaw");var v=babelHelpers.classPrivateFieldLooseKey("createProvidersMenu");var u=babelHelpers.classPrivateFieldLooseKey("createFromNumberMenus");var m=babelHelpers.classPrivateFieldLooseKey("onFromNumbersChange");class h{constructor(e){Object.defineProperty(this,m,{value:H});Object.defineProperty(this,u,{value:g});Object.defineProperty(this,v,{value:y});Object.defineProperty(this,P,{value:L});Object.defineProperty(this,d,{writable:true,value:null});Object.defineProperty(this,b,{writable:true,value:null});Object.defineProperty(this,p,{writable:true,value:[]});babelHelpers.classPrivateFieldLooseBase(this,b)[b]=e}async create(){babelHelpers.classPrivateFieldLooseBase(this,p)[p]=await c();if(babelHelpers.classPrivateFieldLooseBase(this,b)[b]===null){babelHelpers.classPrivateFieldLooseBase(this,b)[b]=babelHelpers.classPrivateFieldLooseBase(this,P)[P](babelHelpers.classPrivateFieldLooseBase(this,p)[p]).fromList[0].id}const e="crm-whatsapp-channels-settings-menu";babelHelpers.classPrivateFieldLooseBase(this,d)[d]=a.MenuManager.create({id:e,bindElement:document.querySelector(".bx-crm-group-actions-messages-settings-icon"),items:[{delimiter:true,text:r.Loc.getMessage("CRM_GROUP_ACTIONS_WHATSAPP_MESSAGE_SETTINGS")},{id:"channelSubmenu",text:r.Loc.getMessage("CRM_GROUP_ACTIONS_WHATSAPP_MESSAGE_SENDER_SELECTOR"),items:babelHelpers.classPrivateFieldLooseBase(this,v)[v](babelHelpers.classPrivateFieldLooseBase(this,p)[p])},{id:"phoneSubmenu",text:r.Loc.getMessage("CRM_GROUP_ACTIONS_WHATSAPP_MESSAGE_NUMBER_SELECTOR"),items:babelHelpers.classPrivateFieldLooseBase(this,u)[u](babelHelpers.classPrivateFieldLooseBase(this,P)[P](babelHelpers.classPrivateFieldLooseBase(this,p)[p]).fromList,babelHelpers.classPrivateFieldLooseBase(this,b)[b])}]});return babelHelpers.classPrivateFieldLooseBase(this,d)[d]}}function L(e){if(babelHelpers.classPrivateFieldLooseBase(this,p)[p].length!==1&&e[0].id!==G){throw new Error(`Currently only ${G} is supported.`)}return babelHelpers.classPrivateFieldLooseBase(this,p)[p][0]}function y(e){const t=babelHelpers.classPrivateFieldLooseBase(this,P)[P](e);return[{id:t.id,title:t.name,text:t.name,disabled:true,className:"menu-popup-item-accept"}]}function g(e,t){return e.map((e=>{const s=e.id===t?"menu-popup-item-accept":"menu-popup-item-none";return{id:e.id,title:e.name,text:e.name,onclick:babelHelpers.classPrivateFieldLooseBase(this,m)[m].bind(this),className:s}}))}function H(e,t){const s=t.id;BX.Event.EventEmitter.emit("BX.Crm.GroupActionsWhatsApp.FromPhoneSelected",{phone:s});babelHelpers.classPrivateFieldLooseBase(this,d)[d].close()}let F=null;function E(e,t,s,a){const{id:i,value:l,entityType:o,text:n}=a;r.ajax.runAction("crm.activity.smsplaceholder.createOrUpdatePlaceholder",{data:{placeholderId:i,fieldName:r.Type.isStringFilled(l)?l:null,entityType:r.Type.isStringFilled(o)?o:null,fieldValue:r.Type.isStringFilled(n)?n:null,templateId:e,entityTypeId:t,entityCategoryId:s}})}const B={name:"SmsEditorWrapper",props:{templateParam:Object,title:String,entityTypeId:Number,categoryId:Number},data(){return{counter:0,editorInstance:null,messages:{send:r.Loc.getMessage("CRM_GROUP_ACTIONS_WHATSAPP_MESSAGE_POPUP_SEND")}}},methods:{onSend(){if(!F){console.error("SmsEditorWrapper: editorInstance is null");return}let e="";if(F){const t=F.getData();if(r.Type.isPlainObject(t)){e=t.body}}if(e===""){e=this.templateParam.PREVIEW}const t=this.templateParam.ID;const s=this.templateParam.ORIGINAL_ID;o.EventEmitter.emit("BX.Crm.SmsEditorWrapper:click",{text:e,templateId:t,originalTemplateId:s})}},mounted(){const e={target:this.$refs.editorContainerEl,categoryId:this.categoryId,entityId:0,entityTypeId:this.entityTypeId,onSelect:e=>{E(this.templateParam.ORIGINAL_ID,this.entityTypeId,this.categoryId,{id:e.id,value:e.value,entityType:e.entityType,text:e.text})}};const t=this.templateParam.PREVIEW;const s=this.templateParam.PLACEHOLDERS||{};const a=this.templateParam.FILLED_PLACEHOLDERS||[];F=new BX.Crm.Template.Editor(e).setPlaceholders(s).setFilledPlaceholders(a);F.setBody(t)},unmounted(){F=null},template:`\n\t\t<div class="bx-crm-group-actions-messages__item">\n\t\t\t<div class="bx-crm-group-actions-messages__item-title">{{ title }}</div>\n\t\t\t<div class="bx-crm-group-actions-messages__editor" ref="editorContainerEl"></div>\n\n\t\t\t<button\n\t\t\t\t@click="onSend"\n\t\t\t\tclass="ui-btn ui-btn-primary ui-btn-md bx-crm-group-actions-messages__button"\n\t\t\t>{{ messages.send }}</button>\n\t\t</div>\n\t`};var S=babelHelpers.classPrivateFieldLooseKey("messages");var _=babelHelpers.classPrivateFieldLooseKey("entityTypeId");var I=babelHelpers.classPrivateFieldLooseKey("itemSlot");var f=babelHelpers.classPrivateFieldLooseKey("getTemplateItems");var A=babelHelpers.classPrivateFieldLooseKey("catalogHeader");var O=babelHelpers.classPrivateFieldLooseKey("catalogFooter");var T=babelHelpers.classPrivateFieldLooseKey("submitAnalytics");class C{constructor(){Object.defineProperty(this,T,{value:w});Object.defineProperty(this,O,{value:D});Object.defineProperty(this,A,{value:R});Object.defineProperty(this,f,{value:N});Object.defineProperty(this,I,{value:M});Object.defineProperty(this,S,{writable:true,value:{startConversation:r.Loc.getMessage("CRM_GROUP_ACTIONS_WHATSAPP_MESSAGE_POPUP_START"),sendFirst:r.Loc.getMessage("CRM_GROUP_ACTIONS_WHATSAPP_MESSAGE_POPUP_FIRST"),howItWork:r.Loc.getMessage("CRM_GROUP_ACTIONS_WHATSAPP_MESSAGE_POPUP_HOW"),learnCompliance:r.Loc.getMessage("CRM_GROUP_ACTIONS_WHATSAPP_MESSAGE_POPUP_COMPLIANCE"),learnMore:r.Loc.getMessage("CRM_GROUP_ACTIONS_WHATSAPP_MESSAGE_POPUP_MORE")}});Object.defineProperty(this,_,{writable:true,value:void 0})}async create(e,t){babelHelpers.classPrivateFieldLooseBase(this,_)[_]=e;const s=await n(e,t);const a=babelHelpers.classPrivateFieldLooseBase(this,f)[f](e,t,s);const i=babelHelpers.classPrivateFieldLooseBase(this,I)[I]();return new l.EntityCatalog({canDeselectGroups:false,showEmptyGroups:false,customComponents:{SmsEditorWrapper:B},slots:{[l.EntityCatalog.SLOT_MAIN_CONTENT_ITEM]:i,[l.EntityCatalog.SLOT_MAIN_CONTENT_HEADER]:babelHelpers.classPrivateFieldLooseBase(this,A)[A](),[l.EntityCatalog.SLOT_MAIN_CONTENT_FOOTER]:babelHelpers.classPrivateFieldLooseBase(this,O)[O]()},groups:a.groups,items:a.templateItems,title:r.Loc.getMessage("CRM_GROUP_ACTIONS_WHATSAPP_MESSAGE_POPUP_TITLE"),popupOptions:{overlay:true,events:{onPopupClose:()=>{babelHelpers.classPrivateFieldLooseBase(this,T)[T]()}}}})}}function M(){return`\n\t\t\t<div>\n\t\t\t\t<SmsEditorWrapper  \n\t\t\t\t\t:templateParam="itemSlotProps.itemData.customData"\n\t\t\t\t\t:title="itemSlotProps.itemData.title" \n\t\t\t\t\t:entityTypeId="itemSlotProps.itemData.entityTypeId"\n\t\t\t\t\t:categoryId="itemSlotProps.itemData.categoryId"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t`}function N(e,t,s){const a=s.map((e=>({id:e.ID,name:e.TITLE})));if(a.length>0){a[0].selected=true}const i=s.map((s=>({id:s.ORIGINAL_ID,title:s.TITLE,entityTypeId:e,categoryId:t,groupIds:[s.ID],customData:{title:s.TITLE,FILLED_PLACEHOLDERS:s.FILLED_PLACEHOLDERS||[],...s}})));return{groups:a,templateItems:i}}function R(){return`\n\t\t\t<div class="bx-crm-group-actions-messages-tpl-header">\n\t\t\t\t<div class="bx-crm-group-actions-messages-tpl-header-left">\n\t\t\t\t\t<div class="bx-crm-group-actions-messages-whatsapp-icon"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-crm-group-actions-messages-tpl-header-center">\n\t\t\t\t\t<strong \n\t\t\t\t\t\tclass="bx-crm-group-actions-messages-tpl-header-center-title"\n\t\t\t\t\t>${babelHelpers.classPrivateFieldLooseBase(this,S)[S].startConversation}</strong><br>\n\t\t\t\t\t<span class="bx-crm-group-actions-messages-tpl-header_gray">${babelHelpers.classPrivateFieldLooseBase(this,S)[S].sendFirst}</span><br>\n\t\t\t\t\t<a \n\t\t\t\t\t\t\thref="#" \n\t\t\t\t\t\t\tonclick="BX.Event.EventEmitter.emit('BX.Crm.GroupActionsWhatsApp.Settings:help', { code: 20526810});"\n\t\t\t\t\t\t>${babelHelpers.classPrivateFieldLooseBase(this,S)[S].howItWork}</a>\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-crm-group-actions-messages-tpl-header-right">\n\t\t\t\t\t<div \n\t\t\t\t\t\tclass="bx-crm-group-actions-messages-settings-icon"\n\t\t\t\t\t\tonclick="BX.Event.EventEmitter.emit('BX.Crm.GroupActionsWhatsApp.Settings:click');"\n\t\t\t\t\t></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`}function D(){return`\n\t\t\t<div class="bx-crm-group-actions-messages-compliance">\n\t\t\t\t${babelHelpers.classPrivateFieldLooseBase(this,S)[S].learnCompliance}\n\t\t\t</div>\n\t\t`}function w(){const e=i.Builder.Communication.FormEvent.createDefault(babelHelpers.classPrivateFieldLooseBase(this,_)[_]).setEvent(i.Dictionary.EVENT_WA_POPUP).setSubSection(i.Dictionary.SUB_SECTION_LIST).setElement(i.Dictionary.ELEMENT_WA_POPUP_CLOSE).buildData();BX.UI.Analytics.sendData(e)}const G="ednaru";const j="bx.crm.group_actions.messages.selected_from_number";var W=babelHelpers.classPrivateFieldLooseKey("instance");var K=babelHelpers.classPrivateFieldLooseKey("options");var X=babelHelpers.classPrivateFieldLooseKey("progressBarRepo");var x=babelHelpers.classPrivateFieldLooseKey("catalog");var U=babelHelpers.classPrivateFieldLooseKey("settingsMenu");var k=babelHelpers.classPrivateFieldLooseKey("selectedFromNumber");var V=babelHelpers.classPrivateFieldLooseKey("messages");var $=babelHelpers.classPrivateFieldLooseKey("isHelpShown");var q=babelHelpers.classPrivateFieldLooseKey("showSettingsMenu");var z=babelHelpers.classPrivateFieldLooseKey("showHelpArticle");var J=babelHelpers.classPrivateFieldLooseKey("destroy");var Q=babelHelpers.classPrivateFieldLooseKey("fromPhoneSelected");var Y=babelHelpers.classPrivateFieldLooseKey("sendMessages");var Z=babelHelpers.classPrivateFieldLooseKey("showAnotherProcessRunningNotification");var ee=babelHelpers.classPrivateFieldLooseKey("showGridLoader");var te=babelHelpers.classPrivateFieldLooseKey("hideGridLoader");var se=babelHelpers.classPrivateFieldLooseKey("getGridLoader");var ae=babelHelpers.classPrivateFieldLooseKey("restoreLastSelectedFromNumber");var ie=babelHelpers.classPrivateFieldLooseKey("storeLastSelectedFromNumber");var le=babelHelpers.classPrivateFieldLooseKey("submitAnalytics");class re{static getInstance(e,t){if(babelHelpers.classPrivateFieldLooseBase(re,W)[W]){babelHelpers.classPrivateFieldLooseBase(re,W)[W].setOptions(t)}else{babelHelpers.classPrivateFieldLooseBase(re,W)[W]=new re(e,t)}return babelHelpers.classPrivateFieldLooseBase(re,W)[W]}constructor(e,t){Object.defineProperty(this,le,{value:Le});Object.defineProperty(this,ie,{value:he});Object.defineProperty(this,ae,{value:me});Object.defineProperty(this,se,{value:ue});Object.defineProperty(this,te,{value:ve});Object.defineProperty(this,ee,{value:Pe});Object.defineProperty(this,Z,{value:pe});Object.defineProperty(this,Y,{value:be});Object.defineProperty(this,Q,{value:de});Object.defineProperty(this,J,{value:ce});Object.defineProperty(this,z,{value:ne});Object.defineProperty(this,q,{value:oe});Object.defineProperty(this,K,{writable:true,value:void 0});Object.defineProperty(this,X,{writable:true,value:void 0});Object.defineProperty(this,x,{writable:true,value:void 0});Object.defineProperty(this,U,{writable:true,value:null});Object.defineProperty(this,k,{writable:true,value:null});Object.defineProperty(this,V,{writable:true,value:{inProgress:r.Loc.getMessage("CRM_GROUP_ACTIONS_WHATSAPP_MESSAGE_IN_PROGRESS")}});Object.defineProperty(this,$,{writable:true,value:false});babelHelpers.classPrivateFieldLooseBase(this,X)[X]=e;babelHelpers.classPrivateFieldLooseBase(this,K)[K]=t;babelHelpers.classPrivateFieldLooseBase(this,k)[k]=babelHelpers.classPrivateFieldLooseBase(this,ae)[ae]()}setOptions(e){babelHelpers.classPrivateFieldLooseBase(this,K)[K]=e}async execute(){o.EventEmitter.subscribeOnce("BX.Crm.SmsEditorWrapper:click",babelHelpers.classPrivateFieldLooseBase(this,Y)[Y].bind(this));o.EventEmitter.subscribe("BX.Crm.GroupActionsWhatsApp.FromPhoneSelected",babelHelpers.classPrivateFieldLooseBase(this,Q)[Q].bind(this));babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]();babelHelpers.classPrivateFieldLooseBase(this,x)[x]=await(new C).create(babelHelpers.classPrivateFieldLooseBase(this,K)[K].entityTypeId,babelHelpers.classPrivateFieldLooseBase(this,K)[K].categoryId);babelHelpers.classPrivateFieldLooseBase(this,te)[te]();babelHelpers.classPrivateFieldLooseBase(this,x)[x].show();const e=babelHelpers.classPrivateFieldLooseBase(this,x)[x].getPopup();e.subscribeOnce("onClose",babelHelpers.classPrivateFieldLooseBase(this,J)[J].bind(this));o.EventEmitter.subscribe("BX.Crm.GroupActionsWhatsApp.Settings:click",babelHelpers.classPrivateFieldLooseBase(this,q)[q].bind(this));o.EventEmitter.subscribe("BX.Crm.GroupActionsWhatsApp.Settings:help",babelHelpers.classPrivateFieldLooseBase(this,z)[z].bind(this))}}async function oe(e){if(babelHelpers.classPrivateFieldLooseBase(this,U)[U]!==null){babelHelpers.classPrivateFieldLooseBase(this,U)[U].close();babelHelpers.classPrivateFieldLooseBase(this,U)[U].destroy();babelHelpers.classPrivateFieldLooseBase(this,U)[U]=null}babelHelpers.classPrivateFieldLooseBase(this,U)[U]=await new h(babelHelpers.classPrivateFieldLooseBase(this,k)[k]).create();babelHelpers.classPrivateFieldLooseBase(this,U)[U].show()}function ne(e){const t=e.getData().code;if(!t){throw new Error("articleCode is not defined")}const s=r.Reflection.getClass("top.BX.Helper");if(s){s.show(`redirect=detail&code=${t}`)}babelHelpers.classPrivateFieldLooseBase(this,le)[le]("showHelp")}function ce(){o.EventEmitter.unsubscribeAll("BX.Crm.SmsEditorWrapper:click");o.EventEmitter.unsubscribeAll("BX.Crm.GroupActionsWhatsApp.Settings:click");o.EventEmitter.unsubscribeAll("BX.Crm.GroupActionsWhatsApp.Settings:help");o.EventEmitter.unsubscribeAll("BX.Crm.GroupActionsWhatsApp.FromPhoneSelected");if(babelHelpers.classPrivateFieldLooseBase(this,x)[x]){babelHelpers.classPrivateFieldLooseBase(this,x)[x].getPopup().unsubscribeAll("onClose");babelHelpers.classPrivateFieldLooseBase(this,x)[x].close();babelHelpers.classPrivateFieldLooseBase(this,x)[x]=null}if(babelHelpers.classPrivateFieldLooseBase(this,U)[U]){babelHelpers.classPrivateFieldLooseBase(this,U)[U].close();babelHelpers.classPrivateFieldLooseBase(this,U)[U].destroy();babelHelpers.classPrivateFieldLooseBase(this,U)[U]=null}}function de(e){const t=e.getData().phone;babelHelpers.classPrivateFieldLooseBase(this,ie)[ie](t);babelHelpers.classPrivateFieldLooseBase(this,k)[k]=t}async function be(e){var s,a,i;const l=babelHelpers.classPrivateFieldLooseBase(this,K)[K].gridId;const r=babelHelpers.classPrivateFieldLooseBase(this,K)[K].entityTypeId;const o=((s=e.getData())==null?void 0:s.text)||"";const n=((a=e.getData())==null?void 0:a.templateId)||null;const c=((i=e.getData())==null?void 0:i.originalTemplateId)||null;const d=babelHelpers.classPrivateFieldLooseBase(this,X)[X].getOrCreateProgressBarContainer("whatsapp-message").id;const b={gridId:l,entityTypeId:r,container:d};const p=t.BatchWhatsappMessageManager.getInstance(l,b);if(p.isRunning()){return}if(t.ProcessRegistry.isProcessRunning(l)){babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]();return}p.setTemplateParams({messageBody:o,messageTemplate:n,fromPhone:babelHelpers.classPrivateFieldLooseBase(this,k)[k]});if(babelHelpers.classPrivateFieldLooseBase(this,K)[K].forAll){p.resetEntityIds()}else{p.setEntityIds(babelHelpers.classPrivateFieldLooseBase(this,K)[K].selectedIds)}p.execute();babelHelpers.classPrivateFieldLooseBase(this,le)[le]("sendMessage",c);babelHelpers.classPrivateFieldLooseBase(this,J)[J]()}function pe(){s.UI.Notification.Center.notify({content:babelHelpers.classPrivateFieldLooseBase(this,V)[V].inProgress,autoHide:true,autoHideDelay:5e3})}function Pe(){const e=babelHelpers.classPrivateFieldLooseBase(this,se)[se]();if(e){e.show()}}function ve(){const e=babelHelpers.classPrivateFieldLooseBase(this,se)[se]();if(e){e.hide()}}function ue(){var e,t;return(e=BX.Main.gridManager.getById(babelHelpers.classPrivateFieldLooseBase(this,K)[K].gridId))==null?void 0:(t=e.instance)==null?void 0:t.getLoader()}function me(){return localStorage.getItem(j)||null}function he(e){localStorage.setItem(j,e)}function Le(e,t=null){let s=null;if(e==="showHelp"&&!babelHelpers.classPrivateFieldLooseBase(this,$)[$]){s=i.Builder.Communication.FormEvent.createDefault(babelHelpers.classPrivateFieldLooseBase(this,K)[K].entityTypeId).setEvent(i.Dictionary.EVENT_WA_POPUP).setSubSection(i.Dictionary.SUB_SECTION_LIST).setElement(i.Dictionary.ELEMENT_WA_HELP);babelHelpers.classPrivateFieldLooseBase(this,$)[$]=true}if(e==="sendMessage"){s=i.Builder.Communication.SendEvent.createDefault(babelHelpers.classPrivateFieldLooseBase(this,K)[K].entityTypeId).setEvent(i.Dictionary.EVENT_WA_SEND).setSubSection(i.Dictionary.SUB_SECTION_LIST).setElement(i.Dictionary.ELEMENT_WA_SEND).setContactsCount(babelHelpers.classPrivateFieldLooseBase(this,K)[K].forAll?"all":babelHelpers.classPrivateFieldLooseBase(this,K)[K].selectedIds.length).setTemplateId(t)}if(s){BX.UI.Analytics.sendData(s.buildData())}}Object.defineProperty(re,W,{writable:true,value:null});e.DEFAULT_PROVIDER=G;e.Messages=re})(this.BX.Crm.GroupActions=this.BX.Crm.GroupActions||{},BX.Crm.Autorun,BX,BX.Main,BX.Crm.Integration.Analytics,BX.UI,BX,BX.Event);
//# sourceMappingURL=messages.bundle.map.js