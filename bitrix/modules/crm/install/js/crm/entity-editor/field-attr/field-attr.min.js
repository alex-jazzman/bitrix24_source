BX.namespace("BX.Crm");if(typeof BX.Crm.EntityFieldAttributeType==="undefined"){BX.Crm.EntityFieldAttributeType=BX.UI.EntityFieldAttributeType}if(typeof BX.Crm.EntityFieldAttributePhaseGroupType==="undefined"){BX.Crm.EntityFieldAttributePhaseGroupType=BX.UI.EntityFieldAttributePhaseGroupType}if(typeof BX.Crm.EntityFieldAttributeManager==="undefined"){BX.Crm.EntityFieldAttributeManager=function(){this._id="";this._settings=null;this._entityTypeId=BX.CrmEntityType.enumeration.undefined;this._entityScope=""};BX.Crm.EntityFieldAttributeManager.prototype={initialize:function(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=i?i:{};this._entityTypeId=BX.prop.getInteger(this._settings,"entityTypeId",BX.CrmEntityType.enumeration.undefined);this._entityScope=BX.prop.getString(this._settings,"entityScope","")},isPermitted:function(){return BX.prop.getBoolean(this._settings,"isPermitted",true)},isPhaseDependent:function(){return BX.prop.getBoolean(this._settings,"isPhaseDependent",true)},getEntityPhases:function(){var t=BX.prop.getArray(this._settings,"entityPhases",null);if(t){return t}var i;if(typeof BX.CrmProgressManager!=="undefined"&&BX.CrmProgressManager.hasOwnProperty("current")){i=BX.CrmProgressManager.current.resolve(this._entityTypeId)}return i?i.getInfos(this._entityScope):[]},createFieldConfigurator:function(t,i){return BX.Crm.EntityFieldAttributeConfigurator.create(this._id,{typeId:i,phases:this.getEntityPhases(),captions:BX.prop.getObject(this._settings,"captions",{}),config:t?t.getAttributeConfiguration(i):null,isPermitted:this.isPermitted(),isPhaseDependent:this.isPhaseDependent(),isAttrConfigButtonHidden:BX.prop.getBoolean(this._settings,"isAttrConfigButtonHidden",false),lockScript:BX.prop.getString(this._settings,"lockScript","")})},prepareFieldName:function(t,i){if(t===BX.CrmEntityType.enumeration.bankDetail&&BX.Type.isStringFilled(i)){const t=i.match(/\[(\w+)]$/);if(t&&BX.Type.isStringFilled(t[1])&&t.length>1){i=t[1]}}return i},saveConfiguration:function(t,i){if(!this.isPermitted()){return}i=this.prepareFieldName(this._entityTypeId,i);BX.ajax.runAction("crm.api.fieldAttribute.saveConfiguration",{data:{config:t,fieldName:i,entityTypeName:BX.CrmEntityType.resolveName(this._entityTypeId),entityScope:this._entityScope}})},removeConfiguration:function(t,i){if(!this.isPermitted()){return}i=this.prepareFieldName(this._entityTypeId,i);BX.ajax.runAction("crm.api.fieldAttribute.removeConfiguration",{data:{type:t,fieldName:i,entityTypeName:BX.CrmEntityType.resolveName(this._entityTypeId),entityScope:this._entityScope}})}};BX.Crm.EntityFieldAttributeManager.create=function(t,i){var e=new BX.Crm.EntityFieldAttributeManager;e.initialize(t,i);return e}}if(typeof BX.Crm.EntityFieldAttributeConfigButton==="undefined"){BX.Crm.EntityFieldAttributeConfigButton=function(){this._id="";this._settings=null;this._configurator=null;this._wrapper=null;this._icon=null};BX.Crm.EntityFieldAttributeConfigButton.prototype={initialize:function(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=i?i:{};this._configurator=BX.prop.get(this._settings,"configurator",null)},isHidden:function(){return BX.prop.getBoolean(this._settings,"isHidden",false)},onClick:function(t){if(this._configurator.isEnabled()){this._configurator.open(this._wrapper)}},adjust:function(){var t=this._configurator.prepareLegendData();if(this._configurator.isEnabled()){BX.removeClass(this._wrapper,"crm-entity-new-field-addiction-step-disabled")}else{BX.addClass(this._wrapper,"crm-entity-new-field-addiction-step-disabled")}this._wrapper.style.backgroundColor=BX.prop.getString(t,"backgroundColor","#CED4DC");this._wrapper.style.color=BX.prop.getString(t,"color","#333");var i=this._wrapper.querySelector("span.crm-entity-new-field-addiction-step-arrow");if(i){i.style.color=BX.prop.getString(t,"color","#333")}var e=this._wrapper.querySelector("span.crm-entity-new-field-addiction-step-name");if(e){e.innerHTML=BX.util.htmlspecialchars(BX.prop.getString(t,"text","..."))}},prepareLayout:function(){var t=this._configurator.prepareLegendData();this._wrapper=BX.create("span",{props:{className:"crm-entity-new-field-addiction-step"},style:{backgroundColor:BX.prop.getString(t,"backgroundColor","#CED4DC"),color:BX.prop.getString(t,"color","#333")},children:[BX.create("span",{props:{className:"crm-entity-new-field-addiction-step-name"},text:BX.prop.getString(t,"text","")}),BX.create("span",{props:{className:"crm-entity-new-field-addiction-step-arrow"},children:[BX.create("span",{props:{className:"crm-entity-new-field-addiction-step-arrow-inner"}})]})]});if(this.isHidden()){this._wrapper.style.display="none"}BX.bind(this._wrapper,"click",BX.delegate(this.onClick,this));return[this._wrapper]}};BX.Crm.EntityFieldAttributeConfigButton.create=function(t,i){var e=new BX.Crm.EntityFieldAttributeConfigButton;e.initialize(t,i);return e}}if(typeof BX.Crm.EntityFieldVisibilityConfigurator==="undefined"){BX.Crm.EntityFieldVisibilityConfigurator=function(){this._id="";this._settings=null;this._config=null;this._button=null;this._wrapper=null;this._label=null;this._switchCheckBox=null;this._switchCheckBoxHandler=BX.delegate(this.onSwitchCheckBoxClick,this);this._onSquareClick=BX.delegate(this.onSquareClick,this);this._isEnabled=false;this._isChanged=false;this._isPermitted=true;this._items=[];this._restriction={};this.useHumanResourcesModule=true};BX.Crm.EntityFieldVisibilityConfigurator.prototype={initialize:function(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=i?i:{};this._config=BX.prop.getObject(this.getSettings(),"config",{});this._editor=BX.prop.get(this.getSettings(),"editor",{});this._field=BX.prop.get(this.getSettings(),"field",null);this._restriction=BX.prop.getObject(this.getSettings(),"restriction",{});this._isPermitted=BX.prop.getBoolean(this._restriction,"isPermitted",true);this.useHumanResourcesModule=BX.prop.getBoolean(this.getSettings(),"useHumanResourcesModule",true);this._squares=[];this._isEnabled=!this.isEmpty();this.initializeItems()},initializeItems:function(){this._items=[];var t=BX.prop.getObject(this._config,"accessCodes",[]);for(var i in t){this.addItem(this.createUserInfo(t[i]))}},addItem:function(t){if(this._items===null){this._items=[]}this._items.push(t);return t},createUserInfo:function(t){return{ID:t.id,FORMATTED_NAME:BX.util.htmlspecialcharsback(BX.prop.getString(t,"name",""))}},onUserFieldConfigurationSave:function(t,i){var e={};t=t||null;if(this._isChanged&&(t||(t=this.getSettings().field.getId()))){var n=this._items||[];if(!this.isEnabled()){n=[];this.removeItems()}this.saveConfiguration(n,t,i)}},getTitle:function(){return BX.Crm.EntityFieldVisibilityConfigurator.messages["titleField"]},saveConfiguration:function(t,i,e){e=e||this.getSettings().editor.getEntityTypeId();this._isChanged=BX.ajax.runAction("crm.api.userFieldVisibility.saveConfiguration",{data:{accessCodes:t.length?t:false,fieldName:i,entityTypeId:e}}).then((function(t,i){return true}))},formatAccessCodesFromConfig:function(t){var i={};t.forEach((function(t,e,n){var r={id:t.ID,name:t.FORMATTED_NAME};i[t.ID]=r}));return i},getId:function(){return this._id},adjust:function(){this.removeSquares();this._items.forEach((function(t,i,e){this.setSquare(t.FORMATTED_NAME,t.ID)}),this);this.getButton().adjust()},getSquares:function(){return BX.Filter.Utils.getByClass(this.getButton().getSelectUserControl(),"main-ui-square",true)},removeSquares:function(){this.getSquares().forEach(BX.remove)},setSquare:function(t,i){var e=BX.decl(this.createSquareData(t,i));e.setAttribute("data-user-id",i);BX.bind(e,"click",BX.delegate(this._onSquareClick,this));var n=this.getSquares();if(!n.length){BX.prepend(e,this.getButton().getSelectUserControl())}else{BX.insertAfter(e,n[n.length-1])}},createSquareData:function(t,i){return{block:"main-ui-square",name:t,item:{_label:t,_value:i}}},onSquareClick:function(t){if(!this._isPermitted){this.runLockScript()}else{var i=t.target.parentElement;var e=i.getAttribute("data-user-id");this._isChanged=true;this.removeItem(e);this.adjust()}},setEnabled:function(t){this._isEnabled=!!t},isEnabled:function(){return this._isEnabled},isEmpty:function(){return Object.keys(BX.prop.getObject(this.getConfiguration(),"accessCodes",{})).length===0},getConfiguration:function(){return this._config},getSettings:function(){return this._settings},open:function(t){if(!this._isPermitted){this.runLockScript()}else{this.getUserSelector().open(t)}},close:function(){if(this.getUserSelector()){this.getUserSelector().close()}},prepareContent:function(){this._wrapper=BX.create("div",{props:{className:"crm-entity-popup-field-addiction-step"}});var t=BX.create("div",{props:{className:"crm-entity-popup-field-addiction-steps-list-container"}});this._wrapper.appendChild(t);return this._wrapper},getButton:function(){if(!this._button){this._button=BX.Crm.EntityFieldVisibilityConfigButton.create(this._id,{configurator:this})}return this._button},getSwitchCheckBox:function(){return this._switchCheckBox},setSwitchCheckBox:function(t){if(this._switchCheckBox){BX.unbind(this._switchCheckBox,"click",this._switchCheckBoxHandler)}this._switchCheckBox=t;if(this._switchCheckBox){BX.bind(this._switchCheckBox,"click",this._switchCheckBoxHandler)}},onSwitchCheckBoxClick:function(t){if(!this._isPermitted){this.runLockScript();this._switchCheckBox.checked=this._isEnabled}else{this._isChanged=true;this.setEnabled(this._switchCheckBox.checked);if(!this._switchCheckBox.checked){this._items=[]}this.adjust()}},runLockScript:function(){var lockScript=BX.prop.getString(this._restriction,"restrictionCallback","");if(lockScript!==""){eval(lockScript)}},getUserSelector:function(){if(!this._userSelector){let t=BX.UI.EntityEditorEntitySelector;if(!t){t=BX.UI.EntityEditorUserSelector}this._userSelector=t.create(this._id,{callback:BX.delegate(this.processItemSelect,this),useHumanResourcesModule:this.useHumanResourcesModule})}return this._userSelector},processItemSelect:function(t,i){this._isChanged=true;var e=BX.prop.getString(i,"id","");if(this.findItemIndexById(e)>=0){this.removeItem(e);this.adjust();return}this.addItem(this.createUserInfo(i));this.adjust()},findItemIndexById:function(t){for(var i=0,e=this._items.length;i<e;i++){if(this._items[i].ID===t){return i}}return-1},getItems:function(){return this._items||[]},removeItems:function(){this._items=[]},removeItem:function(t){var i=this.findItemIndexById(t);if(i>=0){this._items=BX.util.deleteFromArray(this._items,i)}},isCustomized:function(){var t=BX.prop.getObject(this._config,"accessCodes",[]);return!!Object.keys(t).length}};BX.Crm.EntityFieldVisibilityConfigurator.create=function(t,i){var e=new BX.Crm.EntityFieldVisibilityConfigurator;e.initialize(t,i);return e}}if(typeof BX.Crm.EntityFieldVisibilityConfigButton==="undefined"){BX.Crm.EntityFieldVisibilityConfigButton=function(){this._id="";this._settings=null;this._configurator=null;this._wrapper=null;this._selectUserControl=null;this._addButton=null};BX.Crm.EntityFieldVisibilityConfigButton.prototype={initialize:function(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=i?i:{};this._configurator=BX.prop.get(this._settings,"configurator",null);this.adjust()},onClick:function(t){t.preventDefault();if(this._configurator.isEnabled()){this._configurator.open(this._wrapper)}},adjust:function(){if(this._configurator.isEnabled()){BX.removeClass(this._wrapper,"crm-entity-new-field-visibility-disabled");BX.Dom.show(this._wrapper)}else{BX.addClass(this._wrapper,"crm-entity-new-field-visibility-disabled");BX.Dom.hide(this._wrapper)}},prepareLayout:function(){this._addButton=BX.create("a",{props:{className:"feed-add-destination-link"},attrs:{href:"#"},text:BX.Crm.EntityFieldVisibilityConfigurator.messages["addUserButton"]});BX.bind(this._addButton,"click",BX.delegate(this.onClick,this));this._selectUserControl=BX.create("div",{props:{className:"main-ui-control-entity main-ui-control userfieldemployee-control"},dataset:{multiple:true},children:[this._addButton]});var t=BX.create("label",{text:BX.Crm.EntityFieldVisibilityConfigurator.messages["labelField"]});this._wrapper=BX.create("div",{props:{className:"crm-entity-new-field-visibility"},children:[t,this.getSelectUserControl()]});this.adjust();return[this._wrapper]},getSelectUserControl:function(){return this._selectUserControl}};BX.Crm.EntityFieldVisibilityConfigButton.create=function(t,i){var e=new BX.Crm.EntityFieldVisibilityConfigButton;e.initialize(t,i);return e}}
//# sourceMappingURL=field-attr.map.js