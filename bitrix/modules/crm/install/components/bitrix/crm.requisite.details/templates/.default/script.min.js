BX.namespace("BX.Crm");BX.localStorage.set("BX.Crm.RequisiteSliderDetails:initStarted",{},10);if(typeof BX.Crm.RequisiteDetailsManager==="undefined"){BX.Crm.RequisiteDetailsManager=function(){this.needEmitCancelEvent=true;this.entityEditor=null;this.titleNode=null;this.titleInput=null;this.nameControl=null;this.toolbar=null};BX.Crm.RequisiteDetailsManager.presetControlName="PRESET_ID";BX.Crm.RequisiteDetailsManager.autocompleteControlName="AUTOCOMPLETE";BX.Crm.RequisiteDetailsManager.bankDetailsControlName="BANK_DETAILS";BX.Crm.RequisiteDetailsManager.addressControlName="RQ_ADDR";BX.Crm.RequisiteDetailsManager.prototype={initialize:function(t){this._settings=t;this.entityEditor=this.getEntityEditor();if(this.entityEditor){this.nameControl=this.entityEditor.getControlById("NAME")}this.prevPresetId=null;this.titleNode=document.querySelector("[data-cid='NAME']");if(this.titleNode){this.titleInput=this.titleNode.querySelector("input[type='text']")}this.toolbar=BX.Reflection.getClass("BX.UI.ToolbarManager")&&BX.UI.ToolbarManager.getDefaultToolbar();this.addEvents();if(this.getSetting("markPresetAsChanged",false)){this.markPresetAsChanged()}},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getEntityEditor:function(){var t;var e=this.getSetting("entityEditorId","");if(BX.Type.isStringFilled(e)){t=BX.UI.EntityEditor.get(e);if(!t){t=null}}return t},initializeDupControl:function(){var t=this.getEntityEditor();if(!t){return}var e=t.getId().toLowerCase()+"_dup";var i=this.getSetting("duplicateControl",{});i["editor"]=t;BX.Crm.RequisiteDetailsDupManager.create(e,i)},markPresetAsChanged:function(){if(!this.entityEditor){return}var t=this.entityEditor.getControlByCombinedIdRecursive(BX.Crm.RequisiteDetailsManager.presetControlName);if(t){t.markAsChanged()}},addNewBankDetails:function(){if(!this.entityEditor){return}var t=this.entityEditor.getControlByCombinedIdRecursive(BX.Crm.RequisiteDetailsManager.bankDetailsControlName);if(t){t.addEmptyValue({scrollToTop:true})}},addEvents:function(){BX.Event.EventEmitter.subscribe("BX.UI.EntityEditor:onCancel",this.onCancelEdit.bind(this));BX.Event.EventEmitter.subscribe("BX.UI.EntityEditor:onNothingChanged",this.onCancelEdit.bind(this));BX.Event.EventEmitter.subscribe("onEntityUpdate",this.onSave.bind(this));var t=this.getSliderInstance();if(t){BX.addCustomEvent(t,"SidePanel.Slider:onClose",this.onCloseSlider.bind(this));BX.addCustomEvent(t,"SidePanel.Slider:onLoad",this.onLoadSlider.bind(this))}if(this.entityEditor){BX.Event.EventEmitter.subscribe(this.entityEditor,"onControlChanged",this.onControlChanged.bind(this));const t=this.getAttributeManagerSettings();if(BX.Type.isPlainObject(t)){const e=BX.Crm.EntityFieldAttributeManager.create(this.entityEditor.getId()+"_ATTR_MANAGER",{entityTypeId:parseInt(this.getSetting("entityTypeId",BX.CrmEntityType.enumeration.undefined)),entityScope:BX.prop.getString(t,"ENTITY_SCOPE",""),isPermitted:BX.prop.getBoolean(t,"IS_PERMITTED",true),isPhaseDependent:BX.prop.getBoolean(t,"IS_PHASE_DEPENDENT",true),isAttrConfigButtonHidden:BX.prop.getBoolean(t,"IS_ATTR_CONFIG_BUTTON_HIDDEN",true),lockScript:BX.prop.getString(t,"LOCK_SCRIPT",""),captions:BX.prop.getObject(t,"CAPTIONS",{}),entityPhases:BX.prop.getArray(t,"ENTITY_PHASES",null)});this.entityEditor.setAttributeManager(e)}if(this.nameControl&&this.toolbar&&this.titleNode&&this.titleInput){this.toolbar.subscribe(BX.UI.ToolbarEvents.finishEditing,this.onEditTitle.bind(this));this.toolbar.setTitle(this.titleInput.value);BX.Dom.style(this.titleNode,{display:"none"})}}},isMatchedAutocompleteControlName:function(t,e){if(t===e||t.endsWith("."+e)||t.endsWith("["+e+"]")){return true}return false},onControlChanged:function(t){var e;var i=t.getData();if(BX.Type.isArray(i)){e=i.length>0?i[0]:null;if(e instanceof BX.UI.EntityEditorList&&this.isMatchedAutocompleteControlName(e.getId(),BX.Crm.RequisiteDetailsManager.presetControlName)){if(this.prevPresetId===null){this.prevPresetId=e.getValue()}if(this.prevPresetId!==e.getRuntimeValue()){this.onPresetChanged(e,this.prevPresetId);this.prevPresetId=e.getRuntimeValue()}}if(e instanceof BX.Crm.EntityEditorRequisiteAutocomplete&&this.isMatchedAutocompleteControlName(e.getId(),BX.Crm.RequisiteDetailsManager.autocompleteControlName)){var r=e.getAutocompleteData();var n=BX.prop.getObject(r,"fields",{});var s=Object.keys(n);var a=false;var l=null;if(n.hasOwnProperty(BX.Crm.RequisiteDetailsManager.presetControlName)){l=this.getEntityEditor().getControlByIdRecursive(BX.Crm.RequisiteDetailsManager.presetControlName);if(l){const t=n[BX.Crm.RequisiteDetailsManager.presetControlName];if(l.getRuntimeValue()!=t){this.prevPresetId=l.getRuntimeValue();a=true}}}for(var o=0;o<s.length;o++){var d=s[o];var u=n[d];var h=this.getEntityEditor().getControlByCombinedIdRecursive(d);if(h){if(this.isMatchedAutocompleteControlName(d,BX.Crm.RequisiteDetailsManager.addressControlName)){var p=this.getEntityEditor()._model.getField(d);if(BX.Type.isPlainObject(p)){u=BX.merge(p,u)}}this.getEntityEditor()._model.setField(h.getId(),u);h.refreshLayout();if(!this.isMatchedAutocompleteControlName(d,BX.Crm.RequisiteDetailsManager.presetControlName)){h.markAsChanged()}}else if(a&&BX.Type.isStringFilled(u)){this.getEntityEditor().getFormElement().appendChild(BX.create("input",{props:{type:"hidden",name:d,value:u}}))}}if(a&&l){this.onPresetChanged(l,this.prevPresetId)}}}},onPresetChanged:function(t,e){const i=t.getEditor();if(i){if(typeof i.setValidationEnabled==="function"){i.setValidationEnabled(false)}else{const t=BX.UI.EntityUserFieldManager.getById(i.getId());if(t&&typeof t.setValidationEnabled==="function"){t.setValidationEnabled(false)}}BX.Event.EventEmitter.subscribe("BX.UI.EntityEditor:onSave",this.onSaveNewPreset.bind(this,e));i.releaseAjaxForm();i.save()}},onSaveNewPreset:function(t){var e=this.getEntityEditor();if(e){var i=e.getFormElement();if(i){i.appendChild(BX.create("input",{props:{type:"hidden",name:"PREV_PRESET_ID",value:t}}));i.appendChild(BX.create("input",{props:{type:"hidden",name:"ACTION",value:"RELOAD"}}));i.method="post";i.submit()}}},onCancelEdit:function(t){for(var e in t.getData()){if(t.data[e].cancel===false){t.data[e].cancel=true}}this.closeSlider()},onCloseSlider:function(){if(!this.needEmitCancelEvent){this.needEmitCancelEvent=true}else{this.emitEvent("onCancelEdit")}},onLoadSlider:function(){if(this.getSetting("duplicateControlEnabled",false)){this.initializeDupControl()}if(this.getSetting("autoAddBankDetailsItem",false)){this.addNewBankDetails()}},onSave:function(t){var e=t.getData();var i=BX.prop.getObject(e[0],"entityData",{});this.emitEvent("onSave",{requisiteData:BX.prop.getString(i,"REQUISITE_DATA",""),requisiteDataSign:BX.prop.getString(i,"REQUISITE_DATA_SIGN",""),presetId:this.getPresetId(),presetCountryId:this.getPresetCountryId()});setTimeout(this.closeSliderSilently.bind(this),10)},onEditTitle:function(t){this.titleInput.value=t.getData().updatedTitle.trim();this.nameControl.markAsChanged()},emitEvent:function(t,e){if(!e){e={}}e.contextId=this.getContextId();BX.localStorage.set("BX.Crm.RequisiteSliderDetails:"+t,e,10)},closeSlider:function(){var t=this.getSliderInstance();if(t){t.close()}},closeSliderSilently:function(){this.needEmitCancelEvent=false;this.closeSlider()},getContextId:function(){return this.getContextField("external_context_id")},getPresetId:function(){return this.getContextField("pid")},getPresetCountryId:function(){return this.getContextField("presetCountryId")},getContextField:function(t){if(!this.entityEditor){return""}var e=this.entityEditor.getContext();return BX.prop.getString(e,t,"")},getSliderInstance:function(){if(typeof top.BX.SidePanel!=="undefined"){var t=top.BX.SidePanel.Instance.getSliderByWindow(window);if(t&&t.isOpen()){return t}}return null},getAttributeManagerSettings:function(){return this.getSetting("attributeConfig",null)}};BX.Crm.RequisiteDetailsManager.create=function(t){var e=new BX.Crm.RequisiteDetailsManager;e.initialize(t);return e}}if(typeof BX.Crm.RequisiteDetailsDupManager==="undefined"){BX.Crm.RequisiteDetailsDupManager=function(){this._id="";this._settings=null;this._serviceUrl="";this._entityTypeName="";this._form=null;this._controller=null};BX.Crm.RequisiteDetailsDupManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","");this._entityTypeName=BX.prop.getString(this._settings,"entityTypeName","");this._entityId=BX.prop.getString(this._settings,"entityId","");this._editor=BX.prop.get(this._settings,"editor",null);this._requisiteFieldsMap=BX.prop.getArray(this._settings,"requisiteFieldsMap",[]);this._bankDetailsFieldsMap=BX.prop.getArray(this._settings,"bankDetailsFieldsMap",[]);this._requisiteId=BX.prop.getString(this._settings,"requisiteId","");this._presetId=BX.prop.getString(this._settings,"presetId","");this._form=this._editor.getFormElement();this._bankDetailsValues={};this._controller=BX.Crm.RequisiteDetailsDupController.create(this._id,{serviceUrl:this._serviceUrl,entityTypeName:this._entityTypeName,entityId:this._entityId,form:this._form});for(var i,r=0;r<this._requisiteFieldsMap.length;r++){i=this._editor.getControlByIdRecursive(this._requisiteFieldsMap[r]);if(i){this.registerField(i.getId(),{id:i.getId(),field:i})}}BX.Event.EventEmitter.subscribe(this._editor,"onControlChanged",this.onChangeBankDetails.bind(this));this.processBankDetails()},onChangeBankDetails:function(t){var e=t.getData();if(BX.Type.isArray(e)){var i=e.length>0?e[0]:null;if(i&&i.getId()===BX.Crm.RequisiteDetailsManager.bankDetailsControlName){this.processBankDetails()}}},processBankDetails:function(){var t=this._editor.getControlById(BX.Crm.RequisiteDetailsManager.bankDetailsControlName);if(t){var e=t.getEditors();for(var i in e){if(!e.hasOwnProperty(i)){continue}if(this._bankDetailsValues[i]){continue}this._bankDetailsValues[i]=true;for(var r,n=0;n<this._bankDetailsFieldsMap.length;n++){var s=BX.Crm.RequisiteDetailsManager.bankDetailsControlName+"["+i+"]["+this._bankDetailsFieldsMap[n]+"]";r=e[i].getControlByIdRecursive(s);if(r){var a=this._bankDetailsFieldsMap[n];this.registerField(a,{id:a,context:{BANK_DETAILS_ID:i},field:r})}}}}},search:function(){this._controller.initialSearch()},getGroup:function(t){return this._controller.getGroup(t)},ensureGroupRegistered:function(t,e){var i=this.getGroup(t);if(!i){i=this._controller.registerGroup(t,{parameterName:t,requisiteId:this._requisiteId,presetId:this._presetId,context:e.context,groupType:"requisite",groupSummaryTitle:e.field?'"'+e.field.getTitle()+'"':""})}return i},registerField:function(t,e){var i=this.ensureGroupRegistered(t,e);if(!i){return null}return i.registerField(e)},unregisterField:function(t,e){var i=this.getGroup(t);if(!i){return}i.unregisterField(e)}};BX.Crm.RequisiteDetailsDupManager.create=function(t,e){var i=new BX.Crm.RequisiteDetailsDupManager;i.initialize(t,e);return i}}if(typeof BX.Crm.RequisiteDetailsDupController==="undefined"){BX.Crm.RequisiteDetailsDupController=function(){BX.Crm.RequisiteDetailsDupController.superclass.constructor.apply(this)};BX.ready((function(){BX.extend(BX.Crm.RequisiteDetailsDupController,BX.CrmDupController);BX.Crm.RequisiteDetailsDupController.prototype.registerGroup=function(t,e){var i=BX.type.isNotEmptyString(e["groupType"])?e["groupType"]:"";var r=null;try{if(i==="requisite"){r=BX.Crm.RequisiteDetailsSingleField.create(t,e)}}catch(t){}if(r){this.addGroup(r)}else{r=BX.Crm.RequisiteDetailsDupController.superclass.registerGroup.apply(this,[t,e])}return r}}));BX.Crm.RequisiteDetailsDupController.create=function(t,e){var i=new BX.Crm.RequisiteDetailsDupController;i.initialize(t,e);return i}}if(typeof BX.Crm.RequisiteDetailsSingleField==="undefined"){BX.Crm.RequisiteDetailsSingleField=function(){BX.Crm.RequisiteDetailsSingleField.superclass.constructor.apply(this);this._requisiteId=null;this._presetId=null;this._context=null};BX.ready((function(){BX.extend(BX.Crm.RequisiteDetailsSingleField,BX.CrmDupCtrlSingleField);BX.Crm.RequisiteDetailsSingleField.prototype._afterInitialize=function(){this._requisiteId=this.getSetting("requisiteId","");this._presetId=this.getSetting("presetId","");this._context=this.getSetting("context",null);this._paramName=this.getSetting("parameterName","");if(!BX.type.isNotEmptyString(this._paramName)){throw"BX.Crm.RequisiteDetailsSingleField. Could not find parameter name."}var t=this.getSetting("field",null);if(t){this._field=this.addField(BX.Crm.RequisiteDetailsCtrlField.create(this._paramName,t))}};BX.Crm.RequisiteDetailsSingleField.prototype.registerField=function(t){var e=BX.prop.getString(t,"id","");if(e!==this._paramName){return null}var i=BX.prop.get(t,"field",null);if(!i){return null}if(!this._field){this._field=this.addField(BX.Crm.RequisiteDetailsCtrlField.create(this._paramName,i))}return this._field};BX.Crm.RequisiteDetailsSingleField.prototype.prepareSearchParams=function(){var t=BX.Crm.RequisiteDetailsSingleField.superclass.prepareSearchParams.apply(this);if(t){t.PRESET_ID=this._presetId;t.ID=this._requisiteId;if(BX.Type.isPlainObject(this._context)){t=BX.mergeEx(t,this._context)}}return t}}));BX.Crm.RequisiteDetailsSingleField.create=function(t,e){var i=new BX.Crm.RequisiteDetailsSingleField;i.initialize(t,e);return i}}if(typeof BX.Crm.RequisiteDetailsCtrlField==="undefined"){BX.Crm.RequisiteDetailsCtrlField=function(){this._field=null;BX.Crm.RequisiteDetailsCtrlField.superclass.constructor.apply(this)};BX.ready((function(){BX.extend(BX.Crm.RequisiteDetailsCtrlField,BX.CrmDupCtrlField);BX.Crm.RequisiteDetailsCtrlField.prototype.initialize=function(t,e){if(!BX.type.isNotEmptyString(t)){throw"BX.Crm.RequisiteDetailsCtrlField. Invalid parameter 'id': is not defined."}this._id=t;if(!(e instanceof BX.UI.EntityEditorField)){throw"BX.Crm.RequisiteDetailsCtrlField. Invalid parameter 'field': not instance of BX.UI.EntityEditorField."}this._field=e;this._value=e._input?e._input.value:"";BX.Event.EventEmitter.subscribe(this._field.getEditor(),"onControlChanged",this.onFieldChanged.bind(this));this._initialized=true};BX.Crm.RequisiteDetailsCtrlField.prototype.onFieldChanged=function(t){var e=t.getData();if(BX.Type.isArray(e)){var i=e.length>0?e[0]:null;if(i!==this._field||this._value===i._input.value){return}if(this._elementTimeoutId>0){window.clearTimeout(this._elementTimeoutId);this._elementTimeoutId=0}this._elementTimeoutId=window.setTimeout(this._elementTimeoutHandler,1500)}};BX.Crm.RequisiteDetailsCtrlField.prototype.getElementTitle=function(){return this._field.getWrapper()};BX.Crm.RequisiteDetailsCtrlField.prototype.getValue=function(){return this._field._input.value}}));BX.Crm.RequisiteDetailsCtrlField.create=function(t,e){var i=new BX.Crm.RequisiteDetailsCtrlField;i.initialize(t,e);return i}}
//# sourceMappingURL=script.map.js