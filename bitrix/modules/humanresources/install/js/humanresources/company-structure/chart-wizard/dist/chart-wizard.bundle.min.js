this.BX=this.BX||{};this.BX.Humanresources=this.BX.Humanresources||{};(function(t,e,s,i,n,a,r,o,d,l,c,_,h,m,p,E,u,T){"use strict";const C=Object.freeze({moveUsers:"moveUsers",addUsers:"addUsers"});const R=Object.freeze({entities:"entities",department:"department",employees:"employees",bindChat:"bindChat",teamRights:"teamRights"});const A={departmentHead:"HEAD",departmentDeputy:"DEPUTY_HEAD",teamHead:"TEAM_HEAD",teamDeputy:"TEAM_DEPUTY"};const S={name:"headUsers",components:{UserListActionMenu:c.UserListActionMenu},props:{users:{type:Array,required:true},showPlaceholder:{type:Boolean,default:true},isTeamEntity:{type:Boolean,default:false},isExistingDepartment:{type:Boolean,default:true},userType:{type:String,default:"head"},teamColor:{type:[Object,null],default:null}},data(){return{headsVisible:false}},created(){this.userTypes={head:"head",deputy:"deputy"}},computed:{headItemsCount(){return this.isExistingDepartment?1:2},defaultAvatar(){return"/bitrix/js/humanresources/company-structure/org-chart/src/images/default-user.svg"},placeholderAvatar(){if(!this.isTeamEntity||!this.teamColor){return"/bitrix/js/humanresources/company-structure/chart-wizard/src/components/tree-preview/images/placeholder-avatar.svg"}return`/bitrix/js/humanresources/company-structure/chart-wizard/src/components/tree-preview/images/${this.teamColor.avatarImage}`},dropdownItems(){return this.users.map((t=>{const e=t.workPosition||this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_HEAD_POSITION");return{...t,workPosition:e}}))},titleBar(){return this.userType===this.userTypes.deputy?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_DEPUTY_TITLE"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_HEAD_TITLE")},isDeputy(){return this.userType===this.userTypes.deputy}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)}},template:`\n\t\t<div\n\t\t\tclass="chart-wizard-tree-preview__node_head"\n\t\t\t:class="{ '--deputy': isDeputy }"\n\t\t\tv-for="(user, index) in users.slice(0, headItemsCount)"\n\t\t>\n\t\t\t<img\n\t\t\t\t:src="user.avatar || defaultAvatar"\n\t\t\t\tclass="chart-wizard-tree-preview__node_head-avatar --placeholder"\n\t\t\t\t:class="{ '--deputy': isDeputy, '--old': isExistingDepartment }"\n\t\t\t/>\n\t\t\t<div class="chart-wizard-tree-preview__node_head-text" :class="{'--deputy': isDeputy }">\n\t\t\t\t<span\n\t\t\t\t\tclass="chart-wizard-tree-preview__node_head-name --crop"\n\t\t\t\t\t:class="{'--old': isExistingDepartment }"\n\t\t\t\t>\n\t\t\t\t\t{{ user.name }}\n\t\t\t\t</span>\n\t\t\t\t<span\n\t\t\t\t\tv-if="!isDeputy"\n\t\t\t\t\tclass="chart-wizard-tree-preview__node_head-position --crop"\n\t\t\t\t\t:class="{'--old': isExistingDepartment }"\n\t\t\t\t>\n\t\t\t\t\t{{ user.workPosition || loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_HEAD_POSITION') }}\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t\t<span\n\t\t\t\tv-if="index === headItemsCount - 1 && users.length > headItemsCount"\n\t\t\t\tclass="chart-wizard-tree-preview__node_head-rest"\n\t\t\t\t:class="{ '--active': headsVisible }"\n\t\t\t\tref="showMoreHeadUserWizardList"\n\t\t\t\t:data-test-id="'hr-company-structure_chart-wizard-tree__preview-' + userType + '-rest'"\n\t\t\t\t@click.stop="headsVisible = true"\n\t\t\t>\n\t\t\t\t\t{{ '+' + String(users.length - headItemsCount) }}\n\t\t\t</span>\n\t\t</div>\n\t\t<div\n\t\t\tv-if="users.length === 0 && showPlaceholder"\n\t\t\tclass="chart-wizard-tree-preview__node_head"\n\t\t\t:class="{ '--deputy': isDeputy }"\n\t\t>\n\t\t\t<img\n\t\t\t\t:src="placeholderAvatar"\n\t\t\t\tclass="chart-wizard-tree-preview__node_head-avatar --placeholder"\n\t\t\t\t:class="{'--deputy': isDeputy, '--old': isExistingDepartment  }"\n\t\t\t/>\n\t\t\t<div class="chart-wizard-tree-preview__node_head-text">\n\t\t\t\t<span\n\t\t\t\t\tclass="chart-wizard-tree-preview__placeholder_name"\n\t\t\t\t\t:class="{'--deputy': isDeputy, '--team': isTeamEntity }"\n\t\t\t\t\t:style="{ 'background-color': teamColor ? teamColor.namePlaceholder : false }"\n\t\t\t\t></span>\n\t\t\t\t<span\n\t\t\t\t\tv-if="!isDeputy"\n\t\t\t\t\tclass="chart-wizard-tree-preview__node_head-position --crop"\n\t\t\t\t>\n\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_HEAD_POSITION') }}\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t</div>\n\n\t\t<UserListActionMenu\n\t\t\tv-if="headsVisible"\n\t\t\t:id="isDeputy ? 'wizard-head-list-popup-deputy' : 'wizard-head-list-popup-head' "\n\t\t\t:items="dropdownItems"\n\t\t\t:width="228"\n\t\t\t:bindElement="$refs.showMoreHeadUserWizardList[0]"\n\t\t\t@close="headsVisible = false"\n\t\t\t:titleBar="titleBar"\n\t\t/>\n\t`};const y={name:"treeNode",components:{HeadUsers:S},props:{name:String,heads:Array,userCount:Number,nodeId:Number,entityType:{type:String,default:T.EntityTypes.department},teamColor:{type:[Object,null],default:null}},data(){return{isShowLoader:false}},created(){this.memberRoles=m.getMemberRoles(this.departmentData.entityType)},watch:{isShowLoader(t){if(!t){return}this.$nextTick((()=>{const{loaderContainer:t}=this.$refs;const e=new n.Loader({size:30});e.show(t)}))}},computed:{departmentData(){if(this.isExistingDepartment){if(!this.isHeadsLoaded){this.loadHeads([this.nodeId])}return this.departments.get(this.nodeId)}return{name:this.name,heads:this.heads,userCount:this.userCount,entityType:this.entityType}},isExistingDepartment(){return Boolean(this.nodeId)},employeesCount(){var t;return(this.userCount||0)-(((t=this.heads)==null?void 0:t.length)||0)},headUsers(){var t;return(t=this.departmentData.heads)==null?void 0:t.filter((t=>t.role===this.memberRoles.head))},deputyUsers(){var t;return(t=this.departmentData.heads)==null?void 0:t.filter((t=>t.role===this.memberRoles.deputyHead))},showInfo(){return this.nodeId?u.PermissionChecker.getInstance().hasPermission(u.PermissionActions.structureView,this.nodeId):true},isHeadsLoaded(t){const{heads:e}=this.departments.get(this.nodeId);return Boolean(e)},isTeamEntity(){return this.departmentData.entityType===T.EntityTypes.team},dataTestIdSuffix(){return this.isExistingDepartment?"":"_new"},...o.mapState(p.useChartStore,["departments"])},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},locPlural(t,e){return _.Loc.getMessagePlural(t,e,{"#COUNT#":e})},async loadHeads(t){const e=p.useChartStore();try{this.isShowLoader=true;await e.loadHeads(t)}finally{this.isShowLoader=false}},formatDataTestId(t){return t+this.dataTestIdSuffix}},template:`\n\t\t<div\n\t\t\tclass="chart-wizard-tree-preview__node"\n\t\t\t:class="{ '--new': !isExistingDepartment, '--old': isExistingDepartment,'--team': isTeamEntity }"\n\t\t>\n\t\t\t<div \n\t\t\t\tclass="chart-wizard-tree-preview__node_summary" \n\t\t\t\t:class="{ '--old': isExistingDepartment, '--team': isTeamEntity }"\n\t\t\t\t:style="{ '--team-border-color': teamColor?.previewBorder }"\n\t\t\t>\n\t\t\t\t<div \n\t\t\t\t\tclass="chart-wizard-tree-preview__node_name --crop"\n\t\t\t\t\t:data-test-id="formatDataTestId('chart-wizard-tree-preview__node_name')"\n\t\t\t\t\t:style="{ 'background-color': teamColor ? teamColor.headBackground : false }"\n\t\t\t\t>\n\t\t\t\t\t<span\n\t\t\t\t\t\tv-if="!departmentData.name" \n\t\t\t\t\t\tclass="chart-wizard-tree-preview__placeholder_node_name"\n\t\t\t\t\t\t:class="{ '--team': isTeamEntity }"\n\t\t\t\t\t\t:style="{ 'background-color': teamColor ? teamColor.namePlaceholder : false }"\n\t\t\t\t\t></span>\n\t\t\t\t\t{{departmentData.name}}\n\t\t\t\t</div>\n\t\t\t\t<div \n\t\t\t\t\tclass="chart-wizard-tree-preview__node_content"\n\t\t\t\t\t:data-test-id="formatDataTestId('chart-wizard-tree-preview__head_list')"\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="chart-wizard-tree-preview__head_list"\n\t\t\t\t\t\t:data-test-id="formatDataTestId('chart-wizard-tree-preview__head_list')"\n\t\t\t\t\t>\n\t\t\t\t\t\t<HeadUsers\n\t\t\t\t\t\t\tv-if="showInfo && headUsers"\n\t\t\t\t\t\t\t:users="headUsers"\n\t\t\t\t\t\t\t:showPlaceholder="!isExistingDepartment"\n\t\t\t\t\t\t\t:isTeamEntity="isTeamEntity"\n\t\t\t\t\t\t\t:isExistingDepartment="isExistingDepartment"\n\t\t\t\t\t\t\t:teamColor="teamColor"\n\t\t\t\t\t\t/> \n\t\t\t\t\t</div>\n\t\t\t\t\t<div v-if="isShowLoader" ref="loaderContainer"></div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="showInfo && !isExistingDepartment"\n\t\t\t\t\t\tclass="chart-wizard-tree-preview__node_employees"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tclass="chart-wizard-tree-preview__node_employees-list"\n\t\t\t\t\t\t\t:data-test-id="formatDataTestId('chart-wizard-tree-preview__node_employees-list')"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<p class="chart-wizard-tree-preview__node_employees-title">\n\t\t\t\t\t\t\t\t{{\n\t\t\t\t\t\t\t\t\tisTeamEntity \n\t\t\t\t\t\t\t\t\t\t? loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TREE_PREVIEW_TEAM_EMPLOYEES_TITLE') \n\t\t\t\t\t\t\t\t\t\t: loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TREE_PREVIEW_EMPLOYEES_TITLE')\n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t<span class="chart-wizard-tree-preview__node_employees_count">\n\t\t\t\t\t\t\t\t{{ locPlural('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TREE_PREVIEW_EMPLOYEES_COUNT', employeesCount) }}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div \n\t\t\t\t\t\t\tclass="chart-wizard-tree-preview__node_deputies"\n\t\t\t\t\t\t\t:data-test-id="formatDataTestId('chart-wizard-tree-preview__node_deputies-list')"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<p class="chart-wizard-tree-preview__node_employees-title">\n\t\t\t\t\t\t\t\t{{\n\t\t\t\t\t\t\t\t\tisTeamEntity\n\t\t\t\t\t\t\t\t\t\t? loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TREE_PREVIEW_TEAM_DEPUTIES_TITLE') \n\t\t\t\t\t\t\t\t\t\t: loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TREE_PREVIEW_DEPUTIES_TITLE') \n\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t<HeadUsers\n\t\t\t\t\t\t\t\t:users="deputyUsers"\n\t\t\t\t\t\t\t\t:isTeamEntity="isTeamEntity"\n\t\t\t\t\t\t\t\t:isExistingDepartment="isExistingDepartment"\n\t\t\t\t\t\t\t\tuserType="deputy"\n\t\t\t\t\t\t\t\t:teamColor="teamColor"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<slot v-if="isExistingDepartment"></slot>\n\t\t</div>\n\t`};const U={name:"treePreview",components:{TreeNode:y},props:{parentId:{type:[Number,null],required:true},name:{type:String,required:true},heads:{type:Array,required:true},userCount:{type:Number,required:true},entityType:{type:String,default:T.EntityTypes.department},teamColor:{type:[Object,null],default:null}},computed:{rootId(){const t=this.departments.get(this.parentId);if(t){var e;return(e=t.parentId)!=null?e:0}return 0},companyName(){const{name:t}=[...this.departments.values()].find((t=>t.parentId===0));return t},isTeamEntity(){return this.entityType===T.EntityTypes.team},...o.mapState(p.useChartStore,["departments"])},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)}},template:`\n\t\t<div class="chart-wizard-tree-preview">\n\t\t\t<div class="chart-wizard-tree-preview__header">\n\t\t\t\t<span class="chart-wizard-tree-preview__header_text">\n\t\t\t\t\t{{\n\t\t\t\t\t\tisTeamEntity\n\t\t\t\t\t\t\t? loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TREE_PREVIEW_TEAM_TITLE')\n\t\t\t\t\t\t\t: loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TREE_PREVIEW_DEPARTMENT_TITLE')\n\t\t\t\t\t}}\n\t\t\t\t</span>\n\t\t\t\t<span class="chart-wizard-tree-preview__header_name">\n\t\t\t\t\t{{ companyName }}\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t\t<TreeNode\n\t\t\t\tv-if="rootId"\n\t\t\t\t:nodeId="rootId"\n\t\t\t>\n\t\t\t\t<TreeNode :nodeId="parentId">\n\t\t\t\t\t<TreeNode\n\t\t\t\t\t\t:name="name"\n\t\t\t\t\t\t:heads="heads"\n\t\t\t\t\t\t:userCount="userCount"\n\t\t\t\t\t\t:entityType="entityType"\n\t\t\t\t\t\t:teamColor="teamColor"\n\t\t\t\t\t></TreeNode>\n\t\t\t\t</TreeNode>\n\t\t\t</TreeNode>\n\t\t\t<TreeNode\n\t\t\t\tv-else-if="parentId"\n\t\t\t\t:nodeId="parentId"\n\t\t\t>\n\t\t\t\t<TreeNode\n\t\t\t\t\t:name="name"\n\t\t\t\t\t:heads="heads"\n\t\t\t\t\t:userCount="userCount"\n\t\t\t\t\t:entityType="entityType"\n\t\t\t\t\t:teamColor="teamColor"\n\t\t\t\t></TreeNode>\n\t\t\t</TreeNode>\n\t\t\t<TreeNode\n\t\t\t\tv-else\n\t\t\t\t:name="name"\n\t\t\t\t:heads="heads"\n\t\t\t\t:userCount="userCount"\n\t\t\t\t:entityType="entityType"\n\t\t\t\t:teamColor="teamColor"\n\t\t\t></TreeNode>\n\t\t</div>\n\t`};const D={name:"TeamColorPicker",components:{BasePopup:c.BasePopup},props:{modelValue:{type:Object,required:true},bindElement:{type:HTMLElement,required:true}},emits:["action","close","update:modelValue"],computed:{popupConfig(){const t=164;const e=41;const s=39;const i=33;return{width:t,height:116,bindElement:this.bindElement,borderRadius:12,contentNoPaddings:true,contentPadding:0,padding:0,offsetTop:4,offsetLeft:e/2-t/2+s,angleOffset:t/2-i/2}},nodeColorsSettingsDict(){return T.NodeColorsSettingsDict}},methods:{close(){this.$emit("close")}},template:`\n\t\t<BasePopup\n\t\t\t:config="popupConfig"\n\t\t\t:id="'chart_wizard__department__color-picker_popup'"\n\t\t\t@close="close"\n\t\t>\n\t\t\t<div\n\t\t\t\tclass="chart_wizard__department__color-picker_popup-container"\n\t\t\t\t:data-test-id="'wizard-department-color-picker-popup'"\n\t\t\t>\n\t\t\t\t<div v-for="item in nodeColorsSettingsDict" \n\t\t\t\t\t class="chart_wizard__department__color-picker_color-item"\n\t\t\t\t\t :class=" {'--active': item.name === modelValue.name }"\n\t\t\t\t\t @click="$emit('update:modelValue', item)"\n\t\t\t\t\t :data-test-id="'wizard-department-color-picker-item-'+item.name"\n\t\t\t\t>\n\t\t\t\t\t<div class="chart_wizard__department__color-picker_color-item_inner"\n\t\t\t\t\t\t :style="{ 'background-color': item.pickerColor }"\n\t\t\t\t\t></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</BasePopup>\n\t`};const I={name:"department",components:{TeamColorPicker:D},props:{parentId:{type:[Number,null],required:true},name:{type:String,required:true},description:{type:String,required:true},shouldErrorHighlight:{type:Boolean,required:true},isEditMode:{type:Boolean},entityType:{type:String,required:true},teamColor:{type:[Object,null],default:null},refToFocus:{type:String,default:null}},emits:["applyData"],data(){return{deniedError:false,showColorPicker:false,teamColorValue:this.teamColor,locked:false}},watch:{isTeamEntity(){this.recreateTagSelector()}},created(){this.selectedParentDepartment=this.parentId;this.departmentName=this.name;this.departmentDescription=this.description;this.departmentSelectorCashe=new a.MemoryCache;this.departmentsSelector=this.getOrCreateTagSelector()},mounted(){this.departmentsSelector.renderTo(this.$refs["tag-selector"])},activated(){var t;this.teamColorValue=this.teamColor;this.$emit("applyData",{isDepartmentDataChanged:false,isValid:this.departmentName&&((t=this.departmentName)==null?void 0:t.trim())!==""&&this.selectedParentDepartment!==null&&!this.deniedError});if(this.refToFocus&&this.$refs[this.refToFocus]){this.$refs[this.refToFocus].focus()}else{this.$refs.title.focus()}},methods:{recreateTagSelector(){this.$refs["tag-selector"].innerHTML="";this.departmentsSelector=this.getOrCreateTagSelector();this.departmentsSelector.renderTo(this.$refs["tag-selector"])},createTagSelector(){this.locked=this.isTagSelectorLocked();let t=this.parentId?[["structure-node",this.parentId]]:[];if(!this.isEditMode){const e=u.PermissionChecker.getInstance();const s=this.isTeamEntity?u.PermissionActions.teamCreate:u.PermissionActions.departmentCreate;if(e&&!e.hasPermission(s,this.parentId)){t=[["structure-node",0]]}}const e=t=>t.getRootNode().getChildren().count()===0;const s=new h.TagSelector({events:{onTagAdd:t=>{const{tag:e}=t.data;this.selectedParentDepartment=e.id},onTagRemove:()=>{this.selectedParentDepartment=null;this.applyData()}},multiple:false,locked:this.locked,dialogOptions:{width:425,height:350,dropdownMode:true,hideOnDeselect:true,entities:[{id:"structure-node",options:{selectMode:"departmentsOnly",restricted:this.isEditMode?"update":"create",includedNodeEntityTypes:this.includedNodeEntityTypesInDialog,useMultipleTabs:true}}],preselectedItems:t,events:{onLoad:t=>{var i,n,a;const r=s.getDialog();r.getTabs().filter((t=>e(t))).forEach((t=>t.setVisible(false)));const o=t.target;const d=(i=o.selectedItems)==null?void 0:(n=i.values())==null?void 0:(a=n.next())==null?void 0:a.value;if(this.isEditMode){if((d==null?void 0:d.id)===this.parentId&&this.locked){s.lock()}return}const l=u.PermissionChecker.getInstance();if(!l){return}const c=o.items.get("structure-node");const _=this.isTeamEntity?u.PermissionActions.teamCreate:u.PermissionActions.departmentCreate;for(const[,t]of c){var h;if(l.hasPermission(_,t.id)&&!l.hasPermission(_,(h=d==null?void 0:d.id)!=null?h:0)){t.select();break}}},onLoadError:()=>{this.selectedParentDepartment=null;this.applyData()},"Item:onSelect":t=>{var e,s,i;this.deniedError=false;const n=t.target;const a=(e=n.selectedItems)==null?void 0:(s=e.values())==null?void 0:(i=s.next())==null?void 0:i.value;const r=u.PermissionChecker.getInstance();if(!r){return}const o=this.departments.get(a.id);if(!o){return}const d=(o==null?void 0:o.entityType)===T.EntityTypes.team;const l=this.isTeamEntity?u.PermissionActions.teamCreate:u.PermissionActions.departmentCreate;const c=d?u.PermissionActions.teamEdit:u.PermissionActions.departmentEdit;const _=this.isEditMode?c:l;if(!r.hasPermission(_,a.id)){this.deniedError=true}this.applyData()}}}});return s},getOrCreateTagSelector(){const t=String(this.isTeamEntity);return this.departmentSelectorCashe.remember(t,(()=>this.createTagSelector()))},loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},applyData(){var t;this.$emit("applyData",{apiEntityChanged:T.WizardApiEntityChangedDict.department,name:this.departmentName,description:this.departmentDescription,parentId:this.selectedParentDepartment,teamColor:this.teamColorValue,isDepartmentDataChanged:true,isValid:this.departmentName&&((t=this.departmentName)==null?void 0:t.trim())!==""&&this.selectedParentDepartment!==null&&!this.deniedError})},isTagSelectorLocked(){if(!this.isEditMode){return false}if(this.parentId===0){return true}const t=this.departments.get(this.parentId);if(!t){return false}const e=u.PermissionChecker.getInstance();if(!e){return true}if(t.entityType===T.EntityTypes.department){return!e.hasPermission(u.PermissionActions.departmentEdit,t.id)}if(t.entityType===T.EntityTypes.team){return!e.hasPermission(u.PermissionActions.teamEdit,t.id)}return false}},computed:{includedNodeEntityTypesInDialog(){return this.isTeamEntity?["department","team"]:["department"]},isTeamEntity(){return this.entityType===T.EntityTypes.team},namePlaceholder(){return this.isTeamEntity?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TEAM_NAME_PLACEHOLDER_MSGVER_1"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_DEPARTMENT_NAME_PLACEHOLDER")},descriptionPlaceholder(){return this.isTeamEntity?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TEAM_DESCR_PLACEHOLDER"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_DEPARTMENT_DESCR_PLACEHOLDER")},higherLevelDepartmentContainer(){return this.isTeamEntity?".chart-wizard__department_higher_bottom":".chart-wizard__department_higher_top"},showLockedSelectorErrorText(){return this.locked&&this.parentId!==0},selectorErrorText(){if(this.deniedError){return this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_ADD_TO_DEPARTMENT_DENIED_MSG_VER_1")}if(this.locked&&this.parentId!==0){return this.isTeamEntity?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_PARENT_TEAM_ERROR"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_PARENT_DEPARTMENT_ERROR")}return this.isTeamEntity?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TEAM_PARENT_ERROR"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_DEPARTMENT_PARENT_ERROR")},...o.mapState(p.useChartStore,["departments"])},template:`\n\t\t<div class="chart-wizard__department">\n\t\t\t<div class="chart-wizard__form">\n\t\t\t\t<Teleport defer :to="higherLevelDepartmentContainer">\n\t\t\t\t\t<span class="chart-wizard__department_item-label">\n\t\t\t\t\t\t{{\n\t\t\t\t\t\t\tisTeamEntity\n\t\t\t\t\t\t\t\t? loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_DEPARTMENT_HIGHER_WITH_TEAM_LABEL')\n\t\t\t\t\t\t\t\t: loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_DEPARTMENT_HIGHER_LABEL')\n\t\t\t\t\t\t}}\n\t\t\t\t\t</span>\n\t\t\t\t\t<div\n\t\t\t\t\t\t:class="{ 'ui-ctl-warning': deniedError || (selectedParentDepartment === null && shouldErrorHighlight) }"\n\t\t\t\t\t\tref="tag-selector"\n\t\t\t\t\t></div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="deniedError || (selectedParentDepartment === null && shouldErrorHighlight) || showLockedSelectorErrorText"\n\t\t\t\t\t\tclass="chart-wizard__department_item-error"\n\t\t\t\t\t\t:class="{'--wizard-warning-item':  locked && parentId !== 0}"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tclass="ui-icon-set --warning"\n\t\t\t\t\t\t\t:style="locked && !deniedError ? { '--ui-icon-set__icon-size': '17px', '--ui-icon-set__icon-color': '#FFA900' } : {}"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<span class="chart-wizard__department_item-error-message">\n\t\t\t\t\t\t\t{{ selectorErrorText }}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t</Teleport>\n\t\t\t\t<div\n\t\t\t\t\tv-show="!isTeamEntity"\n\t\t\t\t\tclass="chart-wizard__department_item chart-wizard__department_higher_top">\n\t\t\t\t</div>\n\t\t\t\t<div class="chart-wizard__department_item">\n\t\t\t\t\t<span class="chart-wizard__department_item-label">\n\t\t\t\t\t\t{{\n\t\t\t\t\t\t\tisTeamEntity\n\t\t\t\t\t\t\t\t? loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_DEPARTMENT_TEAM_NAME_LABEL')\n\t\t\t\t\t\t\t\t: loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_DEPARTMENT_NAME_LABEL') \n\t\t\t\t\t\t}}\n\t\t\t\t\t</span>\n\t\t\t\t\t<div class="chart-wizard__department_control-wrapper">\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tclass="ui-ctl ui-ctl-textbox"\n\t\t\t\t\t\t\t:class="{ 'ui-ctl-warning': shouldErrorHighlight && departmentName?.trim() === '' }"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\tv-model="departmentName"\n\t\t\t\t\t\t\t\ttype="text"\n\t\t\t\t\t\t\t\tmaxlength="255"\n\t\t\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\t\t\tref="title"\n\t\t\t\t\t\t\t\t:placeholder="namePlaceholder"\n\t\t\t\t\t\t\t\t@input="applyData()"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div v-if="isTeamEntity" \n\t\t\t\t\t\t\t class="chart-wizard__department__color-picker" \n\t\t\t\t\t\t\t @click="showColorPicker = true"\n\t\t\t\t\t\t\t ref="TeamColorPicker"\n\t\t\t\t\t\t\t :data-test-id="'wizard-department-color-picker'"\n\t\t\t\t\t\t\t :class="{ '--active': showColorPicker }"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div class="chart-wizard__department__color-picker_inner"\n\t\t\t\t\t\t\t\t :style="{ 'background-color': teamColorValue?.pickerColor }"\n\t\t\t\t\t\t\t></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="shouldErrorHighlight && departmentName?.trim() === ''"\n\t\t\t\t\t\tclass="chart-wizard__department_item-error"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div class="ui-icon-set --warning"></div>\n\t\t\t\t\t\t<span class="chart-wizard__department_item-error-message">\n\t\t\t\t\t\t\t{{\n\t\t\t\t\t\t\t\tisTeamEntity\n\t\t\t\t\t\t\t\t\t? loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TEAM_NAME_ERROR')\n\t\t\t\t\t\t\t\t\t: loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_DEPARTMENT_NAME_ERROR')\n\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="chart-wizard__department_item">\n\t\t\t\t\t<span class="chart-wizard__department_item-label">\n\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_DEPARTMENT_DESCR_LABEL') }}\n\t\t\t\t\t</span>\n\t\t\t\t\t<div class="ui-ctl ui-ctl-textarea ui-ctl-no-resize">\n\t\t\t\t\t\t<textarea\n\t\t\t\t\t\t\tv-model="departmentDescription"\n\t\t\t\t\t\t\tmaxlength="255"\n\t\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\t\tref="description"\n\t\t\t\t\t\t\t:placeholder="descriptionPlaceholder"\n\t\t\t\t\t\t\t@change="applyData()"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t</textarea>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div\n\t\t\t\t\tv-show="isTeamEntity"\n\t\t\t\t\tclass="chart-wizard__department_item chart-wizard__department_higher_bottom"\n\t\t\t\t></div>\n\t\t\t</div>\n\t\t\t<TeamColorPicker\n\t\t\t\tv-if="showColorPicker"\n\t\t\t\t:bindElement="$refs.TeamColorPicker"\n\t\t\t\tv-model="teamColorValue"\n\t\t\t\t@update:model-value="applyData()"\n\t\t\t\t@close="showColorPicker = false"\n\t\t\t/>\n\t\t</div>\n\t`};const N=Object.freeze({moveUsers:"moveUsers",addUsers:"addUsers"});const g={name:"changeSaveModeControl",emits:["saveModeChanged"],components:{RouteActionMenu:c.RouteActionMenu},created(){this.menuItems=this.getMenuItems()},data(){return{menuVisible:false,actionId:N.moveUsers}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},onActionMenuItemClick(t){this.actionId=t;this.$emit("saveModeChanged",t)},getMenuItems(){return[{id:N.moveUsers,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_SAVE_MODE_MOVE_USERS_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_SAVE_MODE_MOVE_USERS_DESCRIPTION"),bIcon:{name:d.Main.PERSON_ARROW_LEFT_1,size:20,color:T.getColorCode("paletteBlue50")}},{id:N.addUsers,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_SAVE_MODE_ADD_USERS_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_SAVE_MODE_ADD_USERS_DESCRIPTION"),bIcon:{name:d.CRM.PERSON_PLUS_2,size:20,color:T.getColorCode("paletteBlue50")}}]}},computed:{getControlButtonText(){const t=this.actionId===N.moveUsers?"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_SAVE_MODE_MOVE_USERS_TITLE":"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_SAVE_MODE_ADD_USERS_TITLE";return this.loc(t)}},template:`\n\t\t<div\n\t\t\tclass="chart-wizard__change-save-mode-control-container"\n\t\t>\n\t\t\t<span>{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_SAVE_MODE_CONTROL_TEXT') }}</span>\n\t\t\t<a\n\t\t\t\tclass="chart-wizard__change-save-mode-control-button"\n\t\t\t\t:class="{ '--focused': menuVisible }"\n\t\t\t\tref='changeSaveModeButton'\n\t\t\t\t@click="menuVisible = true"\n\t\t\t>\n\t\t\t\t{{ getControlButtonText }}\n\t\t\t</a>\n\t\t</div>\n\t\t<RouteActionMenu\n\t\t\tv-if="menuVisible"\n\t\t\t:id="'hr-wizard-save-mode-menu'"\n\t\t\t:items="menuItems"\n\t\t\t:width="302"\n\t\t\t:bindElement="$refs.changeSaveModeButton"\n\t\t\t@action="onActionMenuItemClick"\n\t\t\t@close="menuVisible = false"\n\t\t/>\n\t`};const M={name:"employees",components:{ChangeSaveModeControl:g},emits:["applyData","saveModeChanged"],props:{heads:{type:Array,required:true},employeesIds:{type:Array,required:true},isEditMode:{type:Boolean,required:true},entityType:{type:String,required:true}},created(){this.memberRoles=m.getMemberRoles(this.entityType);this.selectedUsers=new Set;this.departmentHeads=[];this.departmentEmployees=[];this.removedUsers=[];this.headSelector=this.getUserSelector(m.memberRolesKeys.head);this.deputySelector=this.getUserSelector(m.memberRolesKeys.deputyHead);this.employeesSelector=this.getUserSelector(m.memberRolesKeys.employee);this.userCount=0;this.initialUsers=this.heads.reduce(((t,e)=>t.add(e.id)),new Set);this.employeesIds.forEach((t=>this.initialUsers.add(t)))},mounted(){this.headSelector.renderTo(this.$refs["head-selector"]);this.deputySelector.renderTo(this.$refs["deputy-selector"]);this.employeesSelector.renderTo(this.$refs["employees-selector"])},activated(){this.$emit("applyData",{isDepartmentDataChanged:false,isValid:true})},watch:{entityType(t){const e=this.memberRoles;const s=Object.keys(e);this.memberRoles=m.getMemberRoles(t);this.departmentHeads=this.departmentHeads.map((t=>{const i=s.find((s=>e[s]===t.role));return{...t,role:this.memberRoles[i]}}));this.departmentEmployees=this.departmentEmployees.map((t=>({...t,role:this.memberRoles.employee})))},employeesIds:{handler(t){this.employeesIds.forEach((t=>this.initialUsers.add(t)));const e=t.map((t=>["user",t]));const{dialog:s}=this.employeesSelector;s.setPreselectedItems(e);s.load()}}},methods:{getPreselectedItems(t){if(this.memberRoles.employee===t){return this.employeesIds.map((t=>["user",t]))}return this.heads.filter((e=>e.role===t)).map((t=>["user",t.id]))},getUserSelector(t){const e=new h.TagSelector({events:{onTagAdd:e=>{const{tag:s}=e.getData();this.selectedUsers.add(s.id);this.onSelectorToggle(s,this.memberRoles[t]);if(this.initialUsers.has(s.id)){this.initialUsers.delete(s.id)}else{this.applyData()}},onTagRemove:e=>{const{tag:s}=e.getData();this.selectedUsers.delete(s.id);this.onSelectorToggle(s,this.memberRoles[t]);this.applyData()}},multiple:true,dialogOptions:{preselectedItems:this.getPreselectedItems(this.memberRoles[t]),popupOptions:{events:{onBeforeShow:()=>{s.setHeight(250);if(s.isLoaded()){this.toggleUsers(s)}}}},events:{onShow:()=>{const{dialog:t}=e;const s=t.getContainer();const{top:i}=s.getBoundingClientRect();const n=i+s.offsetHeight-document.body.offsetHeight;if(n>0){const e=5;t.setHeight(s.offsetHeight-n-e)}},onLoad:t=>{this.toggleUsers(s);const e=t.target.items.get("user");e.forEach((t=>{t.setLink("")}))},"SearchTab:onLoad":()=>{this.toggleUsers(s)}},height:250,width:380,entities:[{id:"user",options:{intranetUsersOnly:true,inviteEmployeeLink:true}}],dropdownMode:true,hideOnDeselect:false}});const s=e.getDialog();return e},loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},toggleUsers(t){const e=t.getItems();e.forEach((e=>{const s=this.selectedUsers.has(e.id)&&!t.selectedItems.has(e);e.setHidden(s)}))},onSelectorToggle(t,e){const s=t.selector.dialog.getItem(["user",t.id]);const i=T.getUserDataBySelectorItem(s,e);const n=e===this.memberRoles.employee;if(!t.rendered){this.removedUsers=this.removedUsers.filter((t=>t.id!==i.id));if(n){this.departmentEmployees=[...this.departmentEmployees,{...i}]}else{this.departmentHeads=[...this.departmentHeads,{...i}]}this.userCount+=1;return}const{preselectedItems:a=[]}=t.selector.dialog;const r=a.flat().filter((t=>t!=="user"));if(r.includes(i.id)){this.removedUsers=[...this.removedUsers,{...i,role:e}]}if(n){this.departmentEmployees=this.departmentEmployees.filter((e=>e.id!==t.id))}else{this.departmentHeads=this.departmentHeads.filter((e=>e.id!==t.id))}this.userCount-=1},applyData(){this.$emit("applyData",{apiEntityChanged:T.WizardApiEntityChangedDict.employees,heads:this.departmentHeads,employees:this.departmentEmployees,removedUsers:this.removedUsers,userCount:this.userCount,isDepartmentDataChanged:true})},handleSaveModeChangedChanged(t){this.$emit("saveModeChanged",t)}},computed:{isTeamEntity(){return this.entityType===T.EntityTypes.team},headTitle(){return this.isTeamEntity?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_TEAM_HEAD_TITLE"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_HEAD_TITLE")},headDescription(){return this.isTeamEntity?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_TEAM_HEAD_DESCR"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_HEAD_DESCR")},deputyTitle(){return this.isTeamEntity?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_TEAM_DEPUTY_TITLE"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_DEPUTY_TITLE")},deputyDescription(){return this.isTeamEntity?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_TEAM_DEPUTY_DESCR"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_DEPUTY_DESCR")},employeeTitle(){return this.isTeamEntity?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_TEAM_EMPLOYEES_TITLE"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_EMPLOYEES_TITLE")}},template:`\n\t\t<div class="chart-wizard__employee">\n\t\t\t<div class="chart-wizard__form">\n\t\t\t\t<div class="chart-wizard__employee_item">\n\t\t\t\t\t<span class="chart-wizard__employee_item-label">\n\t\t\t\t\t\t{{ headTitle }}\n\t\t\t\t\t</span>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="chart-wizard__employee_selector"\n\t\t\t\t\t\tref="head-selector"\n\t\t\t\t\t\tdata-test-id="hr-company-structure_chart-wizard__employees-head-selector"\n\t\t\t\t\t/>\n\t\t\t\t\t<span class="chart-wizard__employee_item-description">\n\t\t\t\t\t\t{{ headDescription }}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="chart-wizard__employee_item">\n\t\t\t\t\t<span class="chart-wizard__employee_item-label">\n\t\t\t\t\t\t{{ deputyTitle }}\n\t\t\t\t\t</span>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="chart-wizard__employee_selector"\n\t\t\t\t\t\tref="deputy-selector"\n\t\t\t\t\t\tdata-test-id="hr-company-structure_chart-wizard__employees-deputy-selector"\n\t\t\t\t\t/>\n\t\t\t\t\t<span class="chart-wizard__employee_item-description">\n\t\t\t\t\t\t{{ deputyDescription }}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="chart-wizard__employee_item">\n\t\t\t\t\t<span class="chart-wizard__employee_item-label">\n\t\t\t\t\t\t{{ employeeTitle }}\n\t\t\t\t\t</span>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="chart-wizard__employee_selector"\n\t\t\t\t\t\tref="employees-selector"\n\t\t\t\t\t\tdata-test-id="hr-company-structure_chart-wizard__employees-employee-selector"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<div v-if="!isTeamEntity" class="chart-wizard__employee_item --change-save-mode-control">\n\t\t\t\t\t<ChangeSaveModeControl\n\t\t\t\t\t\tv-if="!isEditMode"\n\t\t\t\t\t\t@saveModeChanged="handleSaveModeChangedChanged"\n\t\t\t\t\t></ChangeSaveModeControl>\n\t\t\t\t\t<div class="chart-wizard__change-save-mode-control-container" v-else>\n\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_EDIT_WIZARD_EMPLOYEE_SAVE_MODE_TEXT') }}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};class v{constructor(){this.phrases={}}getPhrase(t,e){const s=this.phrases[t];if(!s){throw new Error(`Phrase set for key "${t}" is not defined in ${this.constructor.name} selector dictionary.`)}return e?s.team:s.default}getEntityName(){return"im-chat-only"}getTagId(t){return`chat${t.id}`}getItemId(t){return Number(t.id.replace("chat",""))}getEntity(){}getDialogEvents(){return{}}getTestId(t){}getRemovePhrase(t,e){throw new Error("getRemovePhrase must be implemented in inheritor")}}class O extends v{constructor(...t){super(...t);this.phrases={hintText:{team:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_SELECT_CHANNELS_ADD_CHECKBOX_HINT",default:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_SELECT_CHANNELS_ADD_CHECKBOX_HINT_MSGVER_1"},createText:{team:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_SELECT_CHANNELS_ADD_CHECKBOX_LABEL_MSGVER_1",default:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_SELECT_CHANNELS_ADD_CHECKBOX_LABEL_MSGVER_2"},warningText:{team:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_SELECT_CHANNELS_ADD_CHECKBOX_WARNING",default:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_SELECT_CHANNELS_ADD_CHECKBOX_WARNING"}}}getEntity(){return c.getChannelDialogEntity()}getTestId(t){return t.replace("chat","channel")}getRemovePhrase(t,e){if(t){return e?"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_SELECT_CHANNELS_REMOVE_CHECKBOX_LABEL_MSGVER_1":"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_SELECT_CHANNELS_REMOVE_CHECKBOX_LABEL_MSGVER_1"}return e?"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_SELECT_CHANNELS_REMOVE_CHECKBOX_LABEL_NOT_INSIDE":"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_SELECT_CHANNELS_REMOVE_CHECKBOX_LABEL_NOT_INSIDE"}}class f extends v{constructor(...t){super(...t);this.phrases={hintText:{team:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_SELECT_CHATS_ADD_CHECKBOX_HINT",default:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_SELECT_CHATS_ADD_CHECKBOX_HINT_MSGVER_1"},createText:{team:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_SELECT_CHATS_ADD_CHECKBOX_LABEL_MSGVER_1",default:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_SELECT_CHATS_ADD_CHECKBOX_LABEL_MSGVER_2"},warningText:{team:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_SELECT_CHATS_ADD_CHECKBOX_WARNING",default:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_SELECT_CHATS_ADD_CHECKBOX_WARNING"}}}getEntity(){return c.getChatDialogEntity()}getTestId(t){return t}getRemovePhrase(t,e){if(t){return e?"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_SELECT_CHATS_REMOVE_CHECKBOX_LABEL_MSGVER_1":"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_SELECT_CHATS_REMOVE_CHECKBOX_LABEL_MSGVER_1"}return e?"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_SELECT_CHATS_REMOVE_CHECKBOX_LABEL_NOT_INSIDE":"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_SELECT_CHATS_REMOVE_CHECKBOX_LABEL_NOT_INSIDE"}}class H extends v{constructor(...t){super(...t);this.phrases={hintText:{team:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_SELECT_COLLAB_ADD_CHECKBOX_HINT",default:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_SELECT_COLLAB_ADD_CHECKBOX_HINT"},createText:{team:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_SELECT_COLLAB_ADD_CHECKBOX_LABEL",default:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_SELECT_COLLAB_ADD_CHECKBOX_LABEL"},warningText:{team:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_SELECT_COLLAB_ADD_CHECKBOX_WARNING",default:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_SELECT_COLLAB_ADD_CHECKBOX_WARNING"}}}getEntityName(){return"project"}getEntity(){return c.getCollabDialogEntity()}getDialogEvents(){return{onLoad:t=>{const e=t.getTarget();e.removeTab("projects")}}}getTagId(t){return Number(t.id)}getItemId(t){return t.id}getTestId(t){return t.replace("chat","collab")}getRemovePhrase(t,e){if(t){return e?"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_SELECT_COLLAB_REMOVE_CHECKBOX_LABEL":"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_SELECT_COLLAB_REMOVE_CHECKBOX_LABEL"}return e?"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_SELECT_COLLAB_REMOVE_CHECKBOX_LABEL_NOT_INSIDE":"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_SELECT_COLLAB_REMOVE_CHECKBOX_LABEL_NOT_INSIDE"}}function P(t){switch(t){case c.CommunicationsTypeDict.chat:return new f;case c.CommunicationsTypeDict.channel:return new O;case c.CommunicationsTypeDict.collab:return new H;default:throw new Error("Unknown selector type")}}const b="default";const w={name:"communicationSelector",components:{DefaultHint:c.DefaultHint,BIcon:l.BIcon},props:{name:{type:String,required:true},headsCreated:{type:Boolean,required:true},hasCurrentUser:{type:Boolean,required:true},isTeamEntity:{type:Boolean,required:true},initCommunications:{type:Array,required:true},type:{type:String,required:true}},emits:["applyData"],data(){return{createDefault:false}},computed:{selectorDictionary(){return P(this.type)},isChannel(){return this.type===c.CommunicationsTypeDict.channel},set(){return d.Set},hintText(){return this.loc(this.selectorDictionary.getPhrase("hintText",this.isTeamEntity))},createText(){return this.loc(this.selectorDictionary.getPhrase("createText",this.isTeamEntity))},removeText(){return this.loc(this.selectorDictionary.getRemovePhrase(this.hasCurrentUser,this.isTeamEntity))},warningText(){return this.loc(this.selectorDictionary.getPhrase("warningText",this.isTeamEntity))}},watch:{createDefault(t){if(t){this.selector.getDialog().getItem({id:b,entityId:b}).select()}else{this.selector.getDialog().getItem({id:b,entityId:b}).deselect()}},name(t){const e=this.selector.getDialog().getItem({id:b,entityId:b});e.setTitle(t);if(this.createDefault){e.deselect();e.select()}},headsCreated(t){if(!t){this.createDefault=false}},initCommunications:{handler(t){t.forEach((t=>this.initialItemsSet.add(this.selectorDictionary.getTagId(t))));const e=t.map((t=>[this.selectorDictionary.getEntityName(),this.selectorDictionary.getTagId(t)]));const{dialog:s}=this.selector;s.setPreselectedItems(e);s.load()}}},created(){this.communications=[];this.initialItemsSet=this.initCommunications.reduce(((t,e)=>t.add(this.selectorDictionary.getTagId(e))),new Set);this.selector=this.getSelector()},mounted(){this.selector.renderTo(this.$refs["communications-selector"])},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},addTag(t){if(!t.searchable){const e=this.initCommunications.find((e=>this.selectorDictionary.getTagId(e)===t.id));if(e!=null&&e.title){t.setTitle(e.title);if(e.hasAccess){t.setDeselectable(true)}}}this.communications.push(this.selectorDictionary.getItemId(t))},getSelector(){var t,e;const s=this.selectorDictionary.getEntity();const i={multiple:true,events:{onTagAdd:t=>{const{tag:e}=t.getData();if(e.id===b){this.createDefault=true}else{this.addTag(e)}if(this.initialItemsSet.has(e.id)){this.initialItemsSet.delete(e.id)}else{this.applyData()}},onTagRemove:t=>{const{tag:e}=t.getData();const s=this.selectorDictionary.getItemId(e);if(e.id===b){this.createDefault=false}else{this.communications=this.communications.filter((t=>t!==s))}this.applyData()}},dialogOptions:{enableSearch:true,height:250,width:380,dropdownMode:true,events:this.selectorDictionary.getDialogEvents(),recentTabOptions:c.getCommunicationsRecentTabOptions(this.entityType,this.type),items:[this.getDefaultItem((t=s.tagOptions)==null?void 0:t.default,(e=s.itemOptions)==null?void 0:e.default)],preselectedItems:this.initCommunications.map((t=>[this.selectorDictionary.getEntityName(),this.selectorDictionary.getTagId(t)])),entities:[s]}};return new h.TagSelector(i)},getDefaultItem(t={},e={}){return{id:b,entityId:b,title:this.name,searchable:false,tagOptions:t,...e}},applyData(){this.$emit("applyData",{type:this.type,communications:this.communications,createDefault:this.createDefault})}},template:`\n\t\t<div\n\t\t\tclass="chart-wizard__chat_selector"\n\t\t\tref="communications-selector"\n\t\t\t:data-test-id="selectorDictionary.getTestId('hr-company-structure_chart-wizard__chat-selector')"\n\t\t/>\n\t\t<div\n\t\t\tv-if="!createDefault"\n\t\t\tclass="chart-wizard__bind-chat__item-checkbox_container"\n\t\t>\n\t\t\t<div\n\t\t\t\t@click="createDefault = headsCreated"\n\t\t\t\tclass="chart-wizard__bind-chat__item-create"\n\t\t\t\t:class="{ '--disabled': !headsCreated }"\n\t\t\t\t:data-test-id="selectorDictionary.getTestId('hr-company-structure_chart-wizard__make-default-chat-create')"\n\t\t\t\tv-html="createText"\n\t\t\t>\n\t\t\t</div>\n\t\t\t<DefaultHint :content="hintText" />\n\t\t</div>\n\t\t<div v-else class="chart-wizard__bind-chat__item-checkbox_container">\n\t\t\t<div class="ui-icon-set --o-circle-check"></div>\n\t\t\t<div\n\t\t\t\tclass="chart-wizard__bind-chat__item-remove"\n\t\t\t\t:class="{ '--disabled': !headsCreated }"\n\t\t\t\t:data-test-id="selectorDictionary.getTestId('hr-company-structure_chart-wizard__make-default-chat-remove')"\n\t\t\t>\n\t\t\t\t{{ removeText }}\n\t\t\t</div>\n\t\t</div>\n\t\t<div v-if="!headsCreated" class="chart-wizard__bind-chat__item-checkbox_warning">\n\t\t\t<BIcon\n\t\t\t\t:name="set.WARNING"\n\t\t\t\tcolor="#FFA900"\n\t\t\t\t:size="16"\n\t\t\t></BIcon>\n\t\t\t<span>\n\t\t\t\t{{ warningText }}\n\t\t\t</span>\n\t\t</div>\n\t`};const L={name:"bindChat",components:{CommunicationSelector:w},props:{heads:{type:Array,required:false,default:()=>[]},employees:{type:Array,required:false,default:()=>[]},employeesIds:{type:Array,required:false,default:()=>[]},name:{type:String,required:true},entityType:{type:String,required:true},isEditMode:{type:Boolean,required:true},initChats:{type:Array,required:true},initChannels:{type:Array,required:true},initCollabs:{type:Array,required:true}},emits:["applyData"],computed:{isCollabsAvailable(){return u.PermissionChecker.getInstance().isCollabsAvailable},headsCreated(){const t=m.getMemberRoles(this.entityType);return this.heads.some((e=>e.role===t.head))},hasCurrentUser(){return this.heads.some((t=>t.id===this.userId))||this.employeesIds.includes(this.userId)||this.employees.some((t=>t.id===this.userId))},isTeamEntity(){return this.entityType===T.EntityTypes.team},hints(){if(this.isCollabsAvailable){if(this.isTeamEntity){return[this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_HINT_1_W_COLLABS"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_HINT_2_MSGVER_1"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_HINT_3_W_COLLABS")]}return[this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_HINT_1_W_COLLABS"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_HINT_2_MSGVER_2"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_HINT_3_W_COLLABS")]}if(this.isTeamEntity){return[this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_HINT_1"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_HINT_2_MSGVER_1"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_HINT_3")]}return[this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_HINT_1_MSGVER_1"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_HINT_2_MSGVER_2"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_HINT_3")]},ChatTypeDict(){return c.CommunicationsTypeDict},hintTitle(){if(this.isCollabsAvailable){return this.isTeamEntity?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_HINT_TITLE_W_COLLABS"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_HINT_TITLE_W_COLLABS")}return this.isTeamEntity?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_HINT_TITLE"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_HINT_TITLE")},...o.mapState(p.useChartStore,["userId"])},watch:{initChats(t){this.chats=t.map((t=>t.id))},initChannels(t){this.channels=t.map((t=>t.id))},initCollabs(t){this.collabs=t.map((t=>t.id))}},created(){this.chats=this.initChats.map((t=>t.id));this.channels=this.initChannels.map((t=>t.id));this.collabs=this.initCollabs.map((t=>Number(t.id)));this.createDefaultChat=false;this.createDefaultChannel=false;this.createDefaultCollab=false},activated(){this.$emit("applyData",{isDepartmentDataChanged:false,isValid:true})},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},applyData(){this.$emit("applyData",{apiEntityChanged:T.WizardApiEntityChangedDict.bindChats,chats:this.chats,channels:this.channels,collabs:this.collabs,createDefaultChat:this.createDefaultChat,createDefaultChannel:this.createDefaultChannel,createDefaultCollab:this.createDefaultCollab,isDepartmentDataChanged:true})},onCommunicationSelectorChanged(t){if(t.type===c.CommunicationsTypeDict.chat){this.chats=t.communications;this.createDefaultChat=t.createDefault}else if(t.type===c.CommunicationsTypeDict.channel){this.channels=t.communications;this.createDefaultChannel=t.createDefault}else{this.collabs=t.communications;this.createDefaultCollab=t.createDefault}this.applyData()}},template:`\n\t\t<div class="chart-wizard__bind-chat">\n\t\t\t<div class="chart-wizard__bind-chat__item">\n\t\t\t\t<div v-if="!isEditMode" class="chart-wizard__bind-chat__item-hint" :class="{ '--team': isTeamEntity }">\n\t\t\t\t\t<div class="chart-wizard__bind-chat__item-hint_logo" :class="{ '--team': isTeamEntity }"></div>\n\t\t\t\t\t<div class="chart-wizard__bind-chat__item-hint_text">\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tclass="chart-wizard__bind-chat__item-hint_title"\n\t\t\t\t\t\t\tv-html="hintTitle"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div v-for="hint in hints"\n\t\t\t\t\t\t\t class="chart-wizard__bind-chat__item-hint_text-item"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tclass="chart-wizard__bind-chat__item-hint_text-item_icon"\n\t\t\t\t\t\t\t\t:class="{ '--team': isTeamEntity }"\n\t\t\t\t\t\t\t></div>\n\t\t\t\t\t\t\t<span>{{ hint }}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="chart-wizard__bind-chat__item-options" v-if="isCollabsAvailable">\n\t\t\t\t\t<div class="chart-wizard__bind-chat__item-options__item-content_title">\n\t\t\t\t\t\t<div class="chart-wizard__bind-chat__item-options__item-content_title-text">\n\t\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_SELECT_COLLAB_TITLE') }}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<span class="chart-wizard__bind-chat__item-description">\n\t\t\t\t\t\t{{\n\t\t\t\t\t\t\tisTeamEntity\n\t\t\t\t\t\t\t\t? loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_SELECT_COLLAB_DESCRIPTION')\n\t\t\t\t\t\t\t\t: loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_SELECT_COLLAB_DESCRIPTION')\n\t\t\t\t\t\t}}\n\t\t\t\t\t</span>\n\t\t\t\t\t<CommunicationSelector\n\t\t\t\t\t\t:name="name"\n\t\t\t\t\t\t:headsCreated="headsCreated"\n\t\t\t\t\t\t:hasCurrentUser="hasCurrentUser"\n\t\t\t\t\t\t:initCommunications="initCollabs"\n\t\t\t\t\t\t:type="ChatTypeDict.collab"\n\t\t\t\t\t\t:isTeamEntity="isTeamEntity"\n\t\t\t\t\t\t@applyData="onCommunicationSelectorChanged"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<div class="chart-wizard__bind-chat__item-options">\n\t\t\t\t\t<div class="chart-wizard__bind-chat__item-options__item-content_title">\n\t\t\t\t\t\t<div class="chart-wizard__bind-chat__item-options__item-content_title-text">\n\t\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_SELECT_CHANNELS_TITLE') }}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<span class="chart-wizard__bind-chat__item-description">\n\t\t\t\t\t\t{{\n\t\t\t\t\t\t\tisTeamEntity\n\t\t\t\t\t\t\t\t? loc(\n\t\t\t\t\t\t\t\t\t'HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_SELECT_CHANNELS_DESCRIPTION')\n\t\t\t\t\t\t\t\t: loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_SELECT_CHANNELS_DESCRIPTION')\n\t\t\t\t\t\t}}\n\t\t\t\t\t</span>\n\t\t\t\t\t<CommunicationSelector\n\t\t\t\t\t\t:name="name"\n\t\t\t\t\t\t:headsCreated="headsCreated"\n\t\t\t\t\t\t:hasCurrentUser="hasCurrentUser"\n\t\t\t\t\t\t:initCommunications="initChannels"\n\t\t\t\t\t\t:type="ChatTypeDict.channel"\n\t\t\t\t\t\t:isTeamEntity="isTeamEntity"\n\t\t\t\t\t\t@applyData="onCommunicationSelectorChanged"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<div class="chart-wizard__bind-chat__item-options">\n\t\t\t\t\t<div class="chart-wizard__bind-chat__item-options__item-content_title">\n\t\t\t\t\t\t<div class="chart-wizard__bind-chat__item-options__item-content_title-text">\n\t\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_SELECT_CHATS_TITLE') }}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<span class="chart-wizard__bind-chat__item-description">\n\t\t\t\t\t\t{{\n\t\t\t\t\t\t\tisTeamEntity\n\t\t\t\t\t\t\t\t? loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_SELECT_CHATS_DESCRIPTION')\n\t\t\t\t\t\t\t\t: loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_SELECT_CHATS_DESCRIPTION')\n\t\t\t\t\t\t}}\n\t\t\t\t\t</span>\n\t\t\t\t\t<CommunicationSelector\n\t\t\t\t\t\t:name="name"\n\t\t\t\t\t\t:headsCreated="headsCreated"\n\t\t\t\t\t\t:initCommunications="initChats"\n\t\t\t\t\t\t:hasCurrentUser="hasCurrentUser"\n\t\t\t\t\t\t:type="ChatTypeDict.chat"\n\t\t\t\t\t\t:isTeamEntity="isTeamEntity"\n\t\t\t\t\t\t@applyData="onCommunicationSelectorChanged"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const B={props:{parentId:{type:[Number,null],required:true}},components:{ResponsiveHint:c.ResponsiveHint},data(){return{selectedEntityType:T.EntityTypes.department}},emits:["applyData"],created(){this.hint=null;this.hintHideTimeout=null;const t=u.PermissionChecker.getInstance();const e=this.parentId===0?t.hasPermissionOfAction(u.PermissionActions.teamCreate):t.hasPermission(u.PermissionActions.teamCreate,this.parentId);const s=this.parentId===0?t.hasPermissionOfAction(u.PermissionActions.departmentCreate):t.hasPermission(u.PermissionActions.departmentCreate,this.parentId);this.entities=[{type:T.EntityTypes.department,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_ENTITY_DEPARTMENT_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_ENTITY_DEPARTMENT_DESCR_MSGVER_1"),isEnabled:s,hint:!s&&this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_ENTITY_DEPARTMENT_NO_ACCESS_HINT"),isSoon:false},{type:T.EntityTypes.team,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_ENTITY_FUNCTIONAL_TEAM_TITLE_MSGVER_1"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_ENTITY_FUNCTIONAL_TEAM_DESCR_MSGVER_1"),isEnabled:u.PermissionChecker.isTeamsAvailable&&e,hint:u.PermissionChecker.isTeamsAvailable&&!e&&this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_ENTITY_FUNCTIONAL_TEAM_NO_ACCESS_HINT_MSGVER_1"),isSoon:!t.isTeamsAvailable}];for(const t of this.entities){if(t.isEnabled){this.selectedEntityType=t.type;break}}this.applyData(this.selectedEntityType)},activated(){this.applyData(this.selectedEntityType)},deactivated(){var t;(t=this.hint)==null?void 0:t.hide();clearTimeout(this.hintHideTimeout);this.hintHideTimeout=null},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},applyData(t){this.selectedEntityType=t;this.$emit("applyData",{isValid:true,isDepartmentDataChanged:false,entityType:this.selectedEntityType})},showHint(t,e){if(this.hintHideTimeout){return}const s=300;this.hint=_.Reflection.getClass("BX.UI.Hint").createInstance({popupParameters:{width:s,bindOptions:{position:"top"},offsetLeft:225,offsetTop:-23,angle:{offset:s/2-33/2}}});this.hint.show(e.target,t);this.hintHideTimeout=setTimeout((()=>{var t;(t=this.hint)==null?void 0:t.hide();this.hintHideTimeout=null}),2e3)}},template:`\n\t\t<div\n\t\t\tv-for="entity in entities"\n\t\t\tclass="chart-wizard__entity-wrapper"\n\t\t>\n\t\t\t<span v-if="entity.hint" @click="showHint(entity.hint, $event)" class="ui-hint chart-wizard__entity_hint-layout"></span>\n\t\t\t<div class="chart-wizard__entity"\n\t\t\t\t :class="{ \n\t\t\t\t\t['--' + entity.type.toLowerCase()]: true, \n\t\t\t\t\t'--selected': entity.type === selectedEntityType, \n\t\t\t\t\t'--enabled': entity.isEnabled \n\t\t\t\t}"\n\t\t\t\t@click="entity.isEnabled && applyData(entity.type)"\n\t\t\t>\n\t\t\t\t<div class="chart-wizard__entity_summary">\n\t\t\t\t\t<h2\n\t\t\t\t\t\tclass="chart-wizard__entity_title"\n\t\t\t\t\t\t:data-title="entity.isSoon ? loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_ENTITY_ACCESS_TITLE') : null"\n\t\t\t\t\t\t:class="{ '--disabled': !entity.isEnabled, '--soon': entity.isSoon }"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{entity.title}}\n\t\t\t\t\t</h2>\n\t\t\t\t\t<p class="chart-wizard__entity_description" :class="{ '--disabled': !entity.isEnabled}">\n\t\t\t\t\t\t{{entity.description}}\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const Y={name:"teamRights",emits:["applyData"],props:{name:{type:String,required:true},settings:{type:Object,required:false},features:{type:Object,required:false},shouldErrorHighlight:{type:Boolean,required:true}},created(){this.hints=[this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TEAM_RIGHTS_HINT_1"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TEAM_RIGHTS_HINT_2")];this.initBpValues=new Set;this.businessProcSelector=this.getTagSelector(T.NodeSettingsTypes.businessProcAuthority,false);this.reportsSelector=this.getTagSelector(T.NodeSettingsTypes.reportsAuthority,true)},mounted(){this.businessProcSelector.renderTo(this.$refs["business-proc-selector"]);this.reportsSelector.renderTo(this.$refs["reports-selector"])},activated(){this.$emit("applyData",{isDepartmentDataChanged:false,isValid:!this.isBusinessProcHeadNotSelected})},watch:{settings:{handler(t){if(t[T.NodeSettingsTypes.businessProcAuthority]){const e=this.getTagItems(false).filter((e=>t[T.NodeSettingsTypes.businessProcAuthority].has(e.id)));e.forEach((t=>{const e=this.businessProcSelector.dialog.getItem(["head-type",t.id]);if(e){this.initBpValues.add(t.id);e.select()}}))}}}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},applyData(){this.$emit("applyData",{apiEntityChanged:T.WizardApiEntityChangedDict.settings,settings:this.settings,isDepartmentDataChanged:true,isValid:!this.isBusinessProcHeadNotSelected})},getTagSelector(t,e){return new h.TagSelector({events:{onTagAdd:e=>{const{tag:s}=e.getData();this.settings[t].add(s.id);if(this.initBpValues.has(s.id)){this.initBpValues.delete(s.id)}else{this.applyData()}},onTagRemove:e=>{const{tag:s}=e.getData();this.settings[t].delete(s.id);this.applyData()}},multiple:true,id:"head-type-selector",locked:e,tagFontWeight:"700",showAddButton:!e,dialogOptions:{id:"head-type-selector",events:{"Item:onBeforeSelect":t=>{var e;const{item:s}=t.getData();if(!((e=s.getCustomData())!=null&&e.get("selectable"))){t.preventDefault()}}},width:400,height:200,tagMaxWidth:400,dropdownMode:true,showAvatars:false,selectedItems:this.getTagItems(e).filter((e=>this.settings[t].has(e.id))),items:this.getTagItems(e),undeselectedItems:this.features.isDeputyApprovesBPAvailable?[]:[["head-type",A.departmentHead]]}})},getTagItems(t){const e={bgColor:"#BDC1C6",textColor:"#525C69"};const s={bgColor:"#ADE7E4",textColor:"#207976",maxWidth:400};const i={bgColor:"#CCE3FF",textColor:"#3592FF",maxWidth:400};const n={customData:{selectable:false},textColor:"#C9CCD0",badges:[{title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TEAM_RIGHTS_SOON_ITEM_BADGE"),textColor:"#FFFFFF",bgColor:"#2FC6F6"}],badgesOptions:{justifyContent:"right"}};const a=this.features.isDeputyApprovesBPAvailable?{customData:{selectable:true}}:n;const r={id:A.departmentHead,entityId:"head-type",tabs:"recents",title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TEAM_RIGHTS_DEPARTMENT_HEAD_ITEM"),tagOptions:t?e:s,customData:{selectable:true}};const o={id:A.teamHead,entityId:"head-type",tabs:"recents",title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TEAM_RIGHTS_TEAM_HEAD_ITEM"),tagOptions:t?e:i,customData:{selectable:true}};const d={id:A.departmentDeputy,entityId:"head-type",tabs:"recents",title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TEAM_RIGHTS_DEPARTMENT_DEPUTY_ITEM"),tagOptions:t?e:s,...a};const l={id:A.teamDeputy,entityId:"head-type",tabs:"recents",title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TEAM_RIGHTS_TEAM_DEPUTY_ITEM"),tagOptions:t?e:i,...a};return this.features.isDeputyApprovesBPAvailable?[r,d,o,l]:[r,o,d,l]},goToBPHelp(t){if(top.BX.Helper){t.preventDefault();top.BX.Helper.show("redirect=detail&code=25455744")}}},computed:{businessDescription(){return this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TEAM_RIGHTS_BUSINESS_PROC_DESCRIPTION",{"#DEPARTMENT_NAME#":_.Text.encode(this.name)})},reportsDescriptions(){return this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TEAM_RIGHTS_REPORTS_DESCRIPTION",{"#DEPARTMENT_NAME#":_.Text.encode(this.name)})},isBusinessProcHeadNotSelected(){const t=this.settings[T.NodeSettingsTypes.businessProcAuthority];return!t||t.size===0}},template:`\n\t\t<div class="chart-wizard__team-rights">\n\t\t\t<div class="chart-wizard__team-rights__item">\n\t\t\t\t<div class="chart-wizard__team-rights__item-hint --team">\n\t\t\t\t\t<div class="chart-wizard__team-rights__item-hint_logo --team"></div>\n\t\t\t\t\t<div class="chart-wizard__team-rights__item-hint_text">\n\t\t\t\t\t\t<div class="chart-wizard__team-rights__item-hint_title">\n\t\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TEAM_RIGHTS_HINT_TITLE') }}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div v-for="hint in hints"\n\t\t\t\t\t\t\tclass="chart-wizard__team-rights__item-hint_text-item"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tclass="chart-wizard__team-rights__item-hint_text-item_icon --team"\n\t\t\t\t\t\t\t></div>\n\t\t\t\t\t\t\t<span>{{ hint }}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="chart-wizard__team-rights__item-options">\n\t\t\t\t\t<div class="chart-wizard__team-rights__item-options__item-content_title"\n\t\t\t\t\t\t :data-title="loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_ENTITY_ACCESS_TITLE')"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div class="chart-wizard__team-rights__item-options__item-content_title-text">\n\t\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TEAM_RIGHTS_BUSINESS_PROC_TITLE') }}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<span class="ui-hint" @click="goToBPHelp">\n\t\t\t\t\t\t\t<span class="ui-hint-icon"/>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="chart-wizard__team-rights__item-description-container">\n\t\t\t\t\t\t<span class="chart-wizard__team-rights__item-description-text" v-html="businessDescription">\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="chart-wizard__team-rights__business-proc-selector"\n\t\t\t\t\t\t:class="{ 'ui-ctl-warning': (isBusinessProcHeadNotSelected && shouldErrorHighlight) }"\n\t\t\t\t\t\tref="business-proc-selector"\n\t\t\t\t\t\tdata-test-id="hr-company-structure__team-rights__business-proc-selector"\n\t\t\t\t\t/>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="shouldErrorHighlight && isBusinessProcHeadNotSelected"\n\t\t\t\t\t\tclass="chart-wizard__team-rights__item-options-error"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div class="ui-icon-set --warning"></div>\n\t\t\t\t\t\t<span class="chart-wizard__team-rights__item-options-error-message">\n\t\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TEAM_RIGHTS_BUSINESS_PROC_HEAD_ERROR') }}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="chart-wizard__team-rights__item-options">\n\t\t\t\t\t<div class="chart-wizard__team-rights__item-options__item-content_title --soon"\n\t\t\t\t\t\t :data-title="loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_ENTITY_ACCESS_TITLE')"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div class="chart-wizard__team-rights__item-options__item-content_title-text">\n\t\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TEAM_RIGHTS_REPORTS_TITLE') }}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<span class="chart-wizard__team-rights_ui-hint-disabled">\n\t\t\t\t\t\t\t<span class="ui-hint-icon"/>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="chart-wizard__team-rights__item-description-container">\n\t\t\t\t\t\t<span class="chart-wizard__team-rights__item-description-text --soon" v-html="reportsDescriptions">\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="chart-wizard__team-rights__reports-selector"\n\t\t\t\t\t\tref="reports-selector"\n\t\t\t\t\t\tdata-test-id="hr-company-structure__team-rights__reports-selector"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const z={name:"AccessDenied",mounted(){this.$emit("applyData",{isDepartmentDataChanged:false,isValid:true})},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)}},template:`\n\t\t<div class="chart-wizard__access-denied">\n\t\t\t<div class="chart-wizard__access-denied_icon"></div>\n\t\t\t<div class="chart-wizard__access-denied_title">\n\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_ACCESS_DENIED_TITLE') }}\n\t\t\t</div>\n\t\t\t<div class="chart-wizard__access-denied_description">\n\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_ACCESS_DENIED_DESCRIPTION') }}\n\t\t\t</div>\n\t\t</div>\n\t`};const W={createDepartment:(t,e,s,i,n,a,r,o,d,l,c)=>m.postData("humanresources.api.Structure.Department.create",{name:t,parentId:e,description:s,userIds:i,moveUsersToDepartment:n,createChat:a,bindingChatIds:r,createChannel:o,bindingChannelIds:d,createCollab:l,bindingCollabIds:c}),createTeam:(t,e,s,i,n,a,r,o,d,l,c,_)=>m.postData("humanresources.api.Structure.Team.create",{name:t,parentId:e,description:s,colorName:i,userIds:n,createChat:a,bindingChatIds:r,createChannel:o,bindingChannelIds:d,createCollab:l,bindingCollabIds:c,settings:_}),addDepartment:(t,e,s,i,n)=>m.postData("humanresources.api.Structure.Node.add",{name:t,parentId:e,description:s,entityType:i,colorName:n}),getEmployees:t=>m.postData("humanresources.api.Structure.Node.Member.Employee.getIds",{nodeId:t}),updateDepartment:(t,e,s,i,n)=>m.postData("humanresources.api.Structure.Node.update",{nodeId:t,name:s,parentId:e,description:i,colorName:n}),saveUsers:(t,e,s)=>m.postData("humanresources.api.Structure.Node.Member.saveUserList",{nodeId:t,userIds:e,parentId:s}),moveUsers:(t,e,s)=>m.postData("humanresources.api.Structure.Node.Member.moveUserListToDepartment",{nodeId:t,userIds:e,parentId:s}),saveChats:(t,e,s={},i={})=>m.postData("humanresources.api.Structure.Node.Member.Chat.saveChatList",{nodeId:t,ids:e,createDefault:s,removeIds:i}),createSettings:(t,e,s)=>m.postData("humanresources.api.Structure.Node.NodeSettings.create",{settings:e,nodeId:t,parentId:s}),updateSettings:(t,e,s)=>m.postData("humanresources.api.Structure.Node.NodeSettings.update",{settings:e,nodeId:t,parentId:s}),getSettings:t=>m.postData("humanresources.api.Structure.Node.NodeSettings.get",{nodeId:t}),getChatsAndChannels:t=>m.getData("humanresources.api.Structure.Node.Member.Chat.getList",{nodeId:t})};const Z={createDepartment:t=>{var e;const{departments:s,structureMap:i}=p.useChartStore();const{id:n,parentId:a,entityType:r}=t;const o=s.get(a);o.children=[...(e=o.children)!=null?e:[],n];i.set(n,{id:n,parentId:a,entityType:r});s.set(n,{...t,id:n,chats:null,channels:null})},moveUsersToRootDepartment:(t,e)=>{const{departments:s}=p.useChartStore();const i=t.filter((t=>e.includes(t.id)));const n=[...s.values()].find((t=>t.parentId===0));s.set(n.id,{...n,employees:[...n.employees||[],...i],userCount:n.userCount+i.length})},refreshDepartments:t=>{const e=p.useChartStore();e.refreshDepartments(t)},tryToAddCurrentDepartment(t,e){const s=p.useChartStore();const{heads:i,employees:n}=t;const a=[...i,...n].some((t=>t.id===s.userId));if(a){s.changeCurrentDepartment(0,e)}}};const x=Object.freeze({moveUsers:"moveUsers",addUsers:"addUsers"});const k={name:"chartWizard",emits:["modifyTree","close"],components:{Department:I,Employees:M,BindChat:L,TreePreview:U,Entities:B,TeamRights:Y,AccessDenied:z},props:{nodeId:{type:Number,required:true},isEditMode:{type:Boolean,required:true},showEntitySelector:{type:Boolean,required:false},entity:{type:String},entityType:{type:String,default:T.EntityTypes.department},source:{type:String},refToFocus:{type:String,default:null}},data(){return{stepIndex:0,waiting:false,isValidStep:false,isDepartmentDataChanged:false,departmentData:{id:0,parentId:0,name:"",description:"",heads:[],employees:[],chats:[],channels:[],collabs:[],userCount:0,createDefaultChat:false,createDefaultChannel:false,teamColor:T.NodeColorsSettingsDict.blue,entityType:T.EntityTypes.department,settings:{[T.NodeSettingsTypes.businessProcAuthority]:new Set([A.departmentHead]),[T.NodeSettingsTypes.reportsAuthority]:new Set([A.departmentHead])}},removedUsers:[],employeesIds:[],departmentSettings:{[T.NodeSettingsTypes.businessProcAuthority]:new Set([A.departmentHead]),[T.NodeSettingsTypes.reportsAuthority]:new Set([A.departmentHead])},initChats:[],initChannels:[],initCollabs:[],shouldErrorHighlight:false,steps:[],saveMode:x.moveUsers,permissionChecker:null}},created(){this.permissionChecker=u.PermissionChecker.getInstance();this.init()},beforeUnmount(){_.Event.unbind(window,"beforeunload",this.handleBeforeUnload)},computed:{breadcrumbsTitle(){if(this.isEditMode){return this.isTeamEntity?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EDIT_TEAM_TITLE"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EDIT_TITLE")}return this.isTeamEntity?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_CREATE_TEAM_TITLE"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_CREATE_TITLE")},closeConfirmTitle(){var t;if(this.isEditMode){var e;return((e=this.departmentData)==null?void 0:e.entityType)===T.EntityTypes.team?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_CLOSE_EDIT_WIZARD_TEAM_TITLE"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_CLOSE_EDIT_WIZARD_DEPARTMENT_TITLE")}return((t=this.departmentData)==null?void 0:t.entityType)===T.EntityTypes.team?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_CLOSE_CREATE_WIZARD_TEAM_TITLE"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_CLOSE_CREATE_WIZARD_DEPARTMENT_TITLE")},currentStep(){return this.steps[this.stepIndex]},isDeputyApprovesBPAvailable(){if(!this.permissionChecker){return false}return this.permissionChecker.checkDeputyApprovalBPAvailable()},componentInfo(){if(!this.currentStep.isPermitted){return{name:"AccessDenied"}}const{parentId:t,name:e,description:s,heads:i,entityType:n,teamColor:a,employees:r}=this.departmentData;const o={[R.department]:{name:"Department",params:{parentId:t,name:e,description:s,entityType:n,teamColor:a,refToFocus:this.refToFocus,shouldErrorHighlight:this.shouldErrorHighlight,isEditMode:this.isEditMode}},[R.employees]:{name:"Employees",params:{heads:i,entityType:n,employeesIds:this.employeesIds,isEditMode:this.isEditMode}},[R.bindChat]:{name:"BindChat",params:{heads:i,employees:r,employeesIds:this.employeesIds,name:e,entityType:n,isEditMode:this.isEditMode,initChats:this.initChats,initChannels:this.initChannels,initCollabs:this.initCollabs}},[R.teamRights]:{name:"TeamRights",params:{name:e,settings:this.departmentSettings,features:{isDeputyApprovesBPAvailable:this.isDeputyApprovesBPAvailable},shouldErrorHighlight:this.shouldErrorHighlight}},[R.entities]:{name:"Entities",params:{parentId:t}}};return o[this.currentStep.id]},isFirstStep(){return this.currentStep.id===R.entities},breadcrumbsSteps(){return this.steps.filter((t=>t.hasBreadcrumbs))},rootId(){const{id:t}=[...this.departments.values()].find((t=>t.parentId===0));return t},isTeamEntity(){var t;return((t=this.departmentData)==null?void 0:t.entityType)===T.EntityTypes.team},createButtonText(){return this.isTeamEntity?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_CREATE_TEAM_BTN"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_CREATE_BTN")},...o.mapState(p.useChartStore,["departments","userId","currentDepartments"])},methods:{handleBeforeUnload(t){t.preventDefault()},loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},mapRawSettings(t){return t.reduce(((t,{settingsType:e,settingsValue:s})=>{if(!Object.hasOwn(t,e)){t[e]=new Set}t[e].add(s);return t}),{})},async init(){this.apiEntityChanged=new Set;_.Event.bind(window,"beforeunload",this.handleBeforeUnload);if(this.isEditMode){const{id:t,name:e,description:s,parentId:i,heads:n,userCount:a,children:r,entityType:o,teamColor:d,employees:l=[]}=this.departments.get(this.nodeId);this.getMemberRoles(o);this.createSteps(o,t);this.stepIndex=this.steps.indexOf(this.getStepById(this.entity));this.createDefaultSaveMode(o);this.departmentData={...this.departmentData,id:t,parentId:i,name:e,description:s,heads:n,userCount:a,children:r,employees:l,entityType:o,teamColor:d,createDefaultChat:false,createDefaultChannel:false};const c=await W.getSettings(this.nodeId);const _=this.mapRawSettings(c);this.departmentSettings={...this.departmentSettings,..._};const h=await W.getChatsAndChannels(this.nodeId);this.initChats=h.chats.filter((t=>!t.originalNodeId));this.initChannels=h.channels.filter((t=>!t.originalNodeId));this.initCollabs=h.collabs.filter((t=>!t.originalNodeId));this.employeesIds=await W.getEmployees(this.nodeId);return}if(this.entityType){this.departmentData.entityType=this.entityType}this.getMemberRoles(this.entityType);this.createSteps(this.entityType,this.departmentData.id);this.createDefaultSaveMode(this.entityType);if(this.nodeId){this.departmentData.parentId=this.nodeId;return}this.departmentData.parentId=0;E.sendData({tool:"structure",category:"structure",event:"create_wizard",c_element:this.source})},getMemberRoles(t){this.memberRoles=m.getMemberRoles(t)},move(t="next"){if(!this.isValidStep){this.shouldErrorHighlight=true;return}this.stepIndex=t==="back"?this.stepIndex-1:this.stepIndex+1;this.pickStepsAnalytics()},moveToStep(t){if(!this.isValidStep){this.shouldErrorHighlight=true;return}this.stepIndex=this.steps.indexOf(this.getStepById(t,true));this.pickStepsAnalytics()},getStepById(t,e){const s=this.steps.findIndex((e=>t===e.id));if(s>-1&&(this.steps[s].isEditPermitted||e)){return this.steps[s]}return this.steps.find(((t,e)=>t.isEditPermitted&&e>s))||this.steps.find((t=>R.department===t.id))},close(t=false){this.$emit("close");if(t){E.sendData({tool:"structure",category:"structure",event:"cancel_wizard",c_element:this.source})}},closeWithConfirm(){if(!this.isDepartmentDataChanged){this.close(true);return}const t=new s.MessageBox({title:this.closeConfirmTitle,message:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_CLOSE_WIZARD_MESSAGE"),yesCaption:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_CLOSE_WIZARD_OK_CAPTION"),noCaption:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_CLOSE_WIZARD_NO_CAPTION"),onYes:()=>{this.close(true);return true},minHeight:155,buttons:s.MessageBoxButtons.YES_NO,popupOptions:{closeIcon:true,className:"humanresources-chart-wizard__close-confirm-popup"}});t.getYesButton().setRound(true);t.getNoButton().setRound(true);t.show()},onApplyData(t){var e;const s=this.departmentData.entityType;const{isValid:i=true,removedUsers:n=[],isDepartmentDataChanged:a=true,apiEntityChanged:r=null,...o}=t;this.isValidStep=i;this.isDepartmentDataChanged=this.isDepartmentDataChanged||a;if(r){this.apiEntityChanged.add(r)}if(o){this.departmentData={...this.departmentData,...o}}this.removedUsers=n;if(i){this.shouldErrorHighlight=false}if(s!==this.departmentData.entityType){this.getMemberRoles(this.departmentData.entityType);this.createSteps(this.departmentData.entityType,this.departmentData.id);this.createDefaultSaveMode(this.departmentData.entityType);const t=m.getMemberRoles(s);const e=Object.keys(t);this.departmentData.heads=this.departmentData.heads.map((s=>{const i=e.find((e=>t[e]===s.role));return{...s,role:this.memberRoles[i]}}));this.departmentData.employees=this.departmentData.employees.map((t=>({...t,role:this.memberRoles.employee})))}this.departmentData.teamColor=this.isTeamEntity?(e=this.departmentData.teamColor)!=null?e:T.NodeColorsSettingsDict.blue:null},getAllSteps(t,e=null){const s=t===T.EntityTypes.team;return{entity:{id:R.entities,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_SELECT_ENTITY_TITLE"),hasBreadcrumbs:false,hasTreePreview:false,dataTestIdPart:"entities"},department:{id:R.department,breadcrumbsTitleDepartment:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_DEPARTMENT_BREADCRUMBS",breadcrumbsTitleTeam:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TEAM_TITLE_BREADCRUMBS",hasBreadcrumbs:true,hasTreePreview:true,isEditPermitted:s?this.permissionChecker.hasPermission(u.PermissionActions.teamEdit,e):this.permissionChecker.hasPermission(u.PermissionActions.departmentEdit,e),dataTestIdPart:"department"},employees:{id:R.employees,breadcrumbsTitleDepartment:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEES_BREADCRUMBS",breadcrumbsTitleTeam:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TEAM_EMPLOYEES_BREADCRUMBS",hasBreadcrumbs:true,hasTreePreview:true,isEditPermitted:s?this.permissionChecker.hasPermission(u.PermissionActions.teamAddMember,e):this.permissionChecker.hasPermission(u.PermissionActions.employeeAddToDepartment,e),dataTestIdPart:"employees"},bindChat:{id:R.bindChat,breadcrumbsTitleDepartment:this.permissionChecker.isCollabsAvailable?"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TITLE_BREADCRUMBS_W_COLLABS":"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TITLE_BREADCRUMBS",breadcrumbsTitleTeam:this.permissionChecker.isCollabsAvailable?"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_TITLE_BREADCRUMBS_W_COLLABS":"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TEAM_TITLE_BREADCRUMBS",hasBreadcrumbs:true,hasTreePreview:false,isEditPermitted:s?this.permissionChecker.hasPermission(u.PermissionActions.teamCommunicationEdit,e):this.permissionChecker.hasPermission(u.PermissionActions.departmentCommunicationEdit,e),dataTestIdPart:"bind-chat"},teamRights:{id:R.teamRights,breadcrumbsTitleTeam:"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TEAM_RIGHTS_BREADCRUMBS",hasBreadcrumbs:true,hasTreePreview:false,isEditPermitted:s?this.permissionChecker.hasPermission(u.PermissionActions.teamSettingsEdit,e):this.permissionChecker.hasPermission(u.PermissionActions.departmentEdit,e),dataTestIdPart:"team-rights"}}},createSteps(t="DEPARTMENT",e=null){const{entity:s,department:i,employees:n,bindChat:a,teamRights:r}=this.getAllSteps(t,e);const o=this.showEntitySelector?[s]:[];o.push(i,n,a);if(t===T.EntityTypes.team){o.push(r);o.forEach((t=>{Object.assign(t,{breadcrumbsTitle:t.breadcrumbsTitleTeam?this.loc(t.breadcrumbsTitleTeam):""})}))}else{o.forEach((t=>{Object.assign(t,{breadcrumbsTitle:t.breadcrumbsTitleDepartment?this.loc(t.breadcrumbsTitleDepartment):""})}))}if(this.isEditMode){o.forEach((t=>{Object.assign(t,{isPermitted:t.isEditPermitted,hasTreePreview:t.hasTreePreview&&t.isEditPermitted})}))}else{o.forEach((t=>{Object.assign(t,{isPermitted:true})}))}this.steps=o},getUsersPromise(t){const e=this.calculateEmployeeIds();const{headsIds:s,deputiesIds:i,employeesIds:n}=e;const a={[this.memberRoles.head]:s,[this.memberRoles.deputyHead]:i,[this.memberRoles.employee]:n};return this.getUserMemberPromise(t,a)},calculateEmployeeIds(){const{heads:t,employees:e=[]}=this.departmentData;return[...t,...e].reduce(((t,e)=>{const{headsIds:s,deputiesIds:i,employeesIds:n}=t;if(e.role===this.memberRoles.head){s.push(e.id)}else if(e.role===this.memberRoles.deputyHead){i.push(e.id)}else{n.push(e.id)}return t}),{headsIds:[],deputiesIds:[],employeesIds:[]})},getUserMemberPromise(t,e,s){var i;if(this.isEditMode){return W.saveUsers(t,e)}const n=Object.values(e).some((t=>t.length>0));if(!n){return Promise.resolve()}const a=(i=this.departmentData.parentId)!=null?i:null;if(this.saveMode===x.moveUsers){return W.moveUsers(t,e,a)}return W.saveUsers(t,e,a)},async create(){const{name:t,parentId:s,description:i,chats:n,channels:a,collabs:r,createDefaultChat:o,createDefaultChannel:d,createDefaultCollab:l,entityType:c,teamColor:_,settings:h}=this.departmentData;let p=0;let u="";this.waiting=true;try{const e=this.calculateEmployeeIds();const{headsIds:m,deputiesIds:E,employeesIds:C}=e;const R={[this.memberRoles.head]:m,[this.memberRoles.deputyHead]:E,[this.memberRoles.employee]:C};let A={};let S={};let y=false;let U=false;if(c===T.EntityTypes.team){A={[T.NodeSettingsTypes.businessProcAuthority]:{values:[...h[T.NodeSettingsTypes.businessProcAuthority]],replace:true}};({node:S,updatedDepartmentIds:y=false,userMovedToRootIds:U=false}=await W.createTeam(t,s,i,_.name,R,Number(o),n,Number(d),a,Number(l),r,A))}else if(c===T.EntityTypes.department){({node:S,updatedDepartmentIds:y=false,userMovedToRootIds:U=false}=await W.createDepartment(t,s,i,R,this.saveMode===x.moveUsers?1:0,Number(o),n,Number(d),a,Number(l),r,A))}p=S.id;u=S.accessCode;if(y){Z.refreshDepartments(y)}else if(U){Z.tryToAddCurrentDepartment(this.departmentData,p)}}catch(t){if(!m.reportedErrorTypes.has(t.code)){e.UI.Notification.Center.notify({content:t.message,autoHideDelay:4e3})}return}finally{this.waiting=false}Z.createDepartment({...this.departmentData,id:p,accessCode:u});this.$emit("modifyTree",{id:p,parentId:s,showConfetti:true});const{headsIds:C,deputiesIds:R,employeesIds:A}=this.calculateEmployeeIds();E.sendData({tool:"structure",category:"structure",event:"create_dept",c_element:this.source,p2:`headAmount_${C.length}`,p3:`secondHeadAmount_${R.length}`,p4:`employeeAmount_${A.length}`});this.close()},async save(){if(!this.isValidStep){this.shouldErrorHighlight=true;return}const{id:t,parentId:e,name:s,description:n,teamColor:a,settings:r,chats:o,createDefaultChat:d,channels:l,createDefaultChannel:c,collabs:_,createDefaultCollab:h}=this.departmentData;const m=this.departments.get(t);const E=(m==null?void 0:m.parentId)===e?null:e;this.waiting=true;const u=this.apiEntityChanged.has(T.WizardApiEntityChangedDict.employees)?this.getUsersPromise(t):Promise.resolve();const C=this.apiEntityChanged.has(T.WizardApiEntityChangedDict.department)?W.updateDepartment(t,E,s,n,a==null?void 0:a.name):Promise.resolve();const R=this.apiEntityChanged.has(T.WizardApiEntityChangedDict.settings)?W.updateSettings(t,{[T.NodeSettingsTypes.businessProcAuthority]:{values:[...r[T.NodeSettingsTypes.businessProcAuthority]],replace:true}},e):Promise.resolve();this.pickEditAnalytics(t,e);try{const[e]=await Promise.all([u,C,R]);if(this.apiEntityChanged.has(T.WizardApiEntityChangedDict.bindChats)){await W.saveChats(t,{chat:o.filter((t=>!this.initChats.some((e=>e.id===t)))),channel:l.filter((t=>!this.initChannels.some((e=>e.id===t)))),collab:_.filter((t=>!this.initCollabs.some((e=>Number(e.id)===t))))},{chat:Number(d),channel:Number(c),collab:Number(h)},{chat:this.initChats.filter((t=>!o.includes(t.id))).map((t=>t.id)),channel:this.initChannels.filter((t=>!l.includes(t.id))).map((t=>t.id)),collab:this.initCollabs.filter((t=>!_.includes(Number(t.id)))).map((t=>t.id))});this.departmentData.chatsDetailed=null;this.departmentData.channelsDetailed=null;if(this.isEditMode&&t&&i.DepartmentContentActions!=null&&i.DepartmentContentActions.updateChatsInChildrenNodes){i.DepartmentContentActions.updateChatsInChildrenNodes(this.nodeId)}}let s=[];if(this.removedUsers.length>0){var A;s=(A=e==null?void 0:e.userMovedToRootIds)!=null?A:[];if(s.length>0){Z.moveUsersToRootDepartment(this.removedUsers,s)}}const n=p.useChartStore();if(s.includes(this.userId)){n.changeCurrentDepartment(t,this.rootId)}else if(this.removedUsers.some((t=>t.id===this.userId))){n.changeCurrentDepartment(t)}else{Z.tryToAddCurrentDepartment(this.departmentData,t)}n.updateDepartment(this.departmentData)}catch(t){console.error(t);return}finally{this.waiting=false}this.$emit("modifyTree",{id:t,parentId:e});this.close()},handleSaveModeChanged(t){this.saveMode=t},createDefaultSaveMode(t="DEPARTMENT"){if(t===T.EntityTypes.team){this.saveMode=x.addUsers}else{this.saveMode=x.moveUsers}},pickEditAnalytics(t,e){const s=this.departments.get(t);switch(this.entity){case R.department:E.sendData({tool:"structure",category:"structure",event:"edit_dept_name",c_element:this.source,p1:(s==null?void 0:s.parentId)===e?"editHead_N":"editHeadDept_Y",p2:(s==null?void 0:s.name)===name?"editName_N":"editName_Y"});break;case R.employees:{const{headsIds:t,deputiesIds:e,employeesIds:s}=this.calculateEmployeeIds();E.sendData({tool:"structure",category:"structure",event:"edit_dept_employee",c_element:this.source,p2:`headAmount_${t.length}`,p3:`secondHeadAmount_${e.length}`,p4:`employeeAmount_${s.length}`});break}default:break}},pickStepsAnalytics(){let t=null;switch(this.currentStep.id){case R.department:t="create_dept_step1";break;case R.employees:t="create_dept_step2";break;case R.bindChat:t="create_dept_step3";break;case R.teamRights:t="create_dept_step4";break;default:break}if(t){E.sendData({tool:"structure",category:"structure",event:t,c_element:this.source})}}},template:`\n\t\t<div class="chart-wizard">\n\t\t\t<div class="chart-wizard__dialog" :class="{ '--first-step': isFirstStep }">\n\t\t\t\t<div v-if="currentStep.hasBreadcrumbs" class="chart-wizard__breadcrumbs-head">\n\t\t\t\t\t<div class="chart-wizard__head_close --breadcrumbs" @click="closeWithConfirm(true)"></div>\n\t\t\t\t\t<div class="chart-wizard__breadcrumbs-head_descr">\n\t\t\t\t\t\t{{ breadcrumbsTitle }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="chart-wizard__breadcrumbs-head_breadcrumbs">\n\t\t\t\t\t\t<span \n\t\t\t\t\t\t\tv-for="(step, index) in breadcrumbsSteps" \n\t\t\t\t\t\t\t:key="index"\n\t\t\t\t\t\t\tclass="chart-wizard__breadcrumbs-head_breadcrumbs-item"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<span v-if="index > 0" class="ui-icon-set --chevron-right"></span>\n\t\t\t\t\t\t\t<span class="chart-wizard__breadcrumbs-head_breadcrumbs-item-text"\n\t\t\t\t\t\t\t\t  :class="{ '--active': step.id === currentStep.id }"\n\t\t\t\t\t\t\t\t  :data-test-id="'hr-company-structure_chart-wizard__breadcrumbs_' + step.dataTestIdPart"\n\t\t\t\t\t\t\t\t  @click="moveToStep(step.id)"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{{ step.breadcrumbsTitle }}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div v-else class="chart-wizard__head">\n\t\t\t\t\t<div class="chart-wizard__head_close" @click="close(true)"></div>\n\t\t\t\t\t<p class="chart-wizard__head_title">{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_CREATE') }}</p>\n\t\t\t\t\t<p class="chart-wizard__head_descr" :class="{ '--first-step': isFirstStep }">\n\t\t\t\t\t\t{{ currentStep.title }}\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t\t<div class="chart-wizard__content" :style="{ display: !isEditMode && isFirstStep ? 'block' : 'flex' }">\n\t\t\t\t\t<KeepAlive>\n\t\t\t\t\t\t<component\n\t\t\t\t\t\t\t:is="componentInfo.name"\n\t\t\t\t\t\t\tv-bind="componentInfo.params"\n\t\t\t\t\t\t\tv-on="{\n\t\t\t\t\t\t\t\tapplyData: onApplyData,\n\t\t\t\t\t\t\t\tsaveModeChanged: componentInfo.name === 'Employees' ? handleSaveModeChanged : undefined\n\t\t\t\t\t\t\t}"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t</component>\n\t\t\t\t\t</KeepAlive>\n\t\t\t\t\t<div v-if="currentStep.hasTreePreview" class="chart-wizard__tree_container">\n\t\t\t\t\t\t<TreePreview\n\t\t\t\t\t\t\t:parentId="departmentData.parentId"\n\t\t\t\t\t\t\t:name="departmentData.name"\n\t\t\t\t\t\t\t:heads="departmentData.heads"\n\t\t\t\t\t\t\t:userCount="departmentData.userCount"\n\t\t\t\t\t\t\t:entityType="departmentData.entityType"\n\t\t\t\t\t\t\t:teamColor="departmentData.teamColor"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="chart-wizard__footer">\n\t\t\t\t\t<button\n\t\t\t\t\t\tv-if="stepIndex > 0"\n\t\t\t\t\t\tclass="ui-btn ui-btn-light chart-wizard__button --back"\n\t\t\t\t\t\t@click="move('back')"\n\t\t\t\t\t\tdata-test-id="hr-company-structure_chart-wizard__back-button"\n\t\t\t\t\t>\n\t\t\t\t\t\t<span class="chart-wizard__back-button-text">\n\t\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BACK_BTN') }}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button\n\t\t\t\t\t\tv-show="stepIndex < steps.length - 1"\n\t\t\t\t\t\tclass="ui-btn ui-btn-primary ui-btn-round chart-wizard__button --next"\n\t\t\t\t\t\t:class="{ \n\t\t\t\t\t\t\t'ui-btn-disabled': !isValidStep,\n\t\t\t\t\t\t\t'ui-btn-light-border': isEditMode,\n\t\t\t\t\t\t }"\n\t\t\t\t\t\t@click="move()"\n\t\t\t\t\t\tdata-test-id="hr-company-structure_chart-wizard__next-button"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_NEXT_BTN') }}\n\t\t\t\t\t</button>\n\t\t\t\t\t<button\n\t\t\t\t\t\tv-show="!isEditMode && stepIndex === steps.length - 1"\n\t\t\t\t\t\tclass="ui-btn ui-btn-primary ui-btn-round chart-wizard__button"\n\t\t\t\t\t\t:class="{ 'ui-btn-wait': waiting }"\n\t\t\t\t\t\t@click="create"\n\t\t\t\t\t\tdata-test-id="hr-company-structure_chart-wizard__create-button"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ createButtonText }}\n\t\t\t\t\t</button>\n\t\t\t\t\t<button\n\t\t\t\t\t\tv-show="isEditMode"\n\t\t\t\t\t\tclass="ui-btn ui-btn-primary ui-btn-round chart-wizard__button --save"\n\t\t\t\t\t\t:class="{ 'ui-btn-wait': waiting, 'ui-btn-disabled': !isValidStep, }"\n\t\t\t\t\t\t@click="save"\n\t\t\t\t\t\tdata-test-id="hr-company-structure_chart-wizard__save-button"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_SAVE_BTN') }}\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="chart-wizard__overlay"></div>\n\t\t</div>\n\t`};t.ChartWizard=k})(this.BX.Humanresources.CompanyStructure=this.BX.Humanresources.CompanyStructure||{},BX,BX.UI.Dialogs,BX.Humanresources.CompanyStructure,BX,BX.Cache,BX,BX.Vue3.Pinia,BX.UI.IconSet,BX.UI.IconSet,BX.Humanresources.CompanyStructure,BX,BX.UI.EntitySelector,BX.Humanresources.CompanyStructure,BX.Humanresources.CompanyStructure,BX.UI.Analytics,BX.Humanresources.CompanyStructure,BX.Humanresources.CompanyStructure);
//# sourceMappingURL=chart-wizard.bundle.map.js