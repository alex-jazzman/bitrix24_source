this.BX=this.BX||{};this.BX.Humanresources=this.BX.Humanresources||{};(function(t,e,s,n,i,o,r,a,l,d,c,u,h,E,p,_,m,T,R,C,v,A,b,S,M,N,U){"use strict";const P=Object.freeze({HR_DEPARTMENT_CONNECT:"hr-department-connect",HR_DEPARTMENT_DISCONNECT:"hr-department-disconnect",HR_DEPARTMENT_ADAPT_SIBLINGS:"hr-department-adapt-siblings",HR_DEPARTMENT_ADAPT_CONNECTOR_HEIGHT:"hr-department-adapt-connector-height",HR_DEPARTMENT_FOCUS:"hr-department-focus",HR_DEPARTMENT_CONTROL:"hr-department-control",HR_DEPARTMENT_MENU_CLOSE:"hr-department-menu-close",HR_ORG_CHART_CLOSE_BY_ESC:"SidePanel.Slider:onCloseByEsc",HR_ORG_CHART_CLOSE:"SidePanel.Slider:onClose",HR_FIRST_POPUP_SHOW:"HR.company-structure:first-popup-showed",HR_DRAG_ENTITY:"hr-drag-entity",HR_DROP_ENTITY:"hr-drop-entity",HR_ORG_CHART_TRANSFORM_CANVAS:"hr-org-chart-transform-canvas",HR_DEPARTMENT_SLIDER_ON_MESSAGE:"SidePanel.Slider:onMessage",HR_ORG_CHART_LOCATE_TO_DEPARTMENT:"hr-org-chart-locate-to-department",HR_ENTITY_TOGGLE_ELEMENTS:"hr-entity-toggle-elements",HR_ENTITY_SHOW_WIZARD:"hr-entity-show-wizard",HR_ENTITY_REMOVE:"hr-entity-remove",HR_PUBLIC_FOCUS_NODE:"HumanResources.CompanyStructure:focusNode",INTRANET_USER_MINIPROFILE_CLOSE:"Intranet.User.MiniProfile:close",HR_USER_DRAG_START:"HumanResources.User:dragStart",HR_USER_DRAG_MOVE:"HumanResources.User:dragMove",HR_USER_DRAG_DROP:"HumanResources.User:drop",HR_USER_DRAG_END:"HumanResources.User:dragEnd",HR_USER_DRAG_ENTER_NODE:"HumanResources.User:dragEnterNode",HR_USER_DRAG_LEAVE_NODE:"HumanResources.User:dragLeaveNode"});const y=364;const D=Object.freeze({addDepartment:"add-department",addEmployee:"add-employee"});const g={name:"AddButton",components:{RouteActionMenu:h.RouteActionMenu},emits:["addDepartment"],data(){return{actionMenu:{visible:false}}},computed:{MenuOption(){return D}},mounted(){const t=M.PermissionChecker.getInstance();if(!t){return}this.dropdownItems=[{id:D.addDepartment,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_ADD_BUTTON_MENU_ADD_DEPARTMENT_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_ADD_BUTTON_MENU_ADD_DEPARTMENT_DESCR"),bIcon:{name:S.Main.CUBE_PLUS,size:20,color:b.getColorCode("paletteBlue50")},permission:{action:M.PermissionActions.departmentCreate}},{id:D.addEmployee,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_ADD_BUTTON_MENU_ADD_EMPLOYEE_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_ADD_BUTTON_MENU_ADD_EMPLOYEE_DESCR"),bIcon:{name:S.CRM.PERSON_PLUS_2,size:20,color:b.getColorCode("paletteBlue50")},permission:{action:M.PermissionActions.employeeAddToDepartment}}];this.dropdownItems=this.dropdownItems.filter((e=>{if(!e.permission){return false}return t.hasPermissionOfAction(e.permission.action)}))},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},addDepartment(){this.$emit("addDepartment")},actionMenuItemClickHandler(t){if(t===D.addDepartment){this.$emit("addDepartment")}}},template:`\n\t\t<div\n\t\t\tclass="ui-btn ui-btn-success ui-btn-round ui-btn-sm humanresources-title-panel__add-button"\n\t\t\tdata-test-id="hr-org-chart_title-panel__add-button"\n\t\t\t@click="addDepartment"\n\t\t>\n\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_ADD_BUTTON') }}\n\t\t</div>\n\t`};const f=t=>{const e=new Map;t.forEach((t=>{var s,n,i;const{id:o,parentId:r,colorName:a,entityType:l}=t;const d=(s=e.get(o))!=null?s:{};const c=b.getNodeColorSettings(a,l);e.set(o,{...d,...t,teamColor:c});if(r===0){return}const u=(n=e.get(r))!=null?n:{};const h=(i=u.children)!=null?i:[];e.set(r,{...u,children:[...h,o]})}));return e};const I={removeDepartment:t=>u.getData("humanresources.api.Structure.Node.delete",{nodeId:t}),getDepartmentsData:()=>u.getData("humanresources.api.Structure.get",{},{tool:"structure",category:"structure",event:"open_structure"}),getCurrentDepartments:()=>u.getData("humanresources.api.Structure.Node.current"),getDictionary:()=>u.getData("humanresources.api.Structure.dictionary"),getUserId:()=>u.getData("humanresources.api.User.getCurrentId"),firstTimeOpened:()=>u.postData("humanresources.api.User.firstTimeOpen"),updateDepartment:(t,e)=>u.postData("humanresources.api.Structure.Node.update",{nodeId:t,parentId:e,name:null}),changeOrder:(t,e,s)=>u.postData("humanresources.api.Structure.Node.changeOrder",{nodeId:t,direction:e,count:s}),createTreeDataStore:f};const O={applyData:(t,e,s,n,i)=>{const o=R.useChartStore();o.$patch({departments:t,currentDepartments:e,userId:s,searchedUserId:s,structureMap:n,multipleUsers:i})},focusDepartment:t=>{const e=R.useChartStore();e.focusedNode=t},searchUserInDepartment:t=>{const e=R.useChartStore();e.searchedUserId=t},moveSubordinatesToParent:t=>{const e=R.useChartStore();const{departments:s,currentDepartments:n,structureMap:i}=e;const o=s.get(t);const{parentId:r,entityType:a,children:l=[],userCount:d,heads:c,employees:h=[]}=o;const E=s.get(r);l.forEach((t=>{const e=s.get(t);const n=i.get(t);n.parentId=r;e.parentId=r}));if(d>0&&a===b.EntityTypes.department){var p,_;const t=new Set([...E.heads,...(p=E.employees)!=null?p:[]].map((t=>t.id)));const e=[...c,...h];const s=e.filter((e=>!t.has(e.id)));for(const t of s){t.role=u.memberRoles.employee}E.userCount+=s.length;E.employees=[...(_=E.employees)!=null?_:[],...s]}E.children=[...E.children,...l];if(n.includes(t)&&a===b.EntityTypes.department){e.changeCurrentDepartment(t,r)}},markDepartmentAsRemoved:t=>{const{departments:e}=R.useChartStore();const s=e.get(t);const{parentId:n}=s;const i=e.get(n);i.children=i.children.filter((e=>e!==t));delete s.parentId;e.set(t,{...s,prevParentId:n})},removeDepartment:t=>{const{departments:e,structureMap:s}=R.useChartStore();e.delete(t);s.delete(t)},inviteUser:t=>{const{nodeId:e,...s}=t;const{departments:n}=R.useChartStore();const i=n.get(e);if(i.employees){n.set(e,{...i,employees:[...i.employees,{...s}],userCount:i.userCount+1})}},orderDepartments:async(t,e,s,n)=>{const{departments:i}=R.useChartStore();const o=i.get(t);const{parentId:r}=o;const a=i.get(r);const{children:l}=a;const d=l.indexOf(e);const c=l.filter((e=>e!==t));c.splice(d,0,t);i.set(r,{...a,children:c});try{await I.changeOrder(t,s,n);return true}catch{i.set(r,{...a,children:l});return false}},clearNodesChatLists:t=>{const{departments:e}=R.useChartStore();t.forEach((t=>{const s=e.get(t);e.set(t,{...s,chats:null,channels:null})}))}};const H={name:"search-bar",components:{BIcon:T.BIcon},directives:{focus:{mounted(t){t.focus()}}},emits:["locate"],data(){return{canEditPermissions:false,showSearchBar:false}},computed:{set(){return T.Set},...d.mapState(R.useChartStore,["departments"])},watch:{departments:{handler(){this.searchDialog.destroy()},deep:true}},created(){this.searchDialog=this.getSearchDialog()},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},showSearchbar(){if(this.showSearchBar){this.showSearchBar=false;return}v.sendData({tool:"structure",category:"structure",event:"search"});this.showSearchBar=true},hideSearchbar(){this.showSearchBar=false},getSearchDialog(){const t=new o.Dialog({width:425,height:320,multiple:false,entities:[{id:"user",searchFields:[{name:"supertitle",type:"string",system:true,searchable:true},{name:"position",type:"string"}],options:{intranetUsersOnly:true,emailUsers:false,inviteEmployeeLink:false}},{id:"structure-node",options:{selectMode:"departmentsOnly",useMultipleTabs:true,restricted:"view",flatMode:true,includedNodeEntityTypes:["department","team"]}}],recentTabOptions:{id:"recents",visible:true},dropdownMode:true,enableSearch:false,hideOnDeselect:false,context:"HR_STRUCTURE",events:{"Item:onSelect":e=>{const s=e.getData().item;if(s.entityType==="employee"){this.$emit("locate",s.customData.get("nodeId"));O.searchUserInDepartment(s.id);t.recentItemsToSave.push(s);t.saveRecentItems();return}t.recentItemsToSave.push(s);t.saveRecentItems();this.$emit("locate",s.id)},onLoad:t=>{var e;(e=t.target.items.get("user"))==null?void 0:e.forEach((t=>{if(!t.getSubtitle()){t.setSubtitle(t.customData.get("position"))}}))},"SearchTab:onLoad":t=>{var e;(e=t.target.items.get("user"))==null?void 0:e.forEach((t=>{if(!t.getSubtitle()){t.setSubtitle(t.customData.get("position"))}}))},onDestroy:()=>{this.searchDialog=this.getSearchDialog()}}});const e=t.getContainer();U.Dom.attr(e,"data-test-id","hr-org-chart_title-panel__search-dialog-container");return t},onEnter(){if(this.$refs.searchName){this.searchDialog.setTargetNode(this.$refs.searchName);if(!this.searchDialog.isOpen()){this.searchDialog.show()}U.Event.bind(window,"mousedown",this.handleClickOutside)}},handleClickOutside(t){if(this.$refs.searchName&&!this.$refs.searchName.parentElement.contains(t.target)&&!this.searchDialog.isOpen()){this.clearSearch();this.hideSearchbar();U.Event.unbind(window,"mousedown",this.handleClickOutside)}},search(t){if(!this.searchDialog.isOpen()){this.searchDialog.show()}this.searchDialog.search(t)},clearSearch(){this.searchDialog.getSearchTab().clearResults();this.searchDialog.selectTab("recents");if(this.$refs.searchName){this.$refs.searchName.value="";this.$refs.searchName.focus()}}},template:`\n\t\t<div\n\t\t    class="humanresources-title-panel-search-bar-container"\n\t\t    :class="{'--opened': showSearchBar}"\n\t\t>\n\t\t  <div\n\t\t      class="humanresources-title-panel-search-bar-block__search"\n\t\t      @click="showSearchbar"\n\t\t\t\tdata-test-id="hr-org-chart_title-panel__search-bar-button"\n\t\t  >\n\t\t    <BIcon :name="set.SEARCH_2" :size="24" class="hr-title-search-icon"></BIcon>\n\t\t  </div>\n\t\t  <transition name="humanresources-title-panel-search-bar-fade" mode="in-out" @after-enter="onEnter">\n\t\t    <div v-if="showSearchBar"\n\t\t         class="humanresources-title-panel-search-bar-block__search-bar"\n\t\t    >\n\t\t      <input\n\t\t          ref="searchName"\n\t\t          key="searchInput"\n\t\t          type="text"\n\t\t          :placeholder="loc('HUMANRESOURCES_SEARCH_PLACEHOLDER_MSGVER_1')"\n\t\t          v-focus\n\t\t          class="humanresources-title-panel-search-bar-block__search-input"\n\t\t          @click="onEnter"\n\t\t          @input="search($event.target.value)"\n\t\t\t\t\tdata-test-id="hr-org-chart_title-panel__search-bar-input"\n\t\t      >\n\t\t      <div\n\t\t          key="searchReset"\n\t\t          @click="clearSearch"\n\t\t          class="humanresources-title-panel-search-bar-block__search-reset"\n\t\t      >\n\t\t        <div class="humanresources-title-panel-search-bar-block__search-cursor"></div>\n\t\t        <BIcon\n\t\t            :name="set.CROSS_CIRCLE_50"\n\t\t            :size="24"\n\t\t            color="#2FC6F6"\n\t\t        ></BIcon>\n\t\t      </div>\n\t\t    </div>\n\t\t  </transition>\n\t\t</div>\n\t`};const L=Object.freeze({accessRights:"access-rights",teamAccessRights:"team-access-rights"});const B={name:"BurgerMenuButton",components:{RouteActionMenu:h.RouteActionMenu},data(){return{actionMenu:{visible:false}}},mounted(){const t=M.PermissionChecker.getInstance();const e=t.hasPermissionOfAction(M.PermissionActions.accessEdit)?L.accessRights:L.teamAccessRights;this.dropdownItems=[{id:e,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIG_PERMISSION"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIG_PERMISSION_DESCR_MSGVER_2"),bIcon:{name:S.Main.PERSONS_2,size:20,color:b.getColorCode("paletteBlue50")},dataTestId:"hr-org-chart_title-panel__access-rights-button",permission:t.hasPermissionOfAction(M.PermissionActions.accessEdit)||t.hasPermissionOfAction(M.PermissionActions.teamAccessEdit)}]},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},actionMenuItemClickHandler(t){v.sendData({tool:"structure",category:"roles",event:"open_roles"});if(t===L.accessRights){BX.SidePanel.Instance.open("/hr/config/permission/",{usePadding:true})}if(t===L.teamAccessRights){BX.SidePanel.Instance.open("/hr/config/permission/?category=TEAM",{usePadding:true})}}},template:`\n\t\t<span\n\t\t\tref="burgerMenuButton"\n\t\t\t@click="actionMenu.visible = true"\n\t\t\tclass="humanresources-title-panel__burger-menu-button"\n\t\t\tdata-test-id="hr-org-chart_title-panel__burger-menu-button"\n\t\t>\n\t\t\t<svg\n\t\t\t\tviewBox="0 0 24 24"\n\t\t\t\tfill="none"\n\t\t\t\tclass="humanresources-title-panel__icon"\n\t\t\t\t:class="{'--selected': actionMenu.visible }"\n\t\t\t\t>\n\t\t\t\t\t<path fill-rule="evenodd" clip-rule="evenodd" d="M18.7067 15.5577C18.8172 15.5577 18.9067 15.6473 18.9067 15.7577L18.9067 17.2424C18.9067 17.3528 18.8172 17.4424 18.7067 17.4424H5.29375C5.1833 17.4424 5.09375 17.3528 5.09375 17.2424L5.09379 15.7577C5.09379 15.6473 5.18333 15.5577 5.29379 15.5577H18.7067ZM18.7067 11.5577C18.8172 11.5577 18.9067 11.6473 18.9067 11.7577L18.9067 13.2424C18.9067 13.3528 18.8172 13.4424 18.7067 13.4424H5.29375C5.1833 13.4424 5.09375 13.3528 5.09375 13.2424L5.09379 11.7577C5.09379 11.6473 5.18333 11.5577 5.29379 11.5577H18.7067ZM18.7067 7.55774C18.8172 7.55774 18.9067 7.64729 18.9067 7.75774L18.9067 9.24238C18.9067 9.35284 18.8172 9.44238 18.7067 9.44238H5.29375C5.1833 9.44238 5.09375 9.35283 5.09375 9.24237L5.09379 7.75773C5.09379 7.64728 5.18333 7.55774 5.29379 7.55774H18.7067Z" fill="#959ca4"/>\n\t\t\t</svg>\n\t\t </span>\n\t\t<RouteActionMenu\n\t\t\tv-if="actionMenu.visible"\n\t\t\tid="title-panel-burger-menu"\n\t\t\t:items="dropdownItems.filter(item => item.permission)"\n\t\t\t:bindElement="this.$refs.burgerMenuButton"\n\t\t\t@action="actionMenuItemClickHandler($event)"\n\t\t\t@close="this.actionMenu.visible = false"\n\t\t\tcontainerDataTestId="hr-org-chart_title-panel__burger-menu-container"\n\t\t/>\n\t`};const F={components:{AddButton:g,BurgerMenuButton:B,SearchBar:H,BIcon:T.BIcon,Set:T.Set,ResponsiveHint:h.ResponsiveHint},data(){return{canEditPermissions:false,canAddNode:false,toolbarStarActive:false,isHovered:false,hintKey:0}},created(){this.toolbarStarElement=document.getElementById("uiToolbarStar")},mounted(){try{const t=M.PermissionChecker.getInstance();this.canEditPermissions=t&&(t.hasPermissionOfAction(M.PermissionActions.accessEdit)||t.hasPermissionOfAction(M.PermissionActions.teamAccessEdit));this.canAddNode=t&&(t.hasPermissionOfAction(M.PermissionActions.departmentCreate)||t.hasPermissionOfAction(M.PermissionActions.teamCreate))}catch(t){console.error("Failed to fetch data:",t)}const t=new MutationObserver((()=>{const t=U.Dom.hasClass(this.toolbarStarElement,"ui-toolbar-star-active");if(this.toolbarStarActive!==t){this.toolbarStarActive=t;this.hintKey++}}));t.observe(this.toolbarStarElement,{attributes:true,attributeFilter:["class"]});this.toolbarStarActive=U.Dom.hasClass(this.toolbarStarElement,"ui-toolbar-star-active")},name:"title-panel",emits:["showWizard"],computed:{set(){return T.Set},toolbarStarIcon(){if(this.isAirTemplate){return this.set.FAVORITE_0}if(this.isHovered||this.toolbarStarActive){return this.set.FAVORITE_1}return this.set.FAVORITE_0},isAirTemplate(){return BX.Reflection.getClass("top.BX.Intranet.Bitrix24.Template")!==null},toolbarClassIcon(){if(!this.isAirTemplate){return"humanresources-title-panel__star"}return this.toolbarStarActive?"humanresources-title-panel__unpin":"humanresources-title-panel__pin"},starHintText(){return this.toolbarStarActive?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_LEFT_MENU_UN_SAVE_HINT"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_LEFT_MENU_SAVE_HINT")}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},addDepartment(){this.$emit("showWizard",{source:u.AnalyticsSourceType.HEADER})},onLocate(t){N.EventEmitter.emit(i.events.HR_ORG_CHART_LOCATE_TO_DEPARTMENT,{nodeId:t})},triggerFavoriteStar(){this.toolbarStarElement.click();a.UI.Notification.Center.notify({content:this.toolbarStarActive?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_LEFT_MENU_UN_SAVED"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_LEFT_MENU_SAVED"),autoHideDelay:2e3})}},template:`\n\t\t<div class="humanresources-title-panel">\n\t\t\t<p class="humanresources-title-panel__title">\n\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_TITLE') }}\n\t\t\t</p>\n\t\t\t<ResponsiveHint v-if="!isAirTemplate" :content="starHintText" :key="'hint-air-' + hintKey">\n\t\t\t\t<BIcon\n\t\t\t\t\t:name="toolbarStarIcon"\n\t\t\t\t\t:size="24"\n\t\t\t\t\tcolor="rgba(149, 156, 164, 1)"\n\t\t\t\t\t:class="toolbarClassIcon"\n\t\t\t\t\t@mouseover="isHovered = true"\n\t\t\t\t\t@mouseleave="isHovered = false" \n\t\t\t\t\t@click="triggerFavoriteStar"\n\t\t\t\t></BIcon>\n\t\t\t</ResponsiveHint>\n\t\t\t<ResponsiveHint v-else :content="starHintText" :key="'hint-other-' + hintKey">\n\t\t\t\t<div \n\t\t\t\t\t:class="['ui-icon-set', '--size-sm', toolbarClassIcon]" \n\t\t\t\t\t@click="triggerFavoriteStar"\n\t\t\t\t></div>\n\t\t\t</ResponsiveHint>\n\t\t\t<AddButton\n\t\t\t\tv-if="canAddNode"\n\t\t\t\t@addDepartment="addDepartment"\n\t\t\t/>\n\t\t\t<div class="humanresources-title-panel__icon-buttons">\n\t\t\t\t<BurgerMenuButton v-if="canEditPermissions"/>\n\t\t\t\t<SearchBar @locate="onLocate"/>\n\t\t\t</div>\n\t\t</div>\n\t`};const w={getPagedEmployees:(t,e,s)=>u.getData("humanresources.api.Structure.Node.Member.Employee.list",{nodeId:t,page:e,countPerPage:s}),removeUserFromDepartment:(t,e)=>u.postData("humanresources.api.Structure.Node.Member.deleteUser",{nodeId:t,userId:e}),moveUserToDepartment:(t,e,s,n)=>u.postData("humanresources.api.Structure.Node.Member.moveUser",{nodeId:t,userId:e,targetNodeId:s,roleXmlId:n}),isUserInMultipleDepartments:t=>u.getData("humanresources.api.User.isUserInMultipleDepartments",{userId:t}),getUserInfo:(t,e)=>u.getData("humanresources.api.User.getInfoByUserMember",{nodeId:t,userId:e}),fireUser:t=>u.postData("intranet.user.fire",{userId:t}),findMemberByQuery:(t,e)=>u.getData("humanresources.api.Structure.Node.Member.find",{nodeId:t,query:e}),getChatsAndChannels:t=>u.getData("humanresources.api.Structure.Node.Member.Chat.getList",{nodeId:t}),saveChats:(t,e,s,n=0)=>u.postData("humanresources.api.Structure.Node.Member.Chat.saveChatList",{nodeId:t,ids:e,removeIds:s,withChildren:n}),saveChannel:(t,e,s,n=0)=>u.postData("humanresources.api.Structure.Node.Member.Chat.saveChannelList",{nodeId:t,ids:e,removeIds:s,withChildren:n}),saveCollab:(t,e,s,n=0)=>u.postData("humanresources.api.Structure.Node.Member.Chat.saveCollabList",{nodeId:t,ids:e,removeIds:s,withChildren:n})};const x=Object.freeze({FocusNodeId:"focusNodeId"});var Y=babelHelpers.classPrivateFieldLooseKey("getParamsFromUrl");var V=babelHelpers.classPrivateFieldLooseKey("castAndValidate");class k{static getParams(){const t=babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]();return{focusNodeId:babelHelpers.classPrivateFieldLooseBase(this,V)[V](x.FocusNodeId,t.get(x.FocusNodeId))}}}function $(){const t=new Map;const e=new URLSearchParams(document.location.search);Object.values(x).forEach((s=>{const n=e.get(s);if(!n){return}t.set(s,n)}));return t}function z(t,e){if(U.Type.isUndefined(e)){return null}let s=e;if(t===x.FocusNodeId){s=Number(e);if(!U.Type.isInteger(s)){return null}}return s}Object.defineProperty(k,V,{value:z});Object.defineProperty(k,Y,{value:$});const G={name:"headList",components:{UserListActionMenu:h.UserListActionMenu,BIcon:T.BIcon},directives:{hint:h.Hint},props:{entityId:{type:Number,required:false,default:0},items:{type:Array,required:false,default:()=>[]},title:{type:String,required:false,default:""},collapsed:{type:Boolean,required:false,default:false},type:{type:String,required:false,default:"head"},isTeamEntity:{type:Boolean,required:false,default:false}},data(){return{isCollapsed:false,isUpdating:true,headsVisible:false}},computed:{defaultAvatar(){return"/bitrix/js/humanresources/company-structure/org-chart/src/images/default-user.svg"},dropdownItems(){return this.items.map((t=>{const e=this.getPositionText(t);return{...t,workPosition:e}}))},titleBar(){return this.type===this.userTypes.deputy?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_DEPUTY_TITLE"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_HEAD_TITLE")},subordinatesCount(){return this.getSubtreeUserCount(this.entityId)},MainIcons:()=>T.Main,...d.mapState(R.useChartStore,["departments","multipleUsers"])},created(){this.userTypes={head:"head",deputy:"deputy"}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},handleUserClick(t){BX.SidePanel.Instance.open(t,{cacheable:false})},closeHeadList(){if(this.headsVisible){this.headsVisible=false;N.EventEmitter.unsubscribe(P.HR_DEPARTMENT_MENU_CLOSE,this.closeHeadList);N.EventEmitter.unsubscribe(P.HR_DRAG_ENTITY,this.closeHeadList)}},openHeadList(){if(!this.headsVisible){this.headsVisible=true;N.EventEmitter.subscribe(P.HR_DEPARTMENT_MENU_CLOSE,this.closeHeadList);N.EventEmitter.subscribe(P.HR_DRAG_ENTITY,this.closeHeadList)}},getPositionText(t){return t.workPosition||this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_HEAD_POSITION")},getSubtreeUserCount(t){if(!t){return 0}let e=0;const s=new Set;const n=new Set;const i=[t];while(i.length>0){var o;const r=i.pop();if(s.has(r)){continue}s.add(r);const a=this.departments.get(r);if(!a){continue}if(a.entityType===b.EntityTypes.team){continue}let l=Number(a.userCount)||0;if(r===t){const t=this.items.length;l=Math.max(0,l-t)}if(l>0){e+=l;n.add(String(r))}if(((o=a.children)==null?void 0:o.length)>0){for(const t of a.children){if(!s.has(t)){i.push(t)}}}}let r=0;if(this.multipleUsers&&n.size>0){const t=new Set(this.items.map((t=>String(t.id))));for(const[e,s]of Object.entries(this.multipleUsers)){if(!U.Type.isArray(s)||s.length===0){continue}let i=0;for(const t of s){if(n.has(String(t))){i++}}if(i>1){let s=i-1;if(t.has(String(e))){s=Math.max(0,s-1)}r+=s}}}return Math.max(0,e-r)},getEmployeesCountIconColor(){return b.getColorCode("paletteGray70")},getEmployeesCountIconText(){return this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_ALL_EMPLOYEES_COUNT_HINT_TEXT")}},template:`\n\t\t<div v-if="items.length">\n\t\t\t<p v-if="title" class="humanresources-tree__node_employees-title">\n\t\t\t\t{{ title }}\n\t\t\t</p>\n\t\t\t<div\n\t\t\t\tclass="humanresources-tree__node_head"\n\t\t\t\t:class="{ '--collapsed': collapsed }"\n\t\t\t\tv-for="(item, index) in items.slice(0, 2)"\n\t\t\t>\n\t\t\t\t<img\n\t\t\t\t\t:src="item.avatar ? encodeURI(item.avatar) : defaultAvatar"\n\t\t\t\t\tclass="humanresources-tree__node_avatar --head"\n\t\t\t\t\t:class="{ '--collapsed': collapsed }"\n\t\t\t\t\t@click.stop="handleUserClick(item.url)"\n\t\t\t\t/>\n\t\t\t\t<div class="humanresources-tree__node_head-text">\n\t\t\t\t\t<div class="humanresources-tree__node_head-name-container">\n\t\t\t\t\t<span\n\t\t\t\t\t\t:bx-tooltip-user-id="item.id"\n\t\t\t\t\t\tbx-tooltip-context="b24"\n\t\t\t\t\t\tclass="humanresources-tree__node_head-name"\n\t\t\t\t\t\t@click.stop="handleUserClick(item.url)"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ item.name }}\n\t\t\t\t\t</span>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tv-if="index === 0 && type === userTypes.head && !isTeamEntity"\n\t\t\t\t\t\t\tv-hint="getEmployeesCountIconText()"\n\t\t\t\t\t\t\tclass="humanresources-tree__node_head-subordinates"\n\t\t\t\t\t\t\t:class="{ '--active': headsVisible }"\n\t\t\t\t\t\t\t:data-test-id="'hr-company-structure_org-chart-tree__node-subordinates'"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<BIcon\n\t\t\t\t\t\t\t\t:name="MainIcons.PERSONS_2"\n\t\t\t\t\t\t\t\t:size="14"\n\t\t\t\t\t\t\t\tclass="hr-company-structure_org-chart-tree__node-subordinates-icon"\n\t\t\t\t\t\t\t\t:color="getEmployeesCountIconColor()"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<span class="hr-company-structure_org-chart-tree__node-subordinates-text">{{ String(subordinatesCount) }}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<span v-if="!collapsed" class="humanresources-tree__node_head-position">\n\t\t\t\t\t\t{{ getPositionText(item) }}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<span\n\t\t\t\t\tv-if="index === 1 && items.length > 2"\n\t\t\t\t\tclass="humanresources-tree__node_head-rest"\n\t\t\t\t\t:class="{ '--active': headsVisible }"\n\t\t\t\t\t:data-test-id="'hr-company-structure_org-chart-tree__node-' + type + '-rest'"\n\t\t\t\t\tref="showMoreHeadList"\n\t\t\t\t\t@click.stop="openHeadList"\n\t\t\t\t>\n\t\t\t\t\t{{ '+' + String(items.length - 2) }}\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t</div>\n\t\t<UserListActionMenu\n\t\t\tv-if="headsVisible"\n\t\t\t:id="type === userTypes.head ? 'head-list-popup-head' : 'head-list-popup-deputy'"\n\t\t\t:items="dropdownItems"\n\t\t\t:width="228"\n\t\t\t:bindElement="$refs.showMoreHeadList[0]"\n\t\t\t@close="closeHeadList"\n\t\t\t:titleBar="titleBar"\n\t\t/>\n\t`};class j{constructor(t){this.permissionChecker=M.PermissionChecker.getInstance();this.entityId=t}getItems(){throw new Error("Must override this function")}getFilteredItems(){if(!this.permissionChecker){return[]}const t=this.getItems();return t.filter((t=>{if(U.Type.isFunction(t.hasPermission)){return t.hasPermission(this.permissionChecker,this.entityId)}return false}))}onActionMenuItemClick(t){const e=this.items.find((e=>e.id===t));e==null?void 0:e.invoke({entityId:this.entityId,analyticSource:this.analyticSource,entityType:this.entityType})}}class W{constructor({id:t,title:e,description:s,bIcon:n,permissionAction:i,dataTestId:o}){this.id=t;this.title=e;this.description=s;this.bIcon=n;this.permissionAction=i;this.dataTestId=o}invoke(t){throw new Error("Must override this function")}hasPermission(t,e){return t.hasPermission(this.permissionAction,e)}}const X=Object.freeze({editDepartment:"editDepartment",addDepartment:"addDepartment",addEmployee:"addEmployee",editEmployee:"editEmployee",removeDepartment:"removeDepartment",moveEmployee:"moveEmployee",userInvite:"userInvite",teamRights:"teamRights",moveUserToAnotherDepartment:"moveUserToAnotherDepartment",removeUserFromDepartment:"removeUserFromDepartment",fireUserFromCompany:"fireUserFromCompany",openChat:"openChat",unbindChat:"unbindChat"});class K extends W{constructor(t){let e="";let s="";const n=M.PermissionChecker.getInstance();if(n.isTeamsAvailable){e=t===b.EntityTypes.team?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_TEAM_TITLE"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_DEPARTMENT_TITLE_MSGVER_1");s=t===b.EntityTypes.team?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_TEAM_SUBTITLE"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_DEPARTMENT_SUBTITLE_MSGVER_1")}else{e=U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_DEPARTMENT_TITLE_NO_TEAM");s=U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_DEPARTMENT_SUBTITLE_NO_TEAM")}super({id:X.addDepartment,title:e,description:s,bIcon:{name:S.Main.CUBE_PLUS,size:20,color:b.getColorCode("paletteBlue50")},permissionAction:null,dataTestId:"hr-company-structure_menu__add-department-item"});this.entityType=t;this.permissionChecker=n;this.entityType=t}invoke({entityId:t,analyticSource:e,entityType:s}){if(s===b.EntityTypes.team){if(!this.permissionChecker.isTeamsAvailable){a.UI.Notification.Center.notify({content:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_TEAMS_DISABLED_ERROR_MSGVER_1"),autoHideDelay:2e3});return}N.EventEmitter.emit(P.HR_ENTITY_SHOW_WIZARD,{nodeId:t,isEditMode:false,showEntitySelector:false,source:e,entityType:s})}else{N.EventEmitter.emit(P.HR_ENTITY_SHOW_WIZARD,{nodeId:t,isEditMode:false,showEntitySelector:true,source:e,entityType:s})}}hasPermission(t,e){if(this.entityType===b.EntityTypes.team){return t.hasPermission(M.PermissionActions.teamCreate,e)}return t.hasPermission(M.PermissionActions.departmentCreate,e)||t.hasPermission(M.PermissionActions.teamCreate,e)}}class Z extends W{constructor(t){const e=t===b.EntityTypes.team?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_TEAM_TITLE"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_DEPARTMENT_TITLE");const s=t===b.EntityTypes.team?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_TEAM_SUBTITLE_MSGVER_1"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_DEPARTMENT_SUBTITLE_MSGVER_1");super({id:X.editDepartment,title:e,description:s,bIcon:{name:S.Main.EDIT_PENCIL,size:20,color:b.getColorCode("paletteBlue50")},permissionAction:null,dataTestId:"hr-company-structure_menu__edit-department-item"});this.entityType=t}invoke({entityId:t,analyticSource:e,refToFocus:s="title"}){N.EventEmitter.emit(P.HR_ENTITY_SHOW_WIZARD,{nodeId:t,isEditMode:true,showEntitySelector:false,type:"department",entityType:this.entityType,source:e,refToFocus:s})}hasPermission(t,e){if(this.entityType===b.EntityTypes.team){return t.hasPermission(M.PermissionActions.teamEdit,e)||t.hasPermission(M.PermissionActions.teamAddMember,e)||t.hasPermission(M.PermissionActions.teamChatEdit,e)||t.hasPermission(M.PermissionActions.teamChannelEdit,e)||t.hasPermission(M.PermissionActions.teamCollabEdit,e)||t.hasPermission(M.PermissionActions.teamSettingsEdit,e)}return t.hasPermission(M.PermissionActions.departmentEdit,e)||t.hasPermission(M.PermissionActions.employeeAddToDepartment,e)||t.hasPermission(M.PermissionActions.departmentChatEdit,e)||t.hasPermission(M.PermissionActions.departmentChannelEdit,e)||t.hasPermission(M.PermissionActions.departmentCollabEdit,e)}}class q extends W{constructor(t){const e=t===b.EntityTypes.team?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_REMOVE_TEAM_TITLE"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_REMOVE_DEPARTMENT_TITLE");const s=t===b.EntityTypes.team?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_REMOVE_TEAM_SUBTITLE"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_REMOVE_DEPARTMENT_SUBTITLE");const n=t===b.EntityTypes.team?M.PermissionActions.teamDelete:M.PermissionActions.departmentDelete;super({id:X.removeDepartment,title:e,description:s,bIcon:{name:S.Main.TRASH_BIN,size:20,color:b.getColorCode("paletteRed40")},permissionAction:n,dataTestId:"hr-company-structure_menu__remove-department-item"})}invoke({entityId:t,entityType:e}){N.EventEmitter.emit(P.HR_ENTITY_REMOVE,{nodeId:t,entityType:e})}}class Q extends W{constructor(t,e){const s=t===b.EntityTypes.team?M.PermissionActions.teamAddMember:M.PermissionActions.employeeAddToDepartment;super({id:X.addEmployee,bIcon:{name:S.CRM.PERSON_PLUS_2,size:20,color:b.getColorCode("paletteBlue50")},permissionAction:s,dataTestId:"hr-company-structure_menu__add-employee-item"});this.localize(t,e)}localize(t,e){const s=["head","employee"].includes(e)?e:"default";const n=t===b.EntityTypes.team?"team":"default";const i={head:{team:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_ADD_TEAM_HEAD_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_ADD_TEAM_HEAD_SUBTITLE"),role:u.teamMemberRoles.head},default:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_ADD_HEAD_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_ADD_HEAD_SUBTITLE"),role:u.memberRoles.head}},employee:{team:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_ADD_TEAM_EMPLOYEE_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_ADD_TEAM_EMPLOYEE_SUBTITLE"),role:u.teamMemberRoles.employee},default:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_ADD_EMPLOYEE_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_ADD_EMPLOYEE_SUBTITLE"),role:u.memberRoles.employee}},default:{team:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_TEAM_EMPLOYEE_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_TEAM_EMPLOYEE_SUBTITLE"),role:null},default:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_EMPLOYEE_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_EMPLOYEE_SUBTITLE"),role:null}}};this.title=i[s][n].title;this.description=i[s][n].description;this.role=i[s][n].role}invoke({entityId:t,entityType:e}){l.UserManagementDialog.openDialog({nodeId:t,type:"add",role:this.role,entityType:e})}}class J extends W{constructor(t,e){const s=t===b.EntityTypes.team?M.PermissionActions.teamAddMember:M.PermissionActions.employeeAddToDepartment;super({id:X.editEmployee,imageClass:"-hr-department-org-chart-menu-edit-list",bIcon:{name:S.Main.EDIT_MENU,size:20,color:b.getColorCode("paletteBlue50")},permissionAction:s,dataTestId:"hr-company-structure_menu__edit-employee-item"});this.localize(t,e)}localize(t,e){const s=["head","employee"].includes(e)?e:"default";const n=t===b.EntityTypes.team?"team":"default";const i={head:{team:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_EDIT_TEAM_HEAD_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_EDIT_TEAM_HEAD_SUBTITLE")},default:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_EDIT_HEAD_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_EDIT_HEAD_SUBTITLE")}},employee:{team:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_EDIT_TEAM_EMPLOYEE_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_EDIT_TEAM_EMPLOYEE_SUBTITLE")},default:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_EDIT_EMPLOYEE_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_TAB_USERS_MEMBER_ACTION_MENU_EDIT_TEAM_EMPLOYEE_SUBTITLE")}},default:{team:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_TEAM_EMPLOYEE_LIST_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_TEAM_EMPLOYEE_LIST_SUBTITLE")},default:{title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_EMPLOYEE_LIST_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_EMPLOYEE_LIST_SUBTITLE")}}};this.title=i[s][n].title;this.description=i[s][n].description}invoke({entityId:t,analyticSource:e}){N.EventEmitter.emit(P.HR_ENTITY_SHOW_WIZARD,{nodeId:t,isEditMode:true,showEntitySelector:false,type:"employees",source:e})}}class tt extends W{constructor(){super({id:X.moveEmployee,title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_MOVE_EMPLOYEE_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_MOVE_EMPLOYEE_SUBTITLE"),bIcon:{name:S.Main.PERSON_ARROW_LEFT_1,size:20,color:b.getColorCode("paletteBlue50")},permissionAction:M.PermissionActions.employeeAddToDepartment,dataTestId:"hr-company-structure_menu__move-employee-item"})}invoke({entityId:t,analyticSource:e}){l.UserManagementDialog.openDialog({nodeId:t,type:"move"})}hasPermission(t,e){return t.currentUserPermissions.ACTION_EMPLOYEE_REMOVE_FROM_DEPARTMENT&&t.hasPermission(this.permissionAction,e)}}class et extends W{constructor(){super({id:X.userInvite,title:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_USER_INVITE_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_USER_INVITE_SUBTITLE"),bIcon:{name:S.Main.PERSON_LETTER,size:20,color:b.getColorCode("paletteBlue50")},permissionAction:M.PermissionActions.inviteToDepartment,dataTestId:"hr-company-structure_menu__user-invite-item"})}invoke({entityId:t}){BX.SidePanel.Instance.open("/bitrix/services/main/ajax.php?action=getSliderContent"+"&c=bitrix%3Aintranet.invitation&mode=ajax"+`&departments[]=${Number(t)}&firstInvitationBlock=invite-with-group-dp`,{cacheable:false,allowChangeHistory:false,width:1100})}}class st extends j{constructor(t,e,s){super(t);this.entityType=e;this.analyticSource=s;this.items=this.getFilteredItems()}getItems(){if(this.entityType===b.EntityTypes.team){return[new Z(this.entityType),new K(this.entityType),new Q(this.entityType),new q(this.entityType)]}return[new Z(this.entityType),new K(this.entityType),new Q(this.entityType),new tt,new et,new q(this.entityType)]}}const nt={name:"DepartmentMenuButton",components:{RouteActionMenu:h.RouteActionMenu},props:{entityId:{type:Number,required:true},entityType:{type:String,default:b.EntityTypes.department}},data(){return{menuVisible:false}},computed:{menu(){return new st(this.entityId,this.entityType,u.AnalyticsSourceType.CARD)}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},onActionMenuItemClick(t){this.menu.onActionMenuItemClick(t)},closeMenu(){if(this.menuVisible){this.menuVisible=false;N.EventEmitter.unsubscribe(P.HR_DEPARTMENT_MENU_CLOSE,this.closeMenu);N.EventEmitter.unsubscribe(P.HR_DRAG_ENTITY,this.closeMenu)}},openMenu(){if(!this.menuVisible){this.menuVisible=true;N.EventEmitter.subscribe(P.HR_DEPARTMENT_MENU_CLOSE,this.closeMenu);N.EventEmitter.subscribe(P.HR_DRAG_ENTITY,this.closeMenu)}}},template:`\n\t\t<div\n\t\t\tv-if="menu.items.length"\n\t\t\tclass="ui-icon-set --more humanresources-tree__node_department-menu-button"\n\t\t\t:class="{ '--focused': this.menuVisible }"\n\t\t\tref="departmentMenuButton"\n\t\t\tdata-test-id="tree-node-more-button"\n\t\t\t@click.stop="openMenu"\n\t\t>\n\t\t</div>\n\n\t\t<RouteActionMenu\n\t\t\tv-if="menuVisible"\n\t\t\t:id="'tree-node-department-menu-' + entityId"\n\t\t\t:width="302"\n\t\t\t:items="menu.items"\n\t\t\t:bindElement="this.$refs.departmentMenuButton"\n\t\t\t@action="onActionMenuItemClick"\n\t\t\t@close="closeMenu"\n\t\t/>\n\t`};const it={name:"DepartmentInfoIconButton",components:{BasePopup:h.BasePopup},props:{entityId:{type:Number,required:true},canvasZoom:{type:Number,required:true},description:{type:[String,null],default:null}},data(){return{showPopup:false}},computed:{popupConfig(){const t=340;const e=22*this.canvasZoom;const s=41-this.canvasZoom;const n=33;return{width:t,bindElement:this.$refs.departmentMenuButton,bindOptions:{position:"top"},borderRadius:"12px",contentNoPaddings:true,contentPadding:0,padding:16,offsetTop:-2*this.canvasZoom,offsetLeft:e/2-t/2+s,angleOffset:t/2-n/2}}},created(){this.menuItem=new Z(b.EntityTypes.team);const t=M.PermissionChecker.getInstance();this.canEdit=this.menuItem.hasPermission(t,this.entityId)},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},onClose(){if(this.showPopup){this.showPopup=false;N.EventEmitter.unsubscribe(P.HR_DEPARTMENT_MENU_CLOSE,this.onClose);N.EventEmitter.unsubscribe(P.HR_DRAG_ENTITY,this.onClose)}},onOpen(){if(!this.showPopup){this.showPopup=true;N.EventEmitter.subscribe(P.HR_DEPARTMENT_MENU_CLOSE,this.onClose);N.EventEmitter.subscribe(P.HR_DRAG_ENTITY,this.onClose)}},addDescription(){this.onClose();this.menuItem.invoke({entityId:this.entityId,analyticSource:u.AnalyticsSourceType.CARD,refToFocus:"description"})}},template:`\n\t\t<div\n\t\t\tv-if="canEdit || description"\n\t\t\tclass="ui-icon-set --info-1 humanresources-tree__node_department-menu-button"\n\t\t\t:class="{ '--focused': this.showPopup }"\n\t\t\tref="departmentMenuButton"\n\t\t\t@click.stop="onOpen"\n\t\t\tdata-test-id="tree-node-info-button"\n\t\t>\n\t\t</div>\n\t\t<BasePopup\n\t\t\tv-if="showPopup"\n\t\t\t:config="popupConfig"\n\t\t\t:id="'humanresources-tree__node_info-popup' + entityId"\n\t\t\t@close="onClose"\n\t\t>\n\t\t\t<div class="humanresources-tree__node_info-popup-content_description" v-if="description">\n\t\t\t\t{{ description }}\n\t\t\t</div>\n\t\t\t<div v-else class="humanresources-tree__node_info-popup-content">\n\t\t\t\t<div class="humanresources-tree__node_info-popup-content_left"></div>\n\t\t\t\t<div class="humanresources-tree__node_info-popup-content_right">\n\t\t\t\t\t<div class="humanresources-tree__node_info-popup-content_right_title">\n\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_INFO_POPUP_ADD_DESCRIPTION_TITLE') }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="humanresources-tree__node_info-popup-content_right_text">\n\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_INFO_POPUP_ADD_DESCRIPTION_TEXT') }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="ui-btn ui-btn-primary ui-btn-round ui-btn-xs ui-btn-no-caps"\n\t\t\t\t\t\tdata-test-id="tree-node-info-popup_add-button"\n\t\t\t\t\t\t@click="addDescription"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_INFO_POPUP_ADD_DESCRIPTION_BUTTON') }}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</BasePopup>\n\t`};const ot={name:"SubdivisionAddButton",components:{BIcon:T.BIcon},props:{entityId:{type:Number,required:true},entityType:{type:String,default:b.EntityTypes.department}},computed:{set(){return T.Set}},created(){this.menuItem=new K(this.entityType);const t=M.PermissionChecker.getInstance();this.canShow=this.menuItem.hasPermission(t,this.entityId)},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},addSubdivision(){this.menuItem.invoke({entityId:this.entityId,analyticSource:u.AnalyticsSourceType.PLUS,entityType:this.entityType})}},template:`\n\t\t<div class="humanresources-tree__node_add-subdivision" v-if="canShow">\n\t\t  <button class="humanresources-tree__node_add-button" @click="addSubdivision">\n\t\t    <BIcon :name="set.PLUS_20" :size="32" class="humanresources-tree__node_add-icon"></BIcon>\n\t\t  </button>\n\t\t</div>\n\t`};const rt={name:"treeNode",components:{DepartmentMenuButton:nt,HeadList:G,SubdivisionAddButton:ot,DepartmentInfoIconButton:it},directives:{hint:h.Hint},inject:["getTreeBounds"],props:{nodeId:{type:Number,required:true},expandedNodes:{type:Array,required:true},canvasZoom:{type:Number,required:true},currentDepartments:{type:Array,required:true},isShown:{type:Boolean,required:false,default:true},userDropTargetNodeId:{type:Number,default:null},isUserDropAllowed:{type:Boolean,default:false},isDraggingUser:{type:Boolean,default:false}},emits:["calculatePosition"],data(){return{childrenOffset:0,childrenMounted:false,showInfo:true,showDnd:true}},computed:{memberRoles(){return u.getMemberRoles(this.nodeData.entityType)},nodeData(){return this.departments.get(this.nodeId)},nodeClass(){const t=this.isDraggingUser&&this.nodeId===this.focusedNode;return{"--expanded":this.expandedNodes.includes(this.nodeId),"--current-department":this.isCurrentDepartment,"--focused":this.focusedNode===this.nodeId,"--with-restricted-access-rights":!this.showInfo,"--team":this.isTeamEntity,"--drag-source":t}},subdivisionsClass(){return{"humanresources-tree__node_arrow":this.hasChildren,"--up":this.hasChildren&&this.isExpanded,"--down":this.hasChildren&&!this.isExpanded,"--transparent":!this.hasChildren}},hasChildren(){var t;return((t=this.nodeData.children)==null?void 0:t.length)>0},isExpanded(){return this.expandedNodes.includes(this.nodeId)},isCurrentDepartment(){return this.currentDepartments.includes(this.nodeId)},head(){var t;return(t=this.nodeData.heads)==null?void 0:t.filter((t=>t.role===this.memberRoles.head))},deputy(){var t;return(t=this.nodeData.heads)==null?void 0:t.filter((t=>t.role===this.memberRoles.deputyHead))},employeeCount(){return this.nodeData.userCount-this.nodeData.heads.length},childNodeStyle(){return{left:`${this.childrenOffset}px`}},showSubdivisionAddButton(){return this.expandedNodes.includes(this.nodeId)||this.focusedNode===this.nodeId},isTeamEntity(){return this.nodeData.entityType===b.EntityTypes.team},nodeDataTitle(){if(!this.isCurrentDepartment){return null}return this.isTeamEntity?this.loc("HUMANRESOURCES_COMPANY_CURRENT_TEAM"):this.loc("HUMANRESOURCES_COMPANY_CURRENT_DEPARTMENT")},subdivisionsText(){var t;if(this.isTeamEntity){var e;return(e=this.nodeData.children)!=null&&e.length?this.locPlural("HUMANRESOURCES_COMPANY_TEAM_CHILDREN_COUNT",this.nodeData.children.length):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_TREE_TEAM_NO_SUBDEPARTMENTS")}if(!((t=this.nodeData.children)!=null&&t.length)){return this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_TREE_NO_SUBDEPARTMENTS")}const s=[...this.departments.values()].filter((t=>t.entityType===b.EntityTypes.department&&this.nodeData.children.includes(t.id))).length;const n=[...this.departments.values()].filter((t=>t.entityType===b.EntityTypes.team&&this.nodeData.children.includes(t.id))).length;if(n>0&&s>0){return this.loc("HUMANRESOURCES_COMPANY_DEPARTMENT_CHILDREN_COUNT_WITH_CONJUNCTION",{"#DEPT_COUNT#":this.locPlural("HUMANRESOURCES_COMPANY_DEPARTMENT_CHILDREN_COUNT",s),"#TEAM_COUNT#":this.locPlural("HUMANRESOURCES_COMPANY_TEAM_CHILDREN_COUNT",n)})}if(s>0){return this.locPlural("HUMANRESOURCES_COMPANY_DEPARTMENT_CHILDREN_COUNT",s)}if(n>0){return this.locPlural("HUMANRESOURCES_COMPANY_TEAM_CHILDREN_COUNT",n)}return this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_TREE_NO_SUBDEPARTMENTS")},deputyTitle(){return this.isTeamEntity?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_TREE_TEAM_DEPUTY_TITLE"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_TREE_DEPUTY_TITLE")},dropOverlayText(){const t=this.departments.get(this.focusedNode);if(t.entityType===b.EntityTypes.team&&this.nodeData.entityType===b.EntityTypes.department){return this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DND_USER_MOVED_FORBIDDEN")}return this.isUserDropAllowed?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DND_USER_MOVED_APPROVED"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DND_USER_MOVED_NO_RIGHTS")},showOverlay(){return this.nodeId===this.userDropTargetNodeId&&this.nodeId!==this.focusedNode},...d.mapState(R.useChartStore,["departments","focusedNode"])},watch:{head(){this.adaptHeight()},isShown(){this.adaptHeight()},isExpanded:{handler(t){if(t&&!this.childrenMounted){this.childrenMounted=true}},immediate:true}},created(){this.width=278;this.gap=24;this.prevChildrenOffset=0;this.prevHeight=0},async mounted(){let t="";let e="";if(this.isTeamEntity){e=M.PermissionActions.teamView;t=M.PermissionActions.teamEdit}else{e=M.PermissionActions.structureView;t=M.PermissionActions.departmentEdit}const s=M.PermissionChecker.getInstance();this.showInfo=s.hasPermission(e,this.nodeId);this.showDnd=s.hasPermission(t,this.nodeId)&&s.hasPermission(t,this.nodeData.parentId);this.$emit("calculatePosition",this.nodeId);await this.$nextTick();this.prevHeight=this.$el.offsetHeight;N.EventEmitter.emit(P.HR_DEPARTMENT_CONNECT,{id:this.nodeId,parentId:this.nodeData.parentId,html:this.$el,parentsPath:this.getParentsPath(this.nodeData.parentId),...this.calculateNodePoints()})},unmounted(){U.Dom.remove(this.$el);const{prevParentId:t}=this.nodeData;if(!t){return}this.$emit("calculatePosition",this.nodeId);N.EventEmitter.emit(P.HR_DEPARTMENT_DISCONNECT,{id:this.nodeId,parentId:t})},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},onDepartmentClick(t){if(!this.showInfo){return}N.EventEmitter.emit(P.HR_DEPARTMENT_FOCUS,{nodeId:this.nodeId,showEmployees:t==="employees",subdivisionsSelected:t==="subdivisions"})},calculatePosition(t){const e=this.departments.get(this.nodeId);if(e.children.length===0){this.childrenOffset=0}else{const t=this.gap*(e.children.length-1);this.prevChildrenOffset=this.childrenOffset;this.childrenOffset=(this.width-(this.width*e.children.length+t))/2}const s=this.childrenOffset-this.prevChildrenOffset;if(s!==0){N.EventEmitter.emit(P.HR_DEPARTMENT_ADAPT_SIBLINGS,{parentId:this.nodeId,nodeId:t,offset:s})}},locPlural(t,e){return U.Loc.getMessagePlural(t,e,{"#COUNT#":e})},calculateNodePoints(){const{left:t,top:e,width:s}=this.$el.getBoundingClientRect();const{$el:n}=this.$parent.$parent;const{left:i,top:o,width:r,height:a}=n.getBoundingClientRect();const{x:l,y:d}=this.getTreeBounds();return{startPoint:{x:(i-l+r/2)/this.canvasZoom,y:(o-d+a)/this.canvasZoom},endPoint:{x:(t-l+s/2)/this.canvasZoom,y:(e-d)/this.canvasZoom}}},getParentsPath(t){let e=t;const s=[t];while(e){const t=this.departments.get(e);e=t.parentId;if(e){s.push(e)}}return s},async adaptHeight(){if(!this.isShown){return}await this.$nextTick();const t=this.$el.offsetHeight-this.prevHeight;if(t!==0){N.EventEmitter.emit(P.HR_DEPARTMENT_ADAPT_CONNECTOR_HEIGHT,{nodeId:this.nodeId,shift:t});this.prevHeight=this.$el.offsetHeight}},onDragMouseEnter(){N.EventEmitter.emit(P.HR_USER_DRAG_ENTER_NODE,{nodeId:this.nodeId})},onDragMouseLeave(){N.EventEmitter.emit(P.HR_USER_DRAG_LEAVE_NODE,{nodeId:this.nodeId})}},template:`\n\t\t<div\n\t\t\t:data-id="nodeId"\n\t\t\t:class="nodeClass"\n\t\t\t:data-title="nodeDataTitle"\n\t\t\tclass="humanresources-tree__node"\n\t\t\t:style="{\n\t\t\t\t'--team-bubble-background': nodeData.teamColor?.bubbleBackground,\n\t\t\t\t'--team-focused-border-color': nodeData.teamColor?.focusedBorderColor,\n\t\t\t\t'--node-expanded-color': nodeData.teamColor?.expandedBorderColor,\n\t\t\t}"\n\t\t>\n\t\t\t<div v-if="showOverlay"\n\t\t\t\tclass="humanresources-tree__node_drop-overlay"\n\t\t\t>\n\t\t\t\t<div class="ui-icon-set"\n\t\t\t\t\t :class="{\n\t\t\t\t\t'--circle-plus': isUserDropAllowed,\n\t\t\t\t\t'--cross-circle-50': !isUserDropAllowed\n\t\t\t\t}"\n\t\t\t\t></div>\n\t\t\t\t<div class="humanresources-tree__node_drop-overlay-text">\n\t\t\t\t\t{{ dropOverlayText }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tclass="humanresources-tree__node_summary"\n\t\t\t\t@click.stop="onDepartmentClick('department')"\n\t\t\t\t@mouseenter="onDragMouseEnter"\n\t\t\t\t@mouseleave="onDragMouseLeave"\n\t\t\t>\n\t\t\t\t<template v-if="showInfo">\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="humanresources-tree__node_department"\n\t\t\t\t\t\t:style="{ 'background-color': nodeData.teamColor?.treeHeadBackground}"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div class="humanresources-tree__node_department-title">\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tv-if="nodeData.parentId !== 0 && showDnd"\n\t\t\t\t\t\t\t\tclass="humanresources-tree__node_dnd-icon ui-icon-set --more-points"\n\t\t\t\t\t\t\t\t:class="{ '--team': isTeamEntity }"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tv-hint\n\t\t\t\t\t\t\t\tclass="humanresources-tree__node_department-title_text"\n\t\t\t\t\t\t\t\t:class="{ '--no-dnd': !showDnd }"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{{nodeData.name}}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="humanresources-tree__node_department-menu-icons">\n\t\t\t\t\t\t\t<DepartmentInfoIconButton\n\t\t\t\t\t\t\t\tv-if="isTeamEntity"\n\t\t\t\t\t\t\t\t:description="nodeData.description"\n\t\t\t\t\t\t\t\t:entityId="nodeId"\n\t\t\t\t\t\t\t\t:canvasZoom="canvasZoom"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<DepartmentMenuButton\n\t\t\t\t\t\t\t\tv-if="head && deputy"\n\t\t\t\t\t\t\t\t:entityId="nodeId"\n\t\t\t\t\t\t\t\t:entityType="nodeData.entityType"\n\t\t\t\t\t\t\t></DepartmentMenuButton>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="humanresources-tree__node_description">\n\t\t\t\t\t\t<HeadList v-if="head"\n\t\t\t\t\t\t\t\t:entityId="nodeId"\n\t\t\t\t\t\t\t\t:items="head"\n\t\t\t\t\t\t\t\t:isTeamEntity="isTeamEntity"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tv-else\n\t\t\t\t\t\t\tclass="humanresources-tree__node_load-skeleton --heads"\n\t\t\t\t\t\t></div>\n\t\t\t\t\t\t<div v-if="deputy" class="humanresources-tree__node_employees">\n\t\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t\t<p class="humanresources-tree__node_employees-title">\n\t\t\t\t\t\t\t\t\t{{\n\t\t\t\t\t\t\t\t\t\tisTeamEntity\n\t\t\t\t\t\t\t\t\t\t\t? loc('HUMANRESOURCES_COMPANY_STRUCTURE_TREE_TEAM_EMPLOYEES_TITLE')\n\t\t\t\t\t\t\t\t\t\t\t: loc('HUMANRESOURCES_COMPANY_STRUCTURE_TREE_EMPLOYEES_TITLE')\n\t\t\t\t\t\t\t\t\t}}\n\t\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\tclass="humanresources-tree__node_employees-count"\n\t\t\t\t\t\t\t\t\t@click.stop="onDepartmentClick('employees')"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{{locPlural('HUMANRESOURCES_COMPANY_STRUCTURE_TREE_EMPLOYEES_COUNT', employeeCount)}}\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div v-if="!deputy.length"></div>\n\t\t\t\t\t\t\t<HeadList\n\t\t\t\t\t\t\t\t:items="deputy"\n\t\t\t\t\t\t\t\t:title="deputyTitle"\n\t\t\t\t\t\t\t\t:collapsed="true"\n\t\t\t\t\t\t\t\t:type="'deputy'"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t</HeadList>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tv-else\n\t\t\t\t\t\t\tclass="humanresources-tree__node_load-skeleton --deputies"\n\t\t\t\t\t\t></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="humanresources-tree__node_subdivisions"\n\t\t\t\t\t\t:class="subdivisionsClass"\n\t\t\t\t\t\t@click.stop="onDepartmentClick('subdivisions')"\n\t\t\t\t\t>\n\t\t\t\t\t\t<span>{{ subdivisionsText }}</span>\n\t\t\t\t\t</div>\n\t\t\t\t</template>\n\t\t\t\t<svg v-else width="24" height="24" viewBox="0 0 24 24" fill="none" class="humanresources-tree__node_lock">\n\t\t\t\t\t<path d="M12.0646 4.231C13.9529 4.231 15.4836 5.76968 15.4836 7.66775V10.5612H17.2905V7.66775C17.2905 4.76657 14.9507 2.41476 12.0645 2.41476C9.17827 2.41476 6.83847 4.76657 6.83847 7.66775V10.5612H8.64544V7.66775C8.64544 5.76968 10.1762 4.231 12.0646 4.231Z" fill="#D5D7DB"/>\n\t\t\t\t\t<path fill-rule="evenodd" clip-rule="evenodd" d="M7.14721 10.3237C6.12854 10.3237 5.30273 11.1495 5.30273 12.1682V18.506C5.30273 19.5246 6.12854 20.3504 7.14722 20.3504H17.1029C18.1216 20.3504 18.9474 19.5246 18.9474 18.506V12.1682C18.9474 11.1495 18.1216 10.3237 17.1029 10.3237H7.14721ZM12.9216 15.5869C12.9216 15.5685 12.93 15.5512 12.944 15.5392C13.2142 15.3085 13.3859 14.9643 13.3859 14.5797C13.3859 13.8847 12.8259 13.3214 12.1353 13.3214C11.4446 13.3214 10.8846 13.8847 10.8846 14.5797C10.8846 14.9643 11.0563 15.3085 11.3266 15.5392C11.3406 15.5512 11.3489 15.5685 11.3489 15.5869V16.7572C11.3489 17.1915 11.701 17.5435 12.1353 17.5435C12.5696 17.5435 12.9216 17.1915 12.9216 16.7572V15.5869Z" fill="#D5D7DB"/>\n\t\t\t\t</svg>\n\t\t\t\t<SubdivisionAddButton\n\t\t\t\t\tv-if="showSubdivisionAddButton"\n\t\t\t\t\t:entityId="nodeId"\n\t\t\t\t\t:entityType="nodeData.entityType"\n\t\t\t\t\t@click.stop\n\t\t\t\t></SubdivisionAddButton>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tv-if="nodeData.parentId === 0 && !hasChildren"\n\t\t\t\tclass="humanresources-tree__node_empty-skeleton"\n\t\t\t></div>\n\t\t\t<div\n\t\t\t\tv-if="hasChildren"\n\t\t\t\tref="childrenNode"\n\t\t\t\tclass="humanresources-tree__node_children"\n\t\t\t\t:style="childNodeStyle"\n\t\t\t>\n\t\t\t\t<TransitionGroup>\n\t\t\t\t\t<treeNode\n\t\t\t\t\t\tv-for="id in nodeData.children"\n\t\t\t\t\t\tv-if="isExpanded || childrenMounted"\n\t\t\t\t\t\tv-show="isExpanded"\n\t\t\t\t\t\t:ref="'node-' + id"\n\t\t\t\t\t\t:key="id"\n\t\t\t\t\t\t:nodeId="id"\n\t\t\t\t\t\t:expandedNodes="expandedNodes"\n\t\t\t\t\t\t:canvasZoom="canvasZoom"\n\t\t\t\t\t\t:currentDepartments="currentDepartments"\n\t\t\t\t\t\t:isShown="isExpanded"\n\t\t\t\t\t\t@calculatePosition="calculatePosition"\n\t\t\t\t\t\t:userDropTargetNodeId="userDropTargetNodeId"\n\t\t\t\t\t\t:isUserDropAllowed="isUserDropAllowed"\n\t\t\t\t\t\t:isDraggingUser="isDraggingUser"\n\t\t\t\t\t/>\n\t\t\t\t</TransitionGroup>\n\t\t\t</div>\n\t\t</div>\n\t`};const at={name:"companyTreeConnectors",expose:["toggleConnectorsVisibility","toggleConnectorHighlighting","toggleAllConnectorsVisibility","adaptConnectorsAfterReorder"],props:{isLocatedDepartmentVisible:{type:Boolean,required:true},treeNodes:{type:Object,required:true}},data(){return{connectors:{}}},computed:{...d.mapState(R.useChartStore,["focusedNode","departments"])},created(){this.subscribeOnEvents();this.prevWindowWidth=window.innerWidth},beforeUnmount(){this.unsubscribeFromEvents()},methods:{onAddConnector({data:t}){var e;const{id:s,parentId:n}=t;if(!n){return}const i=(e=this.connectors[`${n}-${s}`])!=null?e:{};Object.assign(i,t);if(i.highlighted){delete this.connectors[`${n}-${s}`]}this.connectors[`${n}-${s}`]={show:true,highlighted:false,...i}},onRemoveConnector({data:t}){const{parentId:e,id:s}=t;delete this.connectors[`${e}-${s}`]},onAdaptSiblingConnectors({data:t}){const{nodeId:e,parentId:s,offset:n}=t;const i=this.departments.get(s);const o=i.children.includes(e);const r=Object.values(this.connectors);const a=r.reduce(((t,n)=>{const{endPoint:r,id:a,parentId:l}=n;if(!a||l!==s||a===e){return t}let d=0;if(o){d=i.children.indexOf(e)>i.children.indexOf(a)?1:-1}else{const{endPoint:t}=this.connectors[`${s}-${e}`];d=t.x>r.x?1:-1}return{...t,[a]:d}}),{});r.forEach((t=>{const{id:i,parentId:o,parentsPath:r,endPoint:l,startPoint:d}=t;if(!i||i===e){return}if(o===s){const{x:t}=l;const e=a[i];Object.assign(l,{x:t+n*e});return}const c=r==null?void 0:r.find((t=>Boolean(a[t])));if(c){const t=a[c];Object.assign(d,{x:d.x+n*t});Object.assign(l,{x:l.x+n*t})}}))},adaptConnectorsAfterReorder(t,e,s){t.forEach((t=>{const{parentId:n,children:i}=this.departments.get(t);const o=this.connectors[`${n}-${t}`];if(!o){return}Object.assign(o.endPoint,{x:o.endPoint.x+e});if(!s){Object.assign(o.startPoint,{x:o.startPoint.x+e})}if((i==null?void 0:i.length)>0){this.adaptConnectorsAfterReorder(i,e,false)}}))},onAdaptConnectorHeight({data:t}){const{shift:e,nodeId:s}=t;Object.values(this.connectors).forEach((t=>{if(t.parentId===s){Object.assign(t.startPoint,{y:t.startPoint.y+e})}}))},toggleConnectorsVisibility(t,e){const{children:s}=this.departments.get(t);s.forEach((s=>{var n;const i=(n=this.connectors[`${t}-${s}`])!=null?n:{};this.connectors={...this.connectors,[`${t}-${s}`]:{...i,show:e}}}))},toggleAllConnectorsVisibility(t,e){Object.keys(this.connectors).forEach((s=>{const n=this.connectors[s];if(!t||e.includes(n.parentId)&&t){n.show=t}}))},toggleConnectorHighlighting(t,e){var s;const{parentId:n}=this.departments.get(t);if(!n){return}if(!e){this.connectors[`${n}-${t}`]={...this.connectors[`${n}-${t}`],highlighted:false};return}const i=(s=this.connectors[`${n}-${t}`])!=null?s:{};delete this.connectors[`${n}-${t}`];this.connectors={...this.connectors,[`${n}-${t}`]:{...i,highlighted:true}}},getPath(t){const e=this.connectors[t];const{startPoint:s,endPoint:n,parentId:i}=e;if(!s||!n){return""}let o=115;const r=this.treeNodes.get(i);const a=getComputedStyle(r);const l=parseInt(a.getPropertyValue("--min-height"),10);const d=r.offsetHeight-l;o=d>0?o-d:o;const c=1;const u=s.y-c;const h=this.focusedNode===e.id?12:0;const E={start:"",end:""};let p=0;if(Math.round(s.x)>Math.round(n.x)){p=15;E.start="a15,15 0 0 1 -15,15";E.end="a15,15 0 0 0 -15,15"}else if(Math.round(s.x)<Math.round(n.x)){p=-15;E.start="a15,15 0 0 0 15,15";E.end="a15,15 0 0 1 15,15"}const _=n.y-h;return[`M${s.x} ${u}`,`V${u+o}`,`${String(E.start)}`,`H${n.x+p}`,`${String(E.end)}`,`V${_}`].join("")},subscribeOnEvents(){this.events={[P.HR_DEPARTMENT_CONNECT]:this.onAddConnector,[P.HR_DEPARTMENT_DISCONNECT]:this.onRemoveConnector,[P.HR_DEPARTMENT_ADAPT_SIBLINGS]:this.onAdaptSiblingConnectors,[P.HR_DEPARTMENT_ADAPT_CONNECTOR_HEIGHT]:this.onAdaptConnectorHeight};Object.entries(this.events).forEach((([t,e])=>{N.EventEmitter.subscribe(t,e)}));U.Event.bind(window,"resize",this.onResizeWindow)},unsubscribeFromEvents(){Object.entries(this.events).forEach((([t,e])=>{N.EventEmitter.unsubscribe(t,e)}));U.Event.unbind(window,"resize",this.onResizeWindow)},onResizeWindow(){const t=(window.innerWidth-this.prevWindowWidth)/2;this.prevWindowWidth=window.innerWidth;if(t===0){return}Object.keys(this.connectors).forEach((e=>{const s=this.connectors[e];if(s.startPoint&&s.endPoint){const e=s.startPoint.x;const n=s.endPoint.x;Object.assign(s.startPoint,{x:e+t});Object.assign(s.endPoint,{x:n+t})}}))}},template:`\n\t\t<svg class="humanresources-tree__connectors" fill="none">\n\t\t\t<marker\n\t\t\t\tid='arrow'\n\t\t\t\tmarkerUnits='userSpaceOnUse'\n\t\t\t\tmarkerWidth='20'\n\t\t\t\tmarkerHeight='12'\n\t\t\t\trefX='10'\n\t\t\t\trefY='10.5'\n\t\t\t>\n\t\t\t\t<path d="M1 1L10 10L19 1" class="--highlighted" />\n\t\t\t</marker>\n\t\t\t<path\n\t\t\t\tv-for="(connector, id) in connectors"\n\t\t\t\tv-show="connector.show"\n\t\t\t\t:ref="id"\n\t\t\t\t:marker-end="connector.highlighted ? 'url(#arrow)' : null"\n\t\t\t\t:class="{ '--highlighted': connector.highlighted }"\n\t\t\t\t:id="id"\n\t\t\t\t:d="getPath(id)"\n\t\t\t></path>\n\t\t</svg>\n\t`};let lt=t=>t,dt;const ct=302;const ut=15;var ht=babelHelpers.classPrivateFieldLooseKey("prevAffectedItems");var Et=babelHelpers.classPrivateFieldLooseKey("targetData");var pt=babelHelpers.classPrivateFieldLooseKey("transform");var _t=babelHelpers.classPrivateFieldLooseKey("tree");var mt=babelHelpers.classPrivateFieldLooseKey("draggedItem");var Tt=babelHelpers.classPrivateFieldLooseKey("ghost");var Rt=babelHelpers.classPrivateFieldLooseKey("positionPointer");var Ct=babelHelpers.classPrivateFieldLooseKey("zoom");var vt=babelHelpers.classPrivateFieldLooseKey("canvas");var At=babelHelpers.classPrivateFieldLooseKey("prevPageX");var bt=babelHelpers.classPrivateFieldLooseKey("prevPageY");var St=babelHelpers.classPrivateFieldLooseKey("targetTeams");var Mt=babelHelpers.classPrivateFieldLooseKey("permissionChecker");var Nt=babelHelpers.classPrivateFieldLooseKey("draggedEntityType");var Ut=babelHelpers.classPrivateFieldLooseKey("mouseMoveHandler");var Pt=babelHelpers.classPrivateFieldLooseKey("mouseUpHandler");var yt=babelHelpers.classPrivateFieldLooseKey("mouseWheelHandler");var Dt=babelHelpers.classPrivateFieldLooseKey("onMouseDown");var gt=babelHelpers.classPrivateFieldLooseKey("onMouseMove");var ft=babelHelpers.classPrivateFieldLooseKey("onMouseUp");var It=babelHelpers.classPrivateFieldLooseKey("onMouseWheel");var Ot=babelHelpers.classPrivateFieldLooseKey("createGhost");var Ht=babelHelpers.classPrivateFieldLooseKey("createPositionPointer");var Lt=babelHelpers.classPrivateFieldLooseKey("setTransform");var Bt=babelHelpers.classPrivateFieldLooseKey("setPositionPointerTransform");var Ft=babelHelpers.classPrivateFieldLooseKey("getTargetData");var wt=babelHelpers.classPrivateFieldLooseKey("reorderEntity");var xt=babelHelpers.classPrivateFieldLooseKey("changeParentWithReorder");var Yt=babelHelpers.classPrivateFieldLooseKey("checkForDraggedOverflow");var Vt=babelHelpers.classPrivateFieldLooseKey("setStyles");var kt=babelHelpers.classPrivateFieldLooseKey("resetTeamsBlur");class $t{constructor(t){Object.defineProperty(this,kt,{value:ne});Object.defineProperty(this,Vt,{value:se});Object.defineProperty(this,Yt,{value:ee});Object.defineProperty(this,xt,{value:te});Object.defineProperty(this,wt,{value:Jt});Object.defineProperty(this,Ft,{value:Qt});Object.defineProperty(this,Bt,{value:qt});Object.defineProperty(this,Lt,{value:Zt});Object.defineProperty(this,Ht,{value:Kt});Object.defineProperty(this,Ot,{value:Xt});Object.defineProperty(this,It,{value:Wt});Object.defineProperty(this,ft,{value:jt});Object.defineProperty(this,gt,{value:Gt});Object.defineProperty(this,Dt,{value:zt});Object.defineProperty(this,ht,{writable:true,value:void 0});Object.defineProperty(this,Et,{writable:true,value:void 0});Object.defineProperty(this,pt,{writable:true,value:void 0});Object.defineProperty(this,_t,{writable:true,value:void 0});Object.defineProperty(this,mt,{writable:true,value:void 0});Object.defineProperty(this,Tt,{writable:true,value:void 0});Object.defineProperty(this,Rt,{writable:true,value:void 0});Object.defineProperty(this,Ct,{writable:true,value:void 0});Object.defineProperty(this,vt,{writable:true,value:void 0});Object.defineProperty(this,At,{writable:true,value:0});Object.defineProperty(this,bt,{writable:true,value:0});Object.defineProperty(this,St,{writable:true,value:void 0});Object.defineProperty(this,Mt,{writable:true,value:void 0});Object.defineProperty(this,Nt,{writable:true,value:void 0});Object.defineProperty(this,Ut,{writable:true,value:void 0});Object.defineProperty(this,Pt,{writable:true,value:void 0});Object.defineProperty(this,yt,{writable:true,value:void 0});U.Event.bind(t,"mousedown",(t=>{babelHelpers.classPrivateFieldLooseBase(this,Dt)[Dt](t)}));babelHelpers.classPrivateFieldLooseBase(this,Ut)[Ut]=t=>{babelHelpers.classPrivateFieldLooseBase(this,gt)[gt](t)};babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt]=t=>{babelHelpers.classPrivateFieldLooseBase(this,ft)[ft](t)};babelHelpers.classPrivateFieldLooseBase(this,yt)[yt]=t=>{babelHelpers.classPrivateFieldLooseBase(this,It)[It](t)};babelHelpers.classPrivateFieldLooseBase(this,Mt)[Mt]=M.PermissionChecker.getInstance()}}function zt({target:t,currentTarget:e,pageX:s,pageY:n}){if(!U.Dom.hasClass(t,"humanresources-tree__node_dnd-icon")){return}event.stopPropagation();babelHelpers.classPrivateFieldLooseBase(this,_t)[_t]=e;babelHelpers.classPrivateFieldLooseBase(this,Ct)[Ct]=Number(e.dataset.zoom);babelHelpers.classPrivateFieldLooseBase(this,vt)[vt]={x:Number(e.dataset.x),y:Number(e.dataset.y)};babelHelpers.classPrivateFieldLooseBase(this,mt)[mt]=t.closest(".humanresources-tree__node");babelHelpers.classPrivateFieldLooseBase(this,Tt)[Tt]=babelHelpers.classPrivateFieldLooseBase(this,Ot)[Ot]();babelHelpers.classPrivateFieldLooseBase(this,At)[At]=s;babelHelpers.classPrivateFieldLooseBase(this,bt)[bt]=n;babelHelpers.classPrivateFieldLooseBase(this,Rt)[Rt]=babelHelpers.classPrivateFieldLooseBase(this,Ht)[Ht]();babelHelpers.classPrivateFieldLooseBase(this,St)[St]=[];babelHelpers.classPrivateFieldLooseBase(this,ht)[ht]=[];babelHelpers.classPrivateFieldLooseBase(this,pt)[pt]={x:0,y:0,prevX:0,prevY:0};babelHelpers.classPrivateFieldLooseBase(this,Et)[Et]={};babelHelpers.classPrivateFieldLooseBase(this,Nt)[Nt]=U.Dom.hasClass(babelHelpers.classPrivateFieldLooseBase(this,mt)[mt],"--team")?b.EntityTypes.team:b.EntityTypes.department;U.Dom.addClass(e,"--drag-progress");U.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].parentElement.parentElement,"--blur");babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt](babelHelpers.classPrivateFieldLooseBase(this,mt)[mt]);babelHelpers.classPrivateFieldLooseBase(this,Vt)[Vt]();U.Event.bind(document,"mousemove",babelHelpers.classPrivateFieldLooseBase(this,Ut)[Ut]);U.Event.bind(document,"mouseup",babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt]);U.Event.bind(document,"wheel",babelHelpers.classPrivateFieldLooseBase(this,yt)[yt]);N.EventEmitter.emit(P.HR_ENTITY_TOGGLE_ELEMENTS,{shouldShowElements:false});const i=Number(babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].dataset.id);N.EventEmitter.emit(P.HR_DRAG_ENTITY,{draggedId:i})}function Gt({pageX:t,pageY:e}){U.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,mt)[mt],"--hidden");U.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,_t)[_t].parentElement,"--disabled-transition");U.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,Rt)[Rt],["--inside","--no-permission"]);U.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,Rt)[Rt],"height",`${babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].offsetHeight}px`);babelHelpers.classPrivateFieldLooseBase(this,kt)[kt]();babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].prevX=babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].x;babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].prevY=babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].y;babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].x+=(t-babelHelpers.classPrivateFieldLooseBase(this,At)[At])/babelHelpers.classPrivateFieldLooseBase(this,Ct)[Ct];babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].y+=(e-babelHelpers.classPrivateFieldLooseBase(this,bt)[bt])/babelHelpers.classPrivateFieldLooseBase(this,Ct)[Ct];babelHelpers.classPrivateFieldLooseBase(this,At)[At]=t;babelHelpers.classPrivateFieldLooseBase(this,bt)[bt]=e;babelHelpers.classPrivateFieldLooseBase(this,ht)[ht].forEach((t=>babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt](t,0,0)));babelHelpers.classPrivateFieldLooseBase(this,ht)[ht]=[];const{directionX:s,directionY:n}=babelHelpers.classPrivateFieldLooseBase(this,Yt)[Yt]();babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].x=s===0?babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].x:babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].x+s*ut/babelHelpers.classPrivateFieldLooseBase(this,Ct)[Ct];babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].y=n===0?babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].y:babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].y+n*ut/babelHelpers.classPrivateFieldLooseBase(this,Ct)[Ct];babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt](babelHelpers.classPrivateFieldLooseBase(this,Tt)[Tt],babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].x,babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].y,4);babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt](babelHelpers.classPrivateFieldLooseBase(this,mt)[mt]);babelHelpers.classPrivateFieldLooseBase(this,Et)[Et]=babelHelpers.classPrivateFieldLooseBase(this,Ft)[Ft]();if(!babelHelpers.classPrivateFieldLooseBase(this,Et)[Et].insertion){return}const{insertion:i,targetItem:o,hasPermission:r}=babelHelpers.classPrivateFieldLooseBase(this,Et)[Et];if(!r){U.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,Rt)[Rt],"--no-permission")}babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt](o);switch(i){case"reorder":{const t=babelHelpers.classPrivateFieldLooseBase(this,wt)[wt](o);babelHelpers.classPrivateFieldLooseBase(this,ht)[ht]=t;break}case"sibling-left":case"sibling-right":{const t=babelHelpers.classPrivateFieldLooseBase(this,xt)[xt](o,i);babelHelpers.classPrivateFieldLooseBase(this,ht)[ht]=t;break}default:U.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,Rt)[Rt],"--inside");U.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,Rt)[Rt],"height",`${o.offsetHeight}px`)}}function jt(){babelHelpers.classPrivateFieldLooseBase(this,Vt)[Vt](true);U.Event.unbind(document,"mousemove",babelHelpers.classPrivateFieldLooseBase(this,Ut)[Ut]);U.Event.unbind(document,"mouseup",babelHelpers.classPrivateFieldLooseBase(this,Pt)[Pt]);U.Event.unbind(document,"mouseup",babelHelpers.classPrivateFieldLooseBase(this,yt)[yt]);babelHelpers.classPrivateFieldLooseBase(this,ht)[ht].forEach((t=>babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt](t,0,0)));U.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,_t)[_t],"--drag-progress");U.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].parentElement.parentElement,"--blur");U.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,mt)[mt],"--hidden");U.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,_t)[_t].parentElement,"--disabled-transition");U.Dom.remove(babelHelpers.classPrivateFieldLooseBase(this,Tt)[Tt]);U.Dom.remove(babelHelpers.classPrivateFieldLooseBase(this,Rt)[Rt]);babelHelpers.classPrivateFieldLooseBase(this,kt)[kt]();N.EventEmitter.emit(P.HR_ENTITY_TOGGLE_ELEMENTS,{shouldShowElements:true});const{insertion:t,targetItem:e,hasPermission:s}=babelHelpers.classPrivateFieldLooseBase(this,Et)[Et];if(!t||!s){return}const n=[...babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].parentElement.children].indexOf(babelHelpers.classPrivateFieldLooseBase(this,mt)[mt]);const i=[...e.parentElement.children].indexOf(e);const o=Number(babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].dataset.id);N.EventEmitter.emit(P.HR_DROP_ENTITY,{draggedId:o,targetId:Number(e.dataset.id),targetIndex:i,affectedItems:babelHelpers.classPrivateFieldLooseBase(this,ht)[ht].map((t=>Number(t.dataset.id))),direction:n<i?1:-1,insertion:t})}function Wt({shiftKey:t}){if(t){const t=Number(babelHelpers.classPrivateFieldLooseBase(this,_t)[_t].dataset.x);const e=t-babelHelpers.classPrivateFieldLooseBase(this,vt)[vt].x;babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].x-=e/babelHelpers.classPrivateFieldLooseBase(this,Ct)[Ct];babelHelpers.classPrivateFieldLooseBase(this,vt)[vt].x=t}else{const t=Number(babelHelpers.classPrivateFieldLooseBase(this,_t)[_t].dataset.y);const e=t-babelHelpers.classPrivateFieldLooseBase(this,vt)[vt].y;babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].y-=e/babelHelpers.classPrivateFieldLooseBase(this,Ct)[Ct];babelHelpers.classPrivateFieldLooseBase(this,vt)[vt].y=t}babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt](babelHelpers.classPrivateFieldLooseBase(this,Tt)[Tt],babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].x,babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].y,4)}function Xt(){const t=babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].cloneNode(true);U.Dom.addClass(t,"humanresources-tree__dnd-ghost");U.Dom.removeClass(t,["--expanded","--focused"]);const{x:e,y:s}=babelHelpers.classPrivateFieldLooseBase(this,_t)[_t].getBoundingClientRect();const{x:n,y:i}=babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].getBoundingClientRect();const o=n-e;const r=i-s;U.Dom.style(t,"left",`${o/babelHelpers.classPrivateFieldLooseBase(this,Ct)[Ct]}px`);U.Dom.style(t,"top",`${r/babelHelpers.classPrivateFieldLooseBase(this,Ct)[Ct]}px`);U.Dom.append(t,babelHelpers.classPrivateFieldLooseBase(this,_t)[_t]);return t}function Kt(){const{offsetWidth:t,offsetHeight:e}=babelHelpers.classPrivateFieldLooseBase(this,mt)[mt];const s=U.Dom.hasClass(babelHelpers.classPrivateFieldLooseBase(this,mt)[mt],"--team")?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DRAG_TEAM_LABEL"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_DRAG_DEPARTMENT_LABEL");const n=U.Tag.render(dt||(dt=lt`
			<div
				class="humanresources-tree__position-pointer"
				style="width: ${0}px; height: ${0}px;);"
			>
				<div>
					<div class="ui-icon-set --circle-plus"></div>
					<span>${0}</span>
				</div>
				<div>
					<div class="ui-icon-set --cross-circle-50"></div>
					<span>
						${0}
					</span>
				</div>
			</div>
		`),t,e,s,U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_NO_DRAG_PERMISSION"));U.Dom.append(n,babelHelpers.classPrivateFieldLooseBase(this,_t)[_t]);babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt](babelHelpers.classPrivateFieldLooseBase(this,mt)[mt]);return n}function Zt(t,e,s,n=0){if(e===0&&s===0){U.Dom.style(t,"transform","");return}U.Dom.style(t,"transform",`translate3d(${e}px, ${s}px, 0) rotate(${n}deg)`)}function qt(t){const{x:e,y:s}=babelHelpers.classPrivateFieldLooseBase(this,_t)[_t].getBoundingClientRect();const{x:n,y:i}=t.getBoundingClientRect();const o=(n-e)/babelHelpers.classPrivateFieldLooseBase(this,Ct)[Ct];const r=(i-s)/babelHelpers.classPrivateFieldLooseBase(this,Ct)[Ct];babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt](babelHelpers.classPrivateFieldLooseBase(this,Rt)[Rt],o,r)}function Qt(){U.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,Tt)[Tt],"--disabled-events");babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt](babelHelpers.classPrivateFieldLooseBase(this,Tt)[Tt],babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].x,babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].y);const t=.7;const e=.6;const{x:s,y:n,width:i,height:o}=babelHelpers.classPrivateFieldLooseBase(this,Tt)[Tt].getBoundingClientRect();babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt](babelHelpers.classPrivateFieldLooseBase(this,Tt)[Tt],babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].x,babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].y,4);const r=[{x:s,y:n},{x:s+i,y:n},{x:s,y:n+o},{x:s+i,y:n+o},{x:s,y:n+o/2},{x:s+i,y:n+o/2}];const a=r.reduce(((r,a,l)=>{if(r.insertion){return r}const d=document.elementFromPoint(a.x,a.y);const c=d==null?void 0:d.closest(".humanresources-tree__node_summary");const u=c==null?void 0:c.parentElement;if(!u||u===babelHelpers.classPrivateFieldLooseBase(this,mt)[mt]){return r}const{x:h,y:E,width:p,height:_}=u.getBoundingClientRect();const m=babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].parentElement===u.parentElement;const T=babelHelpers.classPrivateFieldLooseBase(this,Mt)[Mt].canSortEntitiesByParentId(Number(u.parentElement.parentElement.dataset.id));const R=l===0&&!U.Dom.hasClass(u,"--root")&&T;r.targetItem=u;if(m&&s+t*i<h+p&&R){return{...r,insertion:"reorder"}}if(!m&&n+e*o<E+_&&R){return{...r,insertion:s<h+p/2?"sibling-left":"sibling-right"}}const C=U.Dom.hasClass(u,"--team")&&!U.Dom.hasClass(babelHelpers.classPrivateFieldLooseBase(this,mt)[mt],"--team");const v=babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].parentElement.parentElement===u;if(C||v){if(C){U.Dom.addClass(u,"--blur");babelHelpers.classPrivateFieldLooseBase(this,St)[St].push(u)}return r}return{...r,insertion:"inside",hasPermission:babelHelpers.classPrivateFieldLooseBase(this,Mt)[Mt].canBeParentForEntity(Number(u.dataset.id),babelHelpers.classPrivateFieldLooseBase(this,Nt)[Nt])}}),{hasPermission:true});U.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,Tt)[Tt],"--disabled-events");return a}function Jt(t){const e=[...babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].parentElement.children];const s=e.indexOf(babelHelpers.classPrivateFieldLooseBase(this,mt)[mt]);const n=[...t.parentElement.children].indexOf(t);const i=s<n?1:-1;const o=i>0?e.slice(s+1,n+1):e.slice(n,s);o.forEach((t=>babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt](t,-i*ct,0)));return o}function te(t,e){const s=[...t.parentElement.children];const n=s.indexOf(t);let i=[];if(e==="sibling-right"){i=s.slice(0,n+1);i.forEach((t=>babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt](t,-ct,0)))}else{i=s.slice(n);i.forEach((t=>babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt](t,ct,0)))}return i}function ee(){let t=0;let e=0;const{left:s,top:n}=babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].getBoundingClientRect();const i=s/babelHelpers.classPrivateFieldLooseBase(this,Ct)[Ct];const o=n/babelHelpers.classPrivateFieldLooseBase(this,Ct)[Ct];if(i+babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].x<0){t=babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].x<babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].prevX?-1:0}if(i+babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].x+babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].offsetWidth>document.body.offsetWidth/babelHelpers.classPrivateFieldLooseBase(this,Ct)[Ct]){t=babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].x>babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].prevX?1:0}if(o+babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].y<0){e=babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].y<babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].prevY?-1:0}if(o+babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].y+babelHelpers.classPrivateFieldLooseBase(this,mt)[mt].offsetHeight>document.body.offsetHeight/babelHelpers.classPrivateFieldLooseBase(this,Ct)[Ct]){e=babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].y>babelHelpers.classPrivateFieldLooseBase(this,pt)[pt].prevY?1:0}if(t!==0||e!==0){N.EventEmitter.emit(P.HR_ORG_CHART_TRANSFORM_CANVAS,{directionX:t,directionY:e,speed:ut})}return{directionX:t,directionY:e}}function se(t){U.Dom.style(document.body,"userSelect","none");U.Dom.style(document.body,"-webkit-user-select","none");U.Dom.style(document.body,"cursor","grabbing");if(t){U.Dom.style(document.body,"userSelect","");U.Dom.style(document.body,"-webkit-user-select","");U.Dom.style(document.body,"cursor","")}}function ne(){babelHelpers.classPrivateFieldLooseBase(this,St)[St].forEach((t=>U.Dom.removeClass(t,"--blur")))}const ie={mounted(t){new $t(t)},updated(t,{value:e}){const{x:s,y:n,zoom:i}=e;t.setAttribute("data-zoom",i);t.setAttribute("data-x",s);t.setAttribute("data-y",n)}};const oe={name:"companyTree",components:{TreeNode:rt,Connectors:at,MoveEmployeeConfirmationPopup:h.MoveEmployeeConfirmationPopup,ConfirmationPopup:h.ConfirmationPopup},directives:{dnd:ie},provide(){return{getTreeBounds:()=>this.getTreeBounds()}},props:{canvasTransform:{type:Object,required:true}},emits:["moveTo","showWizard","controlDetail"],data(){return{expandedNodes:[],isLocatedDepartmentVisible:false,isLoaded:false,userDropTargetNodeId:null,isUserDropAllowed:false,draggedUserData:null,showDndConfirmationPopup:false,showDndErrorPopup:false,dndErrorPopupDescription:"",dndUserMoveContext:null,isCombineOnly:false}},computed:{dndTargetEntityType(){return this.targetDepartment.entityType||""},dndSourceEntityType(){var t;return((t=this.departments.get(this.focusedNode))==null?void 0:t.entityType)||""},rootId(){const{id:t}=[...this.departments.values()].find((t=>t.parentId===0));return t},connectors(){return this.$refs.connectors},targetDepartment(){var t;if(!((t=this.dndUserMoveContext)!=null&&t.targetDepartmentId)){return null}return this.departments.get(this.dndUserMoveContext.targetDepartmentId)},isTeamTarget(){var t;return((t=this.targetDepartment)==null?void 0:t.entityType)===b.EntityTypes.team},dndPopupDescription(){const t=this.isTeamTarget?"HUMANRESOURCES_COMPANY_STRUCTURE_DND_USER_CONFIRM_POPUP_DESC_ROLE_TEAM":"HUMANRESOURCES_COMPANY_STRUCTURE_DND_USER_CONFIRM_POPUP_DESC_ROLE_DEPARTMENT";return U.Loc.getMessage(t,{"#USER_NAME#":U.Text.encode(this.dndUserMoveContext.user.name),"#DEPARTMENT_NAME#":U.Text.encode(this.targetDepartment.name),"[link]":`<a class="hr-department-detail-content__move-user-department-user-link" href="${this.dndUserMoveContext.user.url}">`,"[/link]":"</a>"})},...d.mapState(R.useChartStore,["currentDepartments","userId","focusedNode","departments"])},created(){this.treeNodes=new Map;this.subscribeOnEvents();this.loadHeads([this.rootId])},mounted(){const t=this.getDepartmentIdForInitialFocus();this.currentDepartmentsLocated=[t];if(t!==this.rootId){this.expandDepartmentParents(t);this.focus(t,{expandAfterFocus:true});return}this.expandLowerDepartments();this.focus(t)},beforeUnmount(){this.unsubscribeFromEvents()},methods:{getDepartmentIdForInitialFocus(){const t=k.getParams().focusNodeId;if(t){const e=this.departments.get(t);if(e){return t}}for(const t of this.currentDepartments){const e=this.departments.get(t);if(e.entityType===b.EntityTypes.department){return t}}return this.rootId},loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},getTreeBounds(){return this.$el.getBoundingClientRect()},onConnectDepartment({data:t}){const{id:e,html:s}=t;this.treeNodes.set(e,s);const n=this.getDepartmentIdForInitialFocus();if(e===n&&!this.isLoaded){const t=1800;this.isLoaded=true;U.Runtime.debounce((()=>{this.moveTo(n)}),t)()}},onDisconnectDepartment({data:t}){const{id:e}=t;const s=this.departments.get(e);delete s.prevParentId;if(!s.parentId){O.removeDepartment(e)}},onDragEntity({data:t}){const{draggedId:e}=t;if(this.expandedNodes.includes(e)){this.collapseRecursively(e)}},onToggleConnectors({data:t}){const{shouldShowElements:e}=t;this.connectors.toggleAllConnectorsVisibility(e,this.expandedNodes)},async changeOrder(t){const{draggedId:e,targetId:s,affectedItems:n,direction:i}=t;const o=O.orderDepartments(e,s,i,n.length);const r=302;const a=n.length*i*r;this.connectors.adaptConnectorsAfterReorder([e],a,true);const l=-i*r;this.connectors.adaptConnectorsAfterReorder(n,l,true);const d=await o;if(!d){this.connectors.adaptConnectorsAfterReorder([e],-a,true);this.connectors.adaptConnectorsAfterReorder(n,-l,true)}},async updateParent(t){const{draggedId:e,targetId:s,targetIndex:n,insertion:i}=t;const{id:o,parentId:r}=this.departments.get(e);if(r===s&&i==="inside"){return}let a=null;const l=R.useChartStore();if(i==="sibling-left"||i==="sibling-right"){const{parentId:t}=this.departments.get(s);const r=i==="sibling-left"?n:n+1;l.updateDepartment({id:o,parentId:t},r);a=I.updateDepartment(e,t)}else{l.updateDepartment({id:o,parentId:s});a=I.updateDepartment(e,s)}this.locateToDepartment(e);try{await a;if(i==="sibling-left"||i==="sibling-right"){const{parentId:t}=this.departments.get(s);const{children:o}=this.departments.get(t);const r=i==="sibling-left"?1:2;const a=o.length-n-r;await I.changeOrder(e,-1,a)}}catch(t){console.error(t)}},onDropEntity({data:t}){const{insertion:e}=t;if(e==="reorder"){this.changeOrder(t);return}this.updateParent(t)},onPublicFocusNode({data:t}){const{nodeId:e}=t;const s=this.departments.get(e);if(!s){return}void this.locateToDepartment(e)},collapse(t){this.expandedNodes=this.expandedNodes.filter((e=>e!==t));this.connectors.toggleConnectorsVisibility(t,false);this.connectors.toggleConnectorHighlighting(t,false)},collapseRecursively(t){const e=t=>{var s;this.collapse(t);const n=this.departments.get(t);(s=n.children)==null?void 0:s.forEach((t=>{if(this.expandedNodes.includes(t)){e(t)}}))};const{parentId:s}=this.departments.get(t);const n=this.expandedNodes.find((t=>{const e=this.departments.get(t);return e.parentId===s}));if(n){e(n)}},expand(t,e={}){const{isManual:s=false}=e;this.collapseRecursively(t);this.expandedNodes=[...this.expandedNodes,t];this.connectors.toggleConnectorsVisibility(t,true);this.connectors.toggleConnectorHighlighting(t,true);const n=this.departments.get(t);const i=n.children.filter((t=>!this.departments.get(t).heads));if(i.length>0){this.loadHeads(i)}if(s){v.sendData({tool:"structure",category:"structure",event:"expand_department"})}},focus(t,e={}){var s;const{expandAfterFocus:n=false,showEmployees:i=false,subdivisionsSelected:o=false}=e;const r=((s=this.departments.get(t).children)==null?void 0:s.length)>0;let a=n||!this.expandedNodes.includes(t);if(i){a=this.expandedNodes.includes(t)}if(o||!r){this.collapseRecursively(t)}if(r&&a){this.expand(t,{isManual:true})}if(this.focusedNode&&!this.expandedNodes.includes(this.focusedNode)){this.connectors.toggleConnectorHighlighting(this.focusedNode,false)}O.focusDepartment(t);this.connectors.toggleConnectorHighlighting(this.focusedNode,true)},onFocusDepartment({data:t}){const{nodeId:e,showEmployees:s,subdivisionsSelected:n}=t;this.focus(e,{showEmployees:s,subdivisionsSelected:n});this.$emit("controlDetail",{showEmployees:s,preventSwitch:n})},tryRemoveDepartment(t,e){const s={team:{title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_TEAM_TITLE"),message:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_TEAM_MESSAGE"),success:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_TEAM_REMOVED"),error:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_TEAM_ERROR")},default:{title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_DEPARTMENT_TITLE"),message:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_DEPARTMENT_MESSAGE"),success:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_DEPARTMENT_REMOVED"),error:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_DEPARTMENT_ERROR")}};const n=e===b.EntityTypes.team?"team":"default";const i=r.MessageBox.create({title:s[n].title,message:s[n].message,buttons:r.MessageBoxButtons.OK_CANCEL,onOk:async e=>{try{await this.removeDepartment(t);a.UI.Notification.Center.notify({content:s[n].success,autoHideDelay:2e3});e.close()}catch{a.UI.Notification.Center.notify({content:s[n].error,autoHideDelay:2e3})}},onCancel:t=>t.close(),minWidth:250,maxWidth:320,minHeight:175,okCaption:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_DEPARTMENT_OK_CAPTION"),popupOptions:{className:"humanresources-tree__message-box",overlay:{opacity:40}}});const o=i.getOkButton();const l=i.getCancelButton();o.setRound(true);l.setRound(true);o.setColor(_.ButtonColor.DANGER);l.setColor(_.ButtonColor.LIGHT_BORDER);i.show()},async removeDepartment(t){const e=R.useChartStore();e.updateChatsInChildrenNodes(t);await I.removeDepartment(t);const s=this.departments.get(t);const{parentId:n,children:i=[]}=s;if(i.length>0){this.collapse(t)}O.moveSubordinatesToParent(t);await this.$nextTick();O.markDepartmentAsRemoved(t);this.focus(n,{expandAfterFocus:true});this.moveTo(n)},expandDepartmentParents(t){let{parentId:e}=this.departments.get(t);while(e){if(!this.expandedNodes.includes(e)){this.expand(e)}e=this.departments.get(e).parentId}},expandLowerDepartments(){let t=0;const e=n=>{var i;const{children:o=[]}=this.departments.get(n);if(t===4||o.length===0){return}this.expand(n);t+=1;const r=Math.trunc(o.length/2);const a=o[r];if(((i=this.departments.get(a).children)==null?void 0:i.length)>0){e(a);return}for(let t=r-1;t>=0;t--){if(s(o[t])){return}}for(let t=r+1;t<o.length;t++){if(s(o[t])){return}}};const s=t=>{const{children:s=[]}=this.departments.get(t);if(s.length>0){e(t);return true}return false};e(this.rootId)},async locateToCurrentDepartment(){if(this.currentDepartmentsLocated.length===this.currentDepartments.length){this.currentDepartmentsLocated=[]}const t=this.currentDepartments.find((t=>!this.currentDepartmentsLocated.includes(t)));if(!t){return}this.currentDepartmentsLocated.push(t);await this.locateToDepartment(t);O.searchUserInDepartment(this.userId)},async locateToDepartment(t){this.isLocatedDepartmentVisible=false;this.expandDepartmentParents(t);this.focus(t,{expandAfterFocus:true});await this.$nextTick();this.isLocatedDepartmentVisible=true;await this.moveTo(t)},async moveTo(t){await this.$nextTick();const e=this.getTreeBounds();const s=e.x+e.width/2;const n=e.y+e.height/2;const i=this.treeNodes.get(t);const o=i.getBoundingClientRect();this.$emit("moveTo",{x:s-o.x-o.width/2,y:n-o.y-o.height/2,nodeId:t})},loadHeads(t){const e=R.useChartStore();e.loadHeads(t)},subscribeOnEvents(){this.events={[P.HR_DEPARTMENT_CONNECT]:this.onConnectDepartment,[P.HR_DEPARTMENT_DISCONNECT]:this.onDisconnectDepartment,[P.HR_DEPARTMENT_FOCUS]:this.onFocusDepartment,[P.HR_DRAG_ENTITY]:this.onDragEntity,[P.HR_DROP_ENTITY]:this.onDropEntity,[P.HR_ENTITY_TOGGLE_ELEMENTS]:this.onToggleConnectors,[P.HR_PUBLIC_FOCUS_NODE]:this.onPublicFocusNode,[P.HR_USER_DRAG_START]:this.onUserDragStart,[P.HR_USER_DRAG_DROP]:this.onUserDragDrop,[P.HR_USER_DRAG_END]:this.onUserDragEnd,[P.HR_USER_DRAG_ENTER_NODE]:this.onUserDragEnterNode,[P.HR_USER_DRAG_LEAVE_NODE]:this.onUserDragLeaveNode};Object.entries(this.events).forEach((([t,e])=>{N.EventEmitter.subscribe(t,e)}))},unsubscribeFromEvents(){Object.entries(this.events).forEach((([t,e])=>{N.EventEmitter.unsubscribe(t,e)}))},onUserDragStart({data:t}){this.draggedUserData=t.user},onUserDragEnterNode({data:t}){if(!this.draggedUserData){return}const e=t.nodeId;const s=this.focusedNode;if(e===s){this.userDropTargetNodeId=e;this.isUserDropAllowed=false;return}this.userDropTargetNodeId=e;const n=this.canMoveUser(s,e);this.isUserDropAllowed=n.isAllowed;this.isCombineOnly=n.combineOnly},onUserDragLeaveNode({data:t}){if(!this.draggedUserData){return}if(this.userDropTargetNodeId===t.nodeId){this.userDropTargetNodeId=null;this.isUserDropAllowed=false}},async onUserDragDrop(){if(!this.userDropTargetNodeId||!this.isUserDropAllowed){return}this.dndUserMoveContext={user:this.draggedUserData,sourceDepartmentId:this.focusedNode,targetDepartmentId:this.userDropTargetNodeId,sourceRole:this.draggedUserData.role};this.showDndConfirmationPopup=true},async confirmUserMove(t){var e,s,n,i;this.showDndConfirmationPopup=false;const{user:o}=this.dndUserMoveContext;const r=((e=(s=this.targetDepartment)==null?void 0:s.heads)!=null?e:[]).find((t=>t.id===o.id))||((n=(i=this.targetDepartment)==null?void 0:i.employees)!=null?n:[]).find((t=>t.id===o.id));const l=Boolean(r);const d=l&&r.role===t.role;if(l&&d){this.displayDndErrorPopup(o);this.dndUserMoveContext=null;return}try{var c;if(t.isCombineMode){await this.handleCombineUser(this.dndUserMoveContext,t)}else{await this.handleMoveUser(this.dndUserMoveContext,t,l)}const e=this.isTeamTarget?"HUMANRESOURCES_COMPANY_STRUCTURE_DND_USER_MOVED_SUCCESS_TEAM":"HUMANRESOURCES_COMPANY_STRUCTURE_DND_USER_MOVED_SUCCESS_DEPARTMENT";a.UI.Notification.Center.notify({content:this.loc(e,{"#USER_NAME#":U.Text.encode(o.name),"#DEPARTMENT_NAME#":U.Text.encode((c=this.targetDepartment)==null?void 0:c.name),"#USER_ROLE#":U.Text.encode(t.roleLabel)})})}catch(t){console.error(t)}this.dndUserMoveContext=null},async handleCombineUser(t,e){var s;const{user:n,targetDepartmentId:i}=t;const o=await l.UserManagementDialogAPI.addUsersToDepartment(i,[n.id],e.role);R.UserService.addUsersToEntity(i,[{...n,role:e.role,badgeText:(s=e.badgeText)!=null?s:null}],o.userCount,e.role)},async handleMoveUser(t,e,s){var n;const{user:i,sourceDepartmentId:o,targetDepartmentId:r,sourceRole:a}=t;const d=this.departments.get(r);if(s){await l.UserManagementDialogAPI.addUsersToDepartment(r,[i.id],e.role);await w.removeUserFromDepartment(o,i.id)}else{await w.moveUserToDepartment(o,i.id,r,e.role)}const c=d.userCount+(s?0:1);R.UserService.removeUserFromEntity(o,i.id,a);R.UserService.addUsersToEntity(r,[{...i,role:e.role,badgeText:(n=e.badgeText)!=null?n:null}],c,e.role)},displayDndErrorPopup(t){var e;const s=this.isTeamTarget?"HUMANRESOURCES_COMPANY_STRUCTURE_DND_ERROR_POPUP_DESC_TEAM":"HUMANRESOURCES_COMPANY_STRUCTURE_DND_ERROR_POPUP_DESC_DEPARTMENT";this.dndErrorPopupDescription=U.Loc.getMessage(s,{"#USER_NAME#":U.Text.encode(t.name),"#DEPARTMENT_NAME#":U.Text.encode((e=this.targetDepartment)==null?void 0:e.name),"[link]":`<a class="hr-department-detail-content__move-user-department-user-link" href="${t.url}">`,"[/link]":"</a>"});this.showDndErrorPopup=true},cancelUserMove(){if(!this.dndUserMoveContext){return}this.showDndConfirmationPopup=false;this.dndUserMoveContext=null},closeDndErrorPopup(){this.showDndErrorPopup=false;this.dndErrorPopupDescription="";this.dndUserMoveContext=null},onUserDragEnd(){this.userDropTargetNodeId=null;this.isUserDropAllowed=false;this.draggedUserData=null},canMoveUser(t,e){const s=M.PermissionChecker.getInstance();const n=this.departments.get(t);const i=this.departments.get(e);if(!n||!i){return{isAllowed:false,combineOnly:false}}const o=n.entityType===b.EntityTypes.team&&i.entityType===b.EntityTypes.department;if(o){return{isAllowed:false,combineOnly:false}}const r=n.entityType===b.EntityTypes.team?M.PermissionActions.teamRemoveMember:M.PermissionActions.employeeRemoveFromDepartment;const a=s.hasPermission(r,t);const l=this.isTeamTarget?M.PermissionActions.teamAddMember:M.PermissionActions.employeeAddToDepartment;const d=s.hasPermission(l,e);if(!d){return{isAllowed:false,combineOnly:false}}const c=n.entityType===b.EntityTypes.department&&i.entityType===b.EntityTypes.team;if(c){return{isAllowed:true,combineOnly:true}}return{isAllowed:true,combineOnly:!a}}},template:`\n\t\t<div\n\t\t\tclass="humanresources-tree"\n\t\t\tv-if="departments.size > 0"\n\t\t\tv-dnd="canvasTransform"\n\t\t>\n\t\t\t<TreeNode\n\t\t\t\tclass="--root"\n\t\t\t\t:key="rootId"\n\t\t\t\t:nodeId="rootId"\n\t\t\t\t:expandedNodes="[...expandedNodes]"\n\t\t\t\t:canvasZoom="canvasTransform.zoom"\n\t\t\t\t:currentDepartments="currentDepartments"\n\t\t\t\t:userDropTargetNodeId="userDropTargetNodeId"\n\t\t\t\t:isUserDropAllowed="isUserDropAllowed"\n\t\t\t\t:isDraggingUser="!!draggedUserData"\n\t\t\t></TreeNode>\n\t\t\t<Connectors\n\t\t\t\tref="connectors"\n\t\t\t\t:isLocatedDepartmentVisible="isLocatedDepartmentVisible"\n\t\t\t\t:treeNodes="treeNodes"\n\t\t\t></Connectors>\n\t\t\t<MoveEmployeeConfirmationPopup\n\t\t\t\tv-if="showDndConfirmationPopup"\n\t\t\t\t:description="dndPopupDescription"\n\t\t\t\t:showRoleSelect="true"\n\t\t\t\t:showCombineCheckbox="true"\n\t\t\t\t:isCombineOnly="isCombineOnly"\n\t\t\t\t:targetType="dndTargetEntityType"\n\t\t\t\t:sourceType="dndSourceEntityType"\n\t\t\t\t@confirm="confirmUserMove"\n\t\t\t\t@close="cancelUserMove"\n\t\t\t/>\n\t\t\t<ConfirmationPopup\n\t\t\t\tv-if="showDndErrorPopup"\n\t\t\t\t:withoutTitleBar = true\n\t\t\t\t:onlyConfirmButtonMode = true\n\t\t\t\t:confirmBtnText = "loc('HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_CONTENT_USER_ACTION_MENU_MOVE_TO_ANOTHER_DEPARTMENT_ALREADY_BELONGS_TO_DEPARTMENT_CLOSE_BUTTON')"\n\t\t\t\t:width="300"\n\t\t\t\t@action="closeDndErrorPopup"\n\t\t\t\t@close="closeDndErrorPopup"\n\t\t\t>\n\t\t\t\t<template v-slot:content>\n\t\t\t\t\t<div class="hr-department-detail-content__user-action-text-container">\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tclass="hr-department-detail-content__user-belongs-to-department-text-container"\n\t\t\t\t\t\t\tv-html="dndErrorPopupDescription"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</template>\n\t\t\t</ConfirmationPopup>\n\t\t</div>\n\t`};const re={name:"transform-panel",props:{modelValue:{type:Object,required:true}},emits:["update:modelValue"],data(){return{selectedId:""}},computed:{zoomInPercent(){const t='<span class="humanresources-transform-panel__zoom_percent">%</span>';return`${(this.modelValue.zoom*100).toFixed(0)}${t}`}},created(){this.actions=Object.freeze({zoomIn:"zoomIn",zoomOut:"zoomOut",locate:"locate",navigate:"navigate"})},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},onZoom(t){const e=.2;const s=3;let n=-1;if(t){n=1;this.selectedId=this.actions.zoomIn}else{this.selectedId=this.actions.zoomOut}const i=Number((this.modelValue.zoom+e*n).toFixed(1));if(i<e||i>s){return}const o=this.$parent.$refs.tree.getTreeBounds();const r=o.width/2/this.modelValue.zoom-y/2;const a=o.height/2/this.modelValue.zoom;const l=(r-this.modelValue.x)/this.modelValue.zoom;const d=(a-this.modelValue.y)/this.modelValue.zoom;const c=r-l*i;const u=a-d*i;this.$emit("update:modelValue",{...this.modelValue,zoom:i,x:c,y:u})},onLocate(){N.EventEmitter.emit(P.HR_ORG_CHART_LOCATE_TO_DEPARTMENT);this.selectedId=this.actions.locate},onfocusout(){this.selectedId=""}},template:`\n\t\t<div class="humanresources-transform-panel" @focusout="onfocusout" tabindex="-1">\n\t\t\t<div\n\t\t\t\tclass="humanresources-transform-panel__locate"\n\t\t\t\t:class="{ '--selected': selectedId === actions.locate }"\n\t\t\t\t@click="onLocate"\n\t\t\t>\n\t\t\t\t{{loc('HUMANRESOURCES_COMPANY_STRUCTURE_TREE_LOCATE')}}\n\t\t\t</div>\n\t\t\t<div class="humanresources-transform-panel__separator"></div>\n\t\t\t<div class="humanresources-transform-panel__zoom">\n\t\t\t\t<svg\n\t\t\t\t\tviewBox="0 0 16 16"\n\t\t\t\t\tfill="none"\n\t\t\t\t\tclass="humanresources-transform-panel__icon --zoom-out"\n\t\t\t\t\t:class="{ '--selected': selectedId === actions.zoomOut }"\n\t\t\t\t\t@click="onZoom(false)"\n\t\t\t\t>\n\t\t\t\t\t<path fill-rule="evenodd" clip-rule="evenodd" d="M4 8.66671V7.33337H7.33333H8.66667H12V8.66671H8.66667H7.33333H4Z" fill="#6A737F"/>\n\t\t\t\t</svg>\n\t\t\t\t<span v-html="zoomInPercent"></span>\n\t\t\t\t<svg\n\t\t\t\t\tviewBox="0 0 16 16"\n\t\t\t\t\tfill="none"\n\t\t\t\t\tclass="humanresources-transform-panel__icon --zoom-in"\n\t\t\t\t\t:class="{ '--selected': selectedId === actions.zoomIn }"\n\t\t\t\t\t@click="onZoom(true)"\n\t\t\t\t>\n\t\t\t\t\t<path fill-rule="evenodd" clip-rule="evenodd" d="M7.83333 4H9.16667V7.33333H12.5V8.66667H9.16667V12H7.83333V8.66667H4.5V7.33333H7.83333V4Z" fill="#6A737F"/>\n\t\t\t\t</svg>\n\t\t\t</div>\n\t\t</div>\n\t`};const ae={name:"detailPanelCollapsedTitle",props:{title:{type:String,required:true},avatars:{type:Array,required:true}},computed:{maxVisibleAvatarsCount(){return 2},additionalCount(){return this.avatars.length>this.maxVisibleAvatarsCount?this.avatars.length-this.maxVisibleAvatarsCount:0}},template:`\n\t\t<div class="humanresources-detail-panel__collapsed-title">\n\t\t\t<template v-for="(avatar, index) in avatars">\n\t\t\t\t<img\n\t\t\t\t\tv-if="index < this.maxVisibleAvatarsCount"\n\t\t\t\t\t:key="index"\n\t\t\t\t\t:src="encodeURI(avatar)"\n\t\t\t\t\tclass="humanresources-detail-panel__collapsed-title-avatar"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t\t<div\n\t\t\t\tv-if="avatars.length > maxVisibleAvatarsCount"\n\t\t\t\tclass="humanresources-detail-panel__collapsed-title-avatar --additional"\n\t\t\t>\n\t\t\t +{{ additionalCount }}\n\t\t\t</div>\n\t\t\t<div class="humanresources-detail-panel__title">{{ title }}</div>\n\t\t</div>\n\t`};const le={name:"detailPanelEditButton",components:{BIcon:T.BIcon,RouteActionMenu:h.RouteActionMenu},props:{entityId:{type:Number,required:true},entityType:{type:String,default:b.EntityTypes.department}},data(){return{menuVisible:false}},computed:{set(){return T.Set},menu(){return new st(this.entityId,this.entityType,u.AnalyticsSourceType.NODE_DETAIL)}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},onActionMenuItemClick(t){this.menu.onActionMenuItemClick(t)}},template:`\n\t\t<div\n\t\t\tv-if="menu.items.length"\n\t\t\tclass="humanresources-detail-panel__edit-button"\n\t\t\t:class="{ '--focused': menuVisible }"\n\t\t\t:ref="'detailPanelEditButton'"\n\t\t\tdata-id="hr-department-detail-panel__edit-menu-button"\n\t\t\t@click.stop="menuVisible = true"\n\t\t>\n\t\t\t<BIcon\n\t\t\t\tclass="humanresources-detail-panel__edit-button-icon"\n\t\t\t\t:name="set.MORE"\n\t\t\t\t:size="20"\n\t\t\t/>\n\t\t</div>\n\t\t<RouteActionMenu\n\t\t\tv-if="menuVisible"\n\t\t\tid="department-detail-content-edit-menu"\n\t\t\t:items="menu.items"\n\t\t\t:width="302"\n\t\t\t:bindElement="$refs.detailPanelEditButton"\n\t\t\t@action="onActionMenuItemClick"\n\t\t\t@close="menuVisible = false"\n\t\t/>\n\t`};const de={name:"detailPanel",components:{DepartmentContent:c.DepartmentContent,DetailPanelCollapsedTitle:ae,DetailPanelEditButton:le},directives:{hint:h.Hint},props:{preventPanelSwitch:Boolean,modelValue:Boolean},emits:["showWizard","removeDepartment","update:modelValue"],data(){return{title:"",isTeamEntity:false,teamColor:null,isCollapsed:true,isHidden:false,isLoading:true,needToShowLoader:false}},computed:{...d.mapState(R.useChartStore,["focusedNode","departments"]),defaultAvatar(){return"/bitrix/js/humanresources/company-structure/org-chart/src/images/default-user.svg"},headAvatarsArray(){var t,e,s;const n=(t=this.departments.get(this.focusedNode).heads)!=null?t:[];return(e=n==null?void 0:(s=n.filter((t=>t.role===this.memberRoles.head)))==null?void 0:s.map((t=>t.avatar||this.defaultAvatar)))!=null?e:[]},entityType(){return this.departments.get(this.focusedNode).entityType},memberRoles(){return u.getMemberRoles(this.entityType)},isPanelCollapsed(){return this.isCollapsed||this.isHidden}},watch:{focusedNode(t,e){this.updateDetailPageHandler(t,e)},modelValue(t){this.isCollapsed=t},departments:{handler(t){const e=t.get(this.focusedNode);if(e){var s;this.title=(s=e.name)!=null?s:""}},deep:true}},created(){this.subscribeOnEvents()},beforeUnmount(){this.unsubscribeFromEvents()},methods:{toggleCollapse(){this.$emit("update:modelValue",!this.isCollapsed)},updateDetailPageHandler(t,e){var s,n;if(!this.preventPanelSwitch&&e!==0){this.$emit("update:modelValue",false)}this.isLoading=true;const i=this.departments.get(t);this.isTeamEntity=i.entityType===b.EntityTypes.team;this.title=(s=i.name)!=null?s:"";this.teamColor=(n=i.teamColor)!=null?n:null;this.isLoading=false},showLoader(){this.needToShowLoader=true},hideLoader(){this.needToShowLoader=false},subscribeOnEvents(){this.events={[P.HR_ENTITY_TOGGLE_ELEMENTS]:this.onToggleDetailPanel};Object.entries(this.events).forEach((([t,e])=>{N.EventEmitter.subscribe(t,e)}))},unsubscribeFromEvents(){Object.entries(this.events).forEach((([t,e])=>{N.EventEmitter.unsubscribe(t,e)}))},onToggleDetailPanel({data:t}){const{shouldShowElements:e}=t;this.isHidden=!e}},template:`\n\t\t<div\n\t\t\t:class="['humanresources-detail-panel', { '--collapsed': isPanelCollapsed }]"\n\t\t\tv-on="isPanelCollapsed ? { click: toggleCollapse } : {}"\n\t\t\tdata-id="hr-department-detail-panel__container"\n\t\t>\n\t\t\t<div\n\t\t\t\tv-if="!isLoading"\n\t\t\t\tclass="humanresources-detail-panel-container"\n\t\t\t\t:class="{ '--hide': needToShowLoader && !isPanelCollapsed }"\n\t\t\t>\n\t\t\t\t<div class="humanresources-detail-panel__head" \n\t\t\t\t\t :class="{ '--team': isTeamEntity, '--collapsed': isPanelCollapsed }"\n\t\t\t\t\t :style="{ '--team-head-background': teamColor?.treeHeadBackground }"\n\t\t\t\t>\n\t\t\t\t\t<span\n\t\t\t\t\t\tv-if="!isPanelCollapsed"\n\t\t\t\t\t\tv-hint\n\t\t\t\t\t\tclass="humanresources-detail-panel__title"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ title }}\n\t\t\t\t\t</span>\n\t\t\t\t\t<DetailPanelCollapsedTitle\n\t\t\t\t\t\tv-else\n\t\t\t\t\t\t:title="title"\n\t\t\t\t\t\t:avatars="headAvatarsArray"\n\t\t\t\t\t>\n\t\t\t\t\t</DetailPanelCollapsedTitle>\n\t\t\t\t\t<div class="humanresources-detail-panel__header_buttons_container">\n\t\t\t\t\t\t<DetailPanelEditButton\n\t\t\t\t\t\t\tv-if="!isPanelCollapsed"\n\t\t\t\t\t\t\t:entityId="focusedNode"\n\t\t\t\t\t\t\t:entityType="entityType"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tclass="humanresources-detail-panel__collapse_button --icon"\n\t\t\t\t\t\t\t@click="toggleCollapse"\n\t\t\t\t\t\t\t:class="{ '--collapsed': isPanelCollapsed }"\n\t\t\t\t\t\t\tdata-id="hr-department-detail-panel__collapse-button"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="humanresources-detail-panel__content" v-show="!isPanelCollapsed">\n\t\t\t\t\t<DepartmentContent\n\t\t\t\t\t\t@showDetailLoader="showLoader"\n\t\t\t\t\t\t@hideDetailLoader="hideLoader"\n\t\t\t\t\t\t:isCollapsed="isPanelCollapsed"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div v-if="needToShowLoader && !isPanelCollapsed" class="humanresources-detail-panel-loader-container"/>\n\t\t</div>\n\t`};const ce={name:"FirstPopup",components:{BIcon:T.BIcon},data(){return{show:false,title:"",description:"",subDescription:"",features:[]}},computed:{set(){return T.Set}},async mounted(){this.title=this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_TITLE");this.description=this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_DESCRIPTION");this.subDescription=this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_SUB_DESCRIPTION");this.features=[this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_FEATURE_1"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_FEATURE_2"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_FEATURE_3"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_FEATURE_4"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_FEATURE_5"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_FEATURE_6"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_FEATURE_7")];const{firstTimeOpened:t}=await I.getDictionary();this.show=t==="N"&&this.title.length>0},methods:{closePopup(){I.firstTimeOpened();this.show=false;top.BX.Event.EventEmitter.emit(P.HR_FIRST_POPUP_SHOW)},loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)}},template:`\n\t\t<div v-if="show" class="first-popup">\n\t\t\t<div class="first-popup-overlay" @click="closePopup"></div>\n\t\t\t<div class="first-popup-content">\n\t\t\t\t<div class="title">{{ title }}</div>\n\t\t\t\t<div class="first-popup-left">\n\t\t\t\t\t<p class="description">{{ description }}</p>\n\t\t\t\t\t<p class="sub-description">{{ subDescription }}</p>\n\t\t\t\t\t<div class="first-popup-list">\n\t\t\t\t\t\t<div class="first-popup-list-item" v-for="(feature, index) in features" :key="index">\n\t\t\t\t\t\t\t<div class="first-popup-list-item-point">\u2022</div>\n\t\t\t\t\t\t\t<div class="first-popup-list-item-feature">{{ feature }}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<button class="ui-btn ui-btn-success first-popup-ui-btn" @click="closePopup">\n\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_BUTTON_START') }}\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t\t<div class="first-popup-right">\n\t\t\t\t\t<video\n\t\t\t\t\t\tsrc="/bitrix/js/humanresources/company-structure/org-chart/src/components/first-popup/images/preview.webm"\n\t\t\t\t\t\tautoplay\n\t\t\t\t\t\tloop\n\t\t\t\t\t\tmuted\n\t\t\t\t\t\tplaysinline\n\t\t\t\t\t\tclass="first-popup-animation"\n\t\t\t\t\t></video>\n\t\t\t\t</div>\n\t\t\t\t<BIcon :name="set.CROSS_25" :size="24" class="first-popup-close" @click="closePopup"></BIcon>\n\t\t\t</div>\n\t\t</div>\n\t`};const ue={components:{TransformCanvas:n.TransformCanvas,Tree:oe,TransformPanel:re,ChartWizard:C.ChartWizard,FirstPopup:ce,DetailPanel:de,TitlePanel:F},data(){return{canvas:{shown:false,moved:false,modelTransform:{x:0,y:0,zoom:.3}},wizard:{shown:false,isEditMode:false,showEntitySelector:true,entity:"",nodeId:0,source:""},detailPanel:{collapsed:true,preventSwitch:false},isTransitionCompleted:false,analyticsQueue:[],isAnalyticsBusy:false}},computed:{rootId(){const{id:t}=[...this.departments.values()].find((t=>t.parentId===0));return t},...d.mapState(R.useChartStore,["departments","currentDepartments"])},async created(){var t;const e=BX.SidePanel.Instance.getTopSlider();e==null?void 0:e.showLoader();const[s,n,i]=await Promise.all([I.getDepartmentsData(),I.getCurrentDepartments(),I.getUserId()]);e==null?void 0:e.closeLoader();const o=s.structure;const r=Object.entries(s.map).reduce(((t,[e,s])=>{t.set(Number(e),{id:Number(e),...s});return t}),new Map);const a=(t=s.multipleMembers)!=null?t:[];const l=I.createTreeDataStore(o);const d=n.filter((t=>l.has(t)));O.applyData(l,d,i,r,a);this.rootOffset=100;this.transformCanvas();this.canvas.shown=true;this.showConfetti=false;N.EventEmitter.subscribe(P.HR_DEPARTMENT_SLIDER_ON_MESSAGE,this.handleInviteSliderMessage);BX.PULL.subscribe({type:BX.PullClient.SubscriptionType.Server,moduleId:"humanresources",command:"linkChatsToNodes",callback:t=>this.clearChatLists(t)});N.EventEmitter.subscribe(P.HR_ENTITY_SHOW_WIZARD,this.showWizardEventHandler);N.EventEmitter.subscribe(P.HR_ENTITY_REMOVE,this.removeDepartmentEventHandler);N.EventEmitter.subscribe(P.HR_ORG_CHART_TRANSFORM_CANVAS,this.onCanvasTransformWhenDragging);N.EventEmitter.subscribe(P.HR_ORG_CHART_LOCATE_TO_DEPARTMENT,this.onLocate);this.handleAnalyticsAjaxSuccess=this.handleAnalyticsAjaxSuccess.bind(this);U.addCustomEvent("OnAjaxSuccess",this.handleAnalyticsAjaxSuccess)},unmounted(){N.EventEmitter.unsubscribe(P.HR_DEPARTMENT_SLIDER_ON_MESSAGE,this.handleInviteSliderMessage);N.EventEmitter.unsubscribe(P.HR_ENTITY_SHOW_WIZARD,this.showWizardEventHandler);N.EventEmitter.unsubscribe(P.HR_ENTITY_REMOVE,this.removeDepartmentEventHandler);N.EventEmitter.unsubscribe(P.HR_ORG_CHART_TRANSFORM_CANVAS,this.onCanvasTransformWhenDragging);N.EventEmitter.unsubscribe(P.HR_ORG_CHART_LOCATE_TO_DEPARTMENT,this.onLocate);U.removeCustomEvent("OnAjaxSuccess",this.handleAnalyticsAjaxSuccess)},methods:{onMoveTo({x:t,y:e,nodeId:s}){const{x:n,y:i,zoom:o}=this.canvas.modelTransform;const r=y*o;const a=t-r/2;const l=s===this.rootId?this.rootOffset:e/o;const d=Math.round(a)===Math.round(n)&&Math.round(e)===Math.round(i);this.detailPanel={...this.detailPanel,collapsed:false};if(d){return}this.canvas={...this.canvas,moved:true,modelTransform:{...this.canvas.modelTransform,x:a/o,y:l,zoom:1}};this.onUpdateTransform()},onLocate({data:t}){if(t.nodeId){this.$refs.tree.locateToDepartment(t.nodeId);return}this.$refs.tree.locateToCurrentDepartment()},showWizardEventHandler({data:t}){this.onShowWizard(t)},sendAnalyticsSequentially(t){this.analyticsQueue.push(t);this.processAnalyticsQueue()},processAnalyticsQueue(){if(this.isAnalyticsBusy||this.analyticsQueue.length===0){return}this.isAnalyticsBusy=true;const t=this.analyticsQueue[0];v.sendData(t)},handleAnalyticsAjaxSuccess(){if(!this.isAnalyticsBusy){return}this.analyticsQueue.shift();this.isAnalyticsBusy=false;this.processAnalyticsQueue()},onShowWizard({nodeId:t=0,isEditMode:e=false,type:s,showEntitySelector:n=true,source:i="",entityType:o,refToFocus:r}={}){let a=null;if(o===b.EntityTypes.team){a="team"}else if(o===b.EntityTypes.department||o===b.EntityTypes.company){a="dept"}this.wizard={...this.wizard,shown:true,isEditMode:e,showEntitySelector:n,entity:s,nodeId:t,source:i,entityType:o,refToFocus:r};if(!e&&i!==u.AnalyticsSourceType.HEADER){this.sendAnalyticsSequentially({tool:"structure",category:"structure",event:"create_wizard",type:a,c_element:i});if(o===b.EntityTypes.team){this.sendAnalyticsSequentially({tool:"structure",category:"structure",event:"create_team_step1",type:a,c_element:i})}}if(e){v.sendData({tool:"structure",category:"structure",event:`edit_${a}`,c_element:i})}switch(s){case"department":v.sendData({tool:"structure",category:"structure",event:`create_${a}_step1`,type:a,c_element:i});break;case"employees":v.sendData({tool:"structure",category:"structure",event:`create_${a}_step2`,type:a,c_element:i});break;case"bindChat":v.sendData({tool:"structure",category:"structure",event:`create_${a}_step3`,type:a,c_element:i});break;case"teamRights":v.sendData({tool:"structure",category:"structure",event:`create_${a}_step4`,type:a,c_element:i});break}},onModifyTree({id:t,showConfetti:e}){this.showConfetti=e!=null?e:false;const{tree:s}=this.$refs;s.locateToDepartment(t)},onWizardClose(){this.wizard.shown=false},removeDepartmentEventHandler({data:t}){this.onRemoveDepartment(t.nodeId,t.entityType)},onRemoveDepartment(t,e){const{tree:s}=this.$refs;s.tryRemoveDepartment(t,e)},async onTransitionEnd(){if(this.canvas.moved){this.isTransitionCompleted=true}this.canvas.moved=false;if(!this.showConfetti){return}this.isTransitionCompleted=false;const t=s.Confetti.fire({particleCount:300,startVelocity:10,spread:400,ticks:100,origin:{y:.4,x:.37}});this.showConfetti=false;await t;this.isTransitionCompleted=true},onControlDetail({showEmployees:t,preventSwitch:e}){this.detailPanel={...this.detailPanel,preventSwitch:e};if(!t){return}this.detailPanel={...this.detailPanel,collapsed:false}},transformCanvas(){const{zoom:t}=this.canvas.modelTransform;const{offsetWidth:e,offsetHeight:s}=this.$el;const[n]=this.currentDepartments;const i=n===this.rootId?this.rootOffset:s/2-s*t/2;this.canvas.modelTransform={...this.canvas.modelTransform,x:e/2-e*t/2,y:i}},onUpdateTransform(){N.EventEmitter.emit(P.INTRANET_USER_MINIPROFILE_CLOSE);N.EventEmitter.emit(P.HR_DEPARTMENT_MENU_CLOSE)},handleInviteSliderMessage(t){const[e]=t.getData();const s=e.getEventId();if(s!=="BX.Intranet.Invitation:onAdd"){return}const{users:n}=e.getData();n.forEach((t=>{const e=b.getInvitedUserData(t);O.inviteUser(e)}))},clearChatLists(t){const e=Object.keys(t).map((t=>Number(t)));O.clearNodesChatLists(e)},onKeyDown(t){if(!this.isTransitionCompleted){t.preventDefault()}},onCanvasTransformWhenDragging({data:t}){const{directionX:e,directionY:s,speed:n}=t;if(e!==0){this.canvas.modelTransform.x+=-e*n}if(s!==0){this.canvas.modelTransform.y+=-s*n}}},template:`\n\t\t<div\n\t\t\tclass="humanresources-chart"\n\t\t\t:class="{ '--locked': !isTransitionCompleted }"\n\t\t\t@keydown="onKeyDown"\n\t\t>\n\t\t\t<TitlePanel @showWizard="onShowWizard"></TitlePanel>\n\t\t\t<TransformCanvas\n\t\t\t\tv-if="canvas.shown"\n\t\t\t\tv-slot="{transform}"\n\t\t\t\tv-model="canvas.modelTransform"\n\t\t\t\t@update:modelValue="onUpdateTransform"\n\t\t\t\t:class="{ '--moved': canvas.moved }"\n\t\t\t\t@transitionend="onTransitionEnd"\n\t\t\t>\n\t\t\t\t<Tree\n\t\t\t\t\t:canvasTransform="transform"\n\t\t\t\t\tref="tree"\n\t\t\t\t\t@moveTo="onMoveTo"\n\t\t\t\t\t@showWizard="onShowWizard"\n\t\t\t\t\t@controlDetail="onControlDetail"\n\t\t\t\t></Tree>\n\t\t\t</TransformCanvas>\n\t\t\t<DetailPanel\n\t\t\t\t@showWizard="onShowWizard"\n\t\t\t\t@removeDepartment="onRemoveDepartment"\n\t\t\t\tv-model="detailPanel.collapsed"\n\t\t\t\t:preventPanelSwitch="detailPanel.preventSwitch"\n\t\t\t></DetailPanel>\n\t\t\t<TransformPanel\n\t\t\t\tv-model="canvas.modelTransform"\n\t\t\t></TransformPanel>\n\t\t\t<ChartWizard\n\t\t\t\tv-if="wizard.shown"\n\t\t\t\t:nodeId="wizard.nodeId"\n\t\t\t\t:isEditMode="wizard.isEditMode"\n\t\t\t\t:showEntitySelector="wizard.showEntitySelector"\n\t\t\t\t:entity="wizard.entity"\n\t\t\t\t:entityType="wizard.entityType"\n\t\t\t\t:source="wizard.source"\n\t\t\t\t:refToFocus="wizard.refToFocus"\n\t\t\t\t@modifyTree="onModifyTree"\n\t\t\t\t@close="onWizardClose"\n\t\t\t></ChartWizard>\n\t\t\t<FirstPopup></FirstPopup>\n\t\t\t<div class="humanresources-chart__back"></div>\n\t\t</div>\n\t`};class he extends j{constructor(t,e,s,n){super(t);this.analyticSource=e;this.role=s;this.entityType=n;this.items=this.getFilteredItems()}getItems(){return[new Q(this.entityType,this.role),new J(this.entityType,this.role)]}}class Ee extends j{constructor(t,e,s,n){super(t);this.entityType=n;this.analyticSource=e;this.role=s;this.items=this.getFilteredItems()}getItems(){if(this.entityType===b.EntityTypes.team){return[new Q(this.entityType,this.role)]}return[new tt,new et,new Q(this.entityType,this.role)]}}class pe extends W{constructor(t){super({id:X.fireUserFromCompany,title:t?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_USER_LIST_ACTION_MENU_DELETE_FROM_COMPANY_TITLE"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_USER_LIST_ACTION_MENU_FIRE_FROM_COMPANY_TITLE"),description:U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_USER_LIST_ACTION_MENU_FIRE_FROM_COMPANY_SUBTITLE_MSGVER_1"),bIcon:{name:S.Main.PERSONS_DENY,size:20,color:b.getColorCode("paletteRed40")},permissionAction:t?"":M.PermissionActions.employeeFire,dataTestId:"hr-department-detail-content__user-list_fire-user-from-department"})}hasPermission(t,e){return t.hasPermissionOfAction(this.permissionAction)}}class _e extends W{constructor(t){const e=t===b.EntityTypes.team?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_USER_LIST_ACTION_MENU_MOVE_TO_ANOTHER_TEAM_TITLE"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_USER_LIST_ACTION_MENU_MOVE_TO_ANOTHER_DEPARTMENT_TITLE");const s=t===b.EntityTypes.team?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_USER_LIST_ACTION_MENU_MOVE_TO_ANOTHER_TEAM_SUBTITLE"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_USER_LIST_ACTION_MENU_MOVE_TO_ANOTHER_DEPARTMENT_SUBTITLE");super({id:X.moveUserToAnotherDepartment,title:e,description:s,bIcon:{name:S.Main.PERSON_ARROW_LEFT_1,size:20,color:b.getColorCode("paletteBlue50")},permissionAction:null,dataTestId:"hr-department-detail-content__user-list_move-from-department"});this.entityType=t}hasPermission(t,e){const s=t.currentUserPermissions;const n=this.entityType===b.EntityTypes.team?M.PermissionActions.teamAddMember:M.PermissionActions.employeeAddToDepartment;const i=this.entityType===b.EntityTypes.team?M.PermissionActions.teamRemoveMember:M.PermissionActions.employeeRemoveFromDepartment;const o=this.entityType===b.EntityTypes.team?s.ACTION_TEAM_MEMBER_ADD:s.ACTION_EMPLOYEE_ADD_TO_DEPARTMENT;const r=this.entityType===b.EntityTypes.team?s.ACTION_TEAM_MEMBER_REMOVE:s.ACTION_EMPLOYEE_REMOVE_FROM_DEPARTMENT;const a=o<r?n:i;return t.hasPermission(a,e)}}class me extends W{constructor(t){const e=t===b.EntityTypes.team?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_USER_LIST_ACTION_MENU_REMOVE_FROM_TEAM_TITLE"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_USER_LIST_ACTION_MENU_REMOVE_FROM_DEPARTMENT_TITLE");const s=t===b.EntityTypes.team?U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_USER_LIST_ACTION_MENU_REMOVE_FROM_TEAM_SUBTITLE"):U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_USER_LIST_ACTION_MENU_REMOVE_FROM_DEPARTMENT_SUBTITLE");const n=t===b.EntityTypes.team?b.getColorCode("paletteRed40"):b.getColorCode("paletteBlue50");const i=t===b.EntityTypes.team?M.PermissionActions.teamRemoveMember:M.PermissionActions.employeeRemoveFromDepartment;super({id:X.removeUserFromDepartment,title:e,description:s,bIcon:{name:S.Main.TRASH_BIN,size:20,color:n},permissionAction:i,dataTestId:"hr-department-detail-content__user-list_remove-from-department"})}}class Te extends j{constructor(t,e,s){super(t);this.isUserInvited=s;this.entityType=e;this.items=this.getFilteredItems()}getItems(){if(this.entityType===b.EntityTypes.team){return[new _e(this.entityType),new me(this.entityType)]}return[new _e(this.entityType),new me(this.entityType),new pe(this.isUserInvited)]}}class Re extends W{constructor(t,e){const{title:s,description:n}=Re.Dictionary[e.type]||{};super({id:X.openChat,title:U.Loc.getMessage(s),description:U.Loc.getMessage(n),bIcon:{name:S.Main.EDIT_PENCIL,size:20,color:b.getColorCode("paletteBlue50")},permissionAction:null,dataTestId:"hr-department-detail-content__chat-list_open-chat"});this.entityType=t;this.chat=e}hasPermission(t,e){return this.chat.hasAccess}}Re.Dictionary=Object.freeze({[b.ChatTypes.chat]:{title:"HUMANRESOURCES_COMPANY_STRUCTURE_CHAT_LIST_ACTION_MENU_OPEN_CHAT_TITLE",description:"HUMANRESOURCES_COMPANY_STRUCTURE_CHAT_LIST_ACTION_MENU_OPEN_CHAT_DESCRIPTION"},[b.ChatTypes.channel]:{title:"HUMANRESOURCES_COMPANY_STRUCTURE_CHAT_LIST_ACTION_MENU_OPEN_CHANNEL_TITLE",description:"HUMANRESOURCES_COMPANY_STRUCTURE_CHAT_LIST_ACTION_MENU_OPEN_CHANNEL_DESCRIPTION"},[b.ChatTypes.collab]:{title:"HUMANRESOURCES_COMPANY_STRUCTURE_CHAT_LIST_ACTION_MENU_OPEN_COLLAB_TITLE",description:"HUMANRESOURCES_COMPANY_STRUCTURE_CHAT_LIST_ACTION_MENU_OPEN_COLLAB_DESCRIPTION"}});class Ce extends W{constructor(t,e){const{title:s,description:n,permissionAction:i}=Ce.Dictionary[t][e.type]||{};super({id:X.unbindChat,title:U.Loc.getMessage(s),description:U.Loc.getMessage(n),bIcon:{name:S.Main.TRASH_BIN,size:20,color:b.getColorCode("paletteRed40")},permissionAction:i,dataTestId:"hr-department-detail-content__chat-list_unbind-chat"});this.chat=e}hasPermission(t,e){return!this.chat.originalNodeId&&this.chat.hasAccess&&t.hasPermission(this.permissionAction,e)}}Ce.Dictionary=Object.freeze({[b.EntityTypes.team]:{[b.ChatTypes.chat]:{title:"HUMANRESOURCES_COMPANY_STRUCTURE_CHAT_LIST_ACTION_MENU_UNBIND_TEAM_CHAT_TITLE",description:"HUMANRESOURCES_COMPANY_STRUCTURE_CHAT_LIST_ACTION_MENU_UNBIND_TEAM_CHAT_DESCRIPTION",permissionAction:M.PermissionActions.teamChatEdit},[b.ChatTypes.channel]:{title:"HUMANRESOURCES_COMPANY_STRUCTURE_CHAT_LIST_ACTION_MENU_UNBIND_TEAM_CHANNEL_TITLE",description:"HUMANRESOURCES_COMPANY_STRUCTURE_CHAT_LIST_ACTION_MENU_UNBIND_TEAM_CHANNEL_DESCRIPTION",permissionAction:M.PermissionActions.teamChannelEdit},[b.ChatTypes.collab]:{title:"HUMANRESOURCES_COMPANY_STRUCTURE_CHAT_LIST_ACTION_MENU_UNBIND_TEAM_COLLAB_TITLE",description:"HUMANRESOURCES_COMPANY_STRUCTURE_CHAT_LIST_ACTION_MENU_UNBIND_TEAM_COLLAB_DESCRIPTION",permissionAction:M.PermissionActions.teamCollabEdit}},[b.EntityTypes.department]:{[b.ChatTypes.chat]:{title:"HUMANRESOURCES_COMPANY_STRUCTURE_CHAT_LIST_ACTION_MENU_UNBIND_DEPARTMENT_CHAT_TITLE",description:"HUMANRESOURCES_COMPANY_STRUCTURE_CHAT_LIST_ACTION_MENU_UNBIND_DEPARTMENT_CHAT_DESCRIPTION",permissionAction:M.PermissionActions.departmentChatEdit},[b.ChatTypes.channel]:{title:"HUMANRESOURCES_COMPANY_STRUCTURE_CHAT_LIST_ACTION_MENU_UNBIND_DEPARTMENT_CHANNEL_TITLE",description:"HUMANRESOURCES_COMPANY_STRUCTURE_CHAT_LIST_ACTION_MENU_UNBIND_DEPARTMENT_CHANNEL_DESCRIPTION",permissionAction:M.PermissionActions.departmentChannelEdit},[b.ChatTypes.collab]:{title:"HUMANRESOURCES_COMPANY_STRUCTURE_CHAT_LIST_ACTION_MENU_UNBIND_DEPARTMENT_COLLAB_TITLE",description:"HUMANRESOURCES_COMPANY_STRUCTURE_CHAT_LIST_ACTION_MENU_UNBIND_DEPARTMENT_COLLAB_DESCRIPTION",permissionAction:M.PermissionActions.departmentCollabEdit}}});class ve extends j{constructor(t,e,s){super(s);this.chat=e;this.entityType=t;this.items=this.getFilteredItems()}getItems(){return[new Re(this.entityType,this.chat),new Ce(this.entityType,this.chat)]}}let Ae=t=>t,be;var Se=babelHelpers.classPrivateFieldLooseKey("subscribeOnEvents");var Me=babelHelpers.classPrivateFieldLooseKey("getNotConvertedStateScreen");class Ne{static async mount(t){const e=document.getElementById(t);U.Dom.append(babelHelpers.classPrivateFieldLooseBase(this,Me)[Me](),e);babelHelpers.classPrivateFieldLooseBase(this,Se)[Se]();const s=3e4;this.updateConvertedStatusInterval=setInterval((async()=>{try{await I.getDictionary()}catch(t){if(t.code==="STRUCTURE_IS_NOT_CONVERTED"){return}if(t.code==="STRUCTURE_ACCESS_DENIED"){clearInterval(this.updateConvertedStatusInterval);window.location.reload()}throw t}clearInterval(this.updateConvertedStatusInterval);window.location.reload()}),s)}}function Ue(){const t=t=>{const[e]=t.data;e.denyAction()};const e=()=>{N.EventEmitter.unsubscribe(P.HR_ORG_CHART_CLOSE_BY_ESC,t);N.EventEmitter.unsubscribe(P.HR_ORG_CHART_CLOSE,e);clearInterval(this.updateConvertedStatusInterval)};N.EventEmitter.subscribe(P.HR_ORG_CHART_CLOSE_BY_ESC,t);N.EventEmitter.subscribe(P.HR_ORG_CHART_CLOSE,e)}function Pe(){return U.Tag.render(be||(be=Ae`
			<div class="humanresources-not-converted-state-screen">
				<div class="humanresources-not-converted-state-screen__icon"></div>
				<div class="humanresources-not-converted-state-screen__title">
					${0}
				</div>
				<div class="humanresources-not-converted-state-screen__description">
					${0}
				</div>
			</div>
		`),U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_NOT_CONVERTED_SCREEN_LOADING_TITLE"),U.Loc.getMessage("HUMANRESOURCES_COMPANY_STRUCTURE_NOT_CONVERTED_SCREEN_LOADING_DESCRIPTION"))}Object.defineProperty(Ne,Me,{value:Pe});Object.defineProperty(Ne,Se,{value:Ue});var ye=babelHelpers.classPrivateFieldLooseKey("subscribeOnEvents");class De{static async mount(t){const s=document.getElementById(t);const n=e.BitrixVue.createApp(ue);const i=d.createPinia();n.use(i);babelHelpers.classPrivateFieldLooseBase(De,ye)[ye](n);const o=BX.SidePanel.Instance.getTopSlider();if(o){o.showLoader()}U.Dom.addClass(s,"humanresources-chart__back");await M.PermissionChecker.init();if(o){o.closeLoader()}U.Dom.removeClass(s,"humanresources-chart__back");n.mount(s)}}function ge(t){const e=t=>{const[e]=t.data;e.denyAction()};const s=()=>{N.EventEmitter.unsubscribe(P.HR_ORG_CHART_CLOSE_BY_ESC,e);N.EventEmitter.unsubscribe(P.HR_ORG_CHART_CLOSE,s);t.unmount()};N.EventEmitter.subscribe(P.HR_ORG_CHART_CLOSE_BY_ESC,e);N.EventEmitter.subscribe(P.HR_ORG_CHART_CLOSE,s)}Object.defineProperty(De,ye,{value:ge});t.App=De;t.UsersTabActionMenu=he;t.EmptyUsersTabActionMenu=Ee;t.UserListActionMenu=Te;t.ChatListActionMenu=ve;t.MenuActions=X;t.NotConvertedState=Ne;t.events=P})(this.BX.Humanresources.CompanyStructure=this.BX.Humanresources.CompanyStructure||{},BX.Vue3,BX.UI,BX.UI,BX.Humanresources.CompanyStructure,BX.UI.EntitySelector,BX.UI.Dialogs,BX,BX.Humanresources.CompanyStructure,BX.Vue3.Pinia,BX.Humanresources.CompanyStructure,BX.Humanresources.CompanyStructure,BX.Humanresources.CompanyStructure,BX,BX,BX.UI,BX,BX.UI.IconSet,BX.Humanresources.CompanyStructure,BX.Humanresources.CompanyStructure,BX.UI.Analytics,BX,BX.Humanresources.CompanyStructure,BX.UI.IconSet,BX.Humanresources.CompanyStructure,BX.Event,BX);
//# sourceMappingURL=org-chart.bundle.map.js