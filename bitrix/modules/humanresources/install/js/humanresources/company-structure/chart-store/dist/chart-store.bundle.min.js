this.BX=this.BX||{};this.BX.Humanresources=this.BX.Humanresources||{};(function(e,t,s,r,n,a){"use strict";class i{async addUsersToEntity(e,t,n,a){var i,o;const u=r.useChartStore();const l=u.departments.get(e);if(!l){return}const c=s.getMemberRoles(l.entityType);const d=new Set(t.map((e=>e.id)));if(d.has(u.userId)){u.changeCurrentDepartment(0,l.id)}const p=((i=l.heads)!=null?i:[]).filter((e=>!d.has(e.id)));const m=((o=l.employees)!=null?o:[]).filter((e=>!d.has(e.id)));(a===c.employee?m:p).push(...t);l.heads=p;l.employees=m;l.userCount=n;await this.refreshMultipleUsers()}removeUserFromEntity(e,t,a){const i=r.useChartStore();const o=i.departments.get(e);if(!o){return}const u=s.getMemberRoles(o.entityType);if(t===i.userId){i.changeCurrentDepartment(e)}o.userCount-=1;if(a===u.employee){o.employees=o.employees.filter((e=>e.id!==t))}else{o.heads=o.heads.filter((e=>e.id!==t))}const l=String(t);const c=i.multipleUsers[l];if(n.Type.isArray(c)){const t=c.filter((t=>Number(t)!==Number(e)));if(t.length>=2){i.multipleUsers[l]=t}else{delete i.multipleUsers[l]}}}moveUserToEntity(e,t,i,o){var u;const l=r.useChartStore();const c=l.departments.get(e);const d=l.departments.get(i);if(!c||!d){return}const p=s.getMemberRoles(c.entityType);const m=s.getMemberRoles(d.entityType);const h=o===p.employee?(u=c.employees)==null?void 0:u.find((e=>e.id===t)):c.heads.find((e=>e.id===t));if(!h){return}c.userCount-=1;if(o===p.employee){c.employees=c.employees.filter((e=>e.id!==t))}else{c.heads=c.heads.filter((e=>e.id!==t))}d.userCount+=1;if(t===l.userId){l.changeCurrentDepartment(e,i)}h.role=m.employee;if(!d.employees){return}d.employees.push(h);if(c.entityType===a.EntityTypes.department){const s=String(t);const r=l.multipleUsers[s];if(n.Type.isArray(r)){const t=new Set(r.map((e=>Number(e))));t.delete(Number(e));t.add(Number(i));l.multipleUsers[s]=[...t]}}}async moveUsersToEntity(e,t,s,n){var a;const i=r.useChartStore();const o=i.departments.get(e);if(!o){return}const u=new Set(t.map((e=>e.id)));const l=((a=o.employees)!=null?a:[]).filter((e=>!u.has(e.id)));const c=new Set(o.heads.map((e=>e.id)));const d=t.filter((e=>!c.has(e.id)));l.push(...d);o.employees=l;o.userCount=s;t.forEach((({id:e})=>{const t=String(e);if(Object.prototype.hasOwnProperty.call(i.multipleUsers,t)){delete i.multipleUsers[t]}}));if(n.length>0){void i.refreshDepartments(n)}}async removeUserFromAllEntities(e){const t=r.useChartStore();const s=t.departments;const a=[];for(const[t,r]of s){if("heads"in r&&n.Type.isArray(r.heads)&&r.heads.some((t=>t.id===e))||"employees"in r&&n.Type.isArray(r.employees)&&r.employees.some((t=>t.id===e))){a.push(t)}}delete t.multipleUsers[String(e)];return t.refreshDepartments(a)}async refreshMultipleUsers(){const e=r.useChartStore();e.multipleUsers=await s.getData("humanresources.api.Structure.Node.Member.getMultipleUsersMap")}}const o=new i;const u=t.defineStore("hr-org-chart",{state:()=>({departments:new Map,currentDepartments:[],focusedNode:0,searchedUserId:0,userId:0,structureMap:new Map,multipleUsers:[]}),actions:{async refreshDepartments(e){if(e.length===0){return}const[t,r]=await Promise.all([s.getData("humanresources.api.Structure.Node.getByIds",{nodeIds:e}),s.getData("humanresources.api.Structure.Node.current")]);this.currentDepartments=r;Object.keys(t).forEach((e=>{const s=t[e];const r=this.departments.get(Number(e))||{};this.departments.set(Number(e),{...r,...s,heads:s.heads,userCount:s.userCount,employees:[],employeeListOptions:{page:0,shouldUpdateList:true,isListUpdated:false}})}))},changeCurrentDepartment(e,t){const s=this.currentDepartments.filter((s=>s!==e&&s!==t));if(!t){this.currentDepartments=s;return}this.currentDepartments=[...s,t]},async loadHeads(e){if(e.length===0){return}const t=await s.getData("humanresources.api.Structure.Node.getHeadsByIds",{nodeIds:e});e.forEach((e=>{const s=this.departments.get(e);if(t[e]){this.departments.set(e,{...s,heads:t[e]})}}))},updateDepartment(e,t){const{id:s,parentId:r}=e;const a=this.departments.get(s);const i=a.entityType;const o=this.departments.get(a.parentId);this.departments.set(s,{...a,...e});this.structureMap.set(s,{id:s,parentId:r!=null?r:a.parentId,entityType:i});if(r!==0&&o.id!==r){var u;o.children=o.children.filter((e=>e!==s));const e=this.departments.get(r);e.children=(u=e.children)!=null?u:[];if(n.Type.isNumber(t)){e.children.splice(t,0,s)}else{e.children.push(s)}this.departments.set(s,{...this.departments.get(s),prevParentId:o.id})}},updateChatsInChildrenNodes(e){const t=this.departments.get(e);if(!t||!t.children){return}this.markDescendantsForChatReload(t.children)},markDescendantsForChatReload(e){const t=u();const s=[...e];const r=new Set;const n=1e4;let a=0;while(s.length>0&&a<n){a++;const e=s.shift();if(r.has(e)){continue}r.add(e);const n=t.departments.get(e);if(!n){continue}n.chatsDetailed=null;n.channelsDetailed=null;n.collabsDetailed=null;if(n.children&&n.children.length>0){s.push(...n.children)}}}}});e.useChartStore=u;e.UserService=o})(this.BX.Humanresources.CompanyStructure=this.BX.Humanresources.CompanyStructure||{},BX.Vue3.Pinia,BX.Humanresources.CompanyStructure,BX.Humanresources.CompanyStructure,BX,BX.Humanresources.CompanyStructure);
//# sourceMappingURL=chart-store.bundle.map.js