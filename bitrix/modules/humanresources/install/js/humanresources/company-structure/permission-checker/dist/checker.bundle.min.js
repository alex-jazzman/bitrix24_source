this.BX=this.BX||{};this.BX.Humanresources=this.BX.Humanresources||{};(function(e,t,r,s,n,i){"use strict";const a=e=>{const t=new Map;e.forEach((e=>{var r,s,n;const{id:a,parentId:u,colorName:o,entityType:m}=e;const c=(r=t.get(a))!=null?r:{};const l=i.getNodeColorSettings(o,m);t.set(a,{...c,...e,teamColor:l});if(u===0){return}const E=(s=t.get(u))!=null?s:{};const h=(n=E.children)!=null?n:[];t.set(u,{...E,children:[...h,a]})}));return t};const u={removeDepartment:e=>t.getData("humanresources.api.Structure.Node.delete",{nodeId:e}),getDepartmentsData:()=>t.getData("humanresources.api.Structure.get",{},{tool:"structure",category:"structure",event:"open_structure"}),getCurrentDepartments:()=>t.getData("humanresources.api.Structure.Node.current"),getDictionary:()=>t.getData("humanresources.api.Structure.dictionary"),getUserId:()=>t.getData("humanresources.api.User.getCurrentId"),firstTimeOpened:()=>t.postData("humanresources.api.User.firstTimeOpen"),updateDepartment:(e,r)=>t.postData("humanresources.api.Structure.Node.update",{nodeId:e,parentId:r,name:null}),changeOrder:(e,r,s)=>t.postData("humanresources.api.Structure.Node.changeOrder",{nodeId:e,direction:r,count:s}),createTreeDataStore:a};class o{isCheckerAction(e){throw new Error("The method isCheckerAction must be implemented in the subclass")}hasPermission(e,t,r,s){throw new Error("The method hasPermission must be implemented in the subclass")}}const m=Object.freeze({structureView:"ACTION_STRUCTURE_VIEW",departmentCreate:"ACTION_DEPARTMENT_CREATE",departmentDelete:"ACTION_DEPARTMENT_DELETE",departmentEdit:"ACTION_DEPARTMENT_EDIT",employeeAddToDepartment:"ACTION_EMPLOYEE_ADD_TO_DEPARTMENT",employeeRemoveFromDepartment:"ACTION_EMPLOYEE_REMOVE_FROM_DEPARTMENT",employeeFire:"ACTION_FIRE_EMPLOYEE",departmentSettingsEdit:"ACTION_DEPARTMENT_SETTINGS_EDIT",departmentChatEdit:"ACTION_DEPARTMENT_CHAT_EDIT",departmentChannelEdit:"ACTION_DEPARTMENT_CHANNEL_EDIT",departmentCollabEdit:"ACTION_DEPARTMENT_COLLAB_EDIT",accessEdit:"ACTION_USERS_ACCESS_EDIT",teamAccessEdit:"ACTION_TEAM_ACCESS_EDIT",inviteToDepartment:"ACTION_USER_INVITE",teamView:"ACTION_TEAM_VIEW",teamCreate:"ACTION_TEAM_CREATE",teamEdit:"ACTION_TEAM_EDIT",teamDelete:"ACTION_TEAM_DELETE",teamAddMember:"ACTION_TEAM_MEMBER_ADD",teamRemoveMember:"ACTION_TEAM_MEMBER_REMOVE",teamSettingsEdit:"ACTION_TEAM_SETTINGS_EDIT",teamChatEdit:"ACTION_TEAM_CHAT_EDIT",teamChannelEdit:"ACTION_TEAM_CHANNEL_EDIT",teamCollabEdit:"ACTION_TEAM_COLLAB_EDIT"});const c=Object.freeze({fullCompany:30,selfAndSub:20,self:10,none:0});class l extends o{constructor(e,t){super();this.departmentChecker=e;this.currentUserPermissions=t}isCheckerAction(e){const t=[m.teamView,m.teamCreate,m.teamEdit,m.teamDelete,m.teamAddMember,m.teamRemoveMember,m.teamSettingsEdit,m.teamChatEdit,m.teamChannelEdit,m.teamCollabEdit];return t.includes(e)}hasPermission(e,t,s,a){if(a){const e=s.TEAM<((a==null?void 0:a.TEAM)||0);const t=s.DEPARTMENT<((a==null?void 0:a.DEPARTMENT)||0);if(e||t){return false}}if(s.TEAM===c.fullCompany){const s=n.useChartStore().structureMap;const a=s.get(t);if((e===m.teamCreate||e===m.teamEdit)&&a.entityType===i.EntityTypes.department){return r.PermissionChecker.hasPermission(m.structureView,a.id)}return true}if(this.hasPermissionByTeamPermission(t,s.TEAM)){return true}return this.hasPermissionByDepartmentPermission(t,s.DEPARTMENT,e)}hasPermissionByTeamPermission(e,t=c.none){if(t===c.none){return false}const r=n.useChartStore().structureMap;const s=n.useChartStore().currentDepartments;const a=new Set(s.filter((e=>{const t=r.get(e);return t&&t.entityType===i.EntityTypes.team})));if(a.has(e)){return true}if(t===c.self){return false}let u=r.get(e);while(u){if(u.entityType===i.EntityTypes.department){return false}if(a.has(u.id)){return true}u=r.get(u.parentId)}return false}hasPermissionByDepartmentPermission(e,t=c.none,r=""){if(t===c.none){return false}const s=n.useChartStore().structureMap;const a=n.useChartStore().currentDepartments;const u=new Set(a.filter((e=>{const t=s.get(e);return t&&t.entityType===i.EntityTypes.department})));if(u.has(e)){return true}let o=s.get(e);while(o){if(u.has(o.id)){return true}if(t===c.self&&o.entityType===i.EntityTypes.department){if(r===m.teamCreate||r===m.teamEdit){return u.has(o.id)}return false}o=s.get(o.parentId)}return false}}class E extends o{isCheckerAction(e){const t=[m.structureView,m.departmentCreate,m.departmentDelete,m.departmentEdit,m.employeeAddToDepartment,m.employeeRemoveFromDepartment,m.employeeFire,m.departmentSettingsEdit,m.departmentChatEdit,m.departmentChannelEdit,m.departmentCollabEdit,m.inviteToDepartment];return t.includes(e)}hasPermission(e,t,r,i){if(!this.isCheckerAction(e)&&!s.Type.isNumber(r)){return false}if(i!==null&&r<i){return false}const a=n.useChartStore().structureMap;if(e===m.departmentDelete){const e=[...a.values()].find((e=>e.parentId===0)).id;if(t===e){return false}}const u=n.useChartStore().currentDepartments;switch(r){case c.fullCompany:{return true}case c.selfAndSub:{let e=a.get(t);while(e){if(u.includes(e.id)){return true}e=a.get(e.parentId)}return false}case c.self:{return u.includes(t)}case c.none:default:{return false}}}}class h{constructor(){if(!h.instance){this.currentUserPermissions={};this.isTeamsAvailable=false;this.isCollabsAvailable=false;this.isDeputyApprovesBPAvailable=false;this.isInitialized=false;this.departmentChecker=new E;this.teamChecker=new l(this.departmentChecker,this.currentUserPermissions);h.instance=this}return h.instance}getInstance(){return h.instance}async init(){if(this.isInitialized){return}const{currentUserPermissions:e,teamsAvailable:t,collabsAvailable:r,deputyApprovesBP:s,departmentSettingsAvailable:n}=await u.getDictionary();this.currentUserPermissions=e;this.isTeamsAvailable=t;this.isCollabsAvailable=r;this.isDeputyApprovesBPAvailable=s;this.isDepartmentSettingsAvailable=n;this.isInitialized=true}hasPermission(e,t,r=null){const s=this.currentUserPermissions[e];if(!s||!t){return false}if(this.departmentChecker.isCheckerAction(e)){return this.departmentChecker.hasPermission(e,t,s,r)}if(this.isTeamsAvailable&&this.teamChecker.isCheckerAction(e)){return this.teamChecker.hasPermission(e,t,s,r)}return false}checkDeputyApprovalBPAvailable(){return this.isDeputyApprovesBPAvailable}checkDepartmentSettingsAvailable(){return this.isDepartmentSettingsAvailable}hasPermissionOfAction(e){const t=this.currentUserPermissions[e];if(!t){return false}if(this.teamChecker.isCheckerAction(e)){if(!this.isTeamsAvailable){return false}return t.TEAM>c.none||t.DEPARTMENT>c.none}return t>c.none}canSortEntitiesByParentId(e){const t=n.useChartStore().departments;const r=t.get(e);if(!r){return false}const s={TEAM:c.selfAndSub};const a={DEPARTMENT:c.selfAndSub};const u=m.teamEdit;if(r.entityType===i.EntityTypes.team){return this.hasPermission(u,e,s)||this.hasPermission(u,e,a)}if(r.entityType===i.EntityTypes.department){const t=m.departmentEdit;return this.hasPermission(t,e,c.selfAndSub)}return false}canBeParentForEntity(e,t){if(t===i.EntityTypes.department){return this.hasPermission(m.departmentEdit,e)}if(t===i.EntityTypes.team){return this.hasPermission(m.teamEdit,e)}return false}}const T=new h;e.PermissionChecker=T;e.PermissionActions=m;e.PermissionLevels=c;e.PermissionCheckerClass=h})(this.BX.Humanresources.CompanyStructure=this.BX.Humanresources.CompanyStructure||{},BX.Humanresources.CompanyStructure,BX.Humanresources.CompanyStructure,BX,BX.Humanresources.CompanyStructure,BX.Humanresources.CompanyStructure);
//# sourceMappingURL=checker.bundle.map.js