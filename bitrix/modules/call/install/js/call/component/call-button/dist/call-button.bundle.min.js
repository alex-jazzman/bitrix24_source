this.BX=this.BX||{};this.BX.Call=this.BX.Call||{};(function(e,t,l,s,o,n,a,i,r,c,u,h,C,d,p,m,g,b,v){"use strict";const f=Object.freeze({main:"main",phone:"phone"});var _=babelHelpers.classPrivateFieldLooseKey("getVideoCallItem");var L=babelHelpers.classPrivateFieldLooseKey("getAudioCallItem");var M=babelHelpers.classPrivateFieldLooseKey("analyticsOnStartCallClick");var A=babelHelpers.classPrivateFieldLooseKey("getPersonalPhoneItem");var P=babelHelpers.classPrivateFieldLooseKey("getWorkPhoneItem");var T=babelHelpers.classPrivateFieldLooseKey("getInnerPhoneItem");var I=babelHelpers.classPrivateFieldLooseKey("getZoomItem");var E=babelHelpers.classPrivateFieldLooseKey("isCallAvailable");var B=babelHelpers.classPrivateFieldLooseKey("getUser");var y=babelHelpers.classPrivateFieldLooseKey("isUser");var H=babelHelpers.classPrivateFieldLooseKey("requestCreateZoomConference");class O extends c.BaseMenu{constructor(){super();Object.defineProperty(this,H,{value:j});Object.defineProperty(this,y,{value:U});Object.defineProperty(this,B,{value:X});Object.defineProperty(this,E,{value:k});Object.defineProperty(this,I,{value:S});Object.defineProperty(this,T,{value:D});Object.defineProperty(this,P,{value:F});Object.defineProperty(this,A,{value:w});Object.defineProperty(this,M,{value:R});Object.defineProperty(this,L,{value:x});Object.defineProperty(this,_,{value:N});this.id="bx-im-chat-header-call-menu"}getMenuOptions(){return{...super.getMenuOptions(),className:this.getMenuClassName(),angle:true,offsetLeft:4,offsetTop:5}}getMenuClassName(){return"bx-im-messenger__scope bx-call-chat-header-call-button__scope"}getMenuItems(){return[...this.groupItems([babelHelpers.classPrivateFieldLooseBase(this,_)[_](),babelHelpers.classPrivateFieldLooseBase(this,L)[L](),babelHelpers.classPrivateFieldLooseBase(this,I)[I]()],f.main),...this.groupItems([babelHelpers.classPrivateFieldLooseBase(this,A)[A](),babelHelpers.classPrivateFieldLooseBase(this,P)[P](),babelHelpers.classPrivateFieldLooseBase(this,T)[T]()],f.phone)]}getMenuGroups(){return[{code:f.main},{code:f.phone}]}}function N(){const e=babelHelpers.classPrivateFieldLooseBase(this,E)[E](this.context.dialogId);return{title:g.Loc.getMessage("CALL_CONTENT_CHAT_HEADER_VIDEOCALL"),design:e?o.MenuItemDesign.Default:o.MenuItemDesign.Disabled,onClick:()=>{if(!e){return}babelHelpers.classPrivateFieldLooseBase(this,M)[M](p.CallTypes.video.id);p.CallTypes.video.start(this.context.dialogId);this.emit(O.events.onMenuItemClick,p.CallTypes.video);this.menuInstance.close()}}}function x(){const e=babelHelpers.classPrivateFieldLooseBase(this,E)[E](this.context.dialogId);return{title:g.Loc.getMessage("CALL_CONTENT_CHAT_HEADER_CALL_MENU_AUDIO"),design:e?o.MenuItemDesign.Default:o.MenuItemDesign.Disabled,onClick:()=>{if(!e){return}babelHelpers.classPrivateFieldLooseBase(this,M)[M](p.CallTypes.audio.id);p.CallTypes.audio.start(this.context.dialogId);this.emit(O.events.onMenuItemClick,p.CallTypes.audio);this.menuInstance.close()}}}function R(e){d.Analytics.getInstance().onContextMenuStartCallClick({context:this.context,callType:e})}function w(){if(!babelHelpers.classPrivateFieldLooseBase(this,y)[y]()){return null}const{phones:e}=babelHelpers.classPrivateFieldLooseBase(this,B)[B]();if(!e.personalMobile){return null}const t=g.Loc.getMessage("CALL_CONTENT_CHAT_HEADER_CALL_MENU_PERSONAL_PHONE");return{title:t,subtitle:e.personalMobile,onClick:()=>{void n.Messenger.startPhoneCall(e.personalMobile);this.menuInstance.close()}}}function F(){if(!babelHelpers.classPrivateFieldLooseBase(this,y)[y]()){return null}const{phones:e}=babelHelpers.classPrivateFieldLooseBase(this,B)[B]();if(!e.workPhone){return null}return{title:g.Loc.getMessage("CALL_CONTENT_CHAT_HEADER_CALL_MENU_WORK_PHONE"),subtitle:e.workPhone,onClick:()=>{void n.Messenger.startPhoneCall(e.workPhone);this.menuInstance.close()}}}function D(){if(!babelHelpers.classPrivateFieldLooseBase(this,y)[y]()){return null}const{phones:e}=babelHelpers.classPrivateFieldLooseBase(this,B)[B]();if(!e.innerPhone){return null}return{title:g.Loc.getMessage("CALL_CONTENT_CHAT_HEADER_CALL_MENU_INNER_PHONE_MSGVER_1"),subtitle:e.innerPhone,onClick:()=>{void n.Messenger.startPhoneCall(e.innerPhone);this.menuInstance.close()}}}function S(){const e=C.FeatureManager.isFeatureAvailable(C.Feature.zoomActive);if(!e){return null}const t=C.FeatureManager.isFeatureAvailable(C.Feature.zoomAvailable);return{title:g.Loc.getMessage("CALL_CONTENT_CHAT_HEADER_CALL_MENU_ZOOM"),design:t?o.MenuItemDesign.Default:o.MenuItemDesign.Disabled,onClick:()=>{if(!t){BX.UI.InfoHelper.show("limit_video_conference_zoom");return}babelHelpers.classPrivateFieldLooseBase(this,H)[H](this.context.dialogId);this.menuInstance.close()}}}function k(e){if(u.CallManager.getInstance().hasActiveCurrentCall(e)){return true}if(u.CallManager.getInstance().hasActiveAnotherCall()){return false}const t=u.CallManager.getInstance().chatCanBeCalled(e);const l=r.PermissionManager.getInstance().canPerformActionByRole(i.ActionByRole.call,e);return t&&l}function X(){if(!babelHelpers.classPrivateFieldLooseBase(this,y)[y]()){return null}return a.Core.getStore().getters["users/get"](this.context.dialogId)}function U(){return this.context.type===i.ChatType.user}function j(e){h.runAction(i.RestMethod.imV2CallZoomCreate,{data:{dialogId:e}}).catch((e=>{let t=g.Loc.getMessage("CALL_CONTENT_CHAT_HEADER_CALL_MENU_ZOOM_CREATE_ERROR");const l=e.some((e=>e.code==="ZOOM_CONNECTED_ERROR"));if(l){const e=`/company/personal/user/${a.Core.getUserId()}/social_services/`;t=g.Loc.getMessage("CALL_CONTENT_CHAT_HEADER_CALL_MENU_ZOOM_CONNECT_ERROR").replace("#HREF_START#",`<a href=${e}>`).replace("#HREF_END#","</>")}BX.UI.Notification.Center.notify({content:t})}))}O.events={onMenuItemClick:"onMenuItemClick"};const K={name:"CallButtonTitle",props:{text:{type:String,required:true},compactMode:{type:Boolean,default:false},copilotMode:{type:Boolean,default:false}},computed:{callButtonIconClasses(){return["bx-call-chat-header-call-button__icon",...this.copilotMode?["--copilot"]:[],...this.compactMode?["--compact"]:[]]}},template:`\n\t\t<div :class="callButtonIconClasses"></div>\n\t\t<div v-if="!compactMode" class="bx-call-chat-header-call-button__text">\n\t\t\t{{ text }}\n\t\t</div>\n\t`};const V={name:"CallButtonPromo",components:{CallPopupContainer:m.CallPopupContainer},emits:["close"],props:{bindElement:{type:Object,required:true}},data(){return{isAIConcertAccepted:b.CallAI.agreementAccepted}},computed:{getId(){return"call-ai-user-list-popup"},config(){return{width:380,padding:0,overlay:false,autoHide:false,closeByEsc:false,angle:{offset:g.Dom.getPosition(this.bindElement).width/2,position:"top"},closeIcon:true,bindElement:this.bindElement,offsetTop:28}},callButtonPromoText(){return this.isAIConcertAccepted?this.loc("CALL_CHAT_HEADER_BUTTON_PROMO_TEXT"):this.loc("CALL_CHAT_HEADER_BUTTON_PROMO_TEXT_WITHOUT_TOS")}},methods:{loc(e,t={}){return g.Loc.getMessage(e,t)}},template:`\n\t\t<CallPopupContainer\n\t\t\t:config="config"\n\t\t\t@close="$emit('close')"\n\t\t\t:id="getId"\n\t\t>\n\t\t\t<div class='bx-call-chat-header-call-button__promo-container'>\n                <div class='bx-call-chat-header-call-button__promo-title'>\n                    {{ loc('CALL_CHAT_HEADER_BUTTON_PROMO_TITLE') }}\n                </div>\n                <div class='bx-call-chat-header-call-button__promo-text'>\n                    {{ callButtonPromoText }}\n                </div>\n\t\t\t</div>\n\t\t</CallPopupContainer>\n\t`};const Z=3;const $={name:"PulseAnimation",props:{showPulse:{type:Boolean,default:true},isConference:{type:Boolean,default:false}},computed:{rings(){if(!this.showPulse){return[]}return Array.from({length:Z})}},template:`\n\t\t<div class="bx-call-pulse-animation__container">\n\t\t\t<slot />\n\t\t\t<div v-for="ring in rings" class="bx-call-pulse-animation__ring" :class="{'--conference': isConference}"></div>\n\t\t</div>\n\t`};const q={directives:{hint:v.hint},components:{CallButtonTitle:K,CallButtonPromo:V,PulseAnimation:$},props:{dialog:{type:Object,required:true},compactMode:{type:Boolean,default:false}},data(){return{lastCallType:"",copilotMinUserLimit:b.CallAI.recordingMinUsers,isCopilotActive:b.CallAI.serviceEnabled,isTariffAvailable:b.CallAI.tariffAvailable,showPromo:false,showPromoTimer:null,promoId:"call:copilot-call-button:29102024:all"}},computed:{dialogId(){return this.dialog.dialogId},chatId(){return this.dialog.chatId},userCount(){return this.dialog.userCounter},isConference(){return this.dialog.type===i.ChatType.videoconf},callButtonText(){const e=p.CallTypes[this.lastCallType].locCode;return this.loc(e)},hasActiveCurrentCall(){return u.CallManager.getInstance().hasActiveCurrentCall(this.dialogId)},hasActiveAnotherCall(){return u.CallManager.getInstance().hasActiveAnotherCall(this.dialogId)},isActive(){if(this.hasActiveCurrentCall){return true}if(this.hasActiveAnotherCall){return false}return u.CallManager.getInstance().chatCanBeCalled(this.dialogId)},userLimit(){return u.CallManager.getInstance().getCallUserLimit()},isChatUserLimitExceeded(){return u.CallManager.getInstance().isChatUserLimitExceeded(this.dialogId)},shouldShowMenu(){return this.isActive},hintContent(){if(!this.isChatUserLimitExceeded){return null}return{text:this.loc("IM_LIB_CALL_USER_LIMIT_EXCEEDED_TOOLTIP",{"#USER_LIMIT#":this.userLimit}),popupOptions:{bindOptions:{position:"bottom"},angle:{position:"top"},targetContainer:document.body,offsetLeft:63,offsetTop:0}}},isCopilotCall(){return this.isCopilotActive&&this.userCount>=this.copilotMinUserLimit&&!this.isConference&&this.isTariffAvailable},callButtonContainerClasses(){return["bx-call-chat-header-call-button__scope","bx-call-chat-header-call-button__container",...this.isConference?["--conference"]:[],...this.isCopilotCall?["--copilot"]:[],...!this.isActive?["--disabled"]:[]]},canShowPromo(){return this.isCopilotCall&&s.PromoManager.getInstance().needToShow(this.promoId)&&!this.hasActiveCurrentCall&&this.isActive}},created(){this.lastCallType=this.getLastCallChoice();this.subscribeToMenuItemClick();t.EventEmitter.subscribe("BX.Call.View:onShow",this.onShowCallView)},mounted(){this.showPromoTimer=setTimeout((()=>{this.showPromo=this.canShowPromo}),2e4)},beforeUnmount(){this.clearShowPromoTimer();this.showPromo=false;t.EventEmitter.unsubscribe("BX.Call.View:onShow",this.onShowCallView)},methods:{startVideoCall(){if(!this.isActive){return}n.Messenger.startVideoCall(this.dialogId)},subscribeToMenuItemClick(){this.getCallMenu().subscribe(O.events.onMenuItemClick,(e=>{const{id:t}=e.getData();this.saveLastCallChoice(t)}))},onShowCallView(){this.onClosePromo()},onButtonClick(){if(!this.isActive){return}if(this.isCopilotCall){this.onClosePromo()}d.Analytics.getInstance().onChatHeaderStartCallClick({dialog:this.dialog,callType:this.lastCallType});p.CallTypes[this.lastCallType].start(this.dialogId)},onMenuClick(){if(!this.shouldShowMenu){return}this.getCallMenu().openMenu(this.dialog,this.$refs.menu)},onStartConferenceClick(){if(!this.isActive){return}if(this.isCopilotCall){this.onClosePromo()}d.Analytics.getInstance().onStartConferenceClick({chatId:this.chatId});n.Messenger.openConference({code:this.dialog.public.code})},getLastCallChoice(){return l.LocalStorageManager.getInstance().get(i.LocalStorageKey.lastCallType,p.CallTypes.video.id)},saveLastCallChoice(e){this.lastCallType=e;l.LocalStorageManager.getInstance().set(i.LocalStorageKey.lastCallType,e)},getCallMenu(){if(!this.callMenu){this.callMenu=new O}return this.callMenu},loc(e,t={}){return g.Loc.getMessage(e,t)},onClosePromo(){this.clearShowPromoTimer();this.showPromo=false;s.PromoManager.getInstance().markAsWatched(this.promoId)},clearShowPromoTimer(){clearTimeout(this.showPromoTimer);this.showPromoTimer=null}},template:`\n\t\t<PulseAnimation :showPulse="showPromo" :isConference="isConference">\n\t\t\t<div\n\t\t\t\tv-if="isConference"\n\t\t\t\t:class="callButtonContainerClasses"\n\t\t\t\t@click="onStartConferenceClick"\n\t\t\t\tref="call-button"\n\t\t\t>\n\t\t\t\t<CallButtonTitle :compactMode="compactMode" :copilotMode="isCopilotCall" :text="loc('IM_CONTENT_CHAT_HEADER_START_CONFERENCE')" />\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tv-else\n\t\t\t\t:class="callButtonContainerClasses"\n\t\t\t\tv-hint="hintContent"\n\t\t\t\t@click="onButtonClick"\n\t\t\t\tref="call-button"\n\t\t\t>\n\t\t\t\t<CallButtonTitle :compactMode="compactMode" :copilotMode="isCopilotCall" :text="callButtonText" />\n\t\t\t\t<div class="bx-call-chat-header-call-button__separator"></div>\n\t\t\t\t<div class="bx-call-chat-header-call-button__chevron_container" @click.stop="onMenuClick">\n\t\t\t\t\t<div class="bx-call-chat-header-call-button__chevron" ref="menu"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<CallButtonPromo\n\t\t\t\tv-if="showPromo"\n\t\t\t\t:bindElement="$refs['call-button']"\n\t\t\t\t@close="onClosePromo"\n\t\t\t/>\n\t\t</PulseAnimation>\n\t`};e.CallButton=q})(this.BX.Call.Component=this.BX.Call.Component||{},BX.Event,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.UI.System,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Const,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Call.Lib,BX.Call.Const,BX.Call.Component.Elements,BX,BX.Call,BX.Vue3.Directives);
//# sourceMappingURL=call-button.bundle.map.js