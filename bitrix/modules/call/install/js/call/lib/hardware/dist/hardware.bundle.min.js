this.BX=this.BX||{};this.BX.Call=this.BX.Call||{};(function(e,i,t){"use strict";const r={defaultMicrophone:"bx-im-settings-default-microphone",defaultCamera:"bx-im-settings-default-camera",defaultSpeaker:"bx-im-settings-default-speaker"};const a={initialized:"initialized",deviceChanged:"deviceChange"};class s extends i.EventEmitter{constructor(){super();this.Events=a;this.setEventNamespace("BX.Call.HardwareManager");this.initialized=false;this._currentDeviceList=[];this.updating=false}init(){if(this.initialized){return Promise.resolve()}if(this.initPromise){return this.initPromise}this._checkPermissions();this.initPromise=new Promise(((e,i)=>{this.enumerateDevices().then((i=>{this._currentDeviceList=this.filterDeviceList(i);navigator.mediaDevices.addEventListener("devicechange",BX.debounce(this.onNavigatorDeviceChanged.bind(this),500));this.initialized=true;this.initPromise=null;this.emit(a.initialized,{});e()})).catch((e=>{this.initPromise=null;i(e)}))}));return this.initPromise}async _checkPermissions(){const e=await navigator.permissions.query({name:"camera"});const i=await navigator.permissions.query({name:"microphone"});e.onchange=e=>{this.getCurrentDeviceList()};i.onchange=e=>{this.getCurrentDeviceList()}}async getUserMedia(e){return new Promise(((i,t)=>{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){const e=new Error("NO_WEBRTC");e.code="NO_WEBRTC";throw e}navigator.mediaDevices.getUserMedia(e).then((e=>{i(e)})).catch((e=>{t(e)}))}))}async enumerateDevices(){if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices){const e=new Error("NO_WEBRTC");e.code="NO_WEBRTC";throw e}try{const e=await navigator.mediaDevices.enumerateDevices();return e}catch(e){throw e}}get cameraList(){return this._getDeviceMap("videoinput")}get microphoneList(){return this._getDeviceMap("audioinput")}get audioOutputList(){return this._getDeviceMap("audiooutput")}get defaultMicrophone(){let e=localStorage?localStorage.getItem(r.defaultMicrophone):"";if((!e||!this.microphoneList[e])&&Object.keys(this.microphoneList).length){if(Object.keys(this.microphoneList).includes("default")){e=this.getDefaultDeviceIdByGroupId(this.getDeviceGroupIdByDeviceId("default","audioinput"),"audioinput")}if(!e){e=Object.keys(this.microphoneList)[0]}return e}return this.microphoneList[e]?e:""}set defaultMicrophone(e){if(localStorage){localStorage.setItem(r.defaultMicrophone,e)}}get defaultCamera(){const e=localStorage?localStorage.getItem(r.defaultCamera):"";if((!e||!this.cameraList[e])&&Object.keys(this.cameraList).length){return Object.keys(this.cameraList)[0]}return this.cameraList[e]?e:""}set defaultCamera(e){if(localStorage){localStorage.setItem(r.defaultCamera,e)}}get defaultSpeaker(){let e=localStorage?localStorage.getItem(r.defaultSpeaker):"";if((!e||this.audioOutputList[e])&&Object.keys(this.audioOutputList).length){e=Object.keys(this.audioOutputList).includes("default")?this.getDefaultDeviceIdByGroupId(this.getDeviceGroupIdByDeviceId("default","audiooutput"),"audiooutput"):Object.keys(this.audioOutputList)[0];return e}return this.audioOutputList[e]?e:""}set defaultSpeaker(e){if(localStorage){localStorage.setItem(r.defaultSpeaker,e)}}hasCamera(){if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}return Object.keys(this.cameraList).length>0}hasMicrophone(){if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}return Object.keys(this.microphoneList).length>0}getMicrophoneList(){if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}return Object.values(this._currentDeviceList).filter((e=>e.kind==="audioinput"&&e.deviceId!=="default"))}getCameraList(){if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}return Object.values(this._currentDeviceList).filter((e=>e.kind=="videoinput"))}getSpeakerList(){if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}return Object.values(this._currentDeviceList).filter((e=>e.kind==="audiooutput"&&e.deviceId!=="default"))}canSelectSpeaker(){return"setSinkId"in HTMLMediaElement.prototype}updateDeviceList(e){if(this.updating){return}this.updating=true;let i=this._currentDeviceList;let t=[];const r=this._currentDeviceList.every((e=>e.deviceId==""&&e.label==""));this.enumerateDevices().then((e=>{e=this.filterDeviceList(e);e.forEach((e=>{const r=i.findIndex((i=>i.kind===e.kind&&i.deviceId===e.deviceId&&i.groupId===e.groupId));if(r!=-1){i.splice(r,1)}else{t.push(e)}}));this._currentDeviceList=e;if(!r){this.emit(a.deviceChanged,{added:t,removed:i})}this.updating=false}))}filterDeviceList(e){return e.filter((e=>{switch(e.kind){case"audioinput":return e.deviceId!=="communications"&&!this.isDeviceInBlackList(e);case"audiooutput":return e.deviceId!=="communications"&&!this.isDeviceInBlackList(e);default:return true}}))}isDeviceInBlackList(e){const i=["(virtual)","zoomaudiodevice","microsoft teams audio","bitrixaudio"];let t=false;i.forEach((i=>{if(e.label.toLowerCase().includes(i)){t=true;return false}}));return t}onNavigatorDeviceChanged(e){if(!this.initialized){return}this.updateDeviceList()}_getDeviceMap(e){let i={};if(!this.initialized){throw new Error("HardwareManager is not initialized yet")}for(let t=0;t<this._currentDeviceList.length;t++){if(this._currentDeviceList[t].kind==e){i[this._currentDeviceList[t].deviceId]=this._currentDeviceList[t].label}}return i}getDefaultDeviceIdByGroupId(e,i){let t;this._currentDeviceList.forEach((r=>{if(r.groupId===e&&r.deviceId!=="default"&&r.kind===i){t=r.deviceId;return false}}));return t}getDeviceGroupIdByDeviceId(e,i){let t;this._currentDeviceList.forEach((r=>{if(r.deviceId===e&&r.kind===i){t=r.groupId;return false}}));return t}removeDevicesByDefaultGroup(e){let i=e;e.forEach((e=>{if(e.deviceId==="default"){i=i.filter((i=>i.kind!==e.kind||i.groupId!==e.groupId))}}));return i}getCurrentDeviceList(){return new Promise(((e,i)=>{this.enumerateDevices().then((i=>{this._currentDeviceList=this.filterDeviceList(i);e(this._currentDeviceList,i)}))}))}getRemovedUsedDevices(e,i){return e.filter((e=>{switch(e.kind){case"audioinput":return e.deviceId===i.microphoneId;case"audiooutput":return e.deviceId===i.speakerId;case"videoinput":return e.deviceId===i.cameraId;default:return false}}))}}e.HardwareManager=s})(this.BX.Call.Lib=this.BX.Call.Lib||{},BX.Event,BX.Messenger.v2.Lib);
//# sourceMappingURL=hardware.bundle.map.js