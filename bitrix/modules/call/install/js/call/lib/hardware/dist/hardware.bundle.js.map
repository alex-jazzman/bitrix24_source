{"version":3,"file":"hardware.bundle.js","sources":["../src/hardware.js"],"sourcesContent":["import { EventEmitter } from 'main.core.events';\nimport { DesktopApi } from 'im.v2.lib.desktop-api';\n\nconst lsKey = {\n\tdefaultMicrophone: 'bx-im-settings-default-microphone',\n\tdefaultCamera: 'bx-im-settings-default-camera',\n\tdefaultSpeaker: 'bx-im-settings-default-speaker',\n};\n\nconst Events = {\n\tinitialized: 'initialized',\n\tdeviceChanged: 'deviceChange',\n};\n\nexport class HardwareManager extends EventEmitter\n{\n\tEvents = Events\n\n\tconstructor()\n\t{\n\t\tsuper();\n\t\t\n\t\tthis.setEventNamespace('BX.Call.HardwareManager');\n\n\t\tthis.initialized = false;\n\t\tthis._currentDeviceList = [];\n\t\tthis.updating = false;\n\t}\n\n\tinit()\n\t{\n\t\tif (this.initialized)\n\t\t{\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tif (this.initPromise)\n\t\t{\n\t\t\treturn this.initPromise;\n\t\t}\n\t\t\n\t\tthis._checkPermissions();\n\n\t\tthis.initPromise = new Promise((resolve, reject) =>\n\t\t{\n\t\t\tthis.enumerateDevices()\n\t\t\t\t.then((deviceList) =>\n\t\t\t\t{\n\t\t\t\t\tthis._currentDeviceList = this.filterDeviceList(deviceList);\n\n\t\t\t\t\tnavigator.mediaDevices.addEventListener('devicechange', BX.debounce(this.onNavigatorDeviceChanged.bind(this), 500));\n\t\t\t\t\tthis.initialized = true;\n\t\t\t\t\tthis.initPromise = null;\n\t\t\t\t\tthis.emit(Events.initialized, {});\n\t\t\t\t\tresolve();\n\t\t\t\t})\n\t\t\t\t.catch((e) =>\n\t\t\t\t{\n\t\t\t\t\tthis.initPromise = null;\n\t\t\t\t\treject(e)\n\t\t\t\t});\n\t\t})\n\n\t\treturn this.initPromise;\n\t}\n\t\n\tasync _checkPermissions()\n\t{\n\t\tconst cameraPermission = await navigator.permissions.query({ name: 'camera' });\n\t\tconst microphonePermission = await navigator.permissions.query({ name: 'microphone' });\n\n\t\tcameraPermission.onchange = (status) => {\n\t\t\tthis.getCurrentDeviceList();\n\t\t};\n\n\t\tmicrophonePermission.onchange = (status) => {\n\t\t\tthis.getCurrentDeviceList();\n\t\t};\n\t}\n\t\n\tasync getUserMedia(constraints)\n\t{\t\n\t\treturn new Promise((resolve, reject) =>\n\t\t{\n\t\t\tif (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia)\n\t\t\t{\n\t\t\t\tconst error = new Error(\"NO_WEBRTC\");\n\t\t\t\terror.code = \"NO_WEBRTC\";\n\t\t\t\tthrow error;\n\t\t\t}\n\n\t\t\tnavigator.mediaDevices.getUserMedia(constraints)\n\t\t\t.then(stream => {\n\t\t\t\tresolve(stream);\n\t\t\t})\n\t\t\t.catch(err => {\n\t\t\t\treject(err);\n\t\t\t});\n\t\t});\n\t}\n\n\tasync enumerateDevices() {\n\t\tif (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices)\n\t\t{\n\t\t\tconst error = new Error(\"NO_WEBRTC\");\n\t\t\terror.code = \"NO_WEBRTC\";\n\t\t\tthrow error;\n\t\t}\n\n\t\ttry\n\t\t{\n\t\t\tconst devices = await navigator.mediaDevices.enumerateDevices();\n\t\t\treturn devices;\n\t\t} catch (e) {\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\tget cameraList()\n\t{\n\t\treturn this._getDeviceMap('videoinput');\n\t}\n\n\tget microphoneList()\n\t{\n\t\treturn this._getDeviceMap('audioinput');\n\t}\n\n\tget audioOutputList()\n\t{\n\t\treturn this._getDeviceMap('audiooutput');\n\t}\n\n\tget defaultMicrophone()\n\t{\n\t\tlet microphoneId = localStorage ? localStorage.getItem(lsKey.defaultMicrophone) : '';\n\n\t\tif (\n\t\t\t(!microphoneId || !this.microphoneList[microphoneId])\n\t\t\t&& Object.keys(this.microphoneList).length\n\t\t)\n\t\t{\n\t\t\t// previous solution with ternary operator\n\t\t\t// has been replaced with two separate conditions\n\t\t\t// because some systems / browsers don't create a duplicate for the default audio device\n\t\t\tif (Object.keys(this.microphoneList).includes('default'))\n\t\t\t{\n\t\t\t\tmicrophoneId = this.getDefaultDeviceIdByGroupId(this.getDeviceGroupIdByDeviceId('default', 'audioinput'), 'audioinput');\n\t\t\t}\n\n\t\t\tif (!microphoneId)\n\t\t\t{\n\t\t\t\tmicrophoneId = Object.keys(this.microphoneList)[0];\n\t\t\t}\n\n\t\t\treturn  microphoneId;\n\t\t}\n\t\treturn this.microphoneList[microphoneId] ? microphoneId : '';\n\t}\n\n\tset defaultMicrophone(microphoneId)\n\t{\n\t\tif (localStorage)\n\t\t{\n\t\t\tlocalStorage.setItem(lsKey.defaultMicrophone, microphoneId)\n\t\t}\n\t}\n\n\tget defaultCamera()\n\t{\n\t\tconst cameraId = localStorage ? localStorage.getItem(lsKey.defaultCamera) : '';\n\n\t\tif (\n\t\t\t(!cameraId || !this.cameraList[cameraId])\n\t\t\t&& Object.keys(this.cameraList).length\n\t\t)\n\t\t{\n\t\t\treturn Object.keys(this.cameraList)[0];\n\t\t}\n\n\t\treturn this.cameraList[cameraId] ? cameraId : '';\n\t}\n\n\tset defaultCamera(cameraId)\n\t{\n\t\tif (localStorage)\n\t\t{\n\t\t\tlocalStorage.setItem(lsKey.defaultCamera, cameraId)\n\t\t}\n\t}\n\n\tget defaultSpeaker()\n\t{\n\t\tlet speakerId = localStorage ? localStorage.getItem(lsKey.defaultSpeaker) : '';\n\n\t\tif (\n\t\t\t(!speakerId || this.audioOutputList[speakerId])\n\t\t\t&& Object.keys(this.audioOutputList).length\n\t\t)\n\t\t{\n\t\t\tspeakerId = Object.keys(this.audioOutputList).includes('default')\n\t\t\t\t? this.getDefaultDeviceIdByGroupId(this.getDeviceGroupIdByDeviceId('default', 'audiooutput'), 'audiooutput')\n\t\t\t\t: Object.keys(this.audioOutputList)[0]\n\t\t\t;\n\n\t\t\treturn  speakerId;\n\t\t}\n\t\treturn this.audioOutputList[speakerId] ? speakerId : '';\n\t}\n\n\tset defaultSpeaker(speakerId: string)\n\t{\n\t\tif (localStorage)\n\t\t{\n\t\t\tlocalStorage.setItem(lsKey.defaultSpeaker, speakerId)\n\t\t}\n\t}\n\n\thasCamera()\n\t{\n\t\tif (!this.initialized)\n\t\t{\n\t\t\tthrow new Error('HardwareManager is not initialized yet');\n\t\t}\n\n\t\treturn Object.keys(this.cameraList).length > 0;\n\t}\n\n\thasMicrophone()\n\t{\n\t\tif (!this.initialized)\n\t\t{\n\t\t\tthrow new Error('HardwareManager is not initialized yet');\n\t\t}\n\n\t\treturn Object.keys(this.microphoneList).length > 0;\n\t}\n\n\tgetMicrophoneList()\n\t{\n\t\tif (!this.initialized)\n\t\t{\n\t\t\tthrow new Error('HardwareManager is not initialized yet');\n\t\t}\n\n\t\treturn Object.values(this._currentDeviceList).filter(deviceInfo => (\n\t\t\tdeviceInfo.kind === 'audioinput' && deviceInfo.deviceId !== 'default'\n\t\t));\n\t}\n\n\tgetCameraList()\n\t{\n\t\tif (!this.initialized)\n\t\t{\n\t\t\tthrow new Error('HardwareManager is not initialized yet');\n\t\t}\n\n\t\treturn Object.values(this._currentDeviceList).filter(deviceInfo => deviceInfo.kind == 'videoinput')\n\t}\n\n\tgetSpeakerList()\n\t{\n\t\tif (!this.initialized)\n\t\t{\n\t\t\tthrow new Error('HardwareManager is not initialized yet');\n\t\t}\n\n\t\treturn Object.values(this._currentDeviceList).filter(deviceInfo => (\n\t\t\tdeviceInfo.kind === 'audiooutput' && deviceInfo.deviceId !== 'default'\n\t\t));\n\t}\n\n\tcanSelectSpeaker()\n\t{\n\t\treturn 'setSinkId' in HTMLMediaElement.prototype;\n\t}\n\n\tupdateDeviceList(e)\n\t{\n\t\tif (this.updating)\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tthis.updating = true;\n\t\tlet removedDevices = this._currentDeviceList;\n\t\tlet addedDevices = [];\n\n\t\tconst shouldSkipDeviceChangedEvent = this._currentDeviceList.every(deviceInfo => deviceInfo.deviceId == '' && deviceInfo.label == '');\n\n\t\tthis.enumerateDevices().then(devices =>\n\t\t{\n\t\t\tdevices = this.filterDeviceList(devices);\n\t\t\tdevices.forEach(deviceInfo =>\n\t\t\t{\n\t\t\t\tconst index = removedDevices.findIndex(dev => (\n\t\t\t\t\tdev.kind === deviceInfo.kind\n\t\t\t\t\t&& dev.deviceId === deviceInfo.deviceId\n\t\t\t\t\t&& dev.groupId === deviceInfo.groupId\n\t\t\t\t))\n\t\t\t\tif (index != -1)\n\t\t\t\t{\n\t\t\t\t\t// device found in previous version\n\t\t\t\t\tremovedDevices.splice(index, 1);\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\taddedDevices.push(deviceInfo);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis._currentDeviceList = devices;\n\n\t\t\tif (!shouldSkipDeviceChangedEvent)\n\t\t\t{\n\t\t\t\tthis.emit(Events.deviceChanged, {\n\t\t\t\t\tadded: addedDevices,\n\t\t\t\t\tremoved: removedDevices\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthis.updating = false;\n\t\t})\n\t}\n\n\tfilterDeviceList(browserDeviceList)\n\t{\n\t\treturn browserDeviceList.filter(device =>\n\t\t{\n\t\t\tswitch (device.kind)\n\t\t\t{\n\t\t\t\tcase 'audioinput':\n\t\t\t\t\treturn device.deviceId !== 'communications' && !this.isDeviceInBlackList(device);\n\t\t\t\tcase 'audiooutput':\n\t\t\t\t\treturn device.deviceId !== 'communications' && !this.isDeviceInBlackList(device);\n\t\t\t\tdefault:\n\t\t\t\t\treturn true;\n\t\t\t}\n\t\t})\n\t}\n\n\tisDeviceInBlackList(device)\n\t{\n\t\tconst deviceBlackList = [\n\t\t\t'(virtual)',\n\t\t\t'zoomaudiodevice',\n\t\t\t'microsoft teams audio',\n\t\t\t'bitrixaudio',\n\t\t];\n\t\tlet result = false;\n\n\t\tdeviceBlackList.forEach(item => {\n\t\t\tif (device.label.toLowerCase().includes(item))\n\t\t\t{\n\t\t\t\tresult = true;\n\t\t\t\treturn false;\n\t\t\t}\n\t\t});\n\n\t\treturn result;\n\t}\n\n\tonNavigatorDeviceChanged(e)\n\t{\n\t\tif (!this.initialized)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.updateDeviceList();\n\t}\n\n\t_getDeviceMap(deviceKind)\n\t{\n\t\tlet result = {};\n\t\tif (!this.initialized)\n\t\t{\n\t\t\tthrow new Error('HardwareManager is not initialized yet');\n\t\t}\n\t\tfor (let i = 0; i < this._currentDeviceList.length; i++)\n\t\t{\n\t\t\tif (this._currentDeviceList[i].kind == deviceKind)\n\t\t\t{\n\t\t\t\tresult[this._currentDeviceList[i].deviceId] = this._currentDeviceList[i].label;\n\t\t\t}\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tgetDefaultDeviceIdByGroupId(groupId, deviceKind)\n\t{\n\t\tlet deviceId;\n\n\t\tthis._currentDeviceList.forEach(device => {\n\t\t\tif (\n\t\t\t\tdevice.groupId === groupId\n\t\t\t\t&& device.deviceId !== 'default'\n\t\t\t\t&& device.kind === deviceKind\n\t\t\t)\n\t\t\t{\n\t\t\t\tdeviceId = device.deviceId;\n\t\t\t\treturn false;\n\t\t\t}\n\t\t});\n\n\t\treturn deviceId;\n\t}\n\n\tgetDeviceGroupIdByDeviceId(deviceId, deviceKind)\n\t{\n\t\tlet groupId;\n\n\t\tthis._currentDeviceList.forEach(device => {\n\t\t\tif (device.deviceId === deviceId && device.kind === deviceKind)\n\t\t\t{\n\t\t\t\tgroupId = device.groupId;\n\t\t\t\treturn false;\n\t\t\t}\n\t\t});\n\n\t\treturn groupId;\n\t}\n\n\tremoveDevicesByDefaultGroup(devices)\n\t{\n\t\tlet resultDeviceList = devices;\n\n\t\tdevices.forEach(device => {\n\t\t\tif (device.deviceId === 'default')\n\t\t\t{\n\t\t\t\tresultDeviceList = resultDeviceList.filter(item => (\n\t\t\t\t\titem.kind !== device.kind\n\t\t\t\t\t|| item.groupId !== device.groupId\n\t\t\t\t));\n\t\t\t}\n\t\t});\n\n\t\treturn resultDeviceList;\n\t}\n\n\tgetCurrentDeviceList()\n\t{\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.enumerateDevices().then(deviceList => {\n\t\t\t\tthis._currentDeviceList = this.filterDeviceList(deviceList);\n\t\t\t\tresolve(this._currentDeviceList, deviceList);\n\t\t\t})\n\t\t});\n\t}\n\n\tgetRemovedUsedDevices(devices, currentDevices)\n\t{\n\t\treturn devices.filter(device =>\n\t\t{\n\t\t\tswitch (device.kind)\n\t\t\t{\n\t\t\t\tcase 'audioinput':\n\t\t\t\t\treturn device.deviceId === currentDevices.microphoneId;\n\t\t\t\tcase 'audiooutput':\n\t\t\t\t\treturn device.deviceId === currentDevices.speakerId;\n\t\t\t\tcase 'videoinput':\n\t\t\t\t\treturn device.deviceId === currentDevices.cameraId;\n\t\t\t\tdefault:\n\t\t\t\t\treturn false;\n\t\t\t}\n\t\t})\n\t}\n}"],"names":["lsKey","defaultMicrophone","defaultCamera","defaultSpeaker","Events","initialized","deviceChanged","HardwareManager","EventEmitter","constructor","setEventNamespace","_currentDeviceList","updating","init","Promise","resolve","initPromise","_checkPermissions","reject","enumerateDevices","then","deviceList","filterDeviceList","navigator","mediaDevices","addEventListener","BX","debounce","onNavigatorDeviceChanged","bind","emit","catch","e","cameraPermission","permissions","query","name","microphonePermission","onchange","status","getCurrentDeviceList","getUserMedia","constraints","error","Error","code","stream","err","devices","cameraList","_getDeviceMap","microphoneList","audioOutputList","microphoneId","localStorage","getItem","Object","keys","length","includes","getDefaultDeviceIdByGroupId","getDeviceGroupIdByDeviceId","setItem","cameraId","speakerId","hasCamera","hasMicrophone","getMicrophoneList","values","filter","deviceInfo","kind","deviceId","getCameraList","getSpeakerList","canSelectSpeaker","HTMLMediaElement","prototype","updateDeviceList","removedDevices","addedDevices","shouldSkipDeviceChangedEvent","every","label","forEach","index","findIndex","dev","groupId","splice","push","added","removed","browserDeviceList","device","isDeviceInBlackList","deviceBlackList","result","item","toLowerCase","deviceKind","i","removeDevicesByDefaultGroup","resultDeviceList","getRemovedUsedDevices","currentDevices"],"mappings":"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"}