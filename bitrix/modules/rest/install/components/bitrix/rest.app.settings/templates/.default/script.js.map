{"version":3,"file":"script.js","sources":["src/app-settings.js"],"sourcesContent":["import { Dom, Tag, ajax, Type, Loc } from 'main.core';\nimport { Loader } from 'main.loader';\nimport { EventEmitter } from 'main.core.events';\nimport { FormConstructor } from 'rest.form-constructor';\n\nexport class AppSettings extends EventEmitter\n{\n\t#formConstructor: FormConstructor;\n\t#handler: string;\n\t#redirect: ?string\n\t#clientId: ?string\n\t#wrapper: HTMLElement;\n\t#loader: Loader\n\t#overlay: HTMLElement;\n\n\tconstructor(options)\n\t{\n\t\tsuper();\n\t\tif (!(options.formConstructor instanceof FormConstructor))\n\t\t{\n\t\t\tthrow new Error('\"formConstructor\" is required parameters')\n\t\t}\n\n\t\tthis.#redirect = null;\n\t\tthis.#wrapper = Type.isElementNode(options.wrapper) ? options.wrapper : null;\n\t\tthis.setFormConstructor(options.formConstructor);\n\t\tthis.#handler = Type.isStringFilled(options.handler) ? options.handler : null;\n\t\tthis.#clientId = Type.isStringFilled(options.clientId) ? options.clientId : null;\n\t\tthis.setRedirect(options.redirect);\n\t\tthis.#loader = new Loader({\n\t\t\ttarget: this.#wrapper\n\t\t});\n\t\tthis.#overlay = Tag.render`<div class=\"rest-app-settings-overlay\"></div>`\n\t}\n\n\tsetRedirect(url: string)\n\t{\n\t\tconst reqExp = new RegExp('^(?:/|https?://' + location.host + ')', \"g\");\n\t\tif (Type.isStringFilled(url) && !!url.match(reqExp))\n\t\t{\n\t\t\tthis.#redirect = url;\n\t\t}\n\t}\n\n\tshow(): void\n\t{\n\t\tif (Type.isNil(this.#wrapper))\n\t\t{\n\t\t\tthrow new Error('Property \"wrapper\" is undefined')\n\t\t}\n\n\t\tthis.#formConstructor.renderTo(this.#wrapper);\n\t}\n\n\tsubscribeEvents(): void\n\t{\n\t\tif (!(this.#formConstructor instanceof FormConstructor))\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tthis.#formConstructor.subscribe('onSave', (event) => {\n\t\t\tconst { form } = event.data;\n\t\t\tconst data = {\n\t\t\t\tsettings: form,\n\t\t\t\thandler: this.#handler\n\t\t\t};\n\n\t\t\tthis.save(data);\n\t\t});\n\t\tthis.#formConstructor.subscribe('onReadySave', () => {\n\t\t\tif (this.isReadySave())\n\t\t\t{\n\t\t\t\tBX.UI.ButtonPanel.show();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tBX.UI.ButtonPanel.hide();\n\t\t\t}\n\t\t});\n\t\tthis.#formConstructor.subscribe('onUnreadySave', () => {\n\t\t\tBX.UI.ButtonPanel.hide();\n\t\t});\n\t\tthis.#formConstructor.subscribe('onFieldChange', () => {\n\t\t\tthis.reload()\n\t\t});\n\t}\n\n\tunsubscribeEvents(): void\n\t{\n\t\tif (!(this.#formConstructor instanceof FormConstructor))\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tthis.#formConstructor.unsubscribeAll('onSave');\n\t\tthis.#formConstructor.unsubscribeAll('onReadySave');\n\t\tthis.#formConstructor.unsubscribeAll('onUnreadySave');\n\t\tthis.#formConstructor.unsubscribeAll('onFieldChange');\n\t}\n\n\tsetFormConstructor(formConstructor: FormConstructor): void\n\t{\n\t\tthis.unsubscribeEvents();\n\t\tthis.#formConstructor = formConstructor;\n\t\tthis.subscribeEvents();\n\t}\n\n\treload(): void\n\t{\n\t\tDom.append(this.#overlay,this.#wrapper);\n\t\tthis.#loader.show();\n\n\t\tif (Type.isNil(this.#clientId))\n\t\t{\n\t\t\tconsole.log('Property \"clientId\" is undefined');\n\t\t\treturn;\n\t\t}\n\t\tajax.runComponentAction('bitrix:rest.app.settings', 'reload',{\n\t\t\tmode: 'class',\n\t\t\tdata: {\n\t\t\t\tclientId: this.#clientId,\n\t\t\t\tsettings: this.#formConstructor.getFormData()\n\t\t\t},\n\t\t}).then((response) => {\n\t\t\tconst data = response.data;\n\t\t\tthis.setFormConstructor(new FormConstructor({\n\t\t\t\tsteps: data.STEPS,\n\t\t\t}));\n\t\t\tthis.#handler = Type.isStringFilled(data.HANDLER) ? data.HANDLER : this.#handler;\n\t\t\tthis.#clientId = Type.isStringFilled(data.CLIENT_ID) ? data.CLIENT_ID : this.#clientId;\n\t\t\tthis.setRedirect(data.REDIRECT);\n\n\t\t\tthis.show();\n\t\t\tthis.#loader.hide();\n\t\t\tDom.remove(this.#overlay);\n\t\t}).catch((response) => {\n\t\t\tconsole.log(response.errors);\n\t\t\tthis.#formConstructor.showTextInBalloon(Loc.getMessage('REST_APP_SETTINGS_ERROR'));\n\t\t});\n\t}\n\n\tisReadySave(): boolean\n\t{\n\t\tlet isAllFieldReady = true;\n\n\t\tthis.#formConstructor.getFields().forEach((field) => {\n\t\t\tif (!field.isReadySave())\n\t\t\t{\n\t\t\t\tisAllFieldReady = false;\n\t\t\t}\n\t\t});\n\n\t\treturn isAllFieldReady;\n\t}\n\n\tsave(data): void\n\t{\n\t\tajax.runAction('rest.einvoice.save', {\n\t\t\tmode: 'class',\n\t\t\tdata: data,\n\t\t}).then(() => {\n\t\t\tif (Type.isNil(this.#redirect))\n\t\t\t{\n\t\t\t\ttop.BX.SidePanel.Instance.close();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\ttop.document.location.href = this.#redirect;\n\t\t\t}\n\t\t}).catch((response) => {\n\t\t\tconst errors = response.errors;\n\t\t\tlet { fieldErrors, otherErrors } = AppSettings.formatErrors(errors);\n\t\t\tthis.#formConstructor.showFieldErrors(fieldErrors);\n\t\t\tif (Type.isArrayFilled(otherErrors))\n\t\t\t{\n\t\t\t\tthis.#formConstructor.showTextInBalloon(Loc.getMessage('REST_APP_SETTINGS_ERROR'));\n\t\t\t}\n\n\t\t\tconst buttonWaitState = BX.UI.ButtonPanel.getContainer().querySelector('.ui-btn-wait');\n\n\t\t\tif (buttonWaitState)\n\t\t\t{\n\t\t\t\tDom.removeClass(buttonWaitState, 'ui-btn-wait');\n\t\t\t}\n\t\t\tBX.UI.ButtonPanel.hide();\n\t\t});\n\t}\n\n\tstatic formatErrors(errors: Array): Object\n\t{\n\t\tlet fieldErrors = {};\n\t\tlet otherErrors = [];\n\t\terrors.forEach((error) => {\n\t\t\tif (Type.isStringFilled(error.customData?.fieldName))\n\t\t\t{\n\t\t\t\tArray.isArray(fieldErrors[error.customData?.fieldName]) ?\n\t\t\t\t\tfieldErrors[error.customData?.fieldName].push(error.message) :\n\t\t\t\t\tfieldErrors[error.customData?.fieldName] = [error.message];\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\totherErrors.push(error.message)\n\t\t\t}\n\t\t});\n\n\t\treturn {\n\t\t\tfieldErrors: fieldErrors,\n\t\t\totherErrors: otherErrors\n\t\t};\n\t}\n}"],"names":["AppSettings","options","formConstructor","FormConstructor","Error","Type","isElementNode","wrapper","setFormConstructor","isStringFilled","handler","clientId","setRedirect","redirect","Loader","target","Tag","render","url","reqExp","RegExp","location","host","match","isNil","renderTo","subscribe","event","form","data","settings","save","isReadySave","BX","UI","ButtonPanel","show","hide","reload","unsubscribeAll","unsubscribeEvents","subscribeEvents","Dom","append","console","log","ajax","runComponentAction","mode","getFormData","then","response","steps","STEPS","HANDLER","CLIENT_ID","REDIRECT","remove","errors","showTextInBalloon","Loc","getMessage","isAllFieldReady","getFields","forEach","field","runAction","top","SidePanel","Instance","close","document","href","formatErrors","fieldErrors","otherErrors","showFieldErrors","isArrayFilled","buttonWaitState","getContainer","querySelector","removeClass","error","customData","fieldName","Array","isArray","push","message","EventEmitter"],"mappings":"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"}