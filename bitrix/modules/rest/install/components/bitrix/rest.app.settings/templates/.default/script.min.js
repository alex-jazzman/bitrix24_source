this.BX=this.BX||{};(function(e,s,a,t,l){"use strict";var i;function r(e,s,a){n(e,s);s.set(e,a)}function n(e,s){if(s.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var o=new WeakMap;var b=new WeakMap;var c=new WeakMap;var d=new WeakMap;var v=new WeakMap;var u=new WeakMap;var p=new WeakMap;var h=function(e){babelHelpers.inherits(t,e);function t(e){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));r(babelHelpers.assertThisInitialized(n),o,{writable:true,value:void 0});r(babelHelpers.assertThisInitialized(n),b,{writable:true,value:void 0});r(babelHelpers.assertThisInitialized(n),c,{writable:true,value:void 0});r(babelHelpers.assertThisInitialized(n),d,{writable:true,value:void 0});r(babelHelpers.assertThisInitialized(n),v,{writable:true,value:void 0});r(babelHelpers.assertThisInitialized(n),u,{writable:true,value:void 0});r(babelHelpers.assertThisInitialized(n),p,{writable:true,value:void 0});if(!(e.formConstructor instanceof l.FormConstructor)){throw new Error('"formConstructor" is required parameters')}babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(n),c,null);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(n),v,s.Type.isElementNode(e.wrapper)?e.wrapper:null);n.setFormConstructor(e.formConstructor);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(n),b,s.Type.isStringFilled(e.handler)?e.handler:null);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(n),d,s.Type.isStringFilled(e.clientId)?e.clientId:null);n.setRedirect(e.redirect);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(n),u,new a.Loader({target:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(n),v)}));babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(n),p,s.Tag.render(i||(i=babelHelpers.taggedTemplateLiteral(['<div class="rest-app-settings-overlay"></div>']))));return n}babelHelpers.createClass(t,[{key:"setRedirect",value:function e(a){var t=new RegExp("^(?:/|https?://"+location.host+")","g");if(s.Type.isStringFilled(a)&&!!a.match(t)){babelHelpers.classPrivateFieldSet(this,c,a)}}},{key:"show",value:function e(){if(s.Type.isNil(babelHelpers.classPrivateFieldGet(this,v))){throw new Error('Property "wrapper" is undefined')}babelHelpers.classPrivateFieldGet(this,o).renderTo(babelHelpers.classPrivateFieldGet(this,v))}},{key:"subscribeEvents",value:function e(){var s=this;if(!(babelHelpers.classPrivateFieldGet(this,o)instanceof l.FormConstructor)){return}babelHelpers.classPrivateFieldGet(this,o).subscribe("onSave",(function(e){var a=e.data.form;var t={settings:a,handler:babelHelpers.classPrivateFieldGet(s,b)};s.save(t)}));babelHelpers.classPrivateFieldGet(this,o).subscribe("onReadySave",(function(){if(s.isReadySave()){BX.UI.ButtonPanel.show()}else{BX.UI.ButtonPanel.hide()}}));babelHelpers.classPrivateFieldGet(this,o).subscribe("onUnreadySave",(function(){BX.UI.ButtonPanel.hide()}));babelHelpers.classPrivateFieldGet(this,o).subscribe("onFieldChange",(function(){s.reload()}))}},{key:"unsubscribeEvents",value:function e(){if(!(babelHelpers.classPrivateFieldGet(this,o)instanceof l.FormConstructor)){return}babelHelpers.classPrivateFieldGet(this,o).unsubscribeAll("onSave");babelHelpers.classPrivateFieldGet(this,o).unsubscribeAll("onReadySave");babelHelpers.classPrivateFieldGet(this,o).unsubscribeAll("onUnreadySave");babelHelpers.classPrivateFieldGet(this,o).unsubscribeAll("onFieldChange")}},{key:"setFormConstructor",value:function e(s){this.unsubscribeEvents();babelHelpers.classPrivateFieldSet(this,o,s);this.subscribeEvents()}},{key:"reload",value:function e(){var a=this;s.Dom.append(babelHelpers.classPrivateFieldGet(this,p),babelHelpers.classPrivateFieldGet(this,v));babelHelpers.classPrivateFieldGet(this,u).show();if(s.Type.isNil(babelHelpers.classPrivateFieldGet(this,d))){console.log('Property "clientId" is undefined');return}s.ajax.runComponentAction("bitrix:rest.app.settings","reload",{mode:"class",data:{clientId:babelHelpers.classPrivateFieldGet(this,d),settings:babelHelpers.classPrivateFieldGet(this,o).getFormData()}}).then((function(e){var t=e.data;a.setFormConstructor(new l.FormConstructor({steps:t.STEPS}));babelHelpers.classPrivateFieldSet(a,b,s.Type.isStringFilled(t.HANDLER)?t.HANDLER:babelHelpers.classPrivateFieldGet(a,b));babelHelpers.classPrivateFieldSet(a,d,s.Type.isStringFilled(t.CLIENT_ID)?t.CLIENT_ID:babelHelpers.classPrivateFieldGet(a,d));a.setRedirect(t.REDIRECT);a.show();babelHelpers.classPrivateFieldGet(a,u).hide();s.Dom.remove(babelHelpers.classPrivateFieldGet(a,p))}))["catch"]((function(e){console.log(e.errors);babelHelpers.classPrivateFieldGet(a,o).showTextInBalloon(s.Loc.getMessage("REST_APP_SETTINGS_ERROR"))}))}},{key:"isReadySave",value:function e(){var s=true;babelHelpers.classPrivateFieldGet(this,o).getFields().forEach((function(e){if(!e.isReadySave()){s=false}}));return s}},{key:"save",value:function e(a){var l=this;s.ajax.runAction("rest.einvoice.save",{mode:"class",data:a}).then((function(){if(s.Type.isNil(babelHelpers.classPrivateFieldGet(l,c))){top.BX.SidePanel.Instance.close()}else{top.document.location.href=babelHelpers.classPrivateFieldGet(l,c)}}))["catch"]((function(e){var a=e.errors;var i=t.formatErrors(a),r=i.fieldErrors,n=i.otherErrors;babelHelpers.classPrivateFieldGet(l,o).showFieldErrors(r);if(s.Type.isArrayFilled(n)){babelHelpers.classPrivateFieldGet(l,o).showTextInBalloon(s.Loc.getMessage("REST_APP_SETTINGS_ERROR"))}var b=BX.UI.ButtonPanel.getContainer().querySelector(".ui-btn-wait");if(b){s.Dom.removeClass(b,"ui-btn-wait")}BX.UI.ButtonPanel.hide()}))}}],[{key:"formatErrors",value:function e(a){var t={};var l=[];a.forEach((function(e){var a;if(s.Type.isStringFilled((a=e.customData)===null||a===void 0?void 0:a.fieldName)){var i,r,n;Array.isArray(t[(i=e.customData)===null||i===void 0?void 0:i.fieldName])?t[(r=e.customData)===null||r===void 0?void 0:r.fieldName].push(e.message):t[(n=e.customData)===null||n===void 0?void 0:n.fieldName]=[e.message]}else{l.push(e.message)}}));return{fieldErrors:t,otherErrors:l}}}]);return t}(t.EventEmitter);e.AppSettings=h})(this.BX.Rest=this.BX.Rest||{},BX,BX,BX.Event,BX.Rest);
//# sourceMappingURL=script.map.js