{"version":3,"file":"script.js","sources":["src/index.js"],"sourcesContent":["import { Dom, ajax, Loc, Runtime } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport { Button, ButtonIcon, ButtonSize, ButtonColor } from 'ui.buttons';\nimport { UserStatus } from 'bizproc.task';\nimport { MessageBox } from 'ui.dialogs.messagebox';\n\nimport './style.css';\nimport 'sidepanel';\n\ntype TaskButton = {\n\tTARGET_USER_STATUS: number,\n\tNAME: string,\n\tVALUE: string,\n\tTEXT: string,\n};\n\nexport class WorkflowInfo\n{\n\tcurrentUserId: number;\n\tworkflowId: string;\n\ttaskId: number;\n\ttaskUserId: number;\n\ttaskButtons: ?Array<TaskButton>;\n\ttaskForm: ?HTMLFormElement;\n\tbuttonsPanel: ?HTMLElement;\n\tcanDelegateTask: boolean;\n\n\tconstructor(options: {\n\t\tcurrentUserId: number,\n\t\tworkflowId: string,\n\t\ttaskId: number,\n\t\ttaskUserId: number,\n\t\ttaskButtons?: Array<TaskButton>,\n\t\ttaskForm?: HTMLFormElement,\n\t\tbuttonsPanel: HTMLElement,\n\t\tcanDelegateTask: boolean,\n\t})\n\t{\n\t\tthis.currentUserId = options.currentUserId;\n\t\tthis.workflowId = options.workflowId;\n\t\tthis.taskId = options.taskId;\n\t\tthis.taskUserId = options.taskUserId;\n\t\tthis.taskButtons = options.taskButtons;\n\t\tthis.taskForm = options.taskForm;\n\t\tthis.buttonsPanel = options.buttonsPanel;\n\t\tthis.canDelegateTask = options.canDelegateTask;\n\n\t\tthis.handleMarkAsRead = Runtime.debounce(this.#sendMarkAsRead, 100, this);\n\t}\n\n\tinit(): void\n\t{\n\t\tif (this.buttonsPanel)\n\t\t{\n\t\t\tthis.#renderButtons();\n\t\t}\n\n\t\tthis.handleMarkAsRead();\n\n\t\tEventEmitter.subscribe('OnUCCommentWasRead', (event) => {\n\t\t\tconst [xmlId] = event.getData();\n\t\t\tif (xmlId === `WF_${this.workflowId}`)\n\t\t\t{\n\t\t\t\tthis.handleMarkAsRead();\n\t\t\t}\n\t\t});\n\t}\n\n\t#renderButtons(): void\n\t{\n\t\tif (this.taskButtons)\n\t\t{\n\t\t\tthis.taskButtons.forEach((taskButton: TaskButton) => {\n\t\t\t\tconst targetStatus = new UserStatus(taskButton.TARGET_USER_STATUS);\n\t\t\t\tconst isDecline = targetStatus.isNo() || targetStatus.isCancel();\n\n\t\t\t\tconst button = new Button({\n\t\t\t\t\tcolor: isDecline ? ButtonColor.LIGHT_BORDER : ButtonColor.SUCCESS,\n\t\t\t\t\t// icon: isDecline ? ButtonIcon.CANCEL : ButtonIcon.DONE,\n\t\t\t\t\tround: true,\n\t\t\t\t\tsize: ButtonSize.MEDIUM,\n\t\t\t\t\t// noCaps: true,\n\t\t\t\t\ttext: taskButton.TEXT,\n\t\t\t\t\tonclick: (btn) => this.#handleTaskButtonClick(taskButton, btn),\n\t\t\t\t});\n\n\t\t\t\tDom.style(button.getContainer(), 'minWidth', '160px');\n\t\t\t\tDom.style(button.getContainer(), 'maxWidth', '200px');\n\t\t\t\tDom.attr(button.getContainer(), 'title', taskButton.TEXT);\n\t\t\t\tDom.append(button.getContainer(), this.buttonsPanel);\n\t\t\t});\n\t\t}\n\n\t\tif (this.canDelegateTask)\n\t\t{\n\t\t\tconst button = new Button({\n\t\t\t\tcolor: ButtonColor.LINK,\n\t\t\t\tsize: ButtonSize.MEDIUM,\n\t\t\t\t// noCaps: true,\n\t\t\t\ttext: Loc.getMessage('BPWFI_SLIDER_BUTTON_DELEGATE'),\n\t\t\t\tonclick: (btn) => this.#handleDelegateButtonClick(btn),\n\t\t\t});\n\n\t\t\tDom.style(button.getContainer(), 'minWidth', '160px');\n\t\t\tDom.style(button.getContainer(), 'maxWidth', '200px');\n\t\t\tDom.append(button.getContainer(), this.buttonsPanel);\n\t\t}\n\t}\n\n\t#handleTaskButtonClick(taskButton: TaskButton, uiButton: Button): void\n\t{\n\t\tconst formData = new FormData(this.taskForm);\n\t\tformData.append('taskId', this.taskId);\n\t\tformData.append(taskButton.NAME, taskButton.VALUE);\n\n\t\tuiButton.setDisabled(true);\n\n\t\tajax.runAction('bizproc.task.do', {\n\t\t\tdata: formData,\n\t\t}).then(() => {\n\t\t\tuiButton.setDisabled(false);\n\t\t\tBX.SidePanel.Instance.getSliderByWindow(window)?.close();\n\t\t}).catch((response) => {\n\t\t\tMessageBox.alert(response.errors.pop().message);\n\t\t\tuiButton.setDisabled(false);\n\t\t});\n\t}\n\n\t#handleDelegateButtonClick(uiButton: Button): void\n\t{\n\t\tuiButton.setDisabled(true);\n\n\t\tRuntime.loadExtension('ui.entity-selector').then((exports) => {\n\t\t\tconst { Dialog } = exports;\n\t\t\tuiButton.setDisabled(false);\n\n\t\t\tconst dialog = new Dialog({\n\t\t\t\ttargetNode: uiButton.getContainer(),\n\t\t\t\tcontext: 'bp-task-delegation',\n\t\t\t\tentities: [\n\t\t\t\t\t{\n\t\t\t\t\t\tid: 'user',\n\t\t\t\t\t\toptions: {\n\t\t\t\t\t\t\tintranetUsersOnly: true,\n\t\t\t\t\t\t\temailUsers: false,\n\t\t\t\t\t\t\tinviteEmployeeLink: false,\n\t\t\t\t\t\t\tinviteGuestLink: false,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tid: 'department',\n\t\t\t\t\t\toptions: {\n\t\t\t\t\t\t\tselectMode: 'usersOnly',\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tpopupOptions: {\n\t\t\t\t\tbindOptions: { forceBindPosition: true },\n\t\t\t\t},\n\t\t\t\tenableSearch: true,\n\t\t\t\tevents: {\n\t\t\t\t\t'Item:onSelect': (event) => {\n\t\t\t\t\t\tconst item = event.getData().item;\n\t\t\t\t\t\tthis.#delegateTask(item.getId());\n\t\t\t\t\t},\n\t\t\t\t\tonHide: (event) => {\n\t\t\t\t\t\tevent.getTarget().destroy();\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\thideOnSelect: true,\n\t\t\t\toffsetTop: 3,\n\t\t\t\tclearUnavailableItems: true,\n\t\t\t\tmultiple: false,\n\t\t\t});\n\n\t\t\tdialog.show();\n\t\t})\n\t\t\t.catch((e) => {\n\t\t\t\tconsole.error(e);\n\t\t\t\tuiButton.setDisabled(false);\n\t\t\t});\n\t}\n\n\t#delegateTask(toUserId: number): void\n\t{\n\t\tconst actionData = {\n\t\t\ttaskIds: [this.taskId],\n\t\t\tfromUserId: this.taskUserId || this.currentUserId,\n\t\t\ttoUserId,\n\t\t};\n\n\t\tajax.runAction('bizproc.task.delegate', { data: actionData })\n\t\t\t.then((response) => {\n\t\t\t\tBX.SidePanel.Instance.getSliderByWindow(window)?.close();\n\t\t\t}).catch((response) => {\n\t\t\t\tMessageBox.alert(response.errors.pop().message);\n\t\t\t});\n\t}\n\n\t#sendMarkAsRead(): void\n\t{\n\t\tajax.runAction('bizproc.workflow.comment.markAsRead', {\n\t\t\tdata: {\n\t\t\t\tworkflowId: this.workflowId,\n\t\t\t\tuserId: this.currentUserId,\n\t\t\t},\n\t\t});\n\t}\n}\n"],"names":["WorkflowInfo","constructor","options","currentUserId","workflowId","taskId","taskUserId","taskButtons","taskForm","buttonsPanel","canDelegateTask","handleMarkAsRead","Runtime","debounce","init","EventEmitter","subscribe","event","xmlId","getData","forEach","taskButton","targetStatus","UserStatus","TARGET_USER_STATUS","isDecline","isNo","isCancel","button","Button","color","ButtonColor","LIGHT_BORDER","SUCCESS","round","size","ButtonSize","MEDIUM","text","TEXT","onclick","btn","Dom","style","getContainer","attr","append","LINK","Loc","getMessage","uiButton","formData","FormData","NAME","VALUE","setDisabled","ajax","runAction","data","then","BX","SidePanel","Instance","getSliderByWindow","window","close","catch","response","MessageBox","alert","errors","pop","message","loadExtension","exports","Dialog","dialog","targetNode","context","entities","id","intranetUsersOnly","emailUsers","inviteEmployeeLink","inviteGuestLink","selectMode","popupOptions","bindOptions","forceBindPosition","enableSearch","events","item","getId","onHide","getTarget","destroy","hideOnSelect","offsetTop","clearUnavailableItems","multiple","show","e","console","error","toUserId","actionData","taskIds","fromUserId","userId"],"mappings":"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"}