this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,s,t,a,l,i,r,o,n,c,b,d,v,u,h,p,g){"use strict";class C{static createRoom(e){v.runAction(u.RestMethod.imCallBetaCreateRoom,{data:{chatId:e}})}}let L=e=>e,P;const B=async e=>{const s=()=>{const s=l.getSelectedItems();const t=F(s);e.onSelect({users:t})};const t=()=>{l.hide()};const{Dialog:a}=await h.Runtime.loadExtension("ui.entity-selector");const l=new a({targetNode:e.bindElement,width:400,enableSearch:true,dropdownMode:true,context:"IM_CHAT_SEARCH",entities:[{id:"user",dynamicLoad:true,itemOptions:{default:{linkTitle:"",link:""}},options:{inviteEmployeeLink:false,"!userId":g.Core.getUserId()},filters:[{id:"im.userDataFilter"}]}],footer:H(s,t)});l.show();return Promise.resolve({close:()=>{l.hide()}})};const F=e=>e.map((e=>({id:e.id,name:e.title.text,avatar:e.avatar,avatar_hr:e.avatar,gender:e.customData.get("imUser").GENDER})));const H=(e,s)=>{const t=h.Loc.getMessage("IM_LIB_CALL_ADD_BUTTON");const a=h.Loc.getMessage("IM_LIB_CALL_CANCEL_BUTTON");return h.Tag.render(P||(P=L`
		<button class="ui-btn ui-btn-xs ui-btn-primary" onclick="${0}">${0}</button>
		<button class="ui-btn ui-btn-xs ui-btn-light-border" onclick="${0}">${0}</button>
	`),e,t,s,a)};var f=babelHelpers.classPrivateFieldLooseKey("controller");var y=babelHelpers.classPrivateFieldLooseKey("store");var m=babelHelpers.classPrivateFieldLooseKey("restClient");var E=babelHelpers.classPrivateFieldLooseKey("onCallJoinHandler");var A=babelHelpers.classPrivateFieldLooseKey("onCallLeaveHandler");var I=babelHelpers.classPrivateFieldLooseKey("onCallDestroyHandler");var O=babelHelpers.classPrivateFieldLooseKey("getController");var M=babelHelpers.classPrivateFieldLooseKey("subscribeToEvents");var S=babelHelpers.classPrivateFieldLooseKey("subscribeToCallEvents");var D=babelHelpers.classPrivateFieldLooseKey("unsubscribeFromCallEvents");var j=babelHelpers.classPrivateFieldLooseKey("onCallCreated");var X=babelHelpers.classPrivateFieldLooseKey("onCallJoin");var K=babelHelpers.classPrivateFieldLooseKey("onCallLeave");var T=babelHelpers.classPrivateFieldLooseKey("onCallDestroy");var w=babelHelpers.classPrivateFieldLooseKey("onOpenChat");var R=babelHelpers.classPrivateFieldLooseKey("checkCallSupport");var U=babelHelpers.classPrivateFieldLooseKey("checkUserCallSupport");var _=babelHelpers.classPrivateFieldLooseKey("checkChatCallSupport");var k=babelHelpers.classPrivateFieldLooseKey("pushServerIsActive");var N=babelHelpers.classPrivateFieldLooseKey("getCurrentDialogId");var x=babelHelpers.classPrivateFieldLooseKey("getDialog");var V=babelHelpers.classPrivateFieldLooseKey("getChatId");var J=babelHelpers.classPrivateFieldLooseKey("isUser");var $=babelHelpers.classPrivateFieldLooseKey("getChatInfo");var q=babelHelpers.classPrivateFieldLooseKey("prepareChatInfo");var G=babelHelpers.classPrivateFieldLooseKey("prepareCall");var W=babelHelpers.classPrivateFieldLooseKey("getChatUserCounter");class Z{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){Object.defineProperty(this,W,{value:Ce});Object.defineProperty(this,G,{value:ge});Object.defineProperty(this,q,{value:pe});Object.defineProperty(this,$,{value:he});Object.defineProperty(this,J,{value:ue});Object.defineProperty(this,V,{value:ve});Object.defineProperty(this,x,{value:de});Object.defineProperty(this,N,{value:be});Object.defineProperty(this,k,{value:ce});Object.defineProperty(this,_,{value:ne});Object.defineProperty(this,U,{value:oe});Object.defineProperty(this,R,{value:re});Object.defineProperty(this,w,{value:ie});Object.defineProperty(this,T,{value:le});Object.defineProperty(this,K,{value:ae});Object.defineProperty(this,X,{value:te});Object.defineProperty(this,j,{value:se});Object.defineProperty(this,D,{value:ee});Object.defineProperty(this,S,{value:Y});Object.defineProperty(this,M,{value:Q});Object.defineProperty(this,O,{value:z});Object.defineProperty(this,f,{writable:true,value:void 0});Object.defineProperty(this,y,{writable:true,value:void 0});Object.defineProperty(this,m,{writable:true,value:void 0});Object.defineProperty(this,E,{writable:true,value:void 0});Object.defineProperty(this,A,{writable:true,value:void 0});Object.defineProperty(this,I,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,y)[y]=g.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,m)[m]=g.Core.getRestClient();if(this.isAvailable()){babelHelpers.classPrivateFieldLooseBase(this,f)[f]=babelHelpers.classPrivateFieldLooseBase(this,O)[O]()}babelHelpers.classPrivateFieldLooseBase(this,M)[M]();babelHelpers.classPrivateFieldLooseBase(this,E)[E]=babelHelpers.classPrivateFieldLooseBase(this,X)[X].bind(this);babelHelpers.classPrivateFieldLooseBase(this,A)[A]=babelHelpers.classPrivateFieldLooseBase(this,K)[K].bind(this);babelHelpers.classPrivateFieldLooseBase(this,I)[I]=babelHelpers.classPrivateFieldLooseBase(this,T)[T].bind(this)}isAvailable(){const{callInstalled:e}=h.Extension.getSettings("im.v2.lib.call");return e===true}async sendBroadcastRequest(e){if(!this.isAvailable()){return Promise.resolve([])}if(!s.DesktopApi.isDesktop()){return Promise.resolve([])}return await babelHelpers.classPrivateFieldLooseBase(this,f)[f].callMultiBroadcastClient.broadcastRequest(e,{timeout:100})}createBetaCallRoom(e){if(!this.isAvailable()){return}C.createRoom(e)}startCall(e,s=true,t=""){if(!this.isAvailable()){return}n.Logger.warn("CallManager: startCall",e,s);babelHelpers.classPrivateFieldLooseBase(this,G)[G](e);babelHelpers.classPrivateFieldLooseBase(this,$)[$](e).then((t=>{babelHelpers.classPrivateFieldLooseBase(this,f)[f].startCall(e,s,t)}))}joinCall(e,s,t,a=true){if(!this.isAvailable()){return}n.Logger.warn("CallManager: joinCall",e,s,a);babelHelpers.classPrivateFieldLooseBase(this,G)[G](t);babelHelpers.classPrivateFieldLooseBase(this,$)[$](t).then((t=>{babelHelpers.classPrivateFieldLooseBase(this,f)[f].joinCall(e,s,a,{chatInfo:t})}))}leaveCurrentCall(){if(!this.isAvailable()){return}n.Logger.warn("CallManager: leaveCurrentCall");babelHelpers.classPrivateFieldLooseBase(this,f)[f].leaveCurrentCall()}onAnswerButtonClick(e,s){if(!this.isAvailable()){return}babelHelpers.classPrivateFieldLooseBase(this,f)[f].onAnswerButtonClick(e,s)}onJoinFromRecentItem(){babelHelpers.classPrivateFieldLooseBase(this,f)[f].closeCallNotification()}deleteRecentCall(e){babelHelpers.classPrivateFieldLooseBase(this,y)[y].dispatch("recent/calls/deleteActiveCall",{dialogId:e})}foldCurrentCall(){if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()||!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasVisibleCall()){return}babelHelpers.classPrivateFieldLooseBase(this,f)[f].fold()}unfoldCurrentCall(){if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()){return}babelHelpers.classPrivateFieldLooseBase(this,f)[f].unfold()}getCurrentCallDialogId(){var e,s;if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()){return""}return(e=babelHelpers.classPrivateFieldLooseBase(this,f)[f])==null?void 0:(s=e.currentCall)==null?void 0:s.associatedEntity.id}getCurrentCall(){if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()){return false}return babelHelpers.classPrivateFieldLooseBase(this,f)[f].currentCall}getCurrentUser(){const e=g.Core.getUserId();return g.Core.getStore().getters["users/get"](e)}hasCurrentCall(){if(!this.isAvailable()){return false}return babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()}hasCurrentScreenSharing(){if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()){return false}return babelHelpers.classPrivateFieldLooseBase(this,f)[f].currentCall.isScreenSharingStarted()}hasVisibleCall(){if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()){return false}return babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasVisibleCall()}startTest(){if(!this.isAvailable()){return}babelHelpers.classPrivateFieldLooseBase(this,f)[f].test()}toggleDebugFlag(e){if(!babelHelpers.classPrivateFieldLooseBase(this,f)[f]){return}babelHelpers.classPrivateFieldLooseBase(this,f)[f].debug=e}chatCanBeCalled(e){if(!this.isAvailable()){return false}const s=babelHelpers.classPrivateFieldLooseBase(this,R)[R](e);const t=babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["recent/calls/hasActiveCall"](e);return s&&!t}hasActiveCurrentCall(e){return babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["recent/calls/hasActiveCall"](e)&&this.getCurrentCallDialogId()===e}hasActiveAnotherCall(e){return babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["recent/calls/hasActiveCall"]()&&!this.hasActiveCurrentCall(e)}getCallUserLimit(){return BX.Call.Util.getUserLimit()}isChatUserLimitExceeded(e){return babelHelpers.classPrivateFieldLooseBase(this,W)[W](e)>this.getCallUserLimit()}updateRecentCallsList(e){const s=babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["recent/calls/get"];const t=new Map(Object.values(e).map((e=>[e.ID,e])));t.forEach((e=>{const s=babelHelpers.classPrivateFieldLooseBase(this,f)[f].isLegacyCall(e.PROVIDER,e.SCHEME)?l.EngineLegacy.instantiateCall(e,e.USERS,e.LOG_TOKEN,e.CONNECTION_DATA,e.USER_DATA):i.CallEngine.instantiateCall(e,e.CALL_TOKEN,e.LOG_TOKEN,e.USER_DATA);babelHelpers.classPrivateFieldLooseBase(this,S)[S](s)}));s.filter((e=>!t.has(e.call.id))).forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,y)[y].dispatch("recent/calls/deleteActiveCall",{dialogId:e.dialogId})}))}isConference(e){const s=babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["chats/get"](e);return s.type===u.ChatType.videoconf}}function z(){return new l.Controller({init:true,language:g.Core.getLanguageId(),messengerFacade:{getDefaultZIndex:()=>o.MessengerSlider.getInstance().getZIndex(),isMessengerOpen:()=>o.MessengerSlider.getInstance().isOpened(),isSliderFocused:()=>o.MessengerSlider.getInstance().isFocused(),isThemeDark:()=>false,openMessenger:e=>r.Messenger.openChat(e),openHistory:e=>r.Messenger.openChat(e),openSettings:()=>r.Messenger.openSettings(),openHelpArticle:()=>{},getContainer:()=>document.querySelector(`.${Z.viewContainerClass}`),getMessageCount:()=>babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["counters/getTotalChatCounter"],getCurrentDialogId:()=>babelHelpers.classPrivateFieldLooseBase(this,N)[N](),isPromoRequired:e=>c.PromoManager.getInstance().needToShow(e),repeatSound:(e,s,t)=>{b.SoundNotificationManager.getInstance().playLoop(e,s,t)},stopRepeatSound:e=>{b.SoundNotificationManager.getInstance().stop(e)},showUserSelector:B},events:{[l.Controller.Events.onPromoViewed]:e=>{const{code:s}=e.getData();c.PromoManager.getInstance().markAsWatched(s)},[l.Controller.Events.onOpenVideoConference]:e=>{var s;const{dialogId:t}=e.getData();const a=g.Core.getStore().getters["chats/get"](`chat${t}`,true);return r.Messenger.openConference({code:(s=a.public)==null?void 0:s.code})}}})}function Q(){t.EventEmitter.subscribe(u.EventType.layout.onLayoutChange,babelHelpers.classPrivateFieldLooseBase(this,w)[w].bind(this));t.EventEmitter.subscribe(u.EventType.layout.onOpenNotifications,this.foldCurrentCall.bind(this));t.EventEmitter.subscribe(u.EventType.call.onJoinFromRecentItem,this.onJoinFromRecentItem.bind(this));t.EventEmitter.subscribe("CallEvents::callCreated",babelHelpers.classPrivateFieldLooseBase(this,j)[j].bind(this))}function Y(e){e.addEventListener(BX.Call.Event.onJoin,babelHelpers.classPrivateFieldLooseBase(this,E)[E]);e.addEventListener(BX.Call.Event.onLeave,babelHelpers.classPrivateFieldLooseBase(this,A)[A]);e.addEventListener(BX.Call.Event.onDestroy,babelHelpers.classPrivateFieldLooseBase(this,I)[I])}function ee(e){e.removeEventListener(BX.Call.Event.onJoin,babelHelpers.classPrivateFieldLooseBase(this,E)[E]);e.removeEventListener(BX.Call.Event.onLeave,babelHelpers.classPrivateFieldLooseBase(this,A)[A]);e.removeEventListener(BX.Call.Event.onDestroy,babelHelpers.classPrivateFieldLooseBase(this,I)[I])}function se(e){const{call:s}=e.getData()[0];const t=babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["recent/calls/getCallByDialog"](s.associatedEntity.id);const a=(t==null?void 0:t.call.uuid)!==s.uuid;const i=s.state===l.State.Connected||s.state===l.State.Proceeding?u.RecentCallStatus.joined:u.RecentCallStatus.waiting;if(a){if(t){babelHelpers.classPrivateFieldLooseBase(this,D)[D](t.call)}babelHelpers.classPrivateFieldLooseBase(this,S)[S](s);babelHelpers.classPrivateFieldLooseBase(this,y)[y].dispatch("recent/calls/addActiveCall",{dialogId:s.associatedEntity.id,name:s.associatedEntity.name,call:s,state:i});return}babelHelpers.classPrivateFieldLooseBase(this,y)[y].dispatch("recent/calls/updateActiveCall",{dialogId:s.associatedEntity.id,fields:{name:s.associatedEntity.name,state:i,call:s}})}function te(e){babelHelpers.classPrivateFieldLooseBase(this,y)[y].dispatch("recent/calls/updateActiveCall",{dialogId:e.call.associatedEntity.id,fields:{state:u.RecentCallStatus.joined}})}function ae(e){babelHelpers.classPrivateFieldLooseBase(this,y)[y].dispatch("recent/calls/updateActiveCall",{dialogId:e.call.associatedEntity.id,fields:{state:u.RecentCallStatus.waiting}})}function le(e){const s=e.call.associatedEntity.id;const t=babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["recent/calls/getCallByDialog"](s);if(t){babelHelpers.classPrivateFieldLooseBase(this,D)[D](t.call)}if((t==null?void 0:t.call.uuid)===e.call.uuid){babelHelpers.classPrivateFieldLooseBase(this,y)[y].dispatch("recent/calls/deleteActiveCall",{dialogId:s})}}function ie(e){const s=this.getCurrentCallDialogId();const t=e.getData().to.entityId;if(s===t){return}this.foldCurrentCall()}function re(e){if(!babelHelpers.classPrivateFieldLooseBase(this,k)[k]()||!BX.Call.Util.isWebRTCSupported()){return false}const s=Number(e);return s>0?babelHelpers.classPrivateFieldLooseBase(this,U)[U](s):babelHelpers.classPrivateFieldLooseBase(this,_)[_](e)}function oe(e){const s=babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["users/get"](e);const t=s.type===u.UserType.bot;return s&&s.status!=="guest"&&!t&&!s.network&&s.id!==g.Core.getUserId()&&Boolean(s.lastActivityDate)}function ne(e){const s=babelHelpers.classPrivateFieldLooseBase(this,W)[W](e);return(s>1||this.isConference(e))&&s<=this.getCallUserLimit()}function ce(){return true}function be(){const e=babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["application/getLayout"];if(e.name!==u.Layout.chat){return""}return e.entityId}function de(e){return babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["chats/get"](e)}function ve(e){var s;return(s=babelHelpers.classPrivateFieldLooseBase(this,x)[x](e))==null?void 0:s.chatId}function ue(e){const s=babelHelpers.classPrivateFieldLooseBase(this,x)[x](e);return(s==null?void 0:s.type)===u.ChatType.user}function he(e){const s=babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["chats/get"](e,true);if(s.chatId===0){return r.Messenger.openChat(e).then((()=>{const s=babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["chats/get"](e,true);return babelHelpers.classPrivateFieldLooseBase(this,q)[q](s)})).catch((e=>{n.Logger.error("Open chat error",e);return babelHelpers.classPrivateFieldLooseBase(this,q)[q](s)}))}return new Promise((e=>{e(babelHelpers.classPrivateFieldLooseBase(this,q)[q](s))}))}function pe(e){return{advanced:{chatType:e.type,entityType:e.entityType,entityId:e.entityId,entityData1:e.entityData1,entityData2:e.entityData2,entityData3:e.entityData3},id:e.dialogId,chatId:e.chatId,name:e.name,avatar:e.avatar||"/bitrix/js/im/images/blank.gif",avatarColor:e.color,type:"chat",userCounter:e.userCounter}}function ge(e){if(!this.isAvailable()){return}const s=g.Core.getUserId();const t=g.Core.getStore().getters["users/get"](s);const a={dialogId:e,userData:{[s]:t}};if(babelHelpers.classPrivateFieldLooseBase(this,J)[J](e)){const s=g.Core.getStore().getters["users/get"](e);a["user"]=s.id;a["userData"][s.id]=s}babelHelpers.classPrivateFieldLooseBase(this,f)[f].prepareCall(a)}function Ce(e){const{userCounter:s}=babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["chats/get"](e,true);return s}Z.viewContainerClass="bx-im-messenger__call_container";e.CallManager=Z})(this.BX.Messenger.v2.Lib=this.BX.Messenger.v2.Lib||{},BX.Messenger.v2.Lib,BX.Event,BX.Vue3.Vuex,BX.Call,BX,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Lib,BX.Messenger.v2.Const,BX,BX.UI,BX.Messenger.v2.Application);
//# sourceMappingURL=call.bundle.map.js