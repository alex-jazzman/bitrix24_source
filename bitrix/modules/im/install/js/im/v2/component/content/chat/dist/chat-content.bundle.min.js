this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Component=this.BX.Messenger.v2.Component||{};(function(t,e,n,a,i,s,o,r,l,d,c,h,g,u,m,C,p,v,I,_,b,T,E,M,S,f,y){"use strict";const L={chatHeader:64,pinnedMessages:53,blockedTextarea:50,dropAreaOffset:16};const x={video:{id:"video",locCode:"IM_CONTENT_CHAT_HEADER_VIDEOCALL",start:t=>{l.Messenger.startVideoCall(t)}},audio:{id:"audio",locCode:"IM_CONTENT_CHAT_HEADER_CALL_MENU_AUDIO",start:t=>{l.Messenger.startVideoCall(t,false)}},beta:{id:"beta",locCode:"IM_CONTENT_CHAT_HEADER_CALL_MENU_BETA_2",start:t=>{const e=C.Core.getStore().getters["chats/get"](t);d.CallManager.getInstance().createBetaCallRoom(e.chatId)}}};let A=t=>t,B;var P=babelHelpers.classPrivateFieldLooseKey("getDelimiter");var N=babelHelpers.classPrivateFieldLooseKey("getVideoCallItem");var O=babelHelpers.classPrivateFieldLooseKey("getAudioCallItem");var D=babelHelpers.classPrivateFieldLooseKey("getPersonalPhoneItem");var k=babelHelpers.classPrivateFieldLooseKey("getWorkPhoneItem");var H=babelHelpers.classPrivateFieldLooseKey("getInnerPhoneItem");var w=babelHelpers.classPrivateFieldLooseKey("getZoomItem");var R=babelHelpers.classPrivateFieldLooseKey("getUserPhoneHtml");var $=babelHelpers.classPrivateFieldLooseKey("isCallAvailable");var U=babelHelpers.classPrivateFieldLooseKey("getUser");var F=babelHelpers.classPrivateFieldLooseKey("isUser");var X=babelHelpers.classPrivateFieldLooseKey("requestCreateZoomConference");class z extends o.BaseMenu{constructor(){super();Object.defineProperty(this,X,{value:et});Object.defineProperty(this,F,{value:tt});Object.defineProperty(this,U,{value:Q});Object.defineProperty(this,$,{value:Y});Object.defineProperty(this,R,{value:Z});Object.defineProperty(this,w,{value:W});Object.defineProperty(this,H,{value:J});Object.defineProperty(this,k,{value:V});Object.defineProperty(this,D,{value:K});Object.defineProperty(this,O,{value:j});Object.defineProperty(this,N,{value:G});Object.defineProperty(this,P,{value:q});this.id="bx-im-chat-header-call-menu"}getMenuOptions(){return{...super.getMenuOptions(),className:this.getMenuClassName(),angle:true,offsetLeft:4,offsetTop:5}}getMenuClassName(){return"bx-im-messenger__scope bx-im-chat-header-call-button__scope"}getMenuItems(){return[babelHelpers.classPrivateFieldLooseBase(this,N)[N](),babelHelpers.classPrivateFieldLooseBase(this,O)[O](),babelHelpers.classPrivateFieldLooseBase(this,w)[w](),babelHelpers.classPrivateFieldLooseBase(this,P)[P](),babelHelpers.classPrivateFieldLooseBase(this,D)[D](),babelHelpers.classPrivateFieldLooseBase(this,k)[k](),babelHelpers.classPrivateFieldLooseBase(this,H)[H]()]}}function q(){return{delimiter:true}}function G(){const t=babelHelpers.classPrivateFieldLooseBase(this,$)[$](this.context.dialogId);return{text:m.Loc.getMessage("IM_CONTENT_CHAT_HEADER_VIDEOCALL"),onclick:()=>{if(!t){return}x.video.start(this.context.dialogId);this.emit(z.events.onMenuItemClick,x.video);this.menuInstance.close()},disabled:!t}}function j(){const t=babelHelpers.classPrivateFieldLooseBase(this,$)[$](this.context.dialogId);return{text:m.Loc.getMessage("IM_CONTENT_CHAT_HEADER_CALL_MENU_AUDIO"),onclick:()=>{if(!t){return}x.audio.start(this.context.dialogId);this.emit(z.events.onMenuItemClick,x.audio);this.menuInstance.close()},disabled:!t}}function K(){if(!babelHelpers.classPrivateFieldLooseBase(this,F)[F]()){return null}const{phones:t}=babelHelpers.classPrivateFieldLooseBase(this,U)[U]();if(!t.personalMobile){return null}const e=m.Loc.getMessage("IM_CONTENT_CHAT_HEADER_CALL_MENU_PERSONAL_PHONE");return{className:"menu-popup-no-icon bx-im-chat-header-call-button-menu__item",html:babelHelpers.classPrivateFieldLooseBase(this,R)[R](e,t.personalMobile),onclick:()=>{l.Messenger.startPhoneCall(t.personalMobile);this.menuInstance.close()}}}function V(){if(!babelHelpers.classPrivateFieldLooseBase(this,F)[F]()){return null}const{phones:t}=babelHelpers.classPrivateFieldLooseBase(this,U)[U]();if(!t.workPhone){return null}const e=m.Loc.getMessage("IM_CONTENT_CHAT_HEADER_CALL_MENU_WORK_PHONE");return{className:"menu-popup-no-icon bx-im-chat-header-call-button-menu__item",html:babelHelpers.classPrivateFieldLooseBase(this,R)[R](e,t.workPhone),onclick:()=>{l.Messenger.startPhoneCall(t.workPhone);this.menuInstance.close()}}}function J(){if(!babelHelpers.classPrivateFieldLooseBase(this,F)[F]()){return null}const{phones:t}=babelHelpers.classPrivateFieldLooseBase(this,U)[U]();if(!t.innerPhone){return null}const e=m.Loc.getMessage("IM_CONTENT_CHAT_HEADER_CALL_MENU_INNER_PHONE_MSGVER_1");return{className:"menu-popup-no-icon bx-im-chat-header-call-button-menu__item",html:babelHelpers.classPrivateFieldLooseBase(this,R)[R](e,t.innerPhone),onclick:()=>{l.Messenger.startPhoneCall(t.innerPhone);this.menuInstance.close()}}}function W(){const t=m.Extension.getSettings("im.v2.component.content.chat");const e=t.get("isZoomActive",false);if(!e){return null}const n=["bx-im-chat-header-call-button-menu__zoom","menu-popup-no-icon"];const a=t.get("isZoomFeatureAvailable",false);if(!a){n.push("--disabled")}return{className:n.join(" "),text:m.Loc.getMessage("IM_CONTENT_CHAT_HEADER_CALL_MENU_ZOOM"),onclick:()=>{if(!a){BX.UI.InfoHelper.show("limit_video_conference_zoom");return}babelHelpers.classPrivateFieldLooseBase(this,X)[X](this.context.dialogId);this.menuInstance.close()}}}function Z(t,e){return m.Tag.render(B||(B=A`
			<span class="bx-im-chat-header-call-button-menu__phone_container">
				<span class="bx-im-chat-header-call-button-menu__phone_title">${0}</span>
				<span class="bx-im-chat-header-call-button-menu__phone_number">${0}</span>
			</span>
		`),t,e)}function Y(t){if(C.Core.getStore().getters["recent/calls/hasActiveCall"](t)&&d.CallManager.getInstance().getCurrentCallDialogId()===t){return true}if(C.Core.getStore().getters["recent/calls/hasActiveCall"]()){return false}const e=d.CallManager.getInstance().chatCanBeCalled(t);const n=v.PermissionManager.getInstance().canPerformAction(f.ChatActionType.call,t);return e&&n}function Q(){if(!babelHelpers.classPrivateFieldLooseBase(this,F)[F]()){return null}return C.Core.getStore().getters["users/get"](this.context.dialogId)}function tt(){return this.context.type===f.ChatType.user}function et(t){r.runAction(f.RestMethod.imV2CallZoomCreate,{data:{dialogId:t}}).catch((t=>{let e=m.Loc.getMessage("IM_CONTENT_CHAT_HEADER_CALL_MENU_ZOOM_CREATE_ERROR");const n=t.some((t=>t.code==="ZOOM_CONNECTED_ERROR"));if(n){const t=`/company/personal/user/${C.Core.getUserId()}/social_services/`;e=m.Loc.getMessage("IM_CONTENT_CHAT_HEADER_CALL_MENU_ZOOM_CONNECT_ERROR").replace("#HREF_START#",`<a href=${t}>`).replace("#HREF_END#","</>")}BX.UI.Notification.Center.notify({content:e})}))}z.events={onMenuItemClick:"onMenuItemClick"};const nt={props:{dialogId:{type:String,required:true}},emits:[],data(){return{lastCallType:""}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},isActive(){if(this.$store.getters["recent/calls/hasActiveCall"](this.dialogId)&&d.CallManager.getInstance().getCurrentCallDialogId()===this.dialogId){return true}if(this.$store.getters["recent/calls/hasActiveCall"]()){return false}const t=d.CallManager.getInstance().chatCanBeCalled(this.dialogId);const e=v.PermissionManager.getInstance().canPerformAction(f.ChatActionType.call,this.dialogId);return t&&e},isConference(){return this.dialog.type===f.ChatType.videoconf},callButtonText(){const t=x[this.lastCallType].locCode;return this.loc(t)}},created(){this.lastCallType=this.getLastCallChoice();this.subscribeToMenuItemClick()},methods:{startVideoCall(){if(!this.isActive){return}l.Messenger.startVideoCall(this.dialogId)},subscribeToMenuItemClick(){this.getCallMenu().subscribe(z.events.onMenuItemClick,(t=>{const{id:e}=t.getData();this.saveLastCallChoice(e)}))},getCallMenu(){if(!this.callMenu){this.callMenu=new z}return this.callMenu},onButtonClick(){if(!this.isActive){return}x[this.lastCallType].start(this.dialogId)},onMenuClick(){if(!this.shouldShowMenu()){return}this.getCallMenu().openMenu(this.dialog,this.$refs.menu)},onStartConferenceClick(){if(!this.isActive){return}l.Messenger.openConference({code:this.dialog.public.code})},getLastCallChoice(){const t=s.LocalStorageManager.getInstance().get(f.LocalStorageKey.lastCallType,x.video.id);if(t===x.beta.id&&!this.isBitrixCallEnabled()){return x.video.id}return t},saveLastCallChoice(t){this.lastCallType=t;s.LocalStorageManager.getInstance().set(f.LocalStorageKey.lastCallType,t)},shouldShowMenu(){return this.isActive||this.isBitrixCallEnabled()},isBitrixCallEnabled(){return false},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div\n\t\t\tv-if="isConference"\n\t\t\tclass="bx-im-chat-header-call-button__scope bx-im-chat-header-call-button__container --conference"\n\t\t\t:class="{'--disabled': !isActive}"\n\t\t\t@click="onStartConferenceClick"\n\t\t>\n\t\t\t<div class="bx-im-chat-header-call-button__text">\n\t\t\t\t{{ loc('IM_CONTENT_CHAT_HEADER_START_CONFERENCE') }}\n\t\t\t</div>\n\t\t</div>\n\t\t<div\n\t\t\tv-else\n\t\t\tclass="bx-im-chat-header-call-button__scope bx-im-chat-header-call-button__container"\n\t\t\t:class="{'--disabled': !isActive}"\n\t\t\t@click="onButtonClick"\n\t\t>\n\t\t\t<div class="bx-im-chat-header-call-button__text">\n\t\t\t\t{{ callButtonText }}\n\t\t\t</div>\n\t\t\t<div class="bx-im-chat-header-call-button__separator"></div>\n\t\t\t<div class="bx-im-chat-header-call-button__chevron_container" @click.stop="onMenuClick">\n\t\t\t\t<div class="bx-im-chat-header-call-button__chevron" ref="menu"></div>\n\t\t\t</div>\n\t\t</div>\n\t`};const at={[f.ChatEntityLinkType.tasks]:{className:"--task",loc:m.Loc.getMessage("IM_CONTENT_CHAT_HEADER_OPEN_TASK")},[f.ChatEntityLinkType.calendar]:{className:"--calendar",loc:m.Loc.getMessage("IM_CONTENT_CHAT_HEADER_OPEN_MEETING_MSGVER_1")},[f.ChatEntityLinkType.sonetGroup]:{className:"--group",loc:m.Loc.getMessage("IM_CONTENT_CHAT_HEADER_OPEN_GROUP_MSGVER_1")},[f.ChatEntityLinkType.mail]:{className:"--mail",loc:m.Loc.getMessage("IM_CONTENT_CHAT_HEADER_OPEN_MAIL_MSGVER_1")},[f.ChatEntityLinkType.contact]:{className:"--crm",loc:m.Loc.getMessage("IM_CONTENT_CHAT_HEADER_OPEN_CONTACT")},[f.ChatEntityLinkType.deal]:{className:"--crm",loc:m.Loc.getMessage("IM_CONTENT_CHAT_HEADER_OPEN_DEAL")},[f.ChatEntityLinkType.lead]:{className:"--crm",loc:m.Loc.getMessage("IM_CONTENT_CHAT_HEADER_OPEN_LEAD")},[f.ChatEntityLinkType.dynamic]:{className:"--crm",loc:m.Loc.getMessage("IM_CONTENT_CHAT_HEADER_OPEN_DYNAMIC_ELEMENT")}};const it={name:"EntityLink",props:{dialogId:{type:String,required:true}},data(){return{}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},entityType(){return this.dialog.entityLink.type},entityUrl(){return this.dialog.entityLink.url},containerClassName(){var t,e;return(t=(e=at[this.entityType])==null?void 0:e.className)!=null?t:""},linkText(){var t,e;return(t=(e=at[this.entityType])==null?void 0:e.loc)!=null?t:"Open entity"}},template:`\n\t\t<a :href="entityUrl" class="bx-im-chat-header-entity-link__container" :class="containerClassName" target="_blank">\n\t\t\t<div class="bx-im-chat-header-entity-link__icon"></div>\n\t\t\t<div class="bx-im-chat-header-entity-link__text">{{ linkText }}</div>\n\t\t\t<div class="bx-im-chat-header-entity-link__arrow"></div>\n\t\t</a>\n\t`};const st={[f.ChatType.openChannel]:"IM_CONTENT_CHAT_HEADER_CHANNEL_USER_COUNT",[f.ChatType.channel]:"IM_CONTENT_CHAT_HEADER_CHANNEL_USER_COUNT",default:"IM_CONTENT_CHAT_HEADER_USER_COUNT"};const ot={name:"GroupChatTitle",components:{EditableChatTitle:S.EditableChatTitle,EntityLink:it,LineLoader:S.LineLoader,FadeAnimation:c.FadeAnimation},props:{dialogId:{type:String,required:true}},emits:["membersClick","newTitle"],data(){return{}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},hasEntityLink(){var t;return Boolean((t=this.dialog.entityLink)==null?void 0:t.url)},userCounterPhraseCode(){var t;return(t=st[this.dialog.type])!=null?t:st.default},userCounterText(){return m.Loc.getMessagePlural(this.userCounterPhraseCode,this.dialog.userCounter,{"#COUNT#":this.dialog.userCounter})}},methods:{loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-chat-header__info">\n\t\t\t<EditableChatTitle :dialogId="dialogId" @newTitleSubmit="$emit('newTitle', $event)" />\n\t\t\t<LineLoader v-if="!dialog.inited" :width="50" :height="16" />\n\t\t\t<FadeAnimation :duration="100">\n\t\t\t\t<div v-if="dialog.inited" class="bx-im-chat-header__subtitle_container">\n\t\t\t\t\t<div\n\t\t\t\t\t\t:title="loc('IM_CONTENT_CHAT_HEADER_OPEN_MEMBERS')"\n\t\t\t\t\t\t@click="$emit('membersClick')"\n\t\t\t\t\t\tclass="bx-im-chat-header__subtitle_content --click"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ userCounterText }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<EntityLink v-if="hasEntityLink" :dialogId="dialogId" />\n\t\t\t\t</div>\n\t\t\t</FadeAnimation>\n\t\t</div>\n\t`};const rt=60*1e3;const lt={name:"UserTitle",components:{ChatTitle:S.ChatTitle},props:{dialogId:{type:String,required:true}},data(){return{userLastOnlineText:""}},computed:{userPosition(){return this.$store.getters["users/getPosition"](this.dialogId)},userLastOnline(){return this.$store.getters["users/getLastOnline"](this.dialogId)},userLink(){return h.Utils.user.getProfileLink(this.dialogId)}},watch:{userLastOnline(t){this.userLastOnlineText=t}},created(){this.updateUserOnline();this.userLastOnlineInterval=setInterval(this.updateUserOnline,rt)},beforeUnmount(){clearInterval(this.userLastOnlineInterval)},methods:{updateUserOnline(){this.userLastOnlineText=this.$store.getters["users/getLastOnline"](this.dialogId)}},template:`\n\t\t<div class="bx-im-chat-header__info">\n\t\t\t<div class="bx-im-chat-header__title --user">\n\t\t\t\t<a :href="userLink" target="_blank" class="bx-im-chat-header__title_container">\n\t\t\t\t\t<ChatTitle :dialogId="dialogId" />\n\t\t\t\t</a>\n\t\t\t\t<span class="bx-im-chat-header__user-status">{{ userLastOnlineText }}</span>\n\t\t\t</div>\n\t\t\t<div class="bx-im-chat-header__subtitle_container">\n\t\t\t\t<div class="bx-im-chat-header__subtitle_content">{{ userPosition }}</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const dt={name:"MultidialogChatTitle",components:{EditableChatTitle:S.EditableChatTitle,ChatTitle:S.ChatTitle},props:{dialogId:{type:String,required:true}},emits:["newTitle"],computed:{isSupportBot(){return this.$store.getters["users/bots/isSupport"](this.dialogId)},subtitle(){return this.$Bitrix.Loc.getMessage("IM_CONTENT_CHAT_HEADER_SUPPORT_SUBTITLE")}},template:`\n\t\t<div class="bx-im-chat-header__info">\n\t\t\t<ChatTitle v-if="isSupportBot" :dialogId="dialogId" />\n\t\t\t<EditableChatTitle v-else :dialogId="dialogId" @newTitleSubmit="$emit('newTitle', $event)" />\n\t\t\t<div class="bx-im-chat-header__subtitle_container">\n\t\t\t\t<div class="bx-im-chat-header__subtitle_content">{{ subtitle }}</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const ct=Object.freeze({group:"group",user:"user",multidialog:"multidialog"});const ht={name:"ChatHeader",components:{ChatAvatar:S.ChatAvatar,AddToChat:i.AddToChat,CallButton:nt,GroupChatTitle:ot,UserChatTitle:lt,MultidialogChatTitle:dt,LineLoader:S.LineLoader,FadeAnimation:c.FadeAnimation},props:{dialogId:{type:String,default:""},currentSidebarPanel:{type:String,default:""}},emits:["toggleRightPanel","toggleSearchPanel","toggleMembersPanel"],data(){return{showAddToChatPopup:false}},computed:{AvatarSize:()=>S.AvatarSize,user(){return this.$store.getters["users/get"](this.dialogId,true)},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},isInited(){return this.dialog.inited},isUser(){return this.dialog.type===f.ChatType.user},isBot(){if(!this.isUser){return false}return this.user.bot===true},isChat(){return!this.isUser},chatId(){return this.dialog.chatId},userLink(){return h.Utils.user.getProfileLink(this.dialogId)},showCallButton(){if(this.isBot||this.isSupport){return false}return v.PermissionManager.getInstance().canPerformAction(f.ChatActionType.call,this.dialogId)},showInviteButton(){if(this.isBot){return false}return v.PermissionManager.getInstance().canPerformAction(f.ChatActionType.extend,this.dialogId)},showSidebarButton(){return v.PermissionManager.getInstance().canPerformAction(f.ChatActionType.openSidebar,this.dialogId)},canChangeAvatar(){return v.PermissionManager.getInstance().canPerformAction(f.ChatActionType.avatar,this.dialogId)},isSidebarOpened(){return this.currentSidebarPanel.length>0},isMessageSearchActive(){return this.currentSidebarPanel===f.SidebarDetailBlock.messageSearch},headerTitleComponentName(){return`${this.chatTitle}ChatTitle`},isSupport(){return this.$store.getters["sidebar/multidialog/isSupport"](this.dialogId)},chatTitle(){if(this.isSupport){return ct.multidialog}if(this.isUser){return ct.user}return ct.group},hasUserLink(){return this.isUser&&!this.isSupport}},methods:{toggleRightPanel(){if(this.currentSidebarPanel){M.EventEmitter.emit(f.EventType.sidebar.close,{panel:""});return}M.EventEmitter.emit(f.EventType.sidebar.open,{panel:f.SidebarDetailBlock.main,dialogId:this.dialogId})},toggleSearchPanel(){if(this.isMessageSearchActive){M.EventEmitter.emit(f.EventType.sidebar.close,{panel:f.SidebarDetailBlock.messageSearch});return}M.EventEmitter.emit(f.EventType.sidebar.open,{panel:f.SidebarDetailBlock.messageSearch,dialogId:this.dialogId})},onMembersClick(){if(!this.isInited){return}if(this.currentSidebarPanel===f.SidebarDetailBlock.members){M.EventEmitter.emit(f.EventType.sidebar.close,{panel:f.SidebarDetailBlock.members});return}M.EventEmitter.emit(f.EventType.sidebar.open,{panel:f.SidebarDetailBlock.members,dialogId:this.dialogId})},onNewTitleSubmit(t){this.getChatService().renameChat(this.dialogId,t).catch((()=>{BX.UI.Notification.Center.notify({content:this.loc("IM_CONTENT_CHAT_HEADER_RENAME_ERROR")})}))},getChatService(){if(!this.chatService){this.chatService=new y.ChatService}return this.chatService},openInvitePopup(){this.showAddToChatPopup=true},onAvatarClick(){if(!this.isChat||!this.canChangeAvatar){return}this.$refs.avatarInput.click()},async onAvatarSelect(t){const e=t.target;const n=e.files[0];if(!n){return}const a=await this.getChatService().prepareAvatar(n);if(!a){return}void this.getChatService().changeAvatar(this.dialog.chatId,a)},loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)}},template:`\n\t\t<div class="bx-im-chat-header__scope bx-im-chat-header__container">\n\t\t\t<div class="bx-im-chat-header__left">\n\t\t\t\t<slot name="left">\n\t\t\t\t\t<div class="bx-im-chat-header__avatar" :class="{'--can-change': canChangeAvatar}" @click="onAvatarClick">\n\t\t\t\t\t\t<a v-if="hasUserLink" :href="userLink" target="_blank">\n\t\t\t\t\t\t\t<ChatAvatar :avatarDialogId="dialogId" :contextDialogId="dialogId" :size="AvatarSize.L" />\n\t\t\t\t\t\t</a>\n\t\t\t\t\t\t<ChatAvatar v-else :avatarDialogId="dialogId" :contextDialogId="dialogId" :size="AvatarSize.L" />\n\t\t\t\t\t</div>\n\t\t\t\t\t<input \n\t\t\t\t\t\ttype="file" \n\t\t\t\t\t\t@change="onAvatarSelect" \n\t\t\t\t\t\taccept="image/*" \n\t\t\t\t\t\tclass="bx-im-chat-header__avatar_input" \n\t\t\t\t\t\tref="avatarInput"\n\t\t\t\t\t>\n\t\t\t\t\t<component\n\t\t\t\t\t\t:is="headerTitleComponentName"\n\t\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t\t@membersClick="onMembersClick"\n\t\t\t\t\t\t@newTitle="onNewTitleSubmit"\n\t\t\t\t\t/>\n\t\t\t\t</slot>\n\t\t\t</div>\n\t\t\t<LineLoader v-if="!isInited" :width="45" :height="22" />\n\t\t\t<FadeAnimation :duration="100">\n\t\t\t\t<div v-if="isInited" class="bx-im-chat-header__right">\n\t\t\t\t\t<slot name="before-actions"></slot>\n\t\t\t\t\t<CallButton v-if="showCallButton" :dialogId="dialogId" />\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="showInviteButton"\n\t\t\t\t\t\t:title="loc('IM_CONTENT_CHAT_HEADER_OPEN_INVITE_POPUP_TITLE')"\n\t\t\t\t\t\t:class="{'--active': showAddToChatPopup}"\n\t\t\t\t\t\tclass="bx-im-chat-header__icon --add-people"\n\t\t\t\t\t\t@click="openInvitePopup" \n\t\t\t\t\t\tref="add-members"\n\t\t\t\t\t></div>\n\t\t\t\t\t<div \n\t\t\t\t\t\t:title="loc('IM_CONTENT_CHAT_HEADER_OPEN_SEARCH')"\n\t\t\t\t\t\t:class="{'--active': isMessageSearchActive}"\n\t\t\t\t\t\tclass="bx-im-chat-header__icon --search" \n\t\t\t\t\t\t@click="toggleSearchPanel"\n\t\t\t\t\t></div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="showSidebarButton"\n\t\t\t\t\t\tclass="bx-im-chat-header__icon --panel"\n\t\t\t\t\t\t:title="loc('IM_CONTENT_CHAT_HEADER_OPEN_SIDEBAR')"\n\t\t\t\t\t\t:class="{'--active': isSidebarOpened}"\n\t\t\t\t\t\t@click="toggleRightPanel" \n\t\t\t\t\t></div>\n\t\t\t\t</div>\n\t\t\t</FadeAnimation>\n\t\t\t<AddToChat\n\t\t\t\t:bindElement="$refs['add-members'] || {}"\n\t\t\t\t:dialogId="dialogId"\n\t\t\t\t:showPopup="showAddToChatPopup"\n\t\t\t\t:popupConfig="{offsetTop: 15, offsetLeft: -300}"\n\t\t\t\t@close="showAddToChatPopup = false"\n\t\t\t/>\n\t\t</div>\n\t`};const gt={props:{dialogId:{type:String,required:true},container:{type:Object,required:true}},data(){return{showDropArea:false,lastDropAreaEnterTarget:null}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},hasPinnedMessages(){return this.$store.getters["messages/pin/getPinned"](this.dialog.chatId).length>0},dropAreaStyles(){let t=L.dropAreaOffset+L.chatHeader;if(this.hasPinnedMessages){t+=L.pinnedMessages}return{top:`${t}px`}}},watch:{container:{immediate:true,handler(t){if(!m.Type.isElementNode(t)){return}this.bindEvents()}}},beforeUnmount(){this.unbindEvents()},methods:{bindEvents(){m.Event.bind(this.container,"dragenter",this.onDragEnter);m.Event.bind(this.container,"dragleave",this.onDragLeave);m.Event.bind(this.container,"dragover",this.onDragOver);m.Event.bind(this.container,"drop",this.onDrop)},unbindEvents(){m.Event.unbind(this.container,"dragenter",this.onDragEnter);m.Event.unbind(this.container,"dragleave",this.onDragLeave);m.Event.unbind(this.container,"dragover",this.onDragOver);m.Event.unbind(this.container,"drop",this.onDrop)},async onDragEnter(t){t.stopPropagation();t.preventDefault();const e=await g.hasDataTransferOnlyFiles(t.dataTransfer,false);if(!e){return}this.lastDropAreaEnterTarget=t.target;this.showDropArea=true},onDragLeave(t){t.stopPropagation();t.preventDefault();if(this.lastDropAreaEnterTarget!==t.target){return}this.showDropArea=false},onDragOver(t){t.preventDefault()},async onDrop(t){t.preventDefault();const e=[f.ChatType.channel,f.ChatType.openChannel].includes(this.dialog.type);const n=await this.getUploadingService().uploadFromDragAndDrop({event:t,dialogId:this.dialogId,sendAsFile:false,autoUpload:!e});if(e){M.EventEmitter.emit(f.EventType.textarea.openUploadPreview,{uploaderId:n})}this.showDropArea=false},getUploadingService(){if(!this.uploadingService){this.uploadingService=y.UploadingService.getInstance()}return this.uploadingService},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<Transition name="drop-area-fade">\n\t\t\t<div v-if="showDropArea" :style="dropAreaStyles" class="bx-im-content-chat-drop-area__container bx-im-content-chat-drop-area__scope">\n\t\t\t\t<div class="bx-im-content-chat-drop-area__box">\n\t\t\t\t\t<span class="bx-im-content-chat-drop-area__icon"></span>\n\t\t\t\t\t<label class="bx-im-content-chat-drop-area__label-text">\n\t\t\t\t\t\t{{ loc('IM_CONTENT_DROP_AREA') }}\n\t\t\t\t\t</label>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</Transition>\n\t`};const ut="rgba(0, 0, 0, 0.1)";const mt="rgba(0, 0, 0, 0.2)";const Ct="#fff";const pt={components:{ChatButton:S.Button},props:{dialogId:{type:String,required:true}},data(){return{}},computed:{ButtonSize:()=>S.ButtonSize,dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},isMuted(){return this.dialog.muteList.includes(C.Core.getUserId())},buttonText(){const t=this.loc("IM_CONTENT_BLOCKED_TEXTAREA_ENABLE_NOTIFICATIONS");const e=this.loc("IM_CONTENT_BLOCKED_TEXTAREA_DISABLE_NOTIFICATIONS");return this.isMuted?t:e},buttonColorScheme(){return{borderColor:f.Color.transparent,backgroundColor:ut,iconColor:Ct,textColor:Ct,hoverColor:mt}}},methods:{onButtonClick(){if(this.isMuted){this.getChatService().unmuteChat(this.dialogId);return}this.getChatService().muteChat(this.dialogId)},getChatService(){if(!this.chatService){this.chatService=new y.ChatService}return this.chatService},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-content-chat__textarea_placeholder">\n\t\t\t<ChatButton\n\t\t\t\t:size="ButtonSize.XL"\n\t\t\t\t:customColorScheme="buttonColorScheme"\n\t\t\t\t:text="buttonText"\n\t\t\t\t:isRounded="true"\n\t\t\t\t@click="onButtonClick"\n\t\t\t/>\n\t\t</div>\n\t`};const vt={components:{ChatButton:S.Button},props:{dialogId:{type:String,required:true}},data(){return{}},computed:{ButtonSize:()=>S.ButtonSize,ButtonColor:()=>S.ButtonColor},methods:{onButtonClick(){this.getChatService().joinChat(this.dialogId)},getChatService(){if(!this.chatService){this.chatService=new y.ChatService}return this.chatService},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-content-chat__textarea_placeholder">\n\t\t\t<ChatButton\n\t\t\t\t:size="ButtonSize.XL"\n\t\t\t\t:color="ButtonColor.Primary"\n\t\t\t\t:text="loc('IM_CONTENT_BLOCKED_TEXTAREA_JOIN_CHAT')"\n\t\t\t\t:isRounded="true"\n\t\t\t\t@click="onButtonClick"\n\t\t\t/>\n\t\t</div>\n\t`};const It={name:"LoadingBar",data(){return{}},template:`\n\t\t<div class="bx-im-content-chat__loading-bar"></div>\n\t`};const _t={mounted(t,e){e.instance.textareaResizeManager.observeTextarea(t)},beforeUnmount(t,e){e.instance.textareaResizeManager.unobserveTextarea(t)}};const bt={name:"BaseChatContent",components:{ChatHeader:ht,ChatDialog:b.ChatDialog,ChatTextarea:E.ChatTextarea,ChatSidebar:a.ChatSidebar,DropArea:gt,MutePanel:pt,JoinPanel:vt,LoadingBar:It},directives:{"textarea-observer":_t},props:{dialogId:{type:String,default:""},commentsOpened:{type:Boolean,default:false}},data(){return{currentSidebarPanel:"",textareaHeight:0,showLoadingBar:false}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},canSend(){return v.PermissionManager.getInstance().canPerformAction(f.ChatActionType.send,this.dialog.dialogId)},isGuest(){return this.dialog.role===f.UserRole.guest},containerClasses(){const t=this.$store.getters["application/settings/get"](f.Settings.appearance.alignment);return[`--${t}-align`]},backgroundStyle(){return u.ThemeManager.getCurrentBackgroundStyle()},dialogContainerStyle(){let t=this.textareaHeight;if(!this.canSend){t=L.blockedTextarea}return{height:`calc(100% - ${L.chatHeader}px - ${t}px)`}}},watch:{textareaHeight(t,e){if(!this.dialog.inited||e===0){return}M.EventEmitter.emit(f.EventType.dialog.scrollToBottom,{chatId:this.dialog.chatId,animation:false})}},created(){this.initTextareaResizeManager();this.bindEvents()},beforeUnmount(){this.unbindEvents()},methods:{initTextareaResizeManager(){this.textareaResizeManager=new n.ResizeManager;this.textareaResizeManager.subscribe(n.ResizeManager.events.onHeightChange,this.onTextareaHeightChange)},onTextareaMount(){const t=this.$refs["textarea-container"];this.textareaHeight=t.clientHeight},onTextareaHeightChange(t){const{newHeight:e}=t.getData();this.textareaHeight=e},onChangeSidebarPanel({panel:t}){this.currentSidebarPanel=t},onShowLoadingBar(t){const{dialogId:e}=t.getData();if(e!==this.dialogId){return}this.showLoadingBar=true},onHideLoadingBar(t){const{dialogId:e}=t.getData();if(e!==this.dialogId){return}this.showLoadingBar=false},bindEvents(){M.EventEmitter.subscribe(f.EventType.dialog.showLoadingBar,this.onShowLoadingBar);M.EventEmitter.subscribe(f.EventType.dialog.hideLoadingBar,this.onHideLoadingBar)},unbindEvents(){M.EventEmitter.unsubscribe(f.EventType.dialog.showLoadingBar,this.onShowLoadingBar);M.EventEmitter.unsubscribe(f.EventType.dialog.hideLoadingBar,this.onHideLoadingBar)},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-content-chat__scope bx-im-content-chat__container" :class="containerClasses" :style="backgroundStyle">\n\t\t\t<div class="bx-im-content-chat__content" ref="content">\n\t\t\t\t<slot name="header" :currentSidebarPanel="currentSidebarPanel">\n\t\t\t\t\t<ChatHeader :dialogId="dialogId" :key="dialogId" :currentSidebarPanel="currentSidebarPanel"/>\n\t\t\t\t</slot>\n\t\t\t\t<div :style="dialogContainerStyle" class="bx-im-content-chat__dialog_container">\n\t\t\t\t\t<Transition name="loading-bar-transition">\n\t\t\t\t\t\t<LoadingBar v-if="showLoadingBar" />\n\t\t\t\t\t</Transition>\n\t\t\t\t\t<div class="bx-im-content-chat__dialog_content">\n\t\t\t\t\t\t<slot name="dialog">\n\t\t\t\t\t\t\t<ChatDialog :dialogId="dialogId" :key="dialogId" />\n\t\t\t\t\t\t</slot>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t\x3c!-- Textarea --\x3e\n\t\t\t\t<div v-if="canSend" v-textarea-observer class="bx-im-content-chat__textarea_container" ref="textarea-container">\n\t\t\t\t\t<slot name="textarea" :onTextareaMount="onTextareaMount">\n\t\t\t\t\t\t<ChatTextarea :dialogId="dialogId" :key="dialogId" @mounted="onTextareaMount" />\n\t\t\t\t\t</slot>\n\t\t\t\t</div>\n\t\t\t\t<slot v-else-if="isGuest" name="join-panel">\n\t\t\t\t\t<JoinPanel :dialogId="dialogId" />\n\t\t\t\t</slot>\n\t\t\t\t<MutePanel v-else :dialogId="dialogId" />\n\t\t\t\t\x3c!-- End textarea --\x3e\n\t\t\t\t<DropArea :dialogId="dialogId" :container="$refs.content || {}" :key="dialogId" />\n\t\t\t</div>\n\t\t\t<ChatSidebar \n\t\t\t\tv-if="dialogId.length > 0" \n\t\t\t\t:originDialogId="dialogId"\n\t\t\t\t:isActive="!commentsOpened"\n\t\t\t\t@changePanel="onChangeSidebarPanel" \n\t\t\t/>\n\t\t</div>\n\t`};const Tt={name:"CommentsButton",props:{dialogId:{type:String,required:true},counter:{type:Number,required:true}},data(){return{}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)}},template:`\n\t\t<div class="bx-im-dialog-channel__comments-button">\n\t\t\t<div class="bx-im-dialog-channel__comments-button_counter">\n\t\t\t\t{{ counter }}\n\t\t\t</div>\n\t\t</div>\n\t`};class Et extends T.MessageMenu{getMenuItems(){return[this.getCopyItem(),this.getCopyLinkItem(),this.getCopyFileItem(),this.getPinItem(),this.getForwardItem(),this.getDelimiter(),this.getMarkItem(),this.getFavoriteItem(),this.getDelimiter(),this.getDownloadFileItem(),this.getSaveToDisk(),this.getDelimiter(),this.getEditItem(),this.getDeleteItem()]}}const Mt={name:"ChannelMessageList",components:{MessageList:T.MessageList},props:{dialogId:{type:String,required:true}},computed:{ChannelMessageMenu:()=>Et},template:`\n\t\t<MessageList :dialogId="dialogId" :messageMenuClass="ChannelMessageMenu" />\n\t`};const St={name:"ChannelDialog",components:{ChatDialog:b.ChatDialog,ChannelMessageList:Mt,CommentsButton:Tt},props:{dialogId:{type:String,required:true}},data(){return{lastScrolledChatId:0}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},layout(){return this.$store.getters["application/getLayout"]},isGuest(){return this.dialog.role===f.UserRole.guest},isChatLayout(){return this.layout.name===f.Layout.chat.name},channelComments(){return this.$store.getters["counters/getChannelComments"](this.dialog.chatId)},totalChannelCommentsCounter(){let t=0;Object.values(this.channelComments).forEach((e=>{t+=e}));return t},showCommentsButton(){return this.isChatLayout&&this.totalChannelCommentsCounter>0}},beforeUnmount(){this.readAllChannelComments()},methods:{async onCommentsButtonClick(){const t=this.getNextChatIdToJump();this.lastScrolledChatId=t;const e=this.$store.getters["messages/comments/getMessageIdByChatId"](t);if(e){this.$refs.dialog.goToMessageContext(e,{position:b.ScrollManager.scrollPosition.messageBottom});return}await this.goToMessageContextByCommentsChatId(t)},async goToMessageContextByCommentsChatId(t){this.$refs.dialog.showLoadingBar();const e=await this.$refs.dialog.getMessageService().loadContextByChatId(t).catch((t=>{console.error("ChannelDialog: goToMessageContextByCommentsChatId error",t)}));this.$refs.dialog.hideLoadingBar();if(!e){console.error("ChannelDialog: no messageId after loading context")}await this.$nextTick();this.$refs.dialog.getScrollManager().scrollToMessage(e,{position:b.ScrollManager.scrollPosition.messageBottom});await this.$nextTick();this.$refs.dialog.highlightMessage(e)},getNextChatIdToJump(){const t=this.getCommentsChatIds();t.sort(((t,e)=>t-e));if(this.lastScrolledChatId===0){return t[0]}const e=t.filter((t=>t>this.lastScrolledChatId));if(e.length===0){return t[0]}return e[0]},getCommentsChatIds(){return Object.keys(this.channelComments).map((t=>Number(t)))},readAllChannelComments(){y.CommentsService.readAllChannelComments(this.dialogId)}},template:`\n\t\t<ChatDialog ref="dialog" :dialogId="dialogId" :resetOnExit="isGuest">\n\t\t\t<template #message-list>\n\t\t\t\t<ChannelMessageList :dialogId="dialogId" />\n\t\t\t</template>\n\t\t\t<template #additional-float-button>\n\t\t\t\t<Transition name="float-button-transition">\n\t\t\t\t\t<CommentsButton\n\t\t\t\t\t\tv-if="showCommentsButton"\n\t\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t\t:counter="totalChannelCommentsCounter"\n\t\t\t\t\t\t@click="onCommentsButtonClick"\n\t\t\t\t\t\tkey="comments"\n\t\t\t\t\t/>\n\t\t\t\t</Transition>\n\t\t\t</template>\n\t\t</ChatDialog>\n\t`};const ft={name:"ChannelHeader",components:{ChatHeader:ht},props:{dialogId:{type:String,default:""},currentSidebarPanel:{type:String,default:""}},template:`\n\t\t<ChatHeader :dialogId="dialogId" :currentSidebarPanel="currentSidebarPanel" />\n\t`};const yt={components:{ChatButton:S.Button},props:{dialogId:{type:String,required:true}},data(){return{}},computed:{ButtonSize:()=>S.ButtonSize,ButtonColor:()=>S.ButtonColor},methods:{onButtonClick(){M.EventEmitter.emit(f.EventType.channel.onChannelJoin,{channelDialogId:this.dialogId});this.getChatService().joinChat(this.dialogId)},getChatService(){if(!this.chatService){this.chatService=new y.ChatService}return this.chatService},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-content-chat__textarea_placeholder">\n\t\t\t<ChatButton\n\t\t\t\t:size="ButtonSize.XL"\n\t\t\t\t:color="ButtonColor.Primary"\n\t\t\t\t:text="loc('IM_CONTENT_BLOCKED_TEXTAREA_JOIN_CHANNEL')"\n\t\t\t\t:isRounded="true"\n\t\t\t\t@click="onButtonClick"\n\t\t\t/>\n\t\t</div>\n\t`};const Lt={name:"ChannelTextarea",components:{ChatTextarea:E.ChatTextarea},props:{dialogId:{type:String,default:""}},template:`\n\t\t<ChatTextarea\n\t\t\t:dialogId="dialogId"\n\t\t\t:withCreateMenu="false"\n\t\t\t:withMarket="false"\n\t\t\tclass="bx-im-channel-send-panel__container"\n\t\t/>\n\t`};const xt={name:"ChannelContent",components:{BaseChatContent:bt,ChannelHeader:ft,ChannelDialog:St,ChannelTextarea:Lt,JoinPanel:yt},props:{dialogId:{type:String,required:true},commentsOpened:{type:Boolean,required:true}},template:`\n\t\t<BaseChatContent :dialogId="dialogId" :commentsOpened="commentsOpened">\n\t\t\t<template #header="{ currentSidebarPanel }">\n\t\t\t\t<ChannelHeader :dialogId="dialogId" :currentSidebarPanel="currentSidebarPanel" :key="dialogId" />\n\t\t\t</template>\n\t\t\t<template #dialog>\n\t\t\t\t<ChannelDialog :dialogId="dialogId" :key="dialogId" />\n\t\t\t</template>\n\t\t\t<template #join-panel>\n\t\t\t\t<JoinPanel :dialogId="dialogId" />\n\t\t\t</template>\n\t\t\t<template #textarea="{ onTextareaMount }">\n\t\t\t\t<ChannelTextarea :dialogId="dialogId" :key="dialogId" @mounted="onTextareaMount" />\n\t\t\t</template>\n\t\t</BaseChatContent>\n\t`};const At={data(){return{}},computed:{iconClass(){return this.isEmptyRecent?"--empty":"--default"},text(){if(this.isEmptyRecent){return this.loc("IM_CONTENT_CHAT_NO_CHATS_START_MESSAGE")}if(this.isChannelLayout){return this.loc("IM_CONTENT_CHANNEL_START_MESSAGE_V2")}return this.loc("IM_CONTENT_CHAT_START_MESSAGE_V2")},subtext(){return""},isEmptyRecent(){return y.RecentService.getInstance().getCollection().length===0},isChannelLayout(){return this.layout.name===f.Layout.channel.name},layout(){return this.$store.getters["application/getLayout"]},backgroundStyle(){return u.ThemeManager.getCurrentBackgroundStyle()}},methods:{loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-content-chat-start__container" :style="backgroundStyle">\n\t\t\t<div class="bx-im-content-chat-start__content">\n\t\t\t\t<div class="bx-im-content-chat-start__icon" :class="iconClass"></div>\n\t\t\t\t<div class="bx-im-content-chat-start__title">\n\t\t\t\t\t{{ text }}\n\t\t\t\t</div>\n\t\t\t\t<div v-if="subtext" class="bx-im-content-chat-start__subtitle">\n\t\t\t\t\t{{ subtext }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};class Bt{async updateLastActivityDate(t){if(this.isPullServerWithUserStatusSupport()){const e=await this.getUserActivityFromPull(t);if(!e){return Promise.resolve()}return this.updateUserModel(t,{lastActivityDate:e})}const e=await this.requestUserData(t);return this.updateUserModel(t,e)}async getUserActivityFromPull(t){const e=await C.Core.getPullClient().getUsersLastSeen([t]).catch((t=>{console.error("UserService: error getting user activity from P&P",t)}));if(!m.Type.isNumber(e[t])){return null}const n=e[t]*1e3;return new Date(Date.now()-n)}async requestUserData(t){I.Logger.warn(`UserService: get actual user data for - ${t}`);const e=await C.Core.getRestClient().callMethod(f.RestMethod.imUserGet,{ID:t}).catch((t=>{console.error("UserService: error getting user data",t)}));return e.data()}async updateUserModel(t,e){I.Logger.warn("UserService: update user data",e);return C.Core.getStore().dispatch("users/update",{id:t,fields:e})}isPullServerWithUserStatusSupport(){return C.Core.getPullClient().isJsonRpc()}}const Pt={name:"ChatOpener",components:{BaseChatContent:bt,ChannelContent:xt,EmptyState:At},props:{dialogId:{type:String,required:true},commentsOpened:{type:Boolean,required:true}},emits:["close"],data(){return{}},computed:{layout(){return this.$store.getters["application/getLayout"]},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},isUser(){return this.dialog.type===f.ChatType.user},isChannel(){return[f.ChatType.channel,f.ChatType.openChannel].includes(this.dialog.type)},isGuest(){return this.dialog.role===f.UserRole.guest}},watch:{dialogId(t,e){I.Logger.warn(`ChatContent: switching from ${e||"empty"} to ${t}`);this.onChatChange()}},created(){if(!this.dialogId){return}this.onChatChange()},methods:{async onChatChange(){if(this.dialogId===""){return}if(h.Utils.dialog.isExternalId(this.dialogId)){const t=await this.getChatService().prepareDialogId(this.dialogId);void e.LayoutManager.getInstance().setLayout({name:f.Layout.chat.name,entityId:t,contextId:this.layout.contextId});return}if(this.dialog.inited){I.Logger.warn(`ChatContent: chat ${this.dialogId} is already loaded`);if(this.isUser){const t=parseInt(this.dialog.dialogId,10);void this.getUserService().updateLastActivityDate(t)}else if(this.isChannel&&!this.isGuest){I.Logger.warn(`ChatContent: channel ${this.dialogId} is loaded, loading comments metadata`);void this.getChatService().loadCommentInfo(this.dialogId)}return}if(this.dialog.loading){I.Logger.warn(`ChatContent: chat ${this.dialogId} is loading`);return}if(this.layout.contextId){await this.loadChatWithContext();return}await this.loadChat()},async loadChatWithContext(){I.Logger.warn(`ChatContent: loading chat ${this.dialogId} with context - ${this.layout.contextId}`);await this.getChatService().loadChatWithContext(this.dialogId,this.layout.contextId).catch((t=>{this.handleChatLoadError(t);I.Logger.error(t);l.Messenger.openChat()}));I.Logger.warn(`ChatContent: chat ${this.dialogId} is loaded with context of ${this.layout.contextId}`)},async loadChat(){I.Logger.warn(`ChatContent: loading chat ${this.dialogId}`);await this.getChatService().loadChatWithMessages(this.dialogId).catch((t=>{this.handleChatLoadError(t);I.Logger.error(t);l.Messenger.openChat()}));I.Logger.warn(`ChatContent: chat ${this.dialogId} is loaded`)},handleChatLoadError(t){const[e]=t;if(e.code==="ACCESS_DENIED"){this.showNotification(this.loc("IM_CONTENT_CHAT_ACCESS_ERROR"))}else if(e.code==="MESSAGE_NOT_FOUND"){this.showNotification(this.loc("IM_CONTENT_CHAT_CONTEXT_MESSAGE_NOT_FOUND"))}},showNotification(t){BX.UI.Notification.Center.notify({content:t})},getChatService(){if(!this.chatService){this.chatService=new y.ChatService}return this.chatService},getUserService(){if(!this.userService){this.userService=new Bt}return this.userService},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-content-default-chat__container">\n\t\t\t<EmptyState v-if="!dialogId" />\n\t\t\t<ChannelContent v-else-if="isChannel" :dialogId="dialogId" :commentsOpened="commentsOpened" />\n\t\t\t<BaseChatContent\n\t\t\t\tv-else\n\t\t\t\t:dialogId="dialogId"\n\t\t\t\tclass="bx-im-content-comments__container"\n\t\t\t/>\n\t\t</div>\n\t`};const Nt={name:"SubscribeToggle",components:{Toggle:S.Toggle},props:{dialogId:{type:String,required:true}},data(){return{}},computed:{ToggleSize:()=>S.ToggleSize,dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},postMessageId(){return this.$store.getters["messages/comments/getMessageIdByChatId"](this.dialog.chatId)},isSubscribed(){return this.$store.getters["messages/comments/isUserSubscribed"](this.postMessageId)}},methods:{onToggleClick(){if(this.isSubscribed){y.CommentsService.unsubscribe(this.postMessageId);return}y.CommentsService.subscribe(this.postMessageId)},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div @click="onToggleClick" class="bx-im-comments-header-follow__container">\n\t\t\t<div class="bx-im-comments-header-follow__text">{{ loc('IM_CONTENT_COMMENTS_FOLLOW_TOGGLE_TEXT') }}</div>\n\t\t\t<Toggle :size="ToggleSize.M" :isEnabled="isSubscribed" />\n\t\t</div>\n\t`};const Ot={name:"CommentsHeader",components:{ChatHeader:ht,ChatAvatar:S.ChatAvatar,SubscribeToggle:Nt},props:{dialogId:{type:String,default:""},channelId:{type:String,required:true},currentSidebarPanel:{type:String,default:""}},computed:{AvatarSize:()=>S.AvatarSize,channel(){return this.$store.getters["chats/get"](this.channelId,true)},showSubscribeToggle(){return v.PermissionManager.getInstance().canPerformAction(f.ChatActionType.subscribeToComments,this.dialogId)}},methods:{onBackClick(){M.EventEmitter.emit(f.EventType.dialog.closeComments)},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<ChatHeader\n\t\t\t:dialogId="dialogId"\n\t\t\t:currentSidebarPanel="currentSidebarPanel"\n\t\t\tclass="bx-im-comment-header__container"\n\t\t>\n\t\t\t<template #left>\n\t\t\t\t<div @click="onBackClick" class="bx-im-comment-header__back"></div>\n\t\t\t\t<div class="bx-im-comment-header__info">\n\t\t\t\t\t<div class="bx-im-comment-header__title">{{ loc('IM_CONTENT_COMMENTS_HEADER_TITLE') }}</div>\n\t\t\t\t\t<div class="bx-im-comment-header__subtitle">\n\t\t\t\t\t\t<div class="bx-im-comment-header__subtitle_avatar">\n\t\t\t\t\t\t\t<ChatAvatar :avatarDialogId="channelId" :contextDialogId="channelId" :size="AvatarSize.XS" />\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="bx-im-comment-header__subtitle_text">{{ channel.name }}</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t\t<template v-if="showSubscribeToggle" #before-actions>\n\t\t\t\t<SubscribeToggle :dialogId="dialogId" />\n\t\t\t</template>\n\t\t</ChatHeader>\n\t`};const Dt={name:"CommentsDialogLoader",data(){return{}},methods:{loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-comments-dialog-loader__container">\n\t\t\t<div class="bx-im-comments-dialog-loader__spinner"></div>\n\t\t</div>\n\t`};class kt extends T.MessageMenu{getMenuItems(){return[this.getReplyItem(),this.getCopyItem(),this.getCopyFileItem(),this.getDelimiter(),this.getFavoriteItem(),this.getDelimiter(),this.getCreateItem(),this.getDelimiter(),this.getDownloadFileItem(),this.getSaveToDisk(),this.getDelimiter(),this.getEditItem(),this.getDeleteItem()]}getReplyItem(){if(this.isPostMessage()){return null}return super.getReplyItem()}getEditItem(){if(this.isPostMessage()){return null}return super.getEditItem()}getDeleteItem(){if(this.isPostMessage()){return null}return super.getDeleteItem()}getCreateItem(){if(this.isPostMessage()){return null}return super.getCreateItem()}isPostMessage(){const{type:t}=this.store.getters["chats/getByChatId"](this.context.chatId);return[f.ChatType.openChannel,f.ChatType.channel].includes(t)}}const Ht={name:"CommentsMessageList",components:{MessageList:T.MessageList,CommentsDialogLoader:Dt,AuthorGroup:T.AuthorGroup,...T.MessageComponents},props:{dialogId:{type:String,required:true}},computed:{CommentsMessageMenu:()=>kt,dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},showPostMessage(){return this.dialog.inited&&!this.dialog.hasPrevPage},postMessageId(){return this.$store.getters["messages/comments/getMessageIdByChatId"](this.dialog.chatId)},postMessage(){return this.$store.getters["messages/getById"](this.postMessageId)},postAuthorGroup(){if(!this.dialog.inited){return null}const t=new T.CollectionManager(this.dialogId);return t.formatAuthorGroup(this.postMessage)}},methods:{onPostMessageMouseUp(t,e){this.$refs.messageList.onMessageMouseUp(t,e)},getMessageComponentName(t){return new T.MessageComponentManager(t).getName()}},template:`\n\t\t<MessageList\n\t\t\t:dialogId="dialogId"\n\t\t\t:messageMenuClass="CommentsMessageMenu"\n\t\t\tref="messageList"\n\t\t>\n\t\t\t<template #loader>\n\t\t\t\t<CommentsDialogLoader />\n\t\t\t</template>\n\t\t\t<template v-if="showPostMessage" #before-messages>\n\t\t\t\t<div class="bx-im-comments-message-list__channel-post">\n\t\t\t\t\t<AuthorGroup :item="postAuthorGroup" :contextDialogId="dialogId">\n\t\t\t\t\t\t<template #message>\n\t\t\t\t\t\t\t<component\n\t\t\t\t\t\t\t\t:is="getMessageComponentName(postMessage)"\n\t\t\t\t\t\t\t\t:item="postMessage"\n\t\t\t\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t\t\t\t:key="postMessage.id"\n\t\t\t\t\t\t\t\t@mouseup="onPostMessageMouseUp(postMessage, $event)"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t</component>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t</AuthorGroup>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t</MessageList>\n\t`};const wt={name:"CommentsDialog",components:{ChatDialog:b.ChatDialog,CommentsMessageList:Ht,PinnedMessages:b.PinnedMessages},props:{dialogId:{type:String,required:true}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},dialogInited(){return this.dialog.inited},postMessageId(){return this.$store.getters["messages/comments/getMessageIdByChatId"](this.dialog.chatId)},postMessage(){return this.$store.getters["messages/getById"](this.postMessageId)}},methods:{async goToPostMessageContext(){const t=this.$refs.dialog;const e=this.dialogInited&&!this.dialog.hasPrevPage;if(e){await t.getScrollManager().animatedScrollToMessage(this.postMessageId);t.highlightMessage(this.postMessageId);return}t.showLoadingBar();await t.getMessageService().loadFirstPage().catch((t=>{I.Logger.error("goToMessageContext error",t)}));await this.$nextTick();t.hideLoadingBar();t.getScrollManager().scrollToMessage(this.postMessageId);await this.$nextTick();t.highlightMessage(this.postMessageId)},onPinnedPostMessageClick(){this.goToPostMessageContext()}},template:`\n\t\t<ChatDialog ref="dialog" :dialogId="dialogId" :saveScrollOnExit="false" :resetOnExit="true">\n\t\t\t<template v-if="dialogInited" #pinned-panel>\n\t\t\t\t<PinnedMessages\n\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t:messages="[postMessage]"\n\t\t\t\t\t@messageClick="onPinnedPostMessageClick"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t\t<template #message-list>\n\t\t\t\t<CommentsMessageList :dialogId="dialogId" />\n\t\t\t</template>\n\t\t</ChatDialog>\n\t`};const Rt={name:"CommentsTextarea",components:{ChatTextarea:E.ChatTextarea},props:{dialogId:{type:String,default:""}},template:`\n\t\t<ChatTextarea\n\t\t\t:dialogId="dialogId"\n\t\t\t:withMarket="false"\n\t\t\tclass="bx-im-comments-send-panel__container"\n\t\t/>\n\t`};const $t={components:{ChatButton:S.Button},props:{dialogId:{type:String,required:true}},data(){return{}},computed:{ButtonSize:()=>S.ButtonSize,ButtonColor:()=>S.ButtonColor},methods:{onButtonClick(){M.EventEmitter.emit(f.EventType.channel.onChannelJoin,{channelDialogId:this.dialogId});this.getChatService().joinChat(this.dialogId)},getChatService(){if(!this.chatService){this.chatService=new y.ChatService}return this.chatService},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-content-chat__textarea_placeholder">\n\t\t\t<ChatButton\n\t\t\t\t:size="ButtonSize.XL"\n\t\t\t\t:color="ButtonColor.Primary"\n\t\t\t\t:text="loc('IM_CONTENT_BLOCKED_TEXTAREA_JOIN_CHANNEL')"\n\t\t\t\t:isRounded="true"\n\t\t\t\t@click="onButtonClick"\n\t\t\t/>\n\t\t</div>\n\t`};const Ut={name:"CommentsContent",components:{BaseChatContent:bt,CommentsHeader:Ot,CommentsDialog:wt,CommentsTextarea:Rt,JoinPanel:$t},props:{dialogId:{type:String,required:true},channelId:{type:String,required:true}},template:`\n\t\t<BaseChatContent :dialogId="dialogId">\n\t\t\t<template #header="{ currentSidebarPanel }">\n\t\t\t\t<CommentsHeader\n\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t:channelId="channelId"\n\t\t\t\t\t:currentSidebarPanel="currentSidebarPanel"\n\t\t\t\t\t:key="dialogId"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t\t<template #dialog>\n\t\t\t\t<CommentsDialog :dialogId="dialogId" :key="dialogId" />\n\t\t\t</template>\n\t\t\t<template #join-panel>\n\t\t\t\t<JoinPanel :dialogId="dialogId" />\n\t\t\t</template>\n\t\t\t<template #textarea="{ onTextareaMount }">\n\t\t\t\t<CommentsTextarea :dialogId="dialogId" :key="dialogId" @mounted="onTextareaMount" />\n\t\t\t</template>\n\t\t</BaseChatContent>\n\t`};const Ft={name:"CommentsOpener",components:{CommentsContent:Ut},props:{postId:{type:Number,required:true},channelId:{type:String,required:true}},emits:["close"],data(){return{}},computed:{dialog(){return this.$store.getters["chats/getByChatId"](this.commentsChatId)},commentInfo(){return this.$store.getters["messages/comments/getByMessageId"](this.postId)},commentsChatId(){return this.commentInfo.chatId},commentsDialogId(){if(!this.dialog){return""}return this.dialog.dialogId}},created(){this.onCreated()},methods:{async onCreated(){await this.loadChat()},async loadChat(){I.Logger.warn(`CommentsContent: loading comments for post ${this.postId}`);await this.getChatService().loadComments(this.postId).catch((t=>{this.handleChatLoadError(t);I.Logger.error(t);this.$emit("close")}));I.Logger.warn(`CommentsContent: comments for post ${this.postId} are loaded`)},handleChatLoadError(t){const[e]=t;if(e.code==="ACCESS_DENIED"){this.showNotification(this.loc("IM_CONTENT_CHAT_ACCESS_ERROR"))}},showNotification(t){BX.UI.Notification.Center.notify({content:t})},getChatService(){if(!this.chatService){this.chatService=new y.ChatService}return this.chatService}},template:`\n\t\t<div class="bx-im-content-comments__container">\n\t\t\t<CommentsContent :dialogId="commentsDialogId" :channelId="channelId" />\n\t\t</div>\n\t`};const Xt={name:"ChatContent",components:{ChatOpener:Pt,CommentsOpener:Ft},props:{entityId:{type:String,default:""}},data(){return{commentsPostId:0,commentsAnimationFlag:false}},computed:{layout(){return this.$store.getters["application/getLayout"]},showComments(){return this.commentsPostId>0}},watch:{layout(t){this.closeComments()}},created(){M.EventEmitter.subscribe(f.EventType.dialog.openComments,this.onOpenComments);M.EventEmitter.subscribe(f.EventType.dialog.closeComments,this.onCloseComments)},beforeUnmount(){M.EventEmitter.unsubscribe(f.EventType.dialog.openComments,this.onOpenComments);M.EventEmitter.unsubscribe(f.EventType.dialog.closeComments,this.onCloseComments)},methods:{onOpenComments(t){const{messageId:e}=t.getData();this.commentsPostId=e;this.commentsAnimationFlag=true},onCloseComments(){this.closeComments()},closeComments(){this.commentsPostId=0},onCommentsAnimationEnd(){this.commentsAnimationFlag=false}},template:`\n\t\t<ChatOpener\n\t\t\t:commentsOpened="showComments"\n\t\t\t:dialogId="entityId"\n\t\t\t:class="{'--comments-show-animation': commentsAnimationFlag}"\n\t\t/>\n\t\t<Transition name="comments-content" @after-enter="onCommentsAnimationEnd">\n\t\t\t<CommentsOpener\n\t\t\t\tv-if="showComments"\n\t\t\t\t:postId="commentsPostId"\n\t\t\t\t:channelId="entityId"\n\t\t\t/>\n\t\t</Transition>\n\t`};t.ChatContent=Xt})(this.BX.Messenger.v2.Component.Content=this.BX.Messenger.v2.Component.Content||{},BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Component,BX.Messenger.v2.Component.EntitySelector,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Component.Animation,BX.Messenger.v2.Lib,BX.UI.Uploader,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Application,BX,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Model,BX.Messenger.v2.Component.Dialog,BX.Messenger.v2.Component,BX.Messenger.v2.Component,BX.Event,BX.Messenger.v2.Component.Elements,BX.Messenger.v2.Const,BX.Messenger.v2.Provider.Service);
//# sourceMappingURL=chat-content.bundle.map.js