this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Component=this.BX.Messenger.v2.Component||{};(function(e,t,s,a,i,n,r,l,o,c,h,d,g,u,m){"use strict";const v={name:"MessageText",components:{ChatTitle:a.ChatTitle},props:{item:{type:Object,required:true}},data(){return{}},computed:{recentItem(){return this.item},dialog(){return this.$store.getters["chats/get"](this.recentItem.dialogId,true)},message(){return this.$store.getters["recent/getMessage"](this.recentItem.dialogId)},formattedDate(){return this.formatDate(this.message.date)},isLastMessageAuthor(){return this.message.authorId===c.Core.getUserId()},lastMessageAuthorAvatar(){const e=this.$store.getters["users/get"](this.message.authorId);if(!e){return""}return e.avatar},lastMessageAuthorAvatarStyle(){return{backgroundImage:`url('${this.lastMessageAuthorAvatar}')`}},messageText(){if(this.message.isDeleted){return this.loc("IM_LIST_RECENT_DELETED_MESSAGE")}const e=n.Parser.purifyRecent(this.recentItem);if(!e){return this.loc("IM_LIST_RECENT_CHAT_TYPE_GROUP_V2")}return e},formattedMessageText(){const e=27;return i.Utils.text.insertUnseenWhitespace(this.messageText,e)}},methods:{formatDate(e){return r.DateFormatter.formatByTemplate(e,r.DateTemplate.recent)},loc(e,t={}){return this.$Bitrix.Loc.getMessage(e,t)}},template:`\n\t\t<div class="bx-im-list-channel-item__message_container">\n\t\t\t<span class="bx-im-list-channel-item__message_text">\n\t\t\t\t<span v-if="isLastMessageAuthor" class="bx-im-list-channel-item__message_author-icon --self"></span>\n\t\t\t\t<template v-else-if="message.authorId">\n\t\t\t\t\t<span v-if="lastMessageAuthorAvatar" :style="lastMessageAuthorAvatarStyle" class="bx-im-list-channel-item__message_author-icon --user"></span>\n\t\t\t\t\t<span v-else class="bx-im-list-channel-item__message_author-icon --user --default"></span>\n\t\t\t\t</template>\n\t\t\t\t<span class="bx-im-list-channel-item__message_text_content">{{ formattedMessageText }}</span>\n\t\t\t</span>\n\t\t</div>\n\t`};const p={name:"ChannelItem",components:{ChatAvatar:a.ChatAvatar,ChatTitle:a.ChatTitle,MessageText:v},props:{item:{type:Object,required:true}},data(){return{}},computed:{AvatarSize:()=>a.AvatarSize,recentItem(){return this.item},formattedDate(){if(this.needsBirthdayPlaceholder){return this.loc("IM_LIST_RECENT_BIRTHDAY_DATE")}return this.formatDate(this.message.date)},formattedCounter(){return this.dialog.counter>99?"99+":this.dialog.counter.toString()},dialog(){return this.$store.getters["chats/get"](this.recentItem.dialogId,true)},layout(){return this.$store.getters["application/getLayout"]},message(){return this.$store.getters["recent/getMessage"](this.recentItem.dialogId)},isUser(){return this.dialog.type===g.ChatType.user},isChat(){return!this.isUser},isChatSelected(){if(this.layout.name!==g.Layout.channel.name){return false}return this.layout.entityId===this.recentItem.dialogId},isChatMuted(){if(this.isUser){return false}const e=this.dialog.muteList.find((e=>e===c.Core.getUserId()));return Boolean(e)},isSomeoneTyping(){return this.dialog.writingList.length>0},needsBirthdayPlaceholder(){return this.$store.getters["recent/needsBirthdayPlaceholder"](this.recentItem.dialogId)},showLastMessage(){return this.$store.getters["application/settings/get"](g.Settings.recent.showLastMessage)},invitation(){return this.recentItem.invitation},wrapClasses(){return{"--selected":this.isChatSelected}}},methods:{formatDate(e){return r.DateFormatter.formatByTemplate(e,r.DateTemplate.recent)},loc(e){return this.$Bitrix.Loc.getMessage(e)}},template:`\n\t\t<div :data-id="recentItem.dialogId" :class="wrapClasses" class="bx-im-list-channel-item__wrap">\n\t\t\t<div class="bx-im-list-channel-item__container">\n\t\t\t\t<div class="bx-im-list-channel-item__avatar_container">\n\t\t\t\t\t<div class="bx-im-list-channel-item__avatar_content">\n\t\t\t\t\t\t<ChatAvatar \n\t\t\t\t\t\t\t:avatarDialogId="recentItem.dialogId" \n\t\t\t\t\t\t\t:contextDialogId="recentItem.dialogId"\n\t\t\t\t\t\t\t:size="AvatarSize.XL" \n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-im-list-channel-item__content_container">\n\t\t\t\t\t<div class="bx-im-list-channel-item__content_header">\n\t\t\t\t\t\t<ChatTitle :dialogId="recentItem.dialogId" />\n\t\t\t\t\t\t<div class="bx-im-list-channel-item__date">\n\t\t\t\t\t\t\t<span>{{ formattedDate }}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="bx-im-list-channel-item__content_bottom">\n\t\t\t\t\t\t<MessageText :item="recentItem" />\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const b={name:"EmptyState",data(){return{}},methods:{loc(e){return this.$Bitrix.Loc.getMessage(e)}},template:`\n\t\t<div class="bx-im-list-channel__empty">\n\t\t\t<div class="bx-im-list-channel__empty_icon"></div>\n\t\t\t<div class="bx-im-list-channel__empty_text">{{ loc('IM_LIST_CHANNEL_EMPTY') }}</div>\n\t\t</div>\n\t`};var L=babelHelpers.classPrivateFieldLooseKey("itemsPerPage");var M=babelHelpers.classPrivateFieldLooseKey("isLoading");var _=babelHelpers.classPrivateFieldLooseKey("pagesLoaded");var I=babelHelpers.classPrivateFieldLooseKey("hasMoreItemsToLoad");var f=babelHelpers.classPrivateFieldLooseKey("lastMessageId");var C=babelHelpers.classPrivateFieldLooseKey("requestItems");var P=babelHelpers.classPrivateFieldLooseKey("updateModels");var y=babelHelpers.classPrivateFieldLooseKey("getMinMessageId");class B{constructor(){Object.defineProperty(this,y,{value:T});Object.defineProperty(this,P,{value:S});Object.defineProperty(this,C,{value:x});this.firstPageIsLoaded=false;Object.defineProperty(this,L,{writable:true,value:50});Object.defineProperty(this,M,{writable:true,value:false});Object.defineProperty(this,_,{writable:true,value:0});Object.defineProperty(this,I,{writable:true,value:true});Object.defineProperty(this,f,{writable:true,value:0})}async loadFirstPage(){babelHelpers.classPrivateFieldLooseBase(this,M)[M]=true;const e=await babelHelpers.classPrivateFieldLooseBase(this,C)[C]({firstPage:true});this.firstPageIsLoaded=true;return e}loadNextPage(){if(babelHelpers.classPrivateFieldLooseBase(this,M)[M]||!babelHelpers.classPrivateFieldLooseBase(this,I)[I]){return Promise.resolve()}babelHelpers.classPrivateFieldLooseBase(this,M)[M]=true;return babelHelpers.classPrivateFieldLooseBase(this,C)[C]()}hasMoreItemsToLoad(){return babelHelpers.classPrivateFieldLooseBase(this,I)[I]}}async function x({firstPage:e=false}={}){const t={data:{limit:babelHelpers.classPrivateFieldLooseBase(this,L)[L],filter:{lastMessageId:e?null:babelHelpers.classPrivateFieldLooseBase(this,f)[f]}}};const s=await h.runAction(g.RestMethod.imV2RecentChannelTail,t).catch((e=>{console.error("Im.ChannelList: page request error",e)}));babelHelpers.classPrivateFieldLooseBase(this,_)[_]++;l.Logger.warn(`Im.ChannelList: ${e?"First":babelHelpers.classPrivateFieldLooseBase(this,_)[_]} page request result`,s);const{messages:a,hasNextPage:i}=s;babelHelpers.classPrivateFieldLooseBase(this,f)[f]=babelHelpers.classPrivateFieldLooseBase(this,y)[y](a);if(!i){babelHelpers.classPrivateFieldLooseBase(this,I)[I]=false}babelHelpers.classPrivateFieldLooseBase(this,M)[M]=false;if(e){void c.Core.getStore().dispatch("recent/clearChannelCollection")}return babelHelpers.classPrivateFieldLooseBase(this,P)[P](s)}function S(e){const{users:t,chats:s,messages:a,files:i,recentItems:n}=e;const r=c.Core.getStore().dispatch("users/set",t);const l=c.Core.getStore().dispatch("chats/set",s);const o=c.Core.getStore().dispatch("messages/store",a);const h=c.Core.getStore().dispatch("files/set",i);const d=c.Core.getStore().dispatch("recent/setChannel",n);return Promise.all([r,l,o,h,d])}function T(e){if(e.length===0){return 0}const t=e[0].id;return e.reduce(((e,t)=>Math.min(e,t.id)),t)}const E="IM_SHARED_CHANNEL_LIST";var F=babelHelpers.classPrivateFieldLooseKey("pullClient");var H=babelHelpers.classPrivateFieldLooseKey("requestWatchStart");class A{constructor(){Object.defineProperty(this,H,{value:X});Object.defineProperty(this,F,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,F)[F]=c.Core.getPullClient()}subscribe(){babelHelpers.classPrivateFieldLooseBase(this,F)[F].extendWatch(E);babelHelpers.classPrivateFieldLooseBase(this,H)[H]()}unsubscribe(){babelHelpers.classPrivateFieldLooseBase(this,F)[F].clearWatch(E)}}function X(){void h.runAction(g.RestMethod.imV2RecentChannelExtendPullWatch)}class D extends m.RecentMenu{getMenuItems(){return[this.getOpenItem()]}getOpenItem(){return{text:d.Loc.getMessage("IM_LIB_MENU_OPEN"),onclick:()=>{u.LayoutManager.getInstance().setLayout({name:g.Layout.channel.name,entityId:this.context.dialogId});this.menuInstance.close()}}}}const w={name:"ChannelList",components:{EmptyState:b,LoadingState:a.ListLoadingState,ChannelItem:p},emits:["chatClick"],data(){return{isLoading:false,isLoadingNextPage:false,firstPageLoaded:false}},computed:{collection(){return this.$store.getters["recent/getChannelCollection"]},preparedItems(){return[...this.collection].sort(((e,t)=>{const s=this.$store.getters["recent/getSortDate"](e.dialogId);const a=this.$store.getters["recent/getSortDate"](t.dialogId);return a-s}))},isEmptyCollection(){return this.collection.length===0}},created(){this.joinedChannels=new Set;this.contextMenuManager=new D;this.bindEvents()},beforeUnmount(){this.contextMenuManager.destroy();this.unbindEvents()},async activated(){this.isLoading=true;await this.getRecentService().loadFirstPage();this.firstPageLoaded=true;this.isLoading=false;this.getPullWatchManager().subscribe()},deactivated(){this.removeJoinedChannels();this.getPullWatchManager().unsubscribe()},methods:{async onScroll(e){this.contextMenuManager.close();if(!i.Utils.dom.isOneScreenRemaining(e.target)||!this.getRecentService().hasMoreItemsToLoad){return}this.isLoadingNextPage=true;await this.getRecentService().loadNextPage();this.isLoadingNextPage=false},onClick(e){this.$emit("chatClick",e.dialogId)},onRightClick(e,t){t.preventDefault();this.contextMenuManager.openMenu(e,t.currentTarget)},onChannelJoin(e){const{channelDialogId:t}=e.getData();this.joinedChannels.add(t)},bindEvents(){t.EventEmitter.subscribe(g.EventType.channel.onChannelJoin,this.onChannelJoin)},unbindEvents(){t.EventEmitter.unsubscribe(g.EventType.channel.onChannelJoin,this.onChannelJoin)},removeJoinedChannels(){[...this.joinedChannels].forEach((e=>{this.$store.dispatch("recent/deleteFromChannelCollection",e)}));this.joinedChannels=new Set},getRecentService(){if(!this.service){this.service=new B}return this.service},getPullWatchManager(){if(!this.pullWatchManager){this.pullWatchManager=new A}return this.pullWatchManager},loc(e){return this.$Bitrix.Loc.getMessage(e)}},template:`\n\t\t<div class="bx-im-list-channel__container">\n\t\t\t<LoadingState v-if="isLoading && !firstPageLoaded" />\n\t\t\t<div v-else @scroll="onScroll" class="bx-im-list-channel__scroll-container">\n\t\t\t\t<EmptyState v-if="isEmptyCollection" />\n\t\t\t\t<div class="bx-im-list-channel__general_container">\n\t\t\t\t\t<ChannelItem\n\t\t\t\t\t\tv-for="item in preparedItems"\n\t\t\t\t\t\t:key="item.dialogId"\n\t\t\t\t\t\t:item="item"\n\t\t\t\t\t\t@click="onClick(item)"\n\t\t\t\t\t\t@click.right="onRightClick(item, $event)"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<LoadingState v-if="isLoadingNextPage" />\n\t\t\t</div>\n\t\t</div>\n\t`};e.ChannelList=w})(this.BX.Messenger.v2.Component.List=this.BX.Messenger.v2.Component.List||{},BX.Event,BX.Main,BX.Messenger.v2.Component.Elements,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Const,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib);
//# sourceMappingURL=channel-list.bundle.map.js