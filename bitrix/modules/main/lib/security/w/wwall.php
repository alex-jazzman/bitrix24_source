<? namespace Bitrix\Main\Security\W;$GLOBALS['____468903287']= array(base64_decode('dG'.'ltZQ=='),base64_decode('dG'.'ltZQ=='),base64_decode('anNvb'.'l9kZWN'.'vZGU='),base64_decode('YXJy'.'YXlfbWVyZ2U='),base64_decode('am9'.'pbg='.'='),base64_decode('am9'.'pbg='.'='),base64_decode('am'.'9pbg=='),base64_decode('YXJyYXlfcG9w'),base64_decode(''.'Y'.'X'.'JyY'.'X'.'lfc2hpZn'.'Q='),base64_decode(''.'YXJyYXlfc2hpZn'.'Q='),base64_decode('YX'.'JyYXlfc2hpZnQ='),base64_decode(''.'YXJyYX'.'lfc'.'2hpZnQ'.'='),base64_decode('YXJyY'.'X'.'l'.'fbW'.'Vy'.'Z2U'.'='),base64_decode(''.'aXNf'.'YXJyYX'.'k'.'='),base64_decode('YXJyYXlfbWVyZ2U='),base64_decode('aW5fYX'.'JyY'.'Xk='),base64_decode(''.'a'.'W5f'.'YXJy'.'YX'.'k='),base64_decode(''.'a'.'W5'.'fYXJyYXk'.'='),base64_decode('aW5f'.'YXJyY'.'Xk'.'='),base64_decode('a'.'W5fYXJ'.'y'.'YXk'.'='),base64_decode(''.'dGltZQ=='),base64_decode('d'.'Glt'.'ZQ=='),base64_decode('YX'.'J'.'yYXlfbWFw'),base64_decode(''.'Z2V0X2x'.'vYW'.'RlZF9'.'leHRlbnNpb'.'25z'),base64_decode('anNvbl9lbmNvZGU='),base64_decode('a'.'n'.'Nvbl9lb'.'m'.'NvZGU='),base64_decode('cGhwdm'.'Vyc2lvbg=='),base64_decode(''.'a'.'nNvbl9lbmNvZ'.'GU'.'='),base64_decode('a'.'m9'.'pbg='.'='));if(!function_exists(__NAMESPACE__.'\\___389428213')){function ___389428213($_1708112430){static $_1961875650= false; if($_1961875650 == false) $_1961875650=array(''.'V1'.'dBTE'.'xfTE9DSw='.'=','c2Vjd'.'XJp'.'dH'.'k=','REFUQQ==',''.'eyI=','V1dBTExfTE9DSw==',''.'c2VjdXJpdH'.'k=','U'.'0VDVVJJ'.'VFlfV1'.'dBT'.'Ex'.'fRVh'.'DRVBU'.'SU9O','RkF'.'J'.'T'.'F'.'9DS'.'E'.'VD'.'S'.'0lORw'.'='.'=','Q'.'2FuIG5vdCBle'.'GVjdXRlI'.'Hd'.'3YWxsIHJ1'.'bG'.'V'.'zO'.'iA=','IFRyY'.'W'.'NlOiA=','UkVRVU'.'VTVF9V'.'Ukk=',''.'a2V'.'5'.'cw'.'==','dmFsdWV'.'z',''.'U0VD'.'VVJJVFlf'.'V1'.'dBTExfTU9E'.'SUZZ',''.'L'.'g==','U0V'.'DVVJJVFl'.'f'.'V1dBTEx'.'fVU'.'5'.'TRV'.'Q=','L'.'g'.'==','U0V'.'DVVJ'.'J'.'VFlfV1dBTE'.'x'.'fRVhJVA==','Lg==','Z2x'.'vYmFs','a2V5cw==','dmFsdWVz',''.'Z'.'2V0','Z2V0','cG9zdA==','cG9zdA==','Y29'.'v'.'a'.'2'.'ll','Y29va2ll','cmVx'.'dWVzdA'.'==','c'.'mV'.'xdWVzdA==',''.'Z2'.'xvYmFs','Z2x'.'vYmFs','bW'.'Fpb'.'l9zZWM=','V1dB'.'TExf'.'QUNUV'.'UFMSV'.'pFX1JVTEV'.'T',''.'d'.'g==','dmVyc2l'.'vbg==',''.'aQ==','aX'.'NJbnN0Y'.'Wx'.'sZ'.'W'.'Q=','dg==',''.'a'.'W5'.'p',''.'bW9kd'.'W'.'xl'.'cw==','bG'.'ljZW5zZQ==',''.'cGhw','dg==','ZX'.'h0','c2'.'Vjd'.'XJpdH'.'k=','ZGI=','dHl'.'wZQ='.'=',''.'ZGI=','dmVyc2lvbg==',''.'ZGI=','dHlw'.'ZQ==',''.'ZGI=','d'.'HlwZQ==','dmVyc'.'2'.'lv'.'bg==','ZGI=','dmVyc2'.'lvbg==','ZW52aX'.'Jvb'.'m1'.'lbnQ'.'=','d'.'m1fdmV'.'yc2lvb'.'g==','dm0=','dg==','ZW52'.'a'.'XJ'.'vbm'.'1lbnQ=','dm'.'1'.'fd'.'mVyc2'.'lvbg==','c'.'29ja2V0'.'V'.'Glt'.'ZW9'.'1dA='.'=','c'.'3'.'Ry'.'Z'.'W'.'FtVGltZ'.'W91d'.'A='.'=','KCc=','ZG'.'F'.'0'.'Y'.'Q==',''.'Jy'.'wgJw==','bW'.'9'.'kdWxl',''.'JywgJw==',''.'b'.'W9kdW'.'xlX'.'3'.'ZlcnNpb2'.'4=','Jy'.'k=','L'.'C'.'A=','U0'.'VD'.'VVJ'.'JVFlf'.'V1d'.'BT'.'Exf'.'RVhDR'.'VBUSU9'.'O','b'.'WFpbg==','RkFJTF9SRUZSR'.'VN'.'ISU5H',''.'Q2FuI'.'G5'.'vdCByZWZyZX'.'NoIHd3'.'YW'.'xsIHJ1bGVzOiA=','IF'.'RyYWNlOiA'.'=','ZGF0Y'.'Q='.'=',''.'eyI=','LS'.'0tLS1'.'CRUd'.'JTiBQV'.'UJ'.'MS'.'UMgS0V'.'ZLS'.'0tL'.'S0=',''.'Ck1J'.'SU'.'JJakFOQmdrc'.'Wh'.'raU'.'c5dzBC'.'QVFFRk'.'FBT0NBUT'.'h'.'BT'.'U'.'l'.'J'.'QkNn'.'S0'.'NBU'.'UVBcTh'.'R'.'RTBIam1'.'ISlV'.'TdF'.'dWNm4'.'w'.'emEKUlZvTHg'.'wMkt'.'6'.'Y'.'m'.'ZyYlMvUDZzV2'.'F4V'.'Hp3OFNlR'.'1R0YlR'.'DT'.'3JwS'.'Gk1UU'.'Y2T'.'1J'.'5a'.'lovWH'.'h'.'6'.'L0tMV'.'T'.'FHYm'.'9'.'mOU'.'NaM'.'w'.'o0'.'ejdT'.'a3FVdDY2aWJYdk'.'9GQng0ZncvQVBQ'.'UkdEcXRtMG5EM2ZnR3'.'N'.'1M1JlUGd3MjlpOCt2bTdtdEJLSlV'.'Z'.'bD'.'RyClZwYjZzZ'.'lp'.'FV'.'DlLRW'.'I'.'2'.'VDFI'.'RF'.'lt'.'RXZjMWhxL2lpdXl4THJaWmk1'.'UT'.'ZVZmY0VUV2VEkrNjhz'.'c0ZS'.'a1'.'Er'.'b3dU'.'UnkKZU'.'9J'.'T'.'WJGaE0vVVRt'.'ZlZ'.'ZYlRSRnky'.'b1VROFdNemEyb'.'ko1U2'.'Fo'.'emkxV'.'UtPMWpBalh'.'U'.'UF'.'Jy'.'emM3'.'Q'.'Wp'.'1NjM5'.'aj'.'FPMAp'.'wcHFmb'.'T'.'V4Z1d'.'sR'.'kFK'.'a0hRVGd'.'iZGQ1Q'.'V'.'d'.'x'.'R'.'EZRa3Q5S'.'EtrWStUbmZCTEd'.'WTXZWeVB'.'3VEhOV1FZ'.'QXc0e'.'HBnL3dBCl'.'p3'.'SU'.'RBU'.'UFCCi'.'0tLS0t'.'RU'.'5EIFBVQkxJQyBLRV'.'ktL'.'S0tL'.'Q==');return base64_decode($_1961875650[$_1708112430]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use Bitrix\Main\License\UrlProvider; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; protected $_971562551= true; public function handle(){ try{  $_2113333174= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_2113333174)){ return;}  $_1529889254= Cache::createInstance(); $_34603588= false; if($_1529889254->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_1664418886= $_1529889254->getVars(); if($GLOBALS['____468903287'][0]()- $_1664418886> round(0+20)){  $_730815674= Application::getConnection(); $_2128324914= RuleRecordTable::getTableName(); $_730815674->truncateTable($_2128324914); RuleRecordTable::cleanCache(); $_1529889254->clean(___389428213(0), ___389428213(1));}} elseif($_1529889254->startDataCache()){  $_1529889254->endDataCache($GLOBALS['____468903287'][1]()); $_34603588= true;} foreach($_2113333174 as $_1306091595){ $_1248098112= new PublicKeyCipher; $_1315169931= $_1248098112->decrypt($_1306091595[___389428213(2)], static::__233498912()); if(!str_starts_with($_1315169931, ___389428213(3))){ continue;} $_315561378= $GLOBALS['____468903287'][2]($_1315169931, true); if(!empty($_315561378)){ $_1118123622= Rule::make($_315561378); $_456227497= $this->handleRule($_1118123622); $this->applyHandlingResults($_456227497);}}  if($_34603588){ $_1529889254->clean(___389428213(4), ___389428213(5));}} catch(\Throwable $_1279967463){ $this->logEvent( ___389428213(6), ___389428213(7), ___389428213(8). $_1279967463->getMessage(). ___389428213(9). $_1279967463->getTraceAsString());}}  public function handleRule(Rule $_1118123622): array{ $_456227497=[]; if($_1118123622->matchPath($_SERVER[___389428213(10)])){  $_833397822= $this->getContextElements($_1118123622->getContext()); foreach($_833397822 as $_1237826404 => &$_1544729579){ $_456227497= $GLOBALS['____468903287'][3]($_456227497, $this->recursiveContextKeyHandle($_1237826404, $_1544729579,[], $_1118123622));}} return $_456227497;}  public function applyHandlingResults(array $_456227497){ $_833397822= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_456227497 as $_132144811){ $_1544729579=& $_833397822[$_132144811->getContextName()]; $_28893300= $_132144811->getRuleResult(); $_1118123622= $_132144811->getRule(); if($_28893300 instanceof ModifyResult){ if($_1118123622->getProcess() === ___389428213(11)){  static::rewriteContextKey( $_132144811->getContextName(), $_1544729579, $_132144811->getContextKey(), $_28893300->getCleanValue());} elseif($_1118123622->getProcess() === ___389428213(12)){ static::rewriteContextValue( $_132144811->getContextName(), $_1544729579, $_132144811->getContextKey(), $_28893300->getCleanValue());} $this->logEvent( ___389428213(13), $_132144811->getContextName(), $GLOBALS['____468903287'][4](___389428213(14), $_132144811->getContextKey()));} elseif($_28893300 instanceof CheckResult &&!$_28893300->isSuccess()){ if($_28893300->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_132144811->getContextName(), $_1544729579, $_132144811->getContextKey(),); $this->logEvent( ___389428213(15), $_132144811->getContextName(), $GLOBALS['____468903287'][5](___389428213(16), $_132144811->getContextKey()));} elseif($_28893300->getAction() === RuleAction::EXIT){ $this->logEvent( ___389428213(17), $_132144811->getContextName(), $GLOBALS['____468903287'][6](___389428213(18), $_132144811->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_971562551= false;} protected function rewriteContextKey($_1237826404, &$_1544729579, $_2012603163, $_79997439){ $_1483725888= $_2012603163;  $GLOBALS['____468903287'][7]($_1483725888); $_1483725888[]= $_79997439; if($_1237826404 === ___389428213(19)){ $_1852047715= $GLOBALS['____468903287'][8]($_2012603163); $GLOBALS['____468903287'][9]($_1483725888); if(empty($_2012603163)){ $GLOBALS[$_79997439]= $GLOBALS[$_1852047715]; unset($GLOBALS[$_1852047715]);} else{ $_1544729579=& $GLOBALS[$_1852047715]; $_269572176= ArrayHelper::getByNestedKey($_1544729579, $_2012603163);  ArrayHelper::setByNestedKey($_1544729579, $_1483725888, $_269572176);  ArrayHelper::unsetByNestedKey($_1544729579, $_2012603163);}} else{ $_269572176= ArrayHelper::getByNestedKey($_1544729579, $_2012603163);  ArrayHelper::setByNestedKey($_1544729579, $_1483725888, $_269572176);  ArrayHelper::unsetByNestedKey($_1544729579, $_2012603163);}} protected function rewriteContextValue($_1237826404, &$_1544729579, $_1015896634, $_269572176){ if($_1237826404 === 'global'){ $_1852047715= $GLOBALS['____468903287'][10]($_1015896634); if(empty($_1015896634)){ $GLOBALS[$_1852047715]= $_269572176;} else{ $_1544729579=& $GLOBALS[$_1852047715]; ArrayHelper::setByNestedKey($_1544729579, $_1015896634, $_269572176);}} else{  ArrayHelper::setByNestedKey($_1544729579, $_1015896634, $_269572176);}} protected function unsetContextValue($_1237826404, &$_1544729579, $_1015896634){ if($_1237826404 === 'global'){ $_1852047715= $GLOBALS['____468903287'][11]($_1015896634); if(empty($_1015896634)){ unset($GLOBALS[$_1852047715]);} else{ $_1544729579=& $GLOBALS[$_1852047715]; ArrayHelper::unsetByNestedKey($_1544729579, $_1015896634);}} else{ ArrayHelper::unsetByNestedKey($_1544729579, $_1015896634);}}  protected function recursiveContextKeyHandle(string $_1237826404, array &$_1544729579, array $_2020635708, Rule $_1118123622): array{  $_456227497=[]; foreach($_1544729579 as $_1974285496 => $_269572176){ $_1015896634= $GLOBALS['____468903287'][12]($_2020635708,[$_1974285496]); if($_1118123622->matchKey($_1015896634)){  if($_1118123622->getProcess() === ___389428213(20)){ $_28893300= $_1118123622->evaluate($_1974285496);} elseif($_1118123622->getProcess() === ___389428213(21)){ $_28893300= $_1118123622->evaluateValue($_269572176);}  if(!empty($_28893300) && $_28893300 instanceof RuleResult){ $_456227497[]= new HandlingResult($_1237826404, $_1015896634, $_28893300, $_1118123622);}}  if($GLOBALS['____468903287'][13]($_269572176)){ $_456227497= $GLOBALS['____468903287'][14]($_456227497, $this->recursiveContextKeyHandle( $_1237826404, $_1544729579[$_1974285496], $_1015896634, $_1118123622));}} return $_456227497;} protected function getContextElements(array $_1729107763){ $_701218656=[]; if($GLOBALS['____468903287'][15](___389428213(22), $_1729107763, true)){ $_701218656[___389428213(23)]= &$_GET;} if($GLOBALS['____468903287'][16](___389428213(24), $_1729107763, true)){ $_701218656[___389428213(25)]= &$_POST;} if($GLOBALS['____468903287'][17](___389428213(26), $_1729107763, true)){ $_701218656[___389428213(27)]= &$_COOKIE;} if($GLOBALS['____468903287'][18](___389428213(28), $_1729107763, true)){ $_701218656[___389428213(29)]= &$_REQUEST;} if($GLOBALS['____468903287'][19](___389428213(30), $_1729107763, true)){ $_701218656[___389428213(31)]= $GLOBALS;} return $_701218656;} public static function refreshRules(){ try{ $_33589423= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____468903287'][20]()- $_33589423)< static::CACHE_RULES_TTL){ return;} Option::set(___389428213(32), ___389428213(33), $GLOBALS['____468903287'][21]()); $_323085711= null;  $_697880773= $GLOBALS['____468903287'][22](function($_657055162){ return[___389428213(34) => $_657055162[___389428213(35)], ___389428213(36) => (int) $_657055162[___389428213(37)]];}, ModuleManager::getModulesFromDisk());  $_527809672=[]; foreach($GLOBALS['____468903287'][23]() as $_1586301542){ $_1706946393= new ReflectionExtension($_1586301542); $_527809672[$_1586301542]=[ ___389428213(38) => $_1706946393->getVersion(), ___389428213(39) => $_1706946393->getINIEntries()];} $_1854101245=[ ___389428213(40) => $GLOBALS['____468903287'][24]($_697880773), ___389428213(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___389428213(42) => $GLOBALS['____468903287'][25]([ ___389428213(43) => $GLOBALS['____468903287'][26](), ___389428213(44) => $_527809672])]; if(Loader::includeModule(___389428213(45))){ $_793481448= CSecuritySystemInformation::getSystemInformation(); if(isset($_793481448[___389428213(46)][___389428213(47)]) && isset($_793481448[___389428213(48)][___389428213(49)])){ $_1854101245[___389428213(50)]=[ ___389428213(51) => $_793481448[___389428213(52)][___389428213(53)], ___389428213(54) => $_793481448[___389428213(55)][___389428213(56)]];} if(isset($_793481448[___389428213(57)][___389428213(58)])){ $_1854101245[___389428213(59)]=[___389428213(60) => $_793481448[___389428213(61)][___389428213(62)]];}}  $_1712109527= new HttpClient([ ___389428213(63) => round(0+1+1+1+1+1), ___389428213(64) => round(0+1+1+1+1+1)]); $_58931608=(new UrlProvider())->getTechDomain(); $_511436608="https://wwall.{$_58931608}/rules.php"; $_210759991= $_1712109527->post($_511436608, $_1854101245); if($_1712109527->getStatus() == round(0+200) &&!empty($_210759991)){ $_323085711= Json::decode($_210759991);}  if($_323085711 !== null){ $_730815674= Application::getConnection(); $_2128324914= RuleRecordTable::getTableName(); if(!empty($_323085711)){ foreach($_323085711 as $_1591408454){ if(!static::checkRuleSign($_1591408454)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____468903287'][27]($_1591408454));}}}  $_730815674->truncateTable($_2128324914);  if(!empty($_323085711)){ $_1885731268=[]; foreach($_323085711 as $_1591408454){ $_1885731268[]= ___389428213(65). $_730815674->getSqlHelper()->forSql($_1591408454[___389428213(66)]). ___389428213(67). $_730815674->getSqlHelper()->forSql($_1591408454[___389428213(68)]). ___389428213(69). $_730815674->getSqlHelper()->forSql($_1591408454[___389428213(70)]). ___389428213(71);} $_771635750= $GLOBALS['____468903287'][28](___389428213(72), $_1885731268);  $_730815674->query("INSERT INTO {$_2128324914} (DATA, MODULE, MODULE_VERSION) VALUES {$_771635750}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_1279967463){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___389428213(73), ___389428213(74), ___389428213(75), ___389428213(76). $_1279967463->getMessage(). ___389428213(77). $_1279967463->getTraceAsString());}} protected static function checkRuleSign($_1118123622){ $_1248098112= new PublicKeyCipher; $_315561378= $_1248098112->decrypt($_1118123622[___389428213(78)], static::__233498912()); return str_starts_with($_315561378, ___389428213(79));} private static function __233498912(){ $_214855356= ''; $_214855356 .= ___389428213(80); $_214855356 .= ___389428213(81); return $_214855356;} protected function logEvent($_1381616135, $_1926882465, $_1574503487){ if($this->_971562551){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1381616135, 'main', $_1926882465, $_1574503487);}}}?>