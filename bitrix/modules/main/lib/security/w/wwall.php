<? namespace Bitrix\Main\Security\W;$GLOBALS['____1272186277']= array(base64_decode('dGltZQ=='),base64_decode(''.'dGltZQ='.'='),base64_decode('anNvbl9kZWNvZGU='),base64_decode('YXJy'.'YXlf'.'bWVyZ2'.'U='),base64_decode('am9pbg='.'='),base64_decode('am9pbg=='),base64_decode(''.'am9'.'pbg=='),base64_decode('Y'.'XJyYXlf'.'cG9w'),base64_decode('Y'.'XJyYXl'.'fc'.'2hp'.'ZnQ='),base64_decode('YXJyYXl'.'fc2hpZnQ='),base64_decode(''.'YXJyYXl'.'fc'.'2hpZnQ'.'='),base64_decode('YXJyYXlfc'.'2h'.'pZn'.'Q'.'='),base64_decode('YXJy'.'YXlf'.'bWVy'.'Z2U='),base64_decode('aXNfYXJyYX'.'k='),base64_decode('YXJyYXlfbWVy'.'Z'.'2'.'U='),base64_decode('aW5fYXJyYXk='),base64_decode('aW5f'.'Y'.'XJyYXk'.'='),base64_decode(''.'aW5f'.'YXJ'.'yYXk='),base64_decode('aW5fYXJ'.'y'.'YXk'.'='),base64_decode('aW5'.'f'.'YXJyYXk='),base64_decode('d'.'G'.'ltZQ='.'='),base64_decode('dG'.'ltZQ=='),base64_decode(''.'YXJyYXlfb'.'WFw'),base64_decode(''.'Z2'.'V0X2xvYWRlZ'.'F9leHR'.'l'.'bnNpb25z'),base64_decode('anNvb'.'l9'.'lb'.'mN'.'v'.'ZGU='),base64_decode('a'.'nNvb'.'l9l'.'bmNv'.'ZGU='),base64_decode('cGh'.'wdmVyc2lv'.'bg'.'='.'='),base64_decode('a'.'nNvb'.'l9lbmNv'.'Z'.'GU='),base64_decode('am9pbg'.'=='));if(!function_exists(__NAMESPACE__.'\\___1350152308')){function ___1350152308($_1888610853){static $_567753200= false; if($_567753200 == false) $_567753200=array('V1'.'dBTExf'.'TE9DSw==','c2VjdXJ'.'pdHk=','RE'.'FUQQ==','eyI=','V'.'1'.'dBT'.'Exf'.'TE9DS'.'w==','c2VjdXJpd'.'Hk=',''.'U0VDVVJJVFlfV1'.'d'.'BTExfRV'.'hD'.'R'.'VBUS'.'U9'.'O','RkFJ'.'TF9'.'DS'.'EVDS0l'.'ORw'.'==','Q2FuIG5vdCBl'.'e'.'GVjd'.'XRl'.'IH'.'d3YWxs'.'IH'.'J1'.'bGVzOi'.'A'.'=','IFRyYW'.'Nl'.'OiA=','U'.'kV'.'RVU'.'VTV'.'F9VUkk=','a'.'2V5cw==','dmF'.'sdWVz',''.'U0VD'.'V'.'V'.'JJV'.'Flf'.'V1dBTExfTU9ESUZZ','L'.'g==',''.'U0'.'VDV'.'VJJVFlf'.'V1dBTExfV'.'U5TRVQ=',''.'Lg'.'==','U0VDVVJJVFlfV1dB'.'TExfRVh'.'JV'.'A==','Lg==','Z'.'2xv'.'Y'.'mFs','a2V5'.'cw==',''.'dmFsd'.'WV'.'z','Z2V0','Z2V0','cG9zdA='.'=',''.'cG9zd'.'A==','Y29v'.'a2ll','Y29'.'va2'.'ll',''.'cm'.'Vxd'.'WVzdA'.'==','cmVxdWVzdA==','Z2'.'xvY'.'mFs','Z2xvY'.'mFs','bWF'.'pbl9zZWM=','V1d'.'BTExfQUNU'.'VU'.'F'.'MSVpFX1JVTEVT','dg'.'==','dmVyc2lvbg==','a'.'Q='.'=','aX'.'N'.'J'.'b'.'nN0YWxsZWQ=','dg==','aW5p','bW9kdWxl'.'cw==','bGljZW5z'.'ZQ==','cGhw','dg==',''.'ZXh0',''.'c'.'2VjdXJpdHk=','ZGI=','d'.'HlwZ'.'Q==','ZGI=','dmVyc2lvbg'.'='.'=','ZG'.'I=','dHlwZQ==',''.'ZGI=',''.'d'.'Hlw'.'ZQ==','dmVyc2l'.'vbg==',''.'ZGI=','dmVyc2lvbg='.'=',''.'ZW52aXJvbm1l'.'b'.'nQ=','dm1fdmVyc2lvbg==','dm0=','dg'.'==','ZW5'.'2a'.'XJvbm1lbnQ=','dm1fdmV'.'yc2lvb'.'g==',''.'c29'.'j'.'a2V0V'.'Gl'.'tZ'.'W91dA==','c3R'.'y'.'Z'.'WFtVG'.'ltZW91dA'.'==',''.'KCc=',''.'ZGF0YQ==','Jyw'.'gJw==','bW'.'9kdWxl','Jywg'.'J'.'w='.'=','bW9kdWx'.'lX'.'3'.'ZlcnNpb'.'24=',''.'Jyk'.'=','L'.'CA=','U0VDV'.'V'.'JJ'.'VF'.'l'.'fV'.'1dBTExfR'.'VhD'.'RVB'.'U'.'S'.'U9O','b'.'WF'.'pb'.'g='.'=','R'.'kF'.'JT'.'F9SRUZSR'.'VNIS'.'U5H','Q'.'2FuIG5'.'vd'.'C'.'ByZWZyZ'.'XNoIHd3YWxsIHJ1b'.'G'.'VzO'.'iA=',''.'IFRyYWNlOiA=','ZGF0'.'Y'.'Q==','eyI'.'=',''.'LS0tLS'.'1'.'CRUd'.'JTiBQVUJ'.'MS'.'U'.'Mg'.'S'.'0V'.'ZLS0'.'t'.'LS0=','Ck1JS'.'UJJa'.'kFOQmdr'.'cWhr'.'aUc5dzBCQVFFRkFBT0NBUThB'.'TUlJ'.'QkNnS0NBUUVBcTh'.'RRTB'.'Iam'.'1IS'.'lVTd'.'Fd'.'WNm4w'.'emEK'.'UlZ'.'vTH'.'gwMkt6'.'Y'.'mZyYlMvUDZzV2'.'F'.'4VH'.'p3'.'OFNlR1R0YlR'.'D'.'T3JwSGk1UUY2T'.'1J5a'.'lovWHh6'.'L'.'0tM'.'VT'.'FHYm9mOUNaMwo0'.'e'.'jdTa3FVdDY2aWJY'.'dk9G'.'Qng0ZncvQ'.'VBQUkdEc'.'X'.'R'.'tMG5EM2ZnR3N1M1Jl'.'U'.'Gd3M'.'j'.'lpOCt2b'.'Tdt'.'dEJLSl'.'V'.'ZbDRyC'.'lZwY'.'jZzZl'.'pFVDlL'.'RWI2VDFIRFlt'.'RX'.'Z'.'jMWhxL2lpdXl4'.'T'.'HJaW'.'mk1UTZV'.'ZmY0V'.'U'.'V2VEkrNj'.'hzc0'.'ZSa1E'.'r'.'b3dU'.'UnkKZ'.'U'.'9JT'.'WJGa'.'E0vVVRtZlZZY'.'lRSR'.'nky'.'b1'.'VROF'.'dNemEyb'.'ko'.'1U2'.'FoemkxVUt'.'PM'.'WpBalh'.'U'.'UFJy'.'em'.'M'.'3QWp1'.'Nj'.'M5ajFPMAp'.'wcHFmb'.'TV4Z1dsR'.'k'.'FKa0hRVGdiZGQ1'.'QVdx'.'REZ'.'Ra3'.'Q5'.'SEtrW'.'StUbmZCT'.'EdWTXZWe'.'VB3VEhOV1FZQX'.'c0'.'eHBn'.'L3dBCl'.'p3SURBUUFCCi'.'0tL'.'S'.'0t'.'RU'.'5EIF'.'BV'.'Qkx'.'JQy'.'BLR'.'VktLS0t'.'LQ'.'==');return base64_decode($_567753200[$_1888610853]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_1190435866= 'https://wwall.bitrix.info/rules.php'; protected $_2046348257= true; public function handle(){ try{  $_2088850237= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_2088850237)){ return;}  $_1699552490= Cache::createInstance(); $_2078203647= false; if($_1699552490->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_1013177274= $_1699552490->getVars(); if($GLOBALS['____1272186277'][0]()- $_1013177274> round(0+20)){  $_1003358349= Application::getConnection(); $_856198756= RuleRecordTable::getTableName(); $_1003358349->truncateTable($_856198756); RuleRecordTable::cleanCache(); $_1699552490->clean(___1350152308(0), ___1350152308(1));}} elseif($_1699552490->startDataCache()){  $_1699552490->endDataCache($GLOBALS['____1272186277'][1]()); $_2078203647= true;} foreach($_2088850237 as $_880259046){ $_184872453= new PublicKeyCipher; $_1353997535= $_184872453->decrypt($_880259046[___1350152308(2)], static::__1356454953()); if(!str_starts_with($_1353997535, ___1350152308(3))){ continue;} $_1579713594= $GLOBALS['____1272186277'][2]($_1353997535, true); if(!empty($_1579713594)){ $_1622656150= Rule::make($_1579713594); $_1031905885= $this->handleRule($_1622656150); $this->applyHandlingResults($_1031905885);}}  if($_2078203647){ $_1699552490->clean(___1350152308(4), ___1350152308(5));}} catch(\Throwable $_1501113276){ $this->logEvent( ___1350152308(6), ___1350152308(7), ___1350152308(8). $_1501113276->getMessage(). ___1350152308(9). $_1501113276->getTraceAsString());}}  public function handleRule(Rule $_1622656150): array{ $_1031905885=[]; if($_1622656150->matchPath($_SERVER[___1350152308(10)])){  $_70846137= $this->getContextElements($_1622656150->getContext()); foreach($_70846137 as $_1728734275 => &$_916487564){ $_1031905885= $GLOBALS['____1272186277'][3]($_1031905885, $this->recursiveContextKeyHandle($_1728734275, $_916487564,[], $_1622656150));}} return $_1031905885;}  public function applyHandlingResults(array $_1031905885){ $_70846137= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1031905885 as $_1112672290){ $_916487564=& $_70846137[$_1112672290->getContextName()]; $_1781631697= $_1112672290->getRuleResult(); $_1622656150= $_1112672290->getRule(); if($_1781631697 instanceof ModifyResult){ if($_1622656150->getProcess() === ___1350152308(11)){  static::rewriteContextKey( $_1112672290->getContextName(), $_916487564, $_1112672290->getContextKey(), $_1781631697->getCleanValue());} elseif($_1622656150->getProcess() === ___1350152308(12)){ static::rewriteContextValue( $_1112672290->getContextName(), $_916487564, $_1112672290->getContextKey(), $_1781631697->getCleanValue());} $this->logEvent( ___1350152308(13), $_1112672290->getContextName(), $GLOBALS['____1272186277'][4](___1350152308(14), $_1112672290->getContextKey()));} elseif($_1781631697 instanceof CheckResult &&!$_1781631697->isSuccess()){ if($_1781631697->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_1112672290->getContextName(), $_916487564, $_1112672290->getContextKey(),); $this->logEvent( ___1350152308(15), $_1112672290->getContextName(), $GLOBALS['____1272186277'][5](___1350152308(16), $_1112672290->getContextKey()));} elseif($_1781631697->getAction() === RuleAction::EXIT){ $this->logEvent( ___1350152308(17), $_1112672290->getContextName(), $GLOBALS['____1272186277'][6](___1350152308(18), $_1112672290->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_2046348257= false;} protected function rewriteContextKey($_1728734275, &$_916487564, $_2079932330, $_416936704){ $_673973503= $_2079932330;  $GLOBALS['____1272186277'][7]($_673973503); $_673973503[]= $_416936704; if($_1728734275 === ___1350152308(19)){ $_1296840595= $GLOBALS['____1272186277'][8]($_2079932330); $GLOBALS['____1272186277'][9]($_673973503); if(empty($_2079932330)){ $GLOBALS[$_416936704]= $GLOBALS[$_1296840595]; unset($GLOBALS[$_1296840595]);} else{ $_916487564=& $GLOBALS[$_1296840595]; $_1099693010= ArrayHelper::getByNestedKey($_916487564, $_2079932330);  ArrayHelper::setByNestedKey($_916487564, $_673973503, $_1099693010);  ArrayHelper::unsetByNestedKey($_916487564, $_2079932330);}} else{ $_1099693010= ArrayHelper::getByNestedKey($_916487564, $_2079932330);  ArrayHelper::setByNestedKey($_916487564, $_673973503, $_1099693010);  ArrayHelper::unsetByNestedKey($_916487564, $_2079932330);}} protected function rewriteContextValue($_1728734275, &$_916487564, $_308579413, $_1099693010){ if($_1728734275 === 'global'){ $_1296840595= $GLOBALS['____1272186277'][10]($_308579413); if(empty($_308579413)){ $GLOBALS[$_1296840595]= $_1099693010;} else{ $_916487564=& $GLOBALS[$_1296840595]; ArrayHelper::setByNestedKey($_916487564, $_308579413, $_1099693010);}} else{  ArrayHelper::setByNestedKey($_916487564, $_308579413, $_1099693010);}} protected function unsetContextValue($_1728734275, &$_916487564, $_308579413){ if($_1728734275 === 'global'){ $_1296840595= $GLOBALS['____1272186277'][11]($_308579413); if(empty($_308579413)){ unset($GLOBALS[$_1296840595]);} else{ $_916487564=& $GLOBALS[$_1296840595]; ArrayHelper::unsetByNestedKey($_916487564, $_308579413);}} else{ ArrayHelper::unsetByNestedKey($_916487564, $_308579413);}}  protected function recursiveContextKeyHandle(string $_1728734275, array &$_916487564, array $_365257759, Rule $_1622656150): array{  $_1031905885=[]; foreach($_916487564 as $_903934103 => $_1099693010){ $_308579413= $GLOBALS['____1272186277'][12]($_365257759,[$_903934103]); if($_1622656150->matchKey($_308579413)){  if($_1622656150->getProcess() === ___1350152308(20)){ $_1781631697= $_1622656150->evaluate($_903934103);} elseif($_1622656150->getProcess() === ___1350152308(21)){ $_1781631697= $_1622656150->evaluateValue($_1099693010);}  if(!empty($_1781631697) && $_1781631697 instanceof RuleResult){ $_1031905885[]= new HandlingResult($_1728734275, $_308579413, $_1781631697, $_1622656150);}}  if($GLOBALS['____1272186277'][13]($_1099693010)){ $_1031905885= $GLOBALS['____1272186277'][14]($_1031905885, $this->recursiveContextKeyHandle( $_1728734275, $_916487564[$_903934103], $_308579413, $_1622656150));}} return $_1031905885;} protected function getContextElements(array $_1544891798){ $_2067277082=[]; if($GLOBALS['____1272186277'][15](___1350152308(22), $_1544891798, true)){ $_2067277082[___1350152308(23)]= &$_GET;} if($GLOBALS['____1272186277'][16](___1350152308(24), $_1544891798, true)){ $_2067277082[___1350152308(25)]= &$_POST;} if($GLOBALS['____1272186277'][17](___1350152308(26), $_1544891798, true)){ $_2067277082[___1350152308(27)]= &$_COOKIE;} if($GLOBALS['____1272186277'][18](___1350152308(28), $_1544891798, true)){ $_2067277082[___1350152308(29)]= &$_REQUEST;} if($GLOBALS['____1272186277'][19](___1350152308(30), $_1544891798, true)){ $_2067277082[___1350152308(31)]= $GLOBALS;} return $_2067277082;} public static function refreshRules(){ try{ $_1424564372= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1272186277'][20]()- $_1424564372)< static::CACHE_RULES_TTL){ return;} Option::set(___1350152308(32), ___1350152308(33), $GLOBALS['____1272186277'][21]()); $_772760324= null;  $_224761923= $GLOBALS['____1272186277'][22](function($_2140039522){ return[___1350152308(34) => $_2140039522[___1350152308(35)], ___1350152308(36) => (int) $_2140039522[___1350152308(37)]];}, ModuleManager::getModulesFromDisk());  $_355602559=[]; foreach($GLOBALS['____1272186277'][23]() as $_1455781074){ $_1396554727= new ReflectionExtension($_1455781074); $_355602559[$_1455781074]=[ ___1350152308(38) => $_1396554727->getVersion(), ___1350152308(39) => $_1396554727->getINIEntries()];} $_954412721=[ ___1350152308(40) => $GLOBALS['____1272186277'][24]($_224761923), ___1350152308(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___1350152308(42) => $GLOBALS['____1272186277'][25]([ ___1350152308(43) => $GLOBALS['____1272186277'][26](), ___1350152308(44) => $_355602559])]; if(Loader::includeModule(___1350152308(45))){ $_1483775175= CSecuritySystemInformation::getSystemInformation(); if(isset($_1483775175[___1350152308(46)][___1350152308(47)]) && isset($_1483775175[___1350152308(48)][___1350152308(49)])){ $_954412721[___1350152308(50)]=[ ___1350152308(51) => $_1483775175[___1350152308(52)][___1350152308(53)], ___1350152308(54) => $_1483775175[___1350152308(55)][___1350152308(56)]];} if(isset($_1483775175[___1350152308(57)][___1350152308(58)])){ $_954412721[___1350152308(59)]=[___1350152308(60) => $_1483775175[___1350152308(61)][___1350152308(62)]];}}  $_1856283392= new HttpClient([ ___1350152308(63) => round(0+2.5+2.5), ___1350152308(64) => round(0+1.25+1.25+1.25+1.25)]); $_1496426388= $_1856283392->post( static::$_1190435866, $_954412721); if($_1856283392->getStatus() == round(0+50+50+50+50) &&!empty($_1496426388)){ $_772760324= Json::decode($_1496426388);}  if($_772760324 !== null){ $_1003358349= Application::getConnection(); $_856198756= RuleRecordTable::getTableName(); if(!empty($_772760324)){ foreach($_772760324 as $_788155410){ if(!static::checkRuleSign($_788155410)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1272186277'][27]($_788155410));}}}  $_1003358349->truncateTable($_856198756);  if(!empty($_772760324)){ $_702199433=[]; foreach($_772760324 as $_788155410){ $_702199433[]= ___1350152308(65). $_1003358349->getSqlHelper()->forSql($_788155410[___1350152308(66)]). ___1350152308(67). $_1003358349->getSqlHelper()->forSql($_788155410[___1350152308(68)]). ___1350152308(69). $_1003358349->getSqlHelper()->forSql($_788155410[___1350152308(70)]). ___1350152308(71);} $_810961866= $GLOBALS['____1272186277'][28](___1350152308(72), $_702199433);  $_1003358349->query("INSERT INTO {$_856198756} (DATA, MODULE, MODULE_VERSION) VALUES {$_810961866}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_1501113276){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___1350152308(73), ___1350152308(74), ___1350152308(75), ___1350152308(76). $_1501113276->getMessage(). ___1350152308(77). $_1501113276->getTraceAsString());}} protected static function checkRuleSign($_1622656150){ $_184872453= new PublicKeyCipher; $_1579713594= $_184872453->decrypt($_1622656150[___1350152308(78)], static::__1356454953()); return str_starts_with($_1579713594, ___1350152308(79));} private static function __1356454953(){ $_1227866955= ''; $_1227866955 .= ___1350152308(80); $_1227866955 .= ___1350152308(81); return $_1227866955;} protected function logEvent($_1333940537, $_203791012, $_962781078){ if($this->_2046348257){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1333940537, 'main', $_203791012, $_962781078);}}}?>