<? namespace Bitrix\Main\Security\W;$GLOBALS['____354900877']= array(base64_decode('d'.'Gl'.'tZQ='.'='),base64_decode(''.'dGltZ'.'Q='.'='),base64_decode('a'.'nNvbl9'.'kZWN'.'vZGU='),base64_decode('Y'.'XJ'.'yYXlf'.'bWVyZ2U='),base64_decode('am9pbg=='),base64_decode('am9pbg='.'='),base64_decode('am'.'9'.'pbg'.'=='),base64_decode('YXJyYX'.'lfcG9w'),base64_decode('YX'.'Jy'.'YXlf'.'c2'.'hp'.'ZnQ='),base64_decode('YXJ'.'yYXlfc2h'.'pZ'.'nQ='),base64_decode('YXJyYX'.'lfc'.'2'.'hp'.'ZnQ='),base64_decode('YX'.'JyYXl'.'fc'.'2'.'h'.'p'.'Zn'.'Q'.'='),base64_decode('Y'.'XJyYXl'.'fb'.'WVyZ2U='),base64_decode('aXNfYXJy'.'Y'.'Xk='),base64_decode('YX'.'JyYXlfbWVyZ2'.'U='),base64_decode('aW'.'5'.'f'.'YX'.'JyY'.'Xk='),base64_decode('a'.'W5fYXJ'.'y'.'YXk'.'='),base64_decode('aW5fYXJyY'.'Xk'.'='),base64_decode('aW5fY'.'X'.'JyY'.'Xk'.'='),base64_decode('aW5f'.'YXJy'.'YXk='),base64_decode('d'.'GltZQ'.'=='),base64_decode('dGl'.'tZ'.'Q'.'=='),base64_decode('YXJyYX'.'lfbW'.'Fw'),base64_decode('Z2V0X2x'.'v'.'YW'.'RlZF9leH'.'Rlb'.'nNpb'.'25z'),base64_decode(''.'an'.'Nvbl9'.'lbmNv'.'ZGU'.'='),base64_decode('a'.'nNvbl'.'9lbmNvZGU='),base64_decode('cGhwdmVyc2lvbg='.'='),base64_decode('anNvbl9lb'.'mN'.'v'.'ZGU='),base64_decode('am9pb'.'g='.'='));if(!function_exists(__NAMESPACE__.'\\___835045963')){function ___835045963($_735643813){static $_2877075= false; if($_2877075 == false) $_2877075=array('V1d'.'BTExfTE9D'.'S'.'w'.'==',''.'c2Vj'.'dXJpd'.'H'.'k=',''.'REFUQQ==','eyI=','V1dB'.'TExfTE9D'.'Sw==','c'.'2V'.'j'.'dXJpdHk'.'=',''.'U0V'.'DVVJJVFlfV'.'1dBT'.'ExfR'.'VhDRVB'.'USU'.'9O','RkFJT'.'F9DSE'.'V'.'DS0l'.'ORw==',''.'Q2'.'F'.'uIG'.'5'.'vdCB'.'leGV'.'jdXR'.'lIH'.'d3YW'.'x'.'sIHJ1bGV'.'zOiA=','IFR'.'y'.'YWNlOiA=','UkV'.'RVU'.'VTVF9VUkk=',''.'a2V5cw==','dmFsd'.'WVz','U0VDVVJJVFlfV'.'1dB'.'T'.'ExfTU'.'9E'.'S'.'UZ'.'Z','Lg'.'==','U0V'.'DVVJJVFlfV'.'1d'.'B'.'TExf'.'V'.'U5TRV'.'Q=','Lg==','U0V'.'D'.'VVJJ'.'V'.'FlfV1dBTE'.'xfRVhJVA='.'=','Lg==','Z'.'2xv'.'Ym'.'Fs','a2'.'V5'.'cw='.'=','dmFs'.'d'.'W'.'Vz','Z2V0','Z2V0','cG'.'9'.'zdA==','cG9zdA==','Y29va2ll','Y29va2ll','cmVxdWVzdA==','cmVxdW'.'VzdA==','Z'.'2xvY'.'mFs','Z2xvYmFs','b'.'WF'.'pbl9zZ'.'WM=','V1dB'.'TExfQUNUVUF'.'MSVpFX1JVTE'.'VT','dg'.'==','dmV'.'yc2lvbg==','aQ==',''.'aXNJbnN0Y'.'W'.'xsZWQ=','dg==','aW5p','c'.'29ja2V0'.'VG'.'l'.'tZW91dA='.'=','c'.'3RyZWFt'.'V'.'GltZW'.'91'.'d'.'A==','K'.'Cc'.'=','ZGF'.'0'.'YQ='.'=','J'.'y'.'wgJw='.'=',''.'bW9'.'kd'.'W'.'xl',''.'JywgJw==','bW9'.'k'.'dWxlX3Zlcn'.'Npb'.'24=',''.'Jyk=','LCA'.'=','U'.'0'.'VDVV'.'JJVFlfV1d'.'BTExfRVhDRVB'.'U'.'SU9'.'O','bWFpbg==','RkFJTF9SRUZSRVNIS'.'U5H','Q2FuIG'.'5'.'vd'.'C'.'ByZ'.'WZ'.'yZXNo'.'IHd3'.'YWxsIH'.'J1'.'bGVzOiA=','IF'.'Ry'.'Y'.'WNlOiA=','ZGF0Y'.'Q==',''.'eyI=','LS0tLS1CRUdJTiBQ'.'VUJMSUM'.'gS0'.'VZ'.'LS0tLS0=','Ck1'.'JSUJJ'.'akFOQmd'.'rcWhra'.'Uc5dz'.'BCQVFFRkFBT0NBUThB'.'TU'.'lJQkNnS'.'0NBUU'.'VBcThRRTBI'.'am1ISlVT'.'dFdWNm4'.'wemEKUlZvTH'.'gwMkt'.'6Y'.'m'.'ZyYlMvU'.'DZzV2F'.'4V'.'H'.'p3OF'.'NlR1R'.'0Y'.'lRD'.'T3J'.'wSGk1'.'U'.'U'.'Y'.'2T'.'1'.'J5al'.'ovW'.'Hh6L0tMVTFHYm9mO'.'UNaMwo0ejdTa3FV'.'d'.'DY2aWJYdk9GQn'.'g0'.'Zn'.'cvQVB'.'QUkdEcXRtMG5EM2Z'.'nR3N1M1JlUGd3MjlpOCt'.'2bTdtdEJL'.'S'.'lV'.'Z'.'bDRyClZ'.'w'.'YjZ'.'zZlpFVDl'.'LRWI2VDFIRFlt'.'R'.'XZjMWh'.'xL2l'.'p'.'dXl'.'4THJaW'.'mk1UTZVZmY0VUV2VEkrNj'.'hzc0ZSa1'.'Erb3d'.'UU'.'n'.'kKZU9'.'JTWJGaE0vVV'.'RtZ'.'lZZYlRS'.'Rnkyb'.'1VROF'.'d'.'NemE'.'ybko1'.'U'.'2Foe'.'mkx'.'VUtPMWpBalhUUF'.'Jye'.'mM3QWp1NjM5ajFPMA'.'pw'.'cHFmb'.'TV4Z1dsR'.'kF'.'Ka0hRVGd'.'iZ'.'GQ1QVdxR'.'EZRa3Q5SEtrWSt'.'Ub'.'mZCTE'.'dWTXZWe'.'VB3VEhOV1'.'F'.'ZQXc'.'0eHBnL3dB'.'Clp3SURBUUFCCi0tLS'.'0'.'t'.'RU'.'5EIFBVQkx'.'JQyB'.'LRV'.'ktLS0tLQ==');return base64_decode($_2877075[$_735643813]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_836039368= 'https://wwall.bitrix.info/rules.php'; protected $_165304624= true; public function handle(){ try{  $_1128319340= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_1128319340)){ return;}  $_344259946= Cache::createInstance(); $_183825565= false; if($_344259946->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_1749399545= $_344259946->getVars(); if($GLOBALS['____354900877'][0]()- $_1749399545> round(0+4+4+4+4+4)){  $_87188265= Application::getConnection(); $_332329233= RuleRecordTable::getTableName(); $_87188265->truncateTable($_332329233); RuleRecordTable::cleanCache(); $_344259946->clean(___835045963(0), ___835045963(1));}} elseif($_344259946->startDataCache()){  $_344259946->endDataCache($GLOBALS['____354900877'][1]()); $_183825565= true;} foreach($_1128319340 as $_15303816){ $_34687329= new PublicKeyCipher; $_2025777517= $_34687329->decrypt($_15303816[___835045963(2)], static::__685498663()); if(!str_starts_with($_2025777517, ___835045963(3))){ continue;} $_2086685351= $GLOBALS['____354900877'][2]($_2025777517, true); if(!empty($_2086685351)){ $_676509347= Rule::make($_2086685351); $_1880892519= $this->handleRule($_676509347); $this->applyHandlingResults($_1880892519);}}  if($_183825565){ $_344259946->clean(___835045963(4), ___835045963(5));}} catch(\Throwable $_467999167){ $this->logEvent( ___835045963(6), ___835045963(7), ___835045963(8). $_467999167->getMessage(). ___835045963(9). $_467999167->getTraceAsString());}}  public function handleRule(Rule $_676509347): array{ $_1880892519=[]; if($_676509347->matchPath($_SERVER[___835045963(10)])){  $_1324923371= $this->getContextElements($_676509347->getContext()); foreach($_1324923371 as $_2080961577 => &$_1275405965){ $_1880892519= $GLOBALS['____354900877'][3]($_1880892519, $this->recursiveContextKeyHandle($_2080961577, $_1275405965,[], $_676509347));}} return $_1880892519;}  public function applyHandlingResults(array $_1880892519){ $_1324923371= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1880892519 as $_1631684780){ $_1275405965=& $_1324923371[$_1631684780->getContextName()]; $_1378362862= $_1631684780->getRuleResult(); $_676509347= $_1631684780->getRule(); if($_1378362862 instanceof ModifyResult){ if($_676509347->getProcess() === ___835045963(11)){  static::rewriteContextKey( $_1631684780->getContextName(), $_1275405965, $_1631684780->getContextKey(), $_1378362862->getCleanValue());} elseif($_676509347->getProcess() === ___835045963(12)){ static::rewriteContextValue( $_1631684780->getContextName(), $_1275405965, $_1631684780->getContextKey(), $_1378362862->getCleanValue());} $this->logEvent( ___835045963(13), $_1631684780->getContextName(), $GLOBALS['____354900877'][4](___835045963(14), $_1631684780->getContextKey()));} elseif($_1378362862 instanceof CheckResult &&!$_1378362862->isSuccess()){ if($_1378362862->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_1631684780->getContextName(), $_1275405965, $_1631684780->getContextKey(),); $this->logEvent( ___835045963(15), $_1631684780->getContextName(), $GLOBALS['____354900877'][5](___835045963(16), $_1631684780->getContextKey()));} elseif($_1378362862->getAction() === RuleAction::EXIT){ $this->logEvent( ___835045963(17), $_1631684780->getContextName(), $GLOBALS['____354900877'][6](___835045963(18), $_1631684780->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_165304624= false;} protected function rewriteContextKey($_2080961577, &$_1275405965, $_2143846247, $_1725612876){ $_1342281557= $_2143846247;  $GLOBALS['____354900877'][7]($_1342281557); $_1342281557[]= $_1725612876; if($_2080961577 === ___835045963(19)){ $_248721580= $GLOBALS['____354900877'][8]($_2143846247); $GLOBALS['____354900877'][9]($_1342281557); if(empty($_2143846247)){ $GLOBALS[$_1725612876]= $GLOBALS[$_248721580]; unset($GLOBALS[$_248721580]);} else{ $_1275405965=& $GLOBALS[$_248721580]; $_753816212= ArrayHelper::getByNestedKey($_1275405965, $_2143846247);  ArrayHelper::setByNestedKey($_1275405965, $_1342281557, $_753816212);  ArrayHelper::unsetByNestedKey($_1275405965, $_2143846247);}} else{ $_753816212= ArrayHelper::getByNestedKey($_1275405965, $_2143846247);  ArrayHelper::setByNestedKey($_1275405965, $_1342281557, $_753816212);  ArrayHelper::unsetByNestedKey($_1275405965, $_2143846247);}} protected function rewriteContextValue($_2080961577, &$_1275405965, $_493283734, $_753816212){ if($_2080961577 === 'global'){ $_248721580= $GLOBALS['____354900877'][10]($_493283734); if(empty($_493283734)){ $GLOBALS[$_248721580]= $_753816212;} else{ $_1275405965=& $GLOBALS[$_248721580]; ArrayHelper::setByNestedKey($_1275405965, $_493283734, $_753816212);}} else{  ArrayHelper::setByNestedKey($_1275405965, $_493283734, $_753816212);}} protected function unsetContextValue($_2080961577, &$_1275405965, $_493283734){ if($_2080961577 === 'global'){ $_248721580= $GLOBALS['____354900877'][11]($_493283734); if(empty($_493283734)){ unset($GLOBALS[$_248721580]);} else{ $_1275405965=& $GLOBALS[$_248721580]; ArrayHelper::unsetByNestedKey($_1275405965, $_493283734);}} else{ ArrayHelper::unsetByNestedKey($_1275405965, $_493283734);}}  protected function recursiveContextKeyHandle(string $_2080961577, array &$_1275405965, array $_859492882, Rule $_676509347): array{  $_1880892519=[]; foreach($_1275405965 as $_1365435577 => $_753816212){ $_493283734= $GLOBALS['____354900877'][12]($_859492882,[$_1365435577]); if($_676509347->matchKey($_493283734)){  if($_676509347->getProcess() === ___835045963(20)){ $_1378362862= $_676509347->evaluate($_1365435577);} elseif($_676509347->getProcess() === ___835045963(21)){ $_1378362862= $_676509347->evaluateValue($_753816212);}  if(!empty($_1378362862) && $_1378362862 instanceof RuleResult){ $_1880892519[]= new HandlingResult($_2080961577, $_493283734, $_1378362862, $_676509347);}}  if($GLOBALS['____354900877'][13]($_753816212)){ $_1880892519= $GLOBALS['____354900877'][14]($_1880892519, $this->recursiveContextKeyHandle( $_2080961577, $_1275405965[$_1365435577], $_493283734, $_676509347));}} return $_1880892519;} protected function getContextElements(array $_10455927){ $_1878200606=[]; if($GLOBALS['____354900877'][15](___835045963(22), $_10455927, true)){ $_1878200606[___835045963(23)]= &$_GET;} if($GLOBALS['____354900877'][16](___835045963(24), $_10455927, true)){ $_1878200606[___835045963(25)]= &$_POST;} if($GLOBALS['____354900877'][17](___835045963(26), $_10455927, true)){ $_1878200606[___835045963(27)]= &$_COOKIE;} if($GLOBALS['____354900877'][18](___835045963(28), $_10455927, true)){ $_1878200606[___835045963(29)]= &$_REQUEST;} if($GLOBALS['____354900877'][19](___835045963(30), $_10455927, true)){ $_1878200606[___835045963(31)]= $GLOBALS;} return $_1878200606;} public static function refreshRules(){ try{ $_1578129836= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____354900877'][20]()- $_1578129836)< static::CACHE_RULES_TTL){ return;} Option::set(___835045963(32), ___835045963(33), $GLOBALS['____354900877'][21]()); $_179051069= null;  $_793757240= $GLOBALS['____354900877'][22](function($_611970346){ return[___835045963(34) => $_611970346[___835045963(35)], ___835045963(36) => (int) $_611970346[___835045963(37)]];}, ModuleManager::getModulesFromDisk());  $_2019453118=[]; foreach($GLOBALS['____354900877'][23]() as $_1734649802){ $_591992897= new ReflectionExtension($_1734649802); $_2019453118[$_1734649802]=[ ___835045963(38) => $_591992897->getVersion(), ___835045963(39) => $_591992897->getINIEntries()];}  $_1124543931= new HttpClient([ ___835045963(40) => round(0+5), ___835045963(41) => round(0+1.6666666666667+1.6666666666667+1.6666666666667)]); $_876611713= $_1124543931->post( static::$_836039368,[ 'modules' => $GLOBALS['____354900877'][24]($_793757240), 'license' => Application::getInstance()->getLicense()->getHashLicenseKey(), 'php' => $GLOBALS['____354900877'][25]([ 'v' => $GLOBALS['____354900877'][26](), 'ext' => $_2019453118]),]); if($_1124543931->getStatus() == round(0+200) &&!empty($_876611713)){ $_179051069= Json::decode($_876611713);}  if($_179051069 !== null){ $_87188265= Application::getConnection(); $_332329233= RuleRecordTable::getTableName(); if(!empty($_179051069)){ foreach($_179051069 as $_925461033){ if(!static::checkRuleSign($_925461033)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____354900877'][27]($_925461033));}}}  $_87188265->truncateTable($_332329233);  if(!empty($_179051069)){ $_1206198829=[]; foreach($_179051069 as $_925461033){ $_1206198829[]= ___835045963(42). $_87188265->getSqlHelper()->forSql($_925461033[___835045963(43)]). ___835045963(44). $_87188265->getSqlHelper()->forSql($_925461033[___835045963(45)]). ___835045963(46). $_87188265->getSqlHelper()->forSql($_925461033[___835045963(47)]). ___835045963(48);} $_682625545= $GLOBALS['____354900877'][28](___835045963(49), $_1206198829);  $_87188265->query("INSERT INTO {$_332329233} (DATA, MODULE, MODULE_VERSION) VALUES {$_682625545}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_467999167){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___835045963(50), ___835045963(51), ___835045963(52), ___835045963(53). $_467999167->getMessage(). ___835045963(54). $_467999167->getTraceAsString());}} protected static function checkRuleSign($_676509347){ $_34687329= new PublicKeyCipher; $_2086685351= $_34687329->decrypt($_676509347[___835045963(55)], static::__685498663()); return str_starts_with($_2086685351, ___835045963(56));} private static function __685498663(){ $_816022697= ''; $_816022697 .= ___835045963(57); $_816022697 .= ___835045963(58); return $_816022697;} protected function logEvent($_624206417, $_796597375, $_603826750){ if($this->_165304624){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_624206417, 'main', $_796597375, $_603826750);}}}?>