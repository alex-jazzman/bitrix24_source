<? namespace Bitrix\Main\Security\W;$GLOBALS['____913864264']= array(base64_decode('d'.'Gl'.'tZQ=='),base64_decode('dG'.'lt'.'Z'.'Q='.'='),base64_decode('anNvb'.'l'.'9kZWNv'.'ZGU='),base64_decode('YXJyYX'.'lfb'.'WVyZ2U='),base64_decode('am'.'9pbg=='),base64_decode('am9p'.'bg=='),base64_decode(''.'am9pbg='.'='),base64_decode(''.'YXJyYXlfc'.'G9w'),base64_decode('YXJyYXl'.'fc'.'2hpZnQ='),base64_decode('YXJyY'.'Xlf'.'c2h'.'pZ'.'nQ='),base64_decode('YXJ'.'yYXlfc2'.'hpZnQ'.'='),base64_decode(''.'YXJyYXlfc2'.'hpZnQ'.'='),base64_decode('YXJyYXlf'.'b'.'WV'.'y'.'Z2U='),base64_decode(''.'aXNfYXJyYXk'.'='),base64_decode('YXJyYXl'.'fbWVyZ'.'2U='),base64_decode(''.'a'.'W5'.'fYX'.'JyYX'.'k='),base64_decode('aW5fY'.'X'.'J'.'yYXk='),base64_decode('aW5fYXJyYXk='),base64_decode('aW5fYXJyY'.'Xk='),base64_decode('a'.'W'.'5'.'f'.'YXJ'.'y'.'YXk='),base64_decode('dGl'.'tZQ=='),base64_decode('dGltZQ=='),base64_decode('YXJyYXl'.'fb'.'WFw'),base64_decode('Z2V'.'0X'.'2xvYWRl'.'ZF9'.'le'.'HRlb'.'nNpb2'.'5z'),base64_decode('anNvbl9l'.'bmN'.'v'.'Z'.'G'.'U='),base64_decode('anNvbl9l'.'bmNv'.'Z'.'GU='),base64_decode('cGhwdmV'.'yc2lvbg='.'='),base64_decode('anNv'.'b'.'l9lbmNvZGU='),base64_decode('a'.'m9'.'pbg'.'=='));if(!function_exists(__NAMESPACE__.'\\___949337879')){function ___949337879($_149994676){static $_33540252= false; if($_33540252 == false) $_33540252=array(''.'V1d'.'BTExfTE9DS'.'w==','c2'.'V'.'jdXJp'.'dHk=','REF'.'UQQ==','eyI'.'=','V1dBTExfT'.'E9'.'DSw'.'==','c2VjdXJpdHk=',''.'U0VDVVJJVFlf'.'V1d'.'BTEx'.'f'.'RVhDRVBUSU9O','RkFJ'.'T'.'F'.'9DSEVDS0lORw==','Q'.'2FuI'.'G5'.'vd'.'CBl'.'eGV'.'jdXR'.'lIHd3Y'.'WxsIHJ1bGVzOiA'.'=','IFRyYWNlOiA=','U'.'kVRVUV'.'T'.'VF'.'9'.'VUkk=','a2V5cw==','dmFsdWV'.'z',''.'U'.'0V'.'DVVJJ'.'VFlfV1dBTE'.'x'.'fTU9E'.'S'.'UZ'.'Z','Lg='.'=','U0'.'VDVVJJVFlfV1'.'dBTExfVU5TRVQ=','Lg==','U'.'0VD'.'VVJ'.'JVFlfV1d'.'BTE'.'x'.'fRVhJVA==','Lg'.'==',''.'Z2x'.'vYmFs','a2V'.'5'.'c'.'w'.'==','d'.'m'.'Fs'.'dWVz','Z2V0','Z2'.'V0','c'.'G9zdA==','cG9zd'.'A='.'=','Y2'.'9'.'v'.'a2l'.'l','Y29va2'.'ll','cmVxdWVz'.'dA'.'='.'=','cm'.'V'.'xdW'.'VzdA==',''.'Z2'.'xvYmFs','Z'.'2xvYmFs','bW'.'Fpbl'.'9zZWM=',''.'V1d'.'BTE'.'xfQUN'.'UVU'.'FM'.'S'.'VpFX1JV'.'T'.'E'.'VT','dg==','dmVyc2lvbg==','aQ==',''.'aX'.'NJbnN0Y'.'WxsZWQ=','dg==','aW5p','bW9kdWxlc'.'w==','bGljZW5'.'zZ'.'Q='.'=',''.'cGhw',''.'dg==','ZXh0',''.'c'.'2'.'V'.'jdXJpd'.'Hk=','ZGI'.'=',''.'d'.'HlwZQ==',''.'Z'.'GI'.'=','dm'.'Vyc2lv'.'bg==','ZG'.'I=','dHlwZQ'.'==','ZGI=','dHl'.'wZ'.'Q==','dmV'.'yc'.'2lvbg==','ZGI=',''.'d'.'mV'.'yc'.'2lvbg==',''.'ZW52aXJvbm1l'.'bnQ=','dm1fdmV'.'yc2'.'lvbg==','dm0=','dg==','ZW52'.'a'.'XJvbm1lbnQ=','dm'.'1fdm'.'Vyc2l'.'vbg'.'==','c2'.'9ja2'.'V0VGlt'.'ZW91d'.'A==','c3RyZ'.'WFtVG'.'ltZW9'.'1dA==','KCc'.'=',''.'ZGF0YQ==','Jy'.'wgJ'.'w='.'=','b'.'W9kdWxl','Jy'.'wgJw==','bW9k'.'dWxlX'.'3'.'Zl'.'cnN'.'pb24=','Jyk=',''.'LCA'.'=','U0VDVV'.'JJVFlfV'.'1dB'.'TE'.'xfRVhDRVBUSU9'.'O','bWFpbg==','Rk'.'FJTF'.'9SRUZSR'.'VNISU5H','Q2FuIG5vdCByZW'.'ZyZXNoIHd3YWxs'.'IHJ'.'1bGVzO'.'iA=','I'.'FRyYWNlOiA'.'=','ZGF0YQ='.'=','eyI=','LS0t'.'L'.'S1'.'CR'.'UdJTiBQVUJMSU'.'M'.'g'.'S0VZLS'.'0'.'tL'.'S0=','Ck1JSUJJ'.'akFOQmdrc'.'W'.'hraUc5dz'.'BCQVFFRkFB'.'T0NBUThBTU'.'lJQkNnS0NB'.'UUVBc'.'ThR'.'RTBIam1ISl'.'V'.'TdF'.'d'.'WNm4we'.'mEK'.'UlZvT'.'HgwMkt6YmZy'.'Y'.'l'.'Mv'.'UD'.'ZzV2F4VHp3OFNl'.'R1R0YlR'.'D'.'T'.'3JwSGk1'.'U'.'UY2T1J5alo'.'vWHh'.'6L'.'0tMVTFHYm9mOUNa'.'Mwo0ejd'.'Ta'.'3F'.'Vd'.'DY'.'2a'.'WJ'.'Yd'.'k9'.'GQng'.'0Z'.'n'.'cvQVBQUkdEcX'.'Rt'.'MG5EM2'.'ZnR3N1'.'M1J'.'l'.'U'.'Gd3MjlpOCt2bTdtdEJLSlVZbDRyCl'.'ZwYj'.'ZzZlpFVDlLRWI2'.'VDFIRFltRXZjMWhxL'.'2l'.'pd'.'Xl4THJaWmk1UTZV'.'Zm'.'Y0VUV2VEkrNjhzc0'.'Z'.'S'.'a1'.'Erb'.'3dUUnk'.'KZU9JTWJGaE0'.'vVVR'.'tZlZZYlRSRnky'.'b1V'.'ROFdN'.'emEybko1U2Foemk'.'x'.'V'.'U'.'t'.'PMWpBalhU'.'UF'.'JyemM3QW'.'p1NjM5'.'aj'.'FPMAp'.'wcHFmbTV4Z1dsRkFKa0hRVGdi'.'ZGQ1QVdxREZRa3Q5SE'.'trWStU'.'bmZCTE'.'dW'.'TX'.'ZWeVB3VEh'.'O'.'V1'.'FZQXc'.'0eHB'.'nL3d'.'BClp3SURB'.'UUF'.'CCi0t'.'LS0t'.'RU5EIFB'.'VQkx'.'J'.'Q'.'yBLRVkt'.'LS0tLQ==');return base64_decode($_33540252[$_149994676]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use Bitrix\Main\License\UrlProvider; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; protected $_608213788= true; public function handle(){ try{  $_330756912= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_330756912)){ return;}  $_1362076431= Cache::createInstance(); $_1907188424= false; if($_1362076431->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_1645990822= $_1362076431->getVars(); if($GLOBALS['____913864264'][0]()- $_1645990822> round(0+4+4+4+4+4)){  $_621203750= Application::getConnection(); $_1594410586= RuleRecordTable::getTableName(); $_621203750->truncateTable($_1594410586); RuleRecordTable::cleanCache(); $_1362076431->clean(___949337879(0), ___949337879(1));}} elseif($_1362076431->startDataCache()){  $_1362076431->endDataCache($GLOBALS['____913864264'][1]()); $_1907188424= true;} foreach($_330756912 as $_463335635){ $_1882985758= new PublicKeyCipher; $_1030400345= $_1882985758->decrypt($_463335635[___949337879(2)], static::__738636483()); if(!str_starts_with($_1030400345, ___949337879(3))){ continue;} $_1796774404= $GLOBALS['____913864264'][2]($_1030400345, true); if(!empty($_1796774404)){ $_375659946= Rule::make($_1796774404); $_1404031403= $this->handleRule($_375659946); $this->applyHandlingResults($_1404031403);}}  if($_1907188424){ $_1362076431->clean(___949337879(4), ___949337879(5));}} catch(\Throwable $_896907833){ $this->logEvent( ___949337879(6), ___949337879(7), ___949337879(8). $_896907833->getMessage(). ___949337879(9). $_896907833->getTraceAsString());}}  public function handleRule(Rule $_375659946): array{ $_1404031403=[]; if($_375659946->matchPath($_SERVER[___949337879(10)])){  $_716582926= $this->getContextElements($_375659946->getContext()); foreach($_716582926 as $_417118451 => &$_615333401){ $_1404031403= $GLOBALS['____913864264'][3]($_1404031403, $this->recursiveContextKeyHandle($_417118451, $_615333401,[], $_375659946));}} return $_1404031403;}  public function applyHandlingResults(array $_1404031403){ $_716582926= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1404031403 as $_236923582){ $_615333401=& $_716582926[$_236923582->getContextName()]; $_1399532079= $_236923582->getRuleResult(); $_375659946= $_236923582->getRule(); if($_1399532079 instanceof ModifyResult){ if($_375659946->getProcess() === ___949337879(11)){  static::rewriteContextKey( $_236923582->getContextName(), $_615333401, $_236923582->getContextKey(), $_1399532079->getCleanValue());} elseif($_375659946->getProcess() === ___949337879(12)){ static::rewriteContextValue( $_236923582->getContextName(), $_615333401, $_236923582->getContextKey(), $_1399532079->getCleanValue());} $this->logEvent( ___949337879(13), $_236923582->getContextName(), $GLOBALS['____913864264'][4](___949337879(14), $_236923582->getContextKey()));} elseif($_1399532079 instanceof CheckResult &&!$_1399532079->isSuccess()){ if($_1399532079->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_236923582->getContextName(), $_615333401, $_236923582->getContextKey(),); $this->logEvent( ___949337879(15), $_236923582->getContextName(), $GLOBALS['____913864264'][5](___949337879(16), $_236923582->getContextKey()));} elseif($_1399532079->getAction() === RuleAction::EXIT){ $this->logEvent( ___949337879(17), $_236923582->getContextName(), $GLOBALS['____913864264'][6](___949337879(18), $_236923582->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_608213788= false;} protected function rewriteContextKey($_417118451, &$_615333401, $_1146030230, $_933513845){ $_1212742149= $_1146030230;  $GLOBALS['____913864264'][7]($_1212742149); $_1212742149[]= $_933513845; if($_417118451 === ___949337879(19)){ $_1059356278= $GLOBALS['____913864264'][8]($_1146030230); $GLOBALS['____913864264'][9]($_1212742149); if(empty($_1146030230)){ $GLOBALS[$_933513845]= $GLOBALS[$_1059356278]; unset($GLOBALS[$_1059356278]);} else{ $_615333401=& $GLOBALS[$_1059356278]; $_1339691523= ArrayHelper::getByNestedKey($_615333401, $_1146030230);  ArrayHelper::setByNestedKey($_615333401, $_1212742149, $_1339691523);  ArrayHelper::unsetByNestedKey($_615333401, $_1146030230);}} else{ $_1339691523= ArrayHelper::getByNestedKey($_615333401, $_1146030230);  ArrayHelper::setByNestedKey($_615333401, $_1212742149, $_1339691523);  ArrayHelper::unsetByNestedKey($_615333401, $_1146030230);}} protected function rewriteContextValue($_417118451, &$_615333401, $_964245161, $_1339691523){ if($_417118451 === 'global'){ $_1059356278= $GLOBALS['____913864264'][10]($_964245161); if(empty($_964245161)){ $GLOBALS[$_1059356278]= $_1339691523;} else{ $_615333401=& $GLOBALS[$_1059356278]; ArrayHelper::setByNestedKey($_615333401, $_964245161, $_1339691523);}} else{  ArrayHelper::setByNestedKey($_615333401, $_964245161, $_1339691523);}} protected function unsetContextValue($_417118451, &$_615333401, $_964245161){ if($_417118451 === 'global'){ $_1059356278= $GLOBALS['____913864264'][11]($_964245161); if(empty($_964245161)){ unset($GLOBALS[$_1059356278]);} else{ $_615333401=& $GLOBALS[$_1059356278]; ArrayHelper::unsetByNestedKey($_615333401, $_964245161);}} else{ ArrayHelper::unsetByNestedKey($_615333401, $_964245161);}}  protected function recursiveContextKeyHandle(string $_417118451, array &$_615333401, array $_1619110077, Rule $_375659946): array{  $_1404031403=[]; foreach($_615333401 as $_1632339192 => $_1339691523){ $_964245161= $GLOBALS['____913864264'][12]($_1619110077,[$_1632339192]); if($_375659946->matchKey($_964245161)){  if($_375659946->getProcess() === ___949337879(20)){ $_1399532079= $_375659946->evaluate($_1632339192);} elseif($_375659946->getProcess() === ___949337879(21)){ $_1399532079= $_375659946->evaluateValue($_1339691523);}  if(!empty($_1399532079) && $_1399532079 instanceof RuleResult){ $_1404031403[]= new HandlingResult($_417118451, $_964245161, $_1399532079, $_375659946);}}  if($GLOBALS['____913864264'][13]($_1339691523)){ $_1404031403= $GLOBALS['____913864264'][14]($_1404031403, $this->recursiveContextKeyHandle( $_417118451, $_615333401[$_1632339192], $_964245161, $_375659946));}} return $_1404031403;} protected function getContextElements(array $_89302999){ $_286263055=[]; if($GLOBALS['____913864264'][15](___949337879(22), $_89302999, true)){ $_286263055[___949337879(23)]= &$_GET;} if($GLOBALS['____913864264'][16](___949337879(24), $_89302999, true)){ $_286263055[___949337879(25)]= &$_POST;} if($GLOBALS['____913864264'][17](___949337879(26), $_89302999, true)){ $_286263055[___949337879(27)]= &$_COOKIE;} if($GLOBALS['____913864264'][18](___949337879(28), $_89302999, true)){ $_286263055[___949337879(29)]= &$_REQUEST;} if($GLOBALS['____913864264'][19](___949337879(30), $_89302999, true)){ $_286263055[___949337879(31)]= $GLOBALS;} return $_286263055;} public static function refreshRules(){ try{ $_267582276= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____913864264'][20]()- $_267582276)< static::CACHE_RULES_TTL){ return;} Option::set(___949337879(32), ___949337879(33), $GLOBALS['____913864264'][21]()); $_1261845557= null;  $_1939341758= $GLOBALS['____913864264'][22](function($_1406740193){ return[___949337879(34) => $_1406740193[___949337879(35)], ___949337879(36) => (int) $_1406740193[___949337879(37)]];}, ModuleManager::getModulesFromDisk());  $_793296207=[]; foreach($GLOBALS['____913864264'][23]() as $_1496367963){ $_1059535849= new ReflectionExtension($_1496367963); $_793296207[$_1496367963]=[ ___949337879(38) => $_1059535849->getVersion(), ___949337879(39) => $_1059535849->getINIEntries()];} $_2103362695=[ ___949337879(40) => $GLOBALS['____913864264'][24]($_1939341758), ___949337879(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___949337879(42) => $GLOBALS['____913864264'][25]([ ___949337879(43) => $GLOBALS['____913864264'][26](), ___949337879(44) => $_793296207])]; if(Loader::includeModule(___949337879(45))){ $_2055565425= CSecuritySystemInformation::getSystemInformation(); if(isset($_2055565425[___949337879(46)][___949337879(47)]) && isset($_2055565425[___949337879(48)][___949337879(49)])){ $_2103362695[___949337879(50)]=[ ___949337879(51) => $_2055565425[___949337879(52)][___949337879(53)], ___949337879(54) => $_2055565425[___949337879(55)][___949337879(56)]];} if(isset($_2055565425[___949337879(57)][___949337879(58)])){ $_2103362695[___949337879(59)]=[___949337879(60) => $_2055565425[___949337879(61)][___949337879(62)]];}}  $_2135359888= new HttpClient([ ___949337879(63) => round(0+5), ___949337879(64) => round(0+2.5+2.5)]); $_1343229869=(new UrlProvider())->getTechDomain(); $_2134242817="https://wwall.{$_1343229869}/rules.php"; $_933968759= $_2135359888->post($_2134242817, $_2103362695); if($_2135359888->getStatus() == round(0+40+40+40+40+40) &&!empty($_933968759)){ $_1261845557= Json::decode($_933968759);}  if($_1261845557 !== null){ $_621203750= Application::getConnection(); $_1594410586= RuleRecordTable::getTableName(); if(!empty($_1261845557)){ foreach($_1261845557 as $_886577779){ if(!static::checkRuleSign($_886577779)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____913864264'][27]($_886577779));}}}  $_621203750->truncateTable($_1594410586);  if(!empty($_1261845557)){ $_448225649=[]; foreach($_1261845557 as $_886577779){ $_448225649[]= ___949337879(65). $_621203750->getSqlHelper()->forSql($_886577779[___949337879(66)]). ___949337879(67). $_621203750->getSqlHelper()->forSql($_886577779[___949337879(68)]). ___949337879(69). $_621203750->getSqlHelper()->forSql($_886577779[___949337879(70)]). ___949337879(71);} $_619608607= $GLOBALS['____913864264'][28](___949337879(72), $_448225649);  $_621203750->query("INSERT INTO {$_1594410586} (DATA, MODULE, MODULE_VERSION) VALUES {$_619608607}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_896907833){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___949337879(73), ___949337879(74), ___949337879(75), ___949337879(76). $_896907833->getMessage(). ___949337879(77). $_896907833->getTraceAsString());}} protected static function checkRuleSign($_375659946){ $_1882985758= new PublicKeyCipher; $_1796774404= $_1882985758->decrypt($_375659946[___949337879(78)], static::__738636483()); return str_starts_with($_1796774404, ___949337879(79));} private static function __738636483(){ $_1453886915= ''; $_1453886915 .= ___949337879(80); $_1453886915 .= ___949337879(81); return $_1453886915;} protected function logEvent($_1240335310, $_483423771, $_661415146){ if($this->_608213788){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1240335310, 'main', $_483423771, $_661415146);}}}?>