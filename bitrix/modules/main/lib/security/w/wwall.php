<? namespace Bitrix\Main\Security\W;$GLOBALS['____1735285425']= array(base64_decode('dGl'.'tZQ'.'=='),base64_decode(''.'dGltZQ=='),base64_decode(''.'anNv'.'b'.'l9kZWNvZGU='),base64_decode('YXJyY'.'XlfbWVyZ2U='),base64_decode('am9pb'.'g=='),base64_decode(''.'am9p'.'bg'.'=='),base64_decode('am9p'.'bg=='),base64_decode(''.'YXJyYXlfcG9w'),base64_decode('YXJ'.'yY'.'Xlfc2hpZnQ='),base64_decode(''.'Y'.'XJyYX'.'lf'.'c2hpZn'.'Q'.'='),base64_decode('YXJyYXlfc'.'2hp'.'ZnQ='),base64_decode('YXJy'.'YX'.'lfc2h'.'pZnQ='),base64_decode('YXJyYXlfbW'.'VyZ2U='),base64_decode('a'.'XNfYXJy'.'YXk='),base64_decode('YX'.'JyYX'.'lfbWVyZ2'.'U'.'='),base64_decode('aW5fYXJyYXk'.'='),base64_decode('aW5fYXJ'.'yY'.'X'.'k='),base64_decode('aW5fYXJyYX'.'k'.'='),base64_decode('a'.'W5'.'fYXJyY'.'Xk='),base64_decode(''.'aW5'.'fYXJ'.'yYXk='),base64_decode('dGl'.'t'.'ZQ=='),base64_decode('dGltZQ=='),base64_decode(''.'YX'.'JyYXlfbWFw'),base64_decode('Z2V0X2xv'.'YWR'.'lZF'.'9le'.'HRlbnNp'.'b'.'25z'),base64_decode('an'.'Nvbl9'.'lbm'.'NvZGU='),base64_decode('anNvbl9'.'lbmNvZGU='),base64_decode('cGh'.'wdmVyc2'.'lvb'.'g=='),base64_decode('anNvb'.'l9lbmNv'.'Z'.'GU='),base64_decode(''.'am9pbg'.'=='));if(!function_exists(__NAMESPACE__.'\\___835630083')){function ___835630083($_1347799675){static $_149258212= false; if($_149258212 == false) $_149258212=array('V1dBTExfTE9D'.'Sw'.'==','c2'.'V'.'jdX'.'JpdH'.'k=',''.'RE'.'FU'.'QQ'.'==','ey'.'I'.'=','V1dBTExfTE9DSw='.'=','c2V'.'jdXJpdHk'.'=','U0VD'.'V'.'V'.'JJVFlf'.'V1dB'.'TE'.'xfRVhD'.'RVBU'.'SU9'.'O','RkFJTF9'.'DSEVDS0lORw'.'==','Q2'.'FuIG5vd'.'CBle'.'GV'.'jdX'.'R'.'lIH'.'d3YWxsIHJ1b'.'G'.'VzOiA=','IFRyYWNlOi'.'A'.'=','U'.'kV'.'RVUVTVF9'.'VUkk=','a2'.'V5cw'.'='.'=','dmFsdW'.'Vz',''.'U0VD'.'VVJJ'.'VF'.'l'.'f'.'V1'.'dBTExfTU9ESU'.'Z'.'Z','Lg==','U0VDVV'.'JJV'.'Fl'.'fV'.'1dB'.'TEx'.'fVU5TRVQ=','Lg'.'='.'=','U0VDVVJJVFl'.'fV1dBT'.'Ex'.'fRVhJVA==','Lg='.'=','Z2'.'xvY'.'mFs',''.'a'.'2V5'.'cw==','dmFsdW'.'V'.'z','Z2V'.'0','Z'.'2V0','cG9zd'.'A='.'=','c'.'G9z'.'d'.'A'.'==','Y29'.'va2l'.'l','Y'.'29va2ll',''.'cmVxdW'.'VzdA==',''.'c'.'mVxdWVzd'.'A==',''.'Z2xvYmFs','Z'.'2xvY'.'mFs','b'.'WF'.'p'.'bl9z'.'ZW'.'M=','V1'.'dB'.'TEx'.'fQUNUVUFMSVpF'.'X1J'.'VT'.'EVT','d'.'g='.'=','dmV'.'yc2'.'l'.'vb'.'g='.'=','a'.'Q='.'=','aX'.'N'.'Jb'.'n'.'N0'.'YWx'.'sZWQ=','dg==',''.'aW'.'5p','bW9'.'kdWxlcw==','bGlj'.'ZW5zZ'.'Q==','cGhw','dg='.'=',''.'ZXh0','c'.'2V'.'jdX'.'J'.'p'.'dHk'.'=','ZGI=','dHlwZQ==',''.'ZGI=','d'.'mVy'.'c2'.'lvb'.'g'.'==','ZGI=','dHlwZQ==',''.'ZG'.'I=',''.'dHlw'.'ZQ==','dmVyc2lvbg==','ZGI=',''.'dmVyc2lvb'.'g'.'==','ZW'.'52a'.'XJv'.'bm'.'1l'.'bnQ=','dm'.'1fd'.'mV'.'y'.'c2l'.'vb'.'g==',''.'dm0'.'=','dg==','Z'.'W52a'.'X'.'Jvbm1l'.'bnQ=','dm1fd'.'mVyc2l'.'v'.'bg==','c'.'29j'.'a2V0VGl'.'tZW9'.'1dA'.'==','c'.'3RyZW'.'FtV'.'GltZW9'.'1dA==','KCc=','Z'.'GF0YQ='.'=',''.'JywgJ'.'w==','bW9k'.'d'.'Wxl',''.'Jywg'.'Jw'.'='.'=','bW'.'9kdWx'.'lX3Zlcn'.'N'.'pb'.'24=','Jyk=','L'.'CA=','U0VD'.'VVJJVFlfV'.'1d'.'BTExfRVh'.'D'.'RVBUSU9O','b'.'WFpbg==','RkF'.'JTF9SRUZ'.'SRVNISU5H','Q2'.'FuIG5vdCB'.'yZWZyZXN'.'o'.'IHd3YWxs'.'I'.'HJ1b'.'GVzOiA=','IFRyYWNl'.'OiA'.'=','ZGF0YQ==','eyI'.'=','LS0'.'tLS1CRU'.'dJTiBQVUJ'.'M'.'SUMgS0VZLS0'.'tLS'.'0=','Ck1JS'.'UJJakFO'.'Qmdrc'.'Wh'.'raUc5dzBCQVF'.'FRkF'.'BT0'.'NBUT'.'hBTUl'.'JQkN'.'n'.'S0NBUU'.'VBcThRRTB'.'Iam1I'.'SlVT'.'dFd'.'WNm'.'4'.'we'.'mE'.'KUlZ'.'v'.'THg'.'wMkt6YmZyYlMvUDZzV2F'.'4'.'V'.'Hp3'.'OFN'.'lR1R0Y'.'lRDT3Jw'.'SGk1UUY2T1J5alovWHh6L'.'0tM'.'VT'.'F'.'H'.'Ym'.'9mOUNaMwo0e'.'jdTa3FVdD'.'Y2aWJYdk9'.'GQng'.'0ZncvQV'.'BQUkdEc'.'XR'.'tMG'.'5'.'EM2ZnR3N1'.'M1J'.'l'.'U'.'Gd3Mjl'.'pOCt2bT'.'d'.'t'.'dE'.'JLS'.'lVZbDRy'.'ClZw'.'YjZ'.'zZlp'.'FVDlLRWI2VDFIRF'.'ltRXZjM'.'Wh'.'xL2lpdXl4THJaWmk1UTZV'.'Zm'.'Y0VUV2'.'V'.'EkrNjhzc'.'0ZSa1Erb3dUUnkKZU9'.'JT'.'WJGaE0vVVRtZlZZYlR'.'S'.'Rn'.'k'.'y'.'b1VRO'.'FdN'.'emEybko1U2Foemk'.'xVUt'.'PM'.'W'.'pBal'.'hUU'.'FJyemM3QW'.'p1NjM5ajFPMApwcHFmbTV4Z1dsR'.'kFKa'.'0hRVGdiZ'.'GQ1QVdxR'.'EZR'.'a3'.'Q5SEtr'.'WS'.'tUb'.'mZCT'.'EdWTX'.'ZW'.'eVB3VEhO'.'V1FZ'.'QX'.'c'.'0e'.'HB'.'n'.'L3dBClp3SU'.'RBU'.'UF'.'C'.'Ci0tLS0tR'.'U5EIFBVQkxJQyBLRVk'.'tLS0'.'tL'.'Q==');return base64_decode($_149258212[$_1347799675]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use Bitrix\Main\License\UrlProvider; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; protected $_606100480= true; public function handle(){ try{  $_1997903243= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_1997903243)){ return;}  $_1052344316= Cache::createInstance(); $_39337984= false; if($_1052344316->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_926202518= $_1052344316->getVars(); if($GLOBALS['____1735285425'][0]()- $_926202518> round(0+4+4+4+4+4)){  $_758342007= Application::getConnection(); $_1460779861= RuleRecordTable::getTableName(); $_758342007->truncateTable($_1460779861); RuleRecordTable::cleanCache(); $_1052344316->clean(___835630083(0), ___835630083(1));}} elseif($_1052344316->startDataCache()){  $_1052344316->endDataCache($GLOBALS['____1735285425'][1]()); $_39337984= true;} foreach($_1997903243 as $_155018572){ $_1705667511= new PublicKeyCipher; $_1382173505= $_1705667511->decrypt($_155018572[___835630083(2)], static::__761396047()); if(!str_starts_with($_1382173505, ___835630083(3))){ continue;} $_546752494= $GLOBALS['____1735285425'][2]($_1382173505, true); if(!empty($_546752494)){ $_553533764= Rule::make($_546752494); $_1391755367= $this->handleRule($_553533764); $this->applyHandlingResults($_1391755367);}}  if($_39337984){ $_1052344316->clean(___835630083(4), ___835630083(5));}} catch(\Throwable $_1825833426){ $this->logEvent( ___835630083(6), ___835630083(7), ___835630083(8). $_1825833426->getMessage(). ___835630083(9). $_1825833426->getTraceAsString());}}  public function handleRule(Rule $_553533764): array{ $_1391755367=[]; if($_553533764->matchPath($_SERVER[___835630083(10)])){  $_752760746= $this->getContextElements($_553533764->getContext()); foreach($_752760746 as $_1375928959 => &$_1131732568){ $_1391755367= $GLOBALS['____1735285425'][3]($_1391755367, $this->recursiveContextKeyHandle($_1375928959, $_1131732568,[], $_553533764));}} return $_1391755367;}  public function applyHandlingResults(array $_1391755367){ $_752760746= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1391755367 as $_1631946610){ $_1131732568=& $_752760746[$_1631946610->getContextName()]; $_2010157617= $_1631946610->getRuleResult(); $_553533764= $_1631946610->getRule(); if($_2010157617 instanceof ModifyResult){ if($_553533764->getProcess() === ___835630083(11)){  static::rewriteContextKey( $_1631946610->getContextName(), $_1131732568, $_1631946610->getContextKey(), $_2010157617->getCleanValue());} elseif($_553533764->getProcess() === ___835630083(12)){ static::rewriteContextValue( $_1631946610->getContextName(), $_1131732568, $_1631946610->getContextKey(), $_2010157617->getCleanValue());} $this->logEvent( ___835630083(13), $_1631946610->getContextName(), $GLOBALS['____1735285425'][4](___835630083(14), $_1631946610->getContextKey()));} elseif($_2010157617 instanceof CheckResult &&!$_2010157617->isSuccess()){ if($_2010157617->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_1631946610->getContextName(), $_1131732568, $_1631946610->getContextKey(),); $this->logEvent( ___835630083(15), $_1631946610->getContextName(), $GLOBALS['____1735285425'][5](___835630083(16), $_1631946610->getContextKey()));} elseif($_2010157617->getAction() === RuleAction::EXIT){ $this->logEvent( ___835630083(17), $_1631946610->getContextName(), $GLOBALS['____1735285425'][6](___835630083(18), $_1631946610->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_606100480= false;} protected function rewriteContextKey($_1375928959, &$_1131732568, $_699365997, $_190232110){ $_940347331= $_699365997;  $GLOBALS['____1735285425'][7]($_940347331); $_940347331[]= $_190232110; if($_1375928959 === ___835630083(19)){ $_669571672= $GLOBALS['____1735285425'][8]($_699365997); $GLOBALS['____1735285425'][9]($_940347331); if(empty($_699365997)){ $GLOBALS[$_190232110]= $GLOBALS[$_669571672]; unset($GLOBALS[$_669571672]);} else{ $_1131732568=& $GLOBALS[$_669571672]; $_1944436244= ArrayHelper::getByNestedKey($_1131732568, $_699365997);  ArrayHelper::setByNestedKey($_1131732568, $_940347331, $_1944436244);  ArrayHelper::unsetByNestedKey($_1131732568, $_699365997);}} else{ $_1944436244= ArrayHelper::getByNestedKey($_1131732568, $_699365997);  ArrayHelper::setByNestedKey($_1131732568, $_940347331, $_1944436244);  ArrayHelper::unsetByNestedKey($_1131732568, $_699365997);}} protected function rewriteContextValue($_1375928959, &$_1131732568, $_1264129769, $_1944436244){ if($_1375928959 === 'global'){ $_669571672= $GLOBALS['____1735285425'][10]($_1264129769); if(empty($_1264129769)){ $GLOBALS[$_669571672]= $_1944436244;} else{ $_1131732568=& $GLOBALS[$_669571672]; ArrayHelper::setByNestedKey($_1131732568, $_1264129769, $_1944436244);}} else{  ArrayHelper::setByNestedKey($_1131732568, $_1264129769, $_1944436244);}} protected function unsetContextValue($_1375928959, &$_1131732568, $_1264129769){ if($_1375928959 === 'global'){ $_669571672= $GLOBALS['____1735285425'][11]($_1264129769); if(empty($_1264129769)){ unset($GLOBALS[$_669571672]);} else{ $_1131732568=& $GLOBALS[$_669571672]; ArrayHelper::unsetByNestedKey($_1131732568, $_1264129769);}} else{ ArrayHelper::unsetByNestedKey($_1131732568, $_1264129769);}}  protected function recursiveContextKeyHandle(string $_1375928959, array &$_1131732568, array $_787853373, Rule $_553533764): array{  $_1391755367=[]; foreach($_1131732568 as $_1737609723 => $_1944436244){ $_1264129769= $GLOBALS['____1735285425'][12]($_787853373,[$_1737609723]); if($_553533764->matchKey($_1264129769)){  if($_553533764->getProcess() === ___835630083(20)){ $_2010157617= $_553533764->evaluate($_1737609723);} elseif($_553533764->getProcess() === ___835630083(21)){ $_2010157617= $_553533764->evaluateValue($_1944436244);}  if(!empty($_2010157617) && $_2010157617 instanceof RuleResult){ $_1391755367[]= new HandlingResult($_1375928959, $_1264129769, $_2010157617, $_553533764);}}  if($GLOBALS['____1735285425'][13]($_1944436244)){ $_1391755367= $GLOBALS['____1735285425'][14]($_1391755367, $this->recursiveContextKeyHandle( $_1375928959, $_1131732568[$_1737609723], $_1264129769, $_553533764));}} return $_1391755367;} protected function getContextElements(array $_772328352){ $_748024045=[]; if($GLOBALS['____1735285425'][15](___835630083(22), $_772328352, true)){ $_748024045[___835630083(23)]= &$_GET;} if($GLOBALS['____1735285425'][16](___835630083(24), $_772328352, true)){ $_748024045[___835630083(25)]= &$_POST;} if($GLOBALS['____1735285425'][17](___835630083(26), $_772328352, true)){ $_748024045[___835630083(27)]= &$_COOKIE;} if($GLOBALS['____1735285425'][18](___835630083(28), $_772328352, true)){ $_748024045[___835630083(29)]= &$_REQUEST;} if($GLOBALS['____1735285425'][19](___835630083(30), $_772328352, true)){ $_748024045[___835630083(31)]= $GLOBALS;} return $_748024045;} public static function refreshRules(){ try{ $_1997436272= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1735285425'][20]()- $_1997436272)< static::CACHE_RULES_TTL){ return;} Option::set(___835630083(32), ___835630083(33), $GLOBALS['____1735285425'][21]()); $_662695624= null;  $_889881609= $GLOBALS['____1735285425'][22](function($_1910357605){ return[___835630083(34) => $_1910357605[___835630083(35)], ___835630083(36) => (int) $_1910357605[___835630083(37)]];}, ModuleManager::getModulesFromDisk());  $_583552298=[]; foreach($GLOBALS['____1735285425'][23]() as $_204629904){ $_2051640943= new ReflectionExtension($_204629904); $_583552298[$_204629904]=[ ___835630083(38) => $_2051640943->getVersion(), ___835630083(39) => $_2051640943->getINIEntries()];} $_560428506=[ ___835630083(40) => $GLOBALS['____1735285425'][24]($_889881609), ___835630083(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___835630083(42) => $GLOBALS['____1735285425'][25]([ ___835630083(43) => $GLOBALS['____1735285425'][26](), ___835630083(44) => $_583552298])]; if(Loader::includeModule(___835630083(45))){ $_765250715= CSecuritySystemInformation::getSystemInformation(); if(isset($_765250715[___835630083(46)][___835630083(47)]) && isset($_765250715[___835630083(48)][___835630083(49)])){ $_560428506[___835630083(50)]=[ ___835630083(51) => $_765250715[___835630083(52)][___835630083(53)], ___835630083(54) => $_765250715[___835630083(55)][___835630083(56)]];} if(isset($_765250715[___835630083(57)][___835630083(58)])){ $_560428506[___835630083(59)]=[___835630083(60) => $_765250715[___835630083(61)][___835630083(62)]];}}  $_758577706= new HttpClient([ ___835630083(63) => round(0+1.25+1.25+1.25+1.25), ___835630083(64) => round(0+1.6666666666667+1.6666666666667+1.6666666666667)]); $_1956322219=(new UrlProvider())->getTechDomain(); $_577862755="https://wwall.{$_1956322219}/rules.php"; $_1013889932= $_758577706->post($_577862755, $_560428506); if($_758577706->getStatus() == round(0+50+50+50+50) &&!empty($_1013889932)){ $_662695624= Json::decode($_1013889932);}  if($_662695624 !== null){ $_758342007= Application::getConnection(); $_1460779861= RuleRecordTable::getTableName(); if(!empty($_662695624)){ foreach($_662695624 as $_1816693189){ if(!static::checkRuleSign($_1816693189)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1735285425'][27]($_1816693189));}}}  $_758342007->truncateTable($_1460779861);  if(!empty($_662695624)){ $_956996462=[]; foreach($_662695624 as $_1816693189){ $_956996462[]= ___835630083(65). $_758342007->getSqlHelper()->forSql($_1816693189[___835630083(66)]). ___835630083(67). $_758342007->getSqlHelper()->forSql($_1816693189[___835630083(68)]). ___835630083(69). $_758342007->getSqlHelper()->forSql($_1816693189[___835630083(70)]). ___835630083(71);} $_108134820= $GLOBALS['____1735285425'][28](___835630083(72), $_956996462);  $_758342007->query("INSERT INTO {$_1460779861} (DATA, MODULE, MODULE_VERSION) VALUES {$_108134820}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_1825833426){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___835630083(73), ___835630083(74), ___835630083(75), ___835630083(76). $_1825833426->getMessage(). ___835630083(77). $_1825833426->getTraceAsString());}} protected static function checkRuleSign($_553533764){ $_1705667511= new PublicKeyCipher; $_546752494= $_1705667511->decrypt($_553533764[___835630083(78)], static::__761396047()); return str_starts_with($_546752494, ___835630083(79));} private static function __761396047(){ $_1545841748= ''; $_1545841748 .= ___835630083(80); $_1545841748 .= ___835630083(81); return $_1545841748;} protected function logEvent($_673599766, $_1408417710, $_1812193384){ if($this->_606100480){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_673599766, 'main', $_1408417710, $_1812193384);}}}?>