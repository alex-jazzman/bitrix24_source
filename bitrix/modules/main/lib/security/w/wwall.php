<? namespace Bitrix\Main\Security\W;$GLOBALS['____1751529081']= array(base64_decode('d'.'GltZQ='.'='),base64_decode(''.'dGltZQ=='),base64_decode('anN'.'v'.'bl9kZ'.'WN'.'vZG'.'U='),base64_decode('YX'.'JyYX'.'lfb'.'WVyZ'.'2U='),base64_decode('am9pbg=='),base64_decode('a'.'m'.'9p'.'bg=='),base64_decode(''.'am9p'.'bg='.'='),base64_decode(''.'YXJyYXlfcG9w'),base64_decode('YXJyYXlfc'.'2hp'.'Zn'.'Q'.'='),base64_decode('YXJyYXlfc'.'2hpZnQ='),base64_decode('YXJyY'.'Xlfc2'.'hpZ'.'nQ='),base64_decode(''.'YXJyYXlfc2hpZnQ='),base64_decode('YXJyYX'.'l'.'fbW'.'VyZ2U='),base64_decode('aXNfYXJ'.'yYXk='),base64_decode('YXJyYXl'.'f'.'b'.'W'.'V'.'yZ2U='),base64_decode(''.'a'.'W'.'5'.'fYX'.'JyY'.'Xk'.'='),base64_decode('aW5fY'.'XJyYXk='),base64_decode(''.'aW5'.'f'.'Y'.'XJyY'.'Xk='),base64_decode('aW'.'5fYXJyYX'.'k='),base64_decode('a'.'W5fYXJyY'.'Xk='),base64_decode('dGltZQ'.'=='),base64_decode('dGl'.'t'.'ZQ=='),base64_decode('YXJyYXl'.'fbWFw'),base64_decode('Z2V0X2xvYWR'.'l'.'ZF9leHRlb'.'nNpb25z'),base64_decode('a'.'nNv'.'bl9lbmNv'.'ZGU='),base64_decode('anNvb'.'l'.'9l'.'bmN'.'v'.'Z'.'GU='),base64_decode('c'.'Ghw'.'dmVyc2'.'lvb'.'g='.'='),base64_decode('anNvbl9lbmN'.'vZGU='),base64_decode('am9p'.'bg=='));if(!function_exists(__NAMESPACE__.'\\___172330570')){function ___172330570($_1576176466){static $_500184942= false; if($_500184942 == false) $_500184942=array(''.'V1dBTEx'.'fTE9DSw'.'==',''.'c2VjdXJpdHk=','REF'.'UQQ==','eyI=','V1dBTExfTE9DSw='.'=','c2VjdX'.'JpdH'.'k=','U0VDVVJJ'.'VF'.'lf'.'V'.'1dBTExfRVhD'.'RVBUSU9O','R'.'kFJTF9DS'.'EVDS'.'0lOR'.'w==','Q'.'2FuIG5vdCBl'.'eGVjdX'.'Rl'.'IHd3'.'YW'.'xsIHJ1bGVzO'.'iA=','I'.'FRyYWNlOiA=','Uk'.'VRVUV'.'T'.'VF9VUk'.'k'.'=',''.'a2V5cw'.'='.'=','dmFs'.'dWVz','U0VD'.'VV'.'JJVFlf'.'V1dB'.'T'.'E'.'xfTU9ES'.'UZZ','Lg==','U0VDVV'.'JJVFlfV1dB'.'TExfVU5TRVQ'.'=','L'.'g==','U0V'.'DVVJ'.'JVFl'.'fV1dBTE'.'x'.'fR'.'V'.'h'.'JVA==','Lg==','Z2xvY'.'mF'.'s','a2V5cw==',''.'dmFsdWVz','Z2'.'V0','Z2V0','cG9'.'z'.'dA==','cG9zdA==','Y'.'29va2ll','Y29va2l'.'l','cm'.'VxdWVzdA==',''.'cm'.'VxdW'.'Vz'.'dA==','Z'.'2xvYmFs',''.'Z2x'.'vYmFs','bW'.'Fpbl'.'9zZWM=','V1d'.'B'.'T'.'E'.'xfQUN'.'UVU'.'FMSVpF'.'X1JVT'.'EVT','dg==',''.'dmVyc2lv'.'bg'.'='.'=',''.'aQ==','aXN'.'Jbn'.'N0YWx'.'sZW'.'Q'.'=',''.'d'.'g==','aW5p',''.'bW9'.'kdWxlcw='.'=','bGlj'.'ZW5zZQ==',''.'c'.'Ghw','dg==','ZX'.'h0',''.'c2V'.'j'.'d'.'X'.'JpdHk=','Z'.'G'.'I=','dHlwZQ==','ZGI=','dmVyc'.'2'.'lvbg'.'='.'=',''.'ZGI=',''.'dHlwZQ'.'==','Z'.'GI'.'=','dHlw'.'ZQ==','dmVyc2lvbg'.'='.'=','ZGI=',''.'dmVyc2lvbg==','ZW5'.'2aXJvbm1lbnQ=','dm1fdmVyc2l'.'vbg='.'=',''.'dm0=','dg==','ZW'.'52'.'aXJvbm1lbnQ=',''.'dm1f'.'dmVyc2'.'lvbg==','c'.'29ja'.'2V0V'.'GltZW9'.'1'.'dA==','c3RyZ'.'WFtVG'.'ltZW91'.'dA='.'=','KCc=','ZGF0YQ==','Jy'.'wg'.'Jw'.'==','bW'.'9kdWx'.'l','Jy'.'wgJ'.'w='.'=','bW9kd'.'Wx'.'l'.'X3ZlcnNp'.'b24=','J'.'yk=','LCA=','U'.'0'.'VDVV'.'JJVFlfV1dBTExfRVhDRVBUSU9O',''.'b'.'WFpbg==','Rk'.'FJTF9SR'.'UZSRVNISU5H',''.'Q2FuIG5vdCByZWZyZXN'.'oIHd3Y'.'W'.'xsIHJ1bGVzOiA=','IF'.'Ry'.'YWN'.'lOiA'.'=','Z'.'GF0Y'.'Q==','eyI=','LS0t'.'L'.'S1CRUdJT'.'iBQVUJ'.'M'.'S'.'UM'.'gS0VZLS0tL'.'S0=',''.'Ck'.'1JSUJJakF'.'OQmdr'.'c'.'WhraU'.'c5d'.'zBCQV'.'FFR'.'kFB'.'T0N'.'BUThB'.'TUlJQkNnS0NB'.'UUVBcT'.'hRRT'.'BI'.'am'.'1I'.'S'.'lV'.'TdFdWNm4wemEK'.'UlZvTHgwMkt6YmZyY'.'lMvUDZz'.'V2F'.'4VHp3OFNlR1R0YlRD'.'T3JwSGk1UUY2T1J5a'.'l'.'ovWH'.'h6L0t'.'MV'.'TFH'.'Y'.'m9mOUNa'.'Mwo0e'.'j'.'d'.'Ta'.'3F'.'Vd'.'DY2aWJY'.'dk'.'9GQng0'.'Z'.'n'.'cvQV'.'BQUkdEcX'.'R'.'tMG5EM2'.'ZnR'.'3'.'N1M1J'.'lUGd3MjlpOCt'.'2bTdtdEJLS'.'lVZ'.'bDRyCl'.'Zw'.'YjZz'.'Zlp'.'FV'.'DlLRWI2VD'.'FIRFl'.'t'.'RXZj'.'MWhxL2l'.'pdX'.'l4T'.'H'.'JaWmk1'.'UTZVZ'.'mY0'.'VUV2V'.'E'.'krNjhz'.'c0Z'.'S'.'a1'.'Erb3dUUnkK'.'Z'.'U9JTW'.'JGaE0vVVRtZ'.'l'.'ZZYlRSRn'.'kyb1VR'.'OFdNemE'.'ybko1'.'U2Foe'.'mkxVUtPM'.'WpB'.'alhUU'.'FJyem'.'M3'.'QW'.'p'.'1Nj'.'M5ajFPM'.'Ap'.'wc'.'HFmb'.'T'.'V4Z1dsRkFKa0'.'h'.'RVGdiZGQ1QVdx'.'R'.'EZRa3Q5SEtr'.'WStUbmZCTEdWTXZWeVB'.'3'.'VE'.'h'.'OV1F'.'ZQXc0eHBnL3dBClp3S'.'URBUUFCCi0tL'.'S0tRU5EIFBV'.'QkxJQyBLRVktLS0tLQ==');return base64_decode($_500184942[$_1576176466]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use Bitrix\Main\License\UrlProvider; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; protected $_1203714456= true; public function handle(){ try{  $_81389104= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_81389104)){ return;}  $_680632438= Cache::createInstance(); $_228726782= false; if($_680632438->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_1085880966= $_680632438->getVars(); if($GLOBALS['____1751529081'][0]()- $_1085880966> round(0+10+10)){  $_1851081439= Application::getConnection(); $_1919551337= RuleRecordTable::getTableName(); $_1851081439->truncateTable($_1919551337); RuleRecordTable::cleanCache(); $_680632438->clean(___172330570(0), ___172330570(1));}} elseif($_680632438->startDataCache()){  $_680632438->endDataCache($GLOBALS['____1751529081'][1]()); $_228726782= true;} foreach($_81389104 as $_1541043263){ $_339478576= new PublicKeyCipher; $_2030221951= $_339478576->decrypt($_1541043263[___172330570(2)], static::__862280213()); if(!str_starts_with($_2030221951, ___172330570(3))){ continue;} $_587477639= $GLOBALS['____1751529081'][2]($_2030221951, true); if(!empty($_587477639)){ $_1070279274= Rule::make($_587477639); $_1769045283= $this->handleRule($_1070279274); $this->applyHandlingResults($_1769045283);}}  if($_228726782){ $_680632438->clean(___172330570(4), ___172330570(5));}} catch(\Throwable $_1359779692){ $this->logEvent( ___172330570(6), ___172330570(7), ___172330570(8). $_1359779692->getMessage(). ___172330570(9). $_1359779692->getTraceAsString());}}  public function handleRule(Rule $_1070279274): array{ $_1769045283=[]; if($_1070279274->matchPath($_SERVER[___172330570(10)])){  $_1656999256= $this->getContextElements($_1070279274->getContext()); foreach($_1656999256 as $_1404595690 => &$_1547946507){ $_1769045283= $GLOBALS['____1751529081'][3]($_1769045283, $this->recursiveContextKeyHandle($_1404595690, $_1547946507,[], $_1070279274));}} return $_1769045283;}  public function applyHandlingResults(array $_1769045283){ $_1656999256= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1769045283 as $_286619442){ $_1547946507=& $_1656999256[$_286619442->getContextName()]; $_284913379= $_286619442->getRuleResult(); $_1070279274= $_286619442->getRule(); if($_284913379 instanceof ModifyResult){ if($_1070279274->getProcess() === ___172330570(11)){  static::rewriteContextKey( $_286619442->getContextName(), $_1547946507, $_286619442->getContextKey(), $_284913379->getCleanValue());} elseif($_1070279274->getProcess() === ___172330570(12)){ static::rewriteContextValue( $_286619442->getContextName(), $_1547946507, $_286619442->getContextKey(), $_284913379->getCleanValue());} $this->logEvent( ___172330570(13), $_286619442->getContextName(), $GLOBALS['____1751529081'][4](___172330570(14), $_286619442->getContextKey()));} elseif($_284913379 instanceof CheckResult &&!$_284913379->isSuccess()){ if($_284913379->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_286619442->getContextName(), $_1547946507, $_286619442->getContextKey(),); $this->logEvent( ___172330570(15), $_286619442->getContextName(), $GLOBALS['____1751529081'][5](___172330570(16), $_286619442->getContextKey()));} elseif($_284913379->getAction() === RuleAction::EXIT){ $this->logEvent( ___172330570(17), $_286619442->getContextName(), $GLOBALS['____1751529081'][6](___172330570(18), $_286619442->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_1203714456= false;} protected function rewriteContextKey($_1404595690, &$_1547946507, $_689722779, $_1626176818){ $_1476021552= $_689722779;  $GLOBALS['____1751529081'][7]($_1476021552); $_1476021552[]= $_1626176818; if($_1404595690 === ___172330570(19)){ $_2020818651= $GLOBALS['____1751529081'][8]($_689722779); $GLOBALS['____1751529081'][9]($_1476021552); if(empty($_689722779)){ $GLOBALS[$_1626176818]= $GLOBALS[$_2020818651]; unset($GLOBALS[$_2020818651]);} else{ $_1547946507=& $GLOBALS[$_2020818651]; $_1298137348= ArrayHelper::getByNestedKey($_1547946507, $_689722779);  ArrayHelper::setByNestedKey($_1547946507, $_1476021552, $_1298137348);  ArrayHelper::unsetByNestedKey($_1547946507, $_689722779);}} else{ $_1298137348= ArrayHelper::getByNestedKey($_1547946507, $_689722779);  ArrayHelper::setByNestedKey($_1547946507, $_1476021552, $_1298137348);  ArrayHelper::unsetByNestedKey($_1547946507, $_689722779);}} protected function rewriteContextValue($_1404595690, &$_1547946507, $_509795732, $_1298137348){ if($_1404595690 === 'global'){ $_2020818651= $GLOBALS['____1751529081'][10]($_509795732); if(empty($_509795732)){ $GLOBALS[$_2020818651]= $_1298137348;} else{ $_1547946507=& $GLOBALS[$_2020818651]; ArrayHelper::setByNestedKey($_1547946507, $_509795732, $_1298137348);}} else{  ArrayHelper::setByNestedKey($_1547946507, $_509795732, $_1298137348);}} protected function unsetContextValue($_1404595690, &$_1547946507, $_509795732){ if($_1404595690 === 'global'){ $_2020818651= $GLOBALS['____1751529081'][11]($_509795732); if(empty($_509795732)){ unset($GLOBALS[$_2020818651]);} else{ $_1547946507=& $GLOBALS[$_2020818651]; ArrayHelper::unsetByNestedKey($_1547946507, $_509795732);}} else{ ArrayHelper::unsetByNestedKey($_1547946507, $_509795732);}}  protected function recursiveContextKeyHandle(string $_1404595690, array &$_1547946507, array $_1797178923, Rule $_1070279274): array{  $_1769045283=[]; foreach($_1547946507 as $_1480153803 => $_1298137348){ $_509795732= $GLOBALS['____1751529081'][12]($_1797178923,[$_1480153803]); if($_1070279274->matchKey($_509795732)){  if($_1070279274->getProcess() === ___172330570(20)){ $_284913379= $_1070279274->evaluate($_1480153803);} elseif($_1070279274->getProcess() === ___172330570(21)){ $_284913379= $_1070279274->evaluateValue($_1298137348);}  if(!empty($_284913379) && $_284913379 instanceof RuleResult){ $_1769045283[]= new HandlingResult($_1404595690, $_509795732, $_284913379, $_1070279274);}}  if($GLOBALS['____1751529081'][13]($_1298137348)){ $_1769045283= $GLOBALS['____1751529081'][14]($_1769045283, $this->recursiveContextKeyHandle( $_1404595690, $_1547946507[$_1480153803], $_509795732, $_1070279274));}} return $_1769045283;} protected function getContextElements(array $_926008244){ $_427821549=[]; if($GLOBALS['____1751529081'][15](___172330570(22), $_926008244, true)){ $_427821549[___172330570(23)]= &$_GET;} if($GLOBALS['____1751529081'][16](___172330570(24), $_926008244, true)){ $_427821549[___172330570(25)]= &$_POST;} if($GLOBALS['____1751529081'][17](___172330570(26), $_926008244, true)){ $_427821549[___172330570(27)]= &$_COOKIE;} if($GLOBALS['____1751529081'][18](___172330570(28), $_926008244, true)){ $_427821549[___172330570(29)]= &$_REQUEST;} if($GLOBALS['____1751529081'][19](___172330570(30), $_926008244, true)){ $_427821549[___172330570(31)]= $GLOBALS;} return $_427821549;} public static function refreshRules(){ try{ $_287582717= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1751529081'][20]()- $_287582717)< static::CACHE_RULES_TTL){ return;} Option::set(___172330570(32), ___172330570(33), $GLOBALS['____1751529081'][21]()); $_968089197= null;  $_1603230544= $GLOBALS['____1751529081'][22](function($_28748824){ return[___172330570(34) => $_28748824[___172330570(35)], ___172330570(36) => (int) $_28748824[___172330570(37)]];}, ModuleManager::getModulesFromDisk());  $_1084706867=[]; foreach($GLOBALS['____1751529081'][23]() as $_1768928194){ $_180864047= new ReflectionExtension($_1768928194); $_1084706867[$_1768928194]=[ ___172330570(38) => $_180864047->getVersion(), ___172330570(39) => $_180864047->getINIEntries()];} $_442119214=[ ___172330570(40) => $GLOBALS['____1751529081'][24]($_1603230544), ___172330570(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___172330570(42) => $GLOBALS['____1751529081'][25]([ ___172330570(43) => $GLOBALS['____1751529081'][26](), ___172330570(44) => $_1084706867])]; if(Loader::includeModule(___172330570(45))){ $_67187993= CSecuritySystemInformation::getSystemInformation(); if(isset($_67187993[___172330570(46)][___172330570(47)]) && isset($_67187993[___172330570(48)][___172330570(49)])){ $_442119214[___172330570(50)]=[ ___172330570(51) => $_67187993[___172330570(52)][___172330570(53)], ___172330570(54) => $_67187993[___172330570(55)][___172330570(56)]];} if(isset($_67187993[___172330570(57)][___172330570(58)])){ $_442119214[___172330570(59)]=[___172330570(60) => $_67187993[___172330570(61)][___172330570(62)]];}}  $_1433986461= new HttpClient([ ___172330570(63) => round(0+1.6666666666667+1.6666666666667+1.6666666666667), ___172330570(64) => round(0+1+1+1+1+1)]); $_618872516=(new UrlProvider())->getTechDomain(); $_34467876="https://wwall.{$_618872516}/rules.php"; $_421460149= $_1433986461->post($_34467876, $_442119214); if($_1433986461->getStatus() == round(0+40+40+40+40+40) &&!empty($_421460149)){ $_968089197= Json::decode($_421460149);}  if($_968089197 !== null){ $_1851081439= Application::getConnection(); $_1919551337= RuleRecordTable::getTableName(); if(!empty($_968089197)){ foreach($_968089197 as $_985798474){ if(!static::checkRuleSign($_985798474)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1751529081'][27]($_985798474));}}}  $_1851081439->truncateTable($_1919551337);  if(!empty($_968089197)){ $_725319822=[]; foreach($_968089197 as $_985798474){ $_725319822[]= ___172330570(65). $_1851081439->getSqlHelper()->forSql($_985798474[___172330570(66)]). ___172330570(67). $_1851081439->getSqlHelper()->forSql($_985798474[___172330570(68)]). ___172330570(69). $_1851081439->getSqlHelper()->forSql($_985798474[___172330570(70)]). ___172330570(71);} $_1450803171= $GLOBALS['____1751529081'][28](___172330570(72), $_725319822);  $_1851081439->query("INSERT INTO {$_1919551337} (DATA, MODULE, MODULE_VERSION) VALUES {$_1450803171}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_1359779692){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___172330570(73), ___172330570(74), ___172330570(75), ___172330570(76). $_1359779692->getMessage(). ___172330570(77). $_1359779692->getTraceAsString());}} protected static function checkRuleSign($_1070279274){ $_339478576= new PublicKeyCipher; $_587477639= $_339478576->decrypt($_1070279274[___172330570(78)], static::__862280213()); return str_starts_with($_587477639, ___172330570(79));} private static function __862280213(){ $_791041609= ''; $_791041609 .= ___172330570(80); $_791041609 .= ___172330570(81); return $_791041609;} protected function logEvent($_1819194332, $_1364046346, $_224792353){ if($this->_1203714456){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1819194332, 'main', $_1364046346, $_224792353);}}}?>