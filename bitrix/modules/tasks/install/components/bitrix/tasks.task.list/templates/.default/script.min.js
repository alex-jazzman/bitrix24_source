BX.namespace("BX.Tasks.Grid");BX.Tasks.GridActions={gridId:null,groupSelector:null,registeredTimerNodes:{},defaultPresetId:"",getTotalCountProceed:false,currentGroupAction:null,restrictions:{project:{limitExceeded:false,limitFeatureId:""}},checkCanMove:function(){return!BX.Tasks.GridInstance||BX.Tasks.GridInstance.checkCanMove()},initPopupBalloon:function(e,t,i){this.groupSelector=null;this.flowSelectorDialog=null;BX.bind(BX(t+"_control"),"click",BX.delegate((function(){if(e==="flow"){if(!this.flowSelectorDialog){this.flowSelectorDialog=new BX.UI.EntitySelector.Dialog({targetNode:BX(t+"_control"),width:350,height:400,multiple:false,dropdownMode:true,enableSearch:true,cacheable:true,entities:[{id:"flow",options:{onlyActive:true},dynamicLoad:true,dynamicSearch:true}],events:{"Item:onBeforeSelect":e=>{const s=e.getData();BX(t+"_control").value=BX.util.htmlspecialcharsback(s.item.title.text)||"";BX(i+"_control").value=s.item.id||""}},recentTabOptions:{stub:"BX.Tasks.Flow.EmptyStub",stubOptions:{showArrow:true}}});const e=new BX.Tasks.Flow.Footer(this.flowSelectorDialog);this.flowSelectorDialog.setFooter(e.render())}this.flowSelectorDialog.show()}else{if(!this.groupSelector){const s=t+"_control";const a=i+"_control";this.groupSelector=new BX.Tasks.GroupSelector({mode:e,targetNodeId:s,showAvatars:true,enableSearch:true,multiple:false,context:"TASKS"});this.groupSelector.subscribe("itemSelected",(e=>{const{item:t}=e.getData();document.getElementById(s).value=BX.util.htmlspecialcharsback(t.getTitle())||"";document.getElementById(a).value=t.getId()||""}))}this.groupSelector.show()}}),this))},onTagUpdateClick:function(e,t,i){const s=t=>{const i=t.getData().id;if(Number(i)===Number(e)){const e=BX.Main.gridManager.getById(this.gridId).instance.getRows().getById(i);p.setTargetNode(e.getCellById("TAG"))}};const a=t=>{const i=t.getData().id;if(Number(i)===Number(e)){p.hide()}};var r=false;var n=function(t){const i=t.getTarget();const s=t.getData().item;s.setSort(1);i.getTab("all").getRootNode().addItem(s);if(r){i.clearSearch();BX.Tasks.GridActions.reloadRow(e);r=false;d();return}var a=i.getSelectedItems().map((function(e){return e.getTitle()}));d();BX.Tasks.GridActions.action("setTags",e,{tags:a})};var o=function(e){var t=e.getTarget();var i=e.getData().query;if(i.trim()!==""){l()}else{d()}};var l=function(){p.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").hidden=false;p.getFooterContainer().querySelector("#tags-widget-custom-footer-conjunction").hidden=false};var d=function(){p.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").hidden=true;p.getFooterContainer().querySelector("#tags-widget-custom-footer-conjunction").hidden=true};var u=function(e,t){if(p.getContainer().querySelector(`div.${e}`)){return}var i=document.createElement("div");i.className=e;i.innerHTML=`\n\t\t\t\t<div class='ui-alert ui-alert-xs ui-alert-danger'  \n\t\t\t\t\t<span class='ui-alert-message'>\n\t\t\t\t\t\t${t}\n\t\t\t\t\t</span> \n\t\t\t\t</div>\n\t\t\t`;p.getFooterContainer().before(i)};var c=function(){var t=["click","keydown"];var i=function(t){if(t.type==="keydown"){if(!((t.ctrlKey||t.metaKey)&&t.keyCode===13)){return}}var i=p.getSelectedItems().map((function(e){return e.getTitle()}));var s=p.getTagSelectorQuery();if(s.trim()===""){return}BX.ajax.runComponentAction("bitrix:tasks.task","setTags",{mode:"class",data:{taskId:e,tags:i,newTag:s}}).then((function(e){if(e.data.success){r=true;const t=p.addItem({id:s,entityId:"task-tag",title:s,sort:1,badges:[{title:e.data.owner}]});p.getTab("all").getRootNode().addItem(t);t.select()}else{const t="tasks-list-tag-already-exists-alert";u(t,e.data.error);const i=function(){const e=p.getContainer().querySelector(`div.${t}`);e&&e.remove()};setTimeout(i,2e3)}}))};t.forEach((function(e){if(e==="click"){p.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").addEventListener(e,i)}else{p.getContainer().addEventListener(e,i)}}))};var h=i.getData();if(BX.Tasks.GridActions.tagsAreConverting){var g=new top.BX.UI.Dialogs.MessageBox({title:BX.message("TASKS_TASK_LIST_TAGS_ARE_CONVERTING_TITLE"),message:BX.message("TASKS_TASK_LIST_TAGS_ARE_CONVERTING_TEXT"),buttons:top.BX.UI.Dialogs.MessageBoxButtons.OK,okCaption:BX.message("TASKS_TASK_LIST_TAGS_ARE_CONVERTING_COME_BACK_LATER"),onOk:function(){g.close()}});g.show();return}var f=function(){var e=document.querySelectorAll("td.main-grid-cell.main-grid-cell-left");var t=h.button;e.forEach((function(e){if(e.contains(t)){t=e}}));return t};var p=new BX.UI.EntitySelector.Dialog({id:"tasks-task-list-tag-widget",targetNode:f(),enableSearch:true,width:350,height:400,multiple:true,dropdownMode:true,compactView:true,entities:[{id:"task-tag",options:{taskId:e,groupId:t}}],searchOptions:{allowCreateItem:false},footer:BX.Tasks.EntitySelector.Footer,footerOptions:{userId:BX.Tasks.GridInstance.userId,taskId:e,groupId:t},clearUnavailableItems:true,events:{onLoad:function(){p.getFooterContainer().style.zIndex=1;BX.addCustomEvent("Tasks.Tasks.Grid:RowRemove",a);c()}.bind(this),onShow:function(){BX.addCustomEvent("Tasks.Tasks.Grid:RowUpdate",s)}.bind(this),onHide:function(){BX.removeCustomEvent("Tasks.Tasks.Grid:RowUpdate",s);BX.removeCustomEvent("Tasks.Tasks.Grid:RowRemove",a)}.bind(this),onSearch:function(e){o(e)}.bind(this),"Item:onSelect":function(e){n(e)}.bind(this),"Item:onDeselect":function(e){n(e)}.bind(this)}});p.show()},onProjectAddClick:function(e,t){var i=new BX.UI.EntitySelector.Dialog({targetNode:t,enableSearch:true,context:"TASKS_PROJECT",entities:[{id:"project",options:{lockProjectLink:this.restrictions.project.limitExceeded,lockProjectLinkFeatureId:this.restrictions.project.limitFeatureId}}],events:{"Item:onSelect":function(t){var i=t.getData().item;BX.Tasks.GridActions.action("setGroup",e,{groupId:i.getId()});t.getTarget().hide()}}});i.show()},toggleFilter:function(e,t,i){var s=BX.Main.filterManager.getById(this.gridId);if(!s){console.log("BX.Main.filterManager not initialised");return}if(t){this.reduceFilter(s,e,i)}else{this.extendFilter(s,e,i)}},extendFilter:function(e,t,i){if(i){t=this.extendCurrentFieldsValues(e,t)}e.getApi().extendFilter(t)},reduceFilter:function(e,t,i){var s=!i;if(i){t=this.reduceCurrentFieldsValues(e,t);Object.values(t).forEach((function(e){if(BX.Type.isArray(e)&&e.length<=0){s=true}}))}if(!s){e.getApi().extendFilter(t);return}var a=e.getFilterFields();Object.keys(t).forEach((function(t){a.forEach((function(i){if(i.getAttribute("data-name")===t){e.getFields().deleteField(i)}}))}));e.getSearch().apply()},extendCurrentFieldsValues:function(e,t){var i=t;var s=e.getFilterFieldsValues();Object.entries(t).forEach((function([e,t]){var a=s[e];if(BX.Type.isArray(a)&&BX.Type.isArray(t)){t.forEach((function(t){if(!a.includes(t)){a.push(t);i[e]=a}}))}}));return i},reduceCurrentFieldsValues:function(e,t){var i=t;var s=e.getFilterFieldsValues();Object.entries(t).forEach((function([e,t]){var a=s[e];if(BX.Type.isArray(a)&&BX.Type.isArray(t)){t.forEach((function(t){if(a.includes(t)){a.splice(a.indexOf(t),1);i[e]=a}}))}}));return i},filter:function(e){var t=BX.Main.filterManager.getById(this.gridId);if(!t){console.log("BX.Main.filterManager not initialised");return}var i=t.getFilterFieldsValues();var s=t.getApi();Object.keys(e).forEach((function(t){i[t]=e[t]}));s.setFields(i);s.apply()},changePin:function(e,t,i){var s=i.getData();var a=s.button;if(BX.Dom.hasClass(a,BX.Grid.CellActionState.ACTIVE)){BX.Tasks.GridActions.action("unpin",e,{groupId:t});BX.Dom.removeClass(a,BX.Grid.CellActionState.ACTIVE);BX.Dom.addClass(a,BX.Grid.CellActionState.SHOW_BY_HOVER)}else{BX.Tasks.GridActions.action("pin",e,{groupId:t});BX.Dom.addClass(a,BX.Grid.CellActionState.ACTIVE);BX.Dom.removeClass(a,BX.Grid.CellActionState.SHOW_BY_HOVER)}},changeMute:function(e,t){var i=t.getData();var s=i.button;if(BX.Dom.hasClass(s,BX.Grid.CellActionState.ACTIVE)){BX.Tasks.GridActions.action("unmute",e);BX.Dom.removeClass(s,BX.Grid.CellActionState.ACTIVE);BX.Dom.addClass(s,BX.Grid.CellActionState.SHOW_BY_HOVER)}else{BX.Tasks.GridActions.action("mute",e);BX.Dom.addClass(s,BX.Grid.CellActionState.ACTIVE);BX.Dom.removeClass(s,BX.Grid.CellActionState.SHOW_BY_HOVER)}},action:function(e,t,i){switch(e){case"add2Timeman":{if(BX.addTaskToPlanner){BX.addTaskToPlanner(t)}else if(window.top.BX.addTaskToPlanner){window.top.BX.addTaskToPlanner(t)}break}case"copyLink":{if(BX.clipboard.copy(i.copyLink)){BX.UI.Notification.Center.notify({content:BX.message("TASKS_LIST_ACTION_COPY_LINK_NOTIFICATION")})}break}case"complete":case"renew":{BX.ajax.runAction("bitrix:tasks.scrum.task.isScrumTask",{mode:"class",data:{taskId:t}}).then(function(s){if(s.data===true){this.doScrumAction(e,t,i)}else{this.doAction(e,t,i)}}.bind(this));break}case"unlinkSubTask":top.BX.Runtime.loadExtension("tasks.v2.provider.service.relation-service").then((({subTasksService:e})=>{e.delete(i.parentId,[t]).then((()=>{if(!this.checkCanMove()){this.reloadRow(t)}})).catch((e=>{if(e.errors){const t=e.errors[0].message||e.errors[0].MESSAGE;BX.UI.Notification.Center.notify({content:t})}}))}));break;case"unlinkRelatedTask":top.BX.Runtime.loadExtension("tasks.v2.provider.service.relation-service").then((({relatedTasksService:e})=>{e.delete(i.relatedToTaskId,[t]).then((()=>{if(!this.checkCanMove()){this.reloadRow(t)}})).catch((e=>{if(e.errors){const t=e.errors[0].message||e.errors[0].MESSAGE;BX.UI.Notification.Center.notify({content:t})}}))}));break;case"take":{this.doTakeAction(t,i);break}default:{this.doAction(e,t,i);break}}},doAction:function(e,t,i){i=i||{};i["taskId"]=t;let s="bitrix:tasks.task";if(e==="pin"||e==="unpin"){s="bitrix:tasks.task.list"}if(e==="ping"){BX.UI.Notification.Center.notify({content:BX.message("TASKS_LIST_ACTION_PING_NOTIFICATION")})}return BX.ajax.runComponentAction(s,e,{mode:"class",data:i}).then(function(i){if(e==="complete"){this.sendAnalyticsOnTaskComplete()}if(e==="delete"){BX.Tasks.Util.fireGlobalTaskEvent("DELETE",{ID:t});BX.UI.Notification.Center.notify({content:BX.message("TASKS_DELETE_SUCCESS")})}if(!this.gridId){window.location.href=window.location.href;return false}if(!this.checkCanMove()){this.reloadRow(t)}return true}.bind(this)).catch(function(e){if(e.errors){const t=e.errors[0].message||e.errors[0].MESSAGE;BX.UI.Notification.Center.notify({content:t})}}.bind(this))},doTakeAction:function(e,t){if(!t.allowTimeTracking){this.doAction("TAKE",e,t);return}BX.ajax.runComponentAction("bitrix:tasks.task","getTaskFromTimer",{mode:"class",data:{}}).then((i=>{const s=i.data;if(!s.id){this.doAction("TAKE",e,t);return}let a=BX.Loc.getMessage("TASKS_TASK_CONFIRM_START_TIMER");a=a.replace("{{TITLE}}",BX.type.isNotEmptyString(s.title)?BX.util.htmlspecialchars(s.title):BX.Loc.getMessage("TASKS_UNKNOWN"));BX.Tasks.confirm(a,BX.delegate((function(i){if(i){this.doAction("TAKE",e,t)}}),this),{title:BX.Loc.getMessage("TASKS_TASK_CONFIRM_START_TIMER_TITLE")})}))},doScrumAction(e,t,i){const s=new BX.Promise;let a=null;let r=false;top.BX.loadExt("tasks.scrum.task-status").then(function(){if(!BX.type.isUndefined(top.BX.Tasks.Scrum)&&!BX.type.isUndefined(top.BX.Tasks.Scrum.TaskStatus)){a=new top.BX.Tasks.Scrum.TaskStatus({taskId:t,action:e,performActionOnParentTask:true});a.updateState().then(function(){a.isParentScrumTask().then(function(i){r=i;if(r){s.fulfill()}else{if(e==="complete"){return a.showDod(t).then(function(){s.fulfill()}.bind(this)).catch(function(){s.reject()}.bind(this))}else{s.fulfill()}}}.bind(this))}.bind(this))}else{s.fulfill()}}.bind(this));s.then(function(){this.doAction(e,t,i).then(function(){if(a&&r){a.update()}}.bind(this))}.bind(this))},getTotalCount:function(e,t,i,s){if(this.getTotalCountProceed){return}this.getTotalCountProceed=true;var a=document.getElementById(e+"_row_count_wrapper");this.showCountLoader(a);BX.ajax.runComponentAction("bitrix:tasks.task.list","getTotalCount",{mode:"class",data:{userId:t,groupId:i,parameters:JSON.stringify(s)}}).then(function(e){this.hideCountLoader(a);if(e.data){e.data=typeof e.data=="number"?e.data:0;var t=a.querySelector("a");if(t){t.remove()}a.append(e.data)}this.getTotalCountProceed=false}.bind(this)).catch(function(e){if(e.errors){BX.Tasks.alert(e.errors)}this.getTotalCountProceed=false}.bind(this))},showCountLoader:function(e){var t=e.querySelector("a");if(t){t.style.display="none"}var i=e.querySelector(".tasks-circle-loader-circular");if(i){i.style.display="inline"}},hideCountLoader:function(e){var t=e.querySelector(".tasks-circle-loader-circular");if(t){t.style.display="none"}},reloadRow:function(e){var t=BX.Main.gridManager.getById(this.gridId);if(t&&t.hasOwnProperty("instance")){t.instance.updateRow(e.toString(),null,null,(({id:e})=>{BX.onCustomEvent("Tasks.Tasks.Grid:RowUpdate",{id:e})}))}},reloadGrid:function(){if(BX.SidePanel&&BX.SidePanel.Instance&&BX.SidePanel.Instance.getLastOpenSlider()){BX.SidePanel.Instance.destroy(BX.SidePanel.Instance.getLastOpenSlider().getUrl())}var e=BX.Main.filterManager.getById(this.gridId);if(!e){console.log("BX.Main.filterManager not initialised");return}e.getSearch().apply()},setCurrentGroupAction:function(e){this.currentGroupAction=e},processBeforeGroupActionSent:function(){if(this.currentGroupAction==="ping"){BX.UI.Notification.Center.notify({content:BX.message("TASKS_LIST_GROUP_ACTION_PING_NOTIFICATION")})}this.currentGroupAction=null},confirmGroupAction:function(e){const t=BX.Main.gridManager.getById(e).instance.getActionsPanel().getValues();const i=BX.Main.gridManager.getById(e).instance.getActionKey();const s=t[i];const a=this.preparationDataGroupAction(e,s);if(!s.includes("none")&&(a.forAll!=="N"||a.selectedIds.length)){a.ownerId=this.ownerId;const e=new BX.Tasks.GroupActionsStepper({action:s,data:a,requestStopFunction(){BX.Tasks.GridActions.processBeforeGroupActionSent();BX.Tasks.GridActions.reloadGrid()}});e.showDialog()}},preparationDataGroupAction(e,t){const i=BX.Main.gridManager.getById(e).instance.getRows().getSelectedIds();const s=BX.Main.gridManager.getById(e).instance.getActionsPanel().getValues();const a={forAll:s[`action_all_rows_${e}`]?"Y":"N",selectedIds:i,groupId:Number(this.groupId)};if(t==="setdeadline"){a.setDeadline=s.ACTION_SET_DEADLINE_from}if(t==="adjustdeadline"||t==="substractdeadline"){a.num=Number(s.num);a.type=s.type}if(t==="settaskcontrol"){a.taskControlState=s.value}if(t==="setresponsible"){a.responsibleId=Number(s.responsibleId)}if(t==="setoriginator"){a.originatorId=Number(s.originatorId)}if(t==="addauditor"){a.auditorId=Number(s.auditorId)}if(t==="addaccomplice"){a.accompliceId=Number(s.accompliceId)}if(t==="setgroup"||t==="setcollab"){a.specifyGroupId=Number(s.groupId)}if(t==="setflow"){a.flowId=Number(s.flowId)}return a},onDeadlineChangeClick:function(e,t,i,s){i=i||(new Date).getDate();t=t||s.getData().button;var a=BX.calendar({node:t,value:i,form:"",bTime:true,currentTime:Math.round(new Date/1e3)-(new Date).getTimezoneOffset()*60,bHideTimebar:true,bCompatibility:true,bCategoryTimeVisibilityOption:"tasks.bx.calendar.deadline",bTimeVisibility:BX.Tasks.GridInstance?BX.Tasks.GridInstance.calendarSettings.deadlineTimeVisibility==="Y":false,callback_after:function(e,t){return function(i){var s=new Date;if(i.getTime()>s.getTime()){BX.onCustomEvent("Tasks.Tour.ExpiredTasksDeadlineChange:saveDeadline",[])}var a=BX.CJSTask.ajaxUrl;BX.CJSTask.ajaxUrl=BX.CJSTask.ajaxUrl+"&_CODE=CHANGE_DEADLINE&viewType=VIEW_MODE_LIST";BX.CJSTask.batchOperations([{operation:"CTaskItem::update()",taskData:{ID:t,DEADLINE:BX.calendar.ValueToString(i,true)}}],{callbackOnSuccess:function(e,t,i){return function(e){}}(e,t,i)});BX.CJSTask.ajaxUrl=a;if(!BX.Tasks.GridActions.checkCanMove()){BX.Tasks.GridActions.reloadRow(t)}}}(t,e)});var r=BX.Tasks.TourGuideController.getGuide();if(r&&r.setCalendarPopup&&r.isCorrectRow(e)&&!r.getIsStopped()){r.setCalendarPopup(a.popup)}},onMarkChangeClick:function(e,t,i){BX.TaskGradePopup.show(e,t,i,{events:{onPopupClose:this.__onGradePopupClose,onPopupChange:this.__onGradePopupChange}});BX.addClass(t,"task-grade-and-report-selected");return false},__onGradePopupClose:function(){BX.removeClass(this.bindElement,"task-grade-and-report-selected")},__onGradePopupChange:function(){this.bindElement.className="task-grade-and-report"+(this.listValue!=="NULL"?" task-grade-"+this.listItem.className:"")+(this.report?" task-in-report":"");this.bindElement.title=BX.message("TASKS_MARK")+": "+this.listItem.name;BX.Tasks.GridActions.action("legacyUpdate",this.id,{data:{MARK:this.listValue==="NULL"?"":this.listValue}})},renderTimerItem:function(e,t,i,s,a,r){r=r||false;var n="task-timer-inner";var o=t+a;if(s){n=n+" task-timer-play"}else if(r){n=n+" task-timer-pause"}else{n=n+" task-timer-clock"}if(i>0&&o>i){n=n+" task-timer-overdue"}return BX.create("span",{props:{id:"task-timer-block-"+e,className:"task-timer-block"},events:{click:function(e,t){return function(){if(BX.hasClass(BX("task-timer-block-inner-"+e),"task-timer-play")){BX.TasksTimerManager.stop(e)}else if(t){BX.TasksTimerManager.start(e)}}}(e,r)},children:[BX.create("span",{props:{id:"task-timer-block-inner-"+e,className:n},children:[BX.create("span",{props:{className:"task-timer-icon"}}),BX.create("span",{props:{id:"task-timer-block-value-"+e,className:"task-timer-time"},text:BX.Tasks.GridActions.renderTimerTimes(o,i,s)})]})]})},renderTimerTimes:function(e,t,i){var s="";var a=!!i;s=BX.Tasks.GridActions.renderSecondsToHHMMSS(e,a);if(t>0){s=s+" / "+BX.Tasks.GridActions.renderSecondsToHHMMSS(t,false)}return s},renderSecondsToHHMMSS:function(e,t){var i="00";var s="";var a="";var r=0;if(e>0){s+=Math.floor(e/3600);a+=Math.floor(e/60)%60}else{s+=Math.ceil(e/3600);a+=Math.ceil(e/60)%60}var n=i.substring(0,2-s.length)+s+":"+i.substring(0,2-a.length)+a;if(t){r=""+e%60;n=n+":"+i.substring(0,2-r.length)+r}return n},redrawTimerNode:function(e,t,i,s,a,r){var n=BX("task-timer-block-"+e);var o=BX.Tasks.GridActions.renderTimerItem(e,t,i,s,a,r);if(n){n.parentNode.replaceChild(o,n)}else{var l=BX("task-timer-block-container-"+e);if(l){if(this.registeredTimerNodes[e]){BX.removeCustomEvent(window,"onTaskTimerChange",this.registeredTimerNodes[e])}l.appendChild(o);if(BX("task-timer-block-"+e)){this.registeredTimerNodes[e]=this.__getTimerChangeCallback(e);BX.addCustomEvent(window,"onTaskTimerChange",this.registeredTimerNodes[e])}}}},removeTimerNode:function(e){if(this.registeredTimerNodes[e]){BX.removeCustomEvent(window,"onTaskTimerChange",this.registeredTimerNodes[e])}var t=BX("task-timer-block-"+e);if(t){t.parentNode.removeChild(t)}},__getTimerChangeCallback:function(e){var t=null;return function(i){var s=null;var a=null;if(i.action==="refresh_daemon_event"){if(Number(i.taskId)!==Number(e)){if(t==="paused"){return}s="paused"}else{if(t!=="playing"){s="playing"}BX.Tasks.GridActions.redrawTimerNode(i.taskId,i.data.TASK.TIME_SPENT_IN_LOGS,i.data.TASK.TIME_ESTIMATE,true,i.data.TIMER.RUN_TIME,true)}}else if(i.action==="start_timer"){if(Number(e)===Number(i.taskId)&&i.timerData&&Number(e)===Number(i.timerData.TASK_ID)){s="playing"}else{s="paused"}}else if(i.action==="stop_timer"){if(Number(e)==Number(i.taskId)){s="paused"}}else if(i.action==="init_timer_data"){if(i.data.TIMER){if(Number(i.data.TIMER.TASK_ID)===Number(e)){s=i.data.TIMER.TIMER_STARTED_AT>0?"playing":"paused"}else if(i.data.TIMER.TASK_ID>0){s="paused"}}}if(s!==null){a=BX("task-timer-block-inner-"+e);if(a&&!BX.hasClass(a,"task-timer-clock")){if(s==="paused"){BX.removeClass(a,"task-timer-play");BX.addClass(a,"task-timer-pause")}else if(s==="playing"){BX.removeClass(a,"task-timer-pause");BX.addClass(a,"task-timer-play")}}t=s}}},sendAnalyticsOnTaskComplete:function(){const e={tool:"tasks",category:"task_operations",event:"task_complete",type:"task",c_section:BX.Tasks.Grid.groupId?"project":"tasks",c_element:"context_menu",c_sub_section:"list"};if(BX.UI.Analytics){BX.UI.Analytics.sendData(e)}else{BX.Runtime.loadExtension("ui.analytics").then((()=>{BX.UI.Analytics.sendData(e)}))}},onStageSwitch:function(e,t,i){const s=BX.Main.gridManager.getById(this.gridId).instance.getRows().getById(e);const a=s.getCellById("STAGE_ID");if(!a){return}const r=a.querySelector(".tasks-grid-stage-container");if(!r){return}if(this.isCurrentStageSelected(r,t)){return}let n=true;let o="";for(const e of r.children){const s=parseInt(e.dataset.stageId);if(n){e.style.backgroundColor=i}else{e.style.backgroundColor=""}e.dataset.selected="N";if(s===parseInt(t)){n=false;o=e.title;e.dataset.selected="Y"}}if(o!==""){const e=a.querySelector(".tasks-grid-stage-title");if(e){e.innerHTML=o}}this.saveStage(e,t)},isCurrentStageSelected:function(e,t){for(const i of e.children){const e=i.dataset.selected;const s=parseInt(i.dataset.stageId);if(s===t&&e==="Y"){return true}}return false},saveStage:function(e,t){return BX.ajax.runComponentAction("bitrix:tasks.task","moveStage",{mode:"class",data:{taskId:e,stageId:t}}).then((i=>{if(i&&i.errors&&i.errors.length===0){BX.Tasks.Util.fireGlobalTaskEvent("UPDATE_STAGE",{ID:e,STAGE_ID:t},{STAY_AT_PAGE:true},{id:e})}}))}};BX((function(){"use strict";BX.Tasks.Grid=function(e){this.grid=BX.Main.gridManager.getInstanceById(e.gridId);this.userId=Number(e.userId);this.ownerId=Number(e.ownerId);this.groupId=Number(e.groupId);this.lastGroupId=Number(e.lastGroupId);this.sorting=e.sorting;this.groupByGroups=e.groupByGroups==="true";this.groupBySubTasks=e.groupBySubTasks==="true";this.arParams=e.arParams;this.migrationBarOptions=e.migrationBarOptions;this.isV2Form=e.isV2Form==="true";this.calendarSettings=e.calendarSettings?e.calendarSettings:{};this.taskList=new Map;this.comments=new Map;this.actions={taskAdd:"taskAdd",taskUpdate:"taskUpdate",taskRemove:"taskRemove",commentAdd:"commentAdd",pinChanged:"pinChanged"};this.classes={highlighted:"task-list-item-highlighted",pinned:"tasks-list-item-pinned"};this.isMyList=this.userId===this.ownerId;this.canPin=this.isMyList;this.updateCanMove();this.init(e)};BX.Tasks.Grid.prototype={init:function(e){this.subscribeToPull();this.bindEvents();this.fillTaskListItems(e.taskList);this.colorPinnedRows();this.showStub();this.clearAnalyticsParams();if(e.arParams&&e.arParams["LAZY_LOAD"]){this.grid.reload()}},clearAnalyticsParams(){const e=new BX.Uri(window.location.href);e.removeQueryParam("ta_cat","ta_sec","ta_sub","ta_el","p1","p2","p3","p4","p5");window.history.replaceState(null,null,e.toString())},subscribeToPull(){new BX.Pull.QueueManager({moduleId:"tasks",userId:this.ownerId,config:{loadItemsDelay:1e3},additionalData:{},events:{onBeforePull:e=>{const{pullData:{command:t,params:i}}=e.data;const s={comment_read_all:this.onPullCommentReadAll,project_read_all:this.onPullProjectReadAll,tag_changed:this.onPullTagChanged};if(s[t]){s[t].apply(this,[i])}},onPull:e=>{const{pullData:{command:t,params:i},promises:s}=e.data;const a=(new BX.Tasks.ControllerTaskEvent).resolveIdByParam(t,i);if(a>0){s.push(Promise.resolve({data:{id:a,action:t,actionParams:i}}))}}},callbacks:{onBeforeQueueExecute:e=>Promise.resolve(),onQueueExecute:e=>new Promise(((t,i)=>{BX.Tasks.ControllerTask.getRepository(e,this).then((i=>{this.executePullQueue(this.getPullItems(e,i)).then((()=>{t()}))}))})),onReload:()=>{}}})},getPullItems(e,t){const i=[];e.forEach((e=>{i.push({...e,...{repository:t}})}));return i},executePullQueue(e){const t={comment_add:this.onPullCommentAdd,task_add:this.onPullTaskAdd,task_update:this.onPullTaskUpdate,task_view:this.onPullTaskView,task_remove:this.onPullTaskRemove,user_option_changed:this.onUserOptionChanged};return new Promise(((i,s)=>{e.forEach((e=>{const{data:{action:i,actionParams:s},repository:a}=e;if(t[i]){t[i].apply(this,[s,a])}}));i()}))},bindEvents:function(){BX.addCustomEvent("BX.Main.grid:sort",function(e,t){if(t===this.grid){this.sorting.sort={};this.sorting.sort[e.sort_by]=e.sort_order}}.bind(this));BX.addCustomEvent("BX.Main.grid:paramsUpdated",function(){this.updateCanMove();this.colorPinnedRows();this.clearTaskListItems();this.clearLastGroupId();this.getRows().map((function(e){return e.getId()})).filter((function(e){return e!=="template_0"})).forEach(function(e){this.addTaskListItem(e);this.updateLastGroupId(e)}.bind(this));this.showStub()}.bind(this));BX.addCustomEvent("BX.Tasks.Filter.group",function(e,t,i){if(this.getGrid()===e){this[t]=i}}.bind(this));const e=new BX.Uri(location.toString()).removeQueryParam("relationToId").removeQueryParam("relationType").toString();history.replaceState(null,"",e);const t=Number(this.arParams.relationToId);const i=this.arParams.relationType;if(t){const e=()=>this.getGrid().reload();const s={subTasks:{relationToField:"parentId",relationDialog:"subTasksDialog"},relatedTasks:{relationToField:"relatedToTaskId",relationDialog:"relatedTasksDialog"}}[i];top.BX.Runtime.loadExtension("tasks.v2.lib.relation-tasks-dialog").then((i=>{const a=i[s.relationDialog];BX.Event.EventEmitter.subscribe("SidePanel.Slider:onClose",(()=>{a.setTaskId(t).getDialog()?.getPopup()?.setTargetContainer(top.document.body)}));BX.Event.bind(document,"click",(({target:e})=>{if(!a.setTaskId(t).getDialog()?.getPopup()?.getPopupContainer()?.contains(e)){top.document.body.click()}}),true);const r=document.getElementById("tasks-buttonRelationAdd");BX.Event.bind(r,"click",(()=>{a.setTaskId(t).onUpdateOnce(e).showTo(r,document.body)}))}));BX.Event.EventEmitter.subscribe("Grid::beforeRequest",(e=>{const[,s]=e.getCompatData();s.url=new BX.Uri(s.url).setQueryParam("relationToId",t).setQueryParam("relationType",i).toString()}));top.BX.Event.EventEmitter.subscribe("tasks:card:taskAdd",(i=>{if(i.getData()?.[s.relationToField]===t){e()}}))}},updateCanMove:function(){this.canMove=this.isMyList&&this.sorting.sort.ACTIVITY_DATE&&this.sorting.sort.ACTIVITY_DATE==="desc"&&!this.groupByGroups&&!this.groupBySubTasks},checkCanMove:function(){return this.canMove},colorPinnedRows:function(){this.getRows().forEach(function(e){var t=e.getNode();this.getIsPinned(e.getId())?BX.addClass(t,this.classes.pinned):BX.removeClass(t,this.classes.pinned)}.bind(this))},getIsPinned:function(e){return this.isRowExist(e)&&this.getRowNodeById(e).querySelector(".main-grid-cell-content-action-pin.main-grid-cell-content-action-active")instanceof HTMLElement},onPullTaskView:function(e,t){if(this.userId!==Number(e.USER_ID)||!this.isRowExist(e.TASK_ID.toString())){return}this.updateActivityDateCellForTask(e.TASK_ID,{},{},t)},onPullCommentReadAll:function(e){this.onReadAll(e)},onPullProjectReadAll:function(e){this.onReadAll(e)},onReadAll:function(e){if(this.userId!==Number(e.USER_ID)){return}this.updateActivityDateCellForTasksFromLocalStorage()},updateActivityDateCellForTasksHandler:function(e,t,i){Object.keys(e.data).forEach(function(t){if(this.isRowExist(t)){var s=this.getRowById(t);var a=e.data[t];if(s.getCellById("ACTIVITY_DATE")){s.setCellsContent({ACTIVITY_DATE:a.content.ACTIVITY_DATE})}s.setActions(a.actions);s.setCellActions(a.cellActions);s.setCounters(a.counters);if(i.highlightRow===true){this.highlightGridRow(t)}}}.bind(this))},updateActivityDateCellForTasksFromLocalStorage:function(){var e={};var t=this.getTaskListItems();var i={taskIds:t,arParams:this.arParams};BX.ajax.runComponentAction("bitrix:tasks.task.list","getGridRows",{mode:"class",data:i}).then(function(e){this.updateActivityDateCellForTasksHandler(e,{},{})}.bind(this)).catch(function(e){if(e.errors){BX.Tasks.alert(e.errors)}}.bind(this))},updateActivityDateCellForTask:function(e,t,i,s){i=i||{};var a=s.collectionGrid.get(BX.Text.toNumber(e));if(a[e]){this.updateActivityDateCellForTasksHandler({data:a},t,i)}else{BX.Tasks.alert("grid.id is empty"+e)}},onPullCommentAdd:function(e,t){if(this.checkComment(e)){var i=e.entityXmlId.split("_");if(i){this.checkTask(i[1],{action:this.actions.commentAdd,userId:Number(e.ownerId),isCompleteComment:e.isCompleteComment},t)}}},onPullTagChanged:function(e){if(this.groupId===0){this.getGrid().reload()}if(this.groupId!==0&&e.groupId===this.groupId){this.getGrid().reload()}var t=BX.UI.EntitySelector.Dialog.getById("tasks-task-list-tag-widget");t&&t.hide()},onPullTaskAdd:function(e,t){if(e.params.addCommentExists===false){this.checkTask(e.TASK_ID.toString(),{action:this.actions.taskAdd,userId:this.ownerId},t)}},onPullTaskUpdate:function(e,t){var i=BX.UI.EntitySelector.Dialog.getById("tasks-task-list-tag-widget");if(i){if("GROUP_ID"in e.AFTER&&e.AFTER.GROUP_ID!==e.BEFORE.GROUP_ID){i.hide()}}if(e.params.updateCommentExists===false){this.checkTask(e.TASK_ID.toString(),{action:this.actions.taskUpdate,userId:this.ownerId},t)}else if(e.params.removedParticipants.includes(this.ownerId.toString())&&(!this.groupId||this.groupId!==Number(e.AFTER.GROUP_ID))){this.removeItem(e.TASK_ID.toString())}},onPullTaskRemove:function(e,t){if(this.checkCanMove()){this.removeItem(e.TASK_ID.toString())}},onUserOptionChanged:function(e,t){if(!this.checkCanMove()||this.userId!==Number(e.USER_ID)){return}var i=e.TASK_ID.toString();switch(Number(e.OPTION)){case 1:this.updateActivityDateCellForTask(i,{},{},t);break;case 2:case 3:if(this.canPin){this.placeToNearTasks(i,null,{action:this.actions.pinChanged},t)}break;default:break}},placeToNearTasks:function(e,t,i,s){var a=s.collectionNear.get(BX.Text.toNumber(e));if(a[e]){var r=a[e];var n=r.before;var o=r.after;if(n&&this.isRowExist(n)||o&&this.isRowExist(o)){var l={before:n,after:o};Object.keys(i).forEach((function(e){l[e]=i[e]}));this.updateItem(e,t,l,s)}else{this.removeItem(e)}}},checkComment:function(e){var t=e.entityXmlId.split("_");if(!t){return false}var i=t[0];var s=t[1];if(i!=="TASK"){return false}if(!this.comments.has(s)){this.comments.set(s,new Set)}var a=this.comments.get(s);var r=e.messageId;var n=e.participants.map((function(e){return e.toString()}));if(a.has(r)){return false}a.add(r);return n.includes(this.userId.toString())||this.groupId===e.groupId},checkTask:function(e,t,i){t=t||{};var s=null;var a=i.collection;var r=i.collectionSiftThroughFilter;if(t.isCompleteComment===false||t.userId===this.userId){s=r.getById(e)}else{s=a.getById(e)}this.onCheckTaskSuccess(s,e,t,i)},onCheckTaskSuccess:function(e,t,i,s){if(BX.Type.isNil(e)){this.removeItem(t);return}var a=e.getFields();if(this.isRowExist(t)){if(this.checkCanMove()){i.canMoveRow=i.action!==this.actions.taskUpdate;this.updateGridRow(t,a,i,s)}else{if(i.action===this.actions.commentAdd){if(i.isCompleteComment===true){this.getGrid().updateRow(t,null,null,(({id:e})=>{BX.onCustomEvent("Tasks.Tasks.Grid:RowUpdate",{id:e})}))}else{var r={};r[t]=a;this.updateActivityDateCellForTask(t,r,{highlightRow:true},s)}}else if(i.action===this.actions.taskUpdate){this.getGrid().updateRow(t,null,null,(({id:e})=>{BX.onCustomEvent("Tasks.Tasks.Grid:RowUpdate",{id:e})}))}}}else if(this.checkCanMove()){if(i.action===this.actions.taskUpdate){this.placeToNearTasks(t,a,i,s)}else{this.updateItem(t,a,i,s)}}},updateItem:function(e,t,i,s){t=t||null;i=i||{};if(!this.hasTaskListItem(e)){this.addTaskListItem(e);this.addGridRow(e,t,i,s)}else{this.updateGridRow(e,t,i,s)}},addGridRow:function(e,t,i,s){var a=s.collectionGrid.get(BX.Text.toNumber(e));if(a[e]){var t=a[e];var r={id:e,columns:t.content,actions:t.actions,cellActions:t.cellActions,counters:t.counters};var n=this.getGridMoveRows(e,i);if(n.rowAfter){r.insertAfter=n.rowAfter}else if(n.rowBefore){r.insertBefore=n.rowBefore}else{r.append=true}if(this.taskList.size>this.getPageNumber()*this.getPageSize()){var o=this.getLastRowId();this.removeTaskListItem(o);BX.remove(this.getRowNodeById(o));this.showMoreButton()}this.hideStub();this.getRealtime().addRow(r);this.colorPinnedRows()}else{BX.Tasks.alert("grid.id is empty"+e)}const l=this.getGrid().containerId;const d=document.getElementById(l+"_check_all");if(d&&d.disabled===true){d.disabled=false}},updateGridRow:function(e,t,i,s){if(!this.isRowExist(e)){return}var a=s.collectionGrid.get(BX.Text.toNumber(e));if(a[e]){var t=a[e];var r=this.getRowById(e);r.setCellsContent(t.content);r.setActions(t.actions);r.setCellActions(t.cellActions);r.setCounters(t.counters);if(i.canMoveRow!==false){this.getGrid().getRows().reset();var n=this.getGridMoveRows(e,i);this.moveRow(e,n.rowAfter)}this.highlightGridRow(e).then(function(){this.colorPinnedRows()}.bind(this));this.getGrid().bindOnRowEvents();BX.onCustomEvent("Tasks.Tasks.Grid:RowUpdate",{id:e})}else{BX.Tasks.alert("grid.id is empty"+e)}},removeItem:function(e){if(!this.isRowExist(e)){return}this.removeTaskListItem(e);this.getGrid().removeRow(e);BX.onCustomEvent("Tasks.Tasks.Grid:RowRemove",{id:e})},getGridMoveRows:function(e,t){var i;var s;switch(t.action){case this.actions.pinChanged:case this.actions.taskUpdate:i=t.before;s=t.after;break;default:i=this.getFirstRowId();s=this.getIsPinned(e)?0:this.getLastPinnedRowId();break}return{rowBefore:i,rowAfter:s}},moveRow:function(e,t){if(t){this.getGrid().getRows().insertAfter(e,t)}else{const t=this.getGrid().getRows().getBodyFirstChild();this.getGrid().getRows().insertBefore(e,t.getId())}},getLastPinnedRowId:function(){var e=Object.values(this.getRows()).filter(function(e){return this.getIsPinned(e.getId())}.bind(this));var t=Object.keys(e);if(t.length>0){return e[t[t.length-1]].getId()}return 0},getFirstRowId:function(){var e=this.getRows();return e.length?this.getRowProp(e[0],"id"):0},getLastRowId:function(){var e=this.getGrid().getRows().getBodyLastChild();return e?this.getRowProp(e,"id"):0},highlightGridRow:function(e){var t=new BX.Promise;if(!this.isRowExist(e)){t.reject();return t}var i=this.getRowNodeById(e);var s=BX.hasClass(i,this.classes.pinned);if(s){BX.removeClass(i,this.classes.pinned)}BX.addClass(i,this.classes.highlighted);setTimeout(function(){BX.removeClass(i,this.classes.highlighted);if(s){BX.addClass(i,this.classes.pinned)}t.fulfill()}.bind(this),900);return t},getGrid:function(){return this.grid},getRows:function(){return this.getGrid().getRows().getBodyChild()},isRowExist:function(e){return this.getRowById(e)!==null},getRowById:function(e){return this.getGrid().getRows().getById(e)},getRowNodeById:function(e){return this.getRowById(e).getNode()},getRowProp:function(e,t){return BX.data(e.getNode(),t)},setRowProp:function(e,t,i){e.getNode().setAttribute("data-"+t,i)},getPageNumber:function(){var e=1;var t=this.getGrid().getContainer().querySelector(".main-grid-nav-panel");if(t){var i=t.querySelector(".main-ui-pagination");if(i){var s=i.querySelector(".main-ui-pagination-active");if(s){e=s.innerText}}}return e},getPageSize:function(){var e=50;var t=BX(this.getGrid().getContainerId()+"_"+this.getGrid().settings.get("pageSizeId"));if(t){e=BX.data(t,"value")}return e},getRealtime:function(){return this.getGrid().getRealtime()},showStub:function(){},hideStub:function(){this.getGrid().hideEmptyStub()},showMoreButton:function(){this.getGrid().getMoreButton().getNode().style.display="inline-block"},hideMoreButton:function(){this.getGrid().getMoreButton().getNode().style.display="none"},getTaskListItems:function(){return Array.from(this.taskList.keys())},hasTaskListItem:function(e){return this.taskList.has(parseInt(e,10))},addTaskListItem:function(e){this.taskList.set(parseInt(e,10))},removeTaskListItem:function(e){this.taskList.delete(parseInt(e,10))},fillTaskListItems:function(e){Object.keys(e).forEach(function(e){this.addTaskListItem(e)}.bind(this))},clearTaskListItems:function(){this.taskList.clear()},updateLastGroupId:function(e){if(e.indexOf("group_")===0){this.lastGroupId=Number(e.replace("group_",""))}},clearLastGroupId:function(){this.lastGroupId=0}};BX.addCustomEvent("tasksTaskEvent",BX.delegate((function(e,t){if(!BX.Tasks.GridActions.checkCanMove()){BX.Tasks.GridActions.reloadGrid()}}),this));BX.addCustomEvent("SidePanel.Slider:onCloseByEsc",(function(e){var t=/tasks\/task\/edit/;var i=e.getSlider().getUrl();if(t.test(i)&&!confirm(BX.message("TASKS_CLOSE_PAGE_CONFIRM"))){e.denyAction()}}));BX.addCustomEvent("BX.Main.Filter:apply",function(e,t,i){var s=window.location.href;var a=new URL(s);var r=a.searchParams.get("F_STATE");var n=r==="sR"?s.replace("&F_STATE=sR",""):s;window.history.replaceState(null,null,n)}.bind(this));BX.addCustomEvent("Tasks.TopMenu:onItem",(function(e,t){var i=BX.Main.filterManager.getById(BX.Tasks.GridActions.gridId);if(!i){console.log("BX.Main.filterManager not initialised");return}var s={preset_id:BX.Tasks.GridActions.defaultPresetId,additional:{ROLEID:e==="view_all"?0:e}};var a=i.getApi();a.setFilter(s,{ROLE_TYPE:"TASKS_ROLE_TYPE_"+(e===""?"view_all":e)});window.history.pushState(null,null,t)}));BX.addCustomEvent("Tasks.Toolbar:onItem",(function(e){var t=e.getData();if(t.counter&&t.counter.filter){t.counter.filter.toggleByField({PROBLEM:t.counter.filterValue})}}));BX.Tasks.Grid.Sorting=function(e){this.grid=BX.Main.gridManager.getInstanceById(e.gridId);this.currentGroupId=e.currentGroupId;this.treeMode=e.treeMode;BX.message(e.messages);this.init();BX.addCustomEvent("BX.Main.grid:rowDragStart",this.handleRowDragStart.bind(this));BX.addCustomEvent("BX.Main.grid:rowDragMove",this.handleRowDragMove.bind(this));BX.addCustomEvent("BX.Main.grid:rowDragEnd",this.handleRowDragEnd.bind(this))};BX.Tasks.Grid.Sorting.prototype={init:function(){this.dragRow=null;this.targetRow=null;this.error=false;this.targetTask=null;this.before=true;this.newGroup=null;this.newParentId=null},getGrid:function(){return this.grid},getRow:function(e){return this.getGrid().getRows().get(e)},getRowById:function(e){return this.getGrid().getRows().getById(e)},getRows:function(){return this.getGrid().getRows().getBodyChild()},getRowProp:function(e,t){return e.getNode().dataset[t]},getRowType:function(e){return this.getRowProp(e,"type")},getRowGroupId:function(e){return this.getRowProp(e,"groupId")},handleRowDragStart:function(e,t){this.dragRow=this.getRow(e.getDragItem())},handleRowDragMove:function(e,t){this.targetRow=this.getRow(e.getTargetItem());var i=this.targetRow?this.getRowType(this.targetRow):null;this.newParentId=null;this.error=false;var s=null;if(i==="task"){var a=this.targetRow.getParentId();if(a!==this.dragRow.getParentId()){this.newParentId=a}s=this.getGroupByRow(this.targetRow);this.targetTask=this.targetRow;this.before=true}else{if(i==="group"){s=this.getPreviousGroup(this.targetRow)}else{s=this.getLastGroup()}var r=this.getClosestTask(this.targetRow);this.targetTask=r.task;this.before=r.before}this.newGroup=s.id!==this.getGroupByRow(this.dragRow).id?s:null;if(i==="task"&&this.isChildOf(this.targetTask,this.dragRow)){this.error=true}else if(this.newGroup&&this.newGroup.id>0&&(this.getRowProp(this.dragRow,"canEdit")==="false"||!this.newGroup.canCreateTasks)){this.error=true}else if(this.newParentId!==null&&this.getRowProp(this.dragRow,"canEdit")==="false"){this.error=true}this.error?e.disallowMove(BX.message("TASKS_ACCESS_DENIED")):e.allowMove()},handleRowDragEnd:function(e,t){if(!this.error){this.save()}this.init()},save:function(){var e=this.dragRow.getId();var t=this.targetTask?this.targetTask.getId():null;if(e===t){return}var i={sourceId:e,targetId:t,before:this.before?1:0,currentGroupId:this.currentGroupId};if(this.newGroup!==null){i.newGroupId=this.newGroup.id;this.setGroupId(this.dragRow,i.newGroupId)}if(this.newParentId!==null&&this.treeMode){i.newParentId=this.newParentId}BX.ajax.runComponentAction("bitrix:tasks.task.list","sortTask",{mode:"class",data:{data:i}}).then(function(e){}.bind(this)).catch(function(e){if(e.errors){BX.Tasks.alert(e.errors);BX.Tasks.GridActions.reloadGrid()}}.bind(this))},getParentRow:function(e){return this.getRowById(e.getParentId())},isChildOf:function(e,t){var i=this.getParentRow(e);while(i!==null){if(i===t){return true}i=this.getParentRow(i)}return false},getGroupById:function(e){var t=this.getRows();for(var i=0;i<t.length;i++){var s=t[i];if(this.getRowType(s)==="group"&&this.getRowGroupId(s)===String(e)){return this.getGroupByRow(s)}}return this.getDefaultProject()},setGroupId:function(e,t){e.getDataset().groupId=t;var i=e.getChildren();for(var s=0;s<i.length;s++){this.setGroupId(i[s],t)}},getDefaultProject:function(){return{id:"0",canCreateTasks:true}},getGroupByRow:function(e){if(this.getRowType(e)==="group"){return{id:this.getRowGroupId(e),canCreateTasks:this.getRowProp(e,"canCreateTasks")==="true"}}else{return this.getGroupById(this.getRowGroupId(e))}},getLastGroup:function(){var e=null;var t=this.getRows();for(var i=t.length-1;i>=0;i--){var s=t[i];if(this.getRowType(s)==="group"){return this.getGroupByRow(s)}}return this.getDefaultProject()},getPreviousGroup:function(e){var t=null;var i=this.getRows();var s=false;for(var a=i.length-1;a>=0;a--){var r=i[a];if(e===r){s=true;continue}if(s&&this.getRowType(r)==="group"){return this.getGroupByRow(r)}}return this.getDefaultProject()},getClosestTask:function(e){var t=this.getRows();var i=e?e.getIndex()-1:t.length;for(var s=i-1;s>=0;s--){if(this.getRowType(t[s])==="task"&&t[s].getDepth()==="0"){return{task:t[s],before:false}}}for(s=i+1;s<t.length;s++){if(this.getRowType(t[s])==="task"&&t[s].getDepth()==="0"){return{task:t[s],before:true}}}return{task:null,before:true}}};BX.Tasks.TourGuideController=function(e){this.tours=e.tours;this.guide=null;this.isV2Form=e.isV2Form;this.initGuides(e)};BX.Tasks.TourGuideController.prototype={initGuides:function(e){var t=this.tours.firstGridTaskCreation;var i=this.tours.expiredTasksDeadlineChange;if(t.show){this.guide=new BX.Tasks.TourGuideController.FirstGridTaskCreationTourGuide(e)}else if(i.show||i.backgroundCheck){this.guide=new BX.Tasks.TourGuideController.ExpiredTasksDeadlineChangeTourGuide(e)}},getGuide:function(){return this.guide}};BX.Tasks.TourGuideController.FirstGridTaskCreationTourGuide=function(e){this.tour=e.tours.firstGridTaskCreation;this.popupData=this.tour.popupData;this.start()};BX.Tasks.TourGuideController.FirstGridTaskCreationTourGuide.prototype={start:function(){const e=BX("tasks-buttonAdd");if(!e){return}if(this.isV2Form===false){e.href=BX.Uri.addParam(e.href,{FIRST_GRID_TASK_CREATION_TOUR_GUIDE:"Y"})}this.guide=new BX.UI.Tour.Guide({steps:[{target:e,title:this.popupData[0].title,text:this.popupData[0].text}],onEvents:true});if(this.isV2Form===false){BX.addCustomEvent("UI.Tour.Guide:onFinish",function(t){if(t.getData().guide===this.guide){e.href=BX.Uri.removeParam(e.href,["FIRST_GRID_TASK_CREATION_TOUR_GUIDE"])}}.bind(this))}this.showNextStep()},showNextStep:function(){setTimeout(function(){this.guide.showNextStep()}.bind(this),500)}};BX.Tasks.TourGuideController.ExpiredTasksDeadlineChangeTourGuide=function(e){this.userId=e.userId;this.tour=e.tours.expiredTasksDeadlineChange;this.popupData=this.tour.popupData;this.counterToCheck=this.tour.counterToCheck;this.rowId=0;this.calendarPopup=0;this.isStopped=false;this.viewMode="grid";this.ajaxActionPrefix="tasks.tourguide.expiredtasksdeadlinechange.";this.grid=BX.Main.gridManager.getInstanceById(e.gridId);if(this.tour.show){this.start()}else if(this.tour.backgroundCheck){this.isPullListening=true}this.bindEvents()};BX.Tasks.TourGuideController.ExpiredTasksDeadlineChangeTourGuide.prototype={bindEvents:function(){var e={user_counter:this.onUserCounter.bind(this)};BX.addCustomEvent("onPullEvent-tasks",function(t,i){if(e[t]){e[t].apply(this,[i])}}.bind(this));BX.addCustomEvent("UI.Tour.Guide:onPopupClose",function(){this.stop()}.bind(this));BX.addCustomEvent("UI.Tour.Guide:onFinish",function(e){if(e.getData().guide===this.guide&&this.getCurrentStepIndex()===0){BX.addCustomEvent("BX.Main.grid:paramsUpdated",BX.proxy(this.onExpiredCounterGridReloaded,this))}}.bind(this))},onUserCounter:function(e){if(!this.isPullListening||this.userId!==Number(e.userId)){return}var t=Number(e[0].view_role_originator.expired)+Number(e[0].view_role_responsible.expired);if(t>=Number(this.counterToCheck)){this.isPullListening=false;BX.ajax.runAction(this.ajaxActionPrefix+"proceed",{analyticsLabel:{viewMode:this.viewMode}}).then(function(e){if(e.data){this.start()}}.bind(this))}},start:function(){this.guide=new BX.UI.Tour.Guide({steps:[{target:document.querySelector(".tasks-counters--item-counter"),title:this.popupData[0].title,text:this.popupData[0].text}],onEvents:true});this.showNextStep()},markShowedStep:function(e){BX.ajax.runAction(this.ajaxActionPrefix+"markShowedStep",{analyticsLabel:{viewMode:this.viewMode,step:e}})},onExpiredCounterGridReloaded:function(){BX.removeCustomEvent("BX.Main.grid:paramsUpdated",BX.proxy(this.onExpiredCounterGridReloaded,this));var e=null;Object.values(this.grid.getRows().getBodyChild()).forEach(function(t){if(!this.rowId&&t.getNode().querySelector(".ui-label.ui-label-danger.ui-label-fill.ui-label-link")){this.rowId=t.getId();e=t.getNode().querySelector(".ui-label.ui-label-danger.ui-label-fill.ui-label-link")}}.bind(this));if(this.rowId>0&&e){this.guide.steps.push(new BX.UI.Tour.Step({target:e,title:this.popupData[1].title,text:this.popupData[1].text}));this.showNextStep()}},setCalendarPopup:function(e){if(!this.calendarPopup&&this.getCurrentStepIndex()===1){this.calendarPopup=e;BX.addCustomEvent(this.calendarPopup,"onPopupAfterClose",BX.proxy(this.onCalendarPopupClose,this))}},onCalendarPopupClose:function(){BX.removeCustomEvent(this.calendarPopup,"onPopupAfterClose",BX.proxy(this.onCalendarPopupClose,this));setTimeout(function(){BX.removeCustomEvent("Tasks.Tour.ExpiredTasksDeadlineChange:saveDeadline",BX.proxy(this.onDeadlineSave,this))}.bind(this),500);BX.addCustomEvent("Tasks.Tour.ExpiredTasksDeadlineChange:saveDeadline",BX.proxy(this.onDeadlineSave,this))},onDeadlineSave:function(){BX.addCustomEvent("BX.Main.grid:paramsUpdated",BX.proxy(this.onGridReloaded,this))},onGridReloaded:function(){BX.removeCustomEvent("BX.Main.grid:paramsUpdated",BX.proxy(this.onGridReloaded,this));if(this.grid.getRows().getById(this.rowId)===null){this.guide.steps.push(new BX.UI.Tour.Step({title:this.popupData[2].title,text:this.popupData[2].text,buttons:[{text:this.popupData[2].buttons[0],event:function(){this.stop()}.bind(this)}]}));this.showNextStep()}},showNextStep:function(){if(this.isStopped){return}setTimeout(function(){this.guide.showNextStep();this.markShowedStep(this.getCurrentStepIndex())}.bind(this),500)},getCurrentStepIndex:function(){return this.guide.currentStepIndex},isCorrectRow:function(e){return Number(this.rowId)===Number(e)},getIsStopped:function(){return this.isStopped},stop:function(){this.isStopped=true;this.guide.close()}}}));this.BX=this.BX||{};(function(e,t,i,s,a){"use strict";var r=Object.freeze({COMMENT_ADD:"comment_add",TASK_ADD:"task_add",TASK_UPDATE:"task_update",TASK_VIEW:"task_view",TASK_REMOVE:"task_remove",USER_OPTION_CHANGED:"user_option_changed"});function n(e,t){l(e,t);t.add(e)}function o(e,t,i){l(e,t);t.set(e,i)}function l(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function d(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var u=new WeakMap;var c=new WeakSet;var h=new WeakSet;var g=new WeakSet;var f=function(){function e(){var i;var s=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);n(this,g);n(this,h);n(this,c);o(this,u,{writable:true,value:0});s=t.Type.isPlainObject(s)?s:{};babelHelpers.classPrivateFieldSet(this,u,(i=s.timeout)!==null&&i!==void 0?i:100)}babelHelpers.createClass(e,[{key:"resolveIdByParam",value:function e(t,i){if(d(this,h,m).call(this,t)){var s=d(this,c,p).call(this,t,i);if(s>0){return s}else{throw new Error("Index is not resolved for command: "+t)}}}},{key:"intervalEmitByParams",value:function e(t){var i=this;return new Promise((function(e,s){var a=Object.values(t);var r=setInterval((function(){if(a.length===0){clearTimeout(r);e();return}var t=a.shift();var s=t.poolItem,n=t.repository;d(i,g,T).call(i,s,n)}),babelHelpers.classPrivateFieldGet(i,u))}))}},{key:"batchEmitByParams",value:function e(t){var i=this;return new Promise((function(e,s){var a=Object.values(t);for(var r in a){if(!a.hasOwnProperty(r)){continue}var n=a[r];var o=n.poolItem,l=n.repository;d(i,g,T).call(i,o,l)}e()}))}}]);return e}();function p(e,t){var i="";if([r.TASK_ADD,r.TASK_UPDATE,r.TASK_REMOVE,r.TASK_VIEW,r.USER_OPTION_CHANGED].includes(e)){i=t.TASK_ID}else{i=t.taskId}return i}function m(e){var t=Object.values(r);return t.includes(e)}function T(e,t){var i=Object.values(e),s=babelHelpers.slicedToArray(i,1),r=s[0];var n=Object.keys(e),o=babelHelpers.slicedToArray(n,1),l=o[0];var d=r.fields.params;a.EventEmitter.emit("BX.Tasks.Event:onEmit",{command:l,params:d,repository:t})}function v(e,t){I(e,t);t.add(e)}function k(e,t,i){I(e,t);t.set(e,i)}function I(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function b(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var w=new WeakMap;var B=new WeakSet;var C=new WeakSet;var S=new WeakSet;var y=function(){function e(){babelHelpers.classCallCheck(this,e);v(this,S);v(this,C);v(this,B);k(this,w,{writable:true,value:{collectionNear:new Map,collectionGrid:new Map,collection:new i.TaskCollection,collectionSiftThroughFilter:new i.TaskCollection}})}babelHelpers.createClass(e,[{key:"callByFilter",value:function e(i,s){var a=this;return new Promise((function(e,r){var n=b(a,B,X).call(a,i,s);var o=b(a,C,A).call(a,n);if(Object.keys(o).length>0){BX.rest.callBatch(o,(function(i){Object.keys(o).forEach((function(e){var s;var r=(s=i[e])!==null&&s!==void 0?s:null;if(t.Type.isNull(r)===false){var n=r.answer.result;b(a,S,E).call(a,e,n)}}));e(a.get())}))}}))}},{key:"get",value:function e(){return babelHelpers.classPrivateFieldGet(this,w)}}]);return e}();function X(e,s){var a={};var r={collectionSiftThroughFilter:{cmd:"tasks.task.list",filter:{id:e.id,returnAccess:e.returnAccess,siftThroughFilter:{userId:e.siftThroughFilter.userId,groupId:e.siftThroughFilter.groupId}}},collection:{cmd:"tasks.task.list",filter:{id:e.id,returnAccess:e.returnAccess}},collectionGrid:{cmd:"tasks.task.getGridRows",filter:{id:e.id},params:s.arParams},collectionNear:{cmd:"tasks.task.getNearTasks",filter:{id:e.id},navigation:s.navigation,params:s.arParams}};Object.keys(r).forEach((function(e){var s=r[e];switch(e){case"collection":case"collectionSiftThroughFilter":a[e]={cmd:s.cmd,param:i.TaskCollection.internalize(s.filter)};break;case"collectionGrid":case"collectionNear":a[e]={cmd:s.cmd,param:{taskIds:t.Type.isArrayFilled(s.filter.id)?s.filter.id:[s.filter.id],navigation:t.Type.isUndefined(s===null||s===void 0?void 0:s.navigation)?null:s.navigation,arParams:s.params}};break}}));return a}function A(e){var t={};Object.keys(e).forEach((function(i){var s=e[i];t[i]=[s.cmd,s.param]}));return t}function E(e,i){var s=this;if(Object.keys(babelHelpers.classPrivateFieldGet(this,w)).includes(e)){switch(e){case"collection":case"collectionSiftThroughFilter":babelHelpers.classPrivateFieldGet(this,w)[e].init(i.tasks);break;case"collectionNear":case"collectionGrid":Object.keys(i).forEach((function(a){if(a>0){var r={};r[a]=i[a];babelHelpers.classPrivateFieldGet(s,w)[e].set(t.Text.toNumber(a),r)}}));break}}}var G=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"getRepository",value:function e(t,i){var s=new y;var a=[];t.forEach((function(e){a.push(e.data.id)}));return new Promise((function(e,t){s.callByFilter({id:a,returnAccess:"Y",siftThroughFilter:{userId:i.ownerId,groupId:i.groupId}},{arParams:i.arParams,navigation:{pageNumber:i.getPageNumber(),pageSize:i.getPageSize()}}).then((function(){e(s.get())}))}))}},{key:"getRepositoryByCollectionPushEventsAsync",value:function t(i,s){var r=new y;var n=e.getValuesId(i);return new Promise((function(e,t){r.callByFilter({id:n,returnAccess:"Y",siftThroughFilter:{userId:s.ownerId,groupId:s.groupId}},{arParams:s.arParams,navigation:{pageNumber:s.getPageNumber(),pageSize:s.getPageSize()}}).then((function(){var t=r.get();a.EventEmitter.emit("BX.Tasks.ControllerTask:onGetRepository",{params:{items:i,repository:t}});e()}))}))}},{key:"emitByCollectionEventImitterEventsAsync",value:function t(i){var s=new f;var a=e.prepareByPoolToEmit(i);return new Promise((function(e,t){s.batchEmitByParams(a).then((function(){return e()}))}))}},{key:"getValuesId",value:function e(t){var i=[];try{for(var s in t){if(!t.hasOwnProperty(s)){continue}var a=Object.keys(t[s]),r=babelHelpers.slicedToArray(a,1),n=r[0];var o=Object.values(t[s]),l=babelHelpers.slicedToArray(o,1),d=l[0];var u=d.fields.id;if(i.includes(u)===false){i.push(u)}}}catch(e){}return i}},{key:"getItemsByType",value:function e(t,i){var s=[];Object.keys(t).forEach((function(e){var a=t[e];if(Object.keys(a)[0]===i){s.push(a[i].fields)}}));return s}},{key:"sortedById",value:function e(t){t.sort((function(e,t){return e.id>t.id?1:t.id<t.id?-1:0}));return t}},{key:"prepareByPoolToEmit",value:function t(i){var s=[];var a=r.USER_OPTION_CHANGED;Object.keys(i).forEach((function(t){var r=i[t];var n=r["default"].fields.params.items;var o=r["default"].fields.params.repository;var l={};var d=e.sortedById(e.getItemsByType(n,a));Object.keys(n).forEach((function(e){if(Object.keys(n[e])[0]===a){l=babelHelpers.defineProperty({},a,{fields:d.shift()})}else{l=n[e]}s.push({poolItem:l,repository:o})}))}));return s}}]);return e}();function R(e,t,i){P(e,t);t.set(e,i)}function P(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var _=new WeakMap;var D=new WeakMap;var N=new WeakMap;var M=new WeakMap;var F=new WeakMap;var x=new WeakMap;var O=new WeakMap;var H=new WeakMap;var L=new WeakMap;var U=new WeakMap;var j=function(e){babelHelpers.inherits(t,e);function t(e){var i;var s;babelHelpers.classCallCheck(this,t);s=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));R(babelHelpers.assertThisInitialized(s),_,{writable:true,value:[{id:"user",options:{emailUsers:true,inviteGuestLink:true},filters:[{id:"tasks.distributedUserDataFilter"}]},{id:"department",options:{selectMode:"usersOnly"}}]});R(babelHelpers.assertThisInitialized(s),D,{writable:true,value:[{id:"project",filters:[{id:"tasks.projectDataFilter"}]}]});R(babelHelpers.assertThisInitialized(s),N,{writable:true,value:(i={},babelHelpers.defineProperty(i,"user",babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(s),_)),babelHelpers.defineProperty(i,"group",babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(s),D)),babelHelpers.defineProperty(i,"project",babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(s),D)),babelHelpers.defineProperty(i,"all",babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(s),_).concat(babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(s),D))),i)});R(babelHelpers.assertThisInitialized(s),M,{writable:true,value:"user"});R(babelHelpers.assertThisInitialized(s),F,{writable:true,value:null});R(babelHelpers.assertThisInitialized(s),x,{writable:true,value:false});R(babelHelpers.assertThisInitialized(s),O,{writable:true,value:false});R(babelHelpers.assertThisInitialized(s),H,{writable:true,value:false});R(babelHelpers.assertThisInitialized(s),L,{writable:true,value:"TASKS"});R(babelHelpers.assertThisInitialized(s),U,{writable:true,value:null});s.setEventNamespace("BX.Tasks.GroupSelector");babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(s),M,e.mode);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(s),F,e.targetNodeId);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(s),x,e.showAvatars);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(s),O,e.enableSearch);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(s),H,e.multiple);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(s),L,e.context);return s}babelHelpers.createClass(t,[{key:"getDialog",value:function e(){var t=this;if(!babelHelpers.classPrivateFieldGet(this,U)){babelHelpers.classPrivateFieldSet(this,U,new s.Dialog({targetNode:document.getElementById(babelHelpers.classPrivateFieldGet(this,F)),showAvatars:babelHelpers.classPrivateFieldGet(this,x),enableSearch:babelHelpers.classPrivateFieldGet(this,O),multiple:babelHelpers.classPrivateFieldGet(this,H),context:babelHelpers.classPrivateFieldGet(this,L),entities:babelHelpers.classPrivateFieldGet(this,N)[babelHelpers.classPrivateFieldGet(this,M)],events:{"Item:onSelect":function e(i){return t.onItemSelect(i)}}}))}return babelHelpers.classPrivateFieldGet(this,U)}},{key:"show",value:function e(){if(babelHelpers.classPrivateFieldGet(this,U)===null){this.getDialog()}babelHelpers.classPrivateFieldGet(this,U).show()}},{key:"onItemSelect",value:function e(t){this.emit("itemSelected",t.getData())}}]);return t}(a.EventEmitter);e.Action=r;e.ControllerTask=G;e.ControllerTaskEvent=f;e.ControllerTaskRepository=y;e.GroupSelector=j})(this.BX.Tasks=this.BX.Tasks||{},BX,BX.Tasks.TaskModel,BX.UI.EntitySelector,BX.Event);
//# sourceMappingURL=script.map.js