this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};(function(e,t,r,i,s,n){"use strict";var a=function(){function e(t){babelHelpers.classCallCheck(this,e);this.filterId=t.filterId;this.filterManager=BX.Main.filterManager.getById(this.filterId);this.bindEvents();this.updateFields()}babelHelpers.createClass(e,[{key:"bindEvents",value:function e(){i.EventEmitter.subscribe("BX.Main.Filter:apply",this.onFilterApply.bind(this))}},{key:"onFilterApply",value:function e(){this.updateFields()}},{key:"updateFields",value:function e(){this.fields=this.filterManager.getFilterFieldsValues()}},{key:"isFilteredByField",value:function e(t){if(!Object.keys(this.fields).includes(t)){return false}if(r.Type.isArray(this.fields[t])){return this.fields[t].length>0}return this.fields[t]!==""}},{key:"isFilteredByFieldValue",value:function e(t,r){return this.isFilteredByField(t)&&this.fields[t]===r}},{key:"toggleByField",value:function e(t){var r=this;var i=t.filterField;var s=t.filterValue;if(!this.isFilteredByFieldValue(i,s)){this.filterManager.getApi().extendFilter(babelHelpers.defineProperty({},i,s),false,{COUNTER_TYPE:"TASKS_COUNTER_TYPE_"+s});return}this.filterManager.getFilterFields().forEach((function(e){if(e.getAttribute("data-name")===i){r.filterManager.getFields().deleteField(e)}}));this.filterManager.getSearch().apply()}},{key:"getFilter",value:function e(){return this.filterManager}}]);return e}();function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){babelHelpers.defineProperty(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function u(e,t){d(e,t);t.add(e)}function c(e,t,r){d(e,t);t.set(e,r)}function d(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function p(e,t,r){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return r}var f=new WeakMap;var m=new WeakSet;var h=new WeakSet;var _=new WeakSet;var b=new WeakSet;var v=new WeakSet;var y=new WeakSet;var g=new WeakSet;var T=new WeakSet;var I=new WeakSet;var E=new WeakSet;var k=new WeakSet;var C=new WeakSet;var L=new WeakSet;var A=function(e){babelHelpers.inherits(t,e);babelHelpers.createClass(t,null,[{key:"counterTypes",get:function e(){return{my:["expired","my_expired","originator_expired","accomplices_expired","auditor_expired","new_comments","my_new_comments","originator_new_comments","accomplices_new_comments","auditor_new_comments","projects_total_expired","projects_total_comments","sonet_total_expired","sonet_total_comments","groups_total_expired","groups_total_comments","scrum_total_comments","flow_total_expired","flow_total_comments"],other:["project_expired","project_comments","projects_foreign_expired","projects_foreign_comments","groups_foreign_expired","groups_foreign_comments","sonet_foreign_expired","sonet_foreign_comments","scrum_foreign_comments"],additional:["muted_new_comments"],expired:["expired","my_expired","originator_expired","accomplices_expired","auditor_expired","project_expired","projects_total_expired","projects_foreign_expired","groups_total_expired","groups_foreign_expired","sonet_total_expired","sonet_foreign_expired","flow_total_expired"],comment:["new_comments","my_new_comments","originator_new_comments","accomplices_new_comments","auditor_new_comments","muted_new_comments","project_comments","projects_total_comments","projects_foreign_comments","groups_total_comments","groups_foreign_comments","sonet_total_comments","sonet_foreign_comments","scrum_total_comments","scrum_foreign_comments","flow_total_comments"],project:["project_expired","projects_total_expired","projects_foreign_expired","groups_total_expired","groups_foreign_expired","sonet_total_expired","sonet_foreign_expired","project_comments","projects_total_comments","projects_foreign_comments","groups_total_comments","groups_foreign_comments","sonet_total_comments","sonet_foreign_comments"],scrum:["scrum_total_comments","scrum_foreign_comments"]}}}]);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,{target:e.renderTo,items:[],multiselect:true,title:r.Loc.getMessage("TASKS_COUNTER_MY")}));u(babelHelpers.assertThisInitialized(i),L);u(babelHelpers.assertThisInitialized(i),C);u(babelHelpers.assertThisInitialized(i),k);u(babelHelpers.assertThisInitialized(i),E);u(babelHelpers.assertThisInitialized(i),I);u(babelHelpers.assertThisInitialized(i),T);u(babelHelpers.assertThisInitialized(i),g);u(babelHelpers.assertThisInitialized(i),y);u(babelHelpers.assertThisInitialized(i),v);u(babelHelpers.assertThisInitialized(i),b);u(babelHelpers.assertThisInitialized(i),_);u(babelHelpers.assertThisInitialized(i),h);u(babelHelpers.assertThisInitialized(i),m);c(babelHelpers.assertThisInitialized(i),f,{writable:true,value:void 0});i.userId=e.userId;i.targetUserId=e.targetUserId;i.groupId=e.groupId;i.counters=e.counters;i.initialCounterTypes=e.counterTypes;i.role=e.role;i.signedParameters=e.signedParameters;babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),f,e.filterId);i.setData(i.counters);i.initPull();i.elements=i.getCounterItems(i.counters);i.setItems(i.elements);return i}babelHelpers.createClass(t,[{key:"isMyTaskList",value:function e(){return this.userId===this.targetUserId}},{key:"isUserTaskList",value:function e(){return Object.keys(this.otherCounters).length===0}},{key:"isProjectsTaskList",value:function e(){return this.groupId>0}},{key:"isProjectList",value:function e(){return!this.isUserTaskList()&&!this.isProjectsTaskList()}},{key:"initPull",value:function e(){var t=this;BX.PULL.subscribe({moduleId:"tasks",callback:function e(r){return t.processPullEvent(r)}});this.extendWatch()}},{key:"extendWatch",value:function e(){var t=this;if(this.isProjectsTaskList()||this.isProjectList()){var r="TASKS_PROJECTS";if(this.isProjectsTaskList()){r="TASKS_PROJECTS_".concat(this.groupId)}BX.PULL.extendWatch(r,true);setTimeout((function(){return t.extendWatch()}),29*60*1e3)}}},{key:"processPullEvent",value:function e(t){var r={user_counter:this.onUserCounter.bind(this),project_counter:this.onProjectCounter.bind(this),comment_read_all:this.onCommentReadAll.bind(this)};var i=Object.prototype.hasOwnProperty;var s=t.command,n=t.params;if(i.call(r,s)){var a=r[s];if(a){a.apply(this,[n])}}}},{key:"bindEvents",value:function e(){var s=this;i.EventEmitter.subscribe("BX.UI.CounterPanel.Item:activate",p(this,_,S).bind(this));i.EventEmitter.subscribe("BX.UI.CounterPanel.Item:deactivate",p(this,v,F).bind(this));i.EventEmitter.subscribe("BX.UI.CounterPanel.Item:click",p(this,m,O).bind(this));i.EventEmitter.subscribe("BX.Main.Filter:apply",this.onFilterApply.bind(this));r.Event.bind(window,"resize",r.Runtime.throttle((function(){if(p(s,h,j).call(s)){var e;(e=s.getItemById(t.READ_ALL_ID))===null||e===void 0?void 0:e.expand()}else{var r;(r=s.getItemById(t.READ_ALL_ID))===null||r===void 0?void 0:r.collapse()}}),10,this))}},{key:"onFilterApply",value:function e(){var t=this;if(this.isRoleChanged()){this.getItems().forEach((function(e){return e.deactivate(false)}));this.updateRole();this.updateCountersData()}else{Object.values(this.elements).forEach((function(e){var r=t.getItemById(e.id);var i=t.filter.isFilteredByFieldValue(e.filterField,e.filterValue);if(!i){r.deactivate(false)}}));p(this,T,H).call(this)}}},{key:"updateCountersData",value:function e(){var i=this;if(t.updateTimeout){t.needUpdate=true;return}t.updateTimeout=true;t.needUpdate=false;r.ajax.runComponentAction("bitrix:tasks.interface.counters","getCounters",{mode:"class",data:{groupId:this.groupId,role:this.role,counters:this.initialCounterTypes},signedParameters:this.signedParameters}).then((function(e){return i.rerender(e.data)}),(function(e){return console.log(e)}));setTimeout((function(){t.updateTimeout=false;if(t.needUpdate){i.updateCountersData()}}),t.timeoutTTL)}},{key:"isRoleChanged",value:function e(){return this.role!==(this.filter.isFilteredByField("ROLEID")?this.filter.fields.ROLEID:"view_all")}},{key:"updateRole",value:function e(){this.role=this.filter.isFilteredByField("ROLEID")?this.filter.fields.ROLEID:"view_all"}},{key:"onCommentReadAll",value:function e(t){this.updateCountersData()}},{key:"onUserCounter",value:function e(t){var r=Object.prototype.hasOwnProperty;if(!this.isUserTaskList()||!this.isMyTaskList()||!r.call(t,this.groupId)||this.userId!==Number(t.userId)){this.updateCountersData();return}if(t.isSonetEnabled!==undefined&&t.isSonetEnabled===false){this.updateCountersData()}}},{key:"onProjectCounter",value:function e(t){if(this.isUserTaskList()){return}this.updateCountersData()}},{key:"getCounterItems",value:function e(i){var s=this;var n=[];var a=0;var o="tasks_more";var l=false;var u=new Set([].concat(babelHelpers.toConsumableArray(t.counterTypes.my),babelHelpers.toConsumableArray(t.counterTypes.other)));n=[];Object.entries(i).forEach((function(e){var r=babelHelpers.slicedToArray(e,2),i=r[0],c=r[1];if(!u.has(i)){return}if(t.counterTypes.other.includes(i)){l=true;a+=Number(c.VALUE);n.push({id:i,title:s.getCounterNameByType(i),value:{value:Number(c.VALUE),order:-1},parentId:o,color:p(s,g,B).call(s,Number(c.VALUE),c.STYLE),filterField:c.FILTER_FIELD,filterValue:c.FILTER_VALUE})}else{n.push({id:i,title:s.getCounterNameByType(i),value:Number(c.VALUE),isRestricted:false,color:p(s,g,B).call(s,Number(c.VALUE),c.STYLE),filterField:c.FILTER_FIELD,filterValue:c.FILTER_VALUE})}}));if(!this.isUserTaskList()||this.isMyTaskList()){n.push({id:t.READ_ALL_ID,title:r.Loc.getMessage("TASKS_COUNTER_READ_ALL"),collapsedIcon:"chat-check",collapsed:!p(this,h,j).call(this),locked:false,dataAttributes:{role:"tasks-counters--item-head-read-all"}})}if(l){n.push({id:o,title:r.Loc.getMessage("TASKS_COUNTER_MORE"),value:{value:a,order:-1},isRestricted:false,color:t.COLOR_THEME})}return n}},{key:"getCounterNameByType",value:function e(i){if(t.counterTypes.expired.includes(i)){return r.Loc.getMessage("TASKS_COUNTER_EXPIRED")}if(t.counterTypes.comment.includes(i)){return r.Loc.getMessage("TASKS_COUNTER_NEW_COMMENTS")}return""}},{key:"setData",value:function e(r){var i=this;this.myCounters={};this.otherCounters={};var s=new Set([].concat(babelHelpers.toConsumableArray(t.counterTypes.my),babelHelpers.toConsumableArray(t.counterTypes.other)));Object.entries(r).forEach((function(e){var r=babelHelpers.slicedToArray(e,2),n=r[0],a=r[1];if(!s.has(n)){return}var o={id:n,title:i.getCounterNameByType(n),value:Number(a.VALUE),color:p(i,g,B).call(i,Number(a.VALUE),a.STYLE),filterField:a.FILTER_FIELD,filterValue:a.FILTER_VALUE};if(t.counterTypes.my.includes(n)){i.myCounters[n]=o}else if(t.counterTypes.other.includes(n)){i.otherCounters[n]=o}}))}},{key:"readAllByRole",value:function e(){(new s.Controller).userComments({groupId:this.groupId,userId:this.userId,role:this.role})}},{key:"readAllForProjects",value:function e(){var r=l(l({},this.myCounters),this.otherCounters);Object.entries(r).forEach((function(e){var r=babelHelpers.slicedToArray(e,2),i=r[0],s=r[1];if(t.counterTypes.comment.includes(i)){s.updateCount(0)}}));(new s.Controller).projectComments({groupId:this.groupId})}},{key:"readAllForScrum",value:function e(){var r=l(l({},this.myCounters),this.otherCounters);Object.entries(r).forEach((function(e){var r=babelHelpers.slicedToArray(e,2),i=r[0],s=r[1];if(t.counterTypes.comment.includes(i)){s.updateCount(0)}}));(new s.Controller).scrumComments({groupId:this.groupId})}},{key:"rerender",value:function e(r){var i=this;this.setData(r);var s=0;var n=null;var a=false;var o=new Set([].concat(babelHelpers.toConsumableArray(t.counterTypes.my),babelHelpers.toConsumableArray(t.counterTypes.other)));Object.entries(r).forEach((function(e){var r=babelHelpers.slicedToArray(e,2),l=r[0],u=r[1];if(!o.has(l)){return}var c=i.getItemById(l);if(c.hasParentId()){n=c.parentId;s+=Number(u.VALUE)}c.updateValue(Number(u.VALUE));c.updateColor(p(i,g,B).call(i,Number(u.VALUE),u.STYLE));if(p(i,g,B).call(i,Number(u.VALUE),u.STYLE)===t.COLOR_SUCCESS){a=true}}));if(a&&(!this.isUserTaskList()||this.isMyTaskList())){p(this,I,R).call(this,a)}if(n){var l=this.getItemById(n);l.updateValue(s)}}},{key:"render",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"init",this).call(this)}},{key:"connectWithFilter",value:function e(){this.filter=new a({filterId:babelHelpers.classPrivateFieldGet(this,f)});this.bindEvents();p(this,T,H).call(this)}}]);return t}(t.CounterPanel);function O(e){var t=e.getData().item;if(t.getId()===A.READ_ALL_ID){if(this.isUserTaskList()||this.isProjectsTaskList()&&this.role!=="view_all"){this.readAllByRole()}else if(this.myCounters.scrum_total_comments||this.otherCounters.scrum_foreign_comments){this.readAllForScrum()}else{this.readAllForProjects()}t.lock()}}function j(){return window.innerWidth>1520}function S(e){var t=e.getData();var r=t.id;var s=null;Object.values(this.elements).forEach((function(e){if(e.id===r){s=e}}));p(this,b,w).call(this,t);this.filter.toggleByField(s);p(this,E,U).call(this,t);i.EventEmitter.emit("Tasks.Toolbar:onItem",{counter:s});i.EventEmitter.emit("BX.Tasks.Counters:active",s)}function w(e){var t=this.getItems();Object.values(t).forEach((function(t){if(t.id!==e.id){t.deactivate(false)}}));if(e.hasParentId()){this.getItemById(e.parentId).activate(false)}}function F(e){var t=this;var r=e.getData();var s=r.id;var n=null;if(r.parent){r.getItems().forEach((function(e){var r=t.getItemById(e);if(r.isActive){s=r.id}}))}Object.values(this.elements).forEach((function(e){if(e.id===s){n=e}}));p(this,y,P).call(this,r);this.filter.toggleByField(n);i.EventEmitter.emit("Tasks.Toolbar:onItem",{counter:n});i.EventEmitter.emit("BX.Tasks.Counters:unActive",n)}function P(e){var t=this;if(e.hasParentId()){var r=this.getItemById(e.parentId);r.deactivate(false);return}if(e.parent){e.getItems().forEach((function(e){var r=t.getItemById(e);if(r.isActive){r.deactivate(false)}}))}}function B(e,t){return Number(e)===0?A.COLOR_GRAY:t.toUpperCase()}function H(){var e=this;var t=null;var r=false;Object.values(this.elements).forEach((function(i){var s=e.getItemById(i.id);var n=e.filter.isFilteredByFieldValue(i.filterField,i.filterValue);if(s.color===A.COLOR_SUCCESS){r=true}if(n){if(s.hasParentId()){t=s.parentId}s.activate(false)}}));if(r&&(!this.isUserTaskList()||this.isMyTaskList())){p(this,I,R).call(this,r)}if(t){this.getItemById(t).activate(false)}}function R(e){var t=this.getItemById(A.READ_ALL_ID);if(e&&t.isLocked()){t.unLock()}if(!e&&!t.isLocked()){t.lock()}}function U(e){n.sendData({tool:"tasks",category:"task_operations",type:"task",event:p(this,k,x).call(this,e),c_section:p(this,C,D).call(this,e),c_element:p(this,L,M).call(this,e)})}function x(e){if(A.counterTypes.expired.includes(e.id)){return"overdue_counters_on"}return"comments_counters_on"}function D(e){if(A.counterTypes.scrum.includes(e.id)){return"scrum"}if(A.counterTypes.project.includes(e.id)){return"project"}return"tasks"}function M(e){if(A.counterTypes.expired.includes(e.id)){return"overdue_counters_filter"}return"comments_counters_filter"}babelHelpers.defineProperty(A,"READ_ALL_ID","read_all");babelHelpers.defineProperty(A,"COLOR_GRAY","GRAY");babelHelpers.defineProperty(A,"COLOR_THEME","THEME");babelHelpers.defineProperty(A,"COLOR_SUCCESS","SUCCESS");babelHelpers.defineProperty(A,"updateTimeout",false);babelHelpers.defineProperty(A,"needUpdate",false);babelHelpers.defineProperty(A,"timeoutTTL",5e3);e.Counters=A})(this.BX.Tasks.Counters=this.BX.Tasks.Counters||{},BX.UI,BX,BX.Event,BX.Tasks.Viewed,BX.UI.Analytics);
//# sourceMappingURL=script.map.js