{"version":3,"sources":["src/legacy.js","src/preset.js","src/roles.js","src/tasks-interface-filter.js"],"names":["Preset","constructor","options","filterId","payAttention","setTimeout","guide","showNextStep","DELAY","BX","Main","filterManager","getById","Guide","simpleMode","onEvents","steps","target","getPopupBindElement","title","Loc","getMessage","text","position","condition","top","bottom","color","getPopup","setWidth","ajax","runComponentAction","mode","data","catch","error","console","log","defaultRole","Roles","params","event","previousRoleId","getData","getFilterFieldsValues","ROLEID","button","selectedRoleId","Object","fromEntries","entries","items","map","roleId","item","TEXT","analytics","Menu","offsetTop","ButtonManager","createFromNode","bindEvent","show","getContainer","EventEmitter","subscribe","setText","updateItems","role","isSelected","onClick","emit","BaseEvent","compatData","sendRoleClick","sendRoleClickType","isFilterEnabled","Runtime","loadExtension","TasksInterfaceFilter","isV2Form","createNode","getMainButton","Tasks","V2","Application","TaskCard","showCompactCard","groupId","roles","showPresetTourGuide","Aha"],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;CCrZsC;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;AAMtC,CAAO,MAAMA,MAAM,CACnB;GAMCC,WAAW,CAACC,OAAgB,EAC5B;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;OAAA;;KAAA;OAAA;OAAA;;KACC,4CAAI,0BAAaA,OAAO,CAACC,QAAQ;KACjC,4CAAI;;GAGLC,YAAY,GACZ;KACCC,UAAU,CAAC,MAAM;OAChB,IAAI,CAACC,KAAK,CAACC,YAAY,EAAE;OACzB,4CAAI;MACJ,EAAEP,MAAM,CAACQ,KAAK,CAAC;;CAwDlB;CAAC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","file":"script.js.map","sourcesContent":[null,"import { Guide } from 'ui.tour';\nimport { ajax, Loc } from 'main.core';\n\ntype Options = {\n\tfilterId: number,\n};\n\nexport class Preset\n{\n\tstatic DELAY = 1000;\n\n\t#filterId: number;\n\t#filter: BX.Main.Filter;\n\n\tconstructor(options: Options)\n\t{\n\t\tthis.#filterId = options.filterId;\n\t\tthis.#init();\n\t}\n\n\tpayAttention(): void\n\t{\n\t\tsetTimeout(() => {\n\t\t\tthis.guide.showNextStep();\n\t\t\tthis.#markViewed();\n\t\t}, Preset.DELAY);\n\t}\n\n\t#init(): void\n\t{\n\t\tthis\n\t\t\t.#setFilter()\n\t\t\t.#setGuide();\n\t}\n\n\t#setFilter(): Preset\n\t{\n\t\tthis.#filter = BX.Main.filterManager.getById(this.#filterId);\n\t\treturn this;\n\t}\n\n\t#setGuide(): Preset\n\t{\n\t\tthis.guide = new Guide({\n\t\t\tsimpleMode: true,\n\t\t\tonEvents: true,\n\t\t\tsteps: [\n\t\t\t\t{\n\t\t\t\t\ttarget: this.#filter.getPopupBindElement(),\n\t\t\t\t\ttitle: Loc.getMessage('TASKS_INTERFACE_FILTER_PRESETS_MOVED_TITLE'),\n\t\t\t\t\ttext: Loc.getMessage('TASKS_INTERFACE_FILTER_PRESETS_MOVED_TEXT'),\n\t\t\t\t\tposition: 'bottom',\n\t\t\t\t\tcondition: {\n\t\t\t\t\t\ttop: true,\n\t\t\t\t\t\tbottom: false,\n\t\t\t\t\t\tcolor: 'primary',\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t],\n\t\t});\n\n\t\tthis.guide.getPopup().setWidth(420);\n\n\t\treturn this;\n\t}\n\n\t#markViewed(): void\n\t{\n\t\tajax.runComponentAction('bitrix:tasks.interface.filter', 'markPresetAhaMomentViewed', {\n\t\t\t\tmode: 'class',\n\t\t\t\tdata: {},\n\t\t\t})\n\t\t\t.catch(error => {\n\t\t\t\tthis.#log(error);\n\t\t\t});\n\t}\n\n\t#log(error: Error): void\n\t{\n\t\tconsole.log(error);\n\t}\n}\n","import { Runtime, Loc } from 'main.core';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\nimport { Button, ButtonManager } from 'ui.buttons';\nimport { Menu, type MenuItemOptions } from 'ui.system.menu';\nimport type { AnalyticsSender } from 'tasks.v2.lib.analytics';\nimport type { AnalyticsParams } from 'tasks.v2.application.task-card';\n\nexport type Params = {\n\tbutton: HTMLElement,\n\titems: { [roleId: string]: RoleDto },\n\tselectedRoleId: string,\n\tanalytics: AnalyticsParams,\n};\n\ntype RoleDto = {\n\tTEXT: string,\n};\n\ntype Role = {\n\ttitle: string,\n};\n\nconst defaultRole = 'view_all';\n\nexport class Roles\n{\n\t#selectedRoleId: string;\n\t#roles: { [roleId: string]: Role };\n\t#analytics: AnalyticsParams;\n\n\t#button: Button;\n\t#menu: Menu;\n\n\tconstructor(params: Params)\n\t{\n\t\tif (!params.button)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#selectedRoleId = params.selectedRoleId || defaultRole;\n\t\tthis.#roles = {\n\t\t\t[defaultRole]: {\n\t\t\t\ttitle: Loc.getMessage('TASKS_ALL_ROLES'),\n\t\t\t},\n\t\t\t...Object.fromEntries(Object.entries(params.items).map(([roleId, item]) => [roleId, {\n\t\t\t\ttitle: item.TEXT,\n\t\t\t}])),\n\t\t};\n\t\tthis.#analytics = params.analytics;\n\n\t\tthis.#initButton(params.button);\n\t\tthis.#bindEvents();\n\t}\n\n\t#initButton(button: HTMLElement): void\n\t{\n\t\tthis.#menu = new Menu({\n\t\t\titems: this.#menuItems,\n\t\t\toffsetTop: 6,\n\t\t});\n\n\t\tthis.#button = ButtonManager.createFromNode(button);\n\t\tthis.#button.bindEvent('click', (): void => {\n\t\t\tthis.#menu.show(this.#button.getContainer());\n\n\t\t\tvoid this.#sendAnalyticsClick();\n\t\t});\n\t}\n\n\t#bindEvents(): void\n\t{\n\t\tEventEmitter.subscribe('BX.Main.Filter:beforeApply', this.#handleFilterBeforeApply);\n\t}\n\n\t#handleFilterBeforeApply = (event: BaseEvent): void => {\n\t\tconst previousRoleId = this.#selectedRoleId;\n\t\tthis.#selectedRoleId = event.getData()[2].getFilterFieldsValues().ROLEID || defaultRole;\n\t\tthis.#update();\n\n\t\tif (previousRoleId !== this.#selectedRoleId)\n\t\t{\n\t\t\tvoid this.#sendAnalyticsApply(this.#selectedRoleId);\n\t\t}\n\t};\n\n\t#update(): void\n\t{\n\t\tthis.#button.setText(this.#roleName);\n\t\tthis.#menu.updateItems(this.#menuItems);\n\t}\n\n\tget #menuItems(): MenuItemOptions[]\n\t{\n\t\treturn Object.entries(this.#roles).map(([roleId, role: Role]) => ({\n\t\t\ttitle: role.title,\n\t\t\tisSelected: roleId === this.#selectedRoleId,\n\t\t\tonClick: (): void => EventEmitter.emit('Tasks.TopMenu:onItem', new BaseEvent({\n\t\t\t\tdata: [roleId],\n\t\t\t\tcompatData: [roleId],\n\t\t\t})),\n\t\t}));\n\t}\n\n\tget #roleName(): string\n\t{\n\t\treturn this.#roles[this.#selectedRoleId].title;\n\t}\n\n\tasync #sendAnalyticsClick(): Promise<void>\n\t{\n\t\tconst analytics = await this.#getAnalyticsSender();\n\n\t\tanalytics.sendRoleClick(this.#analytics);\n\t}\n\n\tasync #sendAnalyticsApply(role: string): Promise<void>\n\t{\n\t\tconst analytics = await this.#getAnalyticsSender();\n\n\t\tanalytics.sendRoleClickType(this.#analytics, {\n\t\t\trole,\n\t\t\tisFilterEnabled: role !== defaultRole,\n\t\t});\n\t}\n\n\tasync #getAnalyticsSender(): Promise<AnalyticsSender>\n\t{\n\t\treturn (await Runtime.loadExtension('tasks.v2.lib.analytics')).analytics;\n\t}\n}\n","import { ButtonManager } from 'ui.buttons';\nimport { Roles, type Params as RolesParams } from './roles';\n\ntype Params = {\n\tfilterId: string,\n\tcreateNode: HTMLElement,\n\troles: RolesParams,\n\tshowPresetTourGuide: boolean,\n\tisV2Form: boolean,\n\tgroupId?: number,\n\tanalytics: Object,\n};\n\nexport class TasksInterfaceFilter\n{\n\t#params: Params;\n\n\tconstructor(params: Params)\n\t{\n\t\tthis.#params = params;\n\n\t\tthis.#initAddButton();\n\t\tthis.#initRoles();\n\t\tthis.#showPresetTourGuide();\n\t}\n\n\t#initAddButton(): void\n\t{\n\t\tif (!this.#params.isV2Form || !this.#params.createNode)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst button = ButtonManager.createFromNode(this.#params.createNode);\n\t\tbutton.getMainButton().bindEvent('click', () => BX.Tasks.V2.Application.TaskCard.showCompactCard({\n\t\t\tgroupId: this.#params.groupId,\n\t\t\tanalytics: this.#params.analytics,\n\t\t}));\n\t}\n\n\t#initRoles(): void\n\t{\n\t\tnew Roles(this.#params.roles);\n\t}\n\n\t#showPresetTourGuide(): void\n\t{\n\t\tif (!this.#params.showPresetTourGuide)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tBX.Tasks.Preset.Aha = new BX.Tasks.Preset({\n\t\t\tfilterId: this.#params.filterId,\n\t\t});\n\t\tBX.Tasks.Preset.Aha.payAttention();\n\t}\n}\n"]}