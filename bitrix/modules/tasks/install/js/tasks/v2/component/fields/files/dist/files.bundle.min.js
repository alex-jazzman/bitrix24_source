this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};this.BX.Tasks.V2.Component=this.BX.Tasks.V2.Component||{};(function(t,e,i,s,n,l,o,r,a,d,u,h,c,p,f,S,k,m,v,A){"use strict";const g=Object.freeze({id:h.TaskField.Files,title:s.Loc.getMessage("TASKS_V2_FILES_TITLE")});const F={name:"TaskFiles",components:{BIcon:r.BIcon,UserFieldWidgetComponent:v.UserFieldWidgetComponent},directives:{hint:e.hint},props:{taskId:{type:[Number,String],required:true}},emits:["open"],setup(t){return{Animated:k.Animated,Outline:k.Outline,filesMeta:g,fileService:A.fileService.get(t.taskId),uploaderAdapter:A.fileService.get(t.taskId).getAdapter()}},data(){return{files:this.fileService.getFiles(),isFilesScrollable:false,showPreview:false}},computed:{task(){return this.$store.getters[`${h.Model.Tasks}/getById`](this.taskId)},filesCount(){return this.files.length},textFormatted(){if(this.filesCount>0){return this.loc("TASKS_V2_FILES_COUNT",{"#COUNT#":this.filesCount})}return this.loc("TASKS_V2_FILES_TITLE")},isUploading(){return this.files.some((({status:t})=>[a.FileStatus.UPLOADING,a.FileStatus.LOADING].includes(t)))},canAttachFiles(){return this.task.rights.attachFile||this.task.rights.edit},isEdit(){return s.Type.isNumber(this.taskId)&&this.taskId>0},widgetOptions(){return{isEmbedded:true,withControlPanel:false,canCreateDocuments:false,tileWidgetOptions:{compact:true,hideDropArea:true,enableDropzone:false,readonly:!this.canAttachFiles,autoCollapse:false,removeFromServer:!this.isEdit,forceDisableSelection:true}}},tooltip(){return()=>i.tooltip({text:this.loc("TASKS_V2_FILES_ADD"),popupOptions:{offsetLeft:this.$refs.add.$el.offsetWidth/2}})}},watch:{files:{handler(t){if(t.length>0&&this.fileService.isFileBrowserClosed()){this.showPreview=true;this.fileService.resetFileBrowserClosedState()}this.handleFilesScrollable()},deep:true}},mounted(){this.showPreview=this.isEdit;this.fileService.subscribe("onFileAdd",this.handleFilesScrollable);this.fileService.subscribe("onFileRemove",this.handleFilesScrollable)},beforeUnmount(){this.fileService.unsubscribe("onFileAdd",this.handleFilesScrollable);this.fileService.unsubscribe("onFileRemove",this.handleFilesScrollable)},methods:{handleAddClick(){this.fileService.browse({bindElement:this.$refs.add.$el,onHideCallback:this.onFileBrowserClose})},handleOpenClick(){if(this.filesCount===0){this.fileService.browse({bindElement:this.$refs.title,onHideCallback:this.onFileBrowserClose})}else{this.$emit("open")}},async handleFilesScrollable(){await this.$nextTick();this.checkFilesScrollable()},checkFilesScrollable(){if(this.$refs.files){this.isFilesScrollable=this.$refs.files.scrollHeight>this.$refs.files.clientHeight}},onFileBrowserClose(){this.fileService.setFileBrowserClosed(true)}},template:`\n\t\t<div\n\t\t\tclass="tasks-field-files"\n\t\t\t:data-task-id="taskId"\n\t\t\t:data-task-field-id="filesMeta.id"\n\t\t\t:data-task-files-count="filesCount"\n\t\t>\n\t\t\t<div class="tasks-field-files-title">\n\t\t\t\t<div\n\t\t\t\t\tclass="tasks-field-files-main"\n\t\t\t\t\tdata-task-files-open\n\t\t\t\t\t@click="handleOpenClick"\n\t\t\t\t\tref="title"\n\t\t\t\t>\n\t\t\t\t\t<template v-if="isUploading">\n\t\t\t\t\t\t<BIcon class="tasks-field-files-icon" :name="Animated.LOADER_WAIT"/>\n\t\t\t\t\t\t<div class="tasks-field-files-text">{{ loc('TASKS_V2_FILES_LOADING') }}</div>\n\t\t\t\t\t</template>\n\t\t\t\t\t<template v-else>\n\t\t\t\t\t\t<BIcon class="tasks-field-files-icon" :name="Outline.ATTACH"/>\n\t\t\t\t\t\t<div class="tasks-field-files-text">{{ textFormatted }}</div>\n\t\t\t\t\t</template>\n\t\t\t\t</div>\n\t\t\t\t<div v-if="canAttachFiles" class="tasks-field-files-add-container" v-hint="tooltip">\n\t\t\t\t\t<BIcon\n\t\t\t\t\t\tclass="tasks-field-files-add"\n\t\t\t\t\t\t:name="Outline.PLUS_L"\n\t\t\t\t\t\t:hoverable="true"\n\t\t\t\t\t\tdata-task-files-plus\n\t\t\t\t\t\t@click="handleAddClick"\n\t\t\t\t\t\tref="add"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tv-if="showPreview && filesCount > 0"\n\t\t\t\tclass="tasks-field-files-list --card"\n\t\t\t\tref="files"\n\t\t\t>\n\t\t\t\t<UserFieldWidgetComponent\n\t\t\t\t\t:uploaderAdapter="uploaderAdapter"\n\t\t\t\t\t:widgetOptions="widgetOptions"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<template v-if="isFilesScrollable">\n\t\t\t\t<div class="tasks-field-files-shadow">\n\t\t\t\t\t<div class="tasks-field-files-shadow-white"/>\n\t\t\t\t</div>\n\t\t\t\t<div\n\t\t\t\t\tclass="tasks-field-files-more-button"\n\t\t\t\t\t@click="$emit('open')"\n\t\t\t\t>\n\t\t\t\t\t<div class="tasks-field-files-more-button-text">\n\t\t\t\t\t\t{{ loc('TASKS_V2_FILES_MORE') }}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t</div>\n\t`};const C={components:{UiButton:S.Button},props:{taskId:{type:[Number,String],required:true}},setup(){return{ButtonSize:S.ButtonSize,AirButtonStyle:S.AirButtonStyle,Outline:r.Outline}},methods:{handleClick(){A.fileService.get(this.taskId).browse({bindElement:this.$el})}},template:`\n\t\t<span data-task-files-upload>\n\t\t\t<UiButton\n\t\t\t\t:text="loc('TASKS_V2_FILES_UPLOAD')"\n\t\t\t\t:size="ButtonSize.MEDIUM"\n\t\t\t\t:style="AirButtonStyle.SELECTION"\n\t\t\t\t:leftIcon="Outline.ATTACH"\n\t\t\t\t@click="handleClick"\n\t\t\t/>\n\t\t</span>\n\t`};const B={components:{UiButton:S.Button},props:{taskId:{type:[Number,String],required:true},files:{type:Array,required:true}},setup(){return{ButtonSize:S.ButtonSize,AirButtonStyle:S.AirButtonStyle,ButtonCounterColor:S.ButtonCounterColor,Outline:r.Outline}},computed:{task(){return this.$store.getters[`${h.Model.Tasks}/getById`](this.taskId)},archiveLink(){return this.task.archiveLink},filesSize(){return this.files.reduce(((t,e)=>t+e.size),0)},formattedFilesSize(){return a.formatFileSize(this.filesSize)}},template:`\n\t\t<a :href="archiveLink" data-task-files-download-archive>\n\t\t\t<UiButton\n\t\t\t\t:text="loc('TASKS_V2_FILES_DOWNLOAD_ARCHIVE', { '#FILES_SIZE#': formattedFilesSize })"\n\t\t\t\t:size="ButtonSize.MEDIUM"\n\t\t\t\t:style="AirButtonStyle.PLAIN_NO_ACCENT"\n\t\t\t/>\n\t\t</a>\n\t`};const I={name:"TaskFilesSheet",components:{UserFieldWidgetComponent:v.UserFieldWidgetComponent,UploadButton:C,DownloadArchiveButton:B,BottomSheet:l.BottomSheet,BIcon:r.BIcon,DropZone:o.DropZone},props:{taskId:{type:[Number,String],required:true},isShown:{type:Boolean,required:true},getBindElement:{type:Function,default:null},getTargetContainer:{type:Function,default:null}},emits:["close"],setup(t){return{Outline:k.Outline,fileService:A.fileService.get(t.taskId),uploaderAdapter:A.fileService.get(t.taskId).getAdapter()}},data(){return{files:this.fileService.getFiles()}},computed:{...n.mapGetters({titleFieldOffsetHeight:`${h.Model.Interface}/titleFieldOffsetHeight`}),task(){return this.$store.getters[`${h.Model.Tasks}/getById`](this.taskId)},canAttachFiles(){return this.task.rights.attachFile||this.task.rights.edit},filesCount(){return this.files.length},archiveLink(){return this.task.archiveLink},isEdit(){return s.Type.isNumber(this.taskId)&&this.taskId>0},widgetOptions(){return{isEmbedded:true,withControlPanel:false,canCreateDocuments:false,tileWidgetOptions:{compact:true,autoCollapse:false,readonly:!this.canAttachFiles,enableDropzone:false,hideDropArea:true,removeFromServer:!this.isEdit,forceDisableSelection:true}}},showFooter(){return this.filesCount>1||this.canAttachFiles},canDownloadArchive(){return this.filesCount>1&&this.archiveLink}},watch:{titleFieldOffsetHeight(){var t;(t=this.$refs.bottomSheet)==null?void 0:t.adjustPosition()}},template:`\n\t\t<BottomSheet\n\t\t\tv-if="isShown"\n\t\t\t:getBindElement="getBindElement"\n\t\t\t:getTargetContainer="getTargetContainer"\n\t\t\tref="bottomSheet"\n\t\t>\n\t\t\t<div class="tasks-field-files-sheet" :data-task-id="taskId">\n\t\t\t\t<div class="tasks-field-files-header">\n\t\t\t\t\t<div class="tasks-field-files-title">\n\t\t\t\t\t\t{{ loc('TASKS_V2_FILES_TITLE') }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<BIcon\n\t\t\t\t\t\tdata-task-files-close\n\t\t\t\t\t\tclass="tasks-field-files-close"\n\t\t\t\t\t\t:hoverable="true"\n\t\t\t\t\t\t:name="Outline.CROSS_L"\n\t\t\t\t\t\t@click="$emit('close')"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-field-files-list">\n\t\t\t\t\t<UserFieldWidgetComponent\n\t\t\t\t\t\t:uploaderAdapter="uploaderAdapter"\n\t\t\t\t\t\t:widgetOptions="widgetOptions"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<div\n\t\t\t\t\tv-if="showFooter"\n\t\t\t\t\tclass="tasks-field-files-footer"\n\t\t\t\t\t:class="{ '--with-archive': canDownloadArchive }"\n\t\t\t\t>\n\t\t\t\t\t<DownloadArchiveButton\n\t\t\t\t\t\tv-if="canDownloadArchive"\n\t\t\t\t\t\t:taskId="taskId"\n\t\t\t\t\t\t:files="files"\n\t\t\t\t\t/>\n\t\t\t\t\t<UploadButton v-if="canAttachFiles" :taskId="taskId"/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<DropZone :taskId="taskId"/>\n\t\t</BottomSheet>\n\t`};const T={components:{Popup:f.Popup,UiButton:S.Button,UserFieldWidgetComponent:v.UserFieldWidgetComponent},props:{taskId:{type:[Number,String],required:true},getBindElement:{type:Function,required:true}},emits:["upload","close"],setup(t){return{ButtonSize:S.ButtonSize,AirButtonStyle:S.AirButtonStyle,ButtonIcon:S.ButtonIcon,Outline:k.Outline,uploaderAdapter:A.fileService.get(t.taskId).getAdapter()}},data(){return{files:A.fileService.get(this.taskId).getFiles()}},computed:{bindElement(){return this.getBindElement()},popupOptions(){return{id:"tasks-field-files-popup",bindElement:this.bindElement,minWidth:380,maxHeight:320,padding:18,bindOptions:{forceBindPosition:true,forceTop:true,position:"top"},closeByEsc:true,autoHideHandler:t=>{var e;const i=this.files.some((({isMenuShown:t})=>t));return((e=this.$refs.popup)==null?void 0:e.autoHideHandler(t))&&!i}}},widgetOptions(){return{isEmbedded:true,withControlPanel:false,canCreateDocuments:false,tileWidgetOptions:{hideDropArea:true,enableDropzone:false,compact:true,autoCollapse:false}}},filesCount(){return this.files.length}},watch:{filesCount(){if(this.filesCount===0){this.closePopup()}}},methods:{handleClearClick(){A.fileService.get(this.taskId).getAdapter().getUploader().removeFiles();this.closePopup()},handleUploadClick(){A.fileService.get(this.taskId).browseFiles()},handleMyDriveClick(){A.fileService.get(this.taskId).browseMyDrive()},closePopup(){this.$emit("close")}},template:`\n\t\t<Popup\n\t\t\t:options="popupOptions"\n\t\t\tref="popup"\n\t\t\t@close="closePopup"\n\t\t>\n\t\t\t<div class="tasks-field-files-popup">\n\t\t\t\t<div class="tasks-field-files-popup-files">\n\t\t\t\t\t<UserFieldWidgetComponent :uploaderAdapter="uploaderAdapter" :widgetOptions="widgetOptions"/>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-field-files-popup-footer">\n\t\t\t\t\t<div class="tasks-field-files-popup-add-buttons">\n\t\t\t\t\t\t<UiButton\n\t\t\t\t\t\t\t:text="loc('TASKS_V2_FILES_UPLOAD_BUTTON')"\n\t\t\t\t\t\t\t:size="ButtonSize.SMALL"\n\t\t\t\t\t\t\t:style="AirButtonStyle.TINTED"\n\t\t\t\t\t\t\t:leftIcon="Outline.DOWNLOAD"\n\t\t\t\t\t\t\t@click="handleUploadClick"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<UiButton\n\t\t\t\t\t\t\t:text="loc('TASKS_V2_FILES_MY_DRIVE')"\n\t\t\t\t\t\t\t:size="ButtonSize.SMALL"\n\t\t\t\t\t\t\t:style="AirButtonStyle.TINTED"\n\t\t\t\t\t\t\t:leftIcon="Outline.UPLOAD"\n\t\t\t\t\t\t\t@click="handleMyDriveClick"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t<UiButton\n\t\t\t\t\t\t:text="loc('TASKS_V2_FILES_CLEAR')"\n\t\t\t\t\t\t:size="ButtonSize.SMALL"\n\t\t\t\t\t\t:style="AirButtonStyle.PLAIN_NO_ACCENT"\n\t\t\t\t\t\t:leftIcon="Outline.TRASHCAN"\n\t\t\t\t\t\t@click="handleClearClick"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</Popup>\n\t`};const b={components:{Chip:u.Chip,FilesPopup:T},inject:["analytics","cardType"],props:{taskId:{type:[Number,String],required:true},isAutonomous:{type:Boolean,default:false}},setup(t){return{filesMeta:g,fileService:A.fileService.get(t.taskId)}},data(){return{files:this.fileService.getFiles(),isPopupShown:false,isPopupShownWithFiles:false}},computed:{task(){return this.$store.getters[`${h.Model.Tasks}/getById`](this.taskId)},group(){return this.$store.getters[`${h.Model.Groups}/getById`](this.task.groupId)},filesCount(){return this.files.length},design(){return{[!this.isAutonomous&&!this.isSelected]:u.ChipDesign.ShadowNoAccent,[!this.isAutonomous&&this.isSelected]:u.ChipDesign.ShadowAccent,[this.isAutonomous&&!this.isSelected]:u.ChipDesign.OutlineNoAccent,[this.isAutonomous&&this.isSelected]:u.ChipDesign.OutlineAccent,[this.hasError]:u.ChipDesign.OutlineAlert}.true},isSelected(){if(this.isAutonomous){return this.files.length>0}const t=this.$store.getters[`${h.Model.Tasks}/wasFieldFilled`](this.taskId,g.id);return t||this.files.length>0},icon(){if(this.isAutonomous&&this.isUploading){return k.Animated.LOADER_WAIT}return k.Outline.ATTACH},text(){if(this.isAutonomous&&this.filesCount>0){return this.loc("TASKS_V2_FILES_COUNT",{"#COUNT#":this.filesCount})}return g.title},isUploading(){return this.fileService.isUploading()},hasError(){return this.files.some((({status:t})=>[a.FileStatus.UPLOAD_FAILED,a.FileStatus.LOAD_FAILED].includes(t)))},canAttachFiles(){return this.task.rights.attachFile||this.task.rights.edit},popupHasAlreadyBeenShown(){return this.filesCount>0&&this.isPopupShownWithFiles}},mounted(){this.fileService.subscribe("onFileAdd",this.handleFileAdd);this.fileService.subscribe("onFileComplete",this.handleFileComplete)},beforeUnmount(){this.fileService.unsubscribe("onFileAdd",this.handleFileAdd);this.fileService.unsubscribe("onFileComplete",this.handleFileComplete)},methods:{handleFileAdd(){if(this.isAutonomous&&this.popupHasAlreadyBeenShown){this.showPopup()}},handleFileComplete(t){this.sendAnalytics(t.getData())},sendAnalytics(t){var e;p.analytics.sendAttachFile(this.analytics,{cardType:this.cardType,collabId:((e=this.group)==null?void 0:e.type)===h.GroupType.Collab?this.group.id:null,fileOrigin:t.origin,fileSize:t.size,fileExtension:t.extension,filesCount:this.filesCount})},handleClick(){if(!this.isAutonomous&&this.isSelected){this.highlightField();return}if(this.files.length>0){this.isPopupShownWithFiles=true;this.showPopup()}else{this.browseFiles()}},showPopup(){this.isPopupShown=true},closePopup(){this.isPopupShown=false;if(!this.filesCount){this.isPopupShownWithFiles=false}},browseFiles(){this.fileService.browse({bindElement:this.$refs.chip.$el,onHideCallback:this.onFileBrowserClose,compact:this.cardType===h.CardType.Compact})},highlightField(){void c.fieldHighlighter.setContainer(this.$root.$el).highlight(g.id)},onFileBrowserClose(){var t;(t=this.$refs.chip)==null?void 0:t.$el.focus();this.fileService.setFileBrowserClosed(true)}},template:`\n\t\t<Chip\n\t\t\tv-if="isSelected || canAttachFiles"\n\t\t\t:design="design"\n\t\t\t:icon="icon"\n\t\t\t:text="text"\n\t\t\t:data-task-id="taskId"\n\t\t\t:data-task-chip-id="filesMeta.id"\n\t\t\tref="chip"\n\t\t\t@click="handleClick"\n\t\t/>\n\t\t<FilesPopup\n\t\t\tv-if="isPopupShown"\n\t\t\t:taskId="taskId"\n\t\t\t:getBindElement="() => $refs.chip.$el"\n\t\t\t@upload="browseFiles"\n\t\t\t@close="closePopup"\n\t\t/>\n\t`};t.Files=F;t.FilesSheet=I;t.FilesChip=b;t.filesMeta=g})(this.BX.Tasks.V2.Component.Fields=this.BX.Tasks.V2.Component.Fields||{},BX.Vue3.Directives,BX.Tasks.V2.Component.Elements,BX,BX.Vue3.Vuex,BX.Tasks.V2.Component.Elements,BX.Tasks.V2.Component,BX.UI.IconSet,BX.UI.Uploader,BX,BX.Tasks.V2.Component.Elements,BX.Tasks.V2.Const,BX.Tasks.V2.Lib,BX.Tasks.V2.Lib,BX.UI.Vue3.Components,BX.Vue3.Components,BX.UI.IconSet,BX,BX.Disk.Uploader,BX.Tasks.V2.Provider.Service);
//# sourceMappingURL=files.bundle.map.js