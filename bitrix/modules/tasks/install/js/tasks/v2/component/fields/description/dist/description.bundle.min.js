this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};this.BX.Tasks.V2.Component=this.BX.Tasks.V2.Component||{};(function(t,e,i,s,n,o,r,a,l,d,c,p,h,u,m,f,v,g,k,S,T,C,b){"use strict";const I=Object.freeze({toolbar:[],floatingToolbar:["bold","italic","underline","strikethrough","|","numbered-list","bulleted-list","|","link"],removePlugins:["BlockToolbar"],visualOptions:{borderWidth:0,blockSpaceInline:0,colorBackground:"transparent"},mention:{dialogOptions:{entities:[{id:T.EntitySelectorEntity.User,options:{emailUsers:true,inviteEmployeeLink:false},itemOptions:{default:{link:"",linkTitle:""}}},{id:T.EntitySelectorEntity.StructureNode,options:{selectMode:"usersOnly",allowFlatDepartments:false}}]}},copilot:{copilotOptions:{}},paragraphPlaceholder:"auto"});var E=babelHelpers.classPrivateFieldLooseKey("editor");var F=babelHelpers.classPrivateFieldLooseKey("fileService");var w=babelHelpers.classPrivateFieldLooseKey("uploaderAdapter");var B=babelHelpers.classPrivateFieldLooseKey("syncHighlightsDebounced");var O=babelHelpers.classPrivateFieldLooseKey("subscribeToEvents");var D=babelHelpers.classPrivateFieldLooseKey("unsubscribeToEvents");var M=babelHelpers.classPrivateFieldLooseKey("registerCommands");var P=babelHelpers.classPrivateFieldLooseKey("syncHighlights");class y extends o.EventEmitter{constructor(t,e){super();Object.defineProperty(this,P,{value:x});Object.defineProperty(this,M,{value:N});Object.defineProperty(this,D,{value:H});Object.defineProperty(this,O,{value:A});Object.defineProperty(this,E,{writable:true,value:void 0});Object.defineProperty(this,F,{writable:true,value:void 0});Object.defineProperty(this,w,{writable:true,value:void 0});Object.defineProperty(this,B,{writable:true,value:void 0});this.onFileComplete=t=>{const e=t.getData();babelHelpers.classPrivateFieldLooseBase(this,E)[E].dispatchCommand(k.Plugins.File.ADD_FILE_COMMAND,e);this.emit("filesChanged")};this.onFileRemove=t=>{const{file:e}=t.getData();this.handleRemoveFile(e.serverFileId);this.emit("filesChanged")};this.handleEditorChange=()=>{babelHelpers.classPrivateFieldLooseBase(this,B)[B]();this.emit("editorChanged")};this.setEventNamespace("Tasks.V2.Component.Description-Text-Editor");this.initService(t);this.initEditor(t,e);babelHelpers.classPrivateFieldLooseBase(this,O)[O]();babelHelpers.classPrivateFieldLooseBase(this,M)[M]();babelHelpers.classPrivateFieldLooseBase(this,B)[B]=g.Runtime.debounce(babelHelpers.classPrivateFieldLooseBase(this,P)[P],500,this)}getEditor(){return babelHelpers.classPrivateFieldLooseBase(this,E)[E]}initService(t){babelHelpers.classPrivateFieldLooseBase(this,F)[F]=b.fileService.get(t);babelHelpers.classPrivateFieldLooseBase(this,w)[w]=b.fileService.get(t).getAdapter()}initEditor(t,e){const i=this.initDescription(t,e.content);const s={content:i,minHeight:118,placeholder:g.Loc.getMessage("TASKS_V2_CHANGE_DESCRIPTION"),newLineMode:"paragraph",events:{onChange:this.handleEditorChange},file:{mode:"disk",files:this.getFiles()},visualOptions:{borderWidth:0,blockSpaceInline:"var(--ui-space-stack-md2)",colorBackground:"transparent"}};babelHelpers.classPrivateFieldLooseBase(this,E)[E]=new k.TextEditor({...I,...s})}initDescription(t,e){if(!g.Type.isStringFilled(e)){return e}const i=this.getTempToServerFileIdMap();const s=e.replaceAll(/(\[disk file id=)(n\d+)/gi,((t,e,s)=>e+(i[s]===undefined?s:i[s])));if(e!==s){const e={description:s};void this.$store.dispatch(`${T.Model.Tasks}/update`,{id:t,fields:e})}return s}setEditorText(t,e){const i=this.initDescription(t,e);babelHelpers.classPrivateFieldLooseBase(this,E)[E].setText(i)}getFiles(){return babelHelpers.classPrivateFieldLooseBase(this,w)[w].getItems()}getTempToServerFileIdMap(){const t={};this.getFiles().forEach((e=>{const i=`n${e.customData.objectId}`;t[i]=e.serverFileId}));return t}destroy(){babelHelpers.classPrivateFieldLooseBase(this,D)[D]();babelHelpers.classPrivateFieldLooseBase(this,E)[E].destroy();babelHelpers.classPrivateFieldLooseBase(this,E)[E]=null}handleRemoveFile(t){babelHelpers.classPrivateFieldLooseBase(this,E)[E].dispatchCommand(k.Plugins.File.REMOVE_FILE_COMMAND,{serverFileId:t,skipHistoryStack:true});babelHelpers.classPrivateFieldLooseBase(this,P)[P]()}insertFile(t){babelHelpers.classPrivateFieldLooseBase(this,E)[E].dispatchCommand(k.Plugins.File.INSERT_FILE_COMMAND,{serverFileId:t.serverFileId,width:600,height:600,info:t,inline:true})}get $store(){return n.Core.getStore()}}function A(){babelHelpers.classPrivateFieldLooseBase(this,F)[F].subscribe("onFileComplete",this.onFileComplete);babelHelpers.classPrivateFieldLooseBase(this,F)[F].subscribe("onFileRemove",this.onFileRemove)}function H(){babelHelpers.classPrivateFieldLooseBase(this,F)[F].unsubscribe("onFileComplete",this.onFileComplete);babelHelpers.classPrivateFieldLooseBase(this,F)[F].unsubscribe("onFileRemove",this.onFileRemove)}function N(){babelHelpers.classPrivateFieldLooseBase(this,E)[E].registerCommand(s.PASTE_COMMAND,(t=>{const e=t.clipboardData;if(!e||!i.isFilePasted(e)){return false}t.preventDefault();i.getFilesFromDataTransfer(e).then((t=>{t.forEach((t=>{babelHelpers.classPrivateFieldLooseBase(this,w)[w].getUploader().addFile(t,{events:{[i.FileEvent.LOAD_ERROR]:()=>{},[i.FileEvent.UPLOAD_ERROR]:()=>{},[i.FileEvent.UPLOAD_COMPLETE]:t=>{const e=t.getTarget();this.insertFile(e.toJSON())}}})}))})).catch((()=>{console.error("clipboard pasting error")}));return true}),s.COMMAND_PRIORITY_NORMAL)}function x(){if(!babelHelpers.classPrivateFieldLooseBase(this,E)[E]){return}babelHelpers.classPrivateFieldLooseBase(this,E)[E].dispatchCommand(k.Plugins.File.GET_INSERTED_FILES_COMMAND,(t=>{const e=new Set;for(const i of t){const{serverFileId:t}=i.getInfo();if(g.Type.isStringFilled(t)||g.Type.isNumber(t)){e.add(t)}}babelHelpers.classPrivateFieldLooseBase(this,w)[w].getUploader().getFiles().forEach((t=>{if(e.has(t.getServerFileId())){t.setCustomData("tileSelected",true);e.delete(t.getServerFileId())}else{t.setCustomData("tileSelected",false)}}));for(const t of e){this.handleRemoveFile(t)}}))}const _={};const $={get(t,e={}){var i;(i=_[t])!=null?i:_[t]=new y(t,e);if(g.Type.isStringFilled(e==null?void 0:e.content)){_[t].setEditorText(t,e.content)}return _[t]},replace(t,e){_[e]=_[t];_[e].initService(e);delete _[t]},delete(t){var e;(e=_[t])==null?void 0:e.destroy();delete _[t]}};const L={name:"TaskDescriptionTextArea",components:{TextEditorComponent:k.TextEditorComponent,UserFieldWidgetComponent:h.UserFieldWidgetComponent},props:{taskId:{type:[Number,String],required:true}},emits:["change","filesChange"],setup(t){return{editor:null,descriptionTextEditor:$.get(t.taskId),fileService:b.fileService.get(t.taskId),uploaderAdapter:b.fileService.get(t.taskId).getAdapter()}},data(){return{files:this.fileService.getFiles()}},computed:{task(){return this.$store.getters[`${T.Model.Tasks}/getById`](this.taskId)},readonly(){return!this.task.rights.edit},isEdit(){return g.Type.isNumber(this.taskId)&&this.taskId>0},widgetOptions(){return{isEmbedded:true,withControlPanel:false,canCreateDocuments:false,insertIntoText:true,tileWidgetOptions:{compact:true,hideDropArea:true,readonly:this.readonly,autoCollapse:false,removeFromServer:!this.isEdit,events:{onInsertIntoText:this.handleInsertFile}}}},filesCount(){return this.files.length}},created(){this.editor=this.descriptionTextEditor.getEditor()},mounted(){this.fileService.subscribe("onFileAdd",this.onFileAdd);this.fileService.subscribe("onFileRemove",this.onFileRemove);this.descriptionTextEditor.subscribe("editorChanged",this.onEditorChange)},unmounted(){this.fileService.unsubscribe("onFileAdd",this.onFileAdd);this.fileService.unsubscribe("onFileRemove",this.onFileRemove);this.descriptionTextEditor.unsubscribe("editorChanged",this.onEditorChange)},methods:{onFileAdd(){this.$emit("filesChange")},onFileRemove(){this.$emit("filesChange")},onEditorChange(){this.$emit("change")},handleInsertFile(t){const e=t.getData().item;this.descriptionTextEditor.insertFile(e)}},template:`\n\t\t<div class="tasks-card-description-text-area-wrapper" ref="editorWrapper">\n\t\t\t<TextEditorComponent :editorInstance="editor">\n\t\t\t\t<template v-if="filesCount > 0" #footer>\n\t\t\t\t\t<div id="descriptionEditorFiles" class="tasks-card-description-editor-files" ref="filesWrapper">\n\t\t\t\t\t\t<UserFieldWidgetComponent\n\t\t\t\t\t\t\t:uploaderAdapter="uploaderAdapter"\n\t\t\t\t\t\t\t:widgetOptions="widgetOptions"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</template>\n\t\t\t</TextEditorComponent>\n\t\t</div>\n\t`};const R={components:{BIcon:d.BIcon},directives:{hint:r.hint},props:{title:{type:String,default:""},iconName:{type:String,required:true},iconColor:{type:String,default:""}},setup(){return{Outline:d.Outline}},computed:{tooltip(){return()=>a.tooltip({text:this.title,popupOptions:{offsetLeft:this.$el.offsetWidth/2}})}},template:`\n\t\t<button class="tasks-card-description-action-button" type="button" v-hint="tooltip">\n\t\t\t<BIcon\n\t\t\t\t:name="iconName"\n\t\t\t\t:color="iconColor"\n\t\t\t\t:hoverable="true"\n\t\t\t\tclass="tasks-card-description-field-icon"\n\t\t\t/>\n\t\t</button>\n\t`};const U={name:"TaskDescriptionCopilot",components:{ActionButton:R,Outline:d.Outline},setup(){return{Outline:d.Outline}},computed:{buttonColor(){return"var(--ui-color-copilot-primary)"}},methods:{handleClick(){alert("Not implemented yet")}},template:`\n\t\t<ActionButton\n\t\t\t:iconName="Outline.COPILOT"\n\t\t\t:title="loc('TASKS_V2_DESCRIPTION_ACTION_COPILOT_TITLE')"\n\t\t\t:iconColor="buttonColor"\n\t\t\t@click="handleClick"\n\t\t/>\n\t`};const V={name:"TaskDescriptionMention",components:{ActionButton:R,Outline:d.Outline},setup(){return{Outline:d.Outline}},template:`\n\t\t<ActionButton\n\t\t\t:iconName="Outline.ATTACH"\n\t\t\t:title="loc('TASKS_V2_DESCRIPTION_ACTION_ATTACH_TITLE')"\n\t\t/>\n\t`};const X={name:"TaskDescriptionMention",components:{ActionButton:R,Outline:d.Outline},setup(){return{Outline:d.Outline}},template:`\n\t\t<ActionButton\n\t\t\t:iconName="Outline.MENTION"\n\t\t\t:title="loc('TASKS_V2_DESCRIPTION_ACTION_MENTION_TITLE')"\n\t\t/>\n\t`};const z={name:"TaskDescriptionContent",components:{BIcon:d.BIcon,UiButton:e.Button,Copilot:U,Attach:V,Mention:X,DescriptionTextArea:L},props:{taskId:{type:[Number,String],required:true}},emits:["close","show"],setup(t){return{ButtonSize:e.ButtonSize,ButtonColor:e.ButtonColor,Outline:d.Outline,fileService:b.fileService.get(t.taskId),descriptionTextEditor:$.get(t.taskId)}},computed:{task(){return this.$store.getters[`${T.Model.Tasks}/getById`](this.taskId)},readonly(){return!this.task.rights.edit},editor(){return this.descriptionTextEditor.getEditor()}},mounted(){this.$emit("show");if(!g.Type.isStringFilled(this.task.description)||this.taskId===0){setTimeout(this.focusToEnd,500)}},methods:{handleClose(){this.$emit("close")},focusToEnd(){this.editor.focus(null,{defaultSelection:"rootEnd"})},handleMentionButtonClick(){this.editor.focus((()=>{this.editor.dispatchCommand(BX.UI.TextEditor.Plugins.Mention.INSERT_MENTION_DIALOG_COMMAND)}),{defaultSelection:"rootEnd"})},handleAttachButtonClick(){this.fileService.browse({bindElement:this.$refs.attach.$el,onHideCallback:this.onFileBrowserClose})},onFileBrowserClose(){this.fileService.setFileBrowserClosed(false)}},template:`\n\t\t<div class="tasks-card-description-wrapper" ref="wrapper">\n\t\t\t<div class="tasks-card-description-header" ref="descriptionHeader">\n\t\t\t\t<div class="tasks-card-description-title">\n\t\t\t\t\t{{ loc('TASKS_V2_CHANGE_DESCRIPTION') }}\n\t\t\t\t</div>\n\t\t\t\t<BIcon\n\t\t\t\t\t:name="Outline.CROSS_L"\n\t\t\t\t\t:hoverable="true"\n\t\t\t\t\tclass="tasks-card-description-field-icon"\n\t\t\t\t\t@click="handleClose"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div class="tasks-card-description-editor-wrapper" id="descriptionTextAreaDestination"/>\n\t\t\t<div v-if="!readonly" class="tasks-card-description-footer" ref="descriptionActions">\n\t\t\t\t<div class="tasks-card-description-action-list">\n\t\t\t\t\t<Copilot />\n\t\t\t\t\t<Attach ref="attach" @click="handleAttachButtonClick"/>\n\t\t\t\t\t<Mention @click="handleMentionButtonClick"/>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-card-description-footer-buttons">\n\t\t\t\t\t<UiButton\n\t\t\t\t\t\t:text="loc('TASKS_V2_DESCRIPTION_BUTTON_SAVE')"\n\t\t\t\t\t\t:size="ButtonSize.MEDIUM"\n\t\t\t\t\t\t:color="ButtonColor.PRIMARY"\n\t\t\t\t\t\t@click="handleClose"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const K={name:"TaskDescriptionMiniFormButton",components:{BIcon:d.BIcon},props:{filesCount:{type:Number,required:true}},setup(){return{Outline:d.Outline}},computed:{iconSize(){return 20}},template:`\n\t\t<div class="tasks-card-change-description-mini-btn">\n\t\t\t<div class="tasks-full-card-field-container --small-vertical-padding">\n\t\t\t\t<div class="tasks-card-change-description" :class="{ '--no-hover': filesCount }">\n\t\t\t\t\t<template v-if="filesCount">\n\t\t\t\t\t\t<BIcon\n\t\t\t\t\t\t\t:name="Outline.ATTACH"\n\t\t\t\t\t\t\t:size=iconSize\n\t\t\t\t\t\t\tclass="tasks-card-description-field-icon-link"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div class="tasks-card-change-description-mini-text-files">\n\t\t\t\t\t\t\t{{ loc('TASKS_V2_DESCRIPTION_FILES_COUNT', { '#COUNT#': String(filesCount) }) }}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</template>\n\t\t\t\t\t<template v-else>\n\t\t\t\t\t\t<div class="tasks-card-change-description-mini-text">\n\t\t\t\t\t\t\t{{ loc('TASKS_V2_CHANGE_DESCRIPTION') }}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<BIcon\n\t\t\t\t\t\t\t:name="Outline.CREATE_CHAT"\n\t\t\t\t\t\t\t:size=iconSize\n\t\t\t\t\t\t\t:hoverable="true"\n\t\t\t\t\t\t\tclass="tasks-card-description-field-icon"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</template>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const W={name:"TaskFullDescription",components:{ActionButton:R,Outline:c.Outline},setup(){return{Outline:c.Outline}},template:`\n\t\t<ActionButton\n\t\t\t:icon-name="Outline.GO_TO_L"\n\t\t\t:title="loc('TASKS_V2_DESCRIPTION_BUTTON_EXPAND')"\n\t\t/>\n\t`};const q={name:"TaskDescriptionMiniForm",components:{TextEditorComponent:k.TextEditorComponent,Copilot:U,Attach:V,Mention:X,FullDescription:W,DescriptionTextArea:L},props:{taskId:{type:[Number,String],required:true},isSlotShown:{type:Boolean,required:true}},emits:["expand","closeEdit"],setup(t){return{Outline:d.Outline,fileService:b.fileService.get(t.taskId),descriptionTextEditor:$.get(t.taskId)}},data(){return{isNeedTeleport:false,hasChanges:false,closed:false}},computed:{task(){return this.$store.getters[`${T.Model.Tasks}/getById`](this.taskId)},taskDescription(){var t;return(t=this.task.description)!=null?t:""},editor(){return this.descriptionTextEditor.getEditor()}},watch:{isSlotShown(t){this.handleTeleport(t)}},async created(){this.saveDebounced=g.Runtime.debounce(this.handleSave,3e4,this);g.Event.bind(window,"beforeunload",this.handleSave)},mounted(){if(!g.Type.isStringFilled(this.taskDescription)){this.focusToEnd()}},async beforeUnmount(){g.Event.unbind(window,"beforeunload",this.handleSave);await this.handleSave();this.closed=true},methods:{focusToEnd(){this.editor.focus(null,{defaultSelection:"rootEnd"})},handleExpand(){this.$emit("expand")},handleMentionButtonClick(){this.editor.focus((()=>{this.editor.dispatchCommand(BX.UI.TextEditor.Plugins.Mention.INSERT_MENTION_DIALOG_COMMAND)}),{defaultSelection:"rootEnd"})},handleAttachButtonClick(){this.fileService.browse({bindElement:this.$refs.attach.$el,onHideCallback:this.onFileBrowserClose})},handleEditorChange(){this.hasChanges=this.taskDescription!==this.getEditorText();void this.saveDebounced()},async handleAddButtonClick(){await this.save()},getEditorText(){var t;return(t=this.editor)==null?void 0:t.getText().replaceAll(/\[p]\n|\[p]\[\/p]|\[\/p]/gi,"").trim()},async handleSave(){if(this.closed||!this.hasChanges||!this.editor){return}await this.save();this.hasChanges=false},async save(){await C.taskService.update(this.taskId,{description:this.editor.getText()})},handleTeleport(t){if(t===true){setTimeout((()=>{this.isNeedTeleport=true}),100);this.editor.setVisualOptions({blockSpaceInline:0})}else{this.isNeedTeleport=false;this.editor.setMaxHeight(null);this.editor.setVisualOptions({blockSpaceInline:"var(--ui-space-stack-md2)"})}},onFileBrowserClose(){this.fileService.setFileBrowserClosed(false)}},template:`\n\t\t<div class="tasks-card-change-description-mini-container">\n\t\t\t<div\n\t\t\t\tclass="tasks-full-card-field-container --description-preview"\n\t\t\t\tref="container"\n\t\t\t\ttabindex="-1"\n\t\t\t>\n\t\t\t\t<Teleport :to="isNeedTeleport ? '#descriptionTextAreaDestination' : undefined" :disabled="!isNeedTeleport">\n\t\t\t\t\t<DescriptionTextArea\n\t\t\t\t\t\t:taskId="taskId"\n\t\t\t\t\t\tref="descriptionTextArea"\n\t\t\t\t\t\t@change="handleEditorChange"\n\t\t\t\t\t\t@filesChange="handleEditorChange"\n\t\t\t\t\t/>\n\t\t\t\t</Teleport>\n\t\t\t\t<div class="tasks-card-description-footer-container">\n\t\t\t\t\t<div class="tasks-card-description-footer">\n\t\t\t\t\t\t<div class="tasks-card-description-action-list">\n\t\t\t\t\t\t\t<Copilot />\n\t\t\t\t\t\t\t<Attach ref="attach" @click="handleAttachButtonClick"/>\n\t\t\t\t\t\t\t<Mention @click="handleMentionButtonClick"/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tclass="tasks-card-description-footer-buttons"\n\t\t\t\t\t\t\tref="fullDescriptionArea"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<FullDescription @click="handleExpand"/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const j={name:"TaskDescriptionPreview",components:{UserFieldWidgetComponent:h.UserFieldWidgetComponent,HtmlFormatterComponent:l.HtmlFormatterComponent,BIcon:d.BIcon},props:{taskId:{type:[Number,String],required:true},files:{type:Array,required:true},filesCount:{type:Number,required:true},isMiniFormShown:{type:Boolean,default:false}},emits:["previewButtonClick"],setup(t){return{BIcon:d.BIcon,Outline:c.Outline,uploaderAdapter:b.fileService.get(t.taskId).getAdapter()}},data(){return{isOverflowing:false,opened:false,isMouseDown:false,selectionMade:false,showRightShadow:null}},computed:{task(){return this.$store.getters[`${T.Model.Tasks}/getById`](this.taskId)},taskDescription(){var t;return(t=this.task.description)!=null?t:""},readonly(){return!this.task.rights.edit},isEdit(){return g.Type.isNumber(this.taskId)&&this.taskId>0},widgetOptions(){return{isEmbedded:true,withControlPanel:false,canCreateDocuments:false,tileWidgetOptions:{compact:true,hideDropArea:true,readonly:this.readonly,enableDropzone:false,autoCollapse:false,removeFromServer:!this.isEdit}}},hidden(){if(this.opened){return false}return this.filesCount||this.isOverflowing},iconSize(){return 20}},watch:{async taskDescription(){await this.$nextTick();this.updateIsOverflowing()}},async mounted(){setTimeout(this.updateIsOverflowing,400);if(this.isMiniFormShown){this.openPreview()}},methods:{updateIsOverflowing(){if(this.opened||!this.$refs.htmlFormatter){return}this.showRightShadow=this.$refs.htmlFormatter.$el.offsetHeight<50;this.isOverflowing=this.$refs.preview.offsetHeight-20<this.$refs.htmlFormatter.$el.offsetHeight},onPreviewClick(){if(this.readonly&&this.hidden){this.openPreview()}if(!this.readonly){this.$emit("previewButtonClick",{doOpenInEditMode:false})}},openPreview(){if(this.$refs.htmlFormatter){g.Dom.style(this.$refs.preview,"maxHeight",`${this.$refs.htmlFormatter.$el.offsetHeight+32}px`)}this.opened=true},onHideClick(){g.Dom.style(this.$refs.preview,"maxHeight","120px");this.opened=false},onMouseDown(t){if(t.button===0){this.isMouseDown=true;this.selectionMade=false}},onMouseMove(){if(this.selectionMade){return}if(this.isMouseDown){const t=window.getSelection();if(t.toString().length>0){this.selectionMade=true}}},onMouseUp(){this.isMouseDown=false;if(!this.selectionMade){this.onPreviewClick()}}},template:`\n\t\t<div class="tasks-full-card-field-container">\n\t\t\t<div\n\t\t\t\tv-if="taskDescription.length > 0"\n\t\t\t\tclass="tasks-card-description-preview"\n\t\t\t\tref="preview"\n\t\t\t>\n\t\t\t\t<HtmlFormatterComponent\n\t\t\t\t\t:bbcode="taskDescription"\n\t\t\t\t\t:options="{ fileMode: 'disk' }"\n\t\t\t\t\t:formatData="{ files }"\n\t\t\t\t\tref="htmlFormatter"\n\t\t\t\t\t@mousedown="onMouseDown"\n\t\t\t\t\t@mousemove="onMouseMove"\n\t\t\t\t\t@mouseup="onMouseUp"\n\t\t\t\t/>\n\t\t\t\t<template v-if="hidden">\n\t\t\t\t\t<div class="tasks-card-description-shadow">\n\t\t\t\t\t\t<div v-if="showRightShadow === true" class="tasks-card-description-shadow-white-right"/>\n\t\t\t\t\t\t<div v-else-if="showRightShadow === false" class="tasks-card-description-shadow-white-bottom"/>\n\t\t\t\t\t</div>\n\t\t\t\t</template>\n\t\t\t\t<div\n\t\t\t\t\tv-if="hidden"\n\t\t\t\t\tclass="tasks-card-description-preview-button"\n\t\t\t\t\t:style="{ 'bottom': showRightShadow ? '16px' : '12px' }"\n\t\t\t\t\t@click="onPreviewClick"\n\t\t\t\t>\n\t\t\t\t\t<span class="tasks-card-description-preview-button-files" v-if="filesCount">\n\t\t\t\t\t\t<BIcon\n\t\t\t\t\t\t\t:name="Outline.ATTACH"\n\t\t\t\t\t\t\t:size="iconSize"\n\t\t\t\t\t\t\tclass="tasks-card-description-field-icon-link"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<span class="tasks-card-description-preview-button-text">\n\t\t\t\t\t\t\t{{ filesCount }}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</span>\n\t\t\t\t\t<span v-if="isOverflowing" class="tasks-card-description-preview-button-text">\n\t\t\t\t\t\t{{ loc('TASKS_V2_DESCRIPTION_PREVIEW_BUTTON_MORE') }}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tv-if="opened && filesCount"\n\t\t\t\tclass="tasks-card-description-editor-files --read-only"\n\t\t\t\t:class="{ '--with-description': taskDescription.length > 0 }"\n\t\t\t\tref="filesWrapper"\n\t\t\t>\n\t\t\t\t<UserFieldWidgetComponent\n\t\t\t\t\t:uploaderAdapter="uploaderAdapter"\n\t\t\t\t\t:widgetOptions="widgetOptions"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tv-if="opened && !isMiniFormShown"\n\t\t\t\tclass="tasks-card-description-preview-button --hide"\n\t\t\t\t@click="onHideClick"\n\t\t\t>\n\t\t\t\t<div class="tasks-card-description-preview-button-more">\n\t\t\t\t\t<span class="tasks-card-description-preview-button-text">\n\t\t\t\t\t\t{{ loc('TASKS_V2_DESCRIPTION_BUTTON_COLLAPSE') }}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const G={name:"TaskDescriptionField",components:{MiniFormButton:K,MiniForm:q,DescriptionPreview:j},props:{taskId:{type:[Number,String],required:true}},setup(t){return{fileService:b.fileService.get(t.taskId),uploaderAdapter:b.fileService.get(t.taskId).getAdapter()}},data(){return{isMiniFormShown:false,isSlotShown:false,doOpenInEditMode:false,files:this.fileService.getFiles()}},computed:{task(){return this.$store.getters[`${T.Model.Tasks}/getById`](this.taskId)},isEdit(){return g.Type.isNumber(this.taskId)&&this.taskId>0},readonly(){return!this.task.rights.edit},filesCount(){return this.files.length}},methods:{openSlotInEditMode(){this.doOpenInEditMode=true;this.isSlotShown=true},closeMiniForm(){this.isMiniFormShown=false},onPreviewButtonClick(t){this.doOpenInEditMode=t.doOpenInEditMode===true;this.isMiniFormShown=true},closeSlot(){this.isSlotShown=false},async save(){var t,e;await((t=this.$refs)==null?void 0:(e=t.miniForm)==null?void 0:e.handleAddButtonClick())}},template:`\n\t\t<slot\n\t\t\t:isShown="isSlotShown"\n\t\t\t:doOpenInEditMode="doOpenInEditMode"\n\t\t\t:close="closeSlot"\n\t\t/>\n\t\t<div\n\t\t\tv-if="!readonly || task.description.length > 0 || filesCount > 0"\n\t\t\tclass="tasks-card-description-field"\n\t\t\t:data-task-id="taskId"\n\t\t\t:data-task-field-id="'description'"\n\t\t>\n\t\t\t<MiniFormButton\n\t\t\t\tv-if="(task.description.length === 0) && !isMiniFormShown"\n\t\t\t\t:filesCount="filesCount"\n\t\t\t\t@click="isMiniFormShown = true"\n\t\t\t/>\n\t\t\t<MiniForm\n\t\t\t\tv-else-if="!readonly && (isMiniFormShown || (task.description.length > 0 && !isEdit))"\n\t\t\t\t:taskId="taskId"\n\t\t\t\t:isSlotShown="isSlotShown"\n\t\t\t\t@expand="openSlotInEditMode"\n\t\t\t\t@closeEdit="closeMiniForm"\n\t\t\t\tref="miniForm"\n\t\t\t/>\n\t\t\t<DescriptionPreview\n\t\t\t\tv-else-if="isMiniFormShown || isEdit"\n\t\t\t\t:taskId="taskId"\n\t\t\t\t:files="files"\n\t\t\t\t:filesCount="filesCount"\n\t\t\t\t:isMiniFormShown="isMiniFormShown"\n\t\t\t\t@previewButtonClick="onPreviewButtonClick"\n\t\t\t/>\n\t\t</div>\n\t`};const Z={name:"TaskDescriptionSheet",components:{BottomSheet:u.BottomSheet,DescriptionEditor:z,DropZone:m.DropZone},props:{taskId:{type:[Number,String],required:true},isShown:{type:Boolean,required:true},doOpenInEditMode:{type:Boolean,default:false},getBindElement:{type:Function,default:null},getTargetContainer:{type:Function,default:null}},emits:["show","close"],computed:{...v.mapGetters({titleFieldOffsetHeight:`${T.Model.Interface}/titleFieldOffsetHeight`})},watch:{titleFieldOffsetHeight(){var t;(t=this.$refs.bottomSheet)==null?void 0:t.adjustPosition()}},methods:{handleShow(){this.$emit("show")}},template:`\n\t\t<BottomSheet\n\t\t\tv-if="isShown"\n\t\t\t:isExpanded="true"\n\t\t\t:getBindElement="getBindElement"\n\t\t\t:getTargetContainer="getTargetContainer"\n\t\t\tref="bottomSheet"\n\t\t>\n\t\t\t<DescriptionEditor\n\t\t\t\tref="editorComponent"\n\t\t\t\t:taskId="taskId"\n\t\t\t\t:doOpenInEditMode="doOpenInEditMode"\n\t\t\t\t:isExpanded="true"\n\t\t\t\t@show="handleShow"\n\t\t\t\t@close="$emit('close')"\n\t\t\t/>\n\t\t\t<DropZone :taskId="taskId"/>\n\t\t</BottomSheet>\n\t`};const Y={name:"TaskDescriptionPopup",components:{Popup:f.Popup,DescriptionEditor:z},props:{taskId:{type:[Number,String],required:true},isShown:{type:Boolean,required:true},doOpenInEditMode:{type:Boolean,default:false}},emits:["show","close","resize"],setup(){return{resizeObserver:null}},data(){return{popupHeight:0}},computed:{popupId(){return`tasks-field-description-popup-${this.taskId}`},popupOptions(){return{className:"tasks-card-description-popup",minHeight:360,maxHeight:this.popupMaxHeight,width:580,offsetTop:0,padding:0,autoHide:false,closeByEsc:false,animation:{showClassName:"tasks-description-popup-show",closeClassName:"tasks-description-popup-close",closeAnimationType:"animation"},events:{onAfterShow:()=>this.$refs.editorComponent.focusToEnd()}}},popupMaxHeight(){return document.body.offsetHeight-120-this.titleFieldOffsetHeight},task(){return this.$store.getters[`${T.Model.Tasks}/getById`](this.taskId)},...v.mapGetters({titleFieldOffsetHeight:`${T.Model.Interface}/titleFieldOffsetHeight`})},watch:{async titleFieldOffsetHeight(){if(!this.$refs.popupComponent){return}this.resizeEditor();await this.$nextTick();this.onResize()}},created(){this.resizeObserver=new ResizeObserver((t=>{for(const e of t){if(e.target===this.$refs.popupWrapper){this.onResize()}}}))},mounted(){g.Event.bind(window,"resize",this.onResize)},beforeUnmount(){g.Event.unbind(window,"resize",this.onResize)},methods:{onShow(){var t;this.resizeEditor();this.$emit("show",{popupInstance:this.$refs.popupComponent.getPopupInstance()});(t=this.$refs.popupComponent)==null?void 0:t.getPopupInstance().adjustPosition();setTimeout((()=>this.resizeObserver.observe(this.$refs.popupWrapper)),300)},resizeEditor(){var t;const e=(t=this.$refs.popupComponent)==null?void 0:t.getPopupInstance();const i=e.getPopupContainer();this.$refs.editorComponent.hideEditor();g.Dom.style(i,"min-height",0);const s=i.clientHeight;const n=240;const o=document.body.clientHeight-s-n-this.titleFieldOffsetHeight;g.Dom.style(i,"min-height","360px");this.$refs.editorComponent.showEditor();this.$refs.editorComponent.setMaxHeight(o);e.setOffset()},onResize(){var t;const e=(t=this.$refs.popupComponent)==null?void 0:t.getPopupInstance();if(e){this.$emit("resize");e.adjustPosition()}},onClose(){this.resizeObserver.disconnect();this.$emit("close")}},template:`\n\t\t<Popup v-if="isShown" :options="popupOptions" ref="popupComponent">\n\t\t\t<div class="tasks-card-description-popup-wrapper" ref="popupWrapper">\n\t\t\t\t<DescriptionEditor\n\t\t\t\t\tref="editorComponent"\n\t\t\t\t\t:taskId="taskId"\n\t\t\t\t\t:doOpenInEditMode="doOpenInEditMode"\n\t\t\t\t\t@show="onShow"\n\t\t\t\t\t@close="onClose"\n\t\t\t\t></DescriptionEditor>\n\t\t\t</div>\n\t\t</Popup>\n\t`};const J={name:"TaskDescriptionInline",components:{TextEditorComponent:k.TextEditorComponent},props:{taskId:{type:[Number,String],required:true}},setup(){return{editor:null,DefaultEditorOptions:I}},data(t){return{isFocused:false,isScrolledToTop:true,isScrolledToBottom:true,fileService:b.fileService.get(t.taskId)}},computed:{task(){return this.$store.getters[`${T.Model.Tasks}/getById`](this.taskId)},taskDescription(){return this.task.description}},created(){const t={minHeight:20,maxHeight:112,placeholder:this.loc("TASKS_V2_DESCRIPTION_INLINE_EDITOR_PLACEHOLDER"),content:this.taskDescription,newLineMode:"paragraph",events:{onFocus:this.handleEditorFocus,onBlur:this.handleEditorBlur,onChange:this.handleEditorChange}};this.editor=new k.TextEditor({...I,...t})},mounted(){g.Event.bind(this.editor.getScrollerContainer(),"scroll",this.handleScroll);this.fileService.getAdapter().getUploader().assignPaste(this.$refs.description)},beforeUnmount(){g.Event.unbind(this.editor.getScrollerContainer(),"scroll",this.handleScroll);this.fileService.getAdapter().getUploader().unassignPaste(this.$refs.description)},methods:{hasScroll(){return!this.isScrolledToTop||!this.isScrolledToBottom},async handleEditorFocus(){this.isFocused=true},async handleEditorBlur(){this.isFocused=false;const t=this.editor.getText();void C.taskService.update(this.taskId,{description:t})},handleEditorChange(){this.handleScroll()},handleScroll(){const t=this.editor.getScrollerContainer();this.isScrolledToTop=t.scrollTop===0;this.isScrolledToBottom=t.scrollTop+t.clientHeight>=t.scrollHeight-5}},template:`\n\t\t<div\n\t\t\tclass="tasks-card-description-inline"\n\t\t\t:class="{ '--bottom-shadow': !isScrolledToBottom, '--top-shadow': !isScrolledToTop }"\n\t\t\t:data-task-id="taskId"\n\t\t\t:data-task-field-id="'description'"\n\t\t\tref="description"\n\t\t>\n\t\t\t<div class="tasks-card-description-inline-shadow --revert" :class="{'--shown': !isScrolledToTop}">\n\t\t\t\t<div class="tasks-card-description-inline-shadow-white"/>\n\t\t\t\t<div class="tasks-card-description-inline-shadow-black"/>\n\t\t\t</div>\n\t\t\t<TextEditorComponent :editorInstance="editor"/>\n\t\t\t<div class="tasks-card-description-inline-shadow" :class="{'--shown': !isScrolledToBottom}">\n\t\t\t\t<div class="tasks-card-description-inline-shadow-white"/>\n\t\t\t\t<div class="tasks-card-description-inline-shadow-black"/>\n\t\t\t</div>\n\t\t</div>\n\t`};t.DescriptionEditor=z;t.DescriptionField=G;t.DescriptionSheet=Z;t.DescriptionPopup=Y;t.DescriptionInline=J;t.descriptionTextEditor=$})(this.BX.Tasks.V2.Component.Fields=this.BX.Tasks.V2.Component.Fields||{},BX.Vue3.Components,BX.UI.Uploader,BX.UI.Lexical.Core,BX.Tasks.V2,BX.Event,BX.Vue3.Directives,BX.Tasks.V2.Component.Elements,BX.UI.BBCode.Formatter,BX.UI.IconSet,BX.UI.IconSet,BX,BX.Disk.Uploader,BX.Tasks.V2.Component.Elements,BX.Tasks.V2.Component,BX.UI.Vue3.Components,BX.Vue3.Vuex,BX,BX.UI.TextEditor,BX.Tasks.V2.Model,BX.Tasks.V2.Const,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service);
//# sourceMappingURL=description.bundle.map.js