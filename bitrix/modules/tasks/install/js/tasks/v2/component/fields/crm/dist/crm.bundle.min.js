this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};this.BX.Tasks.V2.Component=this.BX.Tasks.V2.Component||{};(function(t,e,s,i,a,l,r,n,o,d,c,h,m,p,u,v,b,I,k,y){"use strict";const T={components:{HoverPill:o.HoverPill,TextMd:r.TextMd,RichLoc:l.RichLoc,BMenu:n.BMenu},props:{item:{type:Object,required:true},isEdit:{type:Boolean,required:true},readonly:{type:Boolean,required:true}},emits:["edit","clear"],data(){return{isMenuShown:false}},computed:{menuOptions(){return{id:`tasks-crm-menu-${this.item.id}`,bindElement:this.$refs.pill.$el,offsetTop:8,items:this.menuItems,targetContainer:document.body}},menuItems(){return[{title:this.loc("TASKS_V2_CRM_OPEN"),icon:b.Outline.GO_TO_L,dataset:{id:"tasks-crm-menu-open"},onClick:()=>d.hrefClick(this.item.link)},{title:this.loc("TASKS_V2_CRM_EDIT"),icon:b.Outline.EDIT_L,dataset:{id:"tasks-crm-menu-edit"},onClick:()=>this.$emit("edit")},{title:this.loc("TASKS_V2_CRM_UNLINK"),icon:b.Outline.CROSS_L,dataset:{id:"tasks-crm-menu-unlink"},onClick:this.clear}]}},methods:{prepareTitle(t){return this.loc("TASKS_V2_CRM_ENTITY_TITLE",{"#TYPE_NAME#":t.typeName,"#TITLE#":t.title})},handleClick(){if(!this.isEdit){d.hrefClick(this.item.link);return}if(this.readonly){return}this.isMenuShown=true},clear(){this.$emit("clear",this.item.id)}},template:`\n\t\t<div class="tasks-field-crm-item-container">\n\t\t\t<HoverPill\n\t\t\t\tclass="tasks-field-crm-item"\n\t\t\t\t:withClear="!readonly && !isEdit"\n\t\t\t\t:readonly="readonly"\n\t\t\t\tref="pill"\n\t\t\t\t@click.stop="handleClick"\n\t\t\t\t@clear="clear"\n\t\t\t>\n\t\t\t\t<TextMd class="tasks-field-crm-item-text">\n\t\t\t\t\t<RichLoc tag="span" :text="prepareTitle(item)" placeholder="[a]">\n\t\t\t\t\t\t<template #a="{ text }">\n\t\t\t\t\t\t\t<a @click.prevent>{{ text }}</a>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t</RichLoc>\n\t\t\t\t</TextMd>\n\t\t\t</HoverPill>\n\t\t</div>\n\t\t<BMenu v-if="isMenuShown" :options="menuOptions" @close="isMenuShown = false"/>\n\t`};const B=Object.freeze({id:k.TaskField.Crm,title:c.Loc.getMessage("TASKS_V2_CRM_TITLE")});const C=c.Extension.getSettings("tasks.v2.component.fields.crm").crmIntegration;const g=Object.entries(C).filter((([t,e])=>e==="Y"&&t.startsWith("DYNAMIC_"))).map((([t])=>Number(t.slice(8))));var f=babelHelpers.classPrivateFieldLooseKey("taskId");var S=babelHelpers.classPrivateFieldLooseKey("dialog");var L=babelHelpers.classPrivateFieldLooseKey("onUpdateOnce");var P=babelHelpers.classPrivateFieldLooseKey("onCloseOnce");var F=babelHelpers.classPrivateFieldLooseKey("createDialog");var H=babelHelpers.classPrivateFieldLooseKey("handleItemChange");var E=babelHelpers.classPrivateFieldLooseKey("insertSelectedCrmItems");var O=babelHelpers.classPrivateFieldLooseKey("updateTask");var M=babelHelpers.classPrivateFieldLooseKey("mapItemToModel");var _=babelHelpers.classPrivateFieldLooseKey("clearOnUpdateOnce");var w=babelHelpers.classPrivateFieldLooseKey("items");var X=babelHelpers.classPrivateFieldLooseKey("task");var V=babelHelpers.classPrivateFieldLooseKey("insertCrmItems");class x{constructor(){Object.defineProperty(this,V,{value:R});Object.defineProperty(this,X,{get:N,set:void 0});Object.defineProperty(this,w,{get:j,set:void 0});Object.defineProperty(this,M,{value:D});Object.defineProperty(this,O,{value:A});Object.defineProperty(this,H,{value:$});Object.defineProperty(this,F,{value:K});Object.defineProperty(this,f,{writable:true,value:void 0});Object.defineProperty(this,S,{writable:true,value:void 0});Object.defineProperty(this,L,{writable:true,value:null});Object.defineProperty(this,P,{writable:true,value:null});Object.defineProperty(this,E,{writable:true,value:async()=>{const t=babelHelpers.classPrivateFieldLooseBase(this,S)[S].getSelectedItems().map((t=>babelHelpers.classPrivateFieldLooseBase(this,M)[M](t)));await babelHelpers.classPrivateFieldLooseBase(this,V)[V](t);return t}});Object.defineProperty(this,_,{writable:true,value:()=>{babelHelpers.classPrivateFieldLooseBase(this,L)[L]=null}})}setTaskId(t){babelHelpers.classPrivateFieldLooseBase(this,f)[f]=t;return this}showTo(t){var e,s;(s=(e=babelHelpers.classPrivateFieldLooseBase(this,S))[S])!=null?s:e[S]=babelHelpers.classPrivateFieldLooseBase(this,F)[F]();babelHelpers.classPrivateFieldLooseBase(this,S)[S].selectItemsByIds(babelHelpers.classPrivateFieldLooseBase(this,w)[w]);babelHelpers.classPrivateFieldLooseBase(this,S)[S].showTo(t)}onUpdateOnce(t){babelHelpers.classPrivateFieldLooseBase(this,L)[L]=t}onCloseOnce(t){babelHelpers.classPrivateFieldLooseBase(this,P)[P]=t;return this}get $store(){return h.Core.getStore()}}function K(){let t=false;const e=()=>{t=true};const s=async()=>{var e,s;if(t){void babelHelpers.classPrivateFieldLooseBase(this,H)[H]();t=false}(e=(s=babelHelpers.classPrivateFieldLooseBase(this,P))[P])==null?void 0:e.call(s);babelHelpers.classPrivateFieldLooseBase(this,P)[P]=null};return new u.EntitySelectorDialog({context:"tasks-card",multiple:true,enableSearch:true,entities:[k.EntitySelectorEntity.Deal,k.EntitySelectorEntity.Contact,k.EntitySelectorEntity.Company,k.EntitySelectorEntity.Lead,k.EntitySelectorEntity.SmartInvoice,k.EntitySelectorEntity.DynamicMultiple].map((t=>({id:t,dynamicLoad:true,dynamicSearch:true,options:{dynamicTypeIds:g,showTab:true}}))),preselectedItems:babelHelpers.classPrivateFieldLooseBase(this,w)[w],events:{"Item:onSelect":e,"Item:onDeselect":e,onHide:babelHelpers.classPrivateFieldLooseBase(this,_)[_],onDestroy:babelHelpers.classPrivateFieldLooseBase(this,_)[_],onLoad:babelHelpers.classPrivateFieldLooseBase(this,E)[E]},popupOptions:{events:{onClose:s}}})}async function $(){const t=await babelHelpers.classPrivateFieldLooseBase(this,E)[E]();babelHelpers.classPrivateFieldLooseBase(this,O)[O](t.map((({id:t})=>t)))}function A(t){var e,s;void p.taskService.update(babelHelpers.classPrivateFieldLooseBase(this,f)[f],{crmItemIds:t});(e=(s=babelHelpers.classPrivateFieldLooseBase(this,L))[L])==null?void 0:e.call(s);babelHelpers.classPrivateFieldLooseBase(this,_)[_]()}function D(t){const e=t.getCustomData().get("entityInfo");return{id:m.CrmMappers.mapId(e.type,t.getId()),entityId:t.getId(),type:t.getEntityId(),typeName:e.typeNameTitle,title:t.getTitle(),link:e.url}}function j(){var t,e;return(t=(e=babelHelpers.classPrivateFieldLooseBase(this,X)[X].crmItemIds)==null?void 0:e.map((t=>m.CrmMappers.splitId(t))))!=null?t:[]}function N(){return this.$store.getters[`${k.Model.Tasks}/getById`](babelHelpers.classPrivateFieldLooseBase(this,f)[f])}async function R(t){await this.$store.dispatch(`${k.Model.CrmItems}/upsertMany`,t)}const U=new x;const q=7;const Y={components:{AddBackground:i.AddBackground,TextSm:r.TextSm,BLine:e.BLine,FieldAdd:a.FieldAdd,CrmItem:T},props:{taskId:{type:[Number,String],required:true}},setup(){return{Outline:s.Outline,crmMeta:B}},data(){return{isDialogShown:false,isExpanded:false}},computed:{task(){return this.$store.getters[`${k.Model.Tasks}/getById`](this.taskId)},isEdit(){return Number.isInteger(this.taskId)&&this.taskId>0},crmItems(){return this.$store.getters[`${k.Model.CrmItems}/getByIds`](this.task.crmItemIds)},visibleItems(){return this.crmItems.slice(0,q)},collapsedItems(){return this.crmItems.slice(q)},isLoading(){var t,e;return((t=this.task.crmItemIds)==null?void 0:t.length)&&!((e=this.crmItems)!=null&&e.length)},readonly(){return!this.task.rights.edit},expandButtonText(){if(this.isExpanded){return this.loc("TASKS_V2_CRM_COLLAPSE")}return this.loc("TASKS_V2_CRM_AND_COUNT",{"#COUNT#":this.collapsedItems.length})}},mounted(){void m.crmService.list(this.taskId,this.task.crmItemIds)},methods:{handleClick(){if(this.readonly){return}this.showDialog()},showDialog(){U.setTaskId(this.taskId).onCloseOnce(this.handleClose).showTo(this.$refs.anchor);this.isDialogShown=true},handleClose(){this.isDialogShown=false},handleClear(t){const e=this.task.crmItemIds.filter((e=>e!==t));void p.taskService.update(this.taskId,{crmItemIds:e})}},template:`\n\t\t<AddBackground v-if="!readonly" :isActive="isDialogShown" @click="handleClick"/>\n\t\t<div\n\t\t\tclass="tasks-field-crm"\n\t\t\t:data-task-id="taskId"\n\t\t\t:data-task-field-id="crmMeta.id"\n\t\t\t:data-task-crm-item-ids="task.crmItemIds?.join(',')"\n\t\t>\n\t\t\t<FieldAdd v-if="!task.crmItemIds?.length" :icon="Outline.CRM"/>\n\t\t\t<div v-if="isLoading" class="tasks-field-crm-skeleton">\n\t\t\t\t<template v-for="crmItemId in task.crmItemIds" :key="crmItemId">\n\t\t\t\t\t<BLine :height="20"/>\n\t\t\t\t</template>\n\t\t\t</div>\n\t\t\t<template v-for="item in visibleItems" :key="item.id">\n\t\t\t\t<CrmItem\n\t\t\t\t\t:item="item"\n\t\t\t\t\t:isEdit="isEdit"\n\t\t\t\t\t:readonly="readonly"\n\t\t\t\t\t@edit="showDialog"\n\t\t\t\t\t@clear="handleClear(item.id)"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t\t<template v-if="isExpanded" v-for="item in collapsedItems" :key="item.id">\n\t\t\t\t<CrmItem\n\t\t\t\t\t:item="item"\n\t\t\t\t\t:isEdit="isEdit"\n\t\t\t\t\t:readonly="readonly"\n\t\t\t\t\t@edit="showDialog"\n\t\t\t\t\t@clear="handleClear(item.id)"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t\t<TextSm\n\t\t\t\tv-if="collapsedItems.length > 0"\n\t\t\t\tclass="tasks-field-crm-expand"\n\t\t\t\t@click.capture.stop="isExpanded = !isExpanded"\n\t\t\t>\n\t\t\t\t{{ expandButtonText }}\n\t\t\t</TextSm>\n\t\t</div>\n\t\t<div class="tasks-field-crm-anchor" ref="anchor"></div>\n\t`};const z={components:{Chip:v.Chip},props:{taskId:{type:[Number,String],required:true}},setup(){return{Outline:b.Outline,crmMeta:B}},computed:{task(){return this.$store.getters[`${k.Model.Tasks}/getById`](this.taskId)},design(){return this.isSelected?v.ChipDesign.ShadowAccent:v.ChipDesign.ShadowNoAccent},isSelected(){return this.$store.getters[`${k.Model.Tasks}/wasFieldFilled`](this.taskId,B.id)},readonly(){return!this.task.rights.edit}},methods:{handleClick(){if(this.isSelected){this.highlightField();return}U.setTaskId(this.taskId).showTo(this.$el);U.onUpdateOnce(this.highlightField)},highlightField(){void y.fieldHighlighter.setContainer(this.$root.$el).highlight(B.id)}},template:`\n\t\t<Chip\n\t\t\tv-if="isSelected || !readonly"\n\t\t\t:design="design"\n\t\t\t:icon="Outline.CRM"\n\t\t\t:text="loc('TASKS_V2_CRM_TITLE_CHIP')"\n\t\t\t:data-task-id="taskId"\n\t\t\t:data-task-chip-id="crmMeta.id"\n\t\t\t:data-task-crm-item-ids="task.crmItemIds?.join(',')"\n\t\t\t@click="handleClick"\n\t\t/>\n\t`};t.Crm=Y;t.CrmChip=z;t.crmMeta=B})(this.BX.Tasks.V2.Component.Fields=this.BX.Tasks.V2.Component.Fields||{},BX.UI.System.Skeleton.Vue,BX.UI.IconSet,BX.Tasks.V2.Component.Elements,BX.Tasks.V2.Component.Elements,BX.UI.Vue3.Components,BX.UI.System.Typography.Vue,BX.UI.System.Menu,BX.Tasks.V2.Component.Elements,BX.Tasks.V2.Lib,BX,BX.Tasks.V2,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Lib,BX.UI.System.Chip.Vue,BX.UI.IconSet,BX,BX.Tasks.V2.Const,BX.Tasks.V2.Lib);
//# sourceMappingURL=crm.bundle.map.js