this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};this.BX.Tasks.V2.Component=this.BX.Tasks.V2.Component||{};(function(t,e,s,n,i,a,l,r,o,d,u,h,c,T,p,k,m,S,P,D,f,g,_,A,v,I){"use strict";const E={components:{HoverPill:s.HoverPill},props:{dateTs:{type:Number,required:true},readonly:{type:Boolean,default:false}},computed:{dateFormatted(){return P.calendar.formatDateTime(this.dateTs,{forceYear:true})}},template:`\n\t\t<div class="tasks-field-date-plan-date-container">\n\t\t\t<HoverPill :readonly="readonly">\n\t\t\t\t<div class="tasks-field-date-plan-date">{{ dateFormatted }}</div>\n\t\t\t</HoverPill>\n\t\t</div>\n\t`};const B={components:{HoverPill:s.HoverPill,FieldAdd:n.FieldAdd},directives:{hint:v.hint},props:{taskId:{type:[Number,String],required:true}},setup(){return{Outline:T.Outline}},computed:{task(){return this.$store.getters[`${k.Model.Tasks}/getById`](this.taskId)},tooltip(){return()=>I.tooltip({text:this.loc("TASKS_V2_DATE_PLAN_NO_SUBTASKS_HINT"),popupOptions:{offsetLeft:this.$refs.hint.offsetWidth/2},timeout:100})}},template:`\n\t\t<HoverPill v-if="task.matchesSubTasksTime" :readonly="true">\n\t\t\t<div class="tasks-field-date-plan-content">\n\t\t\t\t<div>{{ loc('TASKS_V2_DATE_PLAN_MATCH_SUBTASKS_TIME_STATE') }}</div>\n\t\t\t\t<div v-hint="tooltip" class="tasks-hint-badge" ref="hint">?</div>\n\t\t\t</div>\n\t\t</HoverPill>\n\t\t<FieldAdd v-else :icon="Outline.PLANNING"/>\n\t`};const V=Object.freeze({id:k.TaskField.DatePlan,title:l.Loc.getMessage("TASKS_V2_DATE_PLAN_TITLE")});const C={components:{FieldList:e.FieldList},props:{taskId:{type:[Number,String],required:true}},emits:["open"],setup(){return{datePlanMeta:V}},computed:{task(){return this.$store.getters[`${k.Model.Tasks}/getById`](this.taskId)},wasFilled(){return this.$store.getters[`${k.Model.Tasks}/wasFieldFilled`](this.taskId,V.id)},fields(){const t=!this.task.startPlanTs&&!this.task.endPlanTs;if(t&&(this.wasFilled||this.task.matchesSubTasksTime)){return[{title:V.title,component:B,props:{taskId:this.taskId}}]}return[{title:this.loc("TASKS_V2_DATE_PLAN_FIELD_START"),component:E,props:{dateTs:this.task.startPlanTs,readonly:this.readonly}},{title:this.loc("TASKS_V2_DATE_PLAN_FIELD_END"),component:E,props:{dateTs:this.task.endPlanTs,readonly:this.readonly}}].filter((({props:{dateTs:t}})=>t))},readonly(){return!this.task.rights.datePlan}},methods:{handleClick(){if(!this.readonly){this.$emit("open")}}},template:`\n\t\t<div\n\t\t\tclass="tasks-field-date-plan"\n\t\t\t:class="{ '--readonly': readonly }"\n\t\t\t:data-task-id="taskId"\n\t\t\t:data-task-field-id="datePlanMeta.id"\n\t\t\t:data-task-plan-start="task.startPlanTs"\n\t\t\t:data-task-plan-end="task.endPlanTs"\n\t\t\t@click="handleClick"\n\t\t>\n\t\t\t<FieldList :fields="fields"/>\n\t\t</div>\n\t`};const w={components:{Chip:i.Chip},props:{taskId:{type:[Number,String],required:true}},emits:["open"],setup(){return{Outline:a.Outline,datePlanMeta:V}},computed:{task(){return this.$store.getters[`${k.Model.Tasks}/getById`](this.taskId)},design(){return this.isSelected?i.ChipDesign.ShadowAccent:i.ChipDesign.ShadowNoAccent},isSelected(){return this.$store.getters[`${k.Model.Tasks}/wasFieldFilled`](this.taskId,V.id)},readonly(){return!this.task.rights.edit}},methods:{handleClick(){if(this.isSelected){this.highlightField();return}this.$emit("open")},highlightField(){void S.fieldHighlighter.setContainer(this.$root.$el).highlight(V.id)}},template:`\n\t\t<Chip\n\t\t\tv-if="isSelected || !readonly"\n\t\t\t:design="design"\n\t\t\t:icon="Outline.PLANNING"\n\t\t\t:text="loc('TASKS_V2_DATE_PLAN_TITLE_CHIP')"\n\t\t\t:data-task-id="taskId"\n\t\t\t:data-task-chip-id="datePlanMeta.id"\n\t\t\t:data-task-plan-start="task.startPlanTs"\n\t\t\t:data-task-plan-end="task.endPlanTs"\n\t\t\t@click="handleClick"\n\t\t/>\n\t`};const N={components:{TextSm:g.TextSm,Switcher:A.Switcher},directives:{hint:v.hint},props:{modelValue:{type:Boolean,required:true},text:{type:String,required:true},hint:{type:String,default:""}},computed:{switcherOptions(){return{size:_.SwitcherSize.extraSmall,useAirDesign:true}},tooltip(){return()=>I.tooltip({text:this.hint,popupOptions:{offsetLeft:this.$refs.hint.offsetWidth/2},timeout:100})}},template:`\n\t\t<div class="tasks-field-date-plan-switcher" @click="$emit('update:modelValue', !modelValue)">\n\t\t\t<Switcher :isChecked="modelValue" :options="switcherOptions"/>\n\t\t\t<TextSm>{{ text }}</TextSm>\n\t\t\t<div v-if="hint" v-hint="tooltip" class="tasks-hint-badge" ref="hint" @click.capture.stop>?</div>\n\t\t</div>\n\t`};const M=2**31;const y={components:{BottomSheet:m.BottomSheet,BIcon:T.BIcon,UiButton:u.Button,HeadlineMd:g.HeadlineMd,TextSm:g.TextSm,BInput:h.BInput,BMenu:c.BMenu,DatePlanSwitcher:N},props:{taskId:{type:[Number,String],required:true},isShown:{type:Boolean,required:true},getBindElement:{type:Function,default:null},getTargetContainer:{type:Function,default:null}},emits:["close"],setup(){return{Outline:T.Outline,InputDesign:h.InputDesign,ButtonSize:u.ButtonSize,ButtonColor:u.ButtonColor,wasEmpty:false}},data(){return{isEndPicker:false,isEndDuration:false,isPickerShown:false,isMenuShown:false,unitId:k.DurationUnit.Days,durationValue:"",startTsTemp:null,endTsTemp:null,matchesWorkTimeTemp:null}},computed:{...d.mapGetters({titleFieldOffsetHeight:`${k.Model.Interface}/titleFieldOffsetHeight`}),isEdit(){return Number.isInteger(this.taskId)&&this.taskId>0},task(){return this.$store.getters[`${k.Model.Tasks}/getById`](this.taskId)},startPlanTs(){return this.task.startPlanTs},endPlanTs(){return this.task.endPlanTs},startTs(){var t;return(t=this.startTsTemp)!=null?t:this.startPlanTs},endTs(){var t;return(t=this.endTsTemp)!=null?t:this.endPlanTs},wasFilled(){return this.$store.getters[`${k.Model.Tasks}/wasFieldFilled`](this.taskId,V.id)},allowsChangeDatePlan:{get(){var t;return(t=this.task.allowsChangeDatePlan)!=null?t:false},set(t){void f.taskService.update(this.taskId,{allowsChangeDatePlan:t})}},matchesWorkTime:{get(){var t,e;return(t=(e=this.matchesWorkTimeTemp)!=null?e:this.task.matchesWorkTime)!=null?t:false},set(t){this.matchesWorkTimeTemp=t;this.update();if(!this.maxDurationReached){void f.taskService.update(this.taskId,{matchesWorkTime:t})}}},matchesSubTasksTime:{get(){var t;return(t=this.task.matchesSubTasksTime)!=null?t:false},set(t){void f.taskService.update(this.taskId,{matchesSubTasksTime:t})}},maxDurationReached(){return this.endTs&&this.startTs&&Math.floor((this.endTs-this.startTs)/1e3)>=M},menuOptions(){return()=>({bindElement:this.$refs.unit.$el,items:[k.DurationUnit.Days,k.DurationUnit.Hours,k.DurationUnit.Minutes].map((t=>{const e=this.units[t];return{title:e.title,isSelected:t===this.unitId,onClick:()=>{this.unitId=t;this.update()}}}))})},units(){const t=r.DurationFormat.getUnitDurations();return{[k.DurationUnit.Days]:{duration:this.matchesWorkTime?P.calendar.workdayDuration:t.d,title:this.loc("TASKS_V2_DATE_PLAN_DAYS")},[k.DurationUnit.Hours]:{duration:t.H,title:this.loc("TASKS_V2_DATE_PLAN_HOURS")},[k.DurationUnit.Minutes]:{duration:t.i,title:this.loc("TASKS_V2_DATE_PLAN_MINUTES")}}},inputDesign(){return this.matchesSubTasksTime?h.InputDesign.Disabled:h.InputDesign.Grey}},watch:{isShown(t){if(t){this.clearTemps();this.updateDuration(this.task.startPlanTs,this.task.endPlanTs);this.wasEmpty=!this.wasFilled}},titleFieldOffsetHeight(){var t;(t=this.$refs.bottomSheet)==null?void 0:t.adjustPosition()}},mounted(){this.updateDuration(this.task.startPlanTs,this.task.endPlanTs)},methods:{clearStart(){this.clearTemps();this.durationValue="";this.updateTaskPlan(null,this.task.endPlanTs)},clearEnd(){this.clearTemps();this.durationValue="";this.updateTaskPlan(this.task.startPlanTs,null)},handleDateClick({target:t},{isEnd:e}){this.clearTemps();this.updateDuration(this.task.startPlanTs,this.task.endPlanTs);this.isEndPicker=e;const s=this.getDatePicker();s.setTargetNode(t);s.show();if(this.isEndPicker&&this.task.endPlanTs){s.setFocusDate(this.task.endPlanTs+D.timezone.getOffset(this.task.endPlanTs))}},getDatePicker(){var t,e;(t=this.handlePickerChangedDebounced)!=null?t:this.handlePickerChangedDebounced=l.Runtime.debounce(this.handlePickerChanged,10,this);(e=this.datePicker)!=null?e:this.datePicker=new o.DatePicker({enableTime:true,selectionMode:"range",defaultTime:P.calendar.defaultTime,events:{[o.DatePickerEvent.SELECT]:this.handlePickerChangedDebounced,[o.DatePickerEvent.DESELECT]:this.handlePickerChangedDebounced,onShow:()=>{this.isPickerShown=true},onHide:()=>{this.isPickerShown=false}}});return this.datePicker},handlePickerChanged(){let t=this.preparePickerTimestamp(this.datePicker.getRangeStart());let e=this.preparePickerTimestamp(this.datePicker.getRangeEnd());if(this.isEndPicker&&!e&&!this.task.startPlanTs){[t,e]=[null,t]}if(t&&!this.task.startPlanTs){t=P.calendar.setHours(t,P.calendar.workdayStart.H,P.calendar.workdayStart.M)}this.updateDuration(t,e)},updateDuration(t,e){const[s,n]=this.prepareRange(t,e);if(!s||!n){this.durationValue="";this.updateTaskPlan(s,n);return}const[i,a]=this.calculateDurationValue(s,n,this.matchesWorkTime);this.durationValue=String(i);this.unitId=a;this.updateTaskPlan(s,n)},update(){const[t,e]=this.prepareRange(this.task.startPlanTs,this.task.endPlanTs);if(t&&e){this.updateRangeFromDuration()}else{this.updateTaskPlan(t,e)}},updateRangeFromDuration(){let[t,e]=this.prepareRange(this.task.startPlanTs,this.task.endPlanTs);if(!t&&!e){return}if(this.isEndDuration){t=null}this.durationValue=this.durationValue.replaceAll(/\D/g,"");const s=this.durationValue*this.units[this.unitId].duration;if(this.matchesWorkTime){t=P.calendar.calculateStartTs(t,e,s);e=P.calendar.calculateEndTs(t,e,s)}else{var n;(n=t)!=null?n:t=e-s;e=t+s}this.updateTaskPlan(t,e)},calculateDurationValue(t,e,s){const n=s?P.calendar.calculateDuration(t,e):e-t;const i=n/this.units[k.DurationUnit.Minutes].duration;const a=n/this.units[k.DurationUnit.Hours].duration;const l=n/this.units[k.DurationUnit.Days].duration;return{[true]:[i,k.DurationUnit.Minutes],[Number.isInteger(a)]:[a,k.DurationUnit.Hours],[Number.isInteger(l)]:[l,k.DurationUnit.Days]}.true},updateTaskPlan(t,e){this.startTsTemp=t;this.endTsTemp=e;if(this.maxDurationReached){return}this.clearTemps();const s=this.getDatePicker();const n={emitEvents:false};if(t||e){const i=t+D.timezone.getOffset(t);const a=e?e+D.timezone.getOffset(e):null;if(t){s.selectRange(i,a,n)}else{s.selectRange(a,null,n)}}else{s.deselectAll(n)}void f.taskService.update(this.taskId,{startPlanTs:t,endPlanTs:e})},clearTemps(){this.startTsTemp=null;this.endTsTemp=null;this.matchesWorkTimeTemp=null},prepareRange(t,e){if(this.matchesWorkTime){return[P.calendar.clampWorkDateTime(t),P.calendar.clampWorkDateTime(e)]}return[t,e]},preparePickerTimestamp(t){if(!t){return null}const e=P.calendar.createDateFromUtc(t).getTime();return e-D.timezone.getOffset(e)},formatDate(t){return P.calendar.formatDateTime(t,{forceYear:true})},close(){if(this.wasEmpty&&this.wasFilled){void S.fieldHighlighter.setContainer(this.$root.$el).highlight(V.id)}if(this.task.matchesSubTasksTime&&!this.isEdit){this.updateDuration(null,null)}this.$emit("close")}},template:`\n\t\t<BottomSheet\n\t\t\tv-if="isShown"\n\t\t\t:getBindElement="getBindElement"\n\t\t\t:getTargetContainer="getTargetContainer"\n\t\t\tref="bottomSheet"\n\t\t>\n\t\t\t<div class="tasks-field-date-plan-sheet">\n\t\t\t\t<div class="tasks-field-date-plan-header">\n\t\t\t\t\t<HeadlineMd>{{ loc('TASKS_V2_DATE_PLAN_TITLE_SHEET') }}</HeadlineMd>\n\t\t\t\t\t<BIcon class="tasks-field-date-plan-close" :name="Outline.CROSS_L" :hoverable="true" @click="close"/>\n\t\t\t\t</div>\n\t\t\t\t<TextSm class="tasks-field-date-plan-description">{{ loc('TASKS_V2_DATE_PLAN_DESCRIPTION') }}</TextSm>\n\t\t\t\t<div class="tasks-field-date-plan-fields">\n\t\t\t\t\t<BInput\n\t\t\t\t\t\t:modelValue="formatDate(startTs)"\n\t\t\t\t\t\t:label="loc('TASKS_V2_DATE_PLAN_START')"\n\t\t\t\t\t\t:design="inputDesign"\n\t\t\t\t\t\t:icon="Outline.CALENDAR_WITH_SLOTS"\n\t\t\t\t\t\t:withClear="Boolean(startTs)"\n\t\t\t\t\t\t:active="isPickerShown && !isEndPicker"\n\t\t\t\t\t\t@clear="clearStart"\n\t\t\t\t\t\t@click="handleDateClick($event, { isEnd: false })"\n\t\t\t\t\t\t@focus="$event.target.blur()"\n\t\t\t\t\t/>\n\t\t\t\t\t<BInput\n\t\t\t\t\t\t:modelValue="formatDate(endTs)"\n\t\t\t\t\t\t:label="loc('TASKS_V2_DATE_PLAN_END')"\n\t\t\t\t\t\t:design="inputDesign"\n\t\t\t\t\t\t:icon="Outline.CALENDAR_WITH_SLOTS"\n\t\t\t\t\t\t:withClear="Boolean(endTs)"\n\t\t\t\t\t\t:active="isPickerShown && isEndPicker"\n\t\t\t\t\t\t@clear="clearEnd"\n\t\t\t\t\t\t@click="handleDateClick($event, { isEnd: true })"\n\t\t\t\t\t\t@focus="$event.target.blur()"\n\t\t\t\t\t/>\n\t\t\t\t\t<div class="tasks-field-date-plan-duration">\n\t\t\t\t\t\t<BInput\n\t\t\t\t\t\t\tv-model="durationValue"\n\t\t\t\t\t\t\t:label="loc('TASKS_V2_DATE_PLAN_DURATION')"\n\t\t\t\t\t\t\t:design="inputDesign"\n\t\t\t\t\t\t\t:error="maxDurationReached ? ' ' : null"\n\t\t\t\t\t\t\t@input="updateRangeFromDuration"\n\t\t\t\t\t\t\t@focus="isEndDuration = !task.startPlanTs"\n\t\t\t\t\t\t\t@blur="isEndDuration = false"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<BInput\n\t\t\t\t\t\t\t:modelValue="units[unitId].title"\n\t\t\t\t\t\t\t:design="inputDesign"\n\t\t\t\t\t\t\t:dropdown="true"\n\t\t\t\t\t\t\t:active="isMenuShown"\n\t\t\t\t\t\t\tref="unit"\n\t\t\t\t\t\t\t@click="isMenuShown = true"\n\t\t\t\t\t\t\t@focus="$event.target.blur()"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-field-date-plan-switchers">\n\t\t\t\t\t<DatePlanSwitcher\n\t\t\t\t\t\tv-if="task.rights.edit"\n\t\t\t\t\t\tv-model="allowsChangeDatePlan"\n\t\t\t\t\t\t:text="loc('TASKS_V2_DATE_PLAN_ALLOW_CHANGE')"\n\t\t\t\t\t/>\n\t\t\t\t\t<DatePlanSwitcher\n\t\t\t\t\t\tv-model="matchesWorkTime"\n\t\t\t\t\t\t:text="loc('TASKS_V2_DATE_PLAN_MATCH_WORK_TIME')"\n\t\t\t\t\t\t:hint="loc('TASKS_V2_DATE_PLAN_MATCH_WORK_TIME_HINT')"\n\t\t\t\t\t/>\n\t\t\t\t\t<DatePlanSwitcher\n\t\t\t\t\t\tv-model="matchesSubTasksTime"\n\t\t\t\t\t\t:text="loc('TASKS_V2_DATE_PLAN_MATCH_SUBTASKS_TIME')"\n\t\t\t\t\t\t:hint="loc('TASKS_V2_DATE_PLAN_MATCH_SUBTASKS_TIME_HINT')"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-field-date-plan-footer">\n\t\t\t\t\t<UiButton\n\t\t\t\t\t\t:text="loc('TASKS_V2_DATE_PLAN_BUTTON_SAVE')"\n\t\t\t\t\t\t:size="ButtonSize.MEDIUM"\n\t\t\t\t\t\t:color="ButtonColor.PRIMARY"\n\t\t\t\t\t\t@click="close"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</BottomSheet>\n\t\t<BMenu v-if="isMenuShown" :options="menuOptions()" @close="isMenuShown = false"/>\n\t`};t.DatePlan=C;t.DatePlanChip=w;t.DatePlanSheet=y;t.datePlanMeta=V})(this.BX.Tasks.V2.Component.Fields=this.BX.Tasks.V2.Component.Fields||{},BX.Tasks.V2.Component.Elements,BX.Tasks.V2.Component.Elements,BX.Tasks.V2.Component.Elements,BX.UI.System.Chip.Vue,BX.UI.IconSet,BX,BX.Main,BX.UI.DatePicker,BX.Vue3.Vuex,BX.Vue3.Components,BX.UI.System.Input.Vue,BX.UI.Vue3.Components,BX.UI.IconSet,BX,BX.Tasks.V2.Const,BX.Tasks.V2.Component.Elements,BX.Tasks.V2.Lib,BX.Tasks.V2.Lib,BX.Tasks.V2.Lib,BX.Tasks.V2.Provider.Service,BX.UI.System.Typography.Vue,BX.UI,BX.UI.Vue3.Components,BX.Vue3.Directives,BX.Tasks.V2.Component.Elements);
//# sourceMappingURL=date-plan.bundle.map.js