this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};this.BX.Tasks.V2.Provider=this.BX.Tasks.V2.Provider||{};(function(e,s,t,a,i,r){"use strict";const l=a.Limit.RelationList;var o=babelHelpers.classPrivateFieldLooseKey("meta");var d=babelHelpers.classPrivateFieldLooseKey("addPromises");var c=babelHelpers.classPrivateFieldLooseKey("requestTasks");var n=babelHelpers.classPrivateFieldLooseKey("getVisibleIds");var v=babelHelpers.classPrivateFieldLooseKey("updateStoreRelationTasks");class b{constructor(e){Object.defineProperty(this,v,{value:h});Object.defineProperty(this,n,{value:S});Object.defineProperty(this,c,{value:k});Object.defineProperty(this,o,{writable:true,value:void 0});Object.defineProperty(this,d,{writable:true,value:[]});babelHelpers.classPrivateFieldLooseBase(this,o)[o]=e}async list(e,s=false){await Promise.all(babelHelpers.classPrivateFieldLooseBase(this,d)[d]);const{tasks:i,ids:l}=await babelHelpers.classPrivateFieldLooseBase(this,c)[c](e,s);if(s){babelHelpers.classPrivateFieldLooseBase(this,v)[v](e,l)}i.forEach((s=>{if(!r.taskService.hasStoreTask(s.id)){r.taskService.extractTask({...s,[babelHelpers.classPrivateFieldLooseBase(this,o)[o].relationToField]:e});void t.Core.getStore().dispatch(`${a.Model.Tasks}/addPartiallyLoaded`,s.id)}}))}async setParent(e,s){return this.add(s,[e])}async add(e,s){this.addStore(e,s);if(!r.taskService.isRealId(e)||s.length===0){return null}try{const t=i.apiClient.post(`${babelHelpers.classPrivateFieldLooseBase(this,o)[o].controller}.add`,{taskId:e,taskIds:s});babelHelpers.classPrivateFieldLooseBase(this,d)[d].push(t);await t;babelHelpers.classPrivateFieldLooseBase(this,d)[d]=babelHelpers.classPrivateFieldLooseBase(this,d)[d].filter((e=>e!==t))}catch(s){var t,a;const i=Object.entries(s.data).filter((([,e])=>!e)).map((([e])=>Number(e)));this.deleteStore(e,i);console.error(`${babelHelpers.classPrivateFieldLooseBase(this,o)[o].controller}.add error`,s);return(t=s.errors)==null?void 0:(a=t[0])==null?void 0:a.message}return null}addStore(e,s){const t=babelHelpers.classPrivateFieldLooseBase(this,o)[o];const a=r.taskService.getStoreTask(e);babelHelpers.classPrivateFieldLooseBase(this,v)[v](e,[...(a==null?void 0:a[t.idsField])||[],...s]);s.forEach((s=>r.taskService.updateStoreTask(s,{[t.relationToField]:e})))}async delete(e,s){this.deleteStore(e,s);if(!r.taskService.isRealId(e)||s.length===0){return}try{await i.apiClient.post(`${babelHelpers.classPrivateFieldLooseBase(this,o)[o].controller}.delete`,{taskId:e,taskIds:s})}catch(t){this.addStore(e,s);console.error(`${babelHelpers.classPrivateFieldLooseBase(this,o)[o].controller}.delete error`,t)}}deleteStore(e,s){const t=babelHelpers.classPrivateFieldLooseBase(this,o)[o];const a=r.taskService.getStoreTask(e);babelHelpers.classPrivateFieldLooseBase(this,v)[v](e,a==null?void 0:a[t.idsField].filter((e=>!s.includes(e))));s.forEach((e=>r.taskService.updateStoreTask(e,{[t.relationToField]:0})))}areIdsLoaded(e){const s=babelHelpers.classPrivateFieldLooseBase(this,o)[o];const t=r.taskService.getStoreTask(e);if(!t||!r.taskService.isRealId(e)){return false}return!t[s.containsField]||t[s.containsField]&&t[s.idsField].length>0}hasUnloadedIds(e){const s=r.taskService.getStoreTask(e)[babelHelpers.classPrivateFieldLooseBase(this,o)[o].idsField];return babelHelpers.classPrivateFieldLooseBase(this,n)[n](s).some((e=>!r.taskService.hasStoreTask(e)))}}async function k(e,s=false){if(!r.taskService.isRealId(e)){const s=r.taskService.getStoreTask(e)[babelHelpers.classPrivateFieldLooseBase(this,o)[o].idsField];const{tasks:t}=await i.apiClient.post(`${babelHelpers.classPrivateFieldLooseBase(this,o)[o].controller}.listByIds`,{taskIds:babelHelpers.classPrivateFieldLooseBase(this,n)[n](s)});return{tasks:t,ids:s}}const{tasks:t,ids:a}=await i.apiClient.post(`${babelHelpers.classPrivateFieldLooseBase(this,o)[o].controller}.list`,{taskId:e,relationTaskSelect:["id","title","creator","responsible","deadline","rights"],withIds:s,navigation:{size:l}});return{tasks:t,ids:a}}function S(e){return[...e].sort(((e,s)=>s-e)).slice(0,l)}function h(e,s){const t=babelHelpers.classPrivateFieldLooseBase(this,o)[o];const a=[...new Set(s)];const i=a.length>0;void r.taskService.updateStoreTask(e,{[t.idsField]:a,[t.containsField]:i})}class T extends b{async setParent(e,t){var a;if(t===e){return s.Loc.getMessage("TASKS_V2_RELATION_PARENT_CANNOT_BE_PARENT")}if((a=r.taskService.getStoreTask(e))!=null&&a.subTaskIds.includes(t)){return s.Loc.getMessage("TASKS_V2_RELATION_SUB_TASK_CANNOT_BE_PARENT")}if(!r.taskService.isRealId(e)){return this.addStore(t,[e])}const i=r.taskService.getStoreTask(e).parentId;const l=await this.add(t,[e]);if(l){this.addStore(i,[e])}return l}async add(e,t){var a,i;let l=null;if(t.includes(e)){var o;(o=l)!=null?o:l=s.Loc.getMessage("TASKS_V2_RELATION_SELF_CANNOT_BE_SUB_TASK")}const d=(a=r.taskService.getStoreTask(e))==null?void 0:a.parentId;if(t.includes(d)){var c;(c=l)!=null?c:l=s.Loc.getMessage("TASKS_V2_RELATION_PARENT_CANNOT_BE_SUB_TASK")}(i=l)!=null?i:l=super.add(e,t.filter((s=>s!==e&&s!==d)));return l}addStore(e,s){s.forEach((e=>{var s;return this.deleteStore((s=r.taskService.getStoreTask(e))==null?void 0:s.parentId,[e])}));super.addStore(e,s)}}const u=Object.freeze({idsField:"subTaskIds",containsField:"containsSubTasks",relationToField:"parentId",controller:"Task.Relation.Child"});const p=Object.freeze({idsField:"relatedTaskIds",containsField:"containsRelatedTasks",relationToField:"relatedToTaskId",controller:"Task.Relation.Related"});const F=new T(u);const P=new b(p);e.subTasksService=F;e.relatedTasksService=P})(this.BX.Tasks.V2.Provider.Service=this.BX.Tasks.V2.Provider.Service||{},BX,BX.Tasks.V2,BX.Tasks.V2.Const,BX.Tasks.V2.Lib,BX.Tasks.V2.Provider.Service);
//# sourceMappingURL=relation-service.bundle.map.js