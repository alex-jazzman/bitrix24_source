this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};this.BX.Tasks.V2.Provider=this.BX.Tasks.V2.Provider||{};(function(e,s,a,t,l,r,i,o,d,n,c){"use strict";class u{constructor(){if(new.target===u){throw new TypeError("BasePullHandler: An abstract class cannot be instantiated")}}getMap(){return{}}getDelayedMap(){return{}}}function b({AFTER:e,TASK_ID:s}){var a,t;const l={id:s,title:P(e.TITLE),isImportant:P(e.PRIORITY,e.PRIORITY===2),creatorId:P(e.CREATED_BY),responsibleId:P(e.RESPONSIBLE_ID),deadlineTs:P(e.DEADLINE,e.DEADLINE*1e3),checklist:undefined,groupId:P(e.GROUP_ID),stageId:P(e.STAGE,(a=(t=e.STAGE_INFO)==null?void 0:t.id)!=null?a:0),flowId:P(e.FLOW_ID),status:P(e.STATUS,v(e.STATUS)),statusChangedTs:P(e.STATUS,Date.now()),accomplicesIds:P(e.ACCOMPLICES,p(e.ACCOMPLICES)),auditorsIds:P(e.AUDITORS,p(e.AUDITORS)),parentId:P(e.PARENT_ID,Number(e.PARENT_ID)||0),tags:P(e.TAGS,e.TAGS?e.TAGS.split(","):[])};return Object.fromEntries(Object.entries(l).filter((([,e])=>!n.Type.isUndefined(e))))}function v(e){var s;return(s={2:c.TaskStatus.Pending,3:c.TaskStatus.InProgress,4:c.TaskStatus.SupposedlyCompleted,5:c.TaskStatus.Completed,6:c.TaskStatus.Deferred}[e])!=null?s:c.TaskStatus.Pending}function p(e){if(!e){return[]}return e.split(",").map((e=>Number(e)))}function P(e,s=e){return n.Type.isUndefined(e)?undefined:s}var f=babelHelpers.classPrivateFieldLooseKey("handleTaskAdded");var h=babelHelpers.classPrivateFieldLooseKey("handleTaskUpdated");var T=babelHelpers.classPrivateFieldLooseKey("handleTaskUpdatedDelayed");var F=babelHelpers.classPrivateFieldLooseKey("handleTaskViewed");var y=babelHelpers.classPrivateFieldLooseKey("handleTaskDeleted");var L=babelHelpers.classPrivateFieldLooseKey("handleDefaultDeadlineChanged");var I=babelHelpers.classPrivateFieldLooseKey("upsertStage");var B=babelHelpers.classPrivateFieldLooseKey("loadTask");var S=babelHelpers.classPrivateFieldLooseKey("needToLoadTask");var H=babelHelpers.classPrivateFieldLooseKey("loadGroup");var g=babelHelpers.classPrivateFieldLooseKey("needToLoadGroup");var E=babelHelpers.classPrivateFieldLooseKey("loadFlow");var O=babelHelpers.classPrivateFieldLooseKey("needToLoadFlow");var D=babelHelpers.classPrivateFieldLooseKey("loadUsers");var k=babelHelpers.classPrivateFieldLooseKey("needToLoadUsers");var m=babelHelpers.classPrivateFieldLooseKey("getUsersIds");var A=babelHelpers.classPrivateFieldLooseKey("loadRights");var K=babelHelpers.classPrivateFieldLooseKey("currentUserId");class w extends u{constructor(...e){super(...e);Object.defineProperty(this,K,{get:x,set:void 0});Object.defineProperty(this,A,{value:G});Object.defineProperty(this,m,{value:$});Object.defineProperty(this,k,{value:N});Object.defineProperty(this,D,{value:V});Object.defineProperty(this,O,{value:C});Object.defineProperty(this,E,{value:U});Object.defineProperty(this,g,{value:X});Object.defineProperty(this,H,{value:M});Object.defineProperty(this,S,{value:j});Object.defineProperty(this,B,{value:R});Object.defineProperty(this,I,{value:_});Object.defineProperty(this,f,{writable:true,value:e=>{const s=t.Core.getParams().features;const a=e.AFTER.USER_ID===babelHelpers.classPrivateFieldLooseBase(this,K)[K]&&s.isMiniformEnabled&&!s.isV2Enabled;if(a){var l;const s=(l=e.AFTER.URL)!=null?l:"";BX.UI.Notification.Center.notify({id:n.Text.getRandom(),content:n.Loc.getMessage("TASKS_V2_NOTIFY_TASK_CREATED"),actions:[{title:n.Loc.getMessage("TASKS_V2_NOTIFY_TASK_DO_VIEW"),events:{click:(e,a)=>{a.close();BX.SidePanel.Instance.open(s)}}}]})}}});Object.defineProperty(this,h,{writable:true,value:e=>{babelHelpers.classPrivateFieldLooseBase(this,I)[I](e.AFTER.STAGE_INFO);const s=b(e);if(e.BEFORE.PARENT_ID){r.subTasksService.deleteStore(e.BEFORE.PARENT_ID,[s.id])}if(s.parentId){r.subTasksService.addStore(s.parentId,[s.id])}}});Object.defineProperty(this,T,{writable:true,value:async e=>{const s=b(e);if(babelHelpers.classPrivateFieldLooseBase(this,S)[S](e)){void babelHelpers.classPrivateFieldLooseBase(this,B)[B](s)}else{await Promise.all([babelHelpers.classPrivateFieldLooseBase(this,H)[H](s),babelHelpers.classPrivateFieldLooseBase(this,E)[E](s),babelHelpers.classPrivateFieldLooseBase(this,D)[D](s),babelHelpers.classPrivateFieldLooseBase(this,A)[A](s)]);const{id:e,...a}=s;void this.$store.dispatch(`${c.Model.Tasks}/update`,{id:e,fields:a})}}});Object.defineProperty(this,F,{writable:true,value:e=>{}});Object.defineProperty(this,y,{writable:true,value:e=>{r.subTasksService.deleteStore(e.BEFORE.PARENT_ID,[e.TASK_ID]);a.EventEmitter.emit(c.EventName.CloseFullCard,{taskId:e.TASK_ID});void this.$store.dispatch(`${c.Model.Tasks}/delete`,e.TASK_ID)}});Object.defineProperty(this,L,{writable:true,value:e=>{void this.$store.dispatch(`${c.Model.Interface}/updateDefaultDeadline`,{defaultDeadlineDate:e.defaultDeadlineDate,defaultDeadlineInSeconds:e.deadline})}})}getMap(){return{task_add:babelHelpers.classPrivateFieldLooseBase(this,f)[f],task_update:babelHelpers.classPrivateFieldLooseBase(this,h)[h],task_view:babelHelpers.classPrivateFieldLooseBase(this,F)[F],task_remove:babelHelpers.classPrivateFieldLooseBase(this,y)[y],default_deadline_changed:babelHelpers.classPrivateFieldLooseBase(this,L)[L]}}getDelayedMap(){return{task_update:babelHelpers.classPrivateFieldLooseBase(this,T)[T]}}get $store(){return t.Core.getStore()}}function _(e){if(e){const s=i.GroupMappers.mapStageDtoToModel(e);void this.$store.dispatch(`${c.Model.Stages}/upsert`,s)}}function R(e){void l.taskService.getById(e.id)}function j(e){const s=new Set(["DESCRIPTION","UF_TASK_WEBDAV_FILES"]);return Object.keys(e.AFTER).some((e=>s.has(e)))}async function M(e){if(babelHelpers.classPrivateFieldLooseBase(this,g)[g](e)){await i.groupService.getGroup(e.groupId)}}function X(e){if(babelHelpers.classPrivateFieldLooseBase(this,O)[O](e)){return false}return e.groupId&&!this.$store.getters[`${c.Model.Groups}/getById`](e.groupId)}async function U(e){if(babelHelpers.classPrivateFieldLooseBase(this,O)[O](e)){await o.flowService.getFlow(e.flowId)}}function C(e){return Boolean(e.flowId)&&!this.$store.getters[`${c.Model.Flows}/getById`](e.flowId)}async function V(e){if(babelHelpers.classPrivateFieldLooseBase(this,k)[k](e)){await d.userService.list(babelHelpers.classPrivateFieldLooseBase(this,m)[m](e))}}function N(e){return!d.userService.hasUsers(babelHelpers.classPrivateFieldLooseBase(this,m)[m](e))}function $(e){var s,a;return[e.creatorId,e.responsibleId,...(s=e.accomplicesIds)!=null?s:[],...(a=e.auditorsIds)!=null?a:[]].filter((e=>e))}async function G(e){await l.taskService.getRights(e.id)}function x(){return this.$store.getters[`${c.Model.Interface}/currentUserId`]}var Q=babelHelpers.classPrivateFieldLooseKey("params");var Y=babelHelpers.classPrivateFieldLooseKey("loadItemsDelay");var W=babelHelpers.classPrivateFieldLooseKey("handlers");var q=babelHelpers.classPrivateFieldLooseKey("onBeforePull");var z=babelHelpers.classPrivateFieldLooseKey("onPull");var J=babelHelpers.classPrivateFieldLooseKey("onBeforeQueueExecute");var Z=babelHelpers.classPrivateFieldLooseKey("onQueueExecute");var ee=babelHelpers.classPrivateFieldLooseKey("onReload");var se=babelHelpers.classPrivateFieldLooseKey("executeQueue");class ae{constructor(e){Object.defineProperty(this,se,{value:de});Object.defineProperty(this,ee,{value:oe});Object.defineProperty(this,Z,{value:ie});Object.defineProperty(this,J,{value:re});Object.defineProperty(this,z,{value:le});Object.defineProperty(this,q,{value:te});Object.defineProperty(this,Q,{writable:true,value:void 0});Object.defineProperty(this,Y,{writable:true,value:500});Object.defineProperty(this,W,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,Q)[Q]=e;babelHelpers.classPrivateFieldLooseBase(this,W)[W]=new Set([new w])}initQueueManager(){return new s.QueueManager({moduleId:c.Module.Tasks,userId:babelHelpers.classPrivateFieldLooseBase(this,Q)[Q].currentUserId,config:{loadItemsDelay:babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]},additionalData:{},events:{onBeforePull:e=>{babelHelpers.classPrivateFieldLooseBase(this,q)[q](e)},onPull:e=>{babelHelpers.classPrivateFieldLooseBase(this,z)[z](e)}},callbacks:{onBeforeQueueExecute:e=>babelHelpers.classPrivateFieldLooseBase(this,J)[J](e),onQueueExecute:e=>babelHelpers.classPrivateFieldLooseBase(this,Z)[Z](e),onReload:()=>{babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]()}}})}}function te(e){const{pullData:{command:s,params:a}}=e.data;for(const e of babelHelpers.classPrivateFieldLooseBase(this,W)[W]){var t,l;(t=(l=e.getMap())[s])==null?void 0:t.call(l,a)}}function le(e){const{pullData:{command:s,params:a},promises:t}=e.data;for(const e of babelHelpers.classPrivateFieldLooseBase(this,W)[W]){if(e.getDelayedMap()[s]){var l;t.push(Promise.resolve({data:{id:(l=a.entityId)!=null?l:n.Text.getRandom(),command:s,params:a}}))}}}function re(e){return Promise.resolve()}async function ie(e){await babelHelpers.classPrivateFieldLooseBase(this,se)[se](e)}function oe(e){}function de(e){return new Promise((s=>{e.forEach((e=>{const{data:{command:s,params:a}}=e;for(const e of babelHelpers.classPrivateFieldLooseBase(this,W)[W]){var t,l;(t=(l=e.getDelayedMap())[s])==null?void 0:t.call(l,a)}}));s()}))}e.PullManager=ae})(this.BX.Tasks.V2.Provider.Pull=this.BX.Tasks.V2.Provider.Pull||{},BX.Pull,BX.Event,BX.Tasks.V2,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX,BX.Tasks.V2.Const);
//# sourceMappingURL=pull-manager.bundle.map.js