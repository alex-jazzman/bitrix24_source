this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};this.BX.Tasks.V2.Provider=this.BX.Tasks.V2.Provider||{};(function(e,s,i,a,t,l,r,o,d,b,c){"use strict";function v(e){return{serverFileId:e.id,serverId:e.serverId,type:e.type,name:e.name,size:e.size,width:e.width,height:e.height,isImage:e.isImage,isVideo:e.isVideo,treatImageAsFile:e.treatImageAsFile,downloadUrl:e.downloadUrl,serverPreviewUrl:e.serverPreviewUrl,serverPreviewWidth:e.serverPreviewWidth,serverPreviewHeight:e.serverPreviewHeight,customData:e.customData,viewerAttrs:e.viewerAttrs}}const n=e=>{if(!Array.isArray(e)){return[]}return e.reduce(((e,s)=>{if(c.Type.isObjectLike(s)&&"id"in s&&"fileId"in s){e.push({id:s.id,fileId:s.fileId})}else if(c.Type.isString(s)&&s.startsWith("n")){e.push({id:s,fileId:s})}return e}),[])};const p=Object.freeze({Task:"task",CheckListItem:"checkListItem"});var h=babelHelpers.classPrivateFieldLooseKey("entityId");var F=babelHelpers.classPrivateFieldLooseKey("entityType");var P=babelHelpers.classPrivateFieldLooseKey("options");var u=babelHelpers.classPrivateFieldLooseKey("menu");var L=babelHelpers.classPrivateFieldLooseKey("loadedIds");var H=babelHelpers.classPrivateFieldLooseKey("objectsIds");var B=babelHelpers.classPrivateFieldLooseKey("promises");var f=babelHelpers.classPrivateFieldLooseKey("adapter");var y=babelHelpers.classPrivateFieldLooseKey("fileBrowserClosed");var m=babelHelpers.classPrivateFieldLooseKey("filesToAttach");var I=babelHelpers.classPrivateFieldLooseKey("filesToDetach");var w=babelHelpers.classPrivateFieldLooseKey("isDetachedErrorMode");var g=babelHelpers.classPrivateFieldLooseKey("saveAttachedFilesDebounced");var k=babelHelpers.classPrivateFieldLooseKey("saveDetachedFilesDebounced");var O=babelHelpers.classPrivateFieldLooseKey("browseElement");var T=babelHelpers.classPrivateFieldLooseKey("addLoadedIds");var j=babelHelpers.classPrivateFieldLooseKey("addLoadedObjectsIds");var A=babelHelpers.classPrivateFieldLooseKey("removeLoadedObjectsIds");var C=babelHelpers.classPrivateFieldLooseKey("getIdsByObjectId");var E=babelHelpers.classPrivateFieldLooseKey("attachFiles");var K=babelHelpers.classPrivateFieldLooseKey("detachFiles");var S=babelHelpers.classPrivateFieldLooseKey("getEntityFileIds");var D=babelHelpers.classPrivateFieldLooseKey("processCheckListFileIds");var U=babelHelpers.classPrivateFieldLooseKey("isRealId");var X=babelHelpers.classPrivateFieldLooseKey("isNewFile");var V=babelHelpers.classPrivateFieldLooseKey("saveAttachedFiles");var R=babelHelpers.classPrivateFieldLooseKey("saveDetachedFiles");var $=babelHelpers.classPrivateFieldLooseKey("entityFileIds");class _ extends s.EventEmitter{constructor(e,s=p.Task,i={}){super();Object.defineProperty(this,$,{get:se,set:void 0});Object.defineProperty(this,R,{value:ee});Object.defineProperty(this,V,{value:Z});Object.defineProperty(this,X,{value:J});Object.defineProperty(this,U,{value:q});Object.defineProperty(this,D,{value:Q});Object.defineProperty(this,S,{value:Y});Object.defineProperty(this,K,{value:G});Object.defineProperty(this,E,{value:x});Object.defineProperty(this,C,{value:z});Object.defineProperty(this,A,{value:W});Object.defineProperty(this,j,{value:N});Object.defineProperty(this,T,{value:M});Object.defineProperty(this,h,{writable:true,value:void 0});Object.defineProperty(this,F,{writable:true,value:void 0});Object.defineProperty(this,P,{writable:true,value:void 0});Object.defineProperty(this,u,{writable:true,value:void 0});Object.defineProperty(this,L,{writable:true,value:new Set});Object.defineProperty(this,H,{writable:true,value:{}});Object.defineProperty(this,B,{writable:true,value:[]});Object.defineProperty(this,f,{writable:true,value:void 0});Object.defineProperty(this,y,{writable:true,value:false});Object.defineProperty(this,m,{writable:true,value:[]});Object.defineProperty(this,I,{writable:true,value:[]});Object.defineProperty(this,w,{writable:true,value:false});Object.defineProperty(this,g,{writable:true,value:void 0});Object.defineProperty(this,k,{writable:true,value:void 0});Object.defineProperty(this,O,{writable:true,value:void 0});this.setEventNamespace("Tasks.V2.Provider.Service.FileService");this.setEntityId(e,s);this.initAdapter(e,s);babelHelpers.classPrivateFieldLooseBase(this,P)[P]=i;babelHelpers.classPrivateFieldLooseBase(this,g)[g]=c.Runtime.debounce(babelHelpers.classPrivateFieldLooseBase(this,V)[V],3e3,this);babelHelpers.classPrivateFieldLooseBase(this,k)[k]=c.Runtime.debounce(babelHelpers.classPrivateFieldLooseBase(this,R)[R],3e3,this)}initAdapter(e,s){babelHelpers.classPrivateFieldLooseBase(this,f)[f]=new a.VueUploaderAdapter({id:ae(e,s),controller:"disk.uf.integration.diskUploaderController",imagePreviewHeight:1200,imagePreviewWidth:1200,imagePreviewQuality:.85,ignoreUnknownImageTypes:true,treatOversizeImageAsFile:true,multiple:true,maxFileSize:null});babelHelpers.classPrivateFieldLooseBase(this,f)[f].subscribeFromOptions({"Item:onAdd":e=>{const{item:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,T)[T]([s.serverFileId]);this.emit("onFileAdd")},"Item:onComplete":e=>{const{item:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,j)[j]([s]);const i=new Set(babelHelpers.classPrivateFieldLooseBase(this,$)[$]);if(!babelHelpers.classPrivateFieldLooseBase(this,C)[C](s.customData.objectId).some((e=>i.has(e)))){babelHelpers.classPrivateFieldLooseBase(this,E)[E]([...i,s.serverFileId],s)}this.emit("onFileComplete",s)},"Item:onRemove":e=>{const{item:s}=e.getData();const i=new Set(babelHelpers.classPrivateFieldLooseBase(this,C)[C](s.customData.objectId));babelHelpers.classPrivateFieldLooseBase(this,A)[A](i);babelHelpers.classPrivateFieldLooseBase(this,K)[K](babelHelpers.classPrivateFieldLooseBase(this,S)[S](i),s);this.emit("onFileRemove",{file:s})}})}setEntityId(e,s=p.Task){babelHelpers.classPrivateFieldLooseBase(this,h)[h]=e;babelHelpers.classPrivateFieldLooseBase(this,F)[F]=s}getEntityId(){return babelHelpers.classPrivateFieldLooseBase(this,h)[h]}getAdapter(){return babelHelpers.classPrivateFieldLooseBase(this,f)[f]}getFiles(){return babelHelpers.classPrivateFieldLooseBase(this,f)[f].getReactiveItems()}isUploading(){return babelHelpers.classPrivateFieldLooseBase(this,f)[f].getItems().some((({status:e})=>[i.FileStatus.UPLOADING,i.FileStatus.LOADING].includes(e)))}hasUploadingError(){return babelHelpers.classPrivateFieldLooseBase(this,f)[f].getItems().some((({status:e})=>[i.FileStatus.UPLOAD_FAILED,i.FileStatus.LOAD_FAILED].includes(e)))}browse(e){babelHelpers.classPrivateFieldLooseBase(this,u)[u]=new r.UserFieldMenu({dialogId:"task-card",uploader:babelHelpers.classPrivateFieldLooseBase(this,f)[f].getUploader(),compact:e.compact||false,menuOptions:{minWidth:220,animation:"fading",closeByEsc:true,bindOptions:{forceBindPosition:true,forceTop:true,position:"top"},events:{onPopupClose:()=>{e.onHideCallback==null?void 0:e.onHideCallback()},onPopupShow:()=>{e.onShowCallback==null?void 0:e.onShowCallback()}}}});babelHelpers.classPrivateFieldLooseBase(this,u)[u].show(e.bindElement)}browseFiles(){if(!babelHelpers.classPrivateFieldLooseBase(this,O)[O]){babelHelpers.classPrivateFieldLooseBase(this,O)[O]=document.createElement("div");babelHelpers.classPrivateFieldLooseBase(this,f)[f].getUploader().assignBrowse(babelHelpers.classPrivateFieldLooseBase(this,O)[O])}babelHelpers.classPrivateFieldLooseBase(this,O)[O].click()}browseMyDrive(){r.openDiskFileDialog({dialogId:"task-card",uploader:babelHelpers.classPrivateFieldLooseBase(this,f)[f].getUploader()})}setFileBrowserClosed(e){babelHelpers.classPrivateFieldLooseBase(this,y)[y]=e;this.emit("onFileBrowserClosed")}isFileBrowserClosed(){return babelHelpers.classPrivateFieldLooseBase(this,y)[y]}resetFileBrowserClosedState(){babelHelpers.classPrivateFieldLooseBase(this,y)[y]=false}destroy(){babelHelpers.classPrivateFieldLooseBase(this,f)[f].unsubscribeAll("Item:onAdd");babelHelpers.classPrivateFieldLooseBase(this,f)[f].unsubscribeAll("Item:onComplete");babelHelpers.classPrivateFieldLooseBase(this,f)[f].unsubscribeAll("Item:onRemove");babelHelpers.classPrivateFieldLooseBase(this,f)[f].getUploader().destroy()}async sync(e){if(e.every((e=>babelHelpers.classPrivateFieldLooseBase(this,L)[L].has(e)))){babelHelpers.classPrivateFieldLooseBase(this,f)[f].getItems().forEach((s=>{const i=[s.serverFileId];if(babelHelpers.classPrivateFieldLooseBase(this,X)[X](s.serverFileId)){const e=Number(s.serverFileId.slice(1));i.push(...babelHelpers.classPrivateFieldLooseBase(this,C)[C](e))}if(i.some((s=>e.includes(s)))){return}babelHelpers.classPrivateFieldLooseBase(this,f)[f].getUploader().removeFile(s.id)}))}await this.list(e)}async list(e){const s=e.filter((e=>!babelHelpers.classPrivateFieldLooseBase(this,X)[X](e)&&!babelHelpers.classPrivateFieldLooseBase(this,L)[L].has(e)));if(s.length===0){await Promise.all(babelHelpers.classPrivateFieldLooseBase(this,B)[B]);return babelHelpers.classPrivateFieldLooseBase(this,f)[f].getItems()}const i=new le;babelHelpers.classPrivateFieldLooseBase(this,B)[B].push(i);babelHelpers.classPrivateFieldLooseBase(this,T)[T](s);try{let e=[];if(babelHelpers.classPrivateFieldLooseBase(this,F)[F]===p.Task){e=await b.apiClient.post("File.list",{taskId:babelHelpers.classPrivateFieldLooseBase(this,h)[h],ids:s})}else if(babelHelpers.classPrivateFieldLooseBase(this,F)[F]===p.CheckListItem){e=await b.apiClient.post("Task.CheckList.File.list",{taskId:babelHelpers.classPrivateFieldLooseBase(this,P)[P].parentEntityId,ids:s})}const a=e.map((e=>v(e)));const t=new Set(Object.values(babelHelpers.classPrivateFieldLooseBase(this,H)[H]));const l=a.filter((({customData:e})=>!t.has(e.objectId)));babelHelpers.classPrivateFieldLooseBase(this,f)[f].getUploader().addFiles(l);babelHelpers.classPrivateFieldLooseBase(this,j)[j](a);i.resolve();await Promise.all(babelHelpers.classPrivateFieldLooseBase(this,B)[B]);return babelHelpers.classPrivateFieldLooseBase(this,f)[f].getItems()}catch(e){console.error("FileService: list error",e);return[]}}notifyError(e){l.UI.Notification.Center.notify({content:e,id:`file-service-error-${c.Text.getRandom()}`})}get $store(){return d.Core.getStore()}}function M(e){e.forEach((e=>babelHelpers.classPrivateFieldLooseBase(this,L)[L].add(e)))}function N(e){e.forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,H)[H][e.serverFileId]=e.customData.objectId}))}function W(e){e.forEach((e=>{delete babelHelpers.classPrivateFieldLooseBase(this,H)[H][e]}))}function z(e){return Object.entries(babelHelpers.classPrivateFieldLooseBase(this,H)[H]).filter((([,s])=>s===e)).map((([e])=>babelHelpers.classPrivateFieldLooseBase(this,X)[X](e)?e:Number(e)))}function x(e,s){if(babelHelpers.classPrivateFieldLooseBase(this,F)[F]===p.Task){const i=babelHelpers.classPrivateFieldLooseBase(this,h)[h];void this.$store.dispatch(`${o.Model.Tasks}/update`,{id:i,fields:{fileIds:e}});if(babelHelpers.classPrivateFieldLooseBase(this,w)[w]){return}if(babelHelpers.classPrivateFieldLooseBase(this,U)[U](i)&&babelHelpers.classPrivateFieldLooseBase(this,X)[X](s.serverFileId)){babelHelpers.classPrivateFieldLooseBase(this,m)[m].push(s);babelHelpers.classPrivateFieldLooseBase(this,g)[g]()}}else if(babelHelpers.classPrivateFieldLooseBase(this,F)[F]===p.CheckListItem){babelHelpers.classPrivateFieldLooseBase(this,D)[D](e)}}function G(e,s){if(babelHelpers.classPrivateFieldLooseBase(this,F)[F]===p.Task){const i=babelHelpers.classPrivateFieldLooseBase(this,h)[h];void this.$store.dispatch(`${o.Model.Tasks}/update`,{id:i,fields:{fileIds:e}});if(babelHelpers.classPrivateFieldLooseBase(this,U)[U](i)){const e=s.serverFileId;const i=babelHelpers.classPrivateFieldLooseBase(this,m)[m].findIndex((s=>s.serverFileId===e));if(i===-1){babelHelpers.classPrivateFieldLooseBase(this,I)[I].push(s);babelHelpers.classPrivateFieldLooseBase(this,k)[k]()}else{babelHelpers.classPrivateFieldLooseBase(this,m)[m].splice(i,1)}}}else if(babelHelpers.classPrivateFieldLooseBase(this,F)[F]===p.CheckListItem){babelHelpers.classPrivateFieldLooseBase(this,D)[D](e)}}function Y(e=new Set){if(babelHelpers.classPrivateFieldLooseBase(this,F)[F]===p.Task){return babelHelpers.classPrivateFieldLooseBase(this,$)[$].filter((s=>!e.has(s)))}if(babelHelpers.classPrivateFieldLooseBase(this,F)[F]===p.CheckListItem){return babelHelpers.classPrivateFieldLooseBase(this,$)[$].filter((s=>!e.has(s.id)))}return[]}function Q(e){const s=n(e);void this.$store.dispatch(`${o.Model.CheckList}/update`,{id:babelHelpers.classPrivateFieldLooseBase(this,h)[h],fields:{attachments:s}})}function q(e){return Number.isInteger(e)&&e>0}function J(e){return String(e).startsWith("n")}async function Z(){if(c.Type.isArrayFilled(babelHelpers.classPrivateFieldLooseBase(this,m)[m])){try{const e=babelHelpers.classPrivateFieldLooseBase(this,m)[m].map((e=>e.serverFileId));babelHelpers.classPrivateFieldLooseBase(this,m)[m]=[];void b.apiClient.post("File.attach",{task:{id:babelHelpers.classPrivateFieldLooseBase(this,h)[h]},ids:e})}catch(e){console.error("FileService: saveAttachedFiles error",e);this.notifyError(c.Loc.getMessage("TASKS_V2_NOTIFY_FILE_ATTACH_ERROR"))}}}async function ee(){if(c.Type.isArrayFilled(babelHelpers.classPrivateFieldLooseBase(this,I)[I])){const e=babelHelpers.classPrivateFieldLooseBase(this,I)[I];try{const e=babelHelpers.classPrivateFieldLooseBase(this,I)[I].map((e=>e.serverFileId));babelHelpers.classPrivateFieldLooseBase(this,I)[I]=[];await b.apiClient.post("File.detach",{task:{id:babelHelpers.classPrivateFieldLooseBase(this,h)[h]},ids:e})}catch(s){console.error("FileService: saveDetachedFiles error",s);babelHelpers.classPrivateFieldLooseBase(this,w)[w]=true;babelHelpers.classPrivateFieldLooseBase(this,f)[f].getUploader().addFiles(e);babelHelpers.classPrivateFieldLooseBase(this,w)[w]=false;this.notifyError(c.Loc.getMessage("TASKS_V2_NOTIFY_FILE_DETACH_ERROR"))}}}function se(){if(babelHelpers.classPrivateFieldLooseBase(this,F)[F]===p.Task){return this.$store.getters[`${o.Model.Tasks}/getById`](babelHelpers.classPrivateFieldLooseBase(this,h)[h]).fileIds}return this.$store.getters[`${o.Model.CheckList}/getById`](babelHelpers.classPrivateFieldLooseBase(this,h)[h]).attachments}const ie={};function ae(e,s){return`${s}:${e}`}const te={get(e,s=p.Task,i={}){var a;const t=ae(e,s);(a=ie[t])!=null?a:ie[t]=new _(e,s,i);return ie[t]},replace(e,s,i=p.Task){const a=ae(e,i);const t=ae(s,i);ie[t]=ie[a];ie[t].setEntityId(s,i);delete ie[a]},delete(e,s=p.Task){var i;const a=ae(e,s);(i=ie[a])==null?void 0:i.destroy();delete ie[a]}};function le(){const e=new Promise((e=>{this.resolve=e}));e.resolve=this.resolve;return e}e.fileService=te;e.EntityTypes=p})(this.BX.Tasks.V2.Provider.Service=this.BX.Tasks.V2.Provider.Service||{},BX.Event,BX.UI.Uploader,BX.UI.Uploader,BX.Vue3,BX,BX.Disk.Uploader,BX.Tasks.V2.Const,BX.Tasks.V2,BX.Tasks.V2.Lib,BX);
//# sourceMappingURL=file-service.bundle.map.js