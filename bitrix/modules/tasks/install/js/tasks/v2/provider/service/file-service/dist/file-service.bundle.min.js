this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};this.BX.Tasks.V2.Provider=this.BX.Tasks.V2.Provider||{};(function(e,s,t,i,a,l,r,o,d){"use strict";function c(e){return{serverFileId:e.id,serverId:e.serverId,type:e.type,name:e.name,size:e.size,width:e.width,height:e.height,isImage:e.isImage,isVideo:e.isVideo,treatImageAsFile:e.treatImageAsFile,downloadUrl:e.downloadUrl,serverPreviewUrl:e.serverPreviewUrl,serverPreviewWidth:e.serverPreviewWidth,serverPreviewHeight:e.serverPreviewHeight,customData:e.customData}}const b=e=>{if(!Array.isArray(e)){return[]}return e.reduce(((e,s)=>{if(typeof s==="object"&&s!==null&&"id"in s&&"fileId"in s){e.push({id:s.id,fileId:s.fileId})}else if(typeof s==="string"&&s.startsWith("n")){e.push({id:s,fileId:s})}return e}),[])};const n=Object.freeze({Task:"task",CheckListItem:"checkListItem"});var v=babelHelpers.classPrivateFieldLooseKey("entityId");var p=babelHelpers.classPrivateFieldLooseKey("entityType");var h=babelHelpers.classPrivateFieldLooseKey("menu");var u=babelHelpers.classPrivateFieldLooseKey("loadedIds");var P=babelHelpers.classPrivateFieldLooseKey("objectsIds");var F=babelHelpers.classPrivateFieldLooseKey("promises");var L=babelHelpers.classPrivateFieldLooseKey("adapter");var B=babelHelpers.classPrivateFieldLooseKey("browseElement");var H=babelHelpers.classPrivateFieldLooseKey("addFiles");var m=babelHelpers.classPrivateFieldLooseKey("addLoadedIds");var f=babelHelpers.classPrivateFieldLooseKey("addLoadedObjectsIds");var y=babelHelpers.classPrivateFieldLooseKey("removeLoadedObjectsIds");var I=babelHelpers.classPrivateFieldLooseKey("getIdsByObjectId");var g=babelHelpers.classPrivateFieldLooseKey("updateEntity");var w=babelHelpers.classPrivateFieldLooseKey("entityFileIds");class k extends s.EventEmitter{constructor(e,s=n.Task){super();Object.defineProperty(this,w,{get:X,set:void 0});Object.defineProperty(this,g,{value:D});Object.defineProperty(this,I,{value:E});Object.defineProperty(this,y,{value:U});Object.defineProperty(this,f,{value:T});Object.defineProperty(this,m,{value:O});Object.defineProperty(this,H,{value:j});Object.defineProperty(this,v,{writable:true,value:void 0});Object.defineProperty(this,p,{writable:true,value:void 0});Object.defineProperty(this,h,{writable:true,value:void 0});Object.defineProperty(this,u,{writable:true,value:new Set});Object.defineProperty(this,P,{writable:true,value:{}});Object.defineProperty(this,F,{writable:true,value:[]});Object.defineProperty(this,L,{writable:true,value:void 0});Object.defineProperty(this,B,{writable:true,value:void 0});this.setEventNamespace("Tasks.V2.Provider.Service.FileService");this.setEntityId(e,s);babelHelpers.classPrivateFieldLooseBase(this,L)[L]=new i.VueUploaderAdapter({id:A(e,s),controller:"disk.uf.integration.diskUploaderController",imagePreviewHeight:1200,imagePreviewWidth:1200,imagePreviewQuality:.85,treatOversizeImageAsFile:true,multiple:true,maxFileSize:null});babelHelpers.classPrivateFieldLooseBase(this,L)[L].subscribeFromOptions({"Item:onAdd":e=>{const{item:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,m)[m]([s.serverFileId]);this.emit("onFileAdd")},"Item:onComplete":e=>{const{item:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,f)[f]([s]);const t=new Set(babelHelpers.classPrivateFieldLooseBase(this,w)[w]);if(!babelHelpers.classPrivateFieldLooseBase(this,I)[I](s.customData.objectId).some((e=>t.has(e)))){babelHelpers.classPrivateFieldLooseBase(this,g)[g]({fileIds:[...t,s.serverFileId]})}this.emit("onFileComplete",s)},"Item:onRemove":e=>{const{item:s}=e.getData();const t=new Set(babelHelpers.classPrivateFieldLooseBase(this,I)[I](s.customData.objectId));babelHelpers.classPrivateFieldLooseBase(this,y)[y](t);babelHelpers.classPrivateFieldLooseBase(this,g)[g]({fileIds:babelHelpers.classPrivateFieldLooseBase(this,w)[w].filter((e=>!t.has(e)))})}})}setEntityId(e,s=n.Task){babelHelpers.classPrivateFieldLooseBase(this,v)[v]=e;babelHelpers.classPrivateFieldLooseBase(this,p)[p]=s}getEntityId(){return A(babelHelpers.classPrivateFieldLooseBase(this,v)[v],babelHelpers.classPrivateFieldLooseBase(this,p)[p])}getAdapter(){return babelHelpers.classPrivateFieldLooseBase(this,L)[L]}getFiles(){return babelHelpers.classPrivateFieldLooseBase(this,L)[L].getReactiveItems()}isUploading(){return babelHelpers.classPrivateFieldLooseBase(this,L)[L].getItems().some((({status:e})=>[t.FileStatus.UPLOADING,t.FileStatus.LOADING].includes(e)))}browse(e){var s,t;(t=(s=babelHelpers.classPrivateFieldLooseBase(this,h))[h])!=null?t:s[h]=new a.UserFieldMenu({dialogId:"task-card",uploader:babelHelpers.classPrivateFieldLooseBase(this,L)[L].getUploader(),menuOptions:{minWidth:220,animation:"fading",closeByEsc:true,bindOptions:{forceBindPosition:true,forceTop:true,position:"top"},events:{onPopupClose:()=>{e.onHideCallback==null?void 0:e.onHideCallback()}}},compact:true});babelHelpers.classPrivateFieldLooseBase(this,h)[h].show(e.bindElement)}browseFiles(){if(!babelHelpers.classPrivateFieldLooseBase(this,B)[B]){babelHelpers.classPrivateFieldLooseBase(this,B)[B]=document.createElement("div");babelHelpers.classPrivateFieldLooseBase(this,L)[L].getUploader().assignBrowse(babelHelpers.classPrivateFieldLooseBase(this,B)[B])}babelHelpers.classPrivateFieldLooseBase(this,B)[B].click()}browseMyDrive(){a.openDiskFileDialog({dialogId:"task-card",uploader:babelHelpers.classPrivateFieldLooseBase(this,L)[L].getUploader()})}destroy(){babelHelpers.classPrivateFieldLooseBase(this,L)[L].unsubscribeAll("Item:onAdd");babelHelpers.classPrivateFieldLooseBase(this,L)[L].unsubscribeAll("Item:onComplete");babelHelpers.classPrivateFieldLooseBase(this,L)[L].unsubscribeAll("Item:onRemove");babelHelpers.classPrivateFieldLooseBase(this,L)[L].getUploader().destroy()}async uploadFromClipboard(e){const{clipboardEvent:s}=e;const{clipboardData:i}=s;if(!i||!t.isFilePasted(i)){return[]}s.preventDefault();const a=await t.getFilesFromDataTransfer(i);return babelHelpers.classPrivateFieldLooseBase(this,H)[H](a)}async sync(e){if(e.every((e=>babelHelpers.classPrivateFieldLooseBase(this,u)[u].has(e)))){babelHelpers.classPrivateFieldLooseBase(this,L)[L].getItems().forEach((s=>{const t=[s.serverFileId];if(s.serverFileId[0]==="n"){const e=Number(s.serverFileId.slice(1));t.push(...babelHelpers.classPrivateFieldLooseBase(this,I)[I](e))}if(t.some((s=>e.includes(s)))){return}babelHelpers.classPrivateFieldLooseBase(this,L)[L].getUploader().removeFile(s.id)}))}await this.list(e)}async list(e){const s=e.filter((e=>e[0]!=="n"&&!babelHelpers.classPrivateFieldLooseBase(this,u)[u].has(e)));if(s.length===0){await Promise.all(babelHelpers.classPrivateFieldLooseBase(this,F)[F]);return babelHelpers.classPrivateFieldLooseBase(this,L)[L].getItems()}const t=new K;babelHelpers.classPrivateFieldLooseBase(this,F)[F].push(t);babelHelpers.classPrivateFieldLooseBase(this,m)[m](s);try{const e=await o.apiClient.post("File.list",{ids:s});const i=e.map((e=>c(e)));const a=new Set(Object.values(babelHelpers.classPrivateFieldLooseBase(this,P)[P]));const l=i.filter((({customData:e})=>!a.has(e.objectId)));babelHelpers.classPrivateFieldLooseBase(this,L)[L].getUploader().addFiles(l);babelHelpers.classPrivateFieldLooseBase(this,f)[f](i);t.resolve();await Promise.all(babelHelpers.classPrivateFieldLooseBase(this,F)[F]);return babelHelpers.classPrivateFieldLooseBase(this,L)[L].getItems()}catch(e){console.error("FileService: list error",e);return[]}}get $store(){return r.Core.getStore()}}function j(e){const s=babelHelpers.classPrivateFieldLooseBase(this,L)[L].getUploader();return s.addFiles(e)}function O(e){e.forEach((e=>babelHelpers.classPrivateFieldLooseBase(this,u)[u].add(e)))}function T(e){e.forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,P)[P][e.serverFileId]=e.customData.objectId}))}function U(e){e.forEach((e=>{delete babelHelpers.classPrivateFieldLooseBase(this,P)[P][e]}))}function E(e){return Object.entries(babelHelpers.classPrivateFieldLooseBase(this,P)[P]).filter((([,s])=>s===e)).map((([e])=>e[0]==="n"?e:Number(e)))}function D(e){if(babelHelpers.classPrivateFieldLooseBase(this,p)[p]===n.Task){void d.taskService.update(babelHelpers.classPrivateFieldLooseBase(this,v)[v],e)}else if(babelHelpers.classPrivateFieldLooseBase(this,p)[p]===n.CheckListItem){const s=b(e.fileIds);void this.$store.dispatch(`${l.Model.CheckList}/update`,{id:babelHelpers.classPrivateFieldLooseBase(this,v)[v],fields:{attachments:s}})}}function X(){if(babelHelpers.classPrivateFieldLooseBase(this,p)[p]===n.Task){return this.$store.getters[`${l.Model.Tasks}/getById`](babelHelpers.classPrivateFieldLooseBase(this,v)[v]).fileIds}return this.$store.getters[`${l.Model.CheckList}/getById`](babelHelpers.classPrivateFieldLooseBase(this,v)[v]).attachments}const S={};function A(e,s){return`${s}:${e}`}const C={get(e,s=n.Task){var t;const i=A(e,s);(t=S[i])!=null?t:S[i]=new k(e,s);return S[i]},replace(e,s,t=n.Task){const i=A(e,t);const a=A(s,t);S[a]=S[i];S[a].setEntityId(s,t);delete S[i]},delete(e,s=n.Task){var t;const i=A(e,s);(t=S[i])==null?void 0:t.destroy();delete S[i]}};function K(){const e=new Promise((e=>{this.resolve=e}));e.resolve=this.resolve;return e}e.fileService=C;e.EntityTypes=n})(this.BX.Tasks.V2.Provider.Service=this.BX.Tasks.V2.Provider.Service||{},BX.Event,BX.UI.Uploader,BX.UI.Uploader,BX.Disk.Uploader,BX.Tasks.V2.Const,BX.Tasks.V2,BX.Tasks.V2.Lib,BX.Tasks.V2.Provider.Service);
//# sourceMappingURL=file-service.bundle.map.js