this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};this.BX.Tasks.V2.Provider=this.BX.Tasks.V2.Provider||{};(function(e,s,a,t,i,l,r,o,d,n){"use strict";function c(e){var s,a,t;return{id:e.id,title:h(e.title),description:h(e.description,u(e.description)),creator:h(e.creatorId,{id:e.creatorId}),createdTs:h(e.createdTs,Math.floor(e.createdTs/1e3)),responsible:h(e.responsibleId,{id:e.responsibleId}),deadlineTs:h(e.deadlineTs,Math.floor(e.deadlineTs/1e3)),needsControl:h(e.needsControl),startPlanTs:h(e.startPlanTs,Math.floor(e.startPlanTs/1e3)),endPlanTs:h(e.endPlanTs,Math.floor(e.endPlanTs/1e3)),fileIds:h(e.fileIds),checklist:h(e.checklist),group:h(e.groupId,{id:e.groupId}),stage:h(e.stageId,{id:e.stageId}),flow:h(e.flowId,{id:e.flowId}),priority:h(e.isImportant,e.isImportant?"high":"low"),status:h(e.status),statusChangedTs:h(e.statusChangedTs,Math.floor(e.statusChangedTs/1e3)),accomplices:h(e.accomplicesIds,(s=e.accomplicesIds)==null?void 0:s.map((e=>({id:e})))),auditors:h(e.auditorsIds,(a=e.auditorsIds)==null?void 0:a.map((e=>({id:e})))),tags:h(e.tags,v((t=e.tags)!=null?t:[])),chatId:h(e.chatId),allowsChangeDeadline:h(e.allowsChangeDeadline),allowsChangeDatePlan:h(e.allowsChangeDatePlan),matchesWorkTime:h(e.matchesWorkTime),matchesSubTasksTime:h(e.matchesSubTasksTime),source:h(e.source),parent:undefined}}function p(e){var s,a,t,i,l,r;const o={id:e.id,title:e.title,isImportant:e.priority==="high",description:e.description,creatorId:e.creator.id,createdTs:e.createdTs*1e3,responsibleId:e.responsible.id,deadlineTs:e.deadlineTs*1e3,needsControl:e.needsControl,startPlanTs:e.startPlanTs*1e3,endPlanTs:e.endPlanTs*1e3,fileIds:e.fileIds,checklist:(s=e.checklist)!=null?s:[],containsChecklist:e.containsChecklist,groupId:(a=e.group)==null?void 0:a.id,stageId:(t=(i=e.stage)==null?void 0:i.id)!=null?t:0,flowId:(l=e.flow)==null?void 0:l.id,status:e.status,statusChangedTs:e.statusChangedTs*1e3,accomplicesIds:e.accomplices.map((({id:e})=>e)),auditorsIds:e.auditors.map((({id:e})=>e)),chatId:e.chatId,allowsChangeDeadline:h(e.allowsChangeDeadline),allowsChangeDatePlan:h(e.allowsChangeDatePlan),matchesWorkTime:h(e.matchesWorkTime),matchesSubTasksTime:h(e.matchesSubTasksTime),rights:h(e.rights),tags:h(e.tags,(r=e.tags)==null?void 0:r.map((({name:e})=>e))),archiveLink:h(e.archiveLink)};return Object.fromEntries(Object.entries(o).filter((([,e])=>e)))}function b(e,a){var t;const i={TITLE:h(e.title),DESCRIPTION:h(e.description,u(e.description)),RESPONSIBLE_ID:h(e.responsibleId),GROUP_ID:h(e.groupId),DEADLINE_TS:h(e.deadlineTs,Math.floor(e.deadlineTs/1e3)),IS_IMPORTANT:h(e.isImportant,e.isImportant?"Y":null),FILE_IDS:h(e.fileIds,((t=e.fileIds)==null?void 0:t.length)>0?e.fileIds:null),CHECKLIST:s.CheckListMappers.mapModelToSliderData(a)};return Object.fromEntries(Object.entries(i).filter((([,e])=>e)))}function h(e,s=e){return a.Type.isUndefined(e)?undefined:s}function u(e){return e==null?void 0:e.replaceAll(/\[p]\n|\[p]\[\/p]|\[\/p]/gi,"").trim()}function v(e){return e.map((e=>({name:e})))}var P=babelHelpers.classPrivateFieldLooseKey("data");class T{constructor(e){Object.defineProperty(this,P,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,P)[P]=e}getTask(){return p(babelHelpers.classPrivateFieldLooseBase(this,P)[P])}getFlow(){return babelHelpers.classPrivateFieldLooseBase(this,P)[P].flow?d.FlowMappers.mapDtoToModel(babelHelpers.classPrivateFieldLooseBase(this,P)[P].flow):null}getGroup(){return babelHelpers.classPrivateFieldLooseBase(this,P)[P].group?o.GroupMappers.mapDtoToModel(babelHelpers.classPrivateFieldLooseBase(this,P)[P].group):null}getStages(){return babelHelpers.classPrivateFieldLooseBase(this,P)[P].stage?[o.GroupMappers.mapStageDtoToModel(babelHelpers.classPrivateFieldLooseBase(this,P)[P].stage)]:[]}getUsers(){return[babelHelpers.classPrivateFieldLooseBase(this,P)[P].creator,babelHelpers.classPrivateFieldLooseBase(this,P)[P].responsible,...babelHelpers.classPrivateFieldLooseBase(this,P)[P].accomplices,...babelHelpers.classPrivateFieldLooseBase(this,P)[P].auditors].map((e=>n.UserMappers.mapDtoToModel(e)))}}var f,F,k,g,L,B,y,H,m,I,w,S,C,O,M,j,D;const K={scrumFields:new Set(["storyPoints","epicId"]),deadlineFields:new Set(["deadlineTs"]),datePlanFields:new Set(["startPlanTs","endPlanTs","matchesWorkTime","matchesSubTasksTime"])};const X=new(f=babelHelpers.classPrivateFieldLooseKey("updateFields"),F=babelHelpers.classPrivateFieldLooseKey("updateTaskBefore"),k=babelHelpers.classPrivateFieldLooseKey("updatePromises"),g=babelHelpers.classPrivateFieldLooseKey("updateServerTaskDebounced"),L=babelHelpers.classPrivateFieldLooseKey("updateTaskDebounced"),B=babelHelpers.classPrivateFieldLooseKey("updateTask"),y=babelHelpers.classPrivateFieldLooseKey("updateTaskFields"),H=babelHelpers.classPrivateFieldLooseKey("updateScrumFields"),m=babelHelpers.classPrivateFieldLooseKey("updateDeadlineFields"),I=babelHelpers.classPrivateFieldLooseKey("updateDatePlanFields"),w=babelHelpers.classPrivateFieldLooseKey("getTaskFields"),S=babelHelpers.classPrivateFieldLooseKey("getFilteredFields"),C=babelHelpers.classPrivateFieldLooseKey("hasChanges"),O=babelHelpers.classPrivateFieldLooseKey("getStoreTask"),M=babelHelpers.classPrivateFieldLooseKey("insertStoreTask"),j=babelHelpers.classPrivateFieldLooseKey("updateStoreTask"),D=babelHelpers.classPrivateFieldLooseKey("deleteStoreTask"),class{constructor(){Object.defineProperty(this,D,{value:Y});Object.defineProperty(this,j,{value:J});Object.defineProperty(this,M,{value:A});Object.defineProperty(this,O,{value:x});Object.defineProperty(this,C,{value:_});Object.defineProperty(this,S,{value:W});Object.defineProperty(this,w,{value:U});Object.defineProperty(this,I,{value:G});Object.defineProperty(this,m,{value:N});Object.defineProperty(this,H,{value:R});Object.defineProperty(this,y,{value:E});Object.defineProperty(this,B,{value:V});Object.defineProperty(this,L,{value:$});Object.defineProperty(this,f,{writable:true,value:{}});Object.defineProperty(this,F,{writable:true,value:{}});Object.defineProperty(this,k,{writable:true,value:{}});Object.defineProperty(this,g,{writable:true,value:{}})}async getById(e){try{const s=await l.apiClient.post("Task.get",{task:{id:e}});await this.extractTask(s)}catch(e){console.error("TaskService: getById error",e)}}async getRights(e){try{const{rights:s}=await l.apiClient.post("Task.Access.get",{task:{id:e}});await babelHelpers.classPrivateFieldLooseBase(this,j)[j](e,{rights:s})}catch(e){console.error("TaskService: getRights error",e)}}async add(e){try{const s=await l.apiClient.post("Task.add",{task:c(e)});const a=s.id;await this.extractTask(s);return[a,null]}catch(e){var s,a;console.error("TaskService: add error",e);return[0,new Error(e==null?void 0:(s=e.errors)==null?void 0:(a=s[0])==null?void 0:a.message)]}}async update(e,s){const a=babelHelpers.classPrivateFieldLooseBase(this,O)[O](e);await babelHelpers.classPrivateFieldLooseBase(this,j)[j](e,s);if(!this.isRealId(e)){return}try{await babelHelpers.classPrivateFieldLooseBase(this,L)[L](e,s,a)}catch(s){await babelHelpers.classPrivateFieldLooseBase(this,j)[j](e,a);console.error("TaskService: update error",s)}}async delete(e){const s=babelHelpers.classPrivateFieldLooseBase(this,O)[O](e);await babelHelpers.classPrivateFieldLooseBase(this,D)[D](e);if(!this.isRealId(e)){return}try{await l.apiClient.post("Task.delete",{task:{id:e}})}catch(e){void babelHelpers.classPrivateFieldLooseBase(this,M)[M](s);console.error("TaskService: delete error",e)}}async extractTask(e){const s=new T(e);await Promise.all([this.$store.dispatch(`${t.Model.Tasks}/upsert`,s.getTask()),this.$store.dispatch(`${t.Model.Flows}/upsert`,s.getFlow()),this.$store.dispatch(`${t.Model.Groups}/insert`,s.getGroup()),this.$store.dispatch(`${t.Model.Stages}/upsertMany`,s.getStages()),this.$store.dispatch(`${t.Model.Users}/upsertMany`,s.getUsers())]);await r.fileService.get(e.id).sync(e.fileIds)}isRealId(e){return Number.isInteger(e)&&e>0}get $store(){return i.Core.getStore()}});async function $(e,s,t){var i,l,r,o,d,n;babelHelpers.classPrivateFieldLooseBase(this,f)[f][e]={...babelHelpers.classPrivateFieldLooseBase(this,f)[f][e],...s};(l=(i=babelHelpers.classPrivateFieldLooseBase(this,F)[F])[e])!=null?l:i[e]=t;(o=(r=babelHelpers.classPrivateFieldLooseBase(this,k)[k])[e])!=null?o:r[e]=new q;(n=(d=babelHelpers.classPrivateFieldLooseBase(this,g)[g])[e])!=null?n:d[e]=a.Runtime.debounce(babelHelpers.classPrivateFieldLooseBase(this,B)[B],500,this);babelHelpers.classPrivateFieldLooseBase(this,g)[g][e](e);await babelHelpers.classPrivateFieldLooseBase(this,k)[k][e]}async function V(e){const s=babelHelpers.classPrivateFieldLooseBase(this,f)[f][e];delete babelHelpers.classPrivateFieldLooseBase(this,f)[f][e];const a=babelHelpers.classPrivateFieldLooseBase(this,F)[F][e];delete babelHelpers.classPrivateFieldLooseBase(this,F)[F][e];const t=babelHelpers.classPrivateFieldLooseBase(this,k)[k][e];delete babelHelpers.classPrivateFieldLooseBase(this,k)[k][e];await babelHelpers.classPrivateFieldLooseBase(this,y)[y](e,s,a);await babelHelpers.classPrivateFieldLooseBase(this,H)[H](e,s,a);await babelHelpers.classPrivateFieldLooseBase(this,m)[m](e,s,a);await babelHelpers.classPrivateFieldLooseBase(this,I)[I](e,s,a);t.resolve()}async function E(e,s,a){const t=babelHelpers.classPrivateFieldLooseBase(this,w)[w](s);if(babelHelpers.classPrivateFieldLooseBase(this,C)[C](a,t)){const s=await l.apiClient.post("Task.update",{task:c({id:e,...t})});await this.extractTask(s)}}async function R(e,s,a){const t=babelHelpers.classPrivateFieldLooseBase(this,S)[S](s,K.scrumFields);if(babelHelpers.classPrivateFieldLooseBase(this,C)[C](a,t)){await l.apiClient.post("Scrum.updateTask",{taskId:e,fields:t})}}async function N(e,s,a){const t=babelHelpers.classPrivateFieldLooseBase(this,S)[S](s,K.deadlineFields);if(babelHelpers.classPrivateFieldLooseBase(this,C)[C](a,t)){await l.apiClient.post("Task.Deadline.update",{task:c({id:e,...t})})}}async function G(e,s,a){const t=babelHelpers.classPrivateFieldLooseBase(this,S)[S](s,K.datePlanFields);if(babelHelpers.classPrivateFieldLooseBase(this,C)[C](a,t)){await l.apiClient.post("Task.Plan.update",{task:c({id:e,...t})})}}function U(e){return Object.fromEntries(Object.entries(e).filter((([e])=>Object.values(K).every((s=>!s.has(e))))))}function W(e,s){return Object.fromEntries(Object.entries(e).filter((([e])=>s.has(e))))}function _(e,s){return Object.entries(s).some((([s,a])=>JSON.stringify(e[s])!==JSON.stringify(a)))}function x(e){return{...this.$store.getters[`${t.Model.Tasks}/getById`](e)}}async function A(e){await this.$store.dispatch(`${t.Model.Tasks}/insert`,e)}async function J(e,s){await this.$store.dispatch(`${t.Model.Tasks}/update`,{id:e,fields:s})}async function Y(e){await this.$store.dispatch(`${t.Model.Tasks}/delete`,e)}function q(){const e=new Promise((e=>{this.resolve=e}));e.resolve=this.resolve;return e}const z={mapModelToDto:c,mapDtoToModel:p,mapModelToSliderData:b};e.TaskMappers=z;e.taskService=X})(this.BX.Tasks.V2.Provider.Service=this.BX.Tasks.V2.Provider.Service||{},BX.Tasks.V2.Provider.Service,BX,BX.Tasks.V2.Const,BX.Tasks.V2,BX.Tasks.V2.Lib,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service);
//# sourceMappingURL=task-service.bundle.map.js