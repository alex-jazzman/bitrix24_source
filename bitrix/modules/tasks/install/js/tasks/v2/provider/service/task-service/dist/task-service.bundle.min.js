this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};this.BX.Tasks.V2.Provider=this.BX.Tasks.V2.Provider||{};(function(e,s,t,a,i,r,l,o,d,n,c,p){"use strict";function u(e){var s,t,a;return{id:e.id,title:b(e.title),description:b(e.description,v(e.description)),creator:b(e.creatorId,{id:e.creatorId}),createdTs:b(e.createdTs,Math.floor(e.createdTs/1e3)),responsible:b(e.responsibleId,{id:e.responsibleId}),deadlineTs:b(e.deadlineTs,Math.floor(e.deadlineTs/1e3)),needsControl:b(e.needsControl),startPlanTs:b(e.startPlanTs,Math.floor(e.startPlanTs/1e3)),endPlanTs:b(e.endPlanTs,Math.floor(e.endPlanTs/1e3)),fileIds:b(e.fileIds),checklist:b(e.checklist),parent:b(e.parentId,{id:e.parentId}),dependsOn:b(e.relatedTaskIds),group:b(e.groupId,{id:e.groupId}),stage:b(e.stageId,{id:e.stageId}),flow:b(e.flowId,{id:e.flowId}),priority:b(e.isImportant,e.isImportant?"high":"low"),status:b(e.status),statusChangedTs:b(e.statusChangedTs,Math.floor(e.statusChangedTs/1e3)),accomplices:b(e.accomplicesIds,(s=e.accomplicesIds)==null?void 0:s.map((e=>({id:e})))),auditors:b(e.auditorsIds,(t=e.auditorsIds)==null?void 0:t.map((e=>({id:e})))),tags:b(e.tags,k((a=e.tags)!=null?a:[])),chatId:b(e.chatId),crmItemIds:b(e.crmItemIds),allowsChangeDeadline:b(e.allowsChangeDeadline),allowsChangeDatePlan:b(e.allowsChangeDatePlan),matchesWorkTime:b(e.matchesWorkTime),matchesSubTasksTime:b(e.matchesSubTasksTime),source:b(e.source)}}function h(e){var s,t,a,i,r,l,o,d,n,c,p,u,h;const T={id:e.id,title:e.title,isImportant:e.priority==="high",description:e.description,creatorId:(s=e.creator)==null?void 0:s.id,createdTs:e.createdTs*1e3,responsibleId:(t=e.responsible)==null?void 0:t.id,deadlineTs:e.deadlineTs*1e3,needsControl:e.needsControl,startPlanTs:e.startPlanTs*1e3,endPlanTs:e.endPlanTs*1e3,fileIds:e.fileIds,checklist:(a=e.checklist)!=null?a:[],containsChecklist:e.containsChecklist,parentId:(i=e.parentId)!=null?i:0,containsSubTasks:e.containsSubTasks,containsRelatedTasks:e.containsRelatedTasks,groupId:(r=e.group)==null?void 0:r.id,stageId:(l=(o=e.stage)==null?void 0:o.id)!=null?l:0,flowId:(d=e.flow)==null?void 0:d.id,status:e.status,statusChangedTs:e.statusChangedTs*1e3,accomplicesIds:(n=(c=e.accomplices)==null?void 0:c.map((({id:e})=>e)))!=null?n:[],auditorsIds:(p=(u=e.auditors)==null?void 0:u.map((({id:e})=>e)))!=null?p:[],chatId:e.chatId,crmItemIds:b(e.crmItemIds),allowsChangeDeadline:b(e.allowsChangeDeadline),allowsChangeDatePlan:b(e.allowsChangeDatePlan),matchesWorkTime:b(e.matchesWorkTime),matchesSubTasksTime:b(e.matchesSubTasksTime),rights:b(e.rights),tags:b(e.tags,(h=e.tags)==null?void 0:h.map((({name:e})=>e))),inFavorite:e.inFavorite||[],inMute:e.inMute||[],archiveLink:b(e.archiveLink)};return Object.fromEntries(Object.entries(T).filter((([,e])=>e)))}function T(e,t){var a;const i=s.CheckListMappers.getUserIdsFromChecklists(t,"accomplices");const r=s.CheckListMappers.getUserIdsFromChecklists(t,"auditors");const l={TITLE:b(e.title),DESCRIPTION:b(e.description,v(e.description)),RESPONSIBLE_ID:b(e.responsibleId),GROUP_ID:b(e.groupId),DEADLINE_TS:b(e.deadlineTs,Math.floor(e.deadlineTs/1e3)),IS_IMPORTANT:b(e.isImportant,e.isImportant?"Y":null),FILE_IDS:b(e.fileIds,((a=e.fileIds)==null?void 0:a.length)>0?e.fileIds:null),CHECKLIST:s.CheckListMappers.mapModelToSliderData(t),ACCOMPLICES:b(i,i.length>0?i:null),AUDITORS:b(r,r.length>0?r:null)};return Object.fromEntries(Object.entries(l).filter((([,e])=>e)))}function b(e,s=e){return t.Type.isUndefined(e)?undefined:s}function v(e){return e==null?void 0:e.replaceAll(/\[p]\n|\[p]\[\/p]|\[\/p]/gi,"").trim()}function k(e){return e.map((e=>({name:e})))}var P=babelHelpers.classPrivateFieldLooseKey("data");class S{constructor(e){Object.defineProperty(this,P,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,P)[P]=e}getTask(){return h(babelHelpers.classPrivateFieldLooseBase(this,P)[P])}getFlow(){return babelHelpers.classPrivateFieldLooseBase(this,P)[P].flow?c.FlowMappers.mapDtoToModel(babelHelpers.classPrivateFieldLooseBase(this,P)[P].flow):null}getGroup(){return babelHelpers.classPrivateFieldLooseBase(this,P)[P].group?n.GroupMappers.mapDtoToModel(babelHelpers.classPrivateFieldLooseBase(this,P)[P].group):null}getStages(){return babelHelpers.classPrivateFieldLooseBase(this,P)[P].stage?[n.GroupMappers.mapStageDtoToModel(babelHelpers.classPrivateFieldLooseBase(this,P)[P].stage)]:[]}getUsers(){var e,s,t,a,i,r;return[(e=babelHelpers.classPrivateFieldLooseBase(this,P)[P].creator)!=null?e:[],(s=babelHelpers.classPrivateFieldLooseBase(this,P)[P].responsible)!=null?s:[],...(t=(a=babelHelpers.classPrivateFieldLooseBase(this,P)[P])==null?void 0:a.accomplices)!=null?t:[],...(i=(r=babelHelpers.classPrivateFieldLooseBase(this,P)[P])==null?void 0:r.auditors)!=null?i:[]].map((e=>p.UserMappers.mapDtoToModel(e)))}}var f,F,g,I,m,w,y,L,B,H,C,M,O,E,D;const $={scrumFields:new Set(["storyPoints","epicId"]),deadlineFields:new Set(["deadlineTs"]),datePlanFields:new Set(["startPlanTs","endPlanTs","matchesWorkTime","matchesSubTasksTime"])};const j=new(f=babelHelpers.classPrivateFieldLooseKey("updateFields"),F=babelHelpers.classPrivateFieldLooseKey("updateTaskBefore"),g=babelHelpers.classPrivateFieldLooseKey("updatePromises"),I=babelHelpers.classPrivateFieldLooseKey("updateServerTaskDebounced"),m=babelHelpers.classPrivateFieldLooseKey("updateTaskDebounced"),w=babelHelpers.classPrivateFieldLooseKey("updateTask"),y=babelHelpers.classPrivateFieldLooseKey("updateTaskFields"),L=babelHelpers.classPrivateFieldLooseKey("updateScrumFields"),B=babelHelpers.classPrivateFieldLooseKey("updateDeadlineFields"),H=babelHelpers.classPrivateFieldLooseKey("updateDatePlanFields"),C=babelHelpers.classPrivateFieldLooseKey("getTaskFields"),M=babelHelpers.classPrivateFieldLooseKey("getFilteredFields"),O=babelHelpers.classPrivateFieldLooseKey("hasChanges"),E=babelHelpers.classPrivateFieldLooseKey("insertStoreTask"),D=babelHelpers.classPrivateFieldLooseKey("deleteStoreTask"),class{constructor(){Object.defineProperty(this,D,{value:x});Object.defineProperty(this,E,{value:_});Object.defineProperty(this,O,{value:W});Object.defineProperty(this,M,{value:G});Object.defineProperty(this,C,{value:N});Object.defineProperty(this,H,{value:A});Object.defineProperty(this,B,{value:V});Object.defineProperty(this,L,{value:K});Object.defineProperty(this,y,{value:U});Object.defineProperty(this,w,{value:R});Object.defineProperty(this,m,{value:X});Object.defineProperty(this,f,{writable:true,value:{}});Object.defineProperty(this,F,{writable:true,value:{}});Object.defineProperty(this,g,{writable:true,value:{}});Object.defineProperty(this,I,{writable:true,value:{}})}async getById(e){try{const s=await l.apiClient.post("Task.get",{task:{id:e}});await this.extractTask(s);await this.$store.dispatch(`${i.Model.Tasks}/removePartiallyLoaded`,e)}catch(e){console.error("TaskService: getById error",e)}}async getRights(e){try{const{rights:s}=await l.apiClient.post("Task.Access.get",{task:{id:e}});await this.updateStoreTask(e,{rights:s})}catch(e){console.error("TaskService: getRights error",e)}}async add(e){try{const s=await l.apiClient.post("Task.add",{task:u(e)});await this.extractTask(s);a.EventEmitter.emit(i.EventName.TaskAdd,{...new S(s).getTask(),relatedToTaskId:e.relatedToTaskId});if(e.containsRelatedTasks){void d.relatedTasksService.list(s.id,true)}if(e.relatedToTaskId){void d.relatedTasksService.add(e.relatedToTaskId,[s.id])}if(e.parentId){d.subTasksService.addStore(e.parentId,[s.id])}return[s.id,null]}catch(e){var s,t;console.error("TaskService: add error",e);return[0,new Error((s=e.errors)==null?void 0:(t=s[0])==null?void 0:t.message)]}}async update(e,s){const t=this.getStoreTask(e);await this.updateStoreTask(e,s);if(!this.isRealId(e)){return}if(babelHelpers.classPrivateFieldLooseBase(this,O)[O](t,s)){a.EventEmitter.emit(i.EventName.TaskUpdate,{id:e,...s})}try{await babelHelpers.classPrivateFieldLooseBase(this,m)[m](e,s,t)}catch(s){await this.updateStoreTask(e,t);console.error("TaskService: update error",s)}}async delete(e){const s=this.getStoreTask(e);await babelHelpers.classPrivateFieldLooseBase(this,D)[D](e);if(!this.isRealId(e)){return}try{await l.apiClient.post("Task.delete",{task:{id:e}})}catch(e){void babelHelpers.classPrivateFieldLooseBase(this,E)[E](s);console.error("TaskService: delete error",e)}}async extractTask(e){const s=new S(e);await Promise.all([this.$store.dispatch(`${i.Model.Tasks}/upsert`,s.getTask()),this.$store.dispatch(`${i.Model.Flows}/upsert`,s.getFlow()),this.$store.dispatch(`${i.Model.Groups}/insert`,s.getGroup()),this.$store.dispatch(`${i.Model.Stages}/upsertMany`,s.getStages()),this.$store.dispatch(`${i.Model.Users}/upsertMany`,s.getUsers())]);await o.fileService.get(e.id).sync(e.fileIds)}isRealId(e){return Number.isInteger(e)&&e>0}async updateStoreTask(e,s){if(this.hasStoreTask(e)){await this.$store.dispatch(`${i.Model.Tasks}/update`,{id:e,fields:s})}}hasStoreTask(e){return this.getStoreTask(e)!==null}getStoreTask(e){const s=this.$store.getters[`${i.Model.Tasks}/getById`](e);return s?{...s}:null}async addFavorite(e,s){const t=[...this.$store.state.tasks.collection[e.id].inFavorite];await this.updateStoreTask(e.id,{inFavorite:[...t,s]});try{const s=await l.apiClient.post("Task.Favorite.add",{task:{id:e.id}});const a=s===true;if(a){console.log("REQUEST SUCCESS")}else{await this.updateStoreTask(e.id,{inFavorite:t})}return a}catch(s){console.error("TaskService error",s);await this.updateStoreTask(e.id,{inFavorite:t});return false}}async removeFavorite(e,s){const t=[...this.$store.state.tasks.collection[e.id].inFavorite];await this.updateStoreTask(e.id,{inFavorite:t.filter((e=>String(e)!==String(s)))});try{const s=await l.apiClient.post("Task.Favorite.delete",{task:{id:e.id}});const a=s===true;if(a){console.log("REQUEST SUCCESS")}else{await this.updateStoreTask(e.id,{inFavorite:t})}return a}catch(s){console.error("TaskService error",s);await this.updateStoreTask(e.id,{inFavorite:t});return false}}async muteTask(e,s){const t=[...this.$store.state.tasks.collection[e.id].inMute];await this.updateStoreTask(e.id,{inMute:[...t,s]});try{const s=await l.apiClient.post("Task.Attention.mute",{task:{id:e.id}});const a=s===true;if(a){console.log("REQUEST SUCCESS")}else{await this.updateStoreTask(e.id,{inMute:t})}return a}catch(s){console.error("TaskService error",s);await this.updateStoreTask(e.id,{inMute:t});return false}}async unmuteTask(e,s){const t=[...this.$store.state.tasks.collection[e.id].inMute];await this.updateStoreTask(e.id,{inMute:t.filter((e=>String(e)!==String(s)))});try{const s=await l.apiClient.post("Task.Attention.unmute",{task:{id:e.id}});const a=s===true;if(a){console.log("REQUEST SUCCESS")}else{await this.updateStoreTask(e.id,{inMute:t})}return a}catch(s){console.error("TaskService error",s);await this.updateStoreTask(e.id,{inMute:t});return false}}async setAuditors(e,s){const t=[...this.$store.state.tasks.collection[e].auditorsIds];const a={...this.$store.state.tasks.collection[e].filledFields};await this.updateStoreTask(e,{filledFields:{...a,auditorsIds:true},auditorsIds:[...s]});const i=s.map((e=>({id:e})));const r={id:e,auditors:i};try{const s=await l.apiClient.post("Task.Stakeholder.Auditor.set",{task:r});const a=Boolean(s);if(a){await this.updateStoreTask(e,{auditorsIds:s.auditors.map((e=>e.id))})}else{await this.updateStoreTask(e,{auditorsIds:[...t]})}return a}catch(s){console.error("TaskService error",s);await this.updateStoreTask(e,{auditorsIds:[...t]});return false}}get $store(){return r.Core.getStore()}});async function X(e,s,a){var i,r,l,o,d,n;babelHelpers.classPrivateFieldLooseBase(this,f)[f][e]={...babelHelpers.classPrivateFieldLooseBase(this,f)[f][e],...s};(r=(i=babelHelpers.classPrivateFieldLooseBase(this,F)[F])[e])!=null?r:i[e]=a;(o=(l=babelHelpers.classPrivateFieldLooseBase(this,g)[g])[e])!=null?o:l[e]=new Q;(n=(d=babelHelpers.classPrivateFieldLooseBase(this,I)[I])[e])!=null?n:d[e]=t.Runtime.debounce(babelHelpers.classPrivateFieldLooseBase(this,w)[w],500,this);babelHelpers.classPrivateFieldLooseBase(this,I)[I][e](e);await babelHelpers.classPrivateFieldLooseBase(this,g)[g][e]}async function R(e){const s=babelHelpers.classPrivateFieldLooseBase(this,f)[f][e];delete babelHelpers.classPrivateFieldLooseBase(this,f)[f][e];const t=babelHelpers.classPrivateFieldLooseBase(this,F)[F][e];delete babelHelpers.classPrivateFieldLooseBase(this,F)[F][e];const a=babelHelpers.classPrivateFieldLooseBase(this,g)[g][e];delete babelHelpers.classPrivateFieldLooseBase(this,g)[g][e];await babelHelpers.classPrivateFieldLooseBase(this,y)[y](e,s,t);await babelHelpers.classPrivateFieldLooseBase(this,L)[L](e,s,t);await babelHelpers.classPrivateFieldLooseBase(this,B)[B](e,s,t);await babelHelpers.classPrivateFieldLooseBase(this,H)[H](e,s,t);a.resolve()}async function U(e,s,t){const a=babelHelpers.classPrivateFieldLooseBase(this,C)[C](s);if(babelHelpers.classPrivateFieldLooseBase(this,O)[O](t,a)){const s=await l.apiClient.post("Task.update",{task:u({id:e,...a})});await this.extractTask(s)}}async function K(e,s,t){const a=babelHelpers.classPrivateFieldLooseBase(this,M)[M](s,$.scrumFields);if(babelHelpers.classPrivateFieldLooseBase(this,O)[O](t,a)){await l.apiClient.post("Scrum.updateTask",{taskId:e,fields:a})}}async function V(e,s,t){const a=babelHelpers.classPrivateFieldLooseBase(this,M)[M](s,$.deadlineFields);if(babelHelpers.classPrivateFieldLooseBase(this,O)[O](t,a)){await l.apiClient.post("Task.Deadline.update",{task:u({id:e,...a})})}}async function A(e,s,t){const a=babelHelpers.classPrivateFieldLooseBase(this,M)[M](s,$.datePlanFields);if(babelHelpers.classPrivateFieldLooseBase(this,O)[O](t,a)){await l.apiClient.post("Task.Plan.update",{task:u({id:e,...a})})}}function N(e){return Object.fromEntries(Object.entries(e).filter((([e])=>Object.values($).every((s=>!s.has(e))))))}function G(e,s){return Object.fromEntries(Object.entries(e).filter((([e])=>s.has(e))))}function W(e,s){return Object.entries(s).some((([s,t])=>JSON.stringify(e[s])!==JSON.stringify(t)))}async function _(e){await this.$store.dispatch(`${i.Model.Tasks}/insert`,e)}async function x(e){await this.$store.dispatch(`${i.Model.Tasks}/delete`,e)}function Q(){const e=new Promise((e=>{this.resolve=e}));e.resolve=this.resolve;return e}const J={mapModelToDto:u,mapDtoToModel:h,mapModelToSliderData:T};e.TaskMappers=J;e.taskService=j})(this.BX.Tasks.V2.Provider.Service=this.BX.Tasks.V2.Provider.Service||{},BX.Tasks.V2.Provider.Service,BX,BX.Event,BX.Tasks.V2.Const,BX.Tasks.V2,BX.Tasks.V2.Lib,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service,BX.Tasks.V2.Provider.Service);
//# sourceMappingURL=task-service.bundle.map.js