{"version":3,"file":"tasks.bundle.js","sources":["../src/tasks.js"],"sourcesContent":["/* eslint-disable no-param-reassign */\nimport { BuilderEntityModel, Store } from 'ui.vue3.vuex';\nimport type { ActionTree, GetterTree, MutationTree } from 'ui.vue3.vuex';\n\nimport { Model, TaskField } from 'tasks.v2.const';\n\nimport type { TaskModel, TasksModelState } from './types';\n\nconst aliasFields = {\n\t[TaskField.DatePlan]: new Set(['startPlanTs', 'endPlanTs', 'matchesSubTasksTime']),\n\t[TaskField.SubTasks]: new Set(['containsSubTasks']),\n\t[TaskField.RelatedTasks]: new Set(['containsRelatedTasks']),\n};\n\nexport class Tasks extends BuilderEntityModel<TasksModelState, TaskModel>\n{\n\tgetName(): string\n\t{\n\t\treturn Model.Tasks;\n\t}\n\n\tgetState(): TasksModelState\n\t{\n\t\treturn {\n\t\t\tpartiallyLoadedIds: new Set(),\n\t\t};\n\t}\n\n\tgetElementState(): TaskModel\n\t{\n\t\treturn {\n\t\t\tid: 0,\n\t\t\ttitle: '',\n\t\t\tisImportant: false,\n\t\t\tdescription: '',\n\t\t\tcreatorId: 0,\n\t\t\tcreatedTs: Date.now(),\n\t\t\tresponsibleId: 0,\n\t\t\tdeadlineTs: 0,\n\t\t\tstartPlanTs: null,\n\t\t\tendPlanTs: null,\n\t\t\tfileIds: [],\n\t\t\tchecklist: [],\n\t\t\tcontainsChecklist: false,\n\t\t\tstoryPoints: '',\n\t\t\tepicId: 0,\n\t\t\taccomplicesIds: [],\n\t\t\tauditorsIds: [],\n\t\t\ttags: [],\n\t\t\tstatus: 'pending',\n\t\t\tstatusChangedTs: Date.now(),\n\t\t\tneedsControl: false,\n\t\t\tfilledFields: {},\n\t\t\tparentId: 0,\n\t\t\tsubTaskIds: [],\n\t\t\tcontainsSubTasks: false,\n\t\t\trelatedTaskIds: [],\n\t\t\tcontainsRelatedTasks: false,\n\t\t\trights: {\n\t\t\t\tedit: true,\n\t\t\t\tdeadline: true,\n\t\t\t\tdatePlan: true,\n\t\t\t\tdelegate: true,\n\t\t\t},\n\t\t\tinFavorite: [],\n\t\t\tinMute: [],\n\t\t};\n\t}\n\n\tgetGetters(): GetterTree<TasksModelState>\n\t{\n\t\treturn {\n\t\t\t/** @function tasks/wasFieldFilled */\n\t\t\twasFieldFilled: (state: TasksModelState) => (id: number | string, fieldName: string): boolean => {\n\t\t\t\treturn state.collection[id].filledFields?.[fieldName] ?? false;\n\t\t\t},\n\t\t\t/** @function tasks/isPartiallyLoaded */\n\t\t\tisPartiallyLoaded: (state: TasksModelState) => (id: number | string): boolean => {\n\t\t\t\treturn state.partiallyLoadedIds.has(id);\n\t\t\t},\n\t\t};\n\t}\n\n\tgetActions(): ActionTree<TasksModelState>\n\t{\n\t\treturn {\n\t\t\t/** @function tasks/setFieldFilled */\n\t\t\tsetFieldFilled: (store: Store, { id, fieldName }: { id: number, fieldName: string }): void => {\n\t\t\t\tstore.commit('setFieldFilled', { id, fieldName });\n\t\t\t},\n\t\t\t/** @function tasks/clearFieldsFilled */\n\t\t\tclearFieldsFilled: (store: Store, id: number | string): void => {\n\t\t\t\tstore.commit('clearFieldsFilled', id);\n\t\t\t},\n\t\t\t/** @function tasks/addPartiallyLoaded */\n\t\t\taddPartiallyLoaded: (store: Store, id: number | string): void => {\n\t\t\t\tstore.commit('addPartiallyLoaded', id);\n\t\t\t},\n\t\t\t/** @function tasks/removePartiaalyLoaded */\n\t\t\tremovePartiallyLoaded: (store: Store, id: number | string): void => {\n\t\t\t\tstore.commit('removePartiallyLoaded', id);\n\t\t\t},\n\t\t};\n\t}\n\n\tgetMutations(): MutationTree<TasksModelState>\n\t{\n\t\treturn {\n\t\t\tupsert: (state: TasksModelState, task: ?TaskModel): void => {\n\t\t\t\tBuilderEntityModel.defaultModel.getMutations(this).upsert(state, task);\n\n\t\t\t\tthis.#setFieldsFilled(state, task.id);\n\t\t\t},\n\t\t\tupdate: (state: TasksModelState, { id, fields }: { id: number | string, fields: TaskModel }): void => {\n\t\t\t\tBuilderEntityModel.defaultModel.getMutations(this).update(state, { id, fields });\n\n\t\t\t\tthis.#setFieldsFilled(state, id);\n\t\t\t},\n\t\t\tsetFieldFilled: (state: TasksModelState, { id, fieldName }: { id: number, fieldName: string }): void => {\n\t\t\t\t(state.collection[id].filledFields ??= {})[fieldName] = true;\n\t\t\t},\n\t\t\tclearFieldsFilled: (state: TasksModelState, id: number | string): void => {\n\t\t\t\tif (!state.collection[id])\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tstate.collection[id].filledFields = {};\n\n\t\t\t\tthis.#setFieldsFilled(state, id);\n\t\t\t},\n\t\t\taddPartiallyLoaded: (state: TasksModelState, id: number | string): void => {\n\t\t\t\tstate.partiallyLoadedIds.add(id);\n\t\t\t},\n\t\t\tremovePartiallyLoaded: (state: TasksModelState, id: number | string): void => {\n\t\t\t\tstate.partiallyLoadedIds.delete(id);\n\t\t\t},\n\t\t};\n\t}\n\n\t#setFieldsFilled(state: TasksModelState, id: number | string): void\n\t{\n\t\tconst task = state.collection[id];\n\t\tconst canEdit = task?.rights?.edit;\n\n\t\ttask.filledFields ??= {};\n\t\tObject.entries(task).forEach(([fieldName: string, value: any]) => {\n\t\t\tconst isFilled = Boolean(value) && (!Array.isArray(value) || value.length > 0);\n\t\t\tif (isFilled)\n\t\t\t{\n\t\t\t\ttask.filledFields[this.#getAliasField(fieldName) ?? fieldName] = true;\n\t\t\t}\n\n\t\t\tif (!isFilled && !canEdit)\n\t\t\t{\n\t\t\t\ttask.filledFields[fieldName] = false;\n\t\t\t}\n\t\t});\n\t}\n\n\t#getAliasField(fieldName: string): string\n\t{\n\t\treturn Object.entries(aliasFields).find(([, alias]) => alias.has(fieldName))?.[0];\n\t}\n}\n"],"names":["aliasFields","TaskField","DatePlan","Set","SubTasks","RelatedTasks","Tasks","BuilderEntityModel","getName","Model","getState","partiallyLoadedIds","getElementState","id","title","isImportant","description","creatorId","createdTs","Date","now","responsibleId","deadlineTs","startPlanTs","endPlanTs","fileIds","checklist","containsChecklist","storyPoints","epicId","accomplicesIds","auditorsIds","tags","status","statusChangedTs","needsControl","filledFields","parentId","subTaskIds","containsSubTasks","relatedTaskIds","containsRelatedTasks","rights","edit","deadline","datePlan","delegate","inFavorite","inMute","getGetters","wasFieldFilled","state","fieldName","collection","isPartiallyLoaded","has","getActions","setFieldFilled","store","commit","clearFieldsFilled","addPartiallyLoaded","removePartiallyLoaded","getMutations","upsert","task","defaultModel","update","fields","add","delete","canEdit","Object","entries","forEach","value","isFilled","Boolean","Array","isArray","length","find","alias"],"mappings":"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"}