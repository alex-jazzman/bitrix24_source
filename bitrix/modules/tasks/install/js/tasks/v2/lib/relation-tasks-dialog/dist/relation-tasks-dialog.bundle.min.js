this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};this.BX.Tasks.V2=this.BX.Tasks.V2||{};(function(e,s,a,t,l,i,r,o){"use strict";let d=e=>e,c;var b=babelHelpers.classPrivateFieldLooseKey("meta");var n=babelHelpers.classPrivateFieldLooseKey("taskId");var v=babelHelpers.classPrivateFieldLooseKey("dialog");var p=babelHelpers.classPrivateFieldLooseKey("onUpdateOnce");var h=babelHelpers.classPrivateFieldLooseKey("createDialog");var P=babelHelpers.classPrivateFieldLooseKey("createFooter");var F=babelHelpers.classPrivateFieldLooseKey("addTaskItems");var L=babelHelpers.classPrivateFieldLooseKey("updateTask");var B=babelHelpers.classPrivateFieldLooseKey("add");var u=babelHelpers.classPrivateFieldLooseKey("selectableItems");var H=babelHelpers.classPrivateFieldLooseKey("items");var T=babelHelpers.classPrivateFieldLooseKey("mapIdsToItemIds");var k=babelHelpers.classPrivateFieldLooseKey("task");class f{constructor(e){Object.defineProperty(this,k,{get:K,set:void 0});Object.defineProperty(this,T,{value:j});Object.defineProperty(this,H,{get:O,set:void 0});Object.defineProperty(this,u,{get:E,set:void 0});Object.defineProperty(this,B,{value:I});Object.defineProperty(this,L,{value:m});Object.defineProperty(this,F,{value:S});Object.defineProperty(this,P,{value:g});Object.defineProperty(this,h,{value:y});Object.defineProperty(this,b,{writable:true,value:void 0});Object.defineProperty(this,n,{writable:true,value:void 0});Object.defineProperty(this,v,{writable:true,value:null});Object.defineProperty(this,p,{writable:true,value:null});babelHelpers.classPrivateFieldLooseBase(this,b)[b]=e}setTaskId(e){babelHelpers.classPrivateFieldLooseBase(this,n)[n]=e;return this}showTo(e,s){var a,t;(t=(a=babelHelpers.classPrivateFieldLooseBase(this,v))[v])!=null?t:a[v]=babelHelpers.classPrivateFieldLooseBase(this,h)[h]();if(babelHelpers.classPrivateFieldLooseBase(this,v)[v].isLoaded()){babelHelpers.classPrivateFieldLooseBase(this,F)[F](babelHelpers.classPrivateFieldLooseBase(this,k)[k][babelHelpers.classPrivateFieldLooseBase(this,b)[b].idsField])}babelHelpers.classPrivateFieldLooseBase(this,v)[v].selectItemsByIds(babelHelpers.classPrivateFieldLooseBase(this,H)[H]);babelHelpers.classPrivateFieldLooseBase(this,v)[v].setSelectableByIds(babelHelpers.classPrivateFieldLooseBase(this,u)[u]);babelHelpers.classPrivateFieldLooseBase(this,v)[v].getPopup().setTargetContainer(s);babelHelpers.classPrivateFieldLooseBase(this,v)[v].showTo(e)}getDialog(){return babelHelpers.classPrivateFieldLooseBase(this,v)[v]}onUpdateOnce(e){babelHelpers.classPrivateFieldLooseBase(this,p)[p]=e;return this}}function y(){const e=()=>{if(!babelHelpers.classPrivateFieldLooseBase(this,v)[v].isLoaded()){return}const e=babelHelpers.classPrivateFieldLooseBase(this,v)[v].getSelectedItems().map((e=>Number(e.getId())));if(e.sort().join(",")!==babelHelpers.classPrivateFieldLooseBase(this,k)[k][babelHelpers.classPrivateFieldLooseBase(this,b)[b].idsField].sort().join(",")){void babelHelpers.classPrivateFieldLooseBase(this,L)[L]()}};return new a.EntitySelectorDialog({context:"tasks-card",multiple:true,enableSearch:true,width:500,entities:[{id:r.EntitySelectorEntity.Task}],preselectedItems:babelHelpers.classPrivateFieldLooseBase(this,H)[H],popupOptions:{events:{onClose:e}},footer:babelHelpers.classPrivateFieldLooseBase(this,P)[P]()})}function g(){const e=i.Tag.render(c||(c=d`
			<span class="ui-selector-footer-link ui-selector-footer-link-add">${0}</span>
		`),babelHelpers.classPrivateFieldLooseBase(this,b)[b].footerText);i.Event.bind(e,"click",(()=>{var e,a;return s.EventEmitter.emit(r.EventName.OpenCompactCard,{[r.TaskField.Title]:(e=(a=this.getDialog().getActiveTab()).getLastSearchQuery)==null?void 0:e.call(a).getQuery(),[babelHelpers.classPrivateFieldLooseBase(this,b)[b].relationToField]:babelHelpers.classPrivateFieldLooseBase(this,n)[n]})}));return e}function S(e){const s=new Set(babelHelpers.classPrivateFieldLooseBase(this,v)[v].getItems().map((e=>e.getId())));e.filter((e=>!s.has(e))).forEach((e=>{const s=l.taskService.getStoreTask(e);babelHelpers.classPrivateFieldLooseBase(this,v)[v].addItem({id:e,entityId:r.EntitySelectorEntity.Task,title:s.title,selected:true,sort:0,tabs:["recents"]})}))}async function m(){var e,s;const a=babelHelpers.classPrivateFieldLooseBase(this,v)[v].getSelectedItems();const t=a.map((e=>Number(e.getId())));const l=babelHelpers.classPrivateFieldLooseBase(this,k)[k][babelHelpers.classPrivateFieldLooseBase(this,b)[b].idsField];const i=l.filter((e=>!t.includes(e)));const r=t.filter((e=>!l.includes(e)));await Promise.all([babelHelpers.classPrivateFieldLooseBase(this,b)[b].service.delete(babelHelpers.classPrivateFieldLooseBase(this,n)[n],i),babelHelpers.classPrivateFieldLooseBase(this,B)[B](r)]);(e=(s=babelHelpers.classPrivateFieldLooseBase(this,p))[p])==null?void 0:e.call(s);babelHelpers.classPrivateFieldLooseBase(this,p)[p]=null}async function I(e){const s=await babelHelpers.classPrivateFieldLooseBase(this,b)[b].service.add(babelHelpers.classPrivateFieldLooseBase(this,n)[n],e);if(s){void t.relationError.setTaskId(babelHelpers.classPrivateFieldLooseBase(this,n)[n]).showError(s,babelHelpers.classPrivateFieldLooseBase(this,b)[b].id)}}function E(){const e=[];const s=[];babelHelpers.classPrivateFieldLooseBase(this,k)[k][babelHelpers.classPrivateFieldLooseBase(this,b)[b].idsField].forEach((a=>{const t=l.taskService.getStoreTask(a);if(!t||t.rights.detachParent||t.rights.detachRelated){e.push(a)}else{s.push(a)}}));return{selectable:babelHelpers.classPrivateFieldLooseBase(this,T)[T](e),unselectable:babelHelpers.classPrivateFieldLooseBase(this,T)[T](s)}}function O(){return babelHelpers.classPrivateFieldLooseBase(this,T)[T](babelHelpers.classPrivateFieldLooseBase(this,k)[k][babelHelpers.classPrivateFieldLooseBase(this,b)[b].idsField])}function j(e){return e.map((e=>[r.EntitySelectorEntity.Task,e]))}function K(){return l.taskService.getStoreTask(babelHelpers.classPrivateFieldLooseBase(this,n)[n])}const X=Object.freeze({id:r.TaskField.SubTasks,idsField:"subTaskIds",relationToField:"parentId",footerText:i.Loc.getMessage("TASKS_V2_SUB_TASKS_CREATE"),service:o.subTasksService});const w=Object.freeze({id:r.TaskField.RelatedTasks,idsField:"relatedTaskIds",relationToField:"relatedToTaskId",footerText:i.Loc.getMessage("TASKS_V2_RELATED_TASKS_CREATE"),service:o.relatedTasksService});const V=new f(X);const A=new f(w);e.subTasksDialog=V;e.relatedTasksDialog=A})(this.BX.Tasks.V2.Lib=this.BX.Tasks.V2.Lib||{},BX.Event,BX.Tasks.V2.Lib,BX.Tasks.V2.Lib,BX.Tasks.V2.Provider.Service,BX,BX.Tasks.V2.Const,BX.Tasks.V2.Provider.Service);
//# sourceMappingURL=relation-tasks-dialog.bundle.map.js