{"version":3,"file":"relation-tasks-dialog.bundle.js","sources":["../src/relation-tasks-dialog.js","../src/meta.js","../src/index.js"],"sourcesContent":["import { Event, Tag } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\n\nimport { EntitySelectorEntity, EventName, TaskField } from 'tasks.v2.const';\nimport { EntitySelectorDialog, type ItemId } from 'tasks.v2.lib.entity-selector-dialog';\nimport { relationError } from 'tasks.v2.lib.relation-error';\nimport { taskService } from 'tasks.v2.provider.service.task-service';\nimport type { TaskModel } from 'tasks.v2.model.tasks';\n\nimport { RelationMeta } from './types';\n\nexport class RelationTasksDialog\n{\n\t#meta: RelationMeta;\n\t#taskId: number | string;\n\t#dialog: EntitySelectorDialog | null = null;\n\t#onUpdateOnce: Function | null = null;\n\n\tconstructor(meta: RelationMeta)\n\t{\n\t\tthis.#meta = meta;\n\t}\n\n\tsetTaskId(taskId: number | string): RelationTasksDialog\n\t{\n\t\tthis.#taskId = taskId;\n\n\t\treturn this;\n\t}\n\n\tshowTo(targetNode: HTMLElement, targetContainer: HTMLElement): void\n\t{\n\t\tthis.#dialog ??= this.#createDialog();\n\t\tif (this.#dialog.isLoaded())\n\t\t{\n\t\t\tthis.#addTaskItems(this.#task[this.#meta.idsField]);\n\t\t}\n\t\tthis.#dialog.selectItemsByIds(this.#items);\n\t\tthis.#dialog.setSelectableByIds(this.#selectableItems);\n\t\tthis.#dialog.getPopup().setTargetContainer(targetContainer);\n\t\tthis.#dialog.showTo(targetNode);\n\t}\n\n\tgetDialog(): EntitySelectorDialog\n\t{\n\t\treturn this.#dialog;\n\t}\n\n\tonUpdateOnce(callback: Function): RelationTasksDialog\n\t{\n\t\tthis.#onUpdateOnce = callback;\n\n\t\treturn this;\n\t}\n\n\t#createDialog(): EntitySelectorDialog\n\t{\n\t\tconst handleClose = (): void => {\n\t\t\tif (!this.#dialog.isLoaded())\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst ids = this.#dialog.getSelectedItems().map((item) => Number(item.getId()));\n\t\t\tif (ids.sort().join(',') !== this.#task[this.#meta.idsField].sort().join(','))\n\t\t\t{\n\t\t\t\tvoid this.#updateTask();\n\t\t\t}\n\t\t};\n\n\t\treturn new EntitySelectorDialog({\n\t\t\tcontext: 'tasks-card',\n\t\t\tmultiple: true,\n\t\t\tenableSearch: true,\n\t\t\twidth: 500,\n\t\t\tentities: [\n\t\t\t\t{\n\t\t\t\t\tid: EntitySelectorEntity.Task,\n\t\t\t\t},\n\t\t\t],\n\t\t\tpreselectedItems: this.#items,\n\t\t\tpopupOptions: {\n\t\t\t\tevents: {\n\t\t\t\t\tonClose: handleClose,\n\t\t\t\t},\n\t\t\t},\n\t\t\tfooter: this.#createFooter(),\n\t\t});\n\t}\n\n\t#createFooter(): HTMLElement\n\t{\n\t\tconst footer = Tag.render`\n\t\t\t<span class=\"ui-selector-footer-link ui-selector-footer-link-add\">${this.#meta.footerText}</span>\n\t\t`;\n\n\t\tEvent.bind(footer, 'click', () => EventEmitter.emit(EventName.OpenCompactCard, {\n\t\t\t[TaskField.Title]: this.getDialog().getActiveTab().getLastSearchQuery?.().getQuery(),\n\t\t\t[this.#meta.relationToField]: this.#taskId,\n\t\t}));\n\n\t\treturn footer;\n\t}\n\n\t#addTaskItems(ids: number): void\n\t{\n\t\tconst itemIds = new Set(this.#dialog.getItems().map((it) => it.getId()));\n\t\tids.filter((id) => !itemIds.has(id)).forEach((id: number) => {\n\t\t\tconst task = taskService.getStoreTask(id);\n\t\t\tthis.#dialog.addItem({\n\t\t\t\tid,\n\t\t\t\tentityId: EntitySelectorEntity.Task,\n\t\t\t\ttitle: task.title,\n\t\t\t\tselected: true,\n\t\t\t\tsort: 0,\n\t\t\t\ttabs: ['recents'],\n\t\t\t});\n\t\t});\n\t}\n\n\tasync #updateTask(): void\n\t{\n\t\tconst selectedItems = this.#dialog.getSelectedItems();\n\t\tconst newTaskIds = selectedItems.map((item) => Number(item.getId()));\n\t\tconst currentTaskIds = this.#task[this.#meta.idsField];\n\n\t\tconst idsToDelete = currentTaskIds.filter((id) => !newTaskIds.includes(id));\n\t\tconst idsToAdd = newTaskIds.filter((id) => !currentTaskIds.includes(id));\n\n\t\tawait Promise.all([\n\t\t\tthis.#meta.service.delete(this.#taskId, idsToDelete),\n\t\t\tthis.#add(idsToAdd),\n\t\t]);\n\n\t\tthis.#onUpdateOnce?.();\n\t\tthis.#onUpdateOnce = null;\n\t}\n\n\tasync #add(ids: number[]): Promise<void>\n\t{\n\t\tconst error = await this.#meta.service.add(this.#taskId, ids);\n\n\t\tif (error)\n\t\t{\n\t\t\tvoid relationError.setTaskId(this.#taskId).showError(error, this.#meta.id);\n\t\t}\n\t}\n\n\tget #selectableItems(): { selectable: ItemId[], unselectable: ItemId[] }\n\t{\n\t\tconst selectableIds = [];\n\t\tconst unselectableIds = [];\n\n\t\tthis.#task[this.#meta.idsField].forEach((id: number) => {\n\t\t\tconst task = taskService.getStoreTask(id);\n\t\t\tif (!task || task.rights.detachParent || task.rights.detachRelated)\n\t\t\t{\n\t\t\t\tselectableIds.push(id);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tunselectableIds.push(id);\n\t\t\t}\n\t\t});\n\n\t\treturn {\n\t\t\tselectable: this.#mapIdsToItemIds(selectableIds),\n\t\t\tunselectable: this.#mapIdsToItemIds(unselectableIds),\n\t\t};\n\t}\n\n\tget #items(): ItemId[]\n\t{\n\t\treturn this.#mapIdsToItemIds(this.#task[this.#meta.idsField]);\n\t}\n\n\t#mapIdsToItemIds(ids: number[]): ItemId[]\n\t{\n\t\treturn ids.map((id: number) => [EntitySelectorEntity.Task, id]);\n\t}\n\n\tget #task(): TaskModel\n\t{\n\t\treturn taskService.getStoreTask(this.#taskId);\n\t}\n}\n","import { Loc } from 'main.core';\nimport { TaskField } from 'tasks.v2.const';\nimport { relatedTasksService, subTasksService } from 'tasks.v2.provider.service.relation-service';\nimport type { RelationMeta } from './types';\n\nexport const subTasksMeta: RelationMeta = Object.freeze({\n\tid: TaskField.SubTasks,\n\tidsField: 'subTaskIds',\n\trelationToField: 'parentId',\n\tfooterText: Loc.getMessage('TASKS_V2_SUB_TASKS_CREATE'),\n\tservice: subTasksService,\n});\n\nexport const relatedTasksMeta: RelationMeta = Object.freeze({\n\tid: TaskField.RelatedTasks,\n\tidsField: 'relatedTaskIds',\n\trelationToField: 'relatedToTaskId',\n\tfooterText: Loc.getMessage('TASKS_V2_RELATED_TASKS_CREATE'),\n\tservice: relatedTasksService,\n});\n","import { RelationTasksDialog } from './relation-tasks-dialog';\nimport { subTasksMeta, relatedTasksMeta } from './meta';\n\nexport const subTasksDialog = new RelationTasksDialog(subTasksMeta);\nexport const relatedTasksDialog = new RelationTasksDialog(relatedTasksMeta);\nexport type { RelationTasksDialog };\n"],"names":["RelationTasksDialog","constructor","meta","setTaskId","taskId","showTo","targetNode","targetContainer","isLoaded","idsField","selectItemsByIds","setSelectableByIds","getPopup","setTargetContainer","getDialog","onUpdateOnce","callback","handleClose","ids","getSelectedItems","map","item","Number","getId","sort","join","EntitySelectorDialog","context","multiple","enableSearch","width","entities","id","EntitySelectorEntity","Task","preselectedItems","popupOptions","events","onClose","footer","Tag","render","footerText","Event","bind","EventEmitter","emit","EventName","OpenCompactCard","TaskField","Title","getActiveTab","getLastSearchQuery","getQuery","relationToField","itemIds","Set","getItems","it","filter","has","forEach","task","taskService","getStoreTask","addItem","entityId","title","selected","tabs","selectedItems","newTaskIds","currentTaskIds","idsToDelete","includes","idsToAdd","Promise","all","service","delete","error","add","relationError","showError","selectableIds","unselectableIds","rights","detachParent","detachRelated","push","selectable","unselectable","subTasksMeta","Object","freeze","SubTasks","Loc","getMessage","subTasksService","relatedTasksMeta","RelatedTasks","relatedTasksService","subTasksDialog","relatedTasksDialog"],"mappings":"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"}