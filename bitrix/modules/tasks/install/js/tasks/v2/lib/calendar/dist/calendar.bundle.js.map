{"version":3,"file":"calendar.bundle.js","sources":["../src/calendar.js"],"sourcesContent":["import { Extension, Loc } from 'main.core';\nimport { DateTimeFormat, DurationFormat } from 'main.date';\nimport { timezone } from 'tasks.v2.lib.timezone';\n\nconst settings = Extension.getSettings('tasks.v2.lib.calendar').calendarSettings;\nconst holidays = new Set(settings.HOLIDAYS.map(({ M, D }) => `${M}.${D}`));\nconst weekends = new Set(settings.WEEKEND.map((it) => ({ SU: 0, MO: 1, TU: 2, WE: 3, TH: 4, FR: 5, SA: 6 }[it])));\nconst { H: startH, M: startM } = settings.HOURS.START;\nconst { H: endH, M: endM } = settings.HOURS.END;\n\nconst dayDuration = DurationFormat.getUnitDurations().d;\nconst workdayDuration = ((endH * 60 + endM) - (startH * 60 + startM)) * 60000;\nconst workWeekDuration = workdayDuration * (7 - weekends.size);\n\nexport const calendar = new class\n{\n\tget workdayDuration(): void\n\t{\n\t\treturn workdayDuration;\n\t}\n\n\tget workdayStart(): { H: string, M: string }\n\t{\n\t\treturn settings.HOURS.START;\n\t}\n\n\tget defaultTime(): void\n\t{\n\t\treturn `${String(endH).padStart(2, '0')}:${String(endM).padStart(2, '0')}`;\n\t}\n\n\tformatDateTime(timestamp: number, { forceYear }: { forceYear: boolean } = {}): string\n\t{\n\t\tif (!timestamp)\n\t\t{\n\t\t\treturn '';\n\t\t}\n\n\t\tconst showYear = forceYear || new Date(timestamp).getFullYear() !== new Date().getFullYear();\n\t\tconst format = Loc.getMessage('TASKS_V2_DATE_TIME_FORMAT', {\n\t\t\t'#DATE#': DateTimeFormat.getFormat(showYear ? 'LONG_DATE_FORMAT' : 'DAY_MONTH_FORMAT'),\n\t\t\t'#TIME#': DateTimeFormat.getFormat('SHORT_TIME_FORMAT'),\n\t\t});\n\t\tconst offset = timezone.getOffset(timestamp);\n\n\t\treturn DateTimeFormat.format(format, (timestamp + offset) / 1000);\n\t}\n\n\tcalculateDuration(startTs: number, end: number): number\n\t{\n\t\tconst dayEnd = this.setHours(startTs, endH, endM);\n\t\tif (end < dayEnd)\n\t\t{\n\t\t\treturn end - startTs;\n\t\t}\n\n\t\tlet start = this.setHours(startTs + dayDuration, startH, startM);\n\t\tlet duration = dayEnd - startTs;\n\t\twhile (start < end)\n\t\t{\n\t\t\tif (this.isWorkDay(start))\n\t\t\t{\n\t\t\t\tduration += Math.min(start + workdayDuration, end) - start;\n\t\t\t}\n\n\t\t\tstart += dayDuration;\n\t\t}\n\n\t\treturn duration;\n\t}\n\n\tcalculateStartTs(startTs: number, endTs: number, duration: number): number\n\t{\n\t\treturn startTs ?? this.#calculateRangeTs(endTs, duration, true);\n\t}\n\n\tcalculateEndTs(startTs: number, endTs: number, durationTs: number): number\n\t{\n\t\tif (!startTs)\n\t\t{\n\t\t\treturn endTs;\n\t\t}\n\n\t\tlet duration = durationTs;\n\t\tlet start = startTs;\n\n\t\tconst daysUntilNextMonday = (1 + 7 - new Date(start - timezone.getOffset(start)).getDay()) % 7;\n\t\tconst nextMondayTs = this.setHours(start + dayDuration * daysUntilNextMonday, startH, startM);\n\t\tconst mondayDuration = this.calculateDuration(start, nextMondayTs);\n\t\tif (duration <= mondayDuration)\n\t\t{\n\t\t\treturn this.#calculateRangeTs(start, duration);\n\t\t}\n\n\t\tduration -= mondayDuration;\n\t\tstart = nextMondayTs;\n\n\t\tconst beforeSkip = new Date(start).setHours(0, 0, 0);\n\t\tconst weeks = Math.max(Math.floor(duration / workWeekDuration) - 1, 0);\n\t\tduration -= workWeekDuration * weeks;\n\t\tstart = this.setHours(start + dayDuration * weeks * 7, startH, startM);\n\t\tconst afterSkip = new Date(start).setHours(0, 0, 0) - dayDuration;\n\n\t\tconst fromYear = new Date(beforeSkip).getFullYear();\n\t\tconst toYear = new Date(afterSkip).getFullYear();\n\t\tconst missedHolidays = Array.from({ length: toYear - fromYear + 1 }, (_, i) => i + fromYear)\n\t\t\t.flatMap((year) => settings.HOLIDAYS.map(({ M, D }) => new Date(year, M - 1, D).getTime()))\n\t\t\t.filter((it) => beforeSkip <= it && it <= afterSkip && !weekends.has(new Date(it).getDay()))\n\t\t;\n\n\t\tif (missedHolidays.length > 0)\n\t\t{\n\t\t\treturn this.calculateEndTs(start, endTs, duration + workdayDuration * missedHolidays.length);\n\t\t}\n\n\t\treturn this.#calculateRangeTs(start, duration);\n\t}\n\n\t#calculateRangeTs(anchorTs: number, durationTs: number, backwards: boolean): number\n\t{\n\t\tconst direction = backwards ? -1 : 1;\n\t\tconst anchorHours = backwards ? settings.HOURS.END : settings.HOURS.START;\n\t\tconst oppositeHours = backwards ? settings.HOURS.START : settings.HOURS.END;\n\n\t\tlet anchor = anchorTs;\n\t\tlet duration = durationTs;\n\t\twhile (duration > 0)\n\t\t{\n\t\t\tif (this.isWorkDay(anchor))\n\t\t\t{\n\t\t\t\tconst dayLength = Math.abs(anchor - this.setHours(anchor, oppositeHours.H, oppositeHours.M));\n\t\t\t\tconst opposite = anchor + Math.min(dayLength, duration, workdayDuration) * direction;\n\t\t\t\tduration -= Math.abs(anchor - opposite);\n\t\t\t\tif (duration === 0)\n\t\t\t\t{\n\t\t\t\t\treturn opposite;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tanchor = this.setHours(anchor + dayDuration * direction, anchorHours.H, anchorHours.M);\n\t\t}\n\n\t\treturn anchorTs;\n\t}\n\n\tclampWorkDateTime(timestamp: ?number): ?number\n\t{\n\t\tif (!timestamp)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tlet workday = timestamp;\n\t\twhile (!this.isWorkDay(workday))\n\t\t{\n\t\t\tworkday = this.setHours(workday + dayDuration, startH, startM);\n\t\t}\n\n\t\tconst dayStart = this.setHours(workday, startH, startM);\n\t\tconst dayEnd = this.setHours(workday, endH, endM);\n\n\t\treturn Math.min(Math.max(workday, dayStart), dayEnd);\n\t}\n\n\tisWorkDay(timestamp: number): boolean\n\t{\n\t\tconst date = new Date(timestamp);\n\n\t\treturn !weekends.has(date.getUTCDay()) && !holidays.has(`${date.getUTCMonth() + 1}.${date.getUTCDate()}`);\n\t}\n\n\tsetHours(timestamp: number, hours: number, minutes: number): number\n\t{\n\t\treturn new Date(timestamp).setHours(hours, minutes, 0, 0) - timezone.getOffset(timestamp);\n\t}\n\n\tcreateDateFromUtc(date: Date): Date\n\t{\n\t\treturn new Date(\n\t\t\tdate.getUTCFullYear(),\n\t\t\tdate.getUTCMonth(),\n\t\t\tdate.getUTCDate(),\n\t\t\tdate.getUTCHours(),\n\t\t\tdate.getUTCMinutes(),\n\t\t);\n\t}\n}();\n"],"names":["settings","Extension","getSettings","calendarSettings","holidays","Set","HOLIDAYS","map","M","D","weekends","WEEKEND","it","SU","MO","TU","WE","TH","FR","SA","H","startH","startM","HOURS","START","endH","endM","END","dayDuration","DurationFormat","getUnitDurations","d","workdayDuration","workWeekDuration","size","calendar","workdayStart","defaultTime","String","padStart","formatDateTime","timestamp","forceYear","showYear","Date","getFullYear","format","Loc","getMessage","DateTimeFormat","getFormat","offset","timezone","getOffset","calculateDuration","startTs","end","dayEnd","setHours","start","duration","isWorkDay","Math","min","calculateStartTs","endTs","calculateEndTs","durationTs","daysUntilNextMonday","getDay","nextMondayTs","mondayDuration","beforeSkip","weeks","max","floor","afterSkip","fromYear","toYear","missedHolidays","Array","from","length","_","i","flatMap","year","getTime","filter","has","clampWorkDateTime","workday","dayStart","date","getUTCDay","getUTCMonth","getUTCDate","hours","minutes","createDateFromUtc","getUTCFullYear","getUTCHours","getUTCMinutes","anchorTs","backwards","direction","anchorHours","oppositeHours","anchor","dayLength","abs","opposite"],"mappings":"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"}