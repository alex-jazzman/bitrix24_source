{"version":3,"file":"script.js","sources":["src/script.js"],"sourcesContent":["import { ajax, Event, Dom, Tag, Reflection, Type, Text } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport { Api } from 'sign.v2.api';\nimport { UserSelector } from 'ui.form-elements.view';\n\nconst namespace = Reflection.namespace('BX.Sign');\n\nconst roles = {\n\tHEAD: '1',\n\tDEPUTY_HEAD: '3',\n};\n\nconst responsibleSelector = '#id_responsible';\nconst assigneeSelector = '#id_representative';\nconst reviewerSelector = '#id_reviewer';\nconst editorSelector = '#id_editor';\n\ntype DocumentData = {\n\ttitle: string;\n\tdocument_uid: string;\n\tresponsibleSelectorValue: number | string | null;\n\tassigneeSelectorValue: number | string | null;\n\teditorSelectorValue?: number | string | null;\n\treviewerSelectorValue?: number | string | null;\n}\n\nexport class SignB2EDocumentActivity extends EventEmitter\n{\n\t#buttonNode: HTMLElement | null = null;\n\t#select: HTMLElement | null = null;\n\t#documentType: Array = [];\n\t#formName: string;\n\t#api: Api;\n\t#templateId: string;\n\t#previousData = {};\n\n\tconstructor(options: Object)\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace('BX.Sign.SignB2EDocumentActivity');\n\t\tthis.#buttonNode = options.buttonNode;\n\t\tthis.#documentType = options.documentType;\n\t\tthis.#select = options.select;\n\t\tthis.#api = new Api();\n\t\tthis.#templateId = options.templateId;\n\n\t\tif (!Type.isStringFilled(options.formName))\n\t\t{\n\t\t\tthrow new Error('formName must be filled string');\n\t\t}\n\t\tthis.#formName = options.formName;\n\t}\n\n\tinit(): void\n\t{\n\t\tthis.#setTemplateList();\n\n\t\tif (!this.#buttonNode)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tEvent.bind(this.#buttonNode, 'click', this.#openSlider.bind(this));\n\t}\n\n\t#openSlider(): void\n\t{\n\t\tBX.SidePanel.Instance.open('/sign/b2e/doc/0/?mode=template&IFRAME=Y&IFRAME_TYPE=SIDE_SLIDER&FROM_ROBOT=1', {\n\t\t\twidth: 1250,\n\t\t\tcacheable: false,\n\t\t\tevents: {\n\t\t\t\tonClose: (event: BX.SidePanel.Event): void => {\n\t\t\t\t\tthis.#onSliderClose(event);\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t}\n\n\tasync #onSliderClose(event: BX.SidePanel.Event): void\n\t{\n\t\tconst slider = event.getSlider();\n\t\tif (slider)\n\t\t{\n\t\t\tthis.#setTemplateList(true, true);\n\t\t}\n\t}\n\n\t#setTemplateList(needUpdateTagSelectors: boolean = false, isSliderClose: boolean = false): void\n\t{\n\t\tthis.#loadTemplatesList()\n\t\t\t.then(({ data }): void => {\n\t\t\t\tif (Type.isPlainObject(data))\n\t\t\t\t{\n\t\t\t\t\tthis.#updateTemplateListSelect(data, isSliderClose);\n\n\t\t\t\t\tObject.entries(this.#getUserSelectorsMap()).forEach(([key, selector]) => {\n\t\t\t\t\t\tconst dialog = this.#getDialog(selector);\n\t\t\t\t\t\tif (dialog === null)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tdialog.subscribe('onLoad', () => {\n\t\t\t\t\t\t\tconst templateId = this.#templateId === '' ? 0 : this.#templateId;\n\t\t\t\t\t\t\tconst defaultUserId = Object.values(data)[templateId]?.[`${key}SelectorValue`];\n\t\t\t\t\t\t\tif (defaultUserId)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.#setSelectorValues([defaultUserId], selector);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tdialog.load();\n\t\t\t\t\t});\n\n\t\t\t\t\tif (needUpdateTagSelectors === true)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#updateTagSelectors(data);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.#select.onchange = () => {\n\t\t\t\t\t\tthis.#updateTagSelectors(data);\n\t\t\t\t\t};\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch((response): void => console.error(response.errors))\n\t\t;\n\t}\n\n\t#setSelectorValues(selectorValues: Array | null, selector: string): void\n\t{\n\t\tconst dialog = this.#getDialog(selector);\n\t\tif (dialog === null)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tdialog.getSelectedItems().forEach(\n\t\t\t(item) => {\n\t\t\t\titem.deselect();\n\t\t\t},\n\t\t);\n\n\t\tselectorValues.forEach((value) => {\n\t\t\tlet item = null;\n\t\t\tconst roleId = roles[value];\n\t\t\tif (roleId !== undefined)\n\t\t\t{\n\t\t\t\titem = dialog.getItem([roleId, value]);\n\t\t\t}\n\t\t\telse if (Type.isInteger(Number(value)))\n\t\t\t{\n\t\t\t\titem = dialog.getItem(['user', value]);\n\t\t\t}\n\n\t\t\tif (item)\n\t\t\t{\n\t\t\t\titem.select();\n\t\t\t}\n\t\t});\n\t}\n\n\t#getUserSelectorsMap(): Record<string, string>\n\t{\n\t\treturn {\n\t\t\tresponsible: responsibleSelector,\n\t\t\tassignee: assigneeSelector,\n\t\t\treviewer: reviewerSelector,\n\t\t\teditor: editorSelector,\n\t\t};\n\t}\n\n\t#getDialog(selector: string): ?Dialog\n\t{\n\t\tconst userSelector = this.#getUserSelector(selector);\n\t\tif (!userSelector)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn userSelector.tagSelector.getDialog();\n\t}\n\n\t#getUserSelector(selector: string): ?UserSelector\n\t{\n\t\treturn BX.Bizproc.UserSelector.getByNode(document.querySelector(selector));\n\t}\n\n\t#updateTemplateListSelect(data: Object, isSliderClose: boolean): void\n\t{\n\t\tif (this.#previousData && isSliderClose)\n\t\t{\n\t\t\tconst previousFirstTemplateId = Object.keys(this.#previousData)[0];\n\t\t\tconst currentFirstTemplateId = Object.keys(data)[0];\n\n\t\t\tif (previousFirstTemplateId !== currentFirstTemplateId)\n\t\t\t{\n\t\t\t\tthis.#templateId = currentFirstTemplateId;\n\t\t\t}\n\t\t}\n\n\t\tif (this.#select)\n\t\t{\n\t\t\tthis.#select.innerHTML = '';\n\t\t}\n\n\t\tObject.entries(data).forEach(([id, { title }]): void => {\n\t\t\tconst selected = this.#templateId === id ? 'selected' : '';\n\t\t\tconst idValue = Text.encode(id);\n\t\t\tconst titleValue = Text.encode(title);\n\t\t\tconst option = Tag.render`<option value=\"${idValue}\" ${selected}>${titleValue}</option>`;\n\t\t\tDom.append(option, this.#select);\n\t\t});\n\n\t\tthis.#previousData = { ...data };\n\t}\n\n\t#updateTagSelectors(data: Record<string, DocumentData>): void\n\t{\n\t\tconst selectedId = this.#select.value;\n\t\tif (!(selectedId in data))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst selectedItem = data[selectedId];\n\t\tif (selectedItem)\n\t\t{\n\t\t\tthis.#selectMembers(selectedItem);\n\t\t}\n\t}\n\n\t#selectMembers(selectedItem: Object): void\n\t{\n\t\tif (selectedItem)\n\t\t{\n\t\t\tthis.#setSelectorValues([selectedItem.responsibleSelectorValue], responsibleSelector);\n\t\t\tthis.#setSelectorValues([selectedItem.assigneeSelectorValue], assigneeSelector);\n\t\t\tthis.#setSelectorValues(selectedItem.reviewerSelectorValue, reviewerSelector);\n\t\t\tthis.#setSelectorValues([selectedItem.editorSelectorValue], editorSelector);\n\t\t}\n\t}\n\n\t#loadTemplatesList(): Promise\n\t{\n\t\treturn ajax.runAction(\n\t\t\t'bizproc.activity.request',\n\t\t\t{\n\t\t\t\tdata: {\n\t\t\t\t\tactivity: 'SignB2EDocumentActivity',\n\t\t\t\t\tdocumentType: this.#documentType,\n\t\t\t\t\tparams: {\n\t\t\t\t\t\tform_name: this.#formName,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\t}\n}\n\nnamespace.SignB2EDocumentActivity = SignB2EDocumentActivity;\n"],"names":["namespace","Reflection","roles","HEAD","DEPUTY_HEAD","responsibleSelector","assigneeSelector","reviewerSelector","editorSelector","SignB2EDocumentActivity","EventEmitter","constructor","options","setEventNamespace","buttonNode","documentType","select","Api","templateId","Type","isStringFilled","formName","Error","init","Event","bind","BX","SidePanel","Instance","open","width","cacheable","events","onClose","event","slider","getSlider","needUpdateTagSelectors","isSliderClose","then","data","isPlainObject","Object","entries","forEach","key","selector","dialog","subscribe","defaultUserId","values","load","onchange","catch","response","console","error","errors","selectorValues","getSelectedItems","item","deselect","value","roleId","undefined","getItem","isInteger","Number","responsible","assignee","reviewer","editor","userSelector","tagSelector","getDialog","Bizproc","UserSelector","getByNode","document","querySelector","previousFirstTemplateId","keys","currentFirstTemplateId","innerHTML","id","title","selected","idValue","Text","encode","titleValue","option","Tag","render","Dom","append","selectedId","selectedItem","responsibleSelectorValue","assigneeSelectorValue","reviewerSelectorValue","editorSelectorValue","ajax","runAction","activity","params","form_name"],"mappings":"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"}