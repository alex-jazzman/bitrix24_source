this.BX=this.BX||{};this.BX.Sign=this.BX.Sign||{};(function(e,s,a,t,l,i,o,r){"use strict";let n=e=>e,c,d;var b=babelHelpers.classPrivateFieldLooseKey("notificationContainer");var p=babelHelpers.classPrivateFieldLooseKey("changeDomainWarningContainer");var v=babelHelpers.classPrivateFieldLooseKey("scenarioType");var h=babelHelpers.classPrivateFieldLooseKey("api");var u=babelHelpers.classPrivateFieldLooseKey("uids");var P=babelHelpers.classPrivateFieldLooseKey("documentMode");var B=babelHelpers.classPrivateFieldLooseKey("chatId");var F=babelHelpers.classPrivateFieldLooseKey("actionMode");var L=babelHelpers.classPrivateFieldLooseKey("initNotifications");var g=babelHelpers.classPrivateFieldLooseKey("isChatCreated");var H=babelHelpers.classPrivateFieldLooseKey("appendChatWarningContainer");var y=babelHelpers.classPrivateFieldLooseKey("register");var m=babelHelpers.classPrivateFieldLooseKey("changeDocumentBlank");var f=babelHelpers.classPrivateFieldLooseKey("getPages");var S=babelHelpers.classPrivateFieldLooseKey("convertToBase64");var k=babelHelpers.classPrivateFieldLooseKey("setDocumentData");var D=babelHelpers.classPrivateFieldLooseKey("processPages");var w=babelHelpers.classPrivateFieldLooseKey("appendUnsecuredSchemeWarningContainer");var _=babelHelpers.classPrivateFieldLooseKey("appendChangeDomainWarningContainer");var I=babelHelpers.classPrivateFieldLooseKey("getWarning");var T=babelHelpers.classPrivateFieldLooseKey("removeChangeDomainWarningContainer");var C=babelHelpers.classPrivateFieldLooseKey("appendEdoWarningContainer");class E extends a.EventEmitter{constructor(e){super();Object.defineProperty(this,C,{value:$});Object.defineProperty(this,T,{value:V});Object.defineProperty(this,I,{value:x});Object.defineProperty(this,_,{value:W});Object.defineProperty(this,w,{value:G});Object.defineProperty(this,D,{value:R});Object.defineProperty(this,k,{value:X});Object.defineProperty(this,S,{value:K});Object.defineProperty(this,f,{value:j});Object.defineProperty(this,m,{value:A});Object.defineProperty(this,y,{value:U});Object.defineProperty(this,H,{value:M});Object.defineProperty(this,g,{value:N});Object.defineProperty(this,L,{value:O});Object.defineProperty(this,b,{writable:true,value:void 0});Object.defineProperty(this,p,{writable:true,value:void 0});Object.defineProperty(this,v,{writable:true,value:void 0});Object.defineProperty(this,h,{writable:true,value:void 0});Object.defineProperty(this,u,{writable:true,value:void 0});Object.defineProperty(this,P,{writable:true,value:void 0});Object.defineProperty(this,B,{writable:true,value:void 0});Object.defineProperty(this,F,{writable:true,value:"create"});this.setEventNamespace("BX.Sign.V2.DocumentSetup");this.blankSelector=new t.BlankSelector({...e,events:{toggleSelection:({data:e})=>{this.emit("toggleActivity",{...e,blankSelector:this.blankSelector})},addFile:({data:e})=>{this.emit("addFile",{ready:this.blankSelector.isFilesReadyForUpload()})},removeFile:()=>this.emit("removeFile",{ready:this.blankSelector.isFilesReadyForUpload()}),clearFiles:()=>this.emit("clearFiles")}});const{type:s,portalConfig:a,documentMode:i,chatId:o}=e;this.setupData=null;this.blankIsNotSelected=true;babelHelpers.classPrivateFieldLooseBase(this,v)[v]=s;babelHelpers.classPrivateFieldLooseBase(this,h)[h]=new l.Api;babelHelpers.classPrivateFieldLooseBase(this,u)[u]=new Map;babelHelpers.classPrivateFieldLooseBase(this,P)[P]=i;babelHelpers.classPrivateFieldLooseBase(this,B)[B]=o;this.initLayout();babelHelpers.classPrivateFieldLooseBase(this,L)[L](a)}initLayout(){this.layout=s.Tag.render(c||(c=n`
			<div class="sign-document-setup">
				<p class="sign-document-setup__add-title">
					${0}
				</p>
				${0}
			</div>
		`),s.Loc.getMessage("SIGN_DOCUMENT_SETUP_ADD_TITLE"),this.blankSelector.getLayout())}isSameBlankSelected(){var e;const{selectedBlankId:s}=this.blankSelector;const{blankId:a}=(e=this.setupData)!=null?e:{};return s>0&&a===s}handleError(e){babelHelpers.classPrivateFieldLooseBase(this,k)[k](null);this.blankSelector.resetSelectedBlank();this.blankSelector.deleteBlank(e)}loadBlocks(e){return babelHelpers.classPrivateFieldLooseBase(this,h)[h].loadBlocksByDocument(e)}async setup(e,a=false,t=false){babelHelpers.classPrivateFieldLooseBase(this,F)[F]=s.Type.isStringFilled(e)?"edit":"create";if(this.isSameBlankSelected()){this.setupData={...this.setupData,isTemplate:true};return}const{selectedBlankId:l}=this.blankSelector;let i=0;try{if(e){const[s,a]=await Promise.all([babelHelpers.classPrivateFieldLooseBase(this,h)[h].loadDocument(e),this.loadBlocks(e)]);babelHelpers.classPrivateFieldLooseBase(this,k)[k]({...s,blocks:a,isTemplate:true});const{blankId:t}=s;this.blankIsNotSelected=false;if(!this.blankSelector.hasBlank(t)){await this.blankSelector.loadBlankById(t)}this.blankSelector.selectBlank(t,{isInitial:true})}else{var o;this.ready=false;const e=l||this.blankSelector.isFilesReadyForUpload();i=l||await this.blankSelector.createBlank();if(!i){this.blankIsNotSelected=true;return}let s=(o=this.setupData)==null?void 0:o.uid;let r=null;if(e&&a&&s){const{templateUid:e}=await babelHelpers.classPrivateFieldLooseBase(this,m)[m](s,i,t);r=e}else{const e=babelHelpers.classPrivateFieldLooseBase(this,u)[u].has(i);const{uid:l,templateUid:o}=e?await babelHelpers.classPrivateFieldLooseBase(this,m)[m](babelHelpers.classPrivateFieldLooseBase(this,u)[u].get(i),i,t):await babelHelpers.classPrivateFieldLooseBase(this,y)[y](i,a,babelHelpers.classPrivateFieldLooseBase(this,B)[B]);s=l;r=o}babelHelpers.classPrivateFieldLooseBase(this,u)[u].set(i,s);await babelHelpers.classPrivateFieldLooseBase(this,h)[h].upload(s);const[n,c]=await Promise.all([babelHelpers.classPrivateFieldLooseBase(this,h)[h].loadDocument(s),babelHelpers.classPrivateFieldLooseBase(this,h)[h].loadBlocksByDocument(s)]);const d=Boolean(l);babelHelpers.classPrivateFieldLooseBase(this,k)[k]({...n,blocks:c,isTemplate:d,templateUid:r})}}catch{this.handleError(i)}this.ready=true}async waitForPagesList(e,s,a=false){let t=0;let l=false;const i=10*1e3;const{uid:o,blankId:r,isTemplate:n}=e;if(!n){this.blankSelector.selectBlank(r)}this.emit("toggleActivity",{selected:false});const c=[new Promise((e=>{var s;(s=BX.PULL)==null?void 0:s.subscribe({moduleId:"sign",command:"blankIsReady",callback:s=>{if(!l&&s!=null&&s.pages&&(s==null?void 0:s.uid)===o){e(s==null?void 0:s.pages)}}})})),new Promise((e=>{t=setInterval((async()=>{if(l){clearInterval(t);return}const s=await babelHelpers.classPrivateFieldLooseBase(this,f)[f](o);if(s.length>0){e(s)}}),i)}))];if(a){c.push(new Promise((e=>{babelHelpers.classPrivateFieldLooseBase(this,f)[f](o).then((s=>{if(s.length>0){e(s)}}))})))}const d=await Promise.race(c);if(!n){const e=this.blankSelector.getBlank(r);e.setPreview(d[0].url)}let b=null;if(this.isTemplateMode()){b=await this.loadBlocks(o);this.setupData.blocks=b}clearInterval(t);l=true;await babelHelpers.classPrivateFieldLooseBase(this,D)[D](d,s,b)}set ready(e){if(e){s.Dom.removeClass(this.layout,"--pending")}else{s.Dom.addClass(this.layout,"--pending")}}isTemplateMode(){return i.isTemplateMode(babelHelpers.classPrivateFieldLooseBase(this,P)[P])}deleteDocumentFromList(e){babelHelpers.classPrivateFieldLooseBase(this,u)[u].delete(e)}getActionMode(){return babelHelpers.classPrivateFieldLooseBase(this,F)[F]}isEditActionMode(){return this.getActionMode()==="edit"}}function O(e){babelHelpers.classPrivateFieldLooseBase(this,b)[b]=s.Tag.render(d||(d=n`<div></div>`));const a=this.layout.querySelector(".sign-blank-selector__tile-widget");s.Dom.insertBefore(babelHelpers.classPrivateFieldLooseBase(this,b)[b],a);const{isDomainChanged:t,isEdoRegion:l,isUnsecuredScheme:i}=e;if(babelHelpers.classPrivateFieldLooseBase(this,g)[g]()&&babelHelpers.classPrivateFieldLooseBase(this,v)[v]!=="b2e"){babelHelpers.classPrivateFieldLooseBase(this,H)[H]()}if(t){babelHelpers.classPrivateFieldLooseBase(this,_)[_]()}if(i){babelHelpers.classPrivateFieldLooseBase(this,w)[w]()}if(l&&babelHelpers.classPrivateFieldLooseBase(this,v)[v]!=="b2e"){babelHelpers.classPrivateFieldLooseBase(this,C)[C]()}}function N(){return babelHelpers.classPrivateFieldLooseBase(this,B)[B]>0}function M(){const e=`<div>${s.Loc.getMessage("SIGN_DOCUMENT_SETUP_COLLAB_WARNING")}</div>`;const a=babelHelpers.classPrivateFieldLooseBase(this,I)[I]();a.setText(e);s.Dom.append(a.getContainer(),babelHelpers.classPrivateFieldLooseBase(this,b)[b])}async function U(e,s=false,a=0){const t=await babelHelpers.classPrivateFieldLooseBase(this,h)[h].register(e,babelHelpers.classPrivateFieldLooseBase(this,v)[v],s,a);return t!=null?t:{}}async function A(e,s,a=false){const t=await babelHelpers.classPrivateFieldLooseBase(this,h)[h].changeBlank(e,s,a);return t!=null?t:{}}async function j(e){var s;const a=await babelHelpers.classPrivateFieldLooseBase(this,h)[h].getPages(e);return(s=a.pages)!=null?s:[]}async function K(e){const a=e.map((async e=>{const a=await fetch(e.url);const t=await a.blob();const l=new FileReader;await new Promise((e=>{s.Event.bindOnce(l,"loadend",e);l.readAsDataURL(t)}));return l.result}));return Promise.all(a)}function X(e){this.setupData=e;this.blankSelector.clearFiles({removeFromServer:false})}async function R(e,s,a){let t=0;const l=3;while(t<e.length){const i=e.slice(t,t+l);const o=await babelHelpers.classPrivateFieldLooseBase(this,S)[S](i);this.emit("toggleActivity",{selected:true});t+=l;s(o,e.length,a)}}function G(){const e=`<div>${s.Loc.getMessage("SIGN_DOCUMENT_SETUP_USE_UNSECURED_SCHEME_WARNING")}</div>`;const a=babelHelpers.classPrivateFieldLooseBase(this,I)[I]();a.setText(e);s.Dom.append(a.getContainer(),babelHelpers.classPrivateFieldLooseBase(this,b)[b])}function W(){const e=new o.Button({text:s.Loc.getMessage("SIGN_DOCUMENT_SETUP_REFRESH_DOMAIN_BUTTON_TEXT"),color:o.Button.Color.LINK,onclick:()=>babelHelpers.classPrivateFieldLooseBase(this,h)[h].changeDomain().then((()=>babelHelpers.classPrivateFieldLooseBase(this,T)[T]())),className:"sign-document-setup__change-domain-button",size:o.Button.Size.EXTRA_SMALL});const a=`<p>${s.Loc.getMessage("SIGN_DOCUMENT_SETUP_CHANGE_DOMAIN_WARNING")}</p>`;const t=babelHelpers.classPrivateFieldLooseBase(this,I)[I]();t.setText(a);babelHelpers.classPrivateFieldLooseBase(this,p)[p]=t.getContainer();s.Dom.append(e.getContainer(),babelHelpers.classPrivateFieldLooseBase(this,p)[p]);s.Dom.append(babelHelpers.classPrivateFieldLooseBase(this,p)[p],babelHelpers.classPrivateFieldLooseBase(this,b)[b])}function x(){return new r.Alert({size:r.Alert.Size.MD,color:r.Alert.Color.WARNING,icon:r.Alert.Icon.DANGER,customClass:"sign-document-setup__change-domain-wrapper"})}function V(){s.Dom.remove(babelHelpers.classPrivateFieldLooseBase(this,p)[p])}function $(){const e=s.Loc.getMessage("SIGN_DOCUMENT_SETUP_EDO_TEXT",{"[helpdesklink]":'<a class="sign-document-setup__helpdesk-article" href="javascript:top.BX.Helper.show(\'redirect=detail&code=18453372\');">',"[/helpdesklink]":"</a>"});const a=babelHelpers.classPrivateFieldLooseBase(this,I)[I]();a.setColor(r.Alert.Color.PRIMARY);a.setIcon(r.Alert.Icon.INFO);a.setText(e);s.Dom.append(a.getContainer(),babelHelpers.classPrivateFieldLooseBase(this,b)[b])}e.DocumentSetup=E})(this.BX.Sign.V2=this.BX.Sign.V2||{},BX,BX.Event,BX.Sign.V2,BX.Sign.V2,BX.Sign.V2,BX.UI,BX.UI);
//# sourceMappingURL=document-setup.bundle.map.js