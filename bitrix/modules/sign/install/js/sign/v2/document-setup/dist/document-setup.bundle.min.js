this.BX=this.BX||{};this.BX.Sign=this.BX.Sign||{};(function(e,s,a,t,l,i,o,r){"use strict";let n=e=>e,c,d;var b=babelHelpers.classPrivateFieldLooseKey("notificationContainer");var p=babelHelpers.classPrivateFieldLooseKey("changeDomainWarningContainer");var v=babelHelpers.classPrivateFieldLooseKey("scenarioType");var h=babelHelpers.classPrivateFieldLooseKey("api");var u=babelHelpers.classPrivateFieldLooseKey("uids");var P=babelHelpers.classPrivateFieldLooseKey("documentMode");var B=babelHelpers.classPrivateFieldLooseKey("chatId");var F=babelHelpers.classPrivateFieldLooseKey("actionMode");var L=babelHelpers.classPrivateFieldLooseKey("templateFolderId");var g=babelHelpers.classPrivateFieldLooseKey("initNotifications");var H=babelHelpers.classPrivateFieldLooseKey("isChatCreated");var y=babelHelpers.classPrivateFieldLooseKey("appendChatWarningContainer");var m=babelHelpers.classPrivateFieldLooseKey("register");var f=babelHelpers.classPrivateFieldLooseKey("changeDocumentBlank");var S=babelHelpers.classPrivateFieldLooseKey("getPages");var k=babelHelpers.classPrivateFieldLooseKey("convertToBase64");var D=babelHelpers.classPrivateFieldLooseKey("setDocumentData");var w=babelHelpers.classPrivateFieldLooseKey("processPages");var I=babelHelpers.classPrivateFieldLooseKey("appendUnsecuredSchemeWarningContainer");var _=babelHelpers.classPrivateFieldLooseKey("appendChangeDomainWarningContainer");var T=babelHelpers.classPrivateFieldLooseKey("getWarning");var C=babelHelpers.classPrivateFieldLooseKey("removeChangeDomainWarningContainer");var E=babelHelpers.classPrivateFieldLooseKey("appendEdoWarningContainer");class O extends a.EventEmitter{constructor(e){super();Object.defineProperty(this,E,{value:z});Object.defineProperty(this,C,{value:$});Object.defineProperty(this,T,{value:V});Object.defineProperty(this,_,{value:x});Object.defineProperty(this,I,{value:W});Object.defineProperty(this,w,{value:G});Object.defineProperty(this,D,{value:R});Object.defineProperty(this,k,{value:X});Object.defineProperty(this,S,{value:K});Object.defineProperty(this,f,{value:j});Object.defineProperty(this,m,{value:A});Object.defineProperty(this,y,{value:U});Object.defineProperty(this,H,{value:M});Object.defineProperty(this,g,{value:N});Object.defineProperty(this,b,{writable:true,value:void 0});Object.defineProperty(this,p,{writable:true,value:void 0});Object.defineProperty(this,v,{writable:true,value:void 0});Object.defineProperty(this,h,{writable:true,value:void 0});Object.defineProperty(this,u,{writable:true,value:void 0});Object.defineProperty(this,P,{writable:true,value:void 0});Object.defineProperty(this,B,{writable:true,value:void 0});Object.defineProperty(this,F,{writable:true,value:"create"});Object.defineProperty(this,L,{writable:true,value:void 0});this.setEventNamespace("BX.Sign.V2.DocumentSetup");this.blankSelector=new t.BlankSelector({...e,events:{toggleSelection:({data:e})=>{this.emit("toggleActivity",{...e,blankSelector:this.blankSelector})},addFile:({data:e})=>{this.emit("addFile",{ready:this.blankSelector.isFilesReadyForUpload()})},removeFile:()=>this.emit("removeFile",{ready:this.blankSelector.isFilesReadyForUpload()}),clearFiles:()=>this.emit("clearFiles")}});const{type:s,portalConfig:a,documentMode:i,chatId:o,templateFolderId:r}=e;this.setupData=null;this.blankIsNotSelected=true;babelHelpers.classPrivateFieldLooseBase(this,v)[v]=s;babelHelpers.classPrivateFieldLooseBase(this,h)[h]=new l.Api;babelHelpers.classPrivateFieldLooseBase(this,u)[u]=new Map;babelHelpers.classPrivateFieldLooseBase(this,P)[P]=i;babelHelpers.classPrivateFieldLooseBase(this,L)[L]=r;babelHelpers.classPrivateFieldLooseBase(this,B)[B]=o;this.initLayout();babelHelpers.classPrivateFieldLooseBase(this,g)[g](a)}initLayout(){this.layout=s.Tag.render(c||(c=n`
			<div class="sign-document-setup">
				<p class="sign-document-setup__add-title">
					${0}
				</p>
				${0}
			</div>
		`),s.Loc.getMessage("SIGN_DOCUMENT_SETUP_ADD_TITLE"),this.blankSelector.getLayout())}isSameBlankSelected(){var e;const{selectedBlankId:s}=this.blankSelector;const{blankId:a}=(e=this.setupData)!=null?e:{};return s>0&&a===s}handleError(e){babelHelpers.classPrivateFieldLooseBase(this,D)[D](null);this.blankSelector.resetSelectedBlank();this.blankSelector.deleteBlank(e)}loadBlocks(e){return babelHelpers.classPrivateFieldLooseBase(this,h)[h].loadBlocksByDocument(e)}async setup(e,a=false,t=false,l=null){babelHelpers.classPrivateFieldLooseBase(this,F)[F]=s.Type.isStringFilled(e)?"edit":"create";if(this.isSameBlankSelected()){this.setupData={...this.setupData,isTemplate:true};return}const{selectedBlankId:i}=this.blankSelector;let o=0;try{if(e){const[s,a]=await Promise.all([babelHelpers.classPrivateFieldLooseBase(this,h)[h].loadDocument(e),this.loadBlocks(e)]);babelHelpers.classPrivateFieldLooseBase(this,D)[D]({...s,blocks:a,isTemplate:true});const{blankId:t}=s;this.blankIsNotSelected=false;if(!this.blankSelector.hasBlank(t)){await this.blankSelector.loadBlankById(t)}this.blankSelector.selectBlank(t,{isInitial:true})}else{var r;this.ready=false;const e=i||this.blankSelector.isFilesReadyForUpload();o=i||await this.blankSelector.createBlank();if(!o){this.blankIsNotSelected=true;return}let s=(r=this.setupData)==null?void 0:r.uid;let n=null;if(e&&a&&s){const{templateUid:e}=await babelHelpers.classPrivateFieldLooseBase(this,f)[f](s,o,t);n=e}else{const e=babelHelpers.classPrivateFieldLooseBase(this,u)[u].has(o);const{uid:i,templateUid:r}=e?await babelHelpers.classPrivateFieldLooseBase(this,f)[f](babelHelpers.classPrivateFieldLooseBase(this,u)[u].get(o),o,t):await babelHelpers.classPrivateFieldLooseBase(this,m)[m](o,a,babelHelpers.classPrivateFieldLooseBase(this,B)[B],l);s=i;n=r}babelHelpers.classPrivateFieldLooseBase(this,u)[u].set(o,s);await babelHelpers.classPrivateFieldLooseBase(this,h)[h].upload(s);const[c,d]=await Promise.all([babelHelpers.classPrivateFieldLooseBase(this,h)[h].loadDocument(s),babelHelpers.classPrivateFieldLooseBase(this,h)[h].loadBlocksByDocument(s)]);const b=Boolean(i);babelHelpers.classPrivateFieldLooseBase(this,D)[D]({...c,blocks:d,isTemplate:b,templateUid:n})}}catch{this.handleError(o)}this.ready=true}async waitForPagesList(e,a,t=false,l=true){let i=0;let o=false;const r=10*1e3;const{uid:n,blankId:c,isTemplate:d}=e;if(!d&&l){this.blankSelector.selectBlank(c)}this.emit("toggleActivity",{selected:false});const b=[new Promise((e=>{var s;(s=BX.PULL)==null?void 0:s.subscribe({moduleId:"sign",command:"blankIsReady",callback:s=>{if(!o&&s!=null&&s.pages&&(s==null?void 0:s.uid)===n){e(s==null?void 0:s.pages)}}})})),new Promise((e=>{i=setInterval((async()=>{if(o){clearInterval(i);return}const s=await babelHelpers.classPrivateFieldLooseBase(this,S)[S](n);if(s.length>0){e(s)}}),r)}))];if(t){b.push(new Promise((e=>{babelHelpers.classPrivateFieldLooseBase(this,S)[S](n).then((s=>{if(s.length>0){e(s)}}))})))}const p=await Promise.race(b);if(!d&&p.length>0){const e=this.blankSelector.getBlank(c);if(!s.Type.isNil(e)){e.setPreview(p[0].url)}}let v=null;if(this.isTemplateMode()){v=await this.loadBlocks(n);this.setupData.blocks=v}clearInterval(i);o=true;await babelHelpers.classPrivateFieldLooseBase(this,w)[w](p,a,v)}set ready(e){if(e){s.Dom.removeClass(this.layout,"--pending")}else{s.Dom.addClass(this.layout,"--pending")}}isTemplateMode(){return i.isTemplateMode(babelHelpers.classPrivateFieldLooseBase(this,P)[P])}deleteDocumentFromList(e){babelHelpers.classPrivateFieldLooseBase(this,u)[u].delete(e)}getActionMode(){return babelHelpers.classPrivateFieldLooseBase(this,F)[F]}isEditActionMode(){return this.getActionMode()==="edit"}}function N(e){babelHelpers.classPrivateFieldLooseBase(this,b)[b]=s.Tag.render(d||(d=n`<div></div>`));const a=this.layout.querySelector(".sign-blank-selector__tile-widget");s.Dom.insertBefore(babelHelpers.classPrivateFieldLooseBase(this,b)[b],a);const{isDomainChanged:t,isEdoRegion:l,isUnsecuredScheme:i}=e;if(babelHelpers.classPrivateFieldLooseBase(this,H)[H]()&&babelHelpers.classPrivateFieldLooseBase(this,v)[v]!=="b2e"){babelHelpers.classPrivateFieldLooseBase(this,y)[y]()}if(t){babelHelpers.classPrivateFieldLooseBase(this,_)[_]()}if(i){babelHelpers.classPrivateFieldLooseBase(this,I)[I]()}if(l&&babelHelpers.classPrivateFieldLooseBase(this,v)[v]!=="b2e"){babelHelpers.classPrivateFieldLooseBase(this,E)[E]()}}function M(){return babelHelpers.classPrivateFieldLooseBase(this,B)[B]>0}function U(){const e=`<div>${s.Loc.getMessage("SIGN_DOCUMENT_SETUP_COLLAB_WARNING")}</div>`;const a=babelHelpers.classPrivateFieldLooseBase(this,T)[T]();a.setText(e);s.Dom.append(a.getContainer(),babelHelpers.classPrivateFieldLooseBase(this,b)[b])}async function A(e,s=false,a=0,t=null){const l=await babelHelpers.classPrivateFieldLooseBase(this,h)[h].register(e,babelHelpers.classPrivateFieldLooseBase(this,v)[v],s,a,babelHelpers.classPrivateFieldLooseBase(this,L)[L],t);return l!=null?l:{}}async function j(e,s,a=false){const t=await babelHelpers.classPrivateFieldLooseBase(this,h)[h].changeBlank(e,s,a);return t!=null?t:{}}async function K(e){var s;const a=await babelHelpers.classPrivateFieldLooseBase(this,h)[h].getPages(e);return(s=a.pages)!=null?s:[]}async function X(e){const a=e.map((async e=>{const a=await fetch(e.url);const t=await a.blob();const l=new FileReader;await new Promise((e=>{s.Event.bindOnce(l,"loadend",e);l.readAsDataURL(t)}));return l.result}));return Promise.all(a)}function R(e){this.setupData=e;this.blankSelector.clearFiles({removeFromServer:false})}async function G(e,s,a){let t=0;const l=3;while(t<e.length){const i=e.slice(t,t+l);const o=await babelHelpers.classPrivateFieldLooseBase(this,k)[k](i);this.emit("toggleActivity",{selected:true});t+=l;s(o,e.length,a)}}function W(){const e=`<div>${s.Loc.getMessage("SIGN_DOCUMENT_SETUP_USE_UNSECURED_SCHEME_WARNING")}</div>`;const a=babelHelpers.classPrivateFieldLooseBase(this,T)[T]();a.setText(e);s.Dom.append(a.getContainer(),babelHelpers.classPrivateFieldLooseBase(this,b)[b])}function x(){const e=new o.Button({text:s.Loc.getMessage("SIGN_DOCUMENT_SETUP_REFRESH_DOMAIN_BUTTON_TEXT"),color:o.Button.Color.LINK,onclick:()=>babelHelpers.classPrivateFieldLooseBase(this,h)[h].changeDomain().then((()=>babelHelpers.classPrivateFieldLooseBase(this,C)[C]())),className:"sign-document-setup__change-domain-button",size:o.Button.Size.EXTRA_SMALL});const a=`<p>${s.Loc.getMessage("SIGN_DOCUMENT_SETUP_CHANGE_DOMAIN_WARNING")}</p>`;const t=babelHelpers.classPrivateFieldLooseBase(this,T)[T]();t.setText(a);babelHelpers.classPrivateFieldLooseBase(this,p)[p]=t.getContainer();s.Dom.append(e.getContainer(),babelHelpers.classPrivateFieldLooseBase(this,p)[p]);s.Dom.append(babelHelpers.classPrivateFieldLooseBase(this,p)[p],babelHelpers.classPrivateFieldLooseBase(this,b)[b])}function V(){return new r.Alert({size:r.Alert.Size.MD,color:r.Alert.Color.WARNING,icon:r.Alert.Icon.DANGER,customClass:"sign-document-setup__change-domain-wrapper"})}function $(){s.Dom.remove(babelHelpers.classPrivateFieldLooseBase(this,p)[p])}function z(){const e=s.Loc.getMessage("SIGN_DOCUMENT_SETUP_EDO_TEXT",{"[helpdesklink]":'<a class="sign-document-setup__helpdesk-article" href="javascript:top.BX.Helper.show(\'redirect=detail&code=18453372\');">',"[/helpdesklink]":"</a>"});const a=babelHelpers.classPrivateFieldLooseBase(this,T)[T]();a.setColor(r.Alert.Color.PRIMARY);a.setIcon(r.Alert.Icon.INFO);a.setText(e);s.Dom.append(a.getContainer(),babelHelpers.classPrivateFieldLooseBase(this,b)[b])}e.DocumentSetup=O})(this.BX.Sign.V2=this.BX.Sign.V2||{},BX,BX.Event,BX.Sign.V2,BX.Sign.V2,BX.Sign.V2,BX.UI,BX.UI);
//# sourceMappingURL=document-setup.bundle.map.js