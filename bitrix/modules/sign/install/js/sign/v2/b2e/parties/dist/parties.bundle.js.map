{"version":3,"file":"parties.bundle.js","sources":["../src/index.js"],"sourcesContent":["import { Dom, Loc, Tag, Type, Extension } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport { CompanySelector, type ProviderSelectedEvent, type CompanySelectedEvent } from 'sign.v2.b2e.company-selector';\nimport { DocumentValidation, maxReviewersCount } from 'sign.v2.b2e.document-validation';\nimport { RepresentativeSelector } from 'sign.v2.b2e.representative-selector';\nimport type { BlankSelectorConfig } from 'sign.v2.blank-selector';\nimport type { Provider, SetupMember } from 'sign.v2.api';\nimport type { DocumentInitiatedType, MemberRoleType, DocumentModeType } from 'sign.type';\nimport { DocumentMode, MemberRole, EntityType } from 'sign.type';\nimport { Helpdesk, Hint } from 'sign.v2.helper';\nimport { isTemplateMode } from 'sign.v2.sign-settings';\n\nimport './style.css';\n\nconst blockWarningClass = 'sign-document-b2e-parties__item_content--warning';\n\nexport type PartiesData = { entityType: string, entityId: ?number, role?: MemberRoleType };\ntype Options = BlankSelectorConfig & { documentInitiatedType?: DocumentInitiatedType, documentMode?: DocumentModeType };\n\nconst currentUserId = Extension.getSettings('sign.v2.b2e.parties').get('currentUserId');\nconst reviewerSelectorContainerListId = 'reviewer-selector-list-container';\n\nconst HelpdeskCodes = Object.freeze({\n\tReviewerRoleDetails: '20801214',\n});\n\nexport class Parties extends EventEmitter\n{\n\t#companySelector: CompanySelector = null;\n\t#representativeSelector: RepresentativeSelector = null;\n\t#documentValidation: DocumentValidation = null;\n\t#addReviewerButton: ?HTMLElement = null;\n\t#ui = {\n\t\tcontainer: HTMLDivElement = null,\n\t\tblocks: {\n\t\t\tcompanyContent: HTMLDivElement = null,\n\t\t\trepresentativeContent: HTMLDivElement = null,\n\t\t\tvalidationEditorLayout: HTMLDivElement = null,\n\t\t},\n\t};\n\n\tconstructor(blankSelectorConfig: Options, hcmLinkAvailable: boolean)\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace('BX.Sign.V2.B2e.Parties');\n\n\t\tconst { region, documentInitiatedType, documentMode } = blankSelectorConfig;\n\t\tconst isTemplate = isTemplateMode(documentMode || DocumentMode.document);\n\n\t\tthis.#representativeSelector = new RepresentativeSelector({\n\t\t\troleEnabled: isTemplate,\n\t\t\tcontext: `sign_b2e_representative_selector_assignee_${currentUserId}`,\n\t\t});\n\t\tthis.#companySelector = new CompanySelector({\n\t\t\tregion,\n\t\t\tdocumentInitiatedType,\n\t\t\tisHcmLinkAvailable: hcmLinkAvailable,\n\t\t\tneedOpenCrmSaveAndEditCompanySliders: isTemplate,\n\t\t});\n\n\t\tthis.#companySelector.subscribe('onSelect', (event: CompanySelectedEvent) => {\n\t\t\tthis.emit('onCompanySelect', event);\n\t\t});\n\n\t\tthis.#companySelector.subscribe('onProviderSelect', (event: ProviderSelectedEvent) => {\n\t\t\tthis.emit('onProviderSelect', event);\n\t\t});\n\n\t\tthis.#documentValidation = new DocumentValidation(\n\t\t\tisTemplate,\n\t\t\t() => this.#checkAddReviewerLimit(),\n\t\t);\n\t}\n\n\tsetEntityId(entityId: number): void\n\t{\n\t\tthis.#companySelector.setOptions({ entityId });\n\t}\n\n\tsetInitiatedByType(initiatedByType: string): void\n\t{\n\t\tthis.#companySelector.setInitiatedByType(initiatedByType);\n\t}\n\n\tasync reloadCompanyProviders(selectFirst: boolean): void\n\t{\n\t\tawait this.#companySelector.reloadCompanyProviders(selectFirst);\n\t}\n\n\tsetEditorAvailability(isAvailable: boolean): void\n\t{\n\t\tif (isAvailable)\n\t\t{\n\t\t\tthis.#addEditorLayout();\n\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#removeEditorLayout();\n\t\tthis.#documentValidation.editorRepresentativeSelector.onSelectorItemDeselectedHandler();\n\t}\n\n\tloadCompany(companyUid: string, entityId: number | null): void\n\t{\n\t\tthis.#companySelector.load(companyUid, entityId);\n\t}\n\n\tloadFirstCompany(): void\n\t{\n\t\tthis.#companySelector.loadFirstCompany();\n\t}\n\n\tloadRepresentative(representativeId: number, entityType: string = EntityType.USER): void\n\t{\n\t\tthis.#representativeSelector.load(representativeId, entityType);\n\t}\n\n\tloadFirstRepresentative(): void\n\t{\n\t\tthis.#representativeSelector.loadFistRepresentative();\n\t}\n\n\tloadValidator(members: Array<SetupMember>): void\n\t{\n\t\tconst reviewers = members.filter(\n\t\t\t(member: SetupMember): boolean => member.role === MemberRole.reviewer,\n\t\t);\n\t\tthis.#documentValidation.loadReviewers(reviewers);\n\n\t\tconst editors = members.filter(\n\t\t\t(member: SetupMember): boolean => member.role === MemberRole.editor,\n\t\t);\n\t\tthis.#documentValidation.loadEditors(editors);\n\t}\n\n\tgetLayout(): HTMLElement\n\t{\n\t\tthis.#ui.blocks.companyContent = Tag.render`\n\t\t\t<div class=\"sign-b2e-settings__item\">\n\t\t\t\t<p class=\"sign-b2e-settings__item_title\">\n\t\t\t\t\t<span>${Loc.getMessage('SIGN_PARTIES_ITEM_COMPANY')}</span>\n\t\t\t\t\t<span\n\t\t\t\t\t\tdata-hint=\"${Loc.getMessage('SIGN_PARTIES_ITEM_COMPANY_HINT')}\"\n\t\t\t\t\t></span>\n\t\t\t\t</p>\n\t\t\t\t${this.#companySelector.getLayout()}\n\t\t\t</div>\n\t\t`;\n\t\tHint.create(this.#ui.blocks.companyContent);\n\t\tthis.#ui.blocks.representativeContent = Tag.render`\n\t\t\t<div class=\"sign-b2e-settings__item --representative\">\n\t\t\t\t<p class=\"sign-b2e-settings__item_title\">\n\t\t\t\t\t${Loc.getMessage('SIGN_PARTIES_ITEM_REPRESENTATIVE')}\n\t\t\t\t</p>\n\t\t\t\t${this.#representativeSelector.getLayout()}\n\t\t\t</div>\n\t\t`;\n\t\tconst providerLayout = Tag.render`\n\t\t\t<div class=\"sign-b2e-settings__item\">\n\t\t\t\t<p class=\"sign-b2e-settings__item_title\">\n\t\t\t\t\t${Loc.getMessage('SIGN_PARTIES_ITEM_PROVIDER')}\n\t\t\t\t</p>\n\t\t\t\t${this.#companySelector.getProviderLayout()}\n\t\t\t</div>\n\t\t`;\n\n\t\tconst validationReviewerLayout = Tag.render`\n\t\t\t<div class=\"sign-b2e-settings__item --reviewer\">\n\t\t\t\t<p class=\"sign-b2e-settings__item_title\">\n\t\t\t\t\t${Loc.getMessage('SIGN_PARTIES_ITEM_VALIDATION_REVIEWER')}\n\t\t\t\t</p>\n\t\t\t\t<div id=\"${reviewerSelectorContainerListId}\">\n\t\t\t\t\t${this.#documentValidation.getReviewerLayoutList()}\n\t\t\t\t</div>\n\t\t\t\t${this.#createAddReviewerButton()}\n\t\t\t\t<p class=\"sign-wizard__notice\">\n\t\t\t\t${Helpdesk.replaceLink(\n\t\t\t\t\tLoc.getMessage('SIGN_PARTIES_ADD_REVIEWER_BUTTON_HINT', { '#LIMIT#': maxReviewersCount }),\n\t\t\t\t\tHelpdeskCodes.ReviewerRoleDetails,\n\t\t\t\t)}\n\t\t\t\t</p>\n\t\t\t</div>\n\t\t`;\n\n\t\tthis.#ui.blocks.validationEditorLayout = Tag.render`\n\t\t\t<div class=\"sign-b2e-settings__item --editor\">\n\t\t\t\t<p class=\"sign-b2e-settings__item_title\">\n\t\t\t\t\t${Loc.getMessage('SIGN_PARTIES_ITEM_VALIDATION_EDITOR')}\n\t\t\t\t</p>\n\t\t\t\t${this.#documentValidation.getEditorLayout()}\n\t\t\t</div>\n\t\t`;\n\n\t\tthis.#ui.container = Tag.render`\n\t\t\t<div>\n\t\t\t\t<h1 class=\"sign-b2e-settings__header\">${Loc.getMessage('SIGN_PARTIES_HEADER')}</h1>\n\t\t\t\t${this.#ui.blocks.companyContent}\n\t\t\t\t${providerLayout}\n\t\t\t\t${this.#ui.blocks.representativeContent}\n\t\t\t\t${validationReviewerLayout}\n\t\t\t\t${this.#ui.blocks.validationEditorLayout}\n\t\t\t</div>\n\t\t`;\n\n\t\treturn this.#ui.container;\n\t}\n\n\t#createAddReviewerButton(): HTMLElement\n\t{\n\t\tthis.#addReviewerButton = Tag.render`\n\t\t\t<button type=\"button\" class=\"sign-b2e-document-setup__add-button\">\n\t\t\t\t<span class=\"sign-b2e-document-setup__add-button_text\">\n\t\t\t\t\t${Loc.getMessage('SIGN_PARTIES_ADD_REVIEWER_BUTTON_TITLE')}\n\t\t\t\t</span>\n\t\t\t\t<span class=\"sign-b2e-document-setup__add-button_disabled_hint\" data-hint=\"${Loc.getMessage('SIGN_PARTIES_ADD_REVIEWER_BUTTON_DISABLED_HINT', { '#LIMIT#': maxReviewersCount })}\"></span>\n\t\t\t</button>\n\t\t`;\n\t\tHint.create(this.#addReviewerButton);\n\n\t\tBX.bind(this.#addReviewerButton, 'click', (): void => {\n\t\t\tconst container = document.getElementById(reviewerSelectorContainerListId);\n\t\t\tif (container === null)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst selector = this.#documentValidation.addReviewerRepresentativeSelector();\n\t\t\tDom.append(selector, container);\n\n\t\t\tthis.#checkAddReviewerLimit();\n\t\t});\n\n\t\tthis.#checkAddReviewerLimit();\n\n\t\treturn this.#addReviewerButton;\n\t}\n\n\t#checkAddReviewerLimit(): void\n\t{\n\t\tif (this.#addReviewerButton === null)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#addReviewerButton.disabled = this.#documentValidation.getReviewerRepresentativeSelectorCount() >= maxReviewersCount;\n\t}\n\n\t#validate(): boolean\n\t{\n\t\treturn this.#companySelector.validate() && this.#representativeSelector.validate();\n\t}\n\n\tasync save(documentId: string)\n\t{\n\t\tthis.#removeWarningFromBlocks();\n\t\tif (!this.#validate())\n\t\t{\n\t\t\tthrow new Error('Validation failed');\n\t\t}\n\n\t\ttry\n\t\t{\n\t\t\tawait this.#companySelector.save(documentId);\n\t\t}\n\t\tcatch (e)\n\t\t{\n\t\t\tthis.#setWarning(this.#ui.blocks.companyContent);\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\tgetSelectedProvider(): Provider | null\n\t{\n\t\treturn this.#companySelector.getSelectedCompanyProvider();\n\t}\n\n\tisProviderSelected(): boolean\n\t{\n\t\treturn Boolean(this.#companySelector.getSelectedCompanyProvider());\n\t}\n\n\tisRepresentativeSelected(): boolean\n\t{\n\t\treturn Boolean(this.#representativeSelector.getRepresentativeId());\n\t}\n\n\tgetParties(): Record<string, PartiesData> & { validation: Array<PartiesData> }\n\t{\n\t\treturn {\n\t\t\trepresentative: {\n\t\t\t\tentityType: this.#representativeSelector.getRepresentativeItemType(),\n\t\t\t\tentityId: this.#representativeSelector.getRepresentativeId(),\n\t\t\t},\n\t\t\tcompany: {\n\t\t\t\tentityType: 'company',\n\t\t\t\tentityId: this.#companySelector.getCompanyId(),\n\t\t\t},\n\t\t\tvalidation: this.#documentValidation.getValidationData(),\n\t\t};\n\t}\n\n\tgetSelectedCompanyId(): number\n\t{\n\t\treturn this.#companySelector.getCompanyId();\n\t}\n\n\t#setWarning(block: HTMLDivElement): void\n\t{\n\t\tif (Type.isNull(block) || Type.isUndefined(block))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tDom.addClass(block, blockWarningClass);\n\t}\n\n\t#removeWarningFromBlocks(): void\n\t{\n\t\tfor (const [key, block] of Object.entries(this.#ui.blocks))\n\t\t{\n\t\t\tif (Type.isNull(block))\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tDom.removeClass(block, blockWarningClass);\n\t\t}\n\t}\n\n\t#addEditorLayout(): void\n\t{\n\t\tDom.append(this.#ui.blocks.validationEditorLayout, this.#ui.container);\n\t}\n\n\t#removeEditorLayout(): void\n\t{\n\t\tDom.remove(this.#ui.blocks.validationEditorLayout);\n\t}\n}\n"],"names":["currentUserId","Extension","getSettings","get","HelpdeskCodes","Object","freeze","ReviewerRoleDetails","Parties","blankSelectorConfig","hcmLinkAvailable","babelHelpers","_this","_classPrivateMethodInitSpec","_classPrivateFieldInitSpec","writable","value","container","HTMLDivElement","blocks","companyContent","representativeContent","validationEditorLayout","setEventNamespace","region","documentInitiatedType","documentMode","isTemplate","isTemplateMode","DocumentMode","document","RepresentativeSelector","roleEnabled","context","CompanySelector","isHcmLinkAvailable","needOpenCrmSaveAndEditCompanySliders","subscribe","event","emit","DocumentValidation","key","entityId","setOptions","initiatedByType","setInitiatedByType","selectFirst","_context","reloadCompanyProviders","isAvailable","_classPrivateMethodGet","this","editorRepresentativeSelector","onSelectorItemDeselectedHandler","companyUid","load","loadFirstCompany","representativeId","entityType","EntityType","USER","loadFistRepresentative","members","reviewers","filter","member","role","MemberRole","reviewer","loadReviewers","editors","editor","loadEditors","Tag","render","Loc","getMessage","getLayout","Hint","create","providerLayout","getProviderLayout","validationReviewerLayout","getReviewerLayoutList","Helpdesk","replaceLink","#LIMIT#","maxReviewersCount","getEditorLayout","documentId","_context2","Error","save","getSelectedCompanyProvider","Boolean","getRepresentativeId","representative","getRepresentativeItemType","company","getCompanyId","validation","getValidationData","EventEmitter","BX","bind","getElementById","selector","addReviewerRepresentativeSelector","Dom","append","_this2","disabled","getReviewerRepresentativeSelectorCount","validate","block","Type","isNull","isUndefined","addClass","entries","removeClass","remove"],"mappings":"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"}