{"version":3,"file":"document-template-user-party.bundle.js","sources":["../src/app.js","../src/document-template-user-party.js"],"sourcesContent":["// @vue/component\nexport const UserPartyApp = {\n\tname: 'UserPartyApp',\n\tprops: {\n\t\tuserParty: {\n\t\t\t/** @type UserParty */\n\t\t\ttype: Object,\n\t\t\trequired: true,\n\t\t},\n\t\tregion: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t},\n\t},\n\tmounted(): void\n\t{\n\t\tconst userPartyLayout = this.userParty.getLayout(this.region);\n\t\tthis.$refs.userPartyContainer.appendChild(userPartyLayout);\n\t},\n\ttemplate: `\n\t\t<div ref=\"userPartyContainer\" class=\"sign-b2e-user-party-container\"></div>\n\t`,\n};\n","import { Extension } from 'main.core';\nimport { Api } from 'sign.v2.api';\nimport type { LoadedDocumentData, TemplateCreatedDocument } from 'sign.v2.api';\nimport { BitrixVue, VueCreateAppResult } from 'ui.vue3';\nimport { UserPartyApp } from './app';\nimport { UserParty } from 'sign.v2.b2e.user-party';\nimport { useDocumentTemplateFillingStore } from 'sign.v2.b2e.sign-settings-templates';\n\nimport './style.css';\n\nexport class DocumentTemplateUserParty\n{\n\t#app: VueCreateAppResult | null;\n\t#vueApp: Object | null;\n\t#container: HTMLElement;\n\t#userParty: UserParty;\n\t#store: Object;\n\t#api: Api;\n\n\tconstructor(store: Object)\n\t{\n\t\tconst b2eSignersLimitCount = this.#getB2eSignersCountLimit();\n\t\tconst region = this.#getRegion();\n\n\t\tthis.#store = store;\n\t\tthis.#userParty = new UserParty({ mode: 'edit', b2eSignersLimitCount, region });\n\t\tthis.#api = new Api();\n\t}\n\n\t#createApp(container: HTMLElement): void\n\t{\n\t\tthis.#app = BitrixVue.createApp(UserPartyApp, {\n\t\t\tuserParty: this.#userParty,\n\t\t\tregion: this.#getRegion(),\n\t\t});\n\t\tthis.#app.use(this.#store);\n\t\tthis.#vueApp = this.#app.mount(container);\n\t}\n\n\tasync syncMembers(): Promise<void>\n\t{\n\t\tconst documentStore = useDocumentTemplateFillingStore();\n\t\tconst storeDocuments = documentStore.createdDocuments;\n\t\tconst ids = storeDocuments.map((value: TemplateCreatedDocument) => value.document.id);\n\n\t\tconst {\n\t\t\tshouldCheckDepartmentsSync,\n\t\t\tdocuments,\n\t\t} = await this.#api.template.setupSigners(ids, this.#userParty.getEntities());\n\n\t\tthis.#updatePartiesCountInStore(documents); // can rid of this if make syncDepartmentForSigners method\n\t\tif (shouldCheckDepartmentsSync)\n\t\t{\n\t\t\tawait this.#waitForDepartmentSync();\n\t\t}\n\t}\n\n\t#updatePartiesCountInStore(documents: LoadedDocumentData[]): void\n\t{\n\t\tuseDocumentTemplateFillingStore()\n\t\t\t.createdDocuments\n\t\t\t.forEach((templateCreatedDocument: TemplateCreatedDocument) => {\n\t\t\t\tconst storeDocument = templateCreatedDocument.document;\n\t\t\t\tconst id = storeDocument.id;\n\t\t\t\tconst document = documents.find(\n\t\t\t\t\t(value: LoadedDocumentData) => value.id === id,\n\t\t\t\t);\n\t\t\t\tif (!document)\n\t\t\t\t{\n\t\t\t\t\tthrow new Error('Created document not found in update parties documents');\n\t\t\t\t}\n\n\t\t\t\tstoreDocument.parties = document.parties;\n\t\t\t});\n\t}\n\n\tasync #waitForDepartmentSync(): Promise<void>\n\t{\n\t\tconst createdDocuments: TemplateCreatedDocument[] = useDocumentTemplateFillingStore().createdDocuments;\n\n\t\tconst syncMemberPromises = createdDocuments.map(\n\t\t\t(value: TemplateCreatedDocument) => this.#syncMembersWithDepartments(value.document.uid, value.document.parties),\n\t\t);\n\n\t\tawait Promise.all(syncMemberPromises);\n\t}\n\n\tasync #syncMembersWithDepartments(uid: string, signerParty: number): Promise<void>\n\t{\n\t\tlet syncFinished = false;\n\t\twhile (!syncFinished)\n\t\t{\n\t\t\t// eslint-disable-next-line no-await-in-loop\n\t\t\tconst response = await this.#api.syncB2eMembersWithDepartments(uid, signerParty);\n\t\t\tsyncFinished = response.syncFinished;\n\t\t\t// eslint-disable-next-line no-await-in-loop\n\t\t\tawait this.#sleep(1000);\n\t\t}\n\t}\n\n\t#sleep(ms: Number): Promise\n\t{\n\t\treturn new Promise((resolve) => {\n\t\t\tsetTimeout(resolve, ms);\n\t\t});\n\t}\n\n\tgetLayout(): HTMLElement\n\t{\n\t\tif (this.#container)\n\t\t{\n\t\t\treturn this.#container;\n\t\t}\n\n\t\tthis.#container = BX.Tag.render`<div></div>`;\n\t\tthis.#createApp(this.#container);\n\n\t\treturn this.#container;\n\t}\n\n\tvalidate(): boolean\n\t{\n\t\tif (!this.#userParty.validate())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst limit = this.#getB2eSignersCountLimit();\n\t\tif (limit > 0 && this.#userParty.getUniqueUsersCount() > limit)\n\t\t{\n\t\t\ttop.BX.UI.InfoHelper.show('limit_office_e_signature');\n\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\t#getB2eSignersCountLimit(): number | null\n\t{\n\t\treturn Extension.getSettings('sign.v2.b2e.document-template-user-party').get('signersLimitCount');\n\t}\n\n\t#getRegion(): string\n\t{\n\t\treturn Extension.getSettings('sign.v2.b2e.document-template-user-party').get('region');\n\t}\n\n\tunmount(): void\n\t{\n\t\tthis.closeCounterGuide();\n\t\tthis.#app?.unmount();\n\t}\n\n\tcloseCounterGuide(): void\n\t{\n\t\tthis.#userParty.closeCounterGuide();\n\t}\n}\n"],"names":["UserPartyApp","name","props","userParty","type","Object","required","region","String","mounted","userPartyLayout","getLayout","$refs","userPartyContainer","appendChild","template","DocumentTemplateUserParty","constructor","store","b2eSignersLimitCount","UserParty","mode","Api","syncMembers","documentStore","useDocumentTemplateFillingStore","storeDocuments","createdDocuments","ids","map","value","document","id","shouldCheckDepartmentsSync","documents","setupSigners","getEntities","BX","Tag","render","validate","limit","getUniqueUsersCount","top","UI","InfoHelper","show","unmount","closeCounterGuide","container","BitrixVue","createApp","use","mount","forEach","templateCreatedDocument","storeDocument","find","Error","parties","syncMemberPromises","uid","Promise","all","signerParty","syncFinished","response","syncB2eMembersWithDepartments","ms","resolve","setTimeout","Extension","getSettings","get"],"mappings":"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"}