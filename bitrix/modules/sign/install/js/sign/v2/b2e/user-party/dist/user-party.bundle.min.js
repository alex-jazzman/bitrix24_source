this.BX=this.BX||{};this.BX.Sign=this.BX.Sign||{};this.BX.Sign.V2=this.BX.Sign.V2||{};(function(e,s,t,a,i,l,r,o,n,b){"use strict";let d=e=>e,c,v,p,u,P,h,L,y,H,m;const F=Object.freeze({view:"view",edit:"edit"});const g={user:"/bitrix/js/sign/v2/b2e/user-party/images/user.svg",department:"/bitrix/js/sign/v2/b2e/user-party/images/department.svg",document:"/bitrix/js/sign/v2/b2e/user-party/images/sign-document.svg",signersList:"/bitrix/js/sign/v2/b2e/user-party/images/signers-list.svg"};const B=Object.freeze({SignEdmWithEmployees:"19740792"});var f=babelHelpers.classPrivateFieldLooseKey("api");var _=babelHelpers.classPrivateFieldLooseKey("ui");var w=babelHelpers.classPrivateFieldLooseKey("items");var T=babelHelpers.classPrivateFieldLooseKey("preselectedUserData");var S=babelHelpers.classPrivateFieldLooseKey("userCount");var C=babelHelpers.classPrivateFieldLooseKey("viewMode");var O=babelHelpers.classPrivateFieldLooseKey("tagSelector");var j=babelHelpers.classPrivateFieldLooseKey("loader");var E=babelHelpers.classPrivateFieldLooseKey("userPartyCounters");var I=babelHelpers.classPrivateFieldLooseKey("documentUid");var D=babelHelpers.classPrivateFieldLooseKey("userPartyPopup");var K=babelHelpers.classPrivateFieldLooseKey("counterDelayTimeout");var M=babelHelpers.classPrivateFieldLooseKey("role");var R=babelHelpers.classPrivateFieldLooseKey("userPartyRefused");var U=babelHelpers.classPrivateFieldLooseKey("init");var $=babelHelpers.classPrivateFieldLooseKey("renderTitle");var x=babelHelpers.classPrivateFieldLooseKey("renderDescription");var X=babelHelpers.classPrivateFieldLooseKey("createUserPartyPopup");var N=babelHelpers.classPrivateFieldLooseKey("displayShowMoreBtn");var V=babelHelpers.classPrivateFieldLooseKey("loadPreselectedUsersData");var A=babelHelpers.classPrivateFieldLooseKey("showLoader");var G=babelHelpers.classPrivateFieldLooseKey("hideLoader");var W=babelHelpers.classPrivateFieldLooseKey("getLoader");var Y=babelHelpers.classPrivateFieldLooseKey("removeItem");var q=babelHelpers.classPrivateFieldLooseKey("addItem");var z=babelHelpers.classPrivateFieldLooseKey("updateEditModeCounter");var k=babelHelpers.classPrivateFieldLooseKey("updateCounterWithDelay");var J=babelHelpers.classPrivateFieldLooseKey("createItemLayout");var Q=babelHelpers.classPrivateFieldLooseKey("createDepartmentItemLayout");var Z=babelHelpers.classPrivateFieldLooseKey("createDocumentItemLayout");var ee=babelHelpers.classPrivateFieldLooseKey("createSignersListItemLayout");var se=babelHelpers.classPrivateFieldLooseKey("createUserItemLayout");var te=babelHelpers.classPrivateFieldLooseKey("clean");var ae=babelHelpers.classPrivateFieldLooseKey("getViewModeItemsCount");var ie=babelHelpers.classPrivateFieldLooseKey("makeItemMapKeyByTag");class le{constructor(e){var s;Object.defineProperty(this,ie,{value:we});Object.defineProperty(this,ae,{value:_e});Object.defineProperty(this,te,{value:fe});Object.defineProperty(this,se,{value:Be});Object.defineProperty(this,ee,{value:ge});Object.defineProperty(this,Z,{value:Fe});Object.defineProperty(this,Q,{value:me});Object.defineProperty(this,J,{value:He});Object.defineProperty(this,k,{value:ye});Object.defineProperty(this,z,{value:Le});Object.defineProperty(this,q,{value:he});Object.defineProperty(this,Y,{value:Pe});Object.defineProperty(this,W,{value:ue});Object.defineProperty(this,G,{value:pe});Object.defineProperty(this,A,{value:ve});Object.defineProperty(this,V,{value:ce});Object.defineProperty(this,N,{value:de});Object.defineProperty(this,X,{value:be});Object.defineProperty(this,x,{value:ne});Object.defineProperty(this,$,{value:oe});Object.defineProperty(this,U,{value:re});Object.defineProperty(this,f,{writable:true,value:void 0});Object.defineProperty(this,_,{writable:true,value:{container:HTMLDivElement=null,itemContainer:HTMLDivElement=null,header:HTMLSpanElement=null,description:HTMLParagraphElement=null,userPartyCounterContainer:HTMLDivElement=null,showMoreSignersContainer:HTMLDivElement=null}});Object.defineProperty(this,w,{writable:true,value:new Map});Object.defineProperty(this,T,{writable:true,value:[]});Object.defineProperty(this,S,{writable:true,value:0});Object.defineProperty(this,C,{writable:true,value:F.edit});Object.defineProperty(this,O,{writable:true,value:null});Object.defineProperty(this,j,{writable:true,value:null});Object.defineProperty(this,E,{writable:true,value:null});Object.defineProperty(this,I,{writable:true,value:null});Object.defineProperty(this,D,{writable:true,value:null});Object.defineProperty(this,K,{writable:true,value:null});Object.defineProperty(this,M,{writable:true,value:n.MemberRole.signer});Object.defineProperty(this,R,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,f)[f]=new r.Api;babelHelpers.classPrivateFieldLooseBase(this,C)[C]=e.mode;babelHelpers.classPrivateFieldLooseBase(this,M)[M]=(s=e.role)!=null?s:n.MemberRole.signer;babelHelpers.classPrivateFieldLooseBase(this,U)[U](e)}getLayout(e){var t;if(babelHelpers.classPrivateFieldLooseBase(this,_)[_].container){return babelHelpers.classPrivateFieldLooseBase(this,_)[_].container}babelHelpers.classPrivateFieldLooseBase(this,_)[_].itemContainer=s.Tag.render(c||(c=d`
			<div class="sign-document-b2e-user-party__item-list"></div>
		`));if(babelHelpers.classPrivateFieldLooseBase(this,C)[C]!==F.edit){s.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,_)[_].itemContainer,"--view");const e=s.Tag.render(v||(v=d`
				<a href="#">${0}</a>
			`),s.Loc.getMessage("SIGN_USER_PARTY_VIEW_SHOW_MORE",{"#EMPLOYEE_COUNT#":'<span class="--count-placeholder">\u2026</span>'}));babelHelpers.classPrivateFieldLooseBase(this,D)[D]=babelHelpers.classPrivateFieldLooseBase(this,X)[X](e);s.Event.bind(e,"click",(e=>{babelHelpers.classPrivateFieldLooseBase(this,D)[D].setDocumentUid(babelHelpers.classPrivateFieldLooseBase(this,I)[I]).show();e.preventDefault()}));babelHelpers.classPrivateFieldLooseBase(this,_)[_].showMoreSignersContainer=s.Tag.render(p||(p=d`
				<div class="sign-document-b2e-user-party__item-show_more">
					${0}
				</div>
			`),e);s.Dom.hide(babelHelpers.classPrivateFieldLooseBase(this,_)[_].showMoreSignersContainer);s.Dom.append(babelHelpers.classPrivateFieldLooseBase(this,_)[_].showMoreSignersContainer,babelHelpers.classPrivateFieldLooseBase(this,_)[_].itemContainer);return babelHelpers.classPrivateFieldLooseBase(this,_)[_].itemContainer}babelHelpers.classPrivateFieldLooseBase(this,_)[_].description=babelHelpers.classPrivateFieldLooseBase(this,x)[x](e);return s.Tag.render(u||(u=d`
			<div>
				<div class="sign-b2e-settings__header-wrapper">
					<h1 class="sign-b2e-settings__header">${0}</h1>
					${0}
				</div>
				<div class="sign-b2e-settings__item">
					${0}
					${0}
					${0}
					${0}
				</div>
			</div>
		`),s.Loc.getMessage("SIGN_USER_PARTY_HEADER"),this.userPartyCounters.getLayout(),babelHelpers.classPrivateFieldLooseBase(this,$)[$](),babelHelpers.classPrivateFieldLooseBase(this,_)[_].itemContainer,babelHelpers.classPrivateFieldLooseBase(this,_)[_].description,(t=this.userPartyRefused.render())!=null?t:"")}async load(e){const{dialog:s}=babelHelpers.classPrivateFieldLooseBase(this,O)[O];s.preselectedItems=e.map((e=>["user",e]));const t=new Promise((e=>{s.subscribeOnce("onLoad",e)}));s.load();await t}async setUserIds(e){babelHelpers.classPrivateFieldLooseBase(this,te)[te]();const s=babelHelpers.classPrivateFieldLooseBase(this,ae)[ae]();babelHelpers.classPrivateFieldLooseBase(this,S)[S]=e.length;babelHelpers.classPrivateFieldLooseBase(this,T)[T]=e.sort(((e,s)=>e.entityType==="structure-node"?-1:1)).slice(0,s);const t=await babelHelpers.classPrivateFieldLooseBase(this,f)[f].getMembersForDocument(babelHelpers.classPrivateFieldLooseBase(this,I)[I],1,s,babelHelpers.classPrivateFieldLooseBase(this,M)[M]);if(babelHelpers.classPrivateFieldLooseBase(this,M)[M]===n.MemberRole.signer){const e=new Set(t.members.map((e=>e.userId)));babelHelpers.classPrivateFieldLooseBase(this,T)[T]=babelHelpers.classPrivateFieldLooseBase(this,T)[T].filter((s=>s.entityType===n.EntityType.USER?e.has(s.entityId):true))}if(babelHelpers.classPrivateFieldLooseBase(this,T)[T].length<s){const a=new Set(e.filter((e=>e.entityType===n.EntityType.USER)).map((e=>e.entityId)));const i=t.members.filter((e=>!a.has(e.userId))).slice(0,s-babelHelpers.classPrivateFieldLooseBase(this,T)[T].length);babelHelpers.classPrivateFieldLooseBase(this,T)[T]=[...babelHelpers.classPrivateFieldLooseBase(this,T)[T],...i.map((e=>({entityType:"user",entityId:e.userId})))]}babelHelpers.classPrivateFieldLooseBase(this,T)[T].reverse();await babelHelpers.classPrivateFieldLooseBase(this,V)[V]();babelHelpers.classPrivateFieldLooseBase(this,N)[N]()}validate(){this.closeCounterGuide();const e=babelHelpers.classPrivateFieldLooseBase(this,w)[w].size>0&&babelHelpers.classPrivateFieldLooseBase(this,E)[E].getCount()>0;const t=babelHelpers.classPrivateFieldLooseBase(this,O)[O].getOuterContainer();if(e){s.Dom.removeClass(t,"--invalid")}else{s.Dom.addClass(t,"--invalid")}return e}isRejectExcludedEnabled(){return babelHelpers.classPrivateFieldLooseBase(this,R)[R].shouldRemoveRefused()}getEntities(){return[...babelHelpers.classPrivateFieldLooseBase(this,w)[w].values()]}resetUserPartyPopup(){babelHelpers.classPrivateFieldLooseBase(this,D)[D].resetData()}setDocumentUid(e){babelHelpers.classPrivateFieldLooseBase(this,I)[I]=e}getPreselectedUserData(){return babelHelpers.classPrivateFieldLooseBase(this,T)[T]}getUniqueUsersCount(){var e,s;return(e=(s=babelHelpers.classPrivateFieldLooseBase(this,E)[E])==null?void 0:s.getCount())!=null?e:0}closeCounterGuide(){var e;(e=babelHelpers.classPrivateFieldLooseBase(this,E)[E])==null?void 0:e.closeGuide()}get userPartyCounters(){return babelHelpers.classPrivateFieldLooseBase(this,E)[E]}get userPartyRefused(){return babelHelpers.classPrivateFieldLooseBase(this,R)[R]}get ui(){return babelHelpers.classPrivateFieldLooseBase(this,_)[_]}}function re(e){if(babelHelpers.classPrivateFieldLooseBase(this,C)[C]===F.view){babelHelpers.classPrivateFieldLooseBase(this,_)[_].container=this.getLayout(e.region);return}const{b2eSignersLimitCount:s,region:t}=e;babelHelpers.classPrivateFieldLooseBase(this,E)[E]=new i.UserPartyCounters({userCountersLimit:s});babelHelpers.classPrivateFieldLooseBase(this,R)[R]=new b.UserPartyRefused;babelHelpers.classPrivateFieldLooseBase(this,R)[R].subscribe("onChange",(e=>{babelHelpers.classPrivateFieldLooseBase(this,z)[z]()}));babelHelpers.classPrivateFieldLooseBase(this,_)[_].container=this.getLayout(t);const l=[];const r=[{id:"user",options:{intranetUsersOnly:true}},{id:"structure-node",options:{selectMode:"usersAndDepartments",fillRecentTab:true,allowFlatDepartments:true}},{id:"signers-list"}];if(o.FeatureStorage.isDocumentsInSignersSelectorEnabled()){r.push({id:"sign-document"})}babelHelpers.classPrivateFieldLooseBase(this,O)[O]=new a.TagSelector({events:{onTagRemove:e=>{const{tag:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,Y)[Y](s)},onTagAdd:e=>{const{tag:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,q)[q](s)}},dialogOptions:{width:425,height:363,multiple:true,targetNode:babelHelpers.classPrivateFieldLooseBase(this,_)[_].itemContainer,context:"sign_b2e_user_party",tabs:l,entities:r,dropdownMode:false,hideOnDeselect:false}});babelHelpers.classPrivateFieldLooseBase(this,O)[O].renderTo(babelHelpers.classPrivateFieldLooseBase(this,_)[_].itemContainer)}function oe(){return s.Tag.render(P||(P=d`
			<p class="sign-b2e-settings__item_title">
				${0}
			</p>
		`),s.Loc.getMessage("SIGN_USER_PARTY_ITEM_TITLE"))}function ne(e){const a=e==="ru"?t.Helpdesk.replaceLink(s.Loc.getMessage("SIGN_USER_PARTY_DESCRIPTION"),B.SignEdmWithEmployees):s.Loc.getMessage("SIGN_USER_PARTY_DESCRIPTION_WITHOUT_LINK");return s.Tag.render(h||(h=d`
			<p class="sign-document-b2e-user-party__description">
				${0}
			</p>
		`),a)}function be(e){const s=babelHelpers.classPrivateFieldLooseBase(this,M)[M]===n.MemberRole.signer;return new l.UserPartyPopup({bindElement:e,isDepartmentsVisible:s,role:babelHelpers.classPrivateFieldLooseBase(this,M)[M]})}async function de(){let e=false;let t=0;const a=babelHelpers.classPrivateFieldLooseBase(this,T)[T].reduce(((e,s)=>s.entityType==="user"?e+1:e),0);if(babelHelpers.classPrivateFieldLooseBase(this,M)[M]===n.MemberRole.signer){const s=await babelHelpers.classPrivateFieldLooseBase(this,f)[f].getUniqUserCountForDocument(babelHelpers.classPrivateFieldLooseBase(this,I)[I],false);t=s.count-a;e=t>0}else if(babelHelpers.classPrivateFieldLooseBase(this,S)[S]>babelHelpers.classPrivateFieldLooseBase(this,ae)[ae]()){e=true;t=babelHelpers.classPrivateFieldLooseBase(this,S)[S]-babelHelpers.classPrivateFieldLooseBase(this,ae)[ae]()}if(e){babelHelpers.classPrivateFieldLooseBase(this,_)[_].showMoreSignersContainer.querySelector(".--count-placeholder").textContent=t;s.Dom.show(babelHelpers.classPrivateFieldLooseBase(this,_)[_].showMoreSignersContainer)}else{babelHelpers.classPrivateFieldLooseBase(this,_)[_].showMoreSignersContainer.querySelector(".--count-placeholder").textContent=0;s.Dom.hide(babelHelpers.classPrivateFieldLooseBase(this,_)[_].showMoreSignersContainer)}}async function ce(){babelHelpers.classPrivateFieldLooseBase(this,A)[A]();await new Promise((e=>{const s=new a.Dialog({entities:[{id:"user"}],events:{onLoad:()=>{s.getSelectedItems().forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,q)[q](e)}));e()}},preselectedItems:babelHelpers.classPrivateFieldLooseBase(this,T)[T].map((e=>[e.entityType,e.entityId]))});s.load()}));babelHelpers.classPrivateFieldLooseBase(this,G)[G]()}function ve(){babelHelpers.classPrivateFieldLooseBase(this,_)[_].itemContainer.style.display="none";babelHelpers.classPrivateFieldLooseBase(this,W)[W]().show()}function pe(){babelHelpers.classPrivateFieldLooseBase(this,_)[_].itemContainer.style.display="flex";babelHelpers.classPrivateFieldLooseBase(this,W)[W]().hide()}function ue(){if(babelHelpers.classPrivateFieldLooseBase(this,j)[j]){return babelHelpers.classPrivateFieldLooseBase(this,j)[j]}babelHelpers.classPrivateFieldLooseBase(this,j)[j]=new BX.Loader({target:babelHelpers.classPrivateFieldLooseBase(this,_)[_].container,mode:"inline",size:40});return babelHelpers.classPrivateFieldLooseBase(this,j)[j]}function Pe(e){const t=babelHelpers.classPrivateFieldLooseBase(this,ie)[ie](e);const a=babelHelpers.classPrivateFieldLooseBase(this,w)[w].get(t);if(a!=null&&a.container){s.Dom.remove(a.container)}babelHelpers.classPrivateFieldLooseBase(this,w)[w].delete(t);babelHelpers.classPrivateFieldLooseBase(this,z)[z]()}function he(e){var t,a;const i={id:e.id,title:e==null?void 0:e.title.text,name:(t=e.customData)==null?void 0:t.get("name"),lastName:(a=e.customData)==null?void 0:a.get("lastName"),avatar:e==null?void 0:e.avatar,entityId:e.id,entityType:e==null?void 0:e.entityId};const l=babelHelpers.classPrivateFieldLooseBase(this,C)[C]===F.view?babelHelpers.classPrivateFieldLooseBase(this,J)[J](i):null;if(l){s.Dom.prepend(l,babelHelpers.classPrivateFieldLooseBase(this,_)[_].itemContainer)}i.container=l;babelHelpers.classPrivateFieldLooseBase(this,w)[w].set(babelHelpers.classPrivateFieldLooseBase(this,ie)[ie](e),i);babelHelpers.classPrivateFieldLooseBase(this,z)[z]()}function Le(){if(babelHelpers.classPrivateFieldLooseBase(this,C)[C]===F.edit){babelHelpers.classPrivateFieldLooseBase(this,k)[k](babelHelpers.classPrivateFieldLooseBase(this,O)[O].getTags().map((e=>({entityId:e.id,entityType:e.entityId}))))}}function ye(e){clearTimeout(babelHelpers.classPrivateFieldLooseBase(this,K)[K]);babelHelpers.classPrivateFieldLooseBase(this,K)[K]=setTimeout((async()=>{var s;const t=await babelHelpers.classPrivateFieldLooseBase(this,f)[f].getUniqUserCountForMembers(e,this.isRejectExcludedEnabled());(s=babelHelpers.classPrivateFieldLooseBase(this,E)[E])==null?void 0:s.update(t.count)}),100)}function He(e){switch(e.entityType){case"structure-node":return babelHelpers.classPrivateFieldLooseBase(this,Q)[Q](e);case"sign-document":return babelHelpers.classPrivateFieldLooseBase(this,Z)[Z](e);case"signers-list":return babelHelpers.classPrivateFieldLooseBase(this,ee)[ee](e);default:return babelHelpers.classPrivateFieldLooseBase(this,se)[se](e)}}function me(e){const t=s.Text.encode(e.title);return s.Tag.render(L||(L=d`
			<div class="sign-document-b2e-user-party__item-list_item --department">
				<div>
					<img
						class="sign-document-b2e-user-party__item-list_item-avatar"
						title="${0}" src='${0}' alt="avatar"
					/>
				</div>
				<div title="${0}" class="sign-document-b2e-user-party__item-list_item-text">
					${0}
				</div>
			</div>
		`),t,g.department,t,t)}function Fe(e){const t=s.Text.encode(e.title);return s.Tag.render(y||(y=d`
			<div class="sign-document-b2e-user-party__item-list_item --document">
				<div>
					<img
						class="sign-document-b2e-user-party__item-list_item-avatar"
						title="${0}" src='${0}' alt="avatar"
					/>
				</div>
				<div title="${0}" class="sign-document-b2e-user-party__item-list_item-text">
					${0}
				</div>
			</div>
		`),t,g.document,t,t)}function ge(e){const t=s.Text.encode(e.title);return s.Tag.render(H||(H=d`
			<div class="sign-document-b2e-user-party__item-list_item --signers-list">
				<div>
					<img
						class="sign-document-b2e-user-party__item-list_item-avatar"
						title="${0}" src='${0}' alt="avatar"
					/>
				</div>
				<div title="${0}" class="sign-document-b2e-user-party__item-list_item-text">
					${0}
				</div>
			</div>
		`),t,g.signersList,t,t)}function Be(e){const t=s.Text.encode(e.title);const a=e.avatar||g.user;const i=`/company/personal/user/${e.entityId}/`;return s.Tag.render(m||(m=d`
			<div class="sign-document-b2e-user-party__item-list_item --user">
				<a href="${0}">
					<img
						class="sign-document-b2e-user-party__item-list_item-avatar"
						title="${0}" src='${0}' alt="avatar"
					/>
				</a>
				<div title="${0}" class="sign-document-b2e-user-party__item-list_item-text">
					${0}
				</div>
			</div>
		`),s.Text.encode(i),t,s.Text.encode(a),t,t)}function fe(){var e;this.closeCounterGuide();[...babelHelpers.classPrivateFieldLooseBase(this,w)[w].values()].forEach((e=>s.Dom.remove(e.container)));babelHelpers.classPrivateFieldLooseBase(this,w)[w].clear();(e=babelHelpers.classPrivateFieldLooseBase(this,E)[E])==null?void 0:e.update(babelHelpers.classPrivateFieldLooseBase(this,w)[w].size)}function _e(){return 7}function we(e){const{id:s,entityId:t}=e;return`${t}_${s}`}e.UserParty=le})(this.BX.Sign.V2.B2e=this.BX.Sign.V2.B2e||{},BX,BX.Sign.V2,BX.UI.EntitySelector,BX.Sign.V2.B2e,BX.Sign.V2.B2e,BX.Sign.V2,BX.Sign,BX.Sign,BX.Sign.V2.B2e);
//# sourceMappingURL=user-party.bundle.map.js