this.BX=this.BX||{};this.BX.Disk=this.BX.Disk||{};(function(exports,ui_buttons,main_popup,disk_externalLink,disk_sharingLegacyPopup){"use strict";var InvalidTokenError=function(e){babelHelpers.inherits(i,e);function i(){babelHelpers.classCallCheck(this,i);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).apply(this,arguments))}return i}(babelHelpers.wrapNativeSuper(Error));InvalidTokenError.prototype.name="InvalidTokenError";function b64DecodeUnicode(e){return decodeURIComponent(atob(e).replace(/(.)/g,(function(e,i){var n=i.charCodeAt(0).toString(16).toUpperCase();if(n.length<2){n="0"+n}return"%"+n})))}function base64UrlDecode(e){var i=e.replace(/-/g,"+").replace(/_/g,"/");switch(i.length%4){case 0:break;case 2:i+="==";break;case 3:i+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return b64DecodeUnicode(i)}catch(e){return atob(i)}}function jwtDecode(e,i){if(typeof e!=="string"){throw new InvalidTokenError("Invalid token specified: must be a string")}i||(i={});var n=i.header===true?0:1;var a=e.split(".")[n];if(typeof a!=="string"){throw new InvalidTokenError("Invalid token specified: missing part #".concat(n+1))}var t;try{t=base64UrlDecode(a)}catch(e){throw new InvalidTokenError("Invalid token specified: invalid base64 for part #".concat(n+1," (").concat(e.message,")"))}try{return JSON.parse(t)}catch(e){throw new InvalidTokenError("Invalid token specified: invalid json for part #".concat(n+1," (").concat(e.message,")"))}}var AccessLevel;(function(e){e["private"]="private";e["readonly"]="readonly";e["editable"]="editable"})(AccessLevel||(AccessLevel={}));var DashboardFlow;(function(e){e["short"]="short"})(DashboardFlow||(DashboardFlow={}));var SDKEvents;(function(e){e["waitParams"]="waitSDKParams";e["setParams"]="setParams";e["boardChanged"]="boardChanged";e["tryToCloseApp"]="tryToCloseApp";e["successCloseApp"]="successCloseApp";e["errorCloseApp"]="errorCloseApp";e["renameBoard"]="renameBoard";e["successBoardRenamed"]="successBoardRenamed";e["errorBoardRenamed"]="errorBoardRenamed";e["userIsKicked"]="userIsKicked";e["userConfirmKickFromBoard"]="userConfirmKickFromBoard";e["shareElementWithSocials"]="shareElementWithSocials"})(SDKEvents||(SDKEvents={}));var WebSDK=function(){function e(i){babelHelpers.classCallCheck(this,e);var n,a,t,o,r,s,d,l,u,c,v;this.params=i;var h;var p;var m={};var f={user_id:"",username:"",avatar_url:"",access_level:"read",can_edit_board:false,webhook_url:"",document_id:"",download_link:"",session_id:"",file_name:""};if(i.token){try{f=jwtDecode(i.token);h=f.access_level==="read"?AccessLevel.readonly:AccessLevel.editable;p=f.can_edit_board;m.documentId=f.document_id;m.fileUrl=f.download_link;m.sessionId=f.session_id;m.fileName=f.file_name}catch(e){console.error("invalid token")}}this.boardParams={appUrl:encodeURIComponent(i.appUrl),accessLevel:h,canEditBoard:p,token:i.token,lang:i.lang||"ru",partnerId:i.partnerId||"0",boardUrl:i.boardUrl&&encodeURIComponent(i.boardUrl),ui:{colorTheme:((n=i.ui)===null||n===void 0?void 0:n.colorTheme)||"flipOriginLight",openTemplatesModal:!!((a=i.ui)===null||a===void 0?void 0:a.openTemplatesModal),compactHeader:!!((t=i.ui)===null||t===void 0?void 0:t.compactHeader),showCloseButton:!!((o=i.ui)===null||o===void 0?void 0:o.showCloseButton),dashboardFlow:((r=i.ui)===null||r===void 0?void 0:r.dashboardFlow)||undefined,exportAsFile:((s=i.ui)===null||s===void 0?void 0:s.exportAsFile)!==false,spinner:(d=i.ui)===null||d===void 0?void 0:d.spinner,userKickable:(l=i.ui)===null||l===void 0?void 0:l.userKickable,confirmUserKick:(u=i.ui)===null||u===void 0?void 0:u.confirmUserKick,scrollToElement:(c=i.ui)===null||c===void 0?void 0:c.scrollToElement,features:(v=i.ui)===null||v===void 0?void 0:v.features},appContainerDomain:window.location.origin,boardData:m};this.iframeEl=document.createElement("iframe");this.iframeEl.allow="clipboard-read; clipboard-write; fullscreen";window.addEventListener("beforeunload",this.destroy.bind(this))}babelHelpers.createClass(e,[{key:"init",value:function e(){var i=document.getElementById(this.params.containerId);if(!i){console.error('\u042d\u043b\u0435\u043c\u0435\u043d\u0442 \u0441 id "'.concat(this.params.containerId,'" \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d.'));return}this.iframeEl.src=this.createUrl();this.iframeEl.style.width="100%";this.iframeEl.style.height="100%";this.iframeEl.style.border="none";i.appendChild(this.iframeEl);this.addEventListener();window.FlipBoard=this.getBoardMethods()}},{key:"getBoardMethods",value:function e(){var i=this;return{tryToCloseBoard:function e(){return new Promise((function(e,n){var a;window.addEventListener("message",(function(i){var a,t;if(((a=i.data)===null||a===void 0?void 0:a.event)===SDKEvents.successCloseApp){e()}if(((t=i.data)===null||t===void 0?void 0:t.event)===SDKEvents.errorCloseApp){n()}}));(a=i.iframeEl.contentWindow)===null||a===void 0?void 0:a.postMessage({event:SDKEvents.tryToCloseApp},"*")}))},renameBoard:function e(n){return new Promise((function(e,a){var t;window.addEventListener("message",(function(i){var n,t;if(((n=i.data)===null||n===void 0?void 0:n.event)===SDKEvents.successBoardRenamed){e()}if(((t=i.data)===null||t===void 0?void 0:t.event)===SDKEvents.errorBoardRenamed){a()}}));(t=i.iframeEl.contentWindow)===null||t===void 0?void 0:t.postMessage({event:SDKEvents.renameBoard,data:{name:n}},"*")}))}}}},{key:"createUrl",value:function e(){var i=new URL("".concat(this.params.appUrl).concat(this.boardParams.partnerId==="0"?"/sdkBoard":""));i.searchParams.set("fromSDK","true");if(this.boardParams.ui.openTemplatesModal)i.searchParams.set("openTemplates","true");if(this.boardParams.ui.spinner&&this.boardParams.ui.spinner!=="default")i.searchParams.set("spinner",this.boardParams.ui.spinner);i.searchParams.set("dt",Date.now().toString());if(this.boardParams.ui.scrollToElement)i.searchParams.set("elementId",this.boardParams.ui.scrollToElement);return i.toString()}},{key:"addEventListener",value:function e(){window.addEventListener("message",this.listenBoardEvents.bind(this))}},{key:"listenBoardEvents",value:function e(i){var n,a,t,o,r,s,d,l,u,c,v,h,p,m,f,k,b,g,E,w,B,S,y,C,D,I,K,L,P;if(((n=i.data)===null||n===void 0?void 0:n.event)===SDKEvents.waitParams){(a=this.iframeEl.contentWindow)===null||a===void 0?void 0:a.postMessage({event:SDKEvents.setParams,data:this.boardParams},"*")}if(((t=i.data)===null||t===void 0?void 0:t.event)===SDKEvents.boardChanged){if((r=(o=this.params)===null||o===void 0?void 0:o.events)===null||r===void 0?void 0:r.onBoardChanged){this.params.events.onBoardChanged()}}if(((s=i.data)===null||s===void 0?void 0:s.event)===SDKEvents.successBoardRenamed){if((l=(d=this.params)===null||d===void 0?void 0:d.events)===null||l===void 0?void 0:l.onBoardRenamed){this.params.events.onBoardRenamed(((c=(u=i.data)===null||u===void 0?void 0:u.data)===null||c===void 0?void 0:c.name)||"")}}if(((v=i.data)===null||v===void 0?void 0:v.event)===SDKEvents.userIsKicked){if((p=(h=this.params)===null||h===void 0?void 0:h.events)===null||p===void 0?void 0:p.onUserKicked){(f=(m=this.params)===null||m===void 0?void 0:m.events)===null||f===void 0?void 0:f.onUserKicked()}}if(((k=i.data)===null||k===void 0?void 0:k.event)===SDKEvents.userConfirmKickFromBoard){if((g=(b=this.params)===null||b===void 0?void 0:b.events)===null||g===void 0?void 0:g.onUserKickConfirmed){(w=(E=this.params)===null||E===void 0?void 0:E.events)===null||w===void 0?void 0:w.onUserKickConfirmed()}}if(((B=i.data)===null||B===void 0?void 0:B.event)===SDKEvents.shareElementWithSocials){if((y=(S=this.params)===null||S===void 0?void 0:S.events)===null||y===void 0?void 0:y.onShareElementWithSocials){(D=(C=this.params)===null||C===void 0?void 0:C.events)===null||D===void 0?void 0:D.onShareElementWithSocials(((K=(I=i.data)===null||I===void 0?void 0:I.data)===null||K===void 0?void 0:K.link)||"",((P=(L=i.data)===null||L===void 0?void 0:L.data)===null||P===void 0?void 0:P.social)||"telegram")}}}},{key:"destroy",value:function e(){window.removeEventListener("message",this.listenBoardEvents)}}]);return e}();var Board=function(){function Board(e){babelHelpers.classCallCheck(this,Board);babelHelpers.defineProperty(this,"setupSharingButton",null);babelHelpers.defineProperty(this,"data",null);babelHelpers.defineProperty(this,"unifiedLinkAccessOnly",false);this.setupSharingButton=ui_buttons.ButtonManager.createByUniqId(e.panelButtonUniqIds.setupSharing);this.data=e.boardData;this.sharingControlType=e.sharingControlType;this.unifiedLinkAccessOnly=e.unifiedLinkAccessOnly;this.bindEvents()}babelHelpers.createClass(Board,[{key:"bindEvents",value:function e(){if(this.setupSharingButton){var i=this.setupSharingButton.getMenuWindow();var n=i.getMenuItem("ext-link").options;n.onclick=this.handleClickSharingByExternalLink.bind(this);i.removeMenuItem("ext-link");i.addMenuItem(n);var a=i.getMenuItem("sharing").options;a.onclick=this.handleClickSharing.bind(this);i.removeMenuItem("sharing");i.addMenuItem(a)}}},{key:"handleClickSharingByExternalLink",value:function handleClickSharingByExternalLink(event,menuItem){this.setupSharingButton.getMenuWindow().close();if(menuItem.dataset.shouldBlockExternalLinkFeature){eval(menuItem.dataset.blockerExternalLinkFeature);return}if(this.unifiedLinkAccessOnly){disk_externalLink.ExternalLinkForUnifiedLink.showPopup(this.data.uniqueCode)}else{disk_externalLink.ExternalLink.showPopup(this.data.id)}}},{key:"handleClickSharing",value:function e(){this.setupSharingButton.getMenuWindow().close();this.showSharingRightsPopup()}},{key:"showSharingRightsPopup",value:function e(){var i=new disk_sharingLegacyPopup.LegacyPopup;var n={object:{id:this.data.id,name:this.data.name}};switch(this.sharingControlType){case disk_sharingLegacyPopup.SharingControlType.WITH_CHANGE_RIGHTS:case disk_sharingLegacyPopup.SharingControlType.WITH_SHARING:i.showSharingDetailWithChangeRights(n);break;case disk_sharingLegacyPopup.SharingControlType.WITHOUT_EDIT:i.showSharingDetailWithoutEdit(n);break;default:break}}}]);return Board}();var SDK=WebSDK;exports.Board=Board;exports.SDK=SDK})(this.BX.Disk.Flipchart=this.BX.Disk.Flipchart||{},BX.UI,BX.Main,BX.Disk,BX.Disk.Sharing);
//# sourceMappingURL=script.map.js