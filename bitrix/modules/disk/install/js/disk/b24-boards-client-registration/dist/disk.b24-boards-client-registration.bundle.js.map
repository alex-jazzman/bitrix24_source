{"version":3,"file":"disk.b24-boards-client-registration.bundle.js","sources":["../src/client-registration.js","../src/client-unregistration.js"],"sourcesContent":["import {ClientRegistrationOptions} from \"./types\";\nimport {ajax as Ajax, Tag, Loc, Extension} from \"main.core\";\nimport {Popup} from \"main.popup\";\nimport {SaveButton} from \"ui.buttons\";\n\nconst DEFAULT_LANGUAGE_ID = 'en';\n\nexport default class ClientRegistration\n{\n\n\toptions: ClientRegistrationOptions;\n\tpopupContainerId = 'content-register-modal';\n\n\tconstructor(options: ClientRegistrationOptions)\n\t{\n\t\tthis.options = options;\n\n\t\tthis.bindEvents();\n\t}\n\n\tbindEvents()\n\t{}\n\n\tstart()\n\t{\n\t\tconst allowedServerPromise = Ajax.runAction('disk.api.integration.b24documents.listAllowedServers')\n\t\t\t.then(response => {\n\t\t\t\t\treturn response.data.servers;\n\t\t\t\t}\n\t\t\t);\n\n\t\tconst warning = Loc.getMessage('JS_B24_BOARDS_CLIENT_REGISTRATION_WARNING', {'#NAME#' : this.#getServiceName()});\n\n\t\tconst popupContent = Tag.render`\n\t\t\t<div class=\"ui-form\" id=\"${this.popupContainerId}\" style=\"padding-top: 20px\">\n\t\t\t\t<div class=\"ui-form-row\" style=\"display: none\">\n\t\t\t\t\t<div class=\"ui-alert ui-alert-danger\">\n\t\t\t\t\t\t<span class=\"ui-alert-message\"></span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"ui-form-row\">\n\t\t\t\t\t<div class=\"ui-form-label\">\n\t\t\t\t\t\t<div class=\"ui-ctl-label-text\">${Loc.getMessage('JS_B24_BOARDS_CLIENT_REGISTRATION_SELECT_SERVER_LABEL')}</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"ui-form-content\">\n\t\t\t\t\t\t<div class=\"ui-ctl ui-ctl-after-icon ui-ctl-dropdown\">\n\t\t\t\t\t\t\t<div class=\"ui-ctl-after ui-ctl-icon-angle\"></div>\n\t\t\t\t\t\t\t<select class=\"ui-ctl-element\"></select>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"ui-form-row\">\n\t\t\t\t\t<div class=\"ui-form-label\">\n\t\t\t\t\t\t<div class=\"ui-ctl-label-text\">${warning}</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\n\t\tconst popup = new Popup({\n\t\t\toverlay: true,\n\t\t\theight: 280,\n\t\t\twidth: 350,\n\t\t\tcontent: popupContent,\n\t\t\tcloseIcon: true,\n\t\t\tevents: {\n\t\t\t\tonAfterClose: () => popup.destroy(),\n\t\t\t},\n\t\t\tbuttons: [\n\t\t\t\tnew SaveButton({\n\t\t\t\t\ttext: Loc.getMessage('JS_B24_BOARDS_CLIENT_REGISTRATION_BUTTON'),\n\t\t\t\t\tonclick: this.handleClickRegister.bind(this),\n\t\t\t\t}),\n\t\t\t]\n\t\t});\n\t\tpopup.show();\n\n\t\tallowedServerPromise.then(servers => {\n\t\t\tconst select = popupContent.querySelector('select');\n\t\t\tservers.forEach(server => {\n\t\t\t\tconst regionSuffix = server.region ? ` (${server.region})` : '';\n\t\t\t\tselect.add(Tag.render`<option value=\"${server.proxy}\">${server.proxy}${regionSuffix}</option>`);\n\t\t\t})\n\t\t})\n\t}\n\n\t#getSelectedServer(): string\n\t{\n\t\tconst selectNode = document.querySelector(`#${this.popupContainerId} select`);\n\t\tif (!selectNode)\n\t\t{\n\t\t\treturn '';\n\t\t}\n\n\t\treturn selectNode.value;\n\t}\n\n\t#getLanguageId(): string\n\t{\n\t\treturn Loc.hasMessage('LANGUAGE_ID') ? Loc.getMessage('LANGUAGE_ID') : DEFAULT_LANGUAGE_ID;\n\t}\n\n\t#getServiceName(): string\n\t{\n\t\treturn Extension.getSettings('disk.b24-boards-client-registration').get('serviceName');\n\t}\n\n\t#showOnlyErrorRowInPopup(message: string): void\n\t{\n\t\tconst rows = document.querySelectorAll(`#${this.popupContainerId} .ui-form-row`);\n\t\trows.forEach(row => {\n\t\t\trow.style.display = 'none';\n\t\t});\n\n\t\trows[0].style.display = '';\n\t\trows[0].querySelector('.ui-alert-message').textContent = message;\n\t}\n\n\thandleClickRegister(button: SaveButton, event: MouseEvent)\n\t{\n\t\tbutton.setDisabled();\n\n\t\tconst loader = new BX.Loader({\n\t\t\ttarget: button.getContainer(),\n\t\t\tsize: 45,\n\t\t});\n\t\tloader.show();\n\n\t\tAjax.runAction('disk.api.integration.b24boards.registerCloudClient', {\n\t\t\tdata: {\n\t\t\t\tserviceUrl: this.#getSelectedServer(),\n\t\t\t\tlanguageId: this.#getLanguageId(),\n\t\t\t}\n\t\t}).then(() => {\n\t\t\tdocument.location.reload();\n\t\t}).catch((response) => {\n\t\t\tconsole.warn('Registration error', response);\n\n\t\t\tloader.hide();\n\t\t\tthis.#showOnlyErrorRowInPopup(\n\t\t\t\tthis.#buildUsefulErrorText(response.errors || [])\n\t\t\t);\n\t\t});\n\t}\n\n\t#buildUsefulErrorText(errors: Array): string\n\t{\n\t\tfor (const error of errors)\n\t\t{\n\t\t\tif (error.code === 'tariff_restriction')\n\t\t\t{\n\t\t\t\treturn Loc.getMessage('JS_B24_BOARDS_CLIENT_REGISTRATION_ERROR_AFTER_REG', {'#NAME#' : this.#getServiceName()});\n\t\t\t}\n\t\t\tif (error.code === 'should_show_in_ui')\n\t\t\t{\n\t\t\t\treturn error.message;\n\t\t\t}\n\t\t\tif (error.code === 'domain_verification')\n\t\t\t{\n\t\t\t\treturn Loc.getMessage('JS_B24_BOARDS_CLIENT_REGISTRATION_ERROR_DOMAIN_VERIFICATION', {\n\t\t\t\t\t'#NAME#' : this.#getServiceName(),\n\t\t\t\t\t'#DOMAIN#' : error.customData.domain,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\treturn Loc.getMessage('JS_B24_BOARDS_CLIENT_REGISTRATION_ERROR_COMMON');\n\t}\n};","import {ClientRegistrationOptions} from \"./types\";\nimport {ajax as Ajax, Loc, Extension} from \"main.core\";\nimport {MessageBox} from \"ui.dialogs.messagebox\";\n\nconst DEFAULT_LANGUAGE_ID = 'en';\n\nexport default class ClientUnRegistration\n{\n\tmessageBox: MessageBox;\n\toptions: ClientRegistrationOptions;\n\tpopupContainerId = 'content-register-modal';\n\n\tconstructor(options: ClientRegistrationOptions)\n\t{\n\t\tthis.options = options;\n\n\t\tthis.bindEvents();\n\t}\n\n\tbindEvents()\n\t{}\n\n\tstart()\n\t{\n\t\tthis.messageBox = MessageBox.create({\n\t\t\ttitle: Loc.getMessage('JS_B24_BOARDS_CLIENT_UNREGISTRATION_TITLE', {'#NAME#' : this.#getServiceName()}),\n\t\t\tmessage: Loc.getMessage('JS_B24_BOARDS_CLIENT_UNREGISTRATION_MSG', {'#NAME#' : this.#getServiceName()}),\n\t\t\tbuttons: BX.UI.Dialogs.MessageBoxButtons.OK_CANCEL,\n\t\t\tokCaption: Loc.getMessage('JS_B24_BOARDS_CLIENT_UNREGISTRATION_UNREGISTER_BTN'),\n\t\t\tonOk: () => {\n\t\t\t\tconsole.log(this);\n\t\t\t\tthis.handleClickUnregister();\n\t\t\t},\n\t\t});\n\t\tthis.messageBox.show();\n\t}\n\n\t#getLanguageId(): string\n\t{\n\t\treturn Loc.hasMessage('LANGUAGE_ID') ? Loc.getMessage('LANGUAGE_ID') : DEFAULT_LANGUAGE_ID;\n\t}\n\n\t#getServiceName(): string\n\t{\n\t\treturn Extension.getSettings('disk.b24-boards-client-registration').get('serviceName');\n\t}\n\n\thandleClickUnregister()\n\t{\n\t\tAjax.runAction('disk.api.integration.b24boards.unregisterCloudClient', {\n\t\t\tdata: {\n\t\t\t\tlanguageId: this.#getLanguageId(),\n\t\t\t}\n\t\t}).then(() => {\n\t\t\tdocument.location.reload();\n\t\t}).catch((response) => {\n\t\t\tconsole.warn('Unregistration error', response);\n\n\t\t\tthis.messageBox.setMessage(this.#buildUsefulErrorText(response.errors || []));\n\t\t});\n\t}\n\n\t#buildUsefulErrorText(errors: Array): string\n\t{\n\t\tfor (const error of errors)\n\t\t{\n\t\t\tif (error.code === 'should_show_in_ui')\n\t\t\t{\n\t\t\t\treturn error.message;\n\t\t\t}\n\t\t}\n\n\t\treturn Loc.getMessage('JS_B24_BOARDS_CLIENT_UNREGISTRATION_ERROR_COMMON');\n\t}\n};"],"names":["DEFAULT_LANGUAGE_ID","ClientRegistration","options","bindEvents","allowedServerPromise","Ajax","runAction","then","response","data","servers","warning","Loc","getMessage","popupContent","Tag","render","popupContainerId","popup","Popup","overlay","height","width","content","closeIcon","events","onAfterClose","destroy","buttons","SaveButton","text","onclick","handleClickRegister","bind","show","select","querySelector","forEach","server","regionSuffix","region","add","proxy","button","event","setDisabled","loader","BX","Loader","target","getContainer","size","serviceUrl","languageId","document","location","reload","console","warn","hide","errors","selectNode","value","hasMessage","Extension","getSettings","get","message","rows","querySelectorAll","row","style","display","textContent","error","code","customData","domain","ClientUnRegistration","_classPrivateMethodInitSpec","messageBox","MessageBox","create","title","UI","Dialogs","MessageBoxButtons","OK_CANCEL","okCaption","onOk","log","handleClickUnregister","setMessage"],"mappings":";;;;;;;;;;;;;AAAA,CAKA,IAAMA,mBAAmB,GAAG,IAAI;CAAC;CAAA;CAAA;CAAA;CAAA;AAAA,KAEZC,kBAAkB;GAMtC,4BAAYC,OAAkC,EAC9C;KAAA;KAAA;KAAA;KAAA;KAAA;KAAA;KAAA,sDAHmB,wBAAwB;KAI1C,IAAI,CAACA,OAAO,GAAGA,OAAO;KAEtB,IAAI,CAACC,UAAU,EAAE;;GACjB;KAAA;KAAA,6BAGD;;KAAE;KAAA,wBAGF;OACC,IAAMC,oBAAoB,GAAGC,cAAI,CAACC,SAAS,CAAC,sDAAsD,CAAC,CACjGC,IAAI,CAAC,UAAAC,QAAQ,EAAI;SAChB,OAAOA,QAAQ,CAACC,IAAI,CAACC,OAAO;QAC5B,CACD;OAEF,IAAMC,OAAO,GAAGC,aAAG,CAACC,UAAU,CAAC,2CAA2C,EAAE;SAAC,QAAQ,yBAAG,IAAI,0CAAJ,IAAI;QAAmB,CAAC;OAEhH,IAAMC,YAAY,GAAGC,aAAG,CAACC,MAAM,69BACH,IAAI,CAACC,gBAAgB,EAQZL,aAAG,CAACC,UAAU,CAAC,uDAAuD,CAAC,EAWvEF,OAAO,CAI3C;OAED,IAAMO,KAAK,GAAG,IAAIC,gBAAK,CAAC;SACvBC,OAAO,EAAE,IAAI;SACbC,MAAM,EAAE,GAAG;SACXC,KAAK,EAAE,GAAG;SACVC,OAAO,EAAET,YAAY;SACrBU,SAAS,EAAE,IAAI;SACfC,MAAM,EAAE;WACPC,YAAY,EAAE;aAAA,OAAMR,KAAK,CAACS,OAAO,EAAE;;UACnC;SACDC,OAAO,EAAE,CACR,IAAIC,qBAAU,CAAC;WACdC,IAAI,EAAElB,aAAG,CAACC,UAAU,CAAC,0CAA0C,CAAC;WAChEkB,OAAO,EAAE,IAAI,CAACC,mBAAmB,CAACC,IAAI,CAAC,IAAI;UAC3C,CAAC;QAEH,CAAC;OACFf,KAAK,CAACgB,IAAI,EAAE;OAEZ9B,oBAAoB,CAACG,IAAI,CAAC,UAAAG,OAAO,EAAI;SACpC,IAAMyB,MAAM,GAAGrB,YAAY,CAACsB,aAAa,CAAC,QAAQ,CAAC;SACnD1B,OAAO,CAAC2B,OAAO,CAAC,UAAAC,MAAM,EAAI;WACzB,IAAMC,YAAY,GAAGD,MAAM,CAACE,MAAM,eAAQF,MAAM,CAACE,MAAM,SAAM,EAAE;WAC/DL,MAAM,CAACM,GAAG,CAAC1B,aAAG,CAACC,MAAM,4HAAkBsB,MAAM,CAACI,KAAK,EAAKJ,MAAM,CAACI,KAAK,EAAGH,YAAY,EAAY;UAC/F,CAAC;QACF,CAAC;;;KACF;KAAA,oCAkCmBI,MAAkB,EAAEC,KAAiB,EACzD;OAAA;OACCD,MAAM,CAACE,WAAW,EAAE;OAEpB,IAAMC,MAAM,GAAG,IAAIC,EAAE,CAACC,MAAM,CAAC;SAC5BC,MAAM,EAAEN,MAAM,CAACO,YAAY,EAAE;SAC7BC,IAAI,EAAE;QACN,CAAC;OACFL,MAAM,CAACZ,IAAI,EAAE;OAEb7B,cAAI,CAACC,SAAS,CAAC,oDAAoD,EAAE;SACpEG,IAAI,EAAE;WACL2C,UAAU,yBAAE,IAAI,gDAAJ,IAAI,CAAqB;WACrCC,UAAU,yBAAE,IAAI,wCAAJ,IAAI;;QAEjB,CAAC,CAAC9C,IAAI,CAAC,YAAM;SACb+C,QAAQ,CAACC,QAAQ,CAACC,MAAM,EAAE;QAC1B,CAAC,SAAM,CAAC,UAAChD,QAAQ,EAAK;SACtBiD,OAAO,CAACC,IAAI,CAAC,oBAAoB,EAAElD,QAAQ,CAAC;SAE5CsC,MAAM,CAACa,IAAI,EAAE;SACb,4BAAI,4DAAJ,KAAI,yBACH,KAAI,sDAAJ,KAAI,EAAuBnD,QAAQ,CAACoD,MAAM,IAAI,EAAE;QAEjD,CAAC;;;GACF;CAAA;CAAA,+BAxDD;GACC,IAAMC,UAAU,GAAGP,QAAQ,CAAClB,aAAa,YAAK,IAAI,CAACnB,gBAAgB,aAAU;GAC7E,IAAI,CAAC4C,UAAU,EACf;KACC,OAAO,EAAE;;GAGV,OAAOA,UAAU,CAACC,KAAK;CACxB;CAAC,2BAGD;GACC,OAAOlD,aAAG,CAACmD,UAAU,CAAC,aAAa,CAAC,GAAGnD,aAAG,CAACC,UAAU,CAAC,aAAa,CAAC,GAAGb,mBAAmB;CAC3F;CAAC,4BAGD;GACC,OAAOgE,mBAAS,CAACC,WAAW,CAAC,qCAAqC,CAAC,CAACC,GAAG,CAAC,aAAa,CAAC;CACvF;CAAC,mCAEwBC,OAAe,EACxC;GACC,IAAMC,IAAI,GAAGd,QAAQ,CAACe,gBAAgB,YAAK,IAAI,CAACpD,gBAAgB,mBAAgB;GAChFmD,IAAI,CAAC/B,OAAO,CAAC,UAAAiC,GAAG,EAAI;KACnBA,GAAG,CAACC,KAAK,CAACC,OAAO,GAAG,MAAM;IAC1B,CAAC;GAEFJ,IAAI,CAAC,CAAC,CAAC,CAACG,KAAK,CAACC,OAAO,GAAG,EAAE;GAC1BJ,IAAI,CAAC,CAAC,CAAC,CAAChC,aAAa,CAAC,mBAAmB,CAAC,CAACqC,WAAW,GAAGN,OAAO;CACjE;CAAC,gCA6BqBP,MAAa,EACnC;GAAA,2CACqBA,MAAM;KAAA;GAAA;KAA1B,oDACA;OAAA,IADWc,KAAK;OAEf,IAAIA,KAAK,CAACC,IAAI,KAAK,oBAAoB,EACvC;SACC,OAAO/D,aAAG,CAACC,UAAU,CAAC,mDAAmD,EAAE;WAAC,QAAQ,yBAAG,IAAI,0CAAJ,IAAI;UAAmB,CAAC;;OAEhH,IAAI6D,KAAK,CAACC,IAAI,KAAK,mBAAmB,EACtC;SACC,OAAOD,KAAK,CAACP,OAAO;;OAErB,IAAIO,KAAK,CAACC,IAAI,KAAK,qBAAqB,EACxC;SACC,OAAO/D,aAAG,CAACC,UAAU,CAAC,6DAA6D,EAAE;WACpF,QAAQ,yBAAG,IAAI,0CAAJ,IAAI,CAAkB;WACjC,UAAU,EAAG6D,KAAK,CAACE,UAAU,CAACC;UAC9B,CAAC;;;;KAEH;;KAAA;;GAED,OAAOjE,aAAG,CAACC,UAAU,CAAC,gDAAgD,CAAC;CACxE;;;;;;;;ACvKD,CAIA,IAAMb,qBAAmB,GAAG,IAAI;CAAC;CAAA;CAAA;AAAA,KAEZ8E,oBAAoB;GAMxC,8BAAY5E,OAAkC,EAC9C;KAAA;KAAA6E;KAAAA;KAAAA;KAAA,sDAHmB,wBAAwB;KAI1C,IAAI,CAAC7E,OAAO,GAAGA,OAAO;KAEtB,IAAI,CAACC,UAAU,EAAE;;GACjB;KAAA;KAAA,6BAGD;;KAAE;KAAA,wBAGF;OAAA;OACC,IAAI,CAAC6E,UAAU,GAAGC,gCAAU,CAACC,MAAM,CAAC;SACnCC,KAAK,EAAEvE,aAAG,CAACC,UAAU,CAAC,2CAA2C,EAAE;WAAC,QAAQ,2BAAG,IAAI,8CAAJ,IAAI;UAAmB,CAAC;SACvGsD,OAAO,EAAEvD,aAAG,CAACC,UAAU,CAAC,yCAAyC,EAAE;WAAC,QAAQ,2BAAG,IAAI,8CAAJ,IAAI;UAAmB,CAAC;SACvGe,OAAO,EAAEmB,EAAE,CAACqC,EAAE,CAACC,OAAO,CAACC,iBAAiB,CAACC,SAAS;SAClDC,SAAS,EAAE5E,aAAG,CAACC,UAAU,CAAC,oDAAoD,CAAC;SAC/E4E,IAAI,EAAE,gBAAM;WACXhC,OAAO,CAACiC,GAAG,CAAC,KAAI,CAAC;WACjB,KAAI,CAACC,qBAAqB,EAAE;;QAE7B,CAAC;OACF,IAAI,CAACX,UAAU,CAAC9C,IAAI,EAAE;;;KACtB;KAAA,wCAaD;OAAA;OACC7B,cAAI,CAACC,SAAS,CAAC,sDAAsD,EAAE;SACtEG,IAAI,EAAE;WACL4C,UAAU,2BAAE,IAAI,4CAAJ,IAAI;;QAEjB,CAAC,CAAC9C,IAAI,CAAC,YAAM;SACb+C,QAAQ,CAACC,QAAQ,CAACC,MAAM,EAAE;QAC1B,CAAC,SAAM,CAAC,UAAChD,QAAQ,EAAK;SACtBiD,OAAO,CAACC,IAAI,CAAC,sBAAsB,EAAElD,QAAQ,CAAC;SAE9C,MAAI,CAACwE,UAAU,CAACY,UAAU,0BAAC,MAAI,0DAAJ,MAAI,EAAuBpF,QAAQ,CAACoD,MAAM,IAAI,EAAE,EAAE;QAC7E,CAAC;;;GACF;CAAA;CAAA,6BAtBD;GACC,OAAOhD,aAAG,CAACmD,UAAU,CAAC,aAAa,CAAC,GAAGnD,aAAG,CAACC,UAAU,CAAC,aAAa,CAAC,GAAGb,qBAAmB;CAC3F;CAAC,8BAGD;GACC,OAAOgE,mBAAS,CAACC,WAAW,CAAC,qCAAqC,CAAC,CAACC,GAAG,CAAC,aAAa,CAAC;CACvF;CAAC,kCAiBqBN,MAAa,EACnC;GAAA,6CACqBA,MAAM;KAAA;GAAA;KAA1B,oDACA;OAAA,IADWc,KAAK;OAEf,IAAIA,KAAK,CAACC,IAAI,KAAK,mBAAmB,EACtC;SACC,OAAOD,KAAK,CAACP,OAAO;;;;KAErB;;KAAA;;GAED,OAAOvD,aAAG,CAACC,UAAU,CAAC,kDAAkD,CAAC;CAC1E;;;;;;;;;"}