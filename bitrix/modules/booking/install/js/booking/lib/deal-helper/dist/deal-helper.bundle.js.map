{"version":3,"file":"deal-helper.bundle.js","sources":["../src/deal-helper.js","../src/booking-deal-helper.js","../src/wait-list-deal-helper.js"],"sourcesContent":["import { Uri } from 'main.core';\nimport { SidePanel as SidePanelMain } from 'main.sidepanel';\n\nimport { CrmEntity, Module } from 'booking.const';\nimport type { DealData } from 'booking.model.bookings';\nimport type { ClientData } from 'booking.model.clients';\n\nimport type { CreateCrmDealParams } from './types';\n\nconst SidePanel = SidePanelMain || BX.SidePanel;\n\nexport class DealHelper\n{\n\topenDealSidePanel({ deal, onClose }: { deal: DealData, onClose: (DealData | null) => void }): void\n\t{\n\t\tSidePanel.Instance.open(`/crm/deal/details/${deal.value}/`, {\n\t\t\tevents: {\n\t\t\t\tonClose: () => onClose(deal),\n\t\t\t},\n\t\t});\n\t}\n\n\tcreateCrmDeal({\n\t\titemId,\n\t\titemIdQueryParamName,\n\t\tqueryParams = {},\n\t\tclients,\n\t\tonLoad,\n\t\tonClose,\n\t}: CreateCrmDealParams): void\n\t{\n\t\tconst createDealUrl = new Uri('/crm/deal/details/0/');\n\t\tcreateDealUrl.setQueryParam(itemIdQueryParamName, itemId);\n\n\t\tObject.keys(queryParams).forEach((queryParamsKey: string) => {\n\t\t\tcreateDealUrl.setQueryParam(queryParamsKey, queryParams[queryParamsKey]);\n\t\t});\n\n\t\tclients.forEach((client: ClientData) => {\n\t\t\tconst paramName = {\n\t\t\t\t[CrmEntity.Contact]: 'contact_id',\n\t\t\t\t[CrmEntity.Company]: 'company_id',\n\t\t\t}[client.type.code];\n\n\t\t\tcreateDealUrl.setQueryParam(paramName, client.id);\n\t\t});\n\n\t\tSidePanel.Instance.open(createDealUrl.toString(), {\n\t\t\tevents: {\n\t\t\t\tonLoad: ({ slider }) => {\n\t\t\t\t\tslider.getWindow().BX.Event.EventEmitter.subscribe('onCrmEntityCreate', (event) => {\n\t\t\t\t\t\tconst [data] = event.getData();\n\t\t\t\t\t\tonLoad({\n\t\t\t\t\t\t\tisDeal: data.entityTypeName === CrmEntity.Deal,\n\t\t\t\t\t\t\tisCanceled: data.isCanceled,\n\t\t\t\t\t\t\titemIdFromQuery: parseInt(new Uri(data.sliderUrl).getQueryParam(itemIdQueryParamName), 10),\n\t\t\t\t\t\t\tdealData: this.mapEntityInfoToDeal(data.entityInfo),\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t\tonClose: () => onClose(),\n\t\t\t},\n\t\t});\n\t}\n\n\tmapEntityInfoToDeal(info: Object): DealData\n\t{\n\t\treturn {\n\t\t\tmoduleId: Module.Crm,\n\t\t\tentityTypeId: info.typeName,\n\t\t\tvalue: info.id,\n\t\t\tdata: [],\n\t\t};\n\t}\n}\n","import { Core } from 'booking.core';\nimport { CrmEntity, Model } from 'booking.const';\nimport { bookingService } from 'booking.provider.service.booking-service';\nimport type { BookingModel, DealData } from 'booking.model.bookings';\n\nimport { DealHelper } from './deal-helper';\nimport type { CreateCrmDealLoadParams } from './types';\n\nexport class BookingDealHelper extends DealHelper\n{\n\t#bookingId: number;\n\n\tconstructor(bookingId: number)\n\t{\n\t\tsuper();\n\t\tthis.#bookingId = bookingId;\n\t}\n\n\thasDeal(): boolean\n\t{\n\t\treturn Boolean(this.#deal);\n\t}\n\n\tget #deal(): DealData | null\n\t{\n\t\treturn this.#booking?.externalData?.find((data) => data.entityTypeId === CrmEntity.Deal) || null;\n\t}\n\n\tget #booking(): BookingModel\n\t{\n\t\treturn Core.getStore().getters[`${Model.Bookings}/getById`](this.#bookingId);\n\t}\n\n\topenDeal(): void\n\t{\n\t\tsuper.openDealSidePanel({\n\t\t\tdeal: this.#deal,\n\t\t\tonClose: async (deal: DealData | null): Promise<void> => {\n\t\t\t\tif (deal?.value)\n\t\t\t\t{\n\t\t\t\t\tvoid bookingService.getById(this.#bookingId);\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\t}\n\n\tcreateDeal(): void\n\t{\n\t\tconst itemIdQueryParamName = 'bookingId';\n\n\t\tsuper.createCrmDeal({\n\t\t\titemIdQueryParamName,\n\t\t\titemId: this.#bookingId,\n\t\t\tclients: this.#booking?.clients || [],\n\t\t\tonLoad: async (data: CreateCrmDealLoadParams): Promise<void> => {\n\t\t\t\tif (!data.isDeal || this.#bookingId !== data.itemIdFromQuery)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tawait this.saveDeal(data.dealData);\n\t\t\t},\n\t\t\tonClose: async (): Promise<void> => {\n\t\t\t\tif (this.#deal?.value)\n\t\t\t\t{\n\t\t\t\t\tawait this.saveDeal(this.#deal);\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\t}\n\n\tsaveDeal(dealData: DealData | null): void\n\t{\n\t\tconst externalData = dealData ? [dealData] : [];\n\n\t\tvoid bookingService.update({\n\t\t\tid: this.#bookingId,\n\t\t\texternalData,\n\t\t});\n\t}\n}\n","import { Core } from 'booking.core';\nimport { CrmEntity, Model } from 'booking.const';\nimport { waitListService } from 'booking.provider.service.wait-list-service';\nimport type { DealData } from 'booking.model.booking';\nimport type { WaitListItemModel } from 'booking.model.wait-list';\n\nimport { DealHelper } from './deal-helper';\nimport type { CreateCrmDealLoadParams } from './types';\n\nexport class WaitListDealHelper extends DealHelper\n{\n\t#waitListItemId: number;\n\n\tconstructor(waitListItemId: number)\n\t{\n\t\tsuper();\n\t\tthis.#waitListItemId = waitListItemId;\n\t}\n\n\thasDeal(): boolean\n\t{\n\t\treturn Boolean(this.#deal);\n\t}\n\n\tget #deal(): DealData | null\n\t{\n\t\treturn this.#waitListItem?.externalData?.find((data) => data.entityTypeId === CrmEntity.Deal) || null;\n\t}\n\n\tget #waitListItem(): WaitListItemModel\n\t{\n\t\treturn Core.getStore().getters[`${Model.WaitList}/getById`](this.#waitListItemId);\n\t}\n\n\topenDeal(): void\n\t{\n\t\tsuper.openDealSidePanel({\n\t\t\tdeal: this.#deal,\n\t\t\tonClose: async (deal: DealData | null): void => {\n\t\t\t\tif (deal?.value)\n\t\t\t\t{\n\t\t\t\t\tawait waitListService.getById(this.#waitListItemId);\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\t}\n\n\tcreateDeal(): void\n\t{\n\t\tconst itemIdQueryParamName = 'waitListItemId';\n\n\t\tsuper.createCrmDeal({\n\t\t\titemIdQueryParamName,\n\t\t\titemId: this.#waitListItemId,\n\t\t\tclients: this.#waitListItem?.clients || [],\n\t\t\tonLoad: async (data: CreateCrmDealLoadParams): Promise<void> => {\n\t\t\t\tif (!data.isDeal || this.#waitListItemId !== data.itemIdFromQuery)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tawait this.saveDeal(data.dealData);\n\t\t\t},\n\t\t\tonClose: async (): Promise<void> => {\n\t\t\t\tif (this.#deal?.value)\n\t\t\t\t{\n\t\t\t\t\tawait this.saveDeal(this.#deal);\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\t}\n\n\tasync saveDeal(dealData: DealData | null): Promise<void>\n\t{\n\t\tconst externalData = dealData ? [dealData] : [];\n\n\t\tawait waitListService.update({\n\t\t\tid: this.#waitListItemId,\n\t\t\texternalData,\n\t\t});\n\t}\n}\n"],"names":["SidePanel","SidePanelMain","BX","DealHelper","openDealSidePanel","deal","onClose","Instance","open","value","events","createCrmDeal","itemId","itemIdQueryParamName","queryParams","clients","onLoad","createDealUrl","Uri","setQueryParam","Object","keys","forEach","queryParamsKey","client","paramName","CrmEntity","Contact","Company","type","code","id","toString","slider","getWindow","Event","EventEmitter","subscribe","event","data","getData","isDeal","entityTypeName","Deal","isCanceled","itemIdFromQuery","parseInt","sliderUrl","getQueryParam","dealData","mapEntityInfoToDeal","entityInfo","info","moduleId","Module","Crm","entityTypeId","typeName","BookingDealHelper","constructor","bookingId","hasDeal","Boolean","openDeal","bookingService","getById","createDeal","saveDeal","externalData","update","find","Core","getStore","getters","Model","Bookings","WaitListDealHelper","waitListItemId","waitListService","WaitList"],"mappings":"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"}