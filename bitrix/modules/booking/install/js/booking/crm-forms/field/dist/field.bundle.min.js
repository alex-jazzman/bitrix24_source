this.BX=this.BX||{};this.BX.Booking=this.BX.Booking||{};(function(t,e,s,o,r,i,n,a,c){"use strict";const l=-1;const u={id:l,name:"",typeName:"",slotRanges:[]};const d=Object.freeze({Sun:0,Mon:1,Tue:2,Wed:3,Thu:4,Fri:5,Sat:6});function h(t){return t.map((t=>({...t,slotRanges:t.slotRanges.map((t=>({...t,weekDays:t.weekDays.map((t=>d[t]))})))})))}let m=null;function f(t){if(m instanceof R){return m}m=new R(t);return m}var p=babelHelpers.classPrivateFieldLooseKey("runAction");var v=babelHelpers.classPrivateFieldLooseKey("timezone");var b=babelHelpers.classPrivateFieldLooseKey("resources");var g=babelHelpers.classPrivateFieldLooseKey("requestCache");var y=babelHelpers.classPrivateFieldLooseKey("requestedResourcesIds");var k=babelHelpers.classPrivateFieldLooseKey("occupancy");var D=babelHelpers.classPrivateFieldLooseKey("requestOccupancy");var O=babelHelpers.classPrivateFieldLooseKey("getPromises");var w=babelHelpers.classPrivateFieldLooseKey("calculateOccupancy");class R{constructor(t){Object.defineProperty(this,w,{value:T});Object.defineProperty(this,O,{value:B});Object.defineProperty(this,D,{value:S});Object.defineProperty(this,p,{writable:true,value:()=>{}});Object.defineProperty(this,v,{writable:true,value:void 0});Object.defineProperty(this,b,{writable:true,value:void 0});Object.defineProperty(this,g,{writable:true,value:{}});Object.defineProperty(this,y,{writable:true,value:{}});Object.defineProperty(this,k,{writable:true,value:{}});babelHelpers.classPrivateFieldLooseBase(this,p)[p]=t}setResources(t){babelHelpers.classPrivateFieldLooseBase(this,b)[b]=t;return this}setTimezone(t){babelHelpers.classPrivateFieldLooseBase(this,v)[v]=t;return this}async getOccupancy(t,e){const s=babelHelpers.classPrivateFieldLooseBase(this,y)[y][e];const o=t.filter((t=>!(s!=null&&s.has(t))));if(o.length>0){var r,i;const t=babelHelpers.classPrivateFieldLooseBase(this,D)[D](o,e);(i=(r=babelHelpers.classPrivateFieldLooseBase(this,g)[g])[e])!=null?i:r[e]={};o.forEach((s=>{babelHelpers.classPrivateFieldLooseBase(this,g)[g][e][s]=t}))}await Promise.all(babelHelpers.classPrivateFieldLooseBase(this,O)[O](t,e));return babelHelpers.classPrivateFieldLooseBase(this,w)[w](t,e)}static calcResourceSlots({date:t,slotRanges:e,resourceOccupancy:s,resourceId:o=null,timezone:i}){const a=[];const c=Date.now();r.SlotRanges.applyTimezone(e,t.getTime(),i).filter((e=>e.weekDays.includes(t.getDay()))).sort(((t,e)=>t.from-e.from)).forEach((e=>{const r=e.slotSize*60*1e3;const i=M(t,e.to);const l=e.slotSize<=120?30:60;const u=l*60*1e3;const d=o===null?s:s.filter((({resourcesIds:t})=>t.includes(o)));let h=M(t,e.from);if(h<c){h=_(h,l)}while(h<i){const t=h+r;if(h<=c||t>i||P({fromTs:h,toTs:t},d)){h+=u;continue}a.push({fromTs:h,toTs:t,label:n.DateTimeFormat.format("H:i",new Date(h))});h+=u}}));return a}}async function S(t,e){var s,o,r,i;(o=(s=babelHelpers.classPrivateFieldLooseBase(this,k)[k])[e])!=null?o:s[e]={};(i=(r=babelHelpers.classPrivateFieldLooseBase(this,y)[y])[e])!=null?i:r[e]=new Set;t.forEach((t=>{var s,o;(o=(s=babelHelpers.classPrivateFieldLooseBase(this,k)[k][e])[t])!=null?o:s[t]=[];babelHelpers.classPrivateFieldLooseBase(this,y)[y][e].add(t)}));const{data:n}=await babelHelpers.classPrivateFieldLooseBase(this,p)[p]("booking.api_v1.CrmForm.getOccupancy",{data:{ids:t,dateTs:e/1e3}});n.forEach((({resourcesIds:t,fromTs:s,toTs:o})=>{t.forEach((r=>{var i;(i=babelHelpers.classPrivateFieldLooseBase(this,k)[k][e][r])==null?void 0:i.push({fromTs:s,toTs:o,resourcesIds:t})}))}))}function B(t,e){return Object.keys(babelHelpers.classPrivateFieldLooseBase(this,g)[g][e]).filter((e=>t.includes(Number(e)))).map((t=>babelHelpers.classPrivateFieldLooseBase(this,g)[g][e][t]))}function T(t,e){const i=new o.Segments([[e,new Date(e).setDate(new Date(e).getDate()+1)]]);const n=babelHelpers.classPrivateFieldLooseBase(this,b)[b].find((({id:e})=>e===t[0]));const a=s.DateFormat.WeekDays[new Date(e).getDay()];r.SlotRanges.applyTimezone(n.slotRanges,e,babelHelpers.classPrivateFieldLooseBase(this,v)[v]).filter((t=>t.weekDays.includes(a))).forEach((t=>i.subtract([new Date(e).setMinutes(t.from),new Date(e).setMinutes(t.to)])));return t.flatMap((t=>babelHelpers.classPrivateFieldLooseBase(this,k)[k][e][t])).map((({fromTs:t,toTs:e,resourcesIds:s})=>({fromTs:t*1e3,toTs:e*1e3,resourcesIds:s})))}function _(t,e){const s=new Date(t);s.setMinutes(e-s.getMinutes()>3?e:e*2);return s.getTime()}function M(t,e){const s=new Date(t);s.setHours(0,0,0,0);s.setMinutes(e);return s.getTime()}function P(t,e){return e.some((e=>t.fromTs>=e.fromTs&&t.fromTs<e.toTs||t.toTs>e.fromTs&&t.toTs<=e.toTs))}const F={name:"ResourceSelector",props:{resources:{type:Array,default:()=>[]}},emits:["select"],template:`\n\t\t<div class="booking--crm-forms--resource-selector">\n\t\t\t<div\n\t\t\t\tv-for="(resource) in resources"\n\t\t\t\t:key="resource.id"\n\t\t\t\tclass="b24-form-control-list-selector-item booking--crm-forms--resource-selector-resource"\n\t\t\t\t@click="$emit('select', resource)"\n\t\t\t>\n\t\t\t\t<div>\n\t\t\t\t\t<div class="booking--crm-forms--time-selector-block-resource-name">\n\t\t\t\t\t\t{{ resource.name }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="booking--crm-forms--time-selector-block-resource-type-name">\n\t\t\t\t\t\t{{ resource.typeName }}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const I={name:"ResourceSelectBlock",components:{ResourceSelector:F},props:{resourceId:{type:Number,required:true},resources:{type:Array,required:true},settingsData:{type:Object,required:true},fetching:{type:Boolean,default:false},errorMessage:{type:String,default:""},hasErrors:{type:Boolean,default:false},dependencies:{type:Object,required:true}},emits:["update:resourceId"],data(){return{dropdownOpened:false}},computed:{label(){var t;return((t=this.settingsData)==null?void 0:t.label)||""},placeholder(){var t;return`${((t=this.settingsData)==null?void 0:t.textHeader)||""} *`},resource(){return this.resources.find((t=>t.id===this.resourceId))},resourceName(){var t;return((t=this.resource)==null?void 0:t.name)||""},hint(){var t,e;return{text:((t=this.settingsData)==null?void 0:t.hint)||"",visible:Boolean((e=this.settingsData)==null?void 0:e.isVisibleHint)}},fieldItemDropdownComponent(){return this.dependencies.mixinDropdown.components["field-item-dropdown"]}},methods:{toggleDropdown(){if(this.dropdownOpened){this.closeDropdown();return}if(this.fetching){return}this.dropdownOpened=true},closeDropdown(){setTimeout((()=>{this.dropdownOpened=false}),0)},setResource(t){this.$emit("update:resourceId",t.id);if(this.dropdownOpened){this.closeDropdown()}}},template:`\n\t\t<div\n\t\t\tclass="booking-crm-forms-field"\n\t\t\t:class="{\n\t\t\t\t'--error': hasErrors,\n\t\t\t}"\n\t\t>\n\t\t\t<div class="b24-form-field-layout-section booking-crm-forms-field-title">\n\t\t\t\t{{ label }}\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tref="tagSelector"\n\t\t\t\tclass="booking-crm-forms-field-tag-selector b24-form-control-string"\n\t\t\t\t:class="{\n\t\t\t\t\t'--disabled': fetching,\n\t\t\t\t}"\n\t\t\t>\n\t\t\t\t<div\n\t\t\t\t\tclass="b24-form-control-container b24-form-control-icon-after"\n\t\t\t\t\t@click="toggleDropdown"\n\t\t\t\t>\n\t\t\t\t\t<input\n\t\t\t\t\t\tname="resourceName"\n\t\t\t\t\t\ttype="text"\n\t\t\t\t\t\treadonly\n\t\t\t\t\t\t:placeholder="placeholder"\n\t\t\t\t\t\t:value="resourceName"\n\t\t\t\t\t\tclass="b24-form-control booking--crm-forms--field-tag-selector-input"\n\t\t\t\t\t\t@click.capture.stop.prevent="toggleDropdown"\n\t\t\t\t\t/>\n\t\t\t\t\t<div class="booking--crm-forms--field-tag-selector-input-icon"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="b24-form-control-alert-message" style="top: 75px">{{ errorMessage }}</div>\n\t\t\t<component\n\t\t\t\tv-if="dropdownOpened"\n\t\t\t\t:is="fieldItemDropdownComponent"\n\t\t\t\t:marginTop="0"\n\t\t\t\t:visible="dropdownOpened"\n\t\t\t\t:title="label"\n\t\t\t\t@close="closeDropdown()"\n\t\t\t>\n\t\t\t\t<ResourceSelector :resources="resources" @select="setResource"/>\n\t\t\t</component>\n\t\t\t<div v-if="hint.visible" class="booking--crm-forms--field-hint">\n\t\t\t\t<div class="booking--crm-forms--field-hint-text">{{ hint.text }}</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const A={name:"CalendarBlock",mixins:[c.locMixin],props:{date:{type:Date,default:null},resource:{type:Object,required:true},titleOnly:{type:Boolean,default:false},hasError:{type:Boolean,default:false},errorMessage:{type:String,default:""}},emits:["updateDate"],data(){return{viewDate:null,disabledPrevMonth:true}},computed:{formattedViewDate(){return n.DateTimeFormat.format("f Y",this.viewDate)},title(){if(this.date!==null&&this.titleOnly){return this.loc("BOOKING_CRM_FORMS_FIELD_TIME_TITLE",{"#DATE#":n.DateTimeFormat.format(this.loc("DAY_MONTH_FORMAT"),this.date)})}return this.loc("BOOKING_CRM_FORMS_FIELD_DATE_TIME_TITLE")}},created(){this.viewDate=this.date;const t=this.date instanceof Date?[this.date.getTime()]:[];this.datePicker=new i.DatePicker({selectedDates:t,startDate:new Date,inline:true,hideHeader:true});this.datePicker.subscribe(i.DatePickerEvent.SELECT,(t=>{const e=t.getData().date;const s=this.toDateFromUtc(e);this.setViewDate();if(s!==this.date){this.$emit("updateDate",s)}}))},mounted(){this.datePicker.setTargetNode(this.$refs.datePicker);this.datePicker.show()},beforeUnmount(){this.datePicker.destroy()},methods:{setPreviousMonth(){const t=this.datePicker.getViewDate();if(t.getMonth()===(new Date).getMonth()){this.updateDisabledPrevMonth();return}this.datePicker.setViewDate(i.getNextDate(t,"month",-1));this.setViewDate()},setNextMonth(){const t=this.datePicker.getViewDate();this.updateDisabledPrevMonth();this.datePicker.setViewDate(i.getNextDate(t,"month"));this.setViewDate()},setViewDate(){this.viewDate=this.toDateFromUtc(this.datePicker.getViewDate());this.updateDisabledPrevMonth()},toDateFromUtc(t){return new Date(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate())},updateDisabledPrevMonth(){const t=this.datePicker.getViewDate();this.disabledPrevMonth=t.getMonth()<=(new Date).getMonth()}},template:`\n\t\t<div\n\t\t\tclass="booking-crm-forms-field booking--crm-forms--calendar-block"\n\t\t\t:class="{\n\t\t\t\t'--error': hasError,\n\t\t\t}"\n\t\t>\n\t\t\t<div class="b24-form-field-layout-section booking-crm-forms-field-title">{{ title }}</div>\n\t\t\t<div\n\t\t\t\tv-if="hasError"\n\t\t\t\tclass="b24-form-control-alert-message"\n\t\t\t\tstyle="top: 30px"\n\t\t\t>\n\t\t\t\t{{ errorMessage }}\n\t\t\t</div>\n\t\t\t<div v-show="!titleOnly" class="booking--crm-forms--calendar-block-content">\n\t\t\t\t<div class="booking--crm-forms--calendar-block-datepicker-header">\n\t\t\t\t\t<div class="booking--crm-forms--calendar-block-datepicker-header-title">\n\t\t\t\t\t\t{{ formattedViewDate }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="booking--crm-forms--calendar-block-datepicker-header-button --left"\n\t\t\t\t\t\t:class="{ '--disabled': disabledPrevMonth }"\n\t\t\t\t\t\t@click="setPreviousMonth"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div class="booking--crm-forms--calendar-block-datepicker-icon --chevron-left"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="booking--crm-forms--calendar-block-datepicker-header-button --right"\n\t\t\t\t\t\t@click="setNextMonth"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div class="booking--crm-forms--calendar-block-datepicker-icon --chevron-right"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div ref="datePicker" class="booking--crm-forms--calendar-block-datepicker"></div>\n\t\t\t</div>\n\t\t</div>\n\t`};const C={name:"ResourceSlotsUiBlock",mixins:[c.locMixin],props:{slot:{type:Object,default:null},date:{type:Date,required:true},resource:{type:Object,required:true},resourceSlots:{type:Array,default:()=>[]},loading:{type:Boolean,default:false}},emits:["select"],computed:{formatDate(){return n.DateTimeFormat.format(this.loc("DAY_MONTH_FORMAT"),this.date)},title(){return this.loc("BOOKING_CRM_FORMS_FIELD_TIME_TITLE",{"#DATE#":this.formatDate})},emptySlotsMessage(){const t=this.date.getDay();if(this.resource.slotRanges.every((({weekDays:e})=>!e.includes(t)))){return this.loc("BOOKING_CRM_FORMS_RESOURCE_RESOURCE_NOT_WORKING_MESSAGE")}return this.loc("BOOKING_CRM_FORMS_RESOURCE_NO_SLOTS_MESSAGE",{"#BR#":"<br />"})}},watch:{loading:{handler(t){if(t){var e;(e=this.loader)==null?void 0:e.show==null?void 0:e.show(this.$refs.slotsContainer)}else{var s;(s=this.loader)==null?void 0:s.hide==null?void 0:s.hide()}},immediate:true}},beforeMount(){this.loader=new a.Loader({target:this.$refs.slotsContainer,size:60})},methods:{selectSlot(t){const e={date:this.date,resource:this.resource,slot:t};this.$emit("select",e)}},template:`\n\t\t<div class="booking-crm-forms-field booking--crm-forms--resource-slots">\n\t\t\t<slot name="title"/>\n\t\t\t<div class="booking--crm-forms--time-selector-block-header">\n\t\t\t\t<div class="booking--crm-forms--time-selector-block-resource">\n\t\t\t\t\t<div class="booking--crm-forms--time-selector-block-resource-name">\n\t\t\t\t\t\t{{ resource.name }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="booking--crm-forms--time-selector-block-resource-type-name">\n\t\t\t\t\t\t{{ resource.typeName }}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="booking--crm-forms--time-selector-block-header__button">\n\t\t\t\t\t<slot name="changeDateBtn" :date="date" :resource="resource"/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div ref="slotsContainer" class="booking--crm-forms--resource-slots__slot-list-wrapper">\n\t\t\t\t<div v-show="!loading" class="booking--crm-forms--resource-slots__slot-list">\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-for="resourceSlot in resourceSlots"\n\t\t\t\t\t\t:key="resourceSlot"\n\t\t\t\t\t\tclass="booking--crm-forms-time-selector-block-time-list-item booking--crm-forms--resource-slots__slot"\n\t\t\t\t\t\t:class="{\n\t\t\t\t\t\t\t'--selected': slot !== null && resourceSlot.fromTs === slot.fromTs\n\t\t\t\t\t\t}"\n\t\t\t\t\t\t@click="selectSlot(resourceSlot)"\n\t\t\t\t\t>\n\t\t\t\t\t\t<span>{{ resourceSlot.label }}</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<template v-if="resourceSlots.length === 0">\n\t\t\t\t\t\t<div class="booking--crm-forms--resource-slots__empty-slots">\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tclass="booking--crm-forms--resource-slots__empty-slots-message"\n\t\t\t\t\t\t\t\tv-html="emptySlotsMessage"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</template>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const E={name:"TimeSelectorBlock",components:{ResourceSlotsUiBlock:C},mixins:[c.locMixin],inject:["isPreview"],props:{slot:{type:Object,default:null},resource:{type:Object,default:null},resources:{type:Array,default:()=>[]},date:{type:Date,required:true},fetching:{type:Boolean,default:false},showChangeDateButton:{type:Boolean,default:false},runAction:{type:Function,required:true},timezone:{type:String,required:true}},emits:["update:slot","update:fetching","showCalendar"],data(){return{resourceOccupancy:[]}},computed:{resourceSlots(){var t;return R.calcResourceSlots({date:this.date,slotRanges:((t=this.resource)==null?void 0:t.slotRanges)||[],resourceOccupancy:this.resourceOccupancy||[],timezone:this.timezone})}},watch:{date:{handler(t){if(t instanceof Date&&!this.isPreview){void this.fetchOccupancy()}},immediate:true},resource:{handler(){if(!this.isPreview){void this.fetchOccupancy()}}}},created(){this.initOccupancy()},methods:{initOccupancy(){if(this.occupancy instanceof R){return}this.occupancy=f(this.runAction);this.occupancy.setResources(this.resources);this.occupancy.setTimezone(this.timezone)},async fetchOccupancy(){if(!this.date||this.fetching||this.resource===null){return}if(!this.occupancy){this.initOccupancy()}this.$emit("update:fetching",true);try{const t=await this.occupancy.getOccupancy([this.resource.id],this.date.getTime());this.resourceOccupancy=t||[]}catch(t){console.error("Booking.CrmForms. GetOccupancy error",t)}finally{this.$emit("update:fetching",false)}},changeSlot({slot:t}){this.$emit("update:slot",t)},changeDate(){this.$emit("showCalendar")}},template:`\n\t\t<ResourceSlotsUiBlock\n\t\t\t:slot="slot"\n\t\t\t:resource="resource"\n\t\t\t:date="date"\n\t\t\t:resourceSlots="resourceSlots"\n\t\t\t:loading="fetching"\n\t\t\t@select="changeSlot"\n\t\t>\n\t\t\t<template #changeDateBtn>\n\t\t\t\t<button\n\t\t\t\t\tv-if="showChangeDateButton"\n\t\t\t\t\ttype="button"\n\t\t\t\t\tclass="booking--crm-forms--change-date-btn"\n\t\t\t\t\t@click="changeDate"\n\t\t\t\t>\n\t\t\t\t\t{{ loc('BOOKING_CRM_FORMS_CHANGE_DATE_BUTTON_CAPTION') }}\n\t\t\t\t</button>\n\t\t\t</template>\n\t\t</ResourceSlotsUiBlock>\n\t`};const L=300;const H={name:"AvailableSlotsBlock",components:{ResourceSlotsUiBlock:C},mixins:[c.locMixin],inject:["isPreview"],props:{date:{type:Date,required:true},resources:{type:Array,required:true},runAction:{type:Function,required:true},timezone:{type:String,required:true}},emits:["update:form","update:resourceId"],data(){return{fetching:false,selectedResourceId:null,visibleResourcesCount:3,resourceOccupancy:[],resourcesSlots:[]}},computed:{visibleResources(){return this.resourcesSlots.slice(0,this.visibleResourcesCount)}},watch:{date:{handler(t){if(t instanceof Date&&!this.isPreview){void this.fetchAvailableSlots()}},immediate:true},fetching:{handler(t){var e;if(t){var s;(s=this.loader)==null?void 0:s.show(this.$refs.resources);return}(e=this.loader)==null?void 0:e.hide()},immediate:true}},created(){this.initOccupancy()},beforeMount(){this.loader=new a.Loader({target:this.$refs.resources,size:60})},methods:{initOccupancy(){if(this.occupancy instanceof R){return}this.occupancy=f(this.runAction);this.occupancy.setResources(this.resources);this.occupancy.setTimezone(this.timezone)},async fetchAvailableSlots(){this.fetching=true;if(!this.occupancy){this.initOccupancy()}try{const t=this.resources.map((t=>t.id));const e=await this.occupancy.getOccupancy(t,this.date.getTime());this.resourceOccupancy=e||[];this.setResourcesSlots()}catch(t){console.error("Booking.CrmForms. GetOccupancy for resources error",t)}finally{this.fetching=false}},setResourcesSlots(){this.resourcesSlots=this.resources.map((t=>{const e=t.id;const s=this.resourceOccupancy;return{resourceId:e,resource:t,slots:R.calcResourceSlots({date:this.date,slotRanges:t.slotRanges,resourceOccupancy:s,resourceId:e,timezone:this.timezone})}})).sort(((t,e)=>e.slots.length-t.slots.length))},showMore(){this.visibleResourcesCount+=3},changeDate(t){this.selectedResourceId=t;setTimeout((()=>{this.$emit("update:form",{resourceId:t})}),L)},selectSlot({resource:t,slot:e}){this.selectedResourceId=t.id;setTimeout((()=>{this.$emit("update:form",{resourceId:t.id,slot:e})}),L)}},template:`\n\t\t<div ref="resources" class="booking--crm-forms--field-group">\n\t\t\t<template v-show="!fetching">\n\t\t\t\t<ResourceSlotsUiBlock\n\t\t\t\t\tv-for="resource in visibleResources"\n\t\t\t\t\t:key="resource.resourceId"\n\t\t\t\t\t:date="date"\n\t\t\t\t\t:resource="resource.resource"\n\t\t\t\t\t:resourceSlots="resource.slots"\n\t\t\t\t\t:class="{\n\t\t\t\t\t\t'--fade': selectedResourceId !== null && selectedResourceId !== resource.resourceId,\n\t\t\t\t\t}"\n\t\t\t\t\t@select="selectSlot"\n\t\t\t\t>\n\t\t\t\t\t<template #changeDateBtn>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\ttype="button"\n\t\t\t\t\t\t\tclass="booking--crm-forms--change-date-btn"\n\t\t\t\t\t\t\t@click="changeDate(resource.resourceId)"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{{ loc('BOOKING_CRM_FORMS_CHANGE_DATE_BUTTON_CAPTION') }}\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</template>\n\t\t\t\t</ResourceSlotsUiBlock>\n\t\t\t</template>\n\t\t\t<template v-if="resources.length > 0 && visibleResourcesCount < resources.length">\n\t\t\t\t<div class="booking--crm-forms--field-group--available-slots-block__footer">\n\t\t\t\t\t<button\n\t\t\t\t\t\ttype="button"\n\t\t\t\t\t\tclass="booking--crm-forms--change-date-btn booking--crm-forms--field-group--available-slots-block__btn-show-more"\n\t\t\t\t\t\t@click="showMore"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ loc('BOOKING_CRM_FORMS_SHOW_MORE_SLOTS') }}\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t</div>\n\t`};const N={name:"CrmFormBookingField",components:{AvailableSlotsBlock:H,CalendarBlock:A,ResourceSelectBlock:I,TimeSelectorBlock:E},mixins:[c.locMixin],provide(){return{isPreview:this.isPreview}},props:{field:{type:Object,required:true},runAction:{type:Function,required:true},dependencies:{type:Object,required:true}},emits:["change"],data(){return{form:{resourceId:0,date:null,dateTs:0,slot:null},resources:[],fetchingResources:false,fetchingOccupancy:false,fetchingAutoSelectionResource:false,visibleCalendar:false,occupancy:null}},computed:{timezone(){return Intl.DateTimeFormat().resolvedOptions().timeZone},isPreview(){return this.$root.form.editMode||window.location.pathname.indexOf("/sites/site/")===0},isAutoSelectionOn(){var t,e,s;return Boolean((t=this.field)==null?void 0:(e=t.options)==null?void 0:(s=e.settingsData)==null?void 0:s.isAutoSelectionOn)},settingsData(){var t,e,s,o,r,i,n,a;if(this.isPreview&&Array.isArray((t=this.field)==null?void 0:(e=t.options)==null?void 0:e.settingsData)){return{label:this.loc("BOOKING_CRM_FORMS_DEFAULT_RESOURCE_FIELD_LABEL"),textHeader:this.loc("BOOKING_CRM_FORMS_DEFAULT_RESOURCE_FIELD_PLACEHOLDER"),hint:this.loc("BOOKING_CRM_FORMS_DEFAULT_RESOURCE_FIELD_HINT"),isVisibleHint:true}}return this.isAutoSelectionOn?(s=this.field)==null?void 0:(o=s.options)==null?void 0:(r=o.settingsData)==null?void 0:r.autoSelection:(i=this.field)==null?void 0:(n=i.options)==null?void 0:(a=n.settingsData)==null?void 0:a.default},hasSlotsAllAvailableResources(){var t;return!this.isAutoSelectionOn&&((t=this.settingsData)==null?void 0:t.hasSlotsAllAvailableResources)},fetching(){return this.fetchingResources||this.fetchingOccupancy||this.fetchingAutoSelectionResource},resource(){if(!this.form.resourceId){return null}return this.resources.find((t=>t.id===this.form.resourceId))||null},realResources(){return this.hasSlotsAllAvailableResources?this.resources.filter((({id:t})=>t!==u.id)):this.resources},value(){if(!this.form.slot||!this.form.resourceId){return null}return{resourcesIds:[this.form.resourceId],dateFromTs:this.form.slot.fromTs/1e3,dateToTs:this.form.slot.toTs/1e3,timezone:this.timezone}},resourcesIds(){var t;return((t=this.settingsData)==null?void 0:t.resourceIds)||[]},errorMessage(){return this.field.messages.get("fieldErrorRequired")},hasErrors(){return this.field.validated&&!this.field.focused&&!this.field.valid()},hasTitleOnlyInCalendar(){return this.form.date&&!this.visibleCalendar&&this.form.resourceId&&this.isAutoSelectionOn},showedCalendarBlock(){return this.form.resourceId&&!this.form.date||this.form.date!==null||this.visibleCalendar},showedSlotsBlock(){return!this.isPreview&&this.hasSlotsAllAvailableResources&&this.form.resourceId===u.id&&this.resources.length>0&&this.form.date!==null},showedTimeSelectorBlock(){return!this.isPreview&&this.form.resourceId>0&&this.realResources.length>0&&this.form.date!==null}},created(){this.occupancyManager=f(this.runAction);this.occupancyManager.setTimezone(this.timezone);if(this.hasSlotsAllAvailableResources){this.form.resourceId=u.id;this.form.date=new Date}},async mounted(){if(!this.isPreview){await this.loadData()}e.Event.bind(window,"click",this.handleFocus,true)},beforeUnmount(){e.Event.unbind(window,"click",this.handleFocus,true)},methods:{async loadData(){const t=[this.loadResources()];if(this.isAutoSelectionOn){t.push(this.fetchAutoSelectionData())}await Promise.all(t)},handleFocus({target:t}){this.field.focused=this.$el.contains(t)},onSelectorChange(){this.updateValue()},updateValue(){if(this.form.resourceId||this.form.slot){this.field.validated=false}this.$emit("change",this.value)},async fetchAutoSelectionData(){try{var t;this.fetchingAutoSelectionResource=true;const s=new FormData;s.append("timezone",this.timezone);const o=((t=this.settingsData)==null?void 0:t.resourceIds)||[];o.forEach((t=>{s.append("resourceIds[]",t)}));const r=await this.runAction("booking.api_v1.CrmForm.getAutoSelectionData",{data:s});if(e.Type.isPlainObject(r==null?void 0:r.data)){this.form.resourceId=r.data.resourceId||0;this.form.date=r.data.date?new Date(r.data.date):null}}catch(t){console.error("RunAction getAutoSelectionData error",t)}finally{this.fetchingAutoSelectionResource=false}},async loadResources(){try{this.fetchingResources=true;const t=await this.runAction("booking.api_v1.CrmForm.getResources");this.setResources(h(t.data||[]));if(this.occupancyManager instanceof R){this.occupancyManager.setResources(this.resources)}}catch(t){console.error("Load resource error",t)}finally{this.fetchingResources=false}},changeDate(){if(this.isPreview){return}this.visibleCalendar=true},async setResource(t){this.form.resourceId=t;this.form.slot=null},setResources(t){var e;const s=((e=this.settingsData)==null?void 0:e.resourceIds)||[];const o=[];if(this.hasSlotsAllAvailableResources){o.push({...u,name:this.loc("BOOKING_CRM_FORMS_ALL_RESOURCES_LABEL")})}this.resources=[...o,...t.filter((({id:t})=>s.includes(t)))]},setDate(t){this.form.date=t;this.form.slot=null},setSlot(t){this.form.slot=t;this.updateValue()},updateForm(t){this.form={...this.form,...t};this.updateValue()}},template:`\n\t\t<div class="booking-crm-forms-field-container">\n\t\t\t<ResourceSelectBlock\n\t\t\t\t:resourceId="form.resourceId"\n\t\t\t\t:resources="resources"\n\t\t\t\t:settingsData="settingsData"\n\t\t\t\t:errorMessage="errorMessage"\n\t\t\t\t:hasErrors="hasErrors && form.resourceId <= 0"\n\t\t\t\t:fetching="fetchingAutoSelectionResource || fetchingResources || fetchingOccupancy"\n\t\t\t\t:dependencies="dependencies"\n\t\t\t\t@update:resourceId="setResource"\n\t\t\t/>\n\t\t\t<CalendarBlock\n\t\t\t\tv-if="!isPreview && showedCalendarBlock"\n\t\t\t\t:resource="resource"\n\t\t\t\t:date="form.date"\n\t\t\t\t:titleOnly="hasTitleOnlyInCalendar"\n\t\t\t\t:hasError="hasErrors && form.slot === null"\n\t\t\t\t:errorMessage="errorMessage"\n\t\t\t\t@updateDate="setDate"\n\t\t\t/>\n\t\t\t<AvailableSlotsBlock\n\t\t\t\tv-if="showedSlotsBlock"\n\t\t\t\t:date="form.date"\n\t\t\t\t:resources="realResources"\n\t\t\t\t:runAction="runAction"\n\t\t\t\t:timezone="timezone"\n\t\t\t\t@update:form="updateForm"\n\t\t\t/>\n\t\t\t<TimeSelectorBlock\n\t\t\t\tv-if="showedTimeSelectorBlock"\n\t\t\t\t:slot="form.slot"\n\t\t\t\t:resource="resource"\n\t\t\t\t:resources="realResources"\n\t\t\t\t:date="form.date"\n\t\t\t\t:runAction="runAction"\n\t\t\t\t:fetching="fetchingOccupancy"\n\t\t\t\t:timezone="timezone"\n\t\t\t\t:showChangeDateButton="hasTitleOnlyInCalendar"\n\t\t\t\t@update:fetching="fetchingOccupancy = $event"\n\t\t\t\t@update:slot="setSlot"\n\t\t\t\t@showCalendar="visibleCalendar = true"\n\t\t\t/>\n\t\t</div>\n\t`};t.Field=N})(this.BX.Booking.CrmForms=this.BX.Booking.CrmForms||{},BX,BX.Booking.Const,BX.Booking.Lib,BX.Booking.Lib,BX.UI.DatePicker,BX.Main,BX,BX.Booking.Component.Mixin);
//# sourceMappingURL=field.bundle.map.js