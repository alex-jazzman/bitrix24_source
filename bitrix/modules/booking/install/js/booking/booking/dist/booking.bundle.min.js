this.BX=this.BX||{};(function(t,e,o,i,s,n,r,a,l,d,c,u,m,h,p,g,b,f,I,k,v,B,T,y,M,E,w,C,S,L,O,F,D,P,$,R,_,N,A,H,z,G,x,K,W,U,q,X,V,j,Y,Z,Q,J,tt,et,ot,it,st,nt,rt,at,lt,dt,ct,ut,mt,ht,pt,gt,bt,ft,It,kt,vt,Bt,Tt){"use strict";const yt=50;const Mt="--booking-off-hours-cell-height";const Et="--booking-booking-collapse";const wt="--booking-booking-expand";var Ct=babelHelpers.classPrivateFieldLooseKey("animation");var St=babelHelpers.classPrivateFieldLooseKey("container");var Lt=babelHelpers.classPrivateFieldLooseKey("content");var Ot=babelHelpers.classPrivateFieldLooseKey("gridWrap");var Ft=babelHelpers.classPrivateFieldLooseKey("fromHour");var Dt=babelHelpers.classPrivateFieldLooseKey("toHour");class Pt{constructor(){Object.defineProperty(this,Dt,{get:At,set:void 0});Object.defineProperty(this,Ft,{get:Nt,set:void 0});Object.defineProperty(this,Ot,{get:_t,set:void 0});Object.defineProperty(this,Lt,{get:Rt,set:void 0});Object.defineProperty(this,St,{get:$t,set:void 0});Object.defineProperty(this,Ct,{writable:true,value:void 0})}expand({keepScroll:t}){ht.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,St)[St],Et);ht.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,St)[St],wt);this.animate(0,yt,t)}collapse(){ht.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,St)[St],wt);ht.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,St)[St],Et);this.animate(yt,0,true)}animate(t,e,o=false){var i;const s=babelHelpers.classPrivateFieldLooseBase(this,Ot)[Ot].scrollTop;const n=babelHelpers.classPrivateFieldLooseBase(this,Ot)[Ot].scrollHeight;const r=babelHelpers.classPrivateFieldLooseBase(this,Ft)[Ft]/(24-(babelHelpers.classPrivateFieldLooseBase(this,Dt)[Dt]-babelHelpers.classPrivateFieldLooseBase(this,Ft)[Ft]));(i=babelHelpers.classPrivateFieldLooseBase(this,Ct)[Ct])==null?void 0:i.stop();babelHelpers.classPrivateFieldLooseBase(this,Ct)[Ct]=new BX.easing({duration:200,start:{height:t},finish:{height:e},step:({height:t})=>{ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt],Mt,`calc(var(--zoom) * ${t}px)`);if(o){const t=babelHelpers.classPrivateFieldLooseBase(this,Ot)[Ot].scrollHeight-n;babelHelpers.classPrivateFieldLooseBase(this,Ot)[Ot].scrollTop=s+t*r}}});babelHelpers.classPrivateFieldLooseBase(this,Ct)[Ct].animate()}setExpanded(t){const e=babelHelpers.classPrivateFieldLooseBase(this,Ot)[Ot].scrollTop;const o=babelHelpers.classPrivateFieldLooseBase(this,Ot)[Ot].scrollHeight;const i=babelHelpers.classPrivateFieldLooseBase(this,Ft)[Ft]/(24-(babelHelpers.classPrivateFieldLooseBase(this,Dt)[Dt]-babelHelpers.classPrivateFieldLooseBase(this,Ft)[Ft]));const s=t?yt:0;const n=t?wt:Et;ht.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,St)[St],[Et,wt]);ht.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,St)[St],n);ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,Lt)[Lt],Mt,`calc(var(--zoom) * ${s}px)`);const r=babelHelpers.classPrivateFieldLooseBase(this,Ot)[Ot].scrollHeight-o;babelHelpers.classPrivateFieldLooseBase(this,Ot)[Ot].scrollTop=e+r*i;void C.Core.getStore().dispatch(`${Bt.Model.Interface}/setOffHoursExpanded`,t)}}function $t(){return C.Core.getParams().container}function Rt(){return BX("booking-content")}function _t(){return BX("booking-booking-grid-wrap")}function Nt(){return C.Core.getStore().getters["interface/fromHour"]}function At(){return C.Core.getStore().getters["interface/toHour"]}const Ht=new Pt;const zt=Object.freeze({CreatedByMe:"booking-filter-preset-created-by-me"});const Gt=Object.freeze({CreatedBy:"CREATED_BY",Contact:"CONTACT",Company:"COMPANY",Resource:"RESOURCE",ResourceLabel:"RESOURCE_label",Confirmed:"CONFIRMED",RequireAttention:"REQUIRE_ATTENTION"});const xt=Object.freeze({Delayed:"D",AwaitConfirmation:"AC"});const Kt={emits:["apply","clear"],props:{filterId:{type:String,required:true}},data(){return{filter:null}},created(){this.filter=BX.Main.filterManager.getById(this.filterId);c.EventEmitter.subscribe("BX.Main.Filter:beforeApply",this.onBeforeApply)},methods:{onBeforeApply(t){const[e]=t.getData();if(e!==this.filterId){return}if(this.isFilterEmpty()){this.$emit("clear")}else{this.$emit("apply")}},setFields(t){const e=this.filter.getFilterFieldsValues();e[Gt.RequireAttention]=t.REQUIRE_ATTENTION;e[Gt.Resource]=t.RESOURCE;if(Gt.ResourceLabel in t){e[Gt.ResourceLabel]=t.RESOURCE_label}this.filter.getApi().setFields(e);this.filter.getApi().apply()},isFilterEmpty(){return Object.keys(this.getFields()).length===0},getFields(){const t=[Gt.Confirmed,Gt.Delayed];const e=[Gt.Company,Gt.Contact,Gt.CreatedBy,Gt.Resource];const o=[Gt.RequireAttention];const i=this.filter.getFilterFieldsValues();const s=t.filter((t=>["Y","N"].includes(i[t]))).reduce(((t,e)=>({...t,[e]:i[e]})),{});e.forEach((t=>{var e;if(((e=i[t])==null?void 0:e.length)>0){s[t]=i[t]}}));o.forEach((t=>{var e;if(((e=i[t])==null?void 0:e.length)>0){s[t]=i[t]}}));return s}},template:`\n\t\t<div></div>\n\t`};const Wt=Object.freeze({AwaitConfirmation:"await-confirmation",Delayed:"delayed"});const Ut={emits:["activeItem"],props:{target:HTMLElement},mounted(){this.addCounterPanel();c.EventEmitter.subscribe("BX.UI.CounterPanel.Item:activate",this.onActiveItem);c.EventEmitter.subscribe("BX.UI.CounterPanel.Item:deactivate",this.onActiveItem)},computed:mt.mapGetters({counters:"counters/get"}),methods:{setItem(t){if(this.getActiveItem()===t){return}Object.values(Wt).forEach((t=>this.counterPanel.getItemById(t).deactivate()));const e=this.counterPanel.getItemById(t);e==null?void 0:e.activate()},addCounterPanel(){this.counterPanel=new l.CounterPanel({target:this.target,items:[{id:Wt.AwaitConfirmation,title:this.loc("BOOKING_BOOKING_COUNTER_PANEL_AWAIT_CONFIRMATION"),value:this.counters.unConfirmed,color:qt(d.CounterColor,d.CounterColor.THEME)},{id:Wt.Delayed,title:this.loc("BOOKING_BOOKING_COUNTER_PANEL_DELAYED"),value:this.counters.delayed}]});this.counterPanel.init()},onActiveItem(){this.$emit("activeItem",this.getActiveItem())},getActiveItem(){var t,e;return(t=(e=this.counterPanel.getItems().find((({isActive:t})=>t)))==null?void 0:e.id)!=null?t:null}},watch:{counters(t){this.counterPanel.getItems().forEach((e=>{if(e.id===Wt.AwaitConfirmation){e.updateColor(qt(d.CounterColor,d.CounterColor.DANGER));e.updateValue(t.unConfirmed)}if(e.id===Wt.Delayed){e.updateColor(qt(d.CounterColor,d.CounterColor.DANGER));e.updateValue(t.delayed)}}))}},template:`\n\t\t<div v-if="false"></div>\n\t`};const qt=(t,e)=>Object.entries(t).find((([,t])=>t===e))[0];const Xt={props:{value:{type:Number,required:true},valueFormatted:{type:String,required:true},increasedValue:{type:Number,required:true},increasedValueFormatted:{type:String,required:true},popupId:{type:String,required:true},title:{type:String,required:true},rows:{type:Array,required:true},button:{type:Object,required:false}},data(){return{isPopupShown:false}},methods:{onMouseEnter(){this.clearTimeouts();this.showTimeout=setTimeout((()=>this.showPopup()),100)},onMouseLeave(){ht.Event.unbind(document,"mouseover",this.updateHoverElement);ht.Event.bind(document,"mouseover",this.updateHoverElement);this.clearTimeouts();if(!this.button){this.closePopup();return}this.closeTimeout=setTimeout((()=>{var t;this.popupContainer=document.getElementById(this.popupId);if(!((t=this.popupContainer)!=null&&t.contains(this.hoverElement))&&!this.$refs.container.contains(this.hoverElement)){this.closePopup()}if(this.popupContainer){ht.Event.unbind(this.popupContainer,"mouseleave",this.onMouseLeave);ht.Event.bind(this.popupContainer,"mouseleave",this.onMouseLeave)}}),100)},updateHoverElement(t){this.hoverElement=t.target},showPopup(){this.clearTimeouts();this.isPopupShown=true},closePopup(){this.clearTimeouts();this.isPopupShown=false;ht.Event.unbind(this.popupContainer,"mouseleave",this.onMouseLeave);ht.Event.unbind(document,"mouseover",this.updateHoverElement)},clearTimeouts(){clearTimeout(this.closeTimeout);clearTimeout(this.showTimeout)},close(){this.closePopup();this.$emit("close")}},watch:{value(){var t;(t=this.$refs.animation)==null?void 0:t.replaceWith(this.$refs.animation)}},components:{StatisticsPopup:x.StatisticsPopup},template:`\n\t\t<div class="booking-toolbar-after-title-info-profit-container" ref="container">\n\t\t\t<div\n\t\t\t\tv-html="valueFormatted"\n\t\t\t\tclass="booking-toolbar-after-title-info-profit"\n\t\t\t\t@click="showPopup"\n\t\t\t\t@mouseenter="onMouseEnter"\n\t\t\t\t@mouseleave="onMouseLeave"\n\t\t\t></div>\n\t\t\t<div\n\t\t\t\tv-if="increasedValue > 0"\n\t\t\t\tv-html="increasedValueFormatted"\n\t\t\t\tclass="booking-toolbar-after-title-profit-increased"\n\t\t\t\tref="animation"\n\t\t\t></div>\n\t\t</div>\n\t\t<StatisticsPopup\n\t\t\tv-if="isPopupShown"\n\t\t\t:popupId="popupId"\n\t\t\t:bindElement="$refs.container"\n\t\t\t:title="title"\n\t\t\t:rows="rows"\n\t\t\t:button="button"\n\t\t\t@close="close"\n\t\t/>\n\t`};const Vt={data(){return{increasedValue:0}},computed:{...mt.mapGetters({totalNewClientsToday:`${Bt.Model.Interface}/totalNewClientsToday`,totalClients:`${Bt.Model.Interface}/totalClients`}),popupId(){return"booking-booking-after-title-clients-popup"},title(){return this.loc("BOOKING_BOOKING_AFTER_TITLE_CLIENTS_POPUP_TITLE")},rows(){return[{title:this.loc("BOOKING_BOOKING_AFTER_TITLE_CLIENTS_POPUP_TOTAL_CLIENTS_TODAY"),value:`+${this.totalNewClientsToday}`},{title:this.loc("BOOKING_BOOKING_AFTER_TITLE_CLIENTS_POPUP_TOTAL_CLIENTS"),value:`<div>${this.totalClients}</div>`}]},button(){return{title:this.loc("BOOKING_BOOKING_CLIENTS_LIST"),click:()=>BX.SidePanel.Instance.open("/crm/contact/list/")}},clientsProfitFormatted(){return ht.Loc.getMessagePlural("BOOKING_BOOKING_PLUS_NUM_CLIENTS",this.totalNewClientsToday,{"#NUM#":this.totalNewClientsToday})},increasedValueFormatted(){return ht.Loc.getMessagePlural("BOOKING_BOOKING_PLUS_NUM_CLIENTS",this.increasedValue,{"#NUM#":this.increasedValue})}},watch:{totalNewClientsToday(t,e){this.increasedValue=t-e}},components:{Statistics:Xt},template:`\n\t\t<Statistics\n\t\t\t:value="totalNewClientsToday"\n\t\t\t:valueFormatted="clientsProfitFormatted"\n\t\t\t:increasedValue="increasedValue"\n\t\t\t:increasedValueFormatted="increasedValueFormatted"\n\t\t\t:popupId="popupId"\n\t\t\t:title="title"\n\t\t\t:rows="rows"\n\t\t\t:button="button"\n\t\t/>\n\t`};const jt={data(){return{increasedValue:0}},computed:{...mt.mapGetters({moneyStatistics:`${Bt.Model.Interface}/moneyStatistics`}),popupId(){return"booking-booking-after-title-profit-popup"},title(){return this.loc("BOOKING_BOOKING_AFTER_TITLE_PROFIT_POPUP_TITLE")},rows(){var t,e,o,i;const s=(t=(e=this.moneyStatistics)==null?void 0:(o=e.month)==null?void 0:(i=o.filter((({currencyId:t})=>t!==this.baseCurrencyId)))==null?void 0:i.map((({currencyId:t})=>t)))!=null?t:[];return[this.getTodayRow(this.baseCurrencyId),...s.map((t=>this.getTodayRow(t))),this.getMonthRow(this.baseCurrencyId),...s.map((t=>this.getMonthRow(t)))]},todayProfit(){return this.getTodayProfit(this.moneyStatistics)},todayProfitFormatted(){return this.formatTodayProfit(this.todayProfit)},increasedValueFormatted(){return this.formatTodayProfit(this.increasedValue)},baseCurrencyId(){return G.currencyFormat.getBaseCurrencyId()}},methods:{getTodayRow(t){const e=this.loc("BOOKING_BOOKING_AFTER_TITLE_PROFIT_POPUP_TOTAL_TODAY");return{title:t===this.baseCurrencyId?e:"",value:`+${this.getTodayProfitFormatted(t)}`}},getMonthRow(t){const e=this.loc("BOOKING_BOOKING_AFTER_TITLE_PROFIT_POPUP_MONTH",{"#MONTH#":at.DateTimeFormat.format("f")});return{title:t===this.baseCurrencyId?e:"",value:`<div>${this.getMonthProfitFormatted(t)}</div>`}},getTodayProfitFormatted(t){var e,o,i;const s=(e=this.moneyStatistics)==null?void 0:(o=e.today)==null?void 0:o.find((({currencyId:e})=>e===t));const n=(i=s==null?void 0:s.opportunity)!=null?i:0;return G.currencyFormat.format(t,n)},getMonthProfitFormatted(t){var e,o,i;const s=(e=this.moneyStatistics)==null?void 0:(o=e.month)==null?void 0:o.find((({currencyId:e})=>e===t));const n=(i=s==null?void 0:s.opportunity)!=null?i:0;return G.currencyFormat.format(t,n)},getTodayProfit(t){var e,o;const i=t==null?void 0:(e=t.today)==null?void 0:e.find((({currencyId:t})=>t===this.baseCurrencyId));return(o=i==null?void 0:i.opportunity)!=null?o:0},formatTodayProfit(t){return`+ <span>${G.currencyFormat.format(this.baseCurrencyId,t)}</span>`}},watch:{moneyStatistics(t,e){this.increasedValue=this.getTodayProfit(t)-this.getTodayProfit(e)}},components:{Statistics:Xt},template:`\n\t\t<Statistics\n\t\t\t:value="todayProfit"\n\t\t\t:valueFormatted="todayProfitFormatted"\n\t\t\t:increasedValue="increasedValue"\n\t\t\t:increasedValueFormatted="increasedValueFormatted"\n\t\t\t:popupId="popupId"\n\t\t\t:title="title"\n\t\t\t:rows="rows"\n\t\t/>\n\t`};const Yt={computed:{dateFormatted(){const t=at.DateTimeFormat.getFormat("DAY_SHORT_MONTH_FORMAT");return at.DateTimeFormat.format(t,Date.now()/1e3)}},components:{Clients:Vt,Profit:jt},template:`\n\t\t<div class="booking-toolbar-after-title">\n\t\t\t<div class="booking-toolbar-after-title-date" ref="date">\n\t\t\t\t{{ dateFormatted }}\n\t\t\t</div>\n\t\t\t<div class="booking-toolbar-after-title-info">\n\t\t\t\t<Clients/>\n\t\t\t\t<Profit/>\n\t\t\t</div>\n\t\t</div>\n\t`};const Zt={props:{bottom:{type:Boolean,default:false}},computed:{...mt.mapGetters({offHoursHover:"interface/offHoursHover",offHoursExpanded:"interface/offHoursExpanded",fromHour:"interface/fromHour",toHour:"interface/toHour"}),fromFormatted(){if(this.bottom){return this.formatHour(this.toHour)}return this.formatHour(0)},toFormatted(){if(this.bottom){return this.formatHour(24)}return this.formatHour(this.fromHour)}},methods:{formatHour(t){const e=at.DateTimeFormat.getFormat("SHORT_TIME_FORMAT");const o=(new Date).setHours(t,0)/1e3;return at.DateTimeFormat.format(e,o)},animateOffHours({keepScroll:t}){if(this.offHoursExpanded){Ht.collapse()}else{Ht.expand({keepScroll:t})}void this.$store.dispatch("interface/setOffHoursExpanded",!this.offHoursExpanded)}},template:`\n\t\t<div\n\t\t\tclass="booking-booking-off-hours"\n\t\t\t:class="{'--hover': offHoursHover, '--bottom': bottom, '--top': !bottom}"\n\t\t\t@click="animateOffHours({ keepScroll: bottom })"\n\t\t\t@mouseenter="$store.dispatch('interface/setOffHoursHover', true)"\n\t\t\t@mouseleave="$store.dispatch('interface/setOffHoursHover', false)"\n\t\t>\n\t\t\t<div class="booking-booking-off-hours-border"></div>\n\t\t\t<span>{{ fromFormatted }}</span>\n\t\t\t<span>{{ toFormatted }}</span>\n\t\t</div>\n\t`};const Qt={name:"HelpPopup",components:{RichLoc:m.RichLoc,StickyPopup:It.StickyPopup},emits:["close"],props:{bindElement:{type:HTMLElement,required:true}},computed:{popupId(){return"booking-quick-filter-help-popup"},config(){return{className:"booking-quick-filter-help-popup",bindElement:this.bindElement,offsetLeft:this.bindElement.offsetWidth,offsetTop:this.bindElement.offsetHeight,maxWidth:220}}},methods:{closePopup(){this.$emit("close")}},template:`\n\t\t<StickyPopup\n\t\t\t:id="popupId"\n\t\t\t:config="config"\n\t\t\t@close="closePopup"\n\t\t>\n\t\t\t<div class="booking-quick-filter-help-popup-content">\n\t\t\t\t<div class="booking-quick-filter-help-popup-icon-container">\n\t\t\t\t\t<div class="booking-quick-filter-help-popup-icon"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class="booking-quick-filter-help-popup-description">\n\t\t\t\t\t<RichLoc :text="loc('BOOKING_QUICK_FILTER_HELP_MSGVER_1')" placeholder="[bold]">\n\t\t\t\t\t\t<template #bold="{ text }">\n\t\t\t\t\t\t\t<span>{{ text }}</span>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t</RichLoc>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</StickyPopup>\n\t`};const Jt={props:{hour:{type:Number,required:true}},data(){return{IconSet:Z.Set,isHelpPopupShown:false}},computed:{active(){return this.hour in this.$store.getters[`${Bt.Model.Filter}/quickFilter`].active},hovered(){return this.hour in this.$store.getters[`${Bt.Model.Filter}/quickFilter`].hovered}},methods:{onClick(){this.closeHelpPopup();if(this.active){void this.$store.dispatch(`${Bt.Model.Filter}/deactivateQuickFilter`,this.hour)}else{void this.$store.dispatch(`${Bt.Model.Filter}/activateQuickFilter`,this.hour)}},hover(){this.helpPopupTimeout=setTimeout((()=>this.showHelpPopup()),1e3);void this.$store.dispatch(`${Bt.Model.Filter}/hoverQuickFilter`,this.hour)},flee(){this.closeHelpPopup();void this.$store.dispatch(`${Bt.Model.Filter}/fleeQuickFilter`,this.hour)},showHelpPopup(){this.isHelpPopupShown=true},closeHelpPopup(){clearTimeout(this.helpPopupTimeout);this.isHelpPopupShown=false}},components:{Icon:Z.BIcon,HelpPopup:Qt},template:`\n\t\t<div\n\t\t\tclass="booking-booking-quick-filter-container"\n\t\t\t:class="{'--hover': hovered || active, '--active': active}"\n\t\t>\n\t\t\t<div\n\t\t\t\tclass="booking-booking-quick-filter"\n\t\t\t\t@mouseenter="hover"\n\t\t\t\t@mouseleave="flee"\n\t\t\t\t@click="onClick"\n\t\t\t>\n\t\t\t\t<Icon :name="active ? IconSet.CROSS_25 : IconSet.FUNNEL"/>\n\t\t\t</div>\n\t\t\t<HelpPopup\n\t\t\t\tv-if="isHelpPopupShown"\n\t\t\t\t:bindElement="$el"\n\t\t\t\t@close="closeHelpPopup"\n\t\t\t/>\n\t\t</div>\n\t`};const te={computed:{...mt.mapGetters({offHoursHover:"interface/offHoursHover",offHoursExpanded:"interface/offHoursExpanded",fromHour:"interface/fromHour",toHour:"interface/toHour"}),panelHours(){const t=at.DateTimeFormat.getFormat("SHORT_TIME_FORMAT");const e=this.offHoursExpanded?24:this.toHour;return w.range(0,24).map((o=>{const i=(new Date).setHours(o,0)/1e3;return{value:o,formatted:at.DateTimeFormat.format(t,i),offHours:o<this.fromHour||o>=this.toHour,last:o===e}}))}},components:{OffHours:Zt,QuickFilter:Jt},template:`\n\t\t<div class="booking-booking-grid-left-panel-container">\n\t\t\t<div class="booking-booking-grid-left-panel">\n\t\t\t\t<OffHours/>\n\t\t\t\t<OffHours :bottom="true"/>\n\t\t\t\t<template v-for="hour of panelHours" :key="hour.value">\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="hour.last"\n\t\t\t\t\t\tclass="booking-booking-grid-left-panel-time-text"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ hour.formatted }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="hour.value !== 24"\n\t\t\t\t\t\tclass="booking-booking-grid-left-panel-time"\n\t\t\t\t\t\t:class="{'--off-hours': hour.offHours}"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div class="booking-booking-grid-left-panel-time-text">\n\t\t\t\t\t\t\t{{ hour.formatted }}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<QuickFilter :hour="hour.value"/>\n\t\t\t\t\t</div>\n\t\t\t\t</template>\n\t\t\t</div>\n\t\t</div>\n\t`};const ee={data(){return{visible:true}},mounted(){this.updateNowLine();setInterval((()=>this.updateNowLine()),1e3)},computed:mt.mapGetters({zoom:`${Bt.Model.Interface}/zoom`,selectedDateTs:`${Bt.Model.Interface}/selectedDateTs`,offHoursExpanded:`${Bt.Model.Interface}/offHoursExpanded`,fromHour:`${Bt.Model.Interface}/fromHour`,toHour:`${Bt.Model.Interface}/toHour`,offset:`${Bt.Model.Interface}/offset`}),methods:{setVisible(t){this.visible=t;this.updateNowLine()},updateNowLine(){const t=new Date(Date.now()+this.offset);const e=50*this.zoom;const o=this.fromHour*60;const i=t.getHours()*60+t.getMinutes();const s=this.offHoursExpanded?24:this.toHour;const n=Math.min(s*60+21,i);const r=(n-o)*(e/60);ht.Dom.style(this.$refs.nowLine,"top",`${r}px`);const a=at.DateTimeFormat.getFormat("SHORT_TIME_FORMAT");const l=at.DateTimeFormat.format(a,t.getTime()/1e3);if(l!==this.$refs.nowText.innerText){this.$refs.nowText.innerText=l}const d=new Date(this.selectedDateTs+this.offset);const c=this.visible&&Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())===Date.UTC(t.getFullYear(),t.getMonth(),t.getDate());ht.Dom.style(this.$refs.nowLine,"display",c?"":"none")}},watch:{selectedDateTs(){this.updateNowLine()},zoom(){this.updateNowLine()},offHoursExpanded(t){const e=new Date;const o=e.getHours()*60+e.getMinutes();if(o<this.toHour*60){return}this.setVisible(!t);setTimeout((()=>this.setVisible(true)),200)}},template:`\n\t\t<div class="booking-booking-grid-now-line" ref="nowLine">\n\t\t\t<div class="booking-booking-grid-now-line-text" ref="nowText"></div>\n\t\t</div>\n\t`};const oe={name:"BookingActionsPopupClient",props:{bookingId:{type:[Number,String],required:true}},emits:["freeze","unfreeze"],computed:{booking(){return this.$store.getters["bookings/getById"](this.bookingId)}},methods:{async addClients({clients:t}){await st.bookingService.update({id:this.booking.id,clients:t})},async updateClients({clients:t}){await st.bookingService.update({id:this.booking.id,clients:t})},async updateNote({note:t}){await st.bookingService.update({id:this.booking.id,note:t})}},components:{Client:D.Client},template:`\n\t\t<Client\n\t\t\t:id="bookingId"\n\t\t\t:clients="booking.clients"\n\t\t\t:primaryClientData="booking.primaryClient"\n\t\t\t:note="booking.note"\n\t\t\t:dataId="bookingId"\n\t\t\t:dataAttributes="{\n\t\t\t\t'data-booking-id': bookingId,\n\t\t\t}"\n\t\t\tdataElementPrefix="booking"\n\t\t\t@freeze="$emit('freeze')"\n\t\t\t@unfreeze="$emit('unfreeze')"\n\t\t\t@addClients="addClients"\n\t\t\t@updateClients="updateClients"\n\t\t\t@updateNote="updateNote"\n\t\t/>\n\t`};const ie={name:"BookingActionsPopupDeal",components:{Deal:D.Deal},props:{bookingId:{type:[Number,String],required:true}},emits:["freeze","unfreeze"],setup(t){const e=new $.BookingDealHelper(t.bookingId);return{dealHelper:e}},computed:{booking(){return this.$store.getters[`${Bt.Model.Bookings}/getById`](this.bookingId)},deal(){var t,e;return(t=(e=this.booking.externalData)==null?void 0:e.find((t=>t.entityTypeId===Bt.CrmEntity.Deal)))!=null?t:null}},template:`\n\t\t<Deal\n\t\t\t:deal="deal"\n\t\t\t:dealHelper="dealHelper"\n\t\t\t:dataId="booking.id"\n\t\t\t:dataAttributes="{\n\t\t\t\t'data-booking-id': bookingId,\n\t\t\t}"\n\t\t\tdataElementPrefix="booking"\n\t\t\t@freeze="$emit('freeze')"\n\t\t\t@unfreeze="$emit('unfreeze')"\n\t\t/>\n\t`};const se={name:"BookingActionsPopupDocument",props:{bookingId:{type:[Number,String],required:true}},data(){return{isLoading:true}},async mounted(){await p.bookingActionsService.getDocData();this.isLoading=false},components:{Document:D.Document},template:`\n\t\t<Document\n\t\t\t:id="bookingId"\n\t\t\t:loading="isLoading"\n\t\t\tdisabled\n\t\t/>\n\t`};const ne={name:"BookingExtraResourcesInfo",components:{ExtraResourcesInfo:D.ExtraResourcesInfo},props:{bookingId:{type:[Number,String],required:true}},emits:["freeze","unfreeze"],template:`\n\t\t<ExtraResourcesInfo\n\t\t\t:id="bookingId"\n\t\t\t@open="$emit('freeze')"\n\t\t\t@close="$emit('unfreeze')"\n\t\t\t@freeze="$emit('freeze')"\n\t\t\t@unfreeze="$emit('unfreeze')"\n\t\t/>\n\t`};const re={name:"BookingActionsPopupMessage",emits:["freeze","unfreeze"],props:{bookingId:{type:Number,required:true}},data(){return{isLoading:true,isPrimaryClientIdUpdated:false}},mounted(){void this.fetchMessageData()},computed:{...mt.mapGetters({isCurrentSenderAvailable:`${Bt.Model.Interface}/isCurrentSenderAvailable`}),booking(){return this.$store.getters["bookings/getById"](this.bookingId)},client(){const t=this.booking.primaryClient;return t?this.$store.getters["clients/getByClientData"](t):null},clientId(){var t;return(t=this.booking.primaryClient)==null?void 0:t.id},updatedAt(){return this.booking.updatedAt}},watch:{clientId(){this.isPrimaryClientIdUpdated=true},updatedAt(){if(this.isPrimaryClientIdUpdated&&this.isCurrentSenderAvailable){void this.fetchMessageData();this.isPrimaryClientIdUpdated=false}}},methods:{async sendMessage({notificationType:t}){try{await p.bookingActionsService.sendMessage(this.bookingId,t);void this.fetchMessageData()}catch(t){if(ht.Type.isArrayFilled(t.errors)){h.Notifier.notify({id:"booking-message-send-error",text:t.errors[0].message})}}},async fetchMessageData(){this.isLoading=true;await p.bookingActionsService.getMessageData(this.bookingId);this.isLoading=false}},components:{Message:D.Message},template:`\n\t\t<Message\n\t\t\t:id="bookingId"\n\t\t\t:clientData="booking.primaryClient"\n\t\t\t:loading="isLoading"\n\t\t\t:dataId="bookingId"\n\t\t\tdataElementPrefix="booking"\n\t\t\t@open="$emit('freeze')"\n\t\t\t@close="$emit('unfreeze')"\n\t\t\t@updateNotificationType="sendMessage"\n\t\t/>\n\t`};const ae={emits:["freeze","unfreeze"],name:"BookingActionsPopupConfirmation",props:{bookingId:{type:[Number,String],required:true}},computed:{booking(){return this.$store.getters[`${Bt.Model.Bookings}/getById`](this.bookingId)}},methods:{updateConfirmationStatus({isConfirmed:t}){void st.bookingService.update({id:this.booking.id,isConfirmed:t})}},components:{Confirmation:D.Confirmation},template:`\n\t\t<Confirmation\n\t\t\t:id="bookingId"\n\t\t\t:isConfirmed="booking.isConfirmed"\n\t\t\t:counters="booking.counters"\n\t\t\t:dataId="booking.id"\n\t\t\tdataElementPrefix="booking"\n\t\t\t@open="$emit('freeze')"\n\t\t\t@close="$emit('unfreeze')"\n\t\t\t@updateConfirmationStatus="updateConfirmationStatus"\n\t\t/>\n\t`};const le={emits:["freeze","unfreeze"],name:"BookingActionsPopupVisit",props:{bookingId:{type:[Number,String],required:true}},computed:{booking(){return this.$store.getters[`${Bt.Model.Bookings}/getById`](this.bookingId)}},methods:{updateVisitStatus({visitStatus:t}){void st.bookingService.update({id:this.booking.id,visitStatus:t})}},components:{Icon:Z.BIcon,Loader:g.Loader,Visit:D.Visit},template:`\n\t\t<Visit\n\t\t\t:id="booking.id"\n\t\t\t:visitStatus="booking.visitStatus"\n\t\t\t:dataId="booking.id"\n\t\t\tdataElementPrefix="booking"\n\t\t\t:hasClients="booking.clients.length > 0"\n\t\t\t@freeze="$emit('freeze')"\n\t\t\t@unfreeze="$emit('unfreeze')"\n\t\t\t@update:visitStatus="updateVisitStatus"\n\t\t/>\n\t`};const de={name:"BookingActionsPopupOverbooking",components:{Icon:Z.BIcon},directives:{hint:b.hint},props:{bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true},disabled:{type:Boolean,default:false}},emits:["close"],setup(t){const e=Z.Set.PLUS_20;const o=20;const i=vt.computed((()=>t.disabled?"var(--ui-color-palette-gray-20)":"var(--ui-color-palette-gray-60)"));return{plusIcon:e,plusIconSize:o,plusIconColor:i}},computed:{...mt.mapGetters({getBookingById:`${Bt.Model.Bookings}/getById`,dictionary:`${Bt.Model.Dictionary}/getBookingVisitStatuses`,isFeatureEnabled:`${Bt.Model.Interface}/isFeatureEnabled`,timezone:`${Bt.Model.Interface}/timezone`,embedItems:`${Bt.Model.Interface}/embedItems`}),booking(){return this.getBookingById(this.bookingId)},hasOverbookingHint(){if(!this.disabled){return undefined}return{text:this.loc("BB_ACTIONS_POPUP_OVERBOOKING_DISABLED_HINT")}},clients(){const t=this.embedItems.filter((t=>t.entityTypeId==="CONTACT"||t.entityTypeId==="COMPANY"));return t.map((t=>({id:t.value,type:{code:t.entityTypeId,module:t.moduleId}})))}},methods:{async addOverbooking(){if(this.disabled){return}if(!this.isFeatureEnabled){it.limit.show();return}const t={...this.booking,id:ht.Text.getRandom(10),clients:this.clients,counter:0,counters:[],createdAt:Date.now(),externalData:this.embedItems,isConfirmed:false,name:null,note:null,resourcesIds:[this.resourceId],primaryClient:undefined,rrule:null,timezoneFrom:this.timezone,timezoneTo:this.timezone,updatedAt:Date.now(),visitStatus:this.dictionary.Unknown};delete t.name;const e=await st.bookingService.add(t);if(e.success&&e.booking){ct.BookingAnalytics.sendAddBooking({isOverbooking:true})}this.$emit("close")}},template:`\n\t\t<div\n\t\t\tv-hint="hasOverbookingHint"\n\t\t\tclass="booking-actions-popup__item-overbooking-button"\n\t\t\t:class="{'--disabled': disabled}"\n\t\t\trole="button"\n\t\t\ttabindex="0"\n\t\t\t@click="addOverbooking"\n\t\t>\n\t\t\t<Icon :name="plusIcon" :size="plusIconSize" :color="plusIconColor"/>\n\t\t\t<div class="booking-actions-popup__item-overbooking-label">\n\t\t\t\t{{ loc('BB_ACTIONS_POPUP_OVERBOOKING_LABEL') }}\n\t\t\t</div>\n\t\t</div>\n\t`};const ce={name:"BookingActionsPopupWaitlist",components:{Icon:Z.BIcon},props:{bookingId:{type:[Number,String],required:true}},computed:{...mt.mapGetters({getBookingById:`${Bt.Model.Bookings}/getById`}),clockIcon(){return Z.Set.BLACK_CLOCK},disabled(){return!O.isRealId(this.bookingId)}},methods:{async toWaitList(){if(this.disabled){return}const t=this.bookingId;const e=this.getBookingById(t);await this.$store.dispatch(`${Bt.Model.Interface}/addDeletingBooking`,t);const o=await N.waitListService.createFromBooking(t,{id:`tmp-id-${Date.now()}-${ht.Text.getRandom(4)}`,clients:e.clients,primaryClient:e.primaryClient,externalData:e.externalData,createdAt:Date.now(),updatedAt:Date.now()});if(o.success&&o.waitListItem){ct.BookingAnalytics.sendAddWaitListItem()}}},template:`\n\t\t<div\n\t\t\tclass="booking--booking-actions-popup__item-waitlist-btn --end"\n\t\t\t:class="{'--disabled': disabled}"\n\t\t\t@click="toWaitList">\n\t\t\t<Icon :name="clockIcon" :size="20" color="var(--ui-color-palette-gray-60)"/>\n\t\t\t<div class="booking-actions-popup__item-waitlist-label">\n\t\t\t\t{{ loc('BB_ACTIONS_POPUP_OVERBOOKING_LIST') }}\n\t\t\t</div>\n\t\t</div>\n\t`};function ue(t,{emit:e}){const o=t.bookingId;const i=()=>{e("close");new A.RemoveBooking(o)};return vt.h(D.RemoveButton,{dataAttributes:{"data-booking-id":o,"data-element":"booking-menu-remove-button"},onRemove:i})}const me=["bookingId"];ue.props=me;ue.emits=["close"];const he=Object.freeze({client:"client",confirmation:"confirmation",deal:"deal",document:"document",extraResourcesInfo:"extraResourcesInfo",fullForm:"fullForm",message:"message",visit:"visit",overbooking:"overbooking",remove:"remove",waitList:"waitList"});const pe={name:"BookingActionsPopup",components:{ActionsPopup:D.ActionsPopup,Overbooking:de,Waitlist:ce,BookingRemoveBtn:ue},props:{bindElement:{type:HTMLElement,required:true},bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true},options:{type:Object,default:null}},emits:["close"],data(){return{soonTmp:false}},computed:{config(){return{offsetLeft:this.getOffsetLeft(),offsetTop:-200}},contentStructure(){return[{id:he.client,props:{bookingId:this.bookingId},component:oe},{id:he.extraResourcesInfo,props:{bookingId:this.bookingId,resourceId:this.resourceId},component:ne},[{id:he.deal,props:{bookingId:this.bookingId},component:ie},{id:he.document,props:{bookingId:this.bookingId},component:se}],{id:he.message,props:{bookingId:this.bookingId},component:re},{id:he.confirmation,props:{bookingId:this.bookingId},component:ae},{id:he.visit,props:{bookingId:this.bookingId},component:le},[{id:he.fullForm,props:{bookingId:this.bookingId},component:D.FullForm},{id:he.info,class:"--shrink",props:{bookingId:this.bookingId},component:D.Info}]]},booking(){return this.$store.getters[`${Bt.Model.Bookings}/getById`](this.bookingId)}},methods:{getOffsetLeft(){const{left:t}=this.bindElement.getBoundingClientRect();if(window.innerWidth-t<325){return-325}return this.bindElement.offsetWidth}},template:`\n\t\t<ActionsPopup\n\t\t\t:popupId="bookingId"\n\t\t\t:bindElement="bindElement"\n\t\t\t:contentStructure="contentStructure"\n\t\t\t:popupOptions="config"\n\t\t\t@close="$emit('close')"\n\t\t>\n\t\t\t<template #footer>\n\t\t\t\t<Overbooking\n\t\t\t\t\tv-if="!options?.overbooking?.hidden"\n\t\t\t\t\t:bookingId\n\t\t\t\t\t:resourceId\n\t\t\t\t\t:disabled="Boolean(options?.overbooking?.disabled)"\n\t\t\t\t\t@close="$emit('close')"\n\t\t\t\t/>\n\t\t\t\t<Waitlist v-if="!options?.waitList?.hidden" :bookingId/>\n\t\t\t\t<BookingRemoveBtn :bookingId @close="$emit('close')"/>\n\t\t\t</template>\n\t\t</ActionsPopup>\n\t`};const ge={name:"BookingActions",props:{bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true},actionsPopupOptions:{type:Object,default:null}},data(){return{showPopup:false}},mounted(){if(this.isEditingBookingMode&&this.editingBookingId===this.bookingId){this.showPopup=true}},computed:mt.mapGetters({editingBookingId:`${Bt.Model.Interface}/editingBookingId`,isEditingBookingMode:`${Bt.Model.Interface}/isEditingBookingMode`}),methods:{clickHandler(){this.showPopup=true}},components:{BookingActionsPopup:pe},template:`\n\t\t<div \n\t\t\tref="node"\n\t\t\tclass="booking-booking-booking-actions"\n\t\t\tdata-element="booking-booking-actions-button"\n\t\t\t:data-id="bookingId"\n\t\t\t:data-resource-id="resourceId"\n\t\t\t@click="clickHandler"\n\t\t>\n\t\t\t<div class="booking-booking-booking-actions-inner">\n\t\t\t\t<div class="ui-icon-set --chevron-down"></div>\n\t\t\t</div>\n\t\t</div>\n\t\t<BookingActionsPopup\n\t\t\tv-if="showPopup"\n\t\t\t:bookingId\n\t\t\t:bindElement="this.$refs.node"\n\t\t\t:resourceId\n\t\t\t:options="actionsPopupOptions"\n\t\t\t@close="showPopup = false"\n\t\t/>\n\t`};const be={name:"BookingAddClient",props:{bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true},expired:{type:Boolean,default:false}},computed:{...mt.mapGetters({getBookingById:`${Bt.Model.Bookings}/getById`})},mounted(){if(O.isRealId(this.bookingId)){bt.ahaMoments.setBookingForAhaMoment(this.bookingId)}if(bt.ahaMoments.shouldShow(Bt.AhaMoment.AddClient,{bookingId:this.bookingId})){void this.showAhaMoment()}},methods:{async addClientsToBook(t){const e=this.getBookingById(this.bookingId);await st.bookingService.update({id:e.id,clients:t})},async showAhaMoment(){var t,e;await bt.ahaMoments.show({id:"booking-add-client",title:this.loc("BOOKING_AHA_ADD_CLIENT_TITLE"),text:this.loc("BOOKING_AHA_ADD_CLIENT_TEXT_MSGVER_1"),target:(t=this.$refs.bookingAddClientBtn)==null?void 0:(e=t.$refs)==null?void 0:e.button});bt.ahaMoments.setShown(Bt.AhaMoment.AddClient)}},components:{AddClient:P.AddClient},template:`\n\t\t<AddClient\n\t\t\t:expired="expired"\n\t\t\t:dataAttributes="{\n\t\t\t\t'data-id': bookingId,\n\t\t\t\t'data-element': 'booking-add-client-button',\n\t\t\t\t'data-resource-id': resourceId,\n\t\t\t}"\n\t\t\tbuttonClass="booking-booking-booking-add-client"\n\t\t\tref="bookingAddClientBtn"\n\t\t\t@add="addClientsToBook"\n\t\t/>\n\t`};const fe={name:"ChangeTimePopup",emits:["close"],props:{bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true},targetNode:{type:HTMLElement,required:true}},data(){return{ButtonSize:Tt.ButtonSize,ButtonColor:Tt.ButtonColor,ButtonIcon:Tt.ButtonIcon,fromTs:0,toTs:0,duration:0}},created(){this.fromTs=this.booking.dateFromTs;this.toTs=this.booking.dateToTs;this.duration=this.toTs-this.fromTs},mounted(){ht.Event.bind(document,"scroll",this.adjustPosition,true)},beforeUnmount(){ht.Event.unbind(document,"scroll",this.adjustPosition,true)},computed:{...mt.mapGetters({selectedDateTs:`${Bt.Model.Interface}/selectedDateTs`}),popupId(){return`booking-change-time-popup-${this.bookingId}-${this.resourceId}`},config(){return{className:"booking-booking-change-time-popup",bindElement:this.targetNode,offsetTop:-10,bindOptions:{forceBindPosition:true,position:"top"},angle:{offset:this.targetNode.offsetWidth/2}}},isBusy(){const t=this.bookingId;const e=this.bookings.filter((({id:e,dateToTs:o,dateFromTs:i})=>{if(e!==t&&this.overbookingMap.has(e)){var s;const o=this.overbookingMap.get(e);const i=o.items.find((t=>t.resourceId===this.resourceId));const n=(i==null?void 0:(s=i.intersections)==null?void 0:s.filter((e=>e.id!==t&&e.dateToTs>this.fromTs&&this.toTs>e.dateFromTs)))||[];if(i&&n.length===0){return false}}return e!==t&&o>this.fromTs&&this.toTs>i}));return e.length>1},bookings(){return this.$store.getters[`${Bt.Model.Bookings}/getByDateAndResources`](this.selectedDateTs,this.booking.resourcesIds)},booking(){return this.$store.getters["bookings/getById"](this.bookingId)},overbookingMap(){return this.$store.getters[`${Bt.Model.Bookings}/overbookingMap`]}},methods:{adjustPosition(){this.$refs.popup.adjustPosition();this.$refs.timeFrom.adjustMenuPosition();this.$refs.timeTo.adjustMenuPosition()},closePopup(){const t=this.booking.dateFromTs!==this.fromTs||this.booking.dateToTs!==this.toTs;if(!this.isBusy&&t){void st.bookingService.update({id:this.booking.id,dateFromTs:this.fromTs,dateToTs:this.toTs,timezoneFrom:this.booking.timezoneFrom,timezoneTo:this.booking.timezoneTo})}this.$emit("close")},freeze(){this.$refs.popup.getPopupInstance().setAutoHide(false)},unfreeze(){this.$refs.popup.getPopupInstance().setAutoHide(true)}},watch:{fromTs(){this.toTs=this.fromTs+this.duration},toTs(){if(this.toTs<=this.fromTs){this.fromTs=this.toTs-this.duration}this.duration=this.toTs-this.fromTs},isBusy(){setTimeout((()=>this.adjustPosition()),0)}},components:{Popup:It.Popup,TimeSelector:I.TimeSelector,Button:Tt.Button},template:`\n\t\t<Popup\n\t\t\t:id="popupId"\n\t\t\t:config="config"\n\t\t\t@close="closePopup"\n\t\t\tref="popup"\n\t\t>\n\t\t\t<div class="booking-booking-change-time-popup-content">\n\t\t\t\t<div class="booking-booking-change-time-popup-main">\n\t\t\t\t\t<TimeSelector\n\t\t\t\t\t\tv-model="fromTs"\n\t\t\t\t\t\t:hasError="isBusy"\n\t\t\t\t\t\tdata-element="booking-change-time-from"\n\t\t\t\t\t\t:data-ts="fromTs"\n\t\t\t\t\t\t:data-booking-id="bookingId"\n\t\t\t\t\t\tref="timeFrom"\n\t\t\t\t\t\t@freeze="freeze"\n\t\t\t\t\t\t@unfreeze="unfreeze"\n\t\t\t\t\t\t@enterSave="closePopup"\n\t\t\t\t\t/>\n\t\t\t\t\t<div class="booking-booking-change-time-popup-separator"></div>\n\t\t\t\t\t<TimeSelector\n\t\t\t\t\t\tv-model="toTs"\n\t\t\t\t\t\t:hasError="isBusy"\n\t\t\t\t\t\t:minTs="fromTs"\n\t\t\t\t\t\tdata-element="booking-change-time-to"\n\t\t\t\t\t\t:data-ts="toTs"\n\t\t\t\t\t\t:data-booking-id="bookingId"\n\t\t\t\t\t\tref="timeTo"\n\t\t\t\t\t\t@freeze="freeze"\n\t\t\t\t\t\t@unfreeze="unfreeze"\n\t\t\t\t\t\t@enterSave="closePopup"\n\t\t\t\t\t/>\n\t\t\t\t\t<Button\n\t\t\t\t\t\tclass="booking-booking-change-time-popup-button"\n\t\t\t\t\t\t:size="ButtonIcon.MEDIUM"\n\t\t\t\t\t\t:color="ButtonColor.PRIMARY"\n\t\t\t\t\t\t:icon="ButtonIcon.DONE"\n\t\t\t\t\t\t:disabled="isBusy"\n\t\t\t\t\t\t@click="closePopup"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<div v-if="isBusy" class="booking-booking-change-time-popup-error">\n\t\t\t\t\t{{ loc('BOOKING_BOOKING_TIME_IS_NOT_AVAILABLE') }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</Popup>\n\t`};const Ie={props:{bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true},dateFromTs:{type:Number,required:true},dateToTs:{type:Number,required:true}},data(){return{showPopup:false}},computed:{...mt.mapGetters({offset:`${Bt.Model.Interface}/offset`,isFeatureEnabled:`${Bt.Model.Interface}/isFeatureEnabled`}),booking(){return this.$store.getters["bookings/getById"](this.bookingId)},timeFormatted(){const t=at.DateTimeFormat.getFormat("SHORT_TIME_FORMAT");return this.loc("BOOKING_BOOKING_TIME_RANGE",{"#FROM#":at.DateTimeFormat.format(t,(this.dateFromTs+this.offset)/1e3),"#TO#":at.DateTimeFormat.format(t,(this.dateToTs+this.offset)/1e3)})}},methods:{clickHandler(){if(!this.isFeatureEnabled){return}this.showPopup=true},closePopup(){this.showPopup=false}},components:{ChangeTimePopup:fe},template:`\n\t\t<div\n\t\t\tclass="booking-booking-booking-time"\n\t\t\t:class="{'--lock': !isFeatureEnabled}"\n\t\t\tdata-element="booking-booking-time"\n\t\t\t:data-booking-id="bookingId"\n\t\t\t:data-resource-id="resourceId"\n\t\t\t:data-from="booking.dateFromTs"\n\t\t\t:data-to="booking.dateToTs"\n\t\t\tref="time"\n\t\t\t@click="clickHandler"\n\t\t>\n\t\t\t{{ timeFormatted }}\n\t\t</div>\n\t\t<ChangeTimePopup\n\t\t\tv-if="showPopup"\n\t\t\t:bookingId="bookingId"\n\t\t\t:resourceId="resourceId"\n\t\t\t:targetNode="$refs.time"\n\t\t\t@close="closePopup"\n\t\t/>\n\t`};const ke={name:"BookingName",components:{Name:P.Name},props:{bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true}},computed:{booking(){return this.$store.getters[`${Bt.Model.Bookings}/getById`](this.bookingId)},client(){const t=this.booking.primaryClient;return t?this.$store.getters[`${Bt.Model.Clients}/getByClientData`](t):null},bookingName(){var t;return((t=this.client)==null?void 0:t.name)||this.booking.name||this.loc("BOOKING_BOOKING_DEFAULT_BOOKING_NAME")}},template:`\n\t\t<Name\n\t\t\t:name="bookingName"\n\t\t\tclassName="booking-booking-booking-name"\n\t\t\t:dataAttributes="{\n\t\t\t\t'data-element': 'booking-booking-name',\n\t\t\t\t'data-id': bookingId,\n\t\t\t\t'data-resource-id':resourceId,\n\t\t\t}"\n\t\t/>\n\t`};const ve={name:"BookingNote",components:{Note:P.Note,NotePopup:k.NotePopup},props:{bookingId:{type:[Number,String],required:true},bindElement:{type:Function,required:true},visiblePopup:{type:Boolean,default:false}},computed:{booking(){return this.$store.getters[`${Bt.Model.Bookings}/getById`](this.bookingId)}},watch:{visiblePopup(t){if(t){var e;(e=this.$refs.note)==null?void 0:e.showViewPopup()}else{var o;(o=this.$refs.note)==null?void 0:o.closeViewPopup()}}},methods:{async saveBookingNote({note:t}){await st.bookingService.update({id:this.booking.id,note:t})}},template:`\n\t\t<Note\n\t\t\tref="note"\n\t\t\t:id="bookingId"\n\t\t\t:note="booking.note"\n\t\t\t:bindElement\n\t\t\tclassName="booking-booking-booking-note-button"\n\t\t\t:dataId="bookingId"\n\t\t\tdataElementPrefix="booking"\n\t\t\t:dataAttributes="{\n\t\t\t\t'data-id': bookingId,\n\t\t\t\t'data-element': 'booking-booking-note-button',\n\t\t\t}"\n\t\t\t@save="saveBookingNote"\n\t\t/>\n\t`};const Be={name:"BookingProfit",components:{Profit:P.Profit},props:{bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true}},computed:{booking(){return this.$store.getters[`${Bt.Model.Bookings}/getById`](this.bookingId)},deal(){var t,e;return(t=(e=this.booking.externalData)==null?void 0:e.find((t=>t.entityTypeId===Bt.CrmEntity.Deal)))!=null?t:null}},template:`\n\t\t<Profit\n\t\t\t:deal\n\t\t\t:dataAttributes="{\n\t\t\t\t'data-id': bookingId,\n\t\t\t\t'data-resource-id': resourceId,\n\t\t\t\t'data-element': 'booking-booking-profit'\n\t\t\t}"\n\t\t\tclassName="booking-booking-booking-profit"\n\t\t/>\n\t`};const Te={name:"BookingCrmButton",components:{CrmButton:P.CrmButton},props:{bookingId:{type:[Number,String],required:true}},setup(t){const e=new $.BookingDealHelper(t.bookingId);return{dealHelper:e}},template:`\n\t\t<CrmButton\n\t\t\t:dealHelper\n\t\t\t:dataAttributes="{\n\t\t\t\t'data-booking-id': bookingId,\n\t\t\t\t'data-element': 'booking-crm-button'\n\t\t\t}"\n\t\t/>\n\t`};const ye={components:{BIcon:Z.BIcon,UiCounter:T.Counter},props:{bookingId:{type:[Number,String],required:true},nowTs:{type:Number,required:true}},setup(){return{Animated:v.Animated,Main:v.Main,CounterColor:T.CounterColor,CounterSize:T.CounterSize}},computed:{...mt.mapGetters({notificationTypes:`${Bt.Model.Dictionary}/getNotifications`}),booking(){return this.$store.getters[`${Bt.Model.Bookings}/getById`](this.bookingId)},showClocking(){var t;if(this.showCounter||this.isExpiredBooking||this.hasVisitStatus||this.isNotVisited){return false}const e=Object.fromEntries(Object.entries(this.notificationTypes).map((([t,{value:e}])=>[t,e])));const o=(t=this.booking.messages)==null?void 0:t.some((({notificationType:t})=>t===e.Confirmation));return!this.booking.isConfirmed&&o},showConfirmed(){if(this.showCounter||this.isExpiredBooking||this.isNotVisited){return false}return this.booking.isConfirmed},showCounter(){return this.booking.counter>0},isExpiredBooking(){return this.nowTs>this.booking.dateToTs},hasVisitStatus(){return[Bt.VisitStatus.Visited,Bt.VisitStatus.NotVisited].includes(this.booking.visitStatus)},isNotVisited(){const t=this.nowTs>this.booking.dateFromTs;const e=this.booking.visitStatus===Bt.VisitStatus.Unknown;const o=this.booking.visitStatus===Bt.VisitStatus.NotVisited;return t&&e||o}},template:`\n\t\t<div class="booking--counter">\n\t\t\t<div v-if="showClocking" class="booking-counter-icon --clocking">\n\t\t\t\t<BIcon :name="Animated.LOADER_CLOCK" :hoverable="false"/>\n\t\t\t</div>\n\t\t\t<div v-else-if="showConfirmed" class="booking-counter-icon --confirmed">\n\t\t\t\t<BIcon :name="Main.CHECK" :hoverable="false"/>\n\t\t\t</div>\n\t\t\t<UiCounter\n\t\t\t\tv-else-if="showCounter"\n\t\t\t\t:value="booking.counter"\n\t\t\t\t:color="CounterColor.DANGER"\n\t\t\t\t:size="CounterSize.LARGE"\n\t\t\t\tborder\n\t\t\t/>\n\t\t</div>\n\t`};const Me=Object.freeze({From:-1,None:0,To:1});const Ee=lt.Duration.getUnitDurations().i*5;const we=lt.Duration.getUnitDurations().i*15;const Ce={name:"BookingResize",props:{bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true}},setup(){const t=null;const e=null;return{tooltipTop:t,tooltipBottom:e}},data(){return{resizeDirection:Me.None,resizeFromTs:null,resizeToTs:null}},computed:{...mt.mapGetters({selectedDateTs:`${Bt.Model.Interface}/selectedDateTs`,overbookingMap:`${Bt.Model.Bookings}/overbookingMap`}),booking(){return this.$store.getters[`${Bt.Model.Bookings}/getById`](this.bookingId)},limits(){return{fromTs:new Date(this.selectedDateTs).setHours(0,0,0,0),toTs:new Date(this.selectedDateTs).setHours(24,0,0,0)}},initialHeight(){return M.grid.calculateHeight(this.booking.dateFromTs,this.booking.dateToTs)},initialDuration(){return Math.max(this.booking.dateToTs-this.booking.dateFromTs,we)},dateFromTsRounded(){return this.roundTimestamp(this.resizeFromTs)},dateToTsRounded(){return this.roundTimestamp(this.resizeToTs)},closestOnFrom(){return this.colliding.reduce(((t,{toTs:e})=>t<e&&e<=this.booking.dateFromTs?e:t),0)},closestOnTo(){return this.colliding.reduce(((t,{fromTs:e})=>this.booking.dateToTs<=e&&e<t?e:t),Infinity)},excludeBookings(){const t=this.overbookingMap;return e=>{if(e.id===this.bookingId){return true}const o=t.get(e.id);const i=this.booking.resourcesIds;return!o||o.items.every((t=>!i.includes(t.resourceId)))}},colliding(){return this.$store.getters[`${Bt.Model.Interface}/getColliding`](this.booking.resourcesIds,this.excludeBookings)},hasIntersections(){return this.booking.resourcesIds.length>1}},methods:{createPopup(t){return new ft.Popup({autoHide:true,cacheable:true,darkMode:true,...t})},showTooltipTop(t){if(!this.tooltipTop){this.tooltipTop=this.createPopup({id:`resize-top-${this.bookingId}-${this.resourceId}`,bindElement:this.$refs.bookingResizeTop,bindOptions:{position:"bottom"},offsetLeft:this.$refs.bookingResizeTop.offsetWidth/2,content:this.loc("BOOKING_RESIZE_GRID_LIMIT"),...t})}else if(t!=null&&t.content){this.tooltipTop.setContent(t.content)}this.tooltipTop.show()},showTooltipBottom(t){if(!this.tooltipBottom){this.tooltipBottom=this.createPopup({id:`resize-bottom-${this.bookingId}-${this.resourceId}`,bindElement:this.$refs.bookingResizeBottom,bindOptions:{position:"bottom"},offsetLeft:this.$refs.bookingResizeBottom.offsetWidth/2,content:this.loc("BOOKING_RESIZE_GRID_LIMIT"),...t})}else if(t!=null&&t.content){this.tooltipBottom.setContent(t.content)}this.tooltipBottom.show()},hideTooltips(){var t,e;(t=this.tooltipTop)==null?void 0:t.close==null?void 0:t.close();(e=this.tooltipBottom)==null?void 0:e.close==null?void 0:e.close()},onMouseDown(t){const e=ht.Dom.hasClass(t.target,"--from")?Me.From:Me.To;void this.startResize(e)},async startResize(t=Me.To){ht.Dom.style(document.body,"user-select","none");ht.Event.bind(window,"mouseup",this.endResize);ht.Event.bind(window,"pointermove",this.resize);this.resizeDirection=t;void this.updateIds(this.bookingId,this.resourceId)},resize(t){if(!this.resizeDirection){return}const e=this.resizeDirection===Me.To?t.clientY-this.$el.getBoundingClientRect().top:this.$el.getBoundingClientRect().bottom-t.clientY;const o=e*this.initialDuration/this.initialHeight;const i=Math.max(o,Ee);if(this.resizeDirection===Me.To){const t=this.booking.dateFromTs+i;const e=Math.min(t,this.limits.toTs);this.manageToLimitNotification(t,e);this.resizeFromTs=this.booking.dateFromTs;this.resizeToTs=Math.min(e,this.closestOnTo)}else{const t=this.booking.dateToTs-i;const e=Math.max(t,this.limits.fromTs);this.manageFromLimitNotification(t,e);this.resizeFromTs=Math.max(e,this.closestOnFrom);this.resizeToTs=this.booking.dateToTs}this.$emit("update",this.resizeFromTs,this.resizeToTs)},async endResize(){this.resizeBooking();this.hideTooltips();ht.Dom.style(document.body,"user-select","");ht.Event.unbind(window,"mouseup",this.endResize);ht.Event.unbind(window,"pointermove",this.resize);this.$emit("update",null,null);await this.updateIds(null,null)},manageFromLimitNotification(t,e){const o=this.colliding.filter((({toTs:t})=>t===this.closestOnFrom));if(t<this.limits.fromTs){this.showTooltipTop({content:this.loc("BOOKING_RESIZE_GRID_LIMIT")});return}if(e<this.closestOnFrom){if(this.checkClosestByIntersection(o)){this.showTooltipTop({content:this.loc("BOOKING_RESIZE_INTERSECTIONS_LIMIT")});return}this.showTooltipTop({content:this.loc("BOOKING_RESIZE_LIMIT")});return}this.hideTooltips()},manageToLimitNotification(t,e){const o=this.colliding.filter((({fromTs:t})=>t===this.closestOnTo));if(t>this.limits.toTs){this.showTooltipBottom({content:this.loc("BOOKING_RESIZE_GRID_LIMIT")});return}if(e>this.closestOnTo){if(this.checkClosestByIntersection(o)){this.showTooltipBottom({content:this.loc("BOOKING_RESIZE_INTERSECTIONS_LIMIT")});return}this.showTooltipBottom({content:this.loc("BOOKING_RESIZE_LIMIT")});return}this.hideTooltips()},checkClosestByIntersection(t){return this.hasIntersections&&(t.length===1||t.filter((t=>t.resourcesIds[0]!==this.resourceId)).length>=2)},async updateIds(t,e){await Promise.all([this.$store.dispatch(`${Bt.Model.Interface}/setResizedBookingId`,t),this.$store.dispatch(`${Bt.Model.Interface}/setDraggedBookingResourceId`,e)]);void et.busySlots.loadBusySlots()},resizeBooking(){if(!this.dateFromTsRounded||!this.dateToTsRounded){return}if(this.dateFromTsRounded===this.booking.dateFromTs&&this.dateToTsRounded===this.booking.dateToTs){return}const t=this.$store.getters[`${Bt.Model.Resources}/getById`](this.resourceId);if(t.isDeleted){return}const e=this.bookingId;const o={id:e,dateFromTs:this.dateFromTsRounded,dateToTs:this.dateToTsRounded,timezoneFrom:this.booking.timezoneFrom,timezoneTo:this.booking.timezoneTo};if(!O.isRealId(this.bookingId)){void this.$store.dispatch(`${Bt.Model.Bookings}/update`,{id:e,booking:o});return}void st.bookingService.update({id:e,...o})},roundTimestamp(t){const e=lt.Duration.getUnitDurations().i*5;return Math.round(t/e)*e}},template:`\n\t\t<div>\n\t\t\t<div ref="bookingResizeTop" class="booking-booking-resize --from" @mousedown="onMouseDown"></div>\n\t\t\t<div ref="bookingResizeBottom" class="booking-booking-resize --to" @mousedown="onMouseDown"></div>\n\t\t</div>\n\t`};const Se=280;const Le={name:"BookingBase",props:{bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true},nowTs:{type:Number,required:true},width:{type:Number,default:Se},leftOffset:{type:Number,default:0},bookingClass:{type:[String,Object,Array],default:""},bookingStyle:{type:[String,Object,Array],default:""}},data(){return{visible:true,isDisabledPopupShown:false,resizeFromTs:null,resizeToTs:null,visibleNotePopup:false}},mounted(){this.updateVisibility();this.updateVisibilityDuringTransition();setTimeout((()=>{if(!this.isReal&&f.mousePosition.isMousePressed()){void this.$refs.resize.startResize()}}),300)},beforeUnmount(){var t;if(this.deletingBookings[this.bookingId]||!((t=this.booking)!=null&&t.resourcesIds.includes(this.resourceId))){this.$el.remove()}},computed:{...mt.mapGetters({resourcesIds:`${Bt.Model.Interface}/resourcesIds`,zoom:`${Bt.Model.Interface}/zoom`,scroll:`${Bt.Model.Interface}/scroll`,draggedBookingId:`${Bt.Model.Interface}/draggedBookingId`,draggedDataTransfer:`${Bt.Model.Interface}/draggedDataTransfer`,editingBookingId:`${Bt.Model.Interface}/editingBookingId`,isEditingBookingMode:`${Bt.Model.Interface}/isEditingBookingMode`,deletingBookings:`${Bt.Model.Interface}/deletingBookings`}),isReal(){return O.isRealId(this.bookingId)},booking(){return this.$store.getters[`${Bt.Model.Bookings}/getById`](this.bookingId)},client(){const t=this.booking.primaryClient;return t?this.$store.getters[`${Bt.Model.Clients}/getByClientData`](t):null},left(){return M.grid.calculateLeft(this.resourceId)},top(){return M.grid.calculateTop(this.dateFromTs)},height(){return M.grid.calculateHeight(this.dateFromTs,this.dateToTs)},realHeight(){return M.grid.calculateRealHeight(this.dateFromTs,this.dateToTs)},dateFromTs(){var t;return(t=this.resizeFromTs)!=null?t:this.booking.dateFromTs},dateToTs(){var t;return(t=this.resizeToTs)!=null?t:this.booking.dateToTs},dateFromTsRounded(){var t;return(t=this.roundTimestamp(this.resizeFromTs))!=null?t:this.dateFromTs},dateToTsRounded(){var t;return(t=this.roundTimestamp(this.resizeToTs))!=null?t:this.dateToTs},disabled(){return this.isEditingBookingMode&&this.editingBookingId!==this.bookingId},bookingOffset(){return this.leftOffset*this.zoom},isExpiredBooking(){return this.booking.dateToTs<this.nowTs},isNotVisited(){const t=this.nowTs>this.booking.dateFromTs;const e=this.booking.visitStatus===Bt.VisitStatus.Unknown;const o=this.booking.visitStatus===Bt.VisitStatus.NotVisited;return t&&e||o},disabledHover(){return this.draggedDataTransfer.id>0&&(this.draggedDataTransfer.kind!==Bt.DraggedElementKind.Booking||this.draggedDataTransfer.id!==this.bookingId)}},methods:{updateVisibilityDuringTransition(){var t;(t=this.animation)==null?void 0:t.stop();this.animation=new BX.easing({duration:200,start:{},finish:{},step:this.updateVisibility});this.animation.animate()},updateVisibility(){if(!this.$el){return}const t=this.$el.getBoundingClientRect();this.visible=t.right>0&&t.left<window.innerWidth},onNoteMouseEnter(){this.showNoteTimeout=setTimeout((()=>{this.visibleNotePopup=true}),100)},onNoteMouseLeave(){clearTimeout(this.showNoteTimeout);this.visibleNotePopup=false},onClick(t){if(this.disabled){this.isDisabledPopupShown=true;t.stopPropagation()}},resizeUpdate(t,e){this.resizeFromTs=t;this.resizeToTs=e},roundTimestamp(t){const e=lt.Duration.getUnitDurations().i*5;return t?Math.round(t/e)*e:null}},watch:{scroll(){this.updateVisibility()},zoom(){this.updateVisibility()},resourcesIds(){this.updateVisibilityDuringTransition()},visible(t){if(t){return}setTimeout((()=>{this.updateVisibility()}),2e3)}},components:{Actions:ge,BookingAddClient:be,BookingCrmButton:Te,BookingTime:Ie,BookingName:ke,BookingNote:ve,BookingProfit:Be,Communication:P.Communication,Counter:ye,DisabledPopup:P.DisabledPopup,Resize:Ce},template:`\n\t\t<div\n\t\t\tclass="booking-booking-booking booking--draggable-item"\n\t\t\tdata-element="booking-booking"\n\t\t\t:data-id="bookingId"\n\t\t\t:data-resource-id="resourceId"\n\t\t\tdata-kind="booking"\n\t\t\t:style="[bookingStyle, {\n\t\t\t\t'--left': left + bookingOffset + 'px',\n\t\t\t\t'--top': top + 'px',\n\t\t\t\t'--height': height + 'px',\n\t\t\t\t'--width': width + 'px',\n\t\t\t}].flat(1)"\n\t\t\t:class="[bookingClass, {\n\t\t\t\t'--not-real': !isReal,\n\t\t\t\t'--zoom-is-less-than-08': zoom < 0.8,\n\t\t\t\t'--compact-mode': realHeight < 40 || zoom < 0.8,\n\t\t\t\t'--small': realHeight <= 15,\n\t\t\t\t'--long': realHeight >= 65,\n\t\t\t\t'--disabled': disabled,\n\t\t\t\t'--confirmed': booking.isConfirmed && !isNotVisited,\n\t\t\t\t'--expired': isExpiredBooking,\n\t\t\t\t'--not-visited': isNotVisited,\n\t\t\t\t'--resizing': resizeFromTs && resizeToTs,\n\t\t\t\t'--no-pointer-events': disabledHover,\n\t\t\t}].flat(1)"\n\t\t\t@click.capture="onClick"\n\t\t>\n\t\t\t<div v-if="visible" class="booking-booking-booking-padding">\n\t\t\t\t<Counter :bookingId="bookingId" :nowTs="nowTs"/>\n\t\t\t\t<div class="booking-booking-booking-inner">\n\t\t\t\t\t<div class="booking-booking-booking-content">\n\t\t\t\t\t\t<div class="booking-booking-booking-content-row">\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tclass="booking-booking-booking-name-container"\n\t\t\t\t\t\t\t\t@mouseenter="onNoteMouseEnter"\n\t\t\t\t\t\t\t\t@mouseleave="onNoteMouseLeave"\n\t\t\t\t\t\t\t\t@click="visibleNotePopup = true"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<BookingName :bookingId="bookingId" :resourceId="resourceId"/>\n\t\t\t\t\t\t\t\t<BookingNote\n\t\t\t\t\t\t\t\t\t:bookingId="bookingId"\n\t\t\t\t\t\t\t\t\t:bindElement="() => $el"\n\t\t\t\t\t\t\t\t\t:visiblePopup="visibleNotePopup"\n\t\t\t\t\t\t\t\t\tref="note"\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<BookingTime\n\t\t\t\t\t\t\t\t:bookingId="bookingId"\n\t\t\t\t\t\t\t\t:resourceId="resourceId"\n\t\t\t\t\t\t\t\t:dateFromTs="dateFromTsRounded"\n\t\t\t\t\t\t\t\t:dateToTs="dateToTsRounded"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<BookingProfit :bookingId="bookingId" :resourceId="resourceId"/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="booking-booking-booking-content-row --lower">\n\t\t\t\t\t\t\t<BookingTime\n\t\t\t\t\t\t\t\t:bookingId="bookingId"\n\t\t\t\t\t\t\t\t:resourceId="resourceId"\n\t\t\t\t\t\t\t\t:dateFromTs="dateFromTsRounded"\n\t\t\t\t\t\t\t\t:dateToTs="dateToTsRounded"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<div v-if="client" class="booking-booking-booking-buttons">\n\t\t\t\t\t\t\t\t<Communication/>\n\t\t\t\t\t\t\t\t<BookingCrmButton :bookingId="bookingId"/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<BookingAddClient\n\t\t\t\t\t\t\t\tv-else\n\t\t\t\t\t\t\t\t:bookingId="bookingId"\n\t\t\t\t\t\t\t\t:resourceId="resourceId"\n\t\t\t\t\t\t\t\t:expired="isExpiredBooking"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<slot name="actions">\n\t\t\t\t\t\t<Actions :bookingId="bookingId" :resourceId="resourceId"/>\n\t\t\t\t\t</slot>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<Resize\n\t\t\t\tv-if="!disabled"\n\t\t\t\t:bookingId="bookingId"\n\t\t\t\t:resourceId="resourceId"\n\t\t\t\tref="resize"\n\t\t\t\t@update="resizeUpdate"\n\t\t\t/>\n\t\t\t<DisabledPopup\n\t\t\t\tv-if="isDisabledPopupShown"\n\t\t\t\t:popupId="['booking-booking-disabled-popup', bookingId, resourceId].join('-')"\n\t\t\t\t:bindElement="() => $el"\n\t\t\t\tcontentClass="booking-booking-disabled-popup-content"\n\t\t\t\t@close="isDisabledPopupShown = false"\n\t\t\t/>\n\t\t\t<slot/>\n\t\t</div>\n\t`};function Oe({booking:t,colliding:e,selectedDateTs:o,draggedBookingResourcesIds:i}){const s=new Date(o).setHours(0,0,0,0);const n=new Date(o).setHours(24,0,0,0);const r={fromTs:s,toTs:n};if(i.length>1){const o=e.find((({fromTs:e})=>e===t.dateFromTs));if(o&&i.every((t=>o.resourcesIds.includes(t)))){return null}}for(const{fromTs:o,toTs:i}of e){if(i<=t.dateFromTs){r.fromTs=Math.max(r.fromTs,i)}if(t.dateToTs<=o){r.toTs=Math.min(r.toTs,o)}}if(r.fromTs===s&&r.toTs===n){return null}return r}function Fe(t,e,o){const i=o.dateToTs-o.dateFromTs;if(e.dateFromTs>=t.fromTs&&e.dateFromTs+i<=t.toTs){return{dateFromTs:e.dateFromTs,dateToTs:e.dateFromTs+i}}if(e.dateToTs-i>=t.fromTs&&e.dateToTs<=t.toTs){return{dateFromTs:e.dateToTs-i,dateToTs:e.dateToTs}}return{dateFromTs:t.fromTs,dateToTs:t.fromTs+i}}function De(t){const e=t.length>0?t.length:1;return Se/e}function Pe({bookingId:t,bookingWidth:e,overlappingBookings:o}){let i=o.indexOf(t);if(i===-1){i=0}return e*i}const $e={name:"Booking",components:{BookingBase:Le,Actions:ge},props:{bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true},nowTs:{type:Number,required:true},bookingUiGroups:{type:Array,default:()=>[]}},data(){return{dropArea:false,freeSpace:null}},computed:{...mt.mapGetters({getBookingById:`${Bt.Model.Bookings}/getById`,overbookingMap:`${Bt.Model.Bookings}/overbookingMap`,selectedDateTs:`${Bt.Model.Interface}/selectedDateTs`,deletingBookings:`${Bt.Model.Interface}/deletingBookings`,animationPause:`${Bt.Model.Interface}/animationPause`,isBookingCreatedFromEmbed:`${Bt.Model.Interface}/isBookingCreatedFromEmbed`,editingBookingId:`${Bt.Model.Interface}/editingBookingId`,draggedDataTransfer:`${Bt.Model.Interface}/draggedDataTransfer`,draggedBookingId:`${Bt.Model.Interface}/draggedBookingId`,getWaitListItemById:`${Bt.Model.WaitList}/getById`,getResourceById:`${Bt.Model.Resources}/getById`,isDeletingResourceFilterMode:`${Bt.Model.Filter}/isDeletingResourceFilterMode`,deletingResource:`${Bt.Model.Filter}/deletingResource`}),booking(){return this.getBookingById(this.bookingId)},deletingBookings(){return Object.values(this.$store.getters[`${Bt.Model.Interface}/deletingBookings`])},overbooking(){return this.overbookingMap.get(this.bookingId)||null},overbookingInResource(){var t,e;return((t=this.overbooking)==null?void 0:(e=t.items)==null?void 0:e.find((t=>t.resourceId===this.resourceId)))||null},hasOverbooking(){var t;return(((t=this.overbookingInResource)==null?void 0:t.intersections)||[]).some((({id:t})=>!this.deletingBookings.includes(t)))},isShifted(){return this.hasOverbooking&&ht.Type.isPlainObject(this.overbookingInResource)&&this.overbookingInResource.shifted},overlappingBookings(){var t;const e=!this.isShifted||!this.hasOverbooking?this.bookingId:this.overbookingDependencies[0];return((t=this.bookingUiGroups.find((({bookingIds:t})=>t.includes(e))))==null?void 0:t.bookingIds)||[]},overbookingDependencies(){var t;return(((t=this.overbookingInResource)==null?void 0:t.intersections)||[]).map((({id:t})=>t))},bookingWidth(){if(this.hasOverbooking){return De(this.overlappingBookings)/2}return De(this.overlappingBookings)},leftOffset(){if(this.isShifted){const t=this.overbookingDependencies[0];const e=Pe({bookingId:t,bookingWidth:this.bookingWidth,overlappingBookings:this.overlappingBookings});return e*2+this.bookingWidth}return Pe({bookingId:this.booking.id,bookingWidth:this.hasOverbooking?this.bookingWidth*2:this.bookingWidth,overlappingBookings:this.overlappingBookings})},actionsPopupOptions(){return{overbooking:{disabled:this.overbooking!==null,hidden:this.isDeletedResource},waitList:{hidden:this.isDeletedResource}}},realBooking(){return ht.Type.isNumber(this.bookingId)},hasAccent(){return this.editingBookingId===this.bookingId||this.isBookingCreatedFromEmbed(this.bookingId)},isDeletedResource(){var t,e;return(t=(e=this.getResourceById(this.resourceId))==null?void 0:e.isDeleted)!=null?t:false},isShaded(){return this.isDeletingResourceFilterMode&&this.resourceId!==this.deletingResource.id}},watch:{draggedDataTransfer:{handler(t){if(this.hasOverbooking){return}if(t.kind===Bt.DraggedElementKind.Booking&&t.id===this.bookingId){return}if(!t||!t.kind||!t.id){this.stopDropHandler()}else{this.startDropHandler()}},deep:true}},methods:{dragMouseEnter(){if(this.isDeletedResource){this.dropArea=false;return}if(this.dropArea||!this.draggedDataTransfer.id){return}if(this.draggedDataTransfer.kind===Bt.DraggedElementKind.WaitListItem){this.freeSpace={fromTs:this.booking.dateFromTs,toTs:this.booking.dateToTs,resourcesIds:this.booking.resourcesIds};this.dropArea=true;return}const t=this.draggedBookingId;if(t===null){return}const e=this.getBookingById(t);const o=this.booking.dateToTs-this.booking.dateFromTs;const i=e.dateToTs-e.dateFromTs;if(o>=i&&e.resourcesIds.length<=1){this.freeSpace={fromTs:this.booking.dateFromTs,toTs:this.booking.dateToTs,resourcesIds:this.booking.resourcesIds};this.dropArea=true;return}const s=t=>{if(t.id===this.draggedBookingId){return true}const e=this.overbookingMap.get(t.id);const o=this.resourceId;return!e||e.items.some((t=>t.resourceId===o))};const n=this.$store.getters[`${Bt.Model.Interface}/getColliding`](this.resourceId,s);if(n.length===0){this.freeSpace={fromTs:this.booking.dateFromTs,toTs:this.booking.dateToTs,resourcesIds:this.booking.resourcesIds};this.dropArea=true;return}const r=Oe({booking:this.booking,colliding:n,selectedDateTs:this.selectedDateTs,draggedBookingResourcesIds:e.resourcesIds});this.freeSpace=r;this.dropArea=r&&r.toTs-r.fromTs>=i},dragMouseLeave(){this.dropArea=false;this.freeSpace=null},async dropElement(){const t=this.draggedDataTransfer.id;if(!t||!this.freeSpace){return}if(this.draggedDataTransfer.kind===Bt.DraggedElementKind.Booking){await this.dropBooking(t);return}if(this.draggedDataTransfer.kind===Bt.DraggedElementKind.WaitListItem){await this.dropWaitListItem(t)}},async dropBooking(t){const e=this.getBookingById(t);const{dateFromTs:o,dateToTs:i}=Fe(this.freeSpace,this.booking,e);const s={id:t,dateFromTs:o,dateToTs:i,timezoneFrom:e.timezoneFrom,timezoneTo:e.timezoneTo,resourcesIds:[...new Set([this.resourceId,...e.resourcesIds.slice(1,e.resourcesIds.length)])]};if(!O.isRealId(t)){await this.$store.dispatch(`${Bt.Model.Bookings}/update`,{id:t,booking:s});return}await st.bookingService.update({id:t,...s})},async dropWaitListItem(t){var e,o;const i=this.getWaitListItemById(t);const s=[...i.clients];const n=this.getResourceById(this.resourceId);const r=n==null?void 0:(e=n.slotRanges)==null?void 0:(o=e[0])==null?void 0:o.timezone;const a={id:`wl${t}`,resourcesIds:[this.resourceId],name:i.name,note:i.note,clients:s,primaryClient:s.length>0?s[0]:undefined,externalData:[...i.externalData],dateFromTs:this.booking.dateFromTs,dateToTs:this.booking.dateToTs,timezoneFrom:r,timezoneTo:r};const l=await st.bookingService.createFromWaitListItem(t,a);if(l.success&&l.booking){ct.BookingAnalytics.sendAddBooking({isOverbooking:true})}},startDropHandler(){ht.Event.bind(this.$el,"mousemove",this.dragMouseEnter,{capture:true});ht.Event.bind(this.$el,"mouseleave",this.dragMouseLeave,{capture:true});ht.Event.bind(this.$el,"mouseup",this.dropElement,{capture:true})},stopDropHandler(){this.dropArea=false;this.freeSpace=null;ht.Event.unbind(this.$el,"mousemove",this.dragMouseEnter,{capture:true});ht.Event.unbind(this.$el,"mouseleave",this.dragMouseLeave,{capture:true});ht.Event.unbind(this.$el,"mouseup",this.dropElement,{capture:true})}},template:`\n\t\t<BookingBase\n\t\t\t:bookingId\n\t\t\t:resourceId\n\t\t\t:nowTs\n\t\t\t:leftOffset\n\t\t\t:bookingClass="{\n\t\t\t\t'--short': overlappingBookings.length > 1,\n\t\t\t\t'--overbooking': hasOverbooking,\n\t\t\t\t'--overbooking-bg': hasOverbooking || overbooking !== null,\n\t\t\t\t'--shifted': isShifted && !realBooking,\n\t\t\t\t'--drop-area': dropArea,\n\t\t\t\t'--accent': hasAccent,\n\t\t\t\t'--shaded': isShaded,\n\t\t\t\t'not-transition': animationPause,\n\t\t\t}"\n\t\t\t:width="bookingWidth"\n\t\t>\n\t\t\t<template #actions>\n\t\t\t\t<Actions\n\t\t\t\t\t:bookingId\n\t\t\t\t\t:resourceId\n\t\t\t\t\t:actionsPopupOptions\n\t\t\t\t/>\n\t\t\t</template>\n\t\t\t<div class="booking--booking-pseudo-overbooking"></div>\n\t\t</BookingBase>\n\t`};const Re={name:"BusyPopup",components:{Popup:It.Popup},props:{busySlot:{type:Object,required:true}},emits:["close"],computed:{...mt.mapGetters({offset:`${Bt.Model.Interface}/offset`,mousePosition:`${Bt.Model.Interface}/mousePosition`}),resource(){const t=this.busySlot.type===Bt.BusySlot.Intersection?this.busySlot.intersectingResourceId:this.busySlot.resourceId;return this.$store.getters[`${Bt.Model.Resources}/getById`](t)},popupId(){return`booking-booking-busy-popup-${this.busySlot.resourceId}`},config(){const t=200;const e=ft.Popup.getOption("angleMinBottom");const o=t/2-e;return{bindElement:this.mousePosition,width:t,background:"#2878ca",offsetTop:-5,offsetLeft:-o+e,bindOptions:{forceBindPosition:true,position:"top"},angle:{offset:o,position:"bottom"},angleBorderRadius:"4px 0",autoHide:false}},textFormatted(){const t=at.DateTimeFormat.getFormat("SHORT_TIME_FORMAT");const e=this.getPopupMessageId(this.busySlot.type);return this.loc(e,{"#RESOURCE#":this.resource.name,"#TIME_FROM#":at.DateTimeFormat.format(t,(this.busySlot.fromTs+this.offset)/1e3),"#TIME_TO#":at.DateTimeFormat.format(t,(this.busySlot.toTs+this.offset)/1e3)})}},watch:{mousePosition:{handler(){this.adjustPosition()},deep:true}},methods:{getPopupMessageId(t){if(t===Bt.BusySlot.Intersection){return"BOOKING_BOOKING_INTERSECTING_RESOURCE_IS_BUSY"}if(t===Bt.BusySlot.IntersectionOverbooking){return"BOOKING_BOOKING_INTERSECTING_RESOURCE_IS_FULL_BUSY"}return"BOOKING_BOOKING_RESOURCE_IS_BUSY"},adjustPosition(){var t;const e=(t=this.$refs.popup)==null?void 0:t.getPopupInstance();if(!e){return}e.setBindElement(this.mousePosition);e.adjustPosition()},closePopup(){this.$emit("close")}},template:`\n\t\t<Popup\n\t\t\tv-if="mousePosition.left !== 0 && mousePosition.top !== 0"\n\t\t\t:id="popupId"\n\t\t\t:config="config"\n\t\t\tref="popup"\n\t\t\t@close="closePopup"\n\t\t>\n\t\t\t<div class="booking-booking-busy-popup">\n\t\t\t\t{{ textFormatted }}\n\t\t\t</div>\n\t\t</Popup>\n\t`};const{mapGetters:_e}=mt.createNamespacedHelpers(Bt.Model.Interface);const{mapGetters:Ne}=mt.createNamespacedHelpers(Bt.Model.Filter);const Ae="booking-booking-busy-slot";const He={name:"BusySlot",components:{BusyPopup:Re},props:{busySlot:{type:Object,required:true}},setup(){return{BookingBusySlotClassName:Ae,BusySlotType:Bt.BusySlot}},data(){return{isPopupShown:false}},computed:{..._e({disabledBusySlots:"disabledBusySlots",isEditingBookingMode:"isEditingBookingMode",isDragMode:"isDragMode"}),...Ne({isFilterMode:"isFilterMode"}),isDisabled(){const t=this.isDragMode&&this.busySlot.type===Bt.BusySlot.OffHours;const e=this.isDragMode&&this.busySlot.type===Bt.BusySlot.IntersectionOverbooking;if(this.isFilterMode||t||e){return true}return this.busySlot.id in this.disabledBusySlots},left(){return M.grid.calculateLeft(this.busySlot.resourceId)},top(){return M.grid.calculateTop(this.busySlot.fromTs)},height(){return M.grid.calculateHeight(this.busySlot.fromTs,this.busySlot.toTs)}},methods:{onClick(){if(this.isFilterMode||this.isEditingBookingMode||this.busySlot.type===Bt.BusySlot.IntersectionOverbooking){return}void this.$store.dispatch(`${Bt.Model.Interface}/addDisabledBusySlot`,this.busySlot)},onMouseEnter(){clearTimeout(this.showTimeout);this.showTimeout=setTimeout((()=>this.showPopup()),300);ht.Event.unbind(document,"mousemove",this.onMouseMove);ht.Event.bind(document,"mousemove",this.onMouseMove)},onMouseMove(t){if(this.cursorInsideContainer(t.target)){this.updatePopup(t)}else{ht.Event.unbind(document,"mousemove",this.onMouseMove);this.closePopup()}},onMouseLeave(t){var e,o;if((e=t.relatedTarget)!=null&&(o=e.closest(".popup-window"))!=null&&o.querySelector(".booking-booking-busy-popup")){return}ht.Event.unbind(document,"mousemove",this.onMouseMove);this.closePopup()},cursorInsideContainer(t){return!ht.Type.isNull(t)&&ht.Dom.hasClass(t,this.BookingBusySlotClassName)},updatePopup(t){var e,o;const i=(e=this.$refs.container)==null?void 0:e.getBoundingClientRect();if(this.isDragMode||!i||t.clientY>i.top+i.height||t.clientY<i.top||t.clientX<i.left||t.clientX>i.left+i.width){this.closePopup();return}(o=this.showTimeout)!=null?o:this.showTimeout=setTimeout((()=>this.showPopup()),300)},showPopup(){this.isPopupShown=true},closePopup(){clearTimeout(this.showTimeout);this.showTimeout=null;this.isPopupShown=false}},template:`\n\t\t<div\n\t\t\tv-if="left >= 0"\n\t\t\t:class="[BookingBusySlotClassName, {\n\t\t\t\t'--disabled': isDisabled,\n\t\t\t}]"\n\t\t\t:style="{\n\t\t\t\t'--left': left + 'px',\n\t\t\t\t'--top': top + 'px',\n\t\t\t\t'--height': height + 'px',\n\t\t\t\t'z-index': busySlot.type === BusySlotType.IntersectionOverbooking ? 1 : 'unset',\n\t\t\t}"\n\t\t\tdata-element="booking-busy-slot"\n\t\t\t:data-id="busySlot.resourceId"\n\t\t\t:data-from="busySlot.fromTs"\n\t\t\t:data-to="busySlot.toTs"\n\t\t\tref="container"\n\t\t\t@click.stop="onClick"\n\t\t\t@mouseenter.stop="onMouseEnter"\n\t\t\t@mouseleave.stop="onMouseLeave"\n\t\t></div>\n\t\t<BusyPopup\n\t\t\tv-if="isPopupShown"\n\t\t\t:busySlot="busySlot"\n\t\t\t@close="closePopup"\n\t\t/>\n\t`};const ze={props:{cell:{type:Object,required:true},className:{type:[String,Object],default:""}},components:{Icon:Z.BIcon},data(){return{IconSet:Z.Set}},computed:{...mt.mapGetters({selectedCells:`${Bt.Model.Interface}/selectedCells`,zoom:`${Bt.Model.Interface}/zoom`,intersections:`${Bt.Model.Interface}/intersections`,timezone:`${Bt.Model.Interface}/timezone`,offset:`${Bt.Model.Interface}/offset`,isFeatureEnabled:`${Bt.Model.Interface}/isFeatureEnabled`,draggedDataTransfer:`${Bt.Model.Interface}/draggedDataTransfer`,embedItems:`${Bt.Model.Interface}/embedItems`}),selected(){return this.cell.id in this.selectedCells},hasSelectedCells(){return Object.keys(this.selectedCells).length>0},timeFormatted(){const t=at.DateTimeFormat.getFormat("SHORT_TIME_FORMAT");return this.loc("BOOKING_BOOKING_TIME_RANGE",{"#FROM#":at.DateTimeFormat.format(t,(this.cell.fromTs+this.offset)/1e3),"#TO#":at.DateTimeFormat.format(t,(this.cell.toTs+this.offset)/1e3)})},height(){return M.grid.calculateRealHeight(this.cell.fromTs,this.cell.toTs)},externalData(){return this.embedItems},clients(){const t=this.embedItems.filter((t=>t.entityTypeId==="CONTACT"||t.entityTypeId==="COMPANY"));return t.map((t=>({id:t.value,type:{code:t.entityTypeId,module:t.moduleId}})))}},methods:{onCellSelected({target:{checked:t}}){if(!this.isFeatureEnabled){it.limit.show();return}if(t){this.$store.dispatch(`${Bt.Model.Interface}/addSelectedCell`,this.cell)}else{this.$store.dispatch(`${Bt.Model.Interface}/removeSelectedCell`,this.cell)}},onMouseDown(){var t,e;if(!this.isFeatureEnabled){void it.limit.show();return}void this.$store.dispatch(`${Bt.Model.Interface}/setHoveredCell`,null);this.creatingBookingId=`tmp-id-${Date.now()}-${Math.random()}`;void this.$store.dispatch(`${Bt.Model.Filter}/addQuickFilterIgnoredBookingId`,this.creatingBookingId);void this.$store.dispatch(`${Bt.Model.Bookings}/add`,{id:this.creatingBookingId,dateFromTs:this.cell.fromTs,dateToTs:this.cell.toTs,resourcesIds:[...new Set([this.cell.resourceId,...(t=this.intersections[0])!=null?t:[],...(e=this.intersections[this.cell.resourceId])!=null?e:[]])],timezoneFrom:this.timezone,timezoneTo:this.timezone,externalData:this.externalData,clients:this.clients});ht.Event.bind(window,"mouseup",this.addBooking)},addBooking(){ht.Event.unbind(window,"mouseup",this.addBooking);if(!this.isFeatureEnabled){void it.limit.show();return}setTimeout((async()=>{const t=this.$store.getters[`${Bt.Model.Bookings}/getById`](this.creatingBookingId);const e=await st.bookingService.add(t);if(e.success&&e.booking){const t=this.$store.getters[`${Bt.Model.Bookings}/overbookingMap`];ct.BookingAnalytics.sendAddBooking({isOverbooking:Boolean(t==null?void 0:t.has==null?void 0:t.has(e.booking.id))})}}))}},template:`\n\t\t<div\n\t\t\tclass="booking-booking-base-cell"\n\t\t\t:class="[className, {\n\t\t\t\t'--selected': selected,\n\t\t\t\t'--bounded-to-bottom': cell.boundedToBottom,\n\t\t\t\t'--height-is-less-than-40': height < 40,\n\t\t\t\t'--compact-mode': height < 40 || zoom < 0.8,\n\t\t\t\t'--small': height <= 12.5,\n\t\t\t}]"\n\t\t\t:style="{\n\t\t\t\t'--height': height + 'px',\n\t\t\t}"\n\t\t\tdata-element="booking-base-cell"\n\t\t\t:data-resource-id="cell.resourceId"\n\t\t\t:data-from="cell.fromTs"\n\t\t\t:data-to="cell.toTs"\n\t\t\t:data-selected="selected"\n\t\t>\n\t\t\t<div class="booking-booking-grid-cell-padding">\n\t\t\t\t<div class="booking-booking-grid-cell-inner">\n\t\t\t\t\t<label\n\t\t\t\t\t\tclass="booking-booking-grid-cell-time"\n\t\t\t\t\t\tdata-element="booking-grid-cell-select-label"\n\t\t\t\t\t>\n\t\t\t\t\t\t<span class="booking-booking-grid-cell-time-inner">\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\tv-if="!draggedDataTransfer.id"\n\t\t\t\t\t\t\t\tclass="booking-booking-grid-cell-checkbox"\n\t\t\t\t\t\t\t\ttype="checkbox"\n\t\t\t\t\t\t\t\t:checked="selected"\n\t\t\t\t\t\t\t\t@change="onCellSelected"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<span data-element="booking-grid-cell-time">\n\t\t\t\t\t\t\t\t{{ timeFormatted }}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</label>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="!hasSelectedCells && !draggedDataTransfer.id"\n\t\t\t\t\t\tclass="booking-booking-grid-cell-select-button-container"\n\t\t\t\t\t\tref="button"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tclass="booking-booking-grid-cell-select-button"\n\t\t\t\t\t\t\t:class="{'--lock': !isFeatureEnabled}"\n\t\t\t\t\t\t\tdata-element="booking-grid-cell-add-button"\n\t\t\t\t\t\t\t@mousedown="onMouseDown"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div class="booking-booking-grid-cell-select-button-text">\n\t\t\t\t\t\t\t\t{{ loc('BOOKING_BOOKING_SELECT') }}\n\t\t\t\t\t\t\t\t<Icon v-if="!isFeatureEnabled" :name="IconSet.LOCK" />\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="ui-icon-set --chevron-right"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const Ge={name:"HoveredCell",components:{BaseCell:ze},props:{cell:{type:Object,required:true},draggedBooking:{type:Object,default:null}},data(){return{overbookingPositionsInCell:[]}},computed:{...mt.mapGetters({overbookingMap:`${Bt.Model.Bookings}/overbookingMap`}),left(){const t=M.grid.calculateLeft(this.cell.resourceId);const e=this.overbookingPositionsInCell;if(e.length>1){return-1}if(e.length===0||e[0]){return t}return t+M.grid.calculateWidth(this.width)},top(){return M.grid.calculateTop(this.cell.fromTs)},height(){const t=this.cell.fromTs;const e=this.draggedBooking?this.draggedBooking.dateToTs-this.draggedBooking.dateFromTs:Infinity;const o=e<this.cell.toTs-t?t+e:this.cell.toTs;return M.grid.calculateHeight(t,o)},width(){return this.overbookingPositionsInCell.length===0?280:280/2}},mounted(){this.calcOverbookingPositionsInCell()},methods:{calcOverbookingPositionsInCell(){const t=this.cell.resourceId;const e={dateFromTs:this.cell.fromTs,dateToTs:this.cell.toTs};const o=[];for(const[,i]of this.overbookingMap){const s=i.items.find((e=>e.resourceId===t));if(s&&y.checkBookingIntersection(i.booking,e)&&!o.includes(s==null?void 0:s.shifted)){o.push(s==null?void 0:s.shifted)}if(o.length>2){break}}this.overbookingPositionsInCell=o}},template:`\n\t\t<div\n\t\t\tv-if="left >= 0"\n\t\t\tclass="booking-booking-selected-cell"\n\t\t\t:style="{\n\t\t\t\t'--left': left + 'px',\n\t\t\t\t'--top': top + 'px',\n\t\t\t\t'--height': height + 'px',\n\t\t\t\t'--width': width + 'px',\n\t\t\t}"\n\t\t\t@mouseleave="$store.dispatch('interface/setHoveredCell', null)"\n\t\t>\n\t\t\t<BaseCell\n\t\t\t\t:cell="cell"\n\t\t\t\t:className="{ '--overbooking': overbookingPositionsInCell.length > 0 }"\n\t\t\t/>\n\t\t</div>\n\t`};const xe={props:{hour:{type:Number,required:true}},computed:{...mt.mapGetters({selectedDateTs:`${Bt.Model.Interface}/selectedDateTs`,resourcesIds:`${Bt.Model.Interface}/resourcesIds`}),top(){return M.grid.calculateTop(this.fromTs)},width(){return this.resourcesIds.length*280},fromTs(){return new Date(this.selectedDateTs).setHours(this.hour)}},template:`\n\t\t<div\n\t\t\tclass="booking-booking-quick-filter-line"\n\t\t\t:style="{\n\t\t\t\t'--top': top + 'px',\n\t\t\t\t'--width': width + 'px',\n\t\t\t}"\n\t\t></div>\n\t`};const Ke=15*60*1e3;function We({dateFromTs:t,dateToTs:e}){const o=e-t;return[t,o<Ke?t+Ke:e]}function Ue(t,e,o){var i;return{...e,resourcesIds:[t],uiSlot:We(e),overbooking:o==null?void 0:(i=o.items)==null?void 0:i.some((e=>e.resourceId===t&&e.shifted))}}function qe(t){const e=new Map;for(const i of t){var o;const t=((o=i.resourcesIds)==null?void 0:o[0])||0;let s=[];if(e.has(t)){s=e.get(t)||[]}s.push(i);e.set(t,s)}return e}function Xe(t){const e=[];if(t.length===0){return e}let o={slot:[0,0],bookingIds:[]};t.filter((t=>!t.overbooking)).map((t=>({id:t.id,uiSlot:t.uiSlot}))).sort(((t,e)=>t.uiSlot[0]-e.uiSlot[0])).forEach((t=>{if(o.bookingIds.length===0){o.slot=[t.uiSlot[0],t.uiSlot[1]]}else if(E.inInterval(t.uiSlot[0],o.slot)){o.slot[1]=t.uiSlot[1]}else{e.push(o);o={slot:[t.uiSlot[0],t.uiSlot[1]],bookingIds:[]}}o.bookingIds.push(t.id)}));e.push(o);return e}function Ve(t){const e=new Map;if(t instanceof Map){[...t.keys()].forEach((o=>{const i=Xe(t.get(o)||[]);e.set(o,i)}))}return e}const{mapGetters:je}=mt.createNamespacedHelpers(Bt.Model.Bookings);const{mapGetters:Ye}=mt.createNamespacedHelpers(Bt.Model.Interface);const{mapGetters:Ze}=mt.createNamespacedHelpers(Bt.Model.Filter);const Qe={name:"Bookings",data(){return{nowTs:Date.now()}},computed:{...je({overbookingMap:"overbookingMap"}),...Ye({resourcesIds:"resourcesIds",selectedDateTs:"selectedDateTs",selectedCells:"selectedCells",hoveredCell:"hoveredCell",busySlots:"busySlots",isFeatureEnabled:"isFeatureEnabled",editingBookingId:"editingBookingId",embedItems:"embedItems",draggedBookingId:"draggedBookingId"}),...Ze({filteredBookingsIds:"filteredBookingsIds",isFilterMode:"isFilterMode",quickFilter:"quickFilter"}),resourcesHash(){const t=this.$store.getters[`${Bt.Model.Resources}/getByIds`](this.resourcesIds).map((({id:t,slotRanges:e})=>({id:t,slotRanges:e})));return JSON.stringify(t)},bookingsHash(){const t=this.bookings.map((({id:t,dateFromTs:e,dateToTs:o})=>({id:t,dateFromTs:e,dateToTs:o})));return JSON.stringify(t)},bookings(){const t=this.selectedDateTs;let e=[];if(this.isFilterMode){e=this.$store.getters[`${Bt.Model.Bookings}/getByDateAndIds`](t,this.filteredBookingsIds)}else{e=this.$store.getters[`${Bt.Model.Bookings}/getByDateAndResources`](t,this.resourcesIds)}return e.flatMap((t=>t.resourcesIds.filter((t=>this.resourcesIds.includes(t))).map((e=>Ue(e,t,this.overbookingMap.get(t.id)))))).sort(((t,e)=>{if(t.resourcesIds[0]!==e.resourcesIds[0]){return e.resourcesIds[0]-t.resourcesIds[0]}if(t.dateFromTs!==e.dateFromTs){return t.dateFromTs-e.dateFromTs}return e.overbooking-t.overbooking}))},cells(){const t=[...Object.values(this.selectedCells),this.hoveredCell];const e=this.selectedDateTs;const o=new Date(e).setDate(new Date(e).getDate()+1);return t.filter((t=>t&&t.toTs>e&&o>t.fromTs))},quickFilterHours(){const t=new Set(Object.values(this.quickFilter.active));return Object.values(this.quickFilter.hovered).filter((e=>!t.has(e)))},resourceBookings(){return qe(this.bookings)},resourceBookingsUiGroupsMap(){return Ve(this.resourceBookings)},embedEditingMode(){var t,e;return this.isFeatureEnabled&&(this.editingBookingId>0||((t=(e=this.embedItems)==null?void 0:e.length)!=null?t:0)>0)},draggedBooking(){if(!this.draggedBookingId){return null}return this.bookings.find((({id:t})=>t===this.draggedBookingId))||null}},mounted(){this.startInterval()},methods:{generateBookingKey(t){return`${t.id}-${t.resourcesIds[0]}`},getBookingUiGroupsByResourceId(t){return this.resourceBookingsUiGroupsMap.get(t)||[]},startInterval(){setInterval((()=>{this.nowTs=Date.now()}),5*1e3)}},watch:{selectedDateTs(){void et.busySlots.loadBusySlots()},bookingsHash(){void et.busySlots.loadBusySlots()},resourcesHash(){void et.busySlots.loadBusySlots()},overbookingMap(){void et.busySlots.loadBusySlots()}},components:{Booking:$e,BusySlot:He,Cell:Ge,QuickFilterLine:xe},template:`\n\t\t<div\n\t\t\tclass="booking-booking-bookings"\n\t\t\t:class="{\n\t\t\t\t'embed-editing-mode': embedEditingMode,\n\t\t\t}"\n\t\t>\n\t\t\t<TransitionGroup name="booking-transition-booking">\n\t\t\t\t<template v-for="booking of bookings" :key="generateBookingKey(booking)">\n\t\t\t\t\t<Booking\n\t\t\t\t\t\t:bookingId="booking.id"\n\t\t\t\t\t\t:resourceId="booking.resourcesIds[0]"\n\t\t\t\t\t\t:nowTs\n\t\t\t\t\t\t:bookingUiGroups="getBookingUiGroupsByResourceId(booking.resourcesIds[0])"\n\t\t\t\t\t/>\n\t\t\t\t</template>\n\t\t\t</TransitionGroup>\n\t\t\t<template v-for="busySlot of busySlots" :key="busySlot.id">\n\t\t\t\t<BusySlot\n\t\t\t\t\t:busySlot="busySlot"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t\t<template v-for="cell of cells" :key="cell.id">\n\t\t\t\t<Cell\n\t\t\t\t\t:cell="cell"\n\t\t\t\t\t:draggedBooking="draggedBooking"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t\t<template v-for="hour of quickFilterHours" :key="hour">\n\t\t\t\t<QuickFilterLine\n\t\t\t\t\t:hour="hour"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t</div>\n\t`};const Je=30*60*1e3;const to={name:"Cell",props:{cell:{type:Object,required:true}},data(){return{halfOffset:0}},computed:{...mt.mapGetters({overbookingMap:`${Bt.Model.Bookings}/overbookingMap`,isFilterMode:`${Bt.Model.Filter}/isFilterMode`,isEditingBookingMode:`${Bt.Model.Interface}/isEditingBookingMode`,draggedBookingId:`${Bt.Model.Interface}/draggedBookingId`,draggedDataTransfer:`${Bt.Model.Interface}/draggedDataTransfer`,resizedBookingId:`${Bt.Model.Interface}/resizedBookingId`,quickFilter:`${Bt.Model.Filter}/quickFilter`}),draggedElementId(){return this.draggedDataTransfer.id},isAvailable(){if(this.isFilterMode||this.resizedBookingId||this.isEditingBookingMode&&!this.draggedDataTransfer.id){return false}const{fromTs:t,toTs:e}=this.freeSpace;const o=this.cell.fromTs;const i=this.cell.fromTs+Je;return(e>o||e>i)&&e-t>=this.duration},fromTs(){return Math.min(this.freeSpace.toTs-this.duration,this.cell.fromTs)+this.halfOffset},toTs(){return this.fromTs+this.duration},duration(){if(this.draggedBooking){return this.draggedBooking.dateToTs-this.draggedBooking.dateFromTs}return this.cell.toTs-this.cell.fromTs},draggedBooking(){var t;return(t=this.$store.getters[`${Bt.Model.Bookings}/getById`](this.draggedBookingId))!=null?t:null},freeSpace(){let t=0;let e=Infinity;for(const{fromTs:o,toTs:i}of this.colliding){if(this.cell.fromTs+Je>o&&this.cell.fromTs+Je<i){t=i;e=o;break}if(i<=this.cell.fromTs+Je){t=Math.max(t,i)}if(o>=this.cell.fromTs+Je){e=Math.min(e,o)}}return{fromTs:t,toTs:e}},colliding(){return this.$store.getters[`${Bt.Model.Interface}/getColliding`](this.cell.resourceId,this.excludeBookingColliding)},quickFilterHovered(){return this.cell.minutes/60 in this.quickFilter.hovered},quickFilterActive(){return this.cell.minutes/60 in this.quickFilter.active}},methods:{excludeBookingColliding(t){if(t.id===this.draggedBookingId){return true}const e=this.cell.resourceId;const o=this.overbookingMap.get(t.id);return o&&o.items.some((t=>t.resourceId===e))},mouseEnterHandler(t){this.updateHalfHour(t)},mouseLeaveHandler(t){var e,o;const i=(e=t.relatedTarget)==null?void 0:e.closest(".booking-booking-base-cell");if(!i||(i==null?void 0:(o=i.dataset)==null?void 0:o.selected)==="true"){void this.$store.dispatch(`${Bt.Model.Interface}/setHoveredCell`,null)}},mouseMoveHandler(t){this.updateHalfHour(t)},updateHalfHour(t){var e;if((e=this.$refs.button)!=null&&e.contains(t.target)){return}this.halfOffset=0;const o=t.clientY-window.scrollY;const i=this.$el.getBoundingClientRect();const s=o>(i.top+i.top+i.height)/2;const n=this.fromTs>=this.freeSpace.fromTs;const r=this.toTs+Je<=this.freeSpace.toTs;if(s&&r||!s&&!n){this.halfOffset=Je}if((!s&&!n||s&&!r)&&this.freeSpace.fromTs-this.cell.fromTs>0){this.halfOffset=this.freeSpace.fromTs-this.cell.fromTs}else if(!s&&n||s&&!r){this.halfOffset=0}const a=s===(this.halfOffset===0);if(this.duration<=Je&&a){this.clearCell(t);return}this.hoverCell({id:`${this.cell.resourceId}-${this.fromTs}-${this.toTs}`,fromTs:this.fromTs,toTs:this.toTs,resourceId:this.cell.resourceId,boundedToBottom:this.toTs===this.freeSpace.toTs})},clearCell(t){var e,o;const i=(e=t.relatedTarget)==null?void 0:e.closest(".booking-booking-base-cell");if(!i||(i==null?void 0:(o=i.dataset)==null?void 0:o.selected)==="true"){void this.$store.dispatch(`${Bt.Model.Interface}/setHoveredCell`,null)}},hoverCell(t){void this.$store.dispatch(`${Bt.Model.Interface}/setHoveredCell`,null);if(this.isAvailable){void this.$store.dispatch(`${Bt.Model.Interface}/setHoveredCell`,t)}}},watch:{draggedElementId(){if(!this.draggedElementId){void this.$store.dispatch(`${Bt.Model.Interface}/setHoveredCell`,null)}}},template:`\n\t\t<div\n\t\t\tclass="booking-booking-grid-cell"\n\t\t\t:class="{\n\t\t\t\t'--quick-filter-hovered': quickFilterHovered,\n\t\t\t\t'--quick-filter-active': quickFilterActive,\n\t\t\t}"\n\t\t\tdata-element="booking-grid-cell"\n\t\t\t:data-resource-id="cell.resourceId"\n\t\t\t:data-from="cell.fromTs"\n\t\t\t:data-to="cell.toTs"\n\t\t\t@mouseenter="mouseEnterHandler"\n\t\t\t@mouseleave="mouseLeaveHandler"\n\t\t\t@mousemove="mouseMoveHandler"\n\t\t></div>\n\t`};const eo={props:{bottom:{type:Boolean,default:false}},computed:mt.mapGetters({offHoursHover:`${Bt.Model.Interface}/offHoursHover`,offHoursExpanded:`${Bt.Model.Interface}/offHoursExpanded`}),methods:{animateOffHours({keepScroll:t}){if(this.offHoursExpanded){Ht.collapse()}else{Ht.expand({keepScroll:t})}void this.$store.dispatch(`${Bt.Model.Interface}/setOffHoursExpanded`,!this.offHoursExpanded)}},template:`\n\t\t<div class="booking-booking-grid-padding">\n\t\t\t<div\n\t\t\t\tclass="booking-booking-column-off-hours"\n\t\t\t\t:class="{'--bottom': bottom, '--hover': offHoursHover}"\n\t\t\t\t@click="animateOffHours({ keepScroll: bottom })"\n\t\t\t\t@mouseenter="$store.dispatch('interface/setOffHoursHover', true)"\n\t\t\t\t@mouseleave="$store.dispatch('interface/setOffHoursHover', false)"\n\t\t\t></div>\n\t\t</div>\n\t`};const{mapGetters:oo}=mt.createNamespacedHelpers(Bt.Model.Interface);const io={props:{resourceId:Number},data(){return{visible:true}},mounted(){this.updateVisibility();this.updateVisibilityDuringTransition()},computed:{...oo({resourcesIds:"resourcesIds",zoom:"zoom",scroll:"scroll",selectedDateTs:"selectedDateTs",offHoursHover:"offHoursHover",offHoursExpanded:"offHoursExpanded",fromHour:"fromHour",toHour:"toHour",offset:"offset"}),resource(){return this.$store.getters["resources/getById"](this.resourceId)},fromMinutes(){return this.fromHour*60},toMinutes(){return this.toHour*60},slotSize(){var t,e;return(t=(e=this.resource.slotRanges[0])==null?void 0:e.slotSize)!=null?t:60},offHoursTopCells(){return this.cells.filter((t=>t.minutes<this.fromMinutes))},workTimeCells(){return this.cells.filter((t=>t.minutes>=this.fromMinutes&&t.minutes<this.toMinutes))},offHoursBottomCells(){return this.cells.filter((t=>t.minutes>=this.toMinutes))},cells(){const t=3600*1e3;const e=this.selectedDateTs;const o=new Date(e).setDate(new Date(e).getDate()+1);return w.range(e,o-t,t).map((t=>{const e=t+this.slotSize*60*1e3;return{id:`${this.resource.id}-${t}-${e}`,fromTs:t,toTs:e,minutes:new Date(t+this.offset).getHours()*60,resourceId:this.resource.id}}))}},methods:{updateVisibilityDuringTransition(){var t;(t=this.animation)==null?void 0:t.stop();this.animation=new BX.easing({duration:200,start:{},finish:{},step:this.updateVisibility});this.animation.animate()},updateVisibility(){const t=this.$el.getBoundingClientRect();this.visible=t.right>0&&t.left<window.innerWidth}},watch:{scroll(){this.updateVisibility()},zoom(){this.updateVisibility()},resourcesIds(){this.updateVisibilityDuringTransition()}},components:{Cell:to,OffHours:eo},template:`\n\t\t<div\n\t\t\tclass="booking-booking-grid-column"\n\t\t\tdata-element="booking-grid-column"\n\t\t\t:data-id="resourceId"\n\t\t>\n\t\t\t<template v-if="visible">\n\t\t\t\t<OffHours/>\n\t\t\t\t<div class="booking-booking-grid-off-hours-cells">\n\t\t\t\t\t<Cell v-for="cell of offHoursTopCells" :key="cell.id" :cell="cell"/>\n\t\t\t\t</div>\n\t\t\t\t<Cell v-for="cell of workTimeCells" :key="cell.id" :cell="cell"/>\n\t\t\t\t<div class="booking-booking-grid-off-hours-cells --bottom">\n\t\t\t\t\t<Cell v-for="cell of offHoursBottomCells" :key="cell.id" :cell="cell"/>\n\t\t\t\t</div>\n\t\t\t\t<OffHours :bottom="true"/>\n\t\t\t</template>\n\t\t</div>\n\t`};let so=t=>t,no;const ro=ht.Extension.getSettings("booking.booking").isAirTemplate;const ao=200;const lo="ui-counter-panel__scope";const co="bitrix24-dark-theme --ui-context-content-light";var uo=babelHelpers.classPrivateFieldLooseKey("slider");var mo=babelHelpers.classPrivateFieldLooseKey("overlay");var ho=babelHelpers.classPrivateFieldLooseKey("handleSliderClose");var po=babelHelpers.classPrivateFieldLooseKey("renderOverlay");var go=babelHelpers.classPrivateFieldLooseKey("isExpanded");var bo=babelHelpers.classPrivateFieldLooseKey("getInset");var fo=babelHelpers.classPrivateFieldLooseKey("animate");var Io=babelHelpers.classPrivateFieldLooseKey("applyMaximizedStyles");var ko=babelHelpers.classPrivateFieldLooseKey("applyMinimizedStyles");var vo=babelHelpers.classPrivateFieldLooseKey("appContainer");var Bo=babelHelpers.classPrivateFieldLooseKey("appHeader");var To=babelHelpers.classPrivateFieldLooseKey("counterPanel");var yo=babelHelpers.classPrivateFieldLooseKey("appContent");var Mo=babelHelpers.classPrivateFieldLooseKey("contentPaddingElement");var Eo=babelHelpers.classPrivateFieldLooseKey("imBarWidth");class wo{constructor({onOverlayClick:t}){Object.defineProperty(this,Eo,{get:Ao,set:void 0});Object.defineProperty(this,Mo,{get:No,set:void 0});Object.defineProperty(this,yo,{get:_o,set:void 0});Object.defineProperty(this,To,{get:Ro,set:void 0});Object.defineProperty(this,Bo,{get:$o,set:void 0});Object.defineProperty(this,vo,{get:Po,set:void 0});Object.defineProperty(this,ko,{value:Do});Object.defineProperty(this,Io,{value:Fo});Object.defineProperty(this,fo,{value:Oo});Object.defineProperty(this,bo,{value:Lo});Object.defineProperty(this,go,{get:So,set:void 0});Object.defineProperty(this,po,{value:Co});Object.defineProperty(this,uo,{writable:true,value:void 0});Object.defineProperty(this,mo,{writable:true,value:void 0});Object.defineProperty(this,ho,{writable:true,value:()=>{if(babelHelpers.classPrivateFieldLooseBase(this,go)[go]){babelHelpers.classPrivateFieldLooseBase(this,uo)[uo].applyHacks();BX.SidePanel.Instance.disablePageScrollbar()}}});this.onOverlayClick=t;babelHelpers.classPrivateFieldLooseBase(this,uo)[uo]=new(BX.SidePanel.Manager.getSliderClass())("");babelHelpers.classPrivateFieldLooseBase(this,mo)[mo]=babelHelpers.classPrivateFieldLooseBase(this,po)[po]();if(top.BX){top.BX.Event.EventEmitter.subscribe("SidePanel.Slider:onCloseComplete",babelHelpers.classPrivateFieldLooseBase(this,ho)[ho]);top.BX.Event.EventEmitter.subscribe("SidePanel.Slider:onDestroy",babelHelpers.classPrivateFieldLooseBase(this,ho)[ho])}}async maximize(){await C.Core.getStore().dispatch(`${Bt.Model.Interface}/setExpanded`,true);babelHelpers.classPrivateFieldLooseBase(this,uo)[uo].applyHacks();BX.SidePanel.Instance.disablePageScrollbar();const t=babelHelpers.classPrivateFieldLooseBase(this,bo)[bo](babelHelpers.classPrivateFieldLooseBase(this,vo)[vo]);ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,vo)[vo],"position","fixed");ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,vo)[vo],"inset","0 0 0 0");const e=babelHelpers.classPrivateFieldLooseBase(this,bo)[bo](babelHelpers.classPrivateFieldLooseBase(this,vo)[vo]);babelHelpers.classPrivateFieldLooseBase(this,Io)[Io]();ht.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,mo)[mo],"--closing");ht.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,mo)[mo],"--opening");ht.Dom.append(babelHelpers.classPrivateFieldLooseBase(this,mo)[mo],document.body);await babelHelpers.classPrivateFieldLooseBase(this,fo)[fo](t,e)}async minimize(){await C.Core.getStore().dispatch(`${Bt.Model.Interface}/setExpanded`,false);babelHelpers.classPrivateFieldLooseBase(this,uo)[uo].resetHacks();BX.SidePanel.Instance.enablePageScrollbar();const t=babelHelpers.classPrivateFieldLooseBase(this,bo)[bo](babelHelpers.classPrivateFieldLooseBase(this,vo)[vo]);ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,vo)[vo],"position",null);const e=babelHelpers.classPrivateFieldLooseBase(this,bo)[bo](babelHelpers.classPrivateFieldLooseBase(this,vo)[vo]);babelHelpers.classPrivateFieldLooseBase(this,ko)[ko]();ht.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,mo)[mo],"--opening");ht.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,mo)[mo],"--closing");ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,vo)[vo],"position","fixed");await babelHelpers.classPrivateFieldLooseBase(this,fo)[fo](t,e);ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,vo)[vo],"position",null);ht.Dom.remove(babelHelpers.classPrivateFieldLooseBase(this,mo)[mo])}}function Co(){return ht.Tag.render(no||(no=so`
			<div class="booking-booking-overlay" onclick="${0}"></div>
		`),this.onOverlayClick)}function So(){return C.Core.getStore().getters[`${Bt.Model.Interface}/expanded`]}function Lo(t){const e=t.getBoundingClientRect();return{left:e.left,top:e.top,right:window.innerWidth-(e.left+e.width),bottom:window.innerHeight-(e.top+e.height)}}function Oo(t,e){return new Promise((o=>new BX.easing({duration:ao,start:t,finish:e,step:({top:t,right:e,bottom:o,left:i})=>{ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,vo)[vo],"inset",`${t}px ${e}px ${o}px ${i}px`)},complete:o}).animate()))}function Fo(){ht.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,To)[To],lo);ht.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,vo)[vo],co);ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,vo)[vo],"height","initial");ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,vo)[vo],"position","fixed");ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,vo)[vo],"clip-path",`inset(0 ${babelHelpers.classPrivateFieldLooseBase(this,Eo)[Eo]}px 0 0)`);ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,vo)[vo],"background","var(--ui-color-palette-white-base)");if(ro){ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,Bo)[Bo],"padding-left","12px");ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,Bo)[Bo],"padding-right","12px")}ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,Bo)[Bo],"border-bottom","1px solid var(--ui-color-base-10)");ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,Bo)[Bo],"max-width","100%");ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,Bo)[Bo].parentElement,"padding-right",`${babelHelpers.classPrivateFieldLooseBase(this,Eo)[Eo]}px`);ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,yo)[yo],"margin",0);ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,yo)[yo],"border-radius",0);if(ro){ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,Mo)[Mo],"padding",0)}else{ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,Mo)[Mo],"padding-bottom",0);ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,Mo)[Mo],"padding-right",`${babelHelpers.classPrivateFieldLooseBase(this,Eo)[Eo]}px`)}ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,mo)[mo],"--right",`${babelHelpers.classPrivateFieldLooseBase(this,Eo)[Eo]}px`);BX.ZIndexManager.register(babelHelpers.classPrivateFieldLooseBase(this,vo)[vo],{overlay:babelHelpers.classPrivateFieldLooseBase(this,mo)[mo]})}function Do(){ht.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,To)[To],lo);ht.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,vo)[vo],co);ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,vo)[vo],"position",null);ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,vo)[vo],"clip-path",null);ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,vo)[vo],"background",null);ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,Bo)[Bo],"border-bottom",null);ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,Bo)[Bo],"max-width",null);ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,Bo)[Bo].parentElement,"padding-right",null);ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,yo)[yo],"margin",null);ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,yo)[yo],"border-radius",null);if(ro){ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,Mo)[Mo],"padding",null)}else{ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,Mo)[Mo],"padding-bottom",null);ht.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,Mo)[Mo],"padding-right",null)}BX.ZIndexManager.unregister(babelHelpers.classPrivateFieldLooseBase(this,vo)[vo])}function Po(){if(ro){return document.querySelector(".app__page")}return BX("content-table")}function $o(){if(ro){return document.querySelector(".page__toolbar")}return document.querySelector(".page-header")}function Ro(){return C.Core.getParams().counterPanelContainer.firstElementChild}function _o(){if(ro){return BX("air-workarea-content")}return BX("workarea-content")}function No(){var t;if(ro){return document.querySelector(".app__page")}return(t=BX("workarea"))==null?void 0:t.parentElement}function Ao(){if(ro){return 0}const t=ro?BX("right-bar"):BX("bx-im-bar");return window.innerWidth-t.getBoundingClientRect().left}const Ho={props:{getColumnsContainer:Function},data(){return{isSlider:C.Core.getParams().isSlider,maximize:new wo({onOverlayClick:()=>this.collapse()}),desiredZoom:this.$store.getters["interface/zoom"],minZoom:.5,maxZoom:1}},mounted(){if(location.hash==="#maximize"){void this.maximize.maximize()}},computed:{...mt.mapGetters({zoom:"interface/zoom",expanded:"interface/expanded"}),zoomFormatted(){return this.loc("BOOKING_BOOKING_ZOOM_PERCENT",{"#PERCENT#":Math.round(this.zoom*100)})}},methods:{expand(t){if(location.hash==="#maximize"||this.isAnyModifierKeyPressed(t)){void this.maximize.maximize()}else{window.open(`${location.href}#maximize`,"_blank").focus()}},isAnyModifierKeyPressed(t){return t.altKey||t.shiftKey||t.ctrlKey||t.metaKey},collapse(){void this.maximize.minimize()},fitToScreen(){const t=260;const e=this.getColumnsContainer();const o=(e.offsetWidth-t)/(e.scrollWidth-t);const i=Math.floor(this.zoom*o*10)/10;this.zoomInto(i)},zoomInto(t){var e;if(Number.isNaN(t)){return}const o="--booking-booking-no-transition";const i=C.Core.getParams().container;const s=400;this.desiredZoom=Math.max(this.minZoom,Math.min(this.maxZoom,t));if(this.zoom===this.desiredZoom){return}(e=this.animation)==null?void 0:e.stop();ht.Dom.addClass(i,o);this.animation=new BX.easing({duration:Math.abs(this.zoom-this.desiredZoom)/this.minZoom*s,start:{zoom:this.zoom*100},finish:{zoom:this.desiredZoom*100},step:({zoom:t})=>this.$store.dispatch("interface/setZoom",t/100),complete:()=>ht.Dom.removeClass(i,o)});this.animation.animate()},async onMouseDown(t){ht.Event.unbind(window,"mouseup",this.onMouseUp);ht.Event.bind(window,"mouseup",this.onMouseUp);this.mouseDown=true;await new Promise((t=>setTimeout(t,50)));if(this.mouseDown){clearInterval(this.zoomInterval);this.zoomInterval=setInterval((()=>this.zoomInto(this.desiredZoom+t*.1)),40)}},onMouseUp(){this.mouseDown=false;if(this.desiredZoom>this.zoom){this.desiredZoom=Math.ceil(this.zoom*10)/10}if(this.desiredZoom<this.zoom){this.desiredZoom=Math.floor(this.zoom*10)/10}this.zoomInto(this.desiredZoom);clearInterval(this.zoomInterval);ht.Event.unbind(window,"mouseup",this.onMouseUp)},async showAhaMoment(){bt.ahaMoments.setPopupShown(Bt.AhaMoment.ExpandGrid);await bt.ahaMoments.show({id:"booking-expand-grid",title:this.loc("BOOKING_AHA_EXPAND_GRID_TITLE_MSGVER_1"),text:this.loc("BOOKING_AHA_EXPAND_GRID_TEXT_MSGVER_1"),target:this.$refs.expand,top:true});bt.ahaMoments.setShown(Bt.AhaMoment.ExpandGrid)}},template:`\n\t\t<div class="booking-booking-grid-scale-panel">\n\t\t\t<div v-if="!isSlider" class="booking-booking-grid-scale-panel-full-screen" ref="expand">\n\t\t\t\t<div v-if="expanded" class="ui-icon-set --collapse-diagonal" @click="collapse"></div>\n\t\t\t\t<div v-else class="ui-icon-set --expand-diagonal" @click="expand"></div>\n\t\t\t</div>\n\t\t\t<div class="booking-booking-grid-scale-panel-fit-to-screen">\n\t\t\t\t<div class="booking-booking-grid-scale-panel-fit-to-screen-text" @click="fitToScreen">\n\t\t\t\t\t{{ loc('BOOKING_BOOKING_SHOW_ALL') }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="booking-booking-grid-scale-panel-change">\n\t\t\t\t<div\n\t\t\t\t\tclass="ui-icon-set --minus-30"\n\t\t\t\t\t:class="{'--disabled': zoom <= minZoom}"\n\t\t\t\t\t@click="zoomInto(desiredZoom - 0.1)"\n\t\t\t\t\t@mousedown="onMouseDown(-1)"\n\t\t\t\t></div>\n\t\t\t\t<div v-html="zoomFormatted" class="booking-booking-grid-scale-panel-zoom"></div>\n\t\t\t\t<div\n\t\t\t\t\tclass="ui-icon-set --plus-30"\n\t\t\t\t\t:class="{'--disabled': zoom >= maxZoom}"\n\t\t\t\t\t@click="zoomInto(desiredZoom + 0.1)"\n\t\t\t\t\t@mousedown="onMouseDown(1)"\n\t\t\t\t></div>\n\t\t\t</div>\n\t\t</div>\n\t`};const{mapGetters:zo}=mt.createNamespacedHelpers(Bt.Model.Interface);const{mapGetters:Go}=mt.createNamespacedHelpers(Bt.Model.Filter);const xo={components:{Icon:Z.BIcon,CounterFloating:L.CounterFloating},props:{calendarClass:{type:[String,Object,Array],default:""}},data(){return{IconSet:Z.Set}},computed:{...mt.mapGetters({calendarExpanded:`${Bt.Model.Interface}/calendarExpanded`,datesCount:`${Bt.Model.Filter}/datesCount`}),...zo({freeMarks:"freeMarks",getCounterMarks:"getCounterMarks",offset:"offset"}),...Go({filteredMarks:"filteredMarks",isFilterMode:"isFilterMode",isDeletingResourceFilterMode:"isDeletingResourceFilterMode"}),selectedDateTs(){return this.$store.getters[`${Bt.Model.Interface}/selectedDateTs`]+this.offset},viewDateTs(){return this.$store.getters[`${Bt.Model.Interface}/viewDateTs`]+this.offset},counterMarks(){if(this.isFilterMode||this.isDeletingResourceFilterMode){return this.getCounterMarks(this.filteredMarks)}return this.getCounterMarks()},formattedDate(){const t=this.calendarExpanded?this.loc("BOOKING_MONTH_YEAR_FORMAT"):at.DateTimeFormat.getFormat("LONG_DATE_FORMAT");const e=this.calendarExpanded?this.viewDateTs/1e3:this.selectedDateTs/1e3;return at.DateTimeFormat.format(t,e)},isShowCounterFloating(){return(this.isDeletingResourceFilterMode||this.isFilterMode)&&this.datesCount.count>0}},watch:{selectedDateTs(t){this.datePicker.selectDate(S.createDate(t));this.updateMarks()},filteredMarks(){this.updateMarks()},freeMarks(){this.updateMarks()},counterMarks(){this.setCounterMarks()},isFilterMode(){this.updateMarks()}},created(){this.datePicker=new S.DatePicker({selectedDates:[this.selectedDateTs],inline:true,hideHeader:true});this.setViewDate();this.datePicker.subscribe(S.DatePickerEvent.SELECT,(t=>{const e=t.getData().date;const o=this.createDateFromUtc(e);void this.$store.dispatch(`${Bt.Model.Interface}/setSelectedDateTs`,o.getTime());this.setViewDate()}))},mounted(){this.datePicker.setTargetNode(this.$refs.datePicker);this.datePicker.show()},beforeUnmount(){this.datePicker.destroy()},methods:{onPreviousClick(){if(this.calendarExpanded){this.previousMonth()}else{this.previousDate()}},onNextClick(){if(this.calendarExpanded){this.nextMonth()}else{this.nextDate()}},previousDate(){const t=this.datePicker.getSelectedDate()||this.datePicker.getToday();this.datePicker.selectDate(S.getNextDate(t,"day",-1));this.setViewDate()},nextDate(){const t=this.datePicker.getSelectedDate()||this.datePicker.getToday();this.datePicker.selectDate(S.getNextDate(t,"day"));this.setViewDate()},previousMonth(){const t=this.datePicker.getViewDate();this.datePicker.setViewDate(S.getNextDate(t,"month",-1));this.setViewDate()},nextMonth(){const t=this.datePicker.getViewDate();this.datePicker.setViewDate(S.getNextDate(t,"month"));this.setViewDate()},setViewDate(){const t=this.createDateFromUtc(this.datePicker.getViewDate());const e=t.setDate(1);void this.$store.dispatch(`${Bt.Model.Interface}/setViewDateTs`,e)},createDateFromUtc(t){return new Date(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate())},updateMarks(){if(this.isFilterMode||this.isDeletingResourceFilterMode){this.setFilterMarks()}else{this.setFreeMarks()}this.setCounterMarks()},setFreeMarks(){const t="rgba(var(--ui-color-background-success-rgb), 0.7)";const e=this.prepareDates(this.freeMarks);this.datePicker.setDayColors([{matcher:e,bgColor:t}])},getFilterMarks(){if(!this.isDeletingResourceFilterMode){return this.filteredMarks}const t=new Date;const e=t.setHours(0,0,0,0);return this.filteredMarks.filter((t=>new Date(t).getTime()>=e))},setFilterMarks(){const t="rgba(var(--ui-color-primary-rgb), 0.20)";const e=this.prepareDates(this.getFilterMarks());this.datePicker.setDayColors([{matcher:e,bgColor:t}])},setCounterMarks(){const t=this.prepareDates(this.counterMarks);this.datePicker.setDayMarks([{matcher:t,bgColor:"red"}])},prepareDates(t){return t.map((t=>{const e=at.DateTimeFormat.parse(t,false,Bt.DateFormat.ServerParse);return this.prepareTimestamp(e.getTime())}))},prepareTimestamp(t){const e=at.DateTimeFormat.getFormat("FORMAT_DATE");return at.DateTimeFormat.format(e,t/1e3)},async collapseToggle(){await Promise.all([this.$store.dispatch(`${Bt.Model.Interface}/setCalendarExpanded`,!this.calendarExpanded),J.optionService.setBool(Bt.Option.CalendarExpanded,this.calendarExpanded)])}},template:`\n\t\t<div \n\t\t\tclass="booking-sidebar-calendar-container"\n\t\t\t:class="[calendarClass, {\n\t\t\t\t'--expanded': calendarExpanded,\n\t\t\t\t'--counter': isShowCounterFloating,\n\t\t\t}].flat(1)"\n\t\t>\n\t\t\t<div class="booking-booking-sidebar-calendar">\n\t\t\t\t<div class="booking-booking-sidebar-calendar-header">\n\t\t\t\t\t<div class="booking-sidebar-button" @click="onPreviousClick">\n\t\t\t\t\t\t<div class="ui-icon-set --chevron-left"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="booking-booking-sidebar-calendar-title">\n\t\t\t\t\t\t{{ formattedDate }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="booking-sidebar-button --right" @click="onNextClick">\n\t\t\t\t\t\t<div class="ui-icon-set --chevron-right"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="booking-sidebar-button" @click="collapseToggle">\n\t\t\t\t\t\t<Icon :name="calendarExpanded ? IconSet.COLLAPSE : IconSet.EXPAND_1"/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="booking-booking-sidebar-calendar-date-picker" ref="datePicker"></div>\n\t\t\t</div>\n\t\t\t<CounterFloating\n\t\t\t\tv-if="isShowCounterFloating"\n\t\t\t\t:count="datesCount.count"\n\t\t\t/>\n\t\t</div>\n\t`};const Ko={name:"WaitListLayout",props:{waitListItemsCount:{type:Number,default:0},waitListClass:{type:[String,Object,Array],default:""},showEmptyState:{type:Boolean,default:false},dragging:{type:Boolean,default:false},expanded:{type:Boolean,default:false}},emits:["mouseUp"],methods:{showHelpDesk(){if(!top.BX.Helper){return}const t=Bt.HelpDesk.WaitListDescription.anchorCode||null;const e={redirect:"detail",code:Bt.HelpDesk.WaitListDescription.code,...t!==null&&{anchor:t}};const o=Object.entries(e).map((([t,e])=>`${t}=${e}`)).join("&");top.BX.Helper.show(o)}},template:`\n\t\t<div\n\t\t\tclass="booking-wait-list"\n\t\t\t:class="waitListClass"\n\t\t\t@mouseup.capture="$emit('mouseUp', $event)"\n\t\t>\n\t\t\t<div class="booking-wait-list-header">\n\t\t\t\t<div class="booking-wait-list-title">{{ loc('BOOKING_BOOKING_WAIT_LIST') }}</div>\n\t\t\t\t<div v-if="waitListItemsCount > 0" class="booking--wait-list-title-count">{{ waitListItemsCount }}</div>\n\t\t\t\t<div class="booking-wait-list-buttons">\n\t\t\t\t\t<slot name="header" />\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tv-if="expanded"\n\t\t\t\tclass="booking--wait-list-content"\n\t\t\t>\n\t\t\t\t<div v-if="showEmptyState" class="booking-wait-list-empty">\n\t\t\t\t\t<div class="booking-wait-list-empty-icon"></div>\n\t\t\t\t\t<div class="booking-wait-list-empty-title">{{ loc('BOOKING_BOOKING_WAIT_LIST') }}</div>\n\t\t\t\t\t<div class="booking-wait-list-empty-subtitle">{{ loc('BOOKING_BOOKING_WAIT_LIST_DESCRIPTION') }}</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="booking-wait-list-empty-help"\n\t\t\t\t\t\t@click="showHelpDesk"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ loc('BOOKING_BOOKING_WAIT_LIST_HOW') }}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div v-if="dragging" class="booking-wait-list-drag-area">\n\t\t\t\t\t{{ loc('BOOKING_BOOKING_WAIT_LIST_DRAG_AREA') }}\n\t\t\t\t</div>\n\t\t\t\t<template v-else>\n\t\t\t\t\t<slot name="waitlist" />\n\t\t\t\t</template>\n\t\t\t</div>\n\t\t</div>\n\t`};const Wo=()=>{const t=async()=>new Promise((t=>{const e=F.MessageBox.create({message:ht.Loc.getMessage("BOOKING_BOOKING_WAIT_LIST_GROUP_CONFIRM_DELETE"),yesCaption:ht.Loc.getMessage("BOOKING_BOOKING_WAIT_LIST_GROUP_CONFIRM_DELETE_YES"),modal:true,buttons:F.MessageBoxButtons.YES_CANCEL,onYes:()=>{e.close();t(true)},onCancel:()=>{e.close();t(false)}});e.show()}));const e=async e=>{if(await t()){await N.waitListService.deleteList(e)}};return{deleteWaitListGroup:e}};const Uo={name:"WaitListGroupMenu",props:{waitListGroup:{type:Object,required:true}},setup(){const t=null;const{deleteWaitListGroup:e}=Wo();return{menuPopup:t,deleteWaitListGroup:e}},computed:{popupId(){return`wait-list-group-menu-${ht.Text.getRandom(4)}`}},unmounted(){if(this.menuPopup){this.destroy()}},methods:{openMenu(){var t,e;if((t=this.menuPopup)!=null&&(e=t.popupWindow)!=null&&e.isShown()){this.destroy();return}const o=this.$refs["menu-button"];this.menuPopup=ft.MenuManager.create(this.popupId,o,this.getMenuItems(),{className:"booking--wait-list--wait-list-group-menu-popup",closeByEsc:true,autoHide:true,offsetTop:-3,offsetLeft:o.offsetWidth-6,angle:true,cacheable:true,events:{onDestroy:()=>this.unbindScrollEvent()}});this.menuPopup.show();this.bindScrollEvent()},getMenuItems(){return[{html:`<span>${this.loc("BOOKING_BOOKING_WAIT_LIST_GROUP_DELETE")}</span>`,onclick:async()=>{this.destroy();await this.deleteWaitListGroup(this.waitListGroup.items.map((({id:t})=>t)))}}]},destroy(){ft.MenuManager.destroy(this.popupId);this.unbindScrollEvent()},bindScrollEvent(){ht.Event.bind(document,"scroll",this.adjustPosition,{capture:true})},unbindScrollEvent(){ht.Event.unbind(document,"scroll",this.adjustPosition,{capture:true})},adjustPosition(){var t,e;(t=this.menuPopup)==null?void 0:(e=t.popupWindow)==null?void 0:e.adjustPosition()}},template:`\n\t\t<button ref="menu-button" class="ui-icon-set --more" @click="openMenu"></button>\n\t`};const qo={name:"WaitListGroups",components:{Icon:Z.BIcon,WaitListGroupMenu:Uo},setup(){const t=null;return{dragManager:t,IconSet:Z.Set}},computed:{...mt.mapGetters({editingWaitListItemId:`${Bt.Model.Interface}/editingWaitListItemId`,isFeatureEnabled:`${Bt.Model.Interface}/isFeatureEnabled`,animationPause:`${Bt.Model.Interface}/animationPause`,waitListItems:`${Bt.Model.WaitList}/get`}),waitListGroups(){const t=[{title:this.loc("BOOKING_BOOKING_WAIT_LIST_ADDED_TODAY"),items:[]},{title:this.loc("BOOKING_BOOKING_WAIT_LIST_ADDED_THIS_WEEK"),items:[]},{title:this.loc("BOOKING_BOOKING_WAIT_LIST_ADDED_THIS_MONTH"),items:[]},{title:this.loc("BOOKING_BOOKING_WAIT_LIST_ADDED_OVER_MONTH"),items:[]}];const e=(new Date).setHours(0,0,0,0);const{d:o,w:i,m:s}=lt.Duration.getUnitDurations();[...this.waitListItems].sort(((t,e)=>e.createdAt-t.createdAt)).forEach((n=>{const r=e-new Date(n.createdAt).setHours(0,0,0,0);if(r<o){t[0].items.push(n)}else if(r<i){t[1].items.push(n)}else if(r<s){t[2].items.push(n)}else{t[3].items.push(n)}}));return t.filter((({items:t})=>t.length>0))}},template:`\n\t\t<div class="booking-wait-list-groups">\n\t\t\t<div v-for="group of waitListGroups" :key="group.title" class="booking-wait-list-group">\n\t\t\t\t<div class="booking-wait-list-group-header">\n\t\t\t\t\t<div class="booking-wait-list-group-title">{{ group.title }}</div>\n\t\t\t\t\t<div class="booking-sidebar-button">\n\t\t\t\t\t\t<WaitListGroupMenu :waitListGroup="group"/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<TransitionGroup :name="animationPause ? 'none' : 'wait-list'" tag="div">\n\t\t\t\t\t<template v-for="item of group.items" :key="item.id">\n\t\t\t\t\t\t<slot name="item" :item="item"/>\n\t\t\t\t\t</template>\n\t\t\t\t</TransitionGroup>\n\t\t\t</div>\n\t\t</div>\n\t`};const Xo={name:"WaitListItemName",components:{Name:P.Name},props:{waitListItem:{type:Object,required:true}},computed:{client(){var t;const e=((t=this.waitListItem.clients)==null?void 0:t[0])||null;return e?this.$store.getters[`${Bt.Model.Clients}/getByClientData`](e):null},itemName(){var t;return((t=this.client)==null?void 0:t.name)||this.waitListItem.name||this.loc("BOOKING_BOOKING_DEFAULT_BOOKING_NAME")}},template:`\n\t\t<Name\n\t\t\t:name="itemName"\n\t\t\t:dataAttributes="{\n\t\t\t\t'data-element': 'wait-list-item-name',\n\t\t\t\t'data-id': waitListItem.id,\n\t\t\t}"\n\t\t/>\n\t`};const Vo={name:"WaitListItemNote",components:{Note:P.Note},props:{waitListItem:{type:Object,required:true},bindElement:{type:Function,required:true},visiblePopup:{type:Boolean,default:false}},watch:{visiblePopup(t){if(t){var e;(e=this.$refs.note)==null?void 0:e.showViewPopup()}else{var o;(o=this.$refs.note)==null?void 0:o.closeViewPopup()}}},methods:{async saveWaitListItemNote({note:t}){const e=this.waitListItem.id;await N.waitListService.update({id:e,note:t})}},template:`\n\t\t<Note\n\t\t\tref="note"\n\t\t\t:id="waitListItem.id"\n\t\t\t:note="waitListItem.note"\n\t\t\t:bindElement\n\t\t\tclassName="booking--wait-list-item-note"\n\t\t\t:dataId="waitListItem.id"\n\t\t\tdataElementPrefix="wait-list-item"\n\t\t\t:dataAttributes="{\n\t\t\t\t'data-id': waitListItem.id,\n\t\t\t\t'data-element': 'booking-wait-list-item-note-button',\n\t\t\t}"\n\t\t\t@save="saveWaitListItemNote"\n\t\t/>\n\t`};const jo={name:"WaitListItemProfit",components:{Profit:P.Profit},props:{waitListItem:{type:Object,required:true}},computed:{deal(){var t,e;return(t=(e=this.waitListItem.externalData)==null?void 0:e.find((t=>t.entityTypeId===Bt.CrmEntity.Deal)))!=null?t:null}},template:`\n\t\t<Profit\n\t\t\t:deal\n\t\t\t:dataAttributes="{\n\t\t\t\t'data-id': waitListItem.id,\n\t\t\t\t'data-element': 'booking-wait-list-item-profit'\n\t\t\t}"\n\t\t/>\n\t`};const Yo={name:"WaitListItemClient",components:{Client:D.Client},props:{waitListItemId:{type:Number,required:true}},emits:["freeze","unfreeze"],computed:{waitListItem(){return this.$store.getters[`${Bt.Model.WaitList}/getById`](this.waitListItemId)}},methods:{async addClients({clients:t}){await N.waitListService.update({id:this.waitListItem.id,clients:t})},async updateClients({clients:t}){await N.waitListService.update({id:this.waitListItem.id,clients:t})},async updateNote({note:t}){await N.waitListService.update({id:this.waitListItem.id,note:t})}},template:`\n\t\t<Client\n\t\t\t:id="waitListItemId"\n\t\t\t:primaryClientData="waitListItem.clients?.[0] || null"\n\t\t\t:clients="waitListItem.clients"\n\t\t\t:note="waitListItem.note"\n\t\t\t:dataId="waitListItemId"\n\t\t\tdataElementPrefix="wait-list-item"\n\t\t\t:dataAttributes="{\n\t\t\t\t'data-wait-list-item-id': waitListItemId,\n\t\t\t}"\n\t\t\t@freeze="$emit('freeze')"\n\t\t\t@unfreeze="$emit('unfreeze')"\n\t\t\t@addClients="addClients"\n\t\t\t@updateClients="updateClients"\n\t\t\t@updateNote="updateNote"\n\t\t/>\n\t`};const Zo={name:"WaitListItemConfirmation",components:{Confirmation:D.Confirmation},props:{waitListItemId:{type:Number,required:true}},emits:["freeze","unfreeze"],template:`\n\t\t<Confirmation\n\t\t\t:id="waitListItemId"\n\t\t\t:isConfirmed="false"\n\t\t\t:counters="[]"\n\t\t\tdisabled\n\t\t\t:dataId="waitListItemId"\n\t\t\tdataPre\n\t\t/>\n\t`};const Qo={name:"WaitListItemDeal",components:{Deal:D.Deal},props:{waitListItemId:{type:Number,required:true}},emits:["freeze","unfreeze"],setup(t){const e=new $.WaitListDealHelper(t.waitListItemId);return{dealHelper:e}},computed:{waitListItem(){return this.$store.getters[`${Bt.Model.WaitList}/getById`](this.waitListItemId)},deal(){var t,e,o;return(t=(e=this.waitListItem)==null?void 0:(o=e.externalData)==null?void 0:o.find((t=>t.entityTypeId===Bt.CrmEntity.Deal)))!=null?t:null}},template:`\n\t\t<Deal\n\t\t\t:deal="deal"\n\t\t\t:dealHelper="dealHelper"\n\t\t\t:dataId="waitListItemId"\n\t\t\t:dataAttributes="{\n\t\t\t\t'data-wait-list-item-id': waitListItemId,\n\t\t\t}"\n\t\t\tdataElementPrefix="wait-list"\n\t\t\t@freeze="$emit('freeze')"\n\t\t\t@unfreeze="$emit('unfreeze')"\n\t\t/>\n\t`};const Jo={name:"WaitListItemDocument",components:{Document:D.Document},props:{waitListItemId:{type:Number,required:true}},setup(){const t=vt.ref(true);vt.onMounted((()=>{t.value=false}));return{isLoading:t}},template:`\n\t\t<Document\n\t\t\t:id="waitListItemId"\n\t\t\t:loading="isLoading"\n\t\t\tdisabled\n\t\t/>\n\t`};const ti={name:"WaitListItemMessage",components:{Message:D.Message},props:{waitListItemId:{type:Number,required:true}},template:`\n\t\t<Message\n\t\t\t:id="waitListItemId"\n\t\t\t:clientData="null"\n\t\t\t:loading="false"\n\t\t\tdisabled\n\t\t\t:dataId="waitListItemId"\n\t\t\tdataElementPrefix="wait-list"\n\t\t/>\n\t`};const ei={name:"WaitListItemRemove",components:{RemoveButton:D.RemoveButton},props:{waitListItemId:{type:Number,required:true}},emits:["close"],methods:{remove(){new H.RemoveWaitListItem(this.waitListItemId);this.$emit("close")}},template:`\n\t\t<RemoveButton\n\t\t\tshowLabel\n\t\t\t:dataAttributes="{\n\t\t\t\t'data-id': waitListItemId,\n\t\t\t\t'data-element': 'booking-wait-list-item-menu-remove-button'\n\t\t\t}"\n\t\t\t@remove="remove"\n\t\t/>\n\t`};const oi={name:"WaitListItemVisit",components:{Visit:D.Visit},props:{waitListItemId:{type:Number,required:true}},computed:{waitListItem(){return this.$store.getters[`${Bt.Model.WaitList}/getById`](this.waitListItemId)}},template:`\n\t\t<Visit\n\t\t\t:id="waitListItem.id"\n\t\t\t:hasClients="waitListItem.clients.length > 0"\n\t\t\tvisitStatus="0"\n\t\t\tdisabled\n\t\t\t:dataId="waitListItem.id"\n\t\t\tdataElementPrefix="wait-list"\n\t\t/>\n\t`};const ii=Object.freeze({client:"client",confirmation:"confirmation",deal:"deal",document:"document",fullForm:"fullForm",message:"message",visit:"visit",overbooking:"overbooking",remove:"remove",waitList:"waitList"});const si={name:"WaitListItemActionsPopup",components:{ActionsPopup:D.ActionsPopup,FullForm:D.FullForm,WaitListItemClient:Yo,WaitListItemConfirmation:Zo,WaitListItemDeal:Qo,WaitListItemDocument:Jo,WaitListItemMessage:ti,WaitListItemRemove:ei,WaitListItemVisit:oi},props:{waitListItem:{type:Object,required:true},bindElement:{type:HTMLElement,required:true}},emits:["close"],computed:{config(){return{offsetTop:-100,offsetLeft:-500,className:"booking--wait-list--wait-list-item--sticky-popup"}},contentStructure(){const t=this.waitListItem.id;return[{id:ii.client,props:{waitListItemId:t},component:Yo},[{id:ii.deal,props:{waitListItemId:t},component:Qo},{id:ii.document,props:{waitListItemId:t},component:Jo}],[{id:ii.fullForm,props:{waitListItemId:t},component:D.FullForm},{id:ii.info,class:"--shrink",props:{waitListItemId:t},component:D.Info}]]}},template:`\n\t\t<ActionsPopup\n\t\t\t:popupId="waitListItem.id"\n\t\t\t:bindElement="bindElement"\n\t\t\t:contentStructure="contentStructure"\n\t\t\t:popupOptions="config"\n\t\t\t@close="$emit('close')"\n\t\t>\n\t\t\t<template #footer>\n\t\t\t\t<WaitListItemRemove\n\t\t\t\t\t:waitListItemId="waitListItem.id"\n\t\t\t\t\t@close="$emit('close')"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t</ActionsPopup>\n\t`};const ni={name:"WaitListItemActions",components:{WaitListItemActionsPopup:si},props:{waitListItem:{type:Object,required:true}},data(){return{showPopup:false}},computed:{...mt.mapGetters({editingWaitListItemId:`${Bt.Model.Interface}/editingWaitListItemId`,isEditingBookingMode:`${Bt.Model.Interface}/isEditingBookingMode`})},mounted(){if(this.isEditingBookingMode&&this.editingWaitListItemId===this.waitListItem.id){this.showPopup=true}},methods:{clickHandler(){this.showPopup=!this.showPopup}},template:`\n\t\t<div\n\t\t\tref="node"\n\t\t\tclass="booking-booking-booking-actions booking--wait-list-item-actions"\n\t\t\tdata-element="booking-wait-list-item-actions-button"\n\t\t\t:data-id="waitListItem.id"\n\t\t\t@click="clickHandler"\n\t\t>\n\t\t\t<div class="booking-booking-booking-actions-inner">\n\t\t\t\t<div class="ui-icon-set --chevron-down"></div>\n\t\t\t</div>\n\t\t</div>\n\t\t<WaitListItemActionsPopup\n\t\t\tv-if="showPopup"\n\t\t\t:waitListItem\n\t\t\t:bindElement="this.$refs.node"\n\t\t\t@close="showPopup = false"\n\t\t/>\n\t`};const ri={name:"WaitListItemAddClient",components:{AddClient:P.AddClient},props:{waitListItem:{type:Object,required:true}},methods:{async addClient(t){const e=this.waitListItem.id;await N.waitListService.update({id:e,clients:t})}},template:`\n\t\t<AddClient\n\t\t\t:dataAttributes="{\n\t\t\t\t'data-id': waitListItem.id,\n\t\t\t\t'data-element': 'booking-wait-list-item-add-client-button',\n\t\t\t}"\n\t\t\t:popupOffsetLeft="-300"\n\t\t\t@add="addClient"\n\t\t/>\n\t`};const ai={name:"WaitListItemCrmButton",components:{CrmButton:P.CrmButton},props:{waitListItem:{type:Object,required:true}},setup(t){const e=new $.WaitListDealHelper(t.waitListItem.id);return{dealHelper:e}},template:`\n\t\t<CrmButton\n\t\t\t:dealHelper\n\t\t\t:dataAttributes="{\n\t\t\t\t'data-wait-list-item-id': waitListItem.id,\n\t\t\t\t'data-element': 'wait-list-item-crm-button'\n\t\t\t}"\n\t\t/>\n\t`};const li={name:"WaitListItem",components:{BookingBase:P.BookingBase,Communication:P.Communication,DisabledPopup:P.DisabledPopup,WaitListItemName:Xo,WaitListItemNote:Vo,WaitListItemProfit:jo,WaitListItemActions:ni,WaitListItemAddClient:ri,WaitListItemCrmButton:ai},props:{item:{type:Object,required:true}},data(){return{isDisabledPopupShown:false,visibleNotePopup:false}},computed:{...mt.mapGetters({editingWaitListItemId:`${Bt.Model.Interface}/editingWaitListItemId`,isEditingBookingMode:`${Bt.Model.Interface}/isEditingBookingMode`,isWaitListItemCreatedFromEmbed:`${Bt.Model.Interface}/isWaitListItemCreatedFromEmbed`,animationPause:`${Bt.Model.Interface}/animationPause`}),hasClient(){return this.item.clients.length>0},disabled(){return this.isEditingBookingMode&&this.editingWaitListItemId!==this.item.id},dataAttributes(){return{"data-id":this.item.id,"data-kind":Bt.DraggedElementKind.WaitListItem,"data-element":"booking-wait-list-item"}},hasAccent(){return this.editingWaitListItemId===this.item.id||this.isWaitListItemCreatedFromEmbed(this.item.id)}},methods:{onClick(){if(this.disabled){this.isDisabledPopupShown=true}},onNoteMouseEnter(){this.showNoteTimeout=setTimeout((()=>{this.visibleNotePopup=true}),100)},onNoteMouseLeave(){clearTimeout(this.showNoteTimeout);this.visibleNotePopup=false}},template:`\n\t\t<BookingBase\n\t\t\t:disabled\n\t\t\t:bookingClass="{\n\t\t\t\t'booking--draggable-item': true,\n\t\t\t\t'booking-wait-list-item': true,\n\t\t\t\t'--disabled': disabled,\n\t\t\t\t'--accent': hasAccent,\n\t\t\t\t'no-transition': animationPause,\n\t\t\t}"\n\t\t\t:dataAttributes="dataAttributes"\n\t\t\t@click="onClick"\n\t\t>\n\t\t\t<template #upper-content-row>\n\t\t\t\t<div\n\t\t\t\t\tclass="booking-booking-booking-name-container"\n\t\t\t\t\t@mouseenter="onNoteMouseEnter"\n\t\t\t\t\t@mouseleave="onNoteMouseLeave"\n\t\t\t\t>\n\t\t\t\t\t<WaitListItemName :waitListItem="item"/>\n\t\t\t\t\t<WaitListItemNote\n\t\t\t\t\t\t:waitListItem="item"\n\t\t\t\t\t\t:bindElement="() => $el"\n\t\t\t\t\t\t:visiblePopup="visibleNotePopup"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<WaitListItemProfit :waitListItem="item"/>\n\t\t\t</template>\n\t\t\t<template #lower-content-row>\n\t\t\t\t<div class="booking--wait-list-item--space"></div>\n\t\t\t\t<div v-if="hasClient" class="booking--booking-base-buttons">\n\t\t\t\t\t<Communication/>\n\t\t\t\t\t<WaitListItemCrmButton :waitListItem="item"/>\n\t\t\t\t</div>\n\t\t\t\t<WaitListItemAddClient\n\t\t\t\t\tv-else\n\t\t\t\t\t:waitListItem="item"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t\t<template #end>\n\t\t\t\t<DisabledPopup\n\t\t\t\t\tv-if="isDisabledPopupShown"\n\t\t\t\t\t:popupId="'booking-wait-list-item-disabled-popup-' + item.id"\n\t\t\t\t\t:bindElement="() => $el"\n\t\t\t\t\t@close="isDisabledPopupShown = false"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t\t<template #actions>\n\t\t\t\t<WaitListItemActions :waitListItem="item"/>\n\t\t\t</template>\n\t\t</BookingBase>\n\t`};const di={name:"ButtonAddWaitListItem",components:{Button:Tt.Button},setup(){return{ButtonColor:Tt.ButtonColor,ButtonSize:Tt.ButtonSize}},computed:{...mt.mapGetters({embedItems:`${Bt.Model.Interface}/embedItems`,isLoaded:`${Bt.Model.Interface}/isLoaded`,isEditingBookingMode:`${Bt.Model.Interface}/isEditingBookingMode`,waitListItems:`${Bt.Model.WaitList}/get`,waitListExpanded:`${Bt.Model.Interface}/waitListExpanded`}),addButtonText(){return this.isLoaded&&this.waitListItems.length===0?this.loc("BOOKING_BOOKING_WAIT_LIST_ADD").replace("[plus]","+"):"+"},disabled(){return this.isEditingBookingMode||!this.isLoaded},clients(){const t=this.embedItems.filter((t=>t.entityTypeId==="CONTACT"||t.entityTypeId==="COMPANY"));return t.map((t=>({id:t.value,type:{code:t.entityTypeId,module:t.moduleId}})))}},methods:{async addWaitListItem(){if(this.disabled||!this.isLoaded){return}if(!this.waitListExpanded){await this.expandWaitListWidget()}const t=Date.now();const e=`tmp-id-${t}-${ht.Text.getRandom(4)}`;await this.addCreatedFromEmbedWaitListItem(e);const o=await N.waitListService.add({id:e,clients:this.clients,externalData:this.embedItems,createdAt:t,updatedAt:t});if(o.success&&o.waitListItem){ct.WaitListAnalytics.sendAddBooking();await this.addCreatedFromEmbedWaitListItem(o.waitListItem.id)}},async addCreatedFromEmbedWaitListItem(t){await this.$store.dispatch(`${Bt.Model.Interface}/addCreatedFromEmbedWaitListItem`,t)},async expandWaitListWidget(){await this.$store.commit("interface/setWaitListExpanded",true)}},template:`\n\t\t<Button\n\t\t\tclass="booking-wait-list-add"\n\t\t\t:text="addButtonText"\n\t\t\t:size="ButtonSize.EXTRA_SMALL"\n\t\t\t:color="ButtonColor.SECONDARY_LIGHT"\n\t\t\t:disabled\n\t\t\t:round="true"\n\t\t\t@click="addWaitListItem"\n\t\t/>\n\t`};const ci={name:"WaitList",components:{Button:Tt.Button,Icon:Z.BIcon,ButtonAddWaitListItem:di,WaitListLayout:Ko,WaitListGroups:qo,WaitListItem:li},data(){return{IconSet:Z.Set,ButtonColor:Tt.ButtonColor,ButtonSize:Tt.ButtonSize}},computed:{...mt.mapGetters({getBookingById:`${Bt.Model.Bookings}/getById`,waitListItems:`${Bt.Model.WaitList}/get`,waitListExpanded:`${Bt.Model.Interface}/waitListExpanded`,draggedBookingId:`${Bt.Model.Interface}/draggedBookingId`,draggedBookingResourceId:`${Bt.Model.Interface}/draggedBookingResourceId`,editingBookingId:`${Bt.Model.Interface}/editingBookingId`,editingWaitListItemId:`${Bt.Model.Interface}/editingWaitListItemId`,isFeatureEnabled:`${Bt.Model.Interface}/isFeatureEnabled`,isBookingCreatedFromEmbed:`${Bt.Model.Interface}/isBookingCreatedFromEmbed`,embedItems:`${Bt.Model.Interface}/embedItems`,getResourceById:`${Bt.Model.Resources}/getById`}),isEmpty(){return this.waitListItems.length===0},isAvailableToDrop(){var t;return Boolean(this.draggedBookingId&&!((t=this.getResourceById(this.draggedBookingResourceId))!=null&&t.isDeleted))},showEmptyState(){return this.isEmpty&&!this.draggedBookingId},embedEditingMode(){var t,e;return this.isFeatureEnabled&&(this.editingBookingId>0||this.editingWaitListItemId>0||((t=(e=this.embedItems)==null?void 0:e.length)!=null?t:0)>0)}},watch:{async waitListExpanded(t,e){if(t!==e){await J.optionService.setBool(Bt.Option.WaitListExpanded,t)}}},methods:{async onMouseUp(){if(!this.draggedBookingId){return}const t=this.draggedBookingId;await this.$store.dispatch(`${Bt.Model.Interface}/addDeletingBooking`,t);if(O.isRealId(t)){if(this.editingBookingId===t){await this.setEditingWaitListItemId(t)}const e=this.getBookingById(t);const o=await N.waitListService.createFromBooking(t,{id:t,clients:e.clients,primaryClient:e.primaryClient,externalData:e.externalData,createdAt:Date.now(),updatedAt:Date.now()});if(o.success&&o.waitListItem){ct.BookingAnalytics.sendAddWaitListItem();if(this.editingWaitListItemId===t){await this.setEditingWaitListItemId(o.waitListItem.id)}}}else{if(this.isBookingCreatedFromEmbed(t)){await this.addCreatedFromEmbedWaitListItem(t)}const e=await N.waitListService.add({id:t,clients:[],createdAt:Date.now(),updatedAt:Date.now()});if(e.success&&e.waitListItem){await this.addCreatedFromEmbedWaitListItem(e.waitListItem.id)}}},async addCreatedFromEmbedWaitListItem(t){await this.$store.dispatch(`${Bt.Model.Interface}/addCreatedFromEmbedWaitListItem`,t)},async setEditingWaitListItemId(t){await Promise.all([this.$store.dispatch(`${Bt.Model.Interface}/setEditingWaitListItemId`,t),this.$store.dispatch(`${Bt.Model.Interface}/setEditingBookingId`,null)])},async collapseToggle(){await this.$store.dispatch(`${Bt.Model.Interface}/setWaitListExpanded`,!this.waitListExpanded)}},template:`\n\t\t<WaitListLayout\n\t\t\t:dragging="isAvailableToDrop"\n\t\t\t:showEmptyState\n\t\t\t:expanded="waitListExpanded"\n\t\t\t:waitListItemsCount="waitListItems.length"\n\t\t\t:waitListClass="{\n\t\t\t\t'--expand': waitListExpanded,\n\t\t\t\t'embed-editing-mode': embedEditingMode,\n\t\t\t}"\n\t\t\t@mouseUp="onMouseUp"\n\t\t>\n\t\t\t<template #header>\n\t\t\t\t<ButtonAddWaitListItem/>\n\t\t\t\t<div class="booking-sidebar-button" @click="collapseToggle">\n\t\t\t\t\t<Icon :name="waitListExpanded ? IconSet.COLLAPSE : IconSet.EXPAND_1"/>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t\t<template #waitlist>\n\t\t\t\t<WaitListGroups>\n\t\t\t\t\t<template #item="{ item }">\n\t\t\t\t\t\t<WaitListItem :item/>\n\t\t\t\t\t</template>\n\t\t\t\t</WaitListGroups>\n\t\t\t</template>\n\t\t</WaitListLayout>\n\t`};const ui={components:{Calendar:xo,WaitList:ci},template:`\n\t\t<div class="booking-booking-sidebar">\n\t\t\t<Calendar/>\n\t\t\t<WaitList/>\n\t\t</div>\n\t`};const mi={data(){return{IconSet:Z.Set}},computed:{...mt.mapGetters({draggedDataTransfer:`${Bt.Model.Interface}/draggedDataTransfer`})},methods:{onMouseUp(){if(this.draggedDataTransfer.kind===Bt.DraggedElementKind.Booking){new A.RemoveBooking(this.draggedDataTransfer.id);return}if(this.draggedDataTransfer.kind===Bt.DraggedElementKind.WaitListItem){new H.RemoveWaitListItem(this.draggedDataTransfer.id)}}},components:{Icon:Z.BIcon},template:`\n\t\t<div v-if="draggedDataTransfer.id > 0" class="booking-booking-drag-delete">\n\t\t\t<div\n\t\t\t\tclass="booking-booking-drag-delete-button"\n\t\t\t\tdata-element="booking-drag-delete"\n\t\t\t\t@mouseup.capture="onMouseUp"\n\t\t\t>\n\t\t\t\t<Icon :name="IconSet.TRASH_BIN"/>\n\t\t\t\t<div class="booking-booking-drag-delete-button-text">\n\t\t\t\t\t{{ loc('BOOKING_BOOKING_DRAG_DELETE') }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const hi={name:"BookingsGrid",components:{LeftPanel:te,NowLine:ee,Column:io,Bookings:Qe,ScalePanel:Ho,Sidebar:ui,DragDelete:mi},data(){return{scrolledToBooking:false}},computed:{...mt.mapGetters({resourcesIds:`${Bt.Model.Interface}/resourcesIds`,scroll:`${Bt.Model.Interface}/scroll`,editingBookingId:`${Bt.Model.Interface}/editingBookingId`,editingWaitListItemId:`${Bt.Model.Interface}/editingWaitListItemId`,isFeatureEnabled:`${Bt.Model.Interface}/isFeatureEnabled`,isLoaded:`${Bt.Model.Interface}/isLoaded`,selectedDateTs:`${Bt.Model.Interface}/selectedDateTs`,filteredBookingsIds:`${Bt.Model.Filter}/filteredBookingsIds`,isFilterMode:`${Bt.Model.Filter}/isFilterMode`}),editingBooking(){var t;return(t=this.$store.getters["bookings/getById"](this.editingBookingId))!=null?t:null}},watch:{scroll(t){this.$refs.columnsContainer.scrollLeft=t},editingBooking(){this.scrollToEditingBooking()},isLoaded(t){if(t){let t=null;let e=null;if(this.editingBookingId){t=this.editingBookingId;e=Bt.DraggedElementKind.Booking}if(this.editingWaitListItemId){t=this.editingWaitListItemId;e=Bt.DraggedElementKind.WaitListItem}this.initDragManager(t,e)}},editingBookingId(t){if(t){this.initDragManager(t,Bt.DraggedElementKind.Booking)}},editingWaitListItemId(t){if(t){this.initDragManager(t,Bt.DraggedElementKind.WaitListItem)}},filteredBookingsIds(t){var e;if(!this.isFilterMode||t.length===0){return}const o=(e=this.$store.getters["bookings/getById"](t[0]))!=null?e:null;if(o!==null){this.scrollToBooking(o)}}},mounted(){this.ears=new rt.Ears({container:this.$refs.columnsContainer,smallSize:true,className:"booking-booking-grid-columns-ears"}).init();c.EventEmitter.subscribe("BX.Main.Popup:onAfterClose",this.tryShowAhaMoment);c.EventEmitter.subscribe("BX.Main.Popup:onDestroy",this.tryShowAhaMoment)},beforeUnmount(){var t;(t=this.dragManager)==null?void 0:t.destroy()},unmounted(){c.EventEmitter.unsubscribe("BX.Main.Popup:onAfterClose",this.tryShowAhaMoment);c.EventEmitter.unsubscribe("BX.Main.Popup:onDestroy",this.tryShowAhaMoment)},methods:{updateEars(){this.ears.toggleEars();this.tryShowAhaMoment()},areEarsShown(){const t="ui-ear-show";return ht.Dom.hasClass(this.ears.getRightEar(),t)||ht.Dom.hasClass(this.ears.getLeftEar(),t)},scrollToEditingBooking(){if(!this.editingBooking||this.scrolledToBooking){return}this.scrollToBooking(this.editingBooking)},scrollToBooking(t){const e=M.grid.calculateTop(t.dateFromTs);const o=M.grid.calculateHeight(t.dateFromTs,t.dateToTs);this.$refs.inner.scrollTop=e+o/2+this.$refs.inner.offsetHeight/2;this.scrolledToBooking=true},tryShowAhaMoment(){if(this.areEarsShown()&&bt.ahaMoments.shouldShow(Bt.AhaMoment.ExpandGrid)){ht.Event.EventEmitter.unsubscribe("BX.Main.Popup:onAfterClose",this.tryShowAhaMoment);ht.Event.EventEmitter.unsubscribe("BX.Main.Popup:onDestroy",this.tryShowAhaMoment);void this.$refs.scalePanel.showAhaMoment()}},initDragManager(t="",e=null){if(this.isFeatureEnabled){const o=t?`[data-id="${t}"]`:"";const i=e?`[data-kind="${e}"]`:"";this.dragManager=new u.Drag({container:this.$el.parentElement,draggable:`.booking--draggable-item${o}${i}`})}}},template:`\n\t\t<div ref="bookingContainer" class="booking-booking-grid">\n\t\t\t<div\n\t\t\t\tid="booking-booking-grid-wrap"\n\t\t\t\tclass="booking-booking-grid-inner --vertical-scroll-bar"\n\t\t\t\tref="inner"\n\t\t\t>\n\t\t\t\t<LeftPanel/>\n\t\t\t\t<NowLine/>\n\t\t\t\t<div\n\t\t\t\t\tid="booking-booking-grid-columns"\n\t\t\t\t\tclass="booking-booking-grid-columns --horizontal-scroll-bar"\n\t\t\t\t\tref="columnsContainer"\n\t\t\t\t\t@scroll="$store.dispatch('interface/setScroll', $refs.columnsContainer.scrollLeft)"\n\t\t\t\t>\n\t\t\t\t\t<Bookings/>\n\t\t\t\t\t<TransitionGroup\n\t\t\t\t\t\tname="booking-transition-resource"\n\t\t\t\t\t\t@after-leave="updateEars"\n\t\t\t\t\t\t@after-enter="updateEars"\n\t\t\t\t\t>\n\t\t\t\t\t\t<template v-for="resourceId of resourcesIds" :key="resourceId">\n\t\t\t\t\t\t\t<Column :resourceId="resourceId"/>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t</TransitionGroup>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<ScalePanel\n\t\t\t\t:getColumnsContainer="() => $refs.columnsContainer"\n\t\t\t\tref="scalePanel"\n\t\t\t/>\n\t\t\t<DragDelete/>\n\t\t</div>\n\t\t<Sidebar/>\n\t`};const pi=0;const gi=12;const bi="var(--ui-color-primary-alt)";const fi="var(--ui-color-background-secondary)";const Ii=14;const ki=27;const vi={name:"BatteryIcon",props:{percent:{type:Number,default:0},dataId:{type:[String,Number],default:""},height:{type:Number,default:Ii},width:{type:Number,default:ki}},mounted(){this.repaint()},methods:{getCharge(t){if(t<=0){return pi}if(t>=100){return gi}return Math.round(t*gi*.01)},repaint(){var t;const e=((t=this.$refs["icon-battery-charge"])==null?void 0:t.children)||[];const o=this.getCharge(this.percent);let i=1;for(const t of e){t.setAttribute("fill",i>o?fi:bi);i++}}},watch:{percent:{handler(){this.repaint()}}},template:`\n\t\t<div :data-id="dataId" :data-percent="percent" data-element="booking-resource-workload-percent">\n\t\t\t<svg id="booking--battery-icon" :width="width" :height="height" viewBox="0 0 27 14" fill="none"\n\t\t\t\t xmlns="http://www.w3.org/2000/svg">\n\t\t\t\t<rect width="23.2875" height="13.8" rx="4" fill="white"/>\n\t\t\t\t<rect x="22.6871" y="0.6" width="12.6" height="22.0875" rx="3.4" transform="rotate(90 22.6871 0.6)" stroke="#C9CCD0" stroke-width="1.2"/>\n\t\t\t\t<g ref="icon-battery-charge" id="booking--battery-icon-charge" clip-path="url(#clip0_5003_187951)">\n\t\t\t\t\t<rect x="2.58789" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t\t<rect x="4.09766" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t\t<rect x="5.60547" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t\t<rect x="7.11523" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t\t<rect x="8.625" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t\t<rect x="10.1328" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t\t<rect x="11.6426" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t\t<rect x="13.1523" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t\t<rect x="14.6621" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t\t<rect x="16.1699" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t\t<rect x="17.6797" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t\t<rect x="19.1895" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t</g>\n\t\t\t\t<g clip-path="url(#clip1_5003_187951)">\n\t\t\t\t\t<ellipse cx="23.102" cy="6.89999" rx="2.9" ry="3.48" transform="rotate(90 23.102 6.89999)" fill="#C9CCD0"/>\n\t\t\t\t</g>\n\t\t\t\t<defs>\n\t\t\t\t\t<clipPath id="clip0_5003_187951">\n\t\t\t\t\t\t<rect x="2.58789" y="2.5875" width="18.1125" height="8.625" rx="1.5" fill="white"/>\n\t\t\t\t\t</clipPath>\n\t\t\t\t\t<clipPath id="clip1_5003_187951">\n\t\t\t\t\t\t<rect width="6.9" height="2.15625" fill="white" transform="translate(26.7383 3.45) rotate(90)"/>\n\t\t\t\t\t</clipPath>\n\t\t\t\t</defs>\n\t\t\t</svg>\n\t\t</div>\n\t`};const Bi={emits:["close"],props:{resourceId:{type:Number,required:true},slotsCount:{type:Number,required:true},bookingCount:{type:Number,required:true},workLoadPercent:{type:Number,required:true},bindElement:{type:HTMLElement,required:true}},computed:{popupId(){return"booking-booking-resource-workload-popup"},title(){return this.loc("BOOKING_BOOKING_RESOURCE_WORKLOAD_POPUP_TITLE")},rows(){return[{title:this.loc("BOOKING_BOOKING_RESOURCE_WORKLOAD_SLOTS_BOOKED"),value:this.slotsBookedFormatted,dataset:{element:"booking-resource-workload-popup-count",resourceId:this.resourceId,bookedCount:this.bookingCount,totalCount:this.slotsCount}},{title:this.loc("BOOKING_BOOKING_RESOURCE_WORKLOAD"),value:this.workLoadPercentFormatted,dataset:{element:"booking-resource-workload-popup-percent",resourceId:this.resourceId,percent:this.workLoadPercent}}]},slotsBookedFormatted(){return this.loc("BOOKING_BOOKING_RESOURCE_WORKLOAD_BOOKED_FROM_SLOTS_COUNT",{"#BOOKED#":this.bookingCount,"#SLOTS_COUNT#":this.slotsCount})},workLoadPercentFormatted(){return this.loc("BOOKING_BOOKING_RESOURCE_WORKLOAD_PERCENT",{"#PERCENT#":this.workLoadPercent})}},components:{StatisticsPopup:x.StatisticsPopup},template:`\n\t\t<StatisticsPopup\n\t\t\t:popupId="popupId"\n\t\t\t:bindElement="bindElement"\n\t\t\t:title="title"\n\t\t\t:rows="rows"\n\t\t\t:dataset="{\n\t\t\t\tid: resourceId,\n\t\t\t\telement: 'booking-resource-workload-popup',\n\t\t\t}"\n\t\t\t@close="$emit('close')"\n\t\t/>\n\t`};const Ti={name:"ResourceWorkload",components:{BatteryIcon:vi,WorkloadPopup:Bi},props:{resourceId:{type:Number,required:true},scale:{type:Number,default:1},isGrid:{type:Boolean,default:false}},data(){return{isPopupShown:false}},computed:{...mt.mapGetters({selectedDateTs:"interface/selectedDateTs",fromHour:"interface/fromHour",toHour:"interface/toHour"}),workLoadPercent(){if(this.slotsCount===0){return 0}const t=this.slotSize*this.slotsCount;const e=this.bookings.reduce(((e,o)=>e+o.duration*100/t),0);return Math.round(e)},slotSize(){var t;return(t=this.resource.slotRanges[0].slotSize)!=null?t:60},slotsCount(){const t=new Date(this.selectedDateTs);const e=Bt.DateFormat.WeekDays[t.getDay()];const o=et.busySlots.filterSlotRanges(this.resource.slotRanges.filter((t=>t.weekDays.includes(e))));return Math.floor(o.reduce(((t,e)=>t+Math.round((e.to-e.from)/this.slotSize)),0))},bookings(){const t=this.selectedDateTs;return this.$store.getters[`${Bt.Model.Bookings}/getByDateAndResources`](t,[this.resourceId]).map((t=>({dateFromTs:t.dateFromTs,dateToTs:t.dateToTs,duration:(t.dateToTs-t.dateFromTs)/6e4})))},bookingsDuration(){return this.bookings.reduce(((t,e)=>t+e.duration),0)},resource(){return this.$store.getters["resources/getById"](this.resourceId)},batteryIconOptions(){return{height:Math.round(Ii*this.scale),width:Math.round(ki*this.scale)}},bookingsCount(){return this.bookings.length}},watch:{bookingsCount(t,e){if(this.isGrid&&t>e&&bt.ahaMoments.shouldShow(Bt.AhaMoment.ResourceWorkload)){void this.showAhaMoment()}}},methods:{onMouseEnter(){this.showTimeout=setTimeout((()=>this.showPopup()),100)},onMouseLeave(){clearTimeout(this.showTimeout);this.closePopup()},showPopup(){this.isPopupShown=true},closePopup(){this.isPopupShown=false},async showAhaMoment(){bt.ahaMoments.setPopupShown(Bt.AhaMoment.ResourceWorkload);await bt.ahaMoments.show({id:"booking-resource-workload",title:this.loc("BOOKING_AHA_RESOURCE_WORKLOAD_TITLE"),text:this.loc("BOOKING_AHA_RESOURCE_WORKLOAD_TEXT"),article:Bt.HelpDesk.AhaResourceWorkload,target:this.$refs.container});bt.ahaMoments.setShown(Bt.AhaMoment.ResourceWorkload)}},template:`\n\t\t<div\n\t\t\tclass="booking-booking-header-resource-workload"\n\t\t\tdata-element="booking-resource-workload"\n\t\t\t:data-id="resourceId"\n\t\t\tref="container"\n\t\t\t@click="showPopup"\n\t\t\t@mouseenter="onMouseEnter"\n\t\t\t@mouseleave="onMouseLeave"\n\t\t>\n\t\t\t<BatteryIcon\n\t\t\t\t:percent="workLoadPercent"\n\t\t\t\t:data-id="resourceId"\n\t\t\t\t:height="batteryIconOptions.height"\n\t\t\t\t:width="batteryIconOptions.width"\n\t\t\t/>\n\t\t</div>\n\t\t<WorkloadPopup\n\t\t\tv-if="isPopupShown"\n\t\t\t:resourceId="resourceId"\n\t\t\t:slotsCount="slotsCount"\n\t\t\t:bookingCount="Math.ceil(bookingsDuration / slotSize)"\n\t\t\t:workLoadPercent="workLoadPercent"\n\t\t\t:bindElement="$refs.container"\n\t\t\t@close="closePopup"\n\t\t/>\n\t`};const yi={name:"ResourceMenu",props:{resourceId:{type:Number,required:true}},data(){return{menuPopup:null}},computed:{...mt.mapGetters({favoritesIds:`${Bt.Model.Favorites}/get`,isEditingBookingMode:`${Bt.Model.Interface}/isEditingBookingMode`,isFeatureEnabled:`${Bt.Model.Interface}/isFeatureEnabled`,isFilterMode:`${Bt.Model.Filter}/isFilterMode`}),popupId(){return`resource-menu-${this.resourceId||"new"}`}},created(){this.hint=BX.UI.Hint.createInstance({popupParameters:{}})},unmounted(){if(this.menuPopup){this.destroy()}},methods:{openMenu(){var t,e;if((t=this.menuPopup)!=null&&(e=t.popupWindow)!=null&&e.isShown()){this.destroy();return}if(this.isFilterMode){return}const o=this.$refs["menu-button"];this.menuPopup=ft.MenuManager.create(this.popupId,o,this.getMenuItems(),{className:"booking-resource-menu-popup",closeByEsc:true,autoHide:true,offsetTop:-3,offsetLeft:o.offsetWidth-6,angle:true,cacheable:true,events:{onDestroy:()=>this.unbindScrollEvent()}});this.menuPopup.show();this.bindScrollEvent()},getMenuItems(){return[{html:`<span>${this.loc("BOOKING_RESOURCE_MENU_EDIT_RESOURCE")}</span>`,className:this.isFeatureEnabled?"menu-popup-item menu-popup-no-icon":"menu-popup-item --lock",onclick:async()=>{if(!this.isFeatureEnabled){it.limit.show();return}const t=new X.ResourceCreationWizard;this.editResource(this.resourceId,t);this.destroy()}},{html:`<span>${this.loc("BOOKING_RESOURCE_MENU_HIDE")}</span>`,onclick:async()=>{this.destroy();await this.hideResource(this.resourceId)}},{html:`<span class="alert-text">${this.loc("BOOKING_RESOURCE_MENU_DELETE")}</span>`,onclick:async()=>{this.destroy();await this.removeResource(this.resourceId)}}]},destroy(){ft.MenuManager.destroy(this.popupId);this.unbindScrollEvent()},bindScrollEvent(){ht.Event.bind(document,"scroll",this.adjustPosition,{capture:true})},unbindScrollEvent(){ht.Event.unbind(document,"scroll",this.adjustPosition,{capture:true})},adjustPosition(){var t,e;(t=this.menuPopup)==null?void 0:(e=t.popupWindow)==null?void 0:e.adjustPosition()},async editResource(t,e){e.open(t)},async removeResource(t){await new W.RemoveResource(t).run()},async hideResource(t){const e=[...this.favoritesIds];const o=this.favoritesIds.indexOf(t);if(o===-1){return}e.splice(o,1);await j.hideResources(e)}},template:`\n\t\t<button ref="menu-button" class="ui-icon-set --more" @click="openMenu"></button>\n\t`};const Mi={props:{resourceId:{type:Number,required:true}},data(){return{visible:true}},mounted(){this.updateVisibility();this.updateVisibilityDuringTransition()},computed:{...mt.mapGetters({resourcesIds:`${Bt.Model.Interface}/resourcesIds`,zoom:`${Bt.Model.Interface}/zoom`,scroll:`${Bt.Model.Interface}/scroll`,selectedDateTs:`${Bt.Model.Interface}/selectedDateTs`}),resource(){return this.$store.getters[`${Bt.Model.Resources}/getById`](this.resourceId)},resourceType(){return this.$store.getters[`${Bt.Model.ResourceTypes}/getById`](this.resource.typeId)},profit(){const t=G.currencyFormat.getBaseCurrencyId();const e=this.bookings.map((({externalData:t})=>{var e;return(e=t==null?void 0:t.find((t=>t.entityTypeId===Bt.CrmEntity.Deal)))!=null?e:null})).filter((e=>{var o;return(e==null?void 0:(o=e.data)==null?void 0:o.currencyId)===t}));if(e.length===0){return""}const o=[...new Map(e.map((t=>[t.value,t]))).values()];const i=o.reduce(((t,e)=>t+e.data.opportunity),0);return G.currencyFormat.format(t,i)},bookings(){return this.$store.getters[`${Bt.Model.Bookings}/getByDateAndResources`](this.selectedDateTs,[this.resourceId])},labelHTML(){const t=new z.Label({size:z.LabelSize.SM,text:this.loc("BOOKING_BOOKING_RESOURCE_DELETED"),fill:true});return t.render().outerHTML}},methods:{updateVisibilityDuringTransition(){var t;(t=this.animation)==null?void 0:t.stop();this.animation=new BX.easing({duration:200,start:{},finish:{},step:this.updateVisibility});this.animation.animate()},updateVisibility(){if(!this.$refs.container){return}const t=this.$refs.container.getBoundingClientRect();this.visible=t.right>0&&t.left<window.innerWidth}},watch:{scroll(){this.updateVisibility()},zoom(){this.updateVisibility()},resourcesIds(){this.updateVisibilityDuringTransition()}},components:{ResourceMenu:yi,ResourceWorkload:Ti},template:`\n\t\t<div\n\t\t\tclass="booking-booking-header-resource"\n\t\t\tdata-element="booking-resource"\n\t\t\t:data-id="resourceId"\n\t\t\tref="container"\n\t\t>\n\t\t\t<template v-if="visible">\n\t\t\t\t<ResourceWorkload\n\t\t\t\t\tv-if="!resource.isDeleted"\n\t\t\t\t\t:resourceId="resourceId"\n\t\t\t\t\t:scale="zoom"\n\t\t\t\t\t:isGrid="true"\n\t\t\t\t/>\n\t\t\t\t<div class="booking-booking-header-resource-title">\n\t\t\t\t\t<div class="booking-booking-header-resource-name" :title="resource.name">\n\t\t\t\t\t\t{{ resource.name }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="booking-booking-header-resource-type" :title="resourceType.name">\n\t\t\t\t\t\t{{ resourceType.name }}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div\n\t\t\t\t\tv-if="resource.isDeleted"\n\t\t\t\t\tv-html="labelHTML"\n\t\t\t\t></div>\n\t\t\t\t<div\n\t\t\t\t\tclass="booking-booking-header-resource-profit"\n\t\t\t\t\tv-else\n\t\t\t\t\tv-html="profit"\n\t\t\t\t></div>\n\t\t\t\t<div class="booking-booking-header-resource-actions" v-if="!resource.isDeleted">\n\t\t\t\t\t<ResourceMenu :resource-id/>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t</div>\n\t`};const Ei={name:"AddResourceButton",components:{Icon:Z.BIcon},data(){return{IconSet:Z.Set,hovered:false}},computed:mt.mapGetters({isLoaded:`${Bt.Model.Interface}/isLoaded`,isFeatureEnabled:`${Bt.Model.Interface}/isFeatureEnabled`}),watch:{isLoaded(){if(bt.ahaMoments.shouldShow(Bt.AhaMoment.AddResource)){void this.showAhaMoment()}}},methods:{async addResource(){if(!this.isFeatureEnabled){await it.limit.show();return}(new X.ResourceCreationWizard).open();ct.RcwAnalytics.sendClickAddResource()},async showAhaMoment(){await bt.ahaMoments.show({id:"booking-add-resource",title:this.loc("BOOKING_AHA_ADD_RESOURCES_TITLE"),text:this.loc("BOOKING_AHA_ADD_RESOURCES_TEXT_MSGVER_1"),article:{...Bt.HelpDesk.AhaAddResource,title:this.loc("BOOKING_AHA_ARTICLE_LINK_TITLE")},target:this.$refs.button});bt.ahaMoments.setShown(Bt.AhaMoment.AddResource);if(q.SidePanelInstance.openSliders.every((({url:t})=>t!==X.ResourceCreationWizard.makeName()))){void this.addResource()}}},template:`\n\t\t<div\n\t\t\tclass="booking-booking-header-add-resource-icon-container"\n\t\t\t:class="{ '--hover': hovered }"\n\t\t\t@click="addResource"\n\t\t\t@mouseenter="hovered = true"\n\t\t\t@mouseleave="hovered = false"\n\t\t>\n\t\t\t<div\n\t\t\t\tclass="booking-booking-header-add-resource-icon"\n\t\t\t\t:class="{'--lock': !isFeatureEnabled}"\n\t\t\t>\n\t\t\t\t<Icon v-if="isFeatureEnabled" :name="IconSet.PLUS_20"/>\n\t\t\t\t<Icon v-else :name="IconSet.LOCK" :size="16"/>\n\t\t\t</div>\n\t\t</div>\n\t\t<div\n\t\t\tclass="booking-booking-header-add-resource"\n\t\t\t:class="{ '--hover': hovered }"\n\t\t\tref="button"\n\t\t\t@click="addResource"\n\t\t\t@mouseenter="hovered = true"\n\t\t\t@mouseleave="hovered = false"\n\t\t>\n\t\t\t<div class="booking-booking-header-add-resource-text">\n\t\t\t\t{{ loc('BOOKING_BOOKING_ADD_RESOURCE') }}\n\t\t\t</div>\n\t\t</div>\n\t`};class wi extends ot.BaseHeader{constructor(...t){super(...t);this.getContainer()}render(){return this.options.content}}const Ci={emits:["update:modelValue"],data(){return{selectedTypes:{}}},computed:{...mt.mapGetters({resourceTypes:"resourceTypes/get"}),visibleResourceTypes(){return this.resourceTypes.filter((t=>t.resourcesCnt>0))},isResourceTypesSectionVisible(){return this.visibleResourceTypes.length>0}},methods:{selectAll(){Object.keys(this.selectedTypes).forEach((t=>{this.selectedTypes[t]=true}))},deselectAll(){Object.keys(this.selectedTypes).forEach((t=>{this.selectedTypes[t]=false}))}},watch:{resourceTypes(t){t.forEach((t=>{var e,o,i;(i=(e=this.selectedTypes)[o=t.id])!=null?i:e[o]=true}))},selectedTypes:{handler(){this.$emit("update:modelValue",this.selectedTypes)},deep:true}},template:`\n\t\t<div v-if="isResourceTypesSectionVisible" class="booking-booking-resources-dialog-header-types">\n\t\t\t<div class="booking-booking-resources-dialog-header-header">\n\t\t\t\t<div class="booking-booking-resources-dialog-header-title">\n\t\t\t\t\t{{ loc('BOOKING_BOOKING_RESOURCES_DIALOG_RESOURCE_TYPES') }}\n\t\t\t\t</div>\n\t\t\t\t<div\n\t\t\t\t\tclass="booking-booking-resources-dialog-header-button"\n\t\t\t\t\tdata-element="booking-resources-dialog-select-all-types-button"\n\t\t\t\t\t@click="selectAll"\n\t\t\t\t>\n\t\t\t\t\t{{ loc('BOOKING_BOOKING_RESOURCES_DIALOG_SELECT_ALL') }}\n\t\t\t\t</div>\n\t\t\t\t<div\n\t\t\t\t\tclass="booking-booking-resources-dialog-header-button"\n\t\t\t\t\tdata-element="booking-resources-dialog-deselect-all-types-button"\n\t\t\t\t\t@click="deselectAll"\n\t\t\t\t>\n\t\t\t\t\t{{ loc('BOOKING_BOOKING_RESOURCES_DIALOG_DESELECT_ALL') }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="booking-booking-resources-dialog-header-items">\n\t\t\t\t<template v-for="resourceType of visibleResourceTypes" :key="resourceType.id">\n\t\t\t\t\t<label\n\t\t\t\t\t\tclass="booking-booking-resources-dialog-header-item"\n\t\t\t\t\t\tdata-element="booking-resources-dialog-type"\n\t\t\t\t\t\t:data-id="resourceType.id"\n\t\t\t\t\t\t:data-selected="selectedTypes[resourceType.id]"\n\t\t\t\t\t>\n\t\t\t\t\t\t<span\n\t\t\t\t\t\t\tclass="booking-booking-resources-dialog-header-item-text"\n\t\t\t\t\t\t\tdata-element="booking-resources-dialog-type-name"\n\t\t\t\t\t\t\t:data-id="resourceType.id"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{{ resourceType.name }}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<input type="checkbox" v-model="selectedTypes[resourceType.id]">\n\t\t\t\t\t</label>\n\t\t\t\t</template>\n\t\t\t</div>\n\t\t</div>\n\t`};const Si={emits:["startResize","endResize"],props:{getNode:{type:Function,required:true}},data(){return{isResized:false,startMouseY:0,startHeight:0}},methods:{startResize(t){this.$emit("startResize");ht.Dom.style(document.body,"user-select","none");ht.Event.bind(window,"mouseup",this.endResize);ht.Event.bind(window,"pointermove",this.resize);this.isResized=true;this.startMouseY=t.clientY;this.startHeight=this.getNode().offsetHeight},resize(t){if(!this.isResized){return}t.preventDefault();const e=110;const o=180;const i=this.startHeight+t.clientY-this.startMouseY;const s=Math.min(o,Math.max(i,e));ht.Dom.style(this.getNode(),"max-height",`${s}px`)},endResize(){this.$emit("endResize");ht.Dom.style(document.body,"user-select","");ht.Event.unbind(window,"mouseup",this.endResize);ht.Event.unbind(window,"pointermove",this.resize);this.isResized=false}},template:`\n\t\t<div\n\t\t\tclass="booking-booking-resources-dialog-header-resize"\n\t\t\t@mousedown="startResize"\n\t\t></div>\n\t`};const Li={emits:["search"],data(){return{searchDebounced:ht.Runtime.debounce(this.search,200,this),query:""}},computed:{searchIcon(){return Z.Set.SEARCH_2}},methods:{onInput(t){const e=t.target.value;this.query=e;if(ht.Type.isStringFilled(e)){this.searchDebounced(e)}else{this.search(e)}},search(t){if(this.query===t){this.$emit("search",t)}}},components:{Icon:Z.BIcon},template:`\n\t\t<div class="booking-booking-resources-dialog-header-input-container">\n\t\t\t<input\n\t\t\t\tclass="booking-booking-resources-dialog-header-input"\n\t\t\t\t:placeholder="loc('BOOKING_BOOKING_RESOURCES_DIALOG_SEARCH')"\n\t\t\t\tdata-element="booking-resources-dialog-search-input"\n\t\t\t\t@input="onInput"\n\t\t\t>\n\t\t\t<div class="booking-booking-resources-dialog-header-input-icon">\n\t\t\t\t<Icon :name="searchIcon"/>\n\t\t\t</div>\n\t\t</div>\n\t`};const Oi={emits:["update:modelValue","search","startResize","endResize","selectAll","deselectAll"],data(){return{selectedTypes:{}}},computed:mt.mapGetters({resources:"resources/get"}),watch:{selectedTypes:{handler(){this.$emit("update:modelValue",this.selectedTypes)},deep:true}},components:{ResourceTypes:Ci,Resize:Si,Search:Li},template:`\n\t\t<div class="booking-booking-resources-dialog-header" ref="header">\n\t\t\t<ResourceTypes\n\t\t\t\tref="resourceTypes"\n\t\t\t\tv-model="selectedTypes"\n\t\t\t/>\n\t\t\t<Resize\n\t\t\t\t:getNode="() => this.$refs.resourceTypes.$el"\n\t\t\t\t@startResize="$emit('startResize')"\n\t\t\t\t@endResize="$emit('endResize')"\n\t\t\t/>\n\t\t\t<div class="booking-booking-resources-dialog-header-resources">\n\t\t\t\t<div class="booking-booking-resources-dialog-header-header">\n\t\t\t\t\t<div class="booking-booking-resources-dialog-header-title">\n\t\t\t\t\t\t{{ loc('BOOKING_BOOKING_RESOURCES_DIALOG_RESOURCES') }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="booking-booking-resources-dialog-header-button"\n\t\t\t\t\t\tdata-element="booking-resources-dialog-select-all-button"\n\t\t\t\t\t\t@click="$emit('selectAll')"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ loc('BOOKING_BOOKING_RESOURCES_DIALOG_SELECT_ALL') }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="booking-booking-resources-dialog-header-button"\n\t\t\t\t\t\tdata-element="booking-resources-dialog-deselect-all-button"\n\t\t\t\t\t\t@click="$emit('deselectAll')"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ loc('BOOKING_BOOKING_RESOURCES_DIALOG_DESELECT_ALL') }}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<Search @search="(query) => this.$emit('search', query)"/>\n\t\t\t</div>\n\t\t</div>\n\t`};class Fi extends ot.BaseFooter{constructor(...t){super(...t);this.getContainer()}render(){return this.options.content}}const Di={name:"DialogFooter",emits:["reset"],computed:{buttonSettings(){return Object.freeze({size:Tt.ButtonSize.SMALL,color:Tt.ButtonColor.LINK})},buttonLabel(){return this.loc("BOOKING_BOOKING_RESOURCES_DIALOG_RESET")}},components:{UiButton:Tt.Button},template:`\n\t\t<div class="booking--booking--select-resources-dialog-footer">\n\t\t\t<UiButton\n\t\t\t\t:size="buttonSettings.size"\n\t\t\t\t:color="buttonSettings.color"\n\t\t\t\t:text="buttonLabel"\n\t\t\t\tbutton-class="booking--booking--select-resources-dialog-footer__button"\n\t\t\t\t@click="$emit('reset')"\n\t\t\t/>\n\t\t</div>\n\t`};const Pi={data(){return{dialogFilled:false,query:"",saveItemsDebounce:ht.Runtime.debounce(this.saveItems,10,this),workloadRefs:{},selectedTypes:{}}},mounted(){this.dialog=new ot.Dialog({context:"BOOKING",targetNode:this.$refs.button,width:340,height:Math.min(window.innerHeight-280,600),offsetLeft:4,dropdownMode:true,preselectedItems:this.favoritesIds.map((t=>[Bt.EntitySelectorEntity.Resource,t])),items:this.resources.map((t=>this.getItemOptions(t))),entities:[{id:Bt.EntitySelectorEntity.Resource}],events:{onShow:this.onShow,"Item:onSelect":this.saveItemsDebounce,"Item:onDeselect":this.saveItemsDebounce},header:wi,headerOptions:{content:this.$refs.dialogHeader.$el},footer:Fi,footerOptions:{content:this.$refs.dialogFooter.$el}});ht.Event.bind(this.dialog.getRecentTab().getContainer(),"scroll",this.loadOnScroll);ht.Event.EventEmitter.subscribe("BX.Main.Popup:onAfterClose",this.tryShowAhaMoment);ht.Event.EventEmitter.subscribe("BX.Main.Popup:onDestroy",this.tryShowAhaMoment)},computed:{...mt.mapGetters({selectedDateTs:`${Bt.Model.Interface}/selectedDateTs`,favoritesIds:`${Bt.Model.Favorites}/get`,resources:`${Bt.Model.Resources}/get`,isFilterMode:`${Bt.Model.Filter}/isFilterMode`,isEditingBookingMode:`${Bt.Model.Interface}/isEditingBookingMode`,isLoaded:`${Bt.Model.Interface}/isLoaded`,mainResources:`${Bt.Model.MainResources}/resources`}),mainResourceIds(){return new Set(this.mainResources)},isDefaultState(){return this.mainResourceIds.size===this.favoritesIds.length&&this.favoritesIds.every((t=>this.mainResourceIds.has(t)))}},methods:{showDialog(){this.updateItems();void this.loadMainResources();this.dialog.show()},async onShow(){if(this.dialogFilled){void this.loadOnScroll();return}this.dialogFilled=true;await V.resourceDialogService.fillDialog(this.selectedDateTs/1e3)},async loadOnScroll(){const t=this.dialog.getRecentTab().getContainer();const e=t.scrollTop;const o=t.scrollHeight-t.offsetHeight;if(e+10>=o){const t=Y.resourcesDateCache.getIdsByDateTs(this.selectedDateTs/1e3);const e=this.resources.filter((t=>!t.isDeleted));const o=e.map((t=>t.id));const i=o.filter((e=>!t.includes(e))).slice(0,Bt.Limit.ResourcesDialog);await V.resourceDialogService.loadByIds(i,this.selectedDateTs/1e3);this.updateItems()}},async loadMainResources(){await V.resourceDialogService.getMainResources()},updateItems(){this.dialog.getItems().forEach((t=>{const e=t.getId();const o=this.workloadRefs[e];const i=this.isItemHidden(e);const s=this.isItemSelected(e);t.getNodes().forEach((t=>{const e=t.getAvatarContainer();ht.Dom.style(e,"width","max-content");ht.Dom.style(e,"height","max-content");ht.Dom.append(o,e)}));t.setHidden(i);if(!t.isSelected()&&s){t.select()}if(t.isSelected()&&!s){t.deselect()}}))},saveItems(){void j.hideResources(this.dialog.getSelectedItems().map((t=>t.id)))},addItems(t){const e=t.reduce(((t,e)=>({...t,[e.id]:this.getItemOptions(e)})),{});Object.values(e).forEach((t=>this.dialog.addItem(t)));const o=this.dialog.getItems().map((t=>t.getId())).filter((t=>e[t]));this.dialog.removeItems();o.forEach((t=>this.dialog.addItem(e[t])));const i=this.dialog.getActiveTab();if(i){i.getContainer().append(i.getRootNode().getChildrenContainer());i.render()}this.updateItems();if(ht.Type.isStringFilled(this.query)){void this.search(this.query)}},getItemOptions(t){return{id:t.id,entityId:Bt.EntitySelectorEntity.Resource,title:t.name,subtitle:this.getResourceType(t.typeId).name,avatarOptions:{bgImage:"none",borderRadius:"0"},tabs:Bt.EntitySelectorTab.Recent,selected:this.isItemSelected(t.id),hidden:this.isItemHidden(t.id),nodeAttributes:{"data-id":t.id,"data-element":"booking-select-resources-dialog-item"}}},isItemSelected(t){return this.favoritesIds.includes(t)},isItemHidden(t){const e=Y.resourcesDateCache.getIdsByDateTs(this.selectedDateTs/1e3);const o=this.getResource(t);const i=e.includes(t)&&o&&!o.isDeleted&&this.selectedTypes[o.typeId];return!i},getResource(t){return this.$store.getters["resources/getById"](t)},getResourceType(t){return this.$store.getters["resourceTypes/getById"](t)},async search(t){this.query=t;this.dialog.search(this.query);this.updateItems();this.dialog.getSearchTab().getStub().hide();this.dialog.getSearchTab().getSearchLoader().show();await V.resourceDialogService.doSearch(this.query,this.selectedDateTs/1e3);this.dialog.search(this.query);this.updateItems();this.dialog.getSearchTab().getSearchLoader().hide();if(this.dialog.getSearchTab().isEmptyResult()){this.dialog.getSearchTab().getStub().show()}},startResize(){this.dialog.freeze()},endResize(){setTimeout((()=>this.dialog.unfreeze()))},selectAll(){this.dialog.getItems().forEach((t=>{if(!t.isHidden()){t.select()}}))},deselectAll(){this.dialog.getItems().forEach((t=>{if(!t.isHidden()){t.deselect()}}))},setWorkloadRef(t,e){this.workloadRefs[e]=t},tryShowAhaMoment(){if(bt.ahaMoments.shouldShow(Bt.AhaMoment.SelectResources)){ht.Event.EventEmitter.unsubscribe("BX.Main.Popup:onAfterClose",this.tryShowAhaMoment);ht.Event.EventEmitter.unsubscribe("BX.Main.Popup:onDestroy",this.tryShowAhaMoment);void this.showAhaMoment()}},async showAhaMoment(){await bt.ahaMoments.show({id:"booking-select-resources",title:this.loc("BOOKING_AHA_SELECT_RESOURCES_TITLE_MSGVER_1"),text:this.loc("BOOKING_AHA_SELECT_RESOURCES_TEXT_MSGVER_1"),article:{...Bt.HelpDesk.AhaSelectResources,title:this.loc("BOOKING_AHA_ARTICLE_LINK_TITLE")},target:this.$refs.button});bt.ahaMoments.setShown(Bt.AhaMoment.SelectResources)},reset(){const t=this.mainResourceIds;this.dialog.getItems().forEach((e=>{if(t.has(e.id)){e.select()}else{e.deselect()}}))}},watch:{favoritesIds(){this.updateItems()},resources:{handler(t){setTimeout((()=>this.addItems(t)));V.resourceDialogService.clearMainResourcesCache()},deep:true},selectedTypes:{handler(){this.updateItems()},deep:true},isLoaded(){this.tryShowAhaMoment()}},components:{DialogHeader:Oi,DialogFooter:Di,ResourceWorkload:Ti},template:`\n\t\t<div\n\t\t\tclass="booking-booking-select-resources"\n\t\t\t:class="{'--disabled': isFilterMode}"\n\t\t\tdata-element="booking-select-resources"\n\t\t\tref="button"\n\t\t\t@click="showDialog"\n\t\t>\n\t\t\t<div class="ui-icon-set --funnel"></div>\n\t\t</div>\n\t\t<DialogHeader\n\t\t\tref="dialogHeader"\n\t\t\tv-model="selectedTypes"\n\t\t\t@search="search"\n\t\t\t@startResize="startResize"\n\t\t\t@endResize="endResize"\n\t\t\t@selectAll="selectAll"\n\t\t\t@deselectAll="deselectAll"\n\t\t/>\n\t\t<DialogFooter\n\t\t\tv-show="dialogFilled && !isDefaultState"\n\t\t\tref="dialogFooter"\n\t\t\t@reset="reset"\n\t\t/>\n\t\t<div class="booking-booking-select-resources-workload-container">\n\t\t\t<template v-for="resource of resources">\n\t\t\t\t<span class="booking-booking-select-resources-workload" :ref="(el) => setWorkloadRef(el, resource.id)">\n\t\t\t\t\t<ResourceWorkload :resourceId="resource.id"/>\n\t\t\t\t</span>\n\t\t\t</template>\n\t\t</div>\n\t`};const $i={computed:mt.mapGetters({resourcesIds:`${Bt.Model.Interface}/resourcesIds`,scroll:`${Bt.Model.Interface}/scroll`,isEditingBookingMode:`${Bt.Model.Interface}/isEditingBookingMode`}),watch:{scroll(t){this.$refs.inner.scrollLeft=t}},components:{Resource:Mi,AddResourceButton:Ei,SelectResources:Pi},template:`\n\t\t<div class="booking-booking-header">\n\t\t\t<SelectResources/>\n\t\t\t<div\n\t\t\t\tclass="booking-booking-header-inner"\n\t\t\t\tref="inner"\n\t\t\t\t@scroll="$store.dispatch('interface/setScroll', $refs.inner.scrollLeft)"\n\t\t\t>\n\t\t\t\t<TransitionGroup name="booking-transition-resource">\n\t\t\t\t\t<template v-for="resourceId of resourcesIds" :key="resourceId">\n\t\t\t\t\t\t<Resource :resourceId="resourceId"/>\n\t\t\t\t\t</template>\n\t\t\t\t</TransitionGroup>\n\t\t\t\t<AddResourceButton v-if="!isEditingBookingMode"/>\n\t\t\t</div>\n\t\t</div>\n\t`};const Ri={emits:["change"],props:{resourceId:{type:Number,required:true}},data(){return{isSelected:false,selectedItems:[]}},mounted(){this.selector=this.createSelector()},unmounted(){this.selector.destroy();this.selector=null},methods:{createSelector(){var t;const e=(t=this.intersections[this.resourceId])!=null?t:[];return new ot.Dialog({id:`booking-intersection-selector-resource-${this.resourceId}`,targetNode:this.$refs.intersectionField,preselectedItems:e.map((t=>[Bt.EntitySelectorEntity.Resource,t])),width:400,enableSearch:true,dropdownMode:true,context:"bookingResourceIntersection",multiple:true,cacheable:true,showAvatars:false,entities:[{id:Bt.EntitySelectorEntity.Resource,dynamicLoad:true,dynamicSearch:true}],searchOptions:{allowCreateItem:false,footerOptions:{label:this.loc("BOOKING_BOOKING_ADD_INTERSECTION_DIALOG_SEARCH_FOOTER")}},events:{onHide:this.changeSelected.bind(this),onLoad:this.changeSelected.bind(this)}})},showSelector(){if(this.isFeatureEnabled){this.selector.show()}else{void it.limit.show()}},changeSelected(){this.selectedItems=this.selector.getSelectedItems();this.isSelected=this.selectedItems.length>0;const t=this.selectedItems.map((t=>t.id));this.$emit("change",t,this.resourceId)},handleRemove(t){this.selector.getItem([Bt.EntitySelectorEntity.Resource,t]).deselect();this.changeSelected()}},computed:{...mt.mapGetters({intersections:`${Bt.Model.Interface}/intersections`,isFeatureEnabled:`${Bt.Model.Interface}/isFeatureEnabled`,resources:`${Bt.Model.Resources}/get`}),resourcesIds(){return this.resources.map((({id:t})=>t))},firstItemTitle(){return this.selectedItems.length>0?this.selectedItems[0].title:""},remainingItemsCount(){return this.selectedItems.length>1?this.selectedItems.length-1:0}},watch:{resourcesIds(t,e){if(t.join(",")===e.join(",")){return}const o=e.filter((e=>!t.includes(e)));const i=t.filter((t=>!e.includes(t)));o.forEach((t=>{const e=this.selector.getItem([Bt.EntitySelectorEntity.Resource,t]);this.selector.removeItem(e)}));i.forEach((t=>{const e=this.$store.getters[`${Bt.Model.Resources}/getById`](t);if(!e||e.isDeleted){return}const o=this.$store.getters[`${Bt.Model.ResourceTypes}/getById`](e.typeId);this.selector.addItem({id:t,entityId:Bt.EntitySelectorEntity.Resource,title:e.name,subtitle:o.name,tabs:Bt.EntitySelectorTab.Recent})}));this.changeSelected()},resources:{handler(){this.selector.getItems().forEach((t=>{const e=this.$store.getters[`${Bt.Model.Resources}/getById`](t.getId());if(!e){return}const o=this.$store.getters[`${Bt.Model.ResourceTypes}/getById`](e.typeId);t.setTitle(e.name);t.setSubtitle(o.name)}));this.selector.getTagSelector().getTags().forEach((t=>{const e=this.$store.getters[`${Bt.Model.Resources}/getById`](t.getId());if(!e){return}t.setTitle(e.name);t.render()}));this.selectedItems=this.selector.getSelectedItems()},deep:true}},template:`\n\t\t<div\n\t\t\tref="intersectionField"\n\t\t\tclass="booking-booking-intersections-resource"\n\t\t\t:data-id="'booking-booking-intersections-resource-' + resourceId"\n\t\t>\n\t\t\t<template v-if="isSelected">\n\t\t\t\t<div\n\t\t\t\t\tref="selectorItemContainer"\n\t\t\t\t\tclass="booking-booking-intersections-resource-container"\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="selectedItems.length > 0"\n\t\t\t\t\t\tclass="bbi-resource-selector-item bbi-resource-selector-tag"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div class="bbi-resource-selector-tag-content" :title="firstItemTitle">\n\t\t\t\t\t\t\t<div class="bbi-resource-selector-tag-title">{{ firstItemTitle }}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div \n\t\t\t\t\t\t\tclass="bbi-resource-selector-tag-remove"\n\t\t\t\t\t\t\t@click="handleRemove(selectedItems[0].id)"\n\t\t\t\t\t\t\t:data-id="'bbi-resource-selector-tag-remove-' + resourceId"\n\t\t\t\t\t\t></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="remainingItemsCount > 0"\n\t\t\t\t\t\tclass="bbi-resource-selector-item bbi-resource-selector-tag --count"\n\t\t\t\t\t\t@click="showSelector"\n\t\t\t\t\t\t:data-id="'bbi-resource-selector-tag-count-' + resourceId"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div class="bbi-resource-selector-tag-content">\n\t\t\t\t\t\t\t<div class="bbi-resource-selector-tag-title --count">+{{ remainingItemsCount }}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<span\n\t\t\t\t\t\t\tclass="bbi-resource-selector-item bbi-resource-selector-add-button"\n\t\t\t\t\t\t\t@click="showSelector"\n\t\t\t\t\t\t\t:data-id="'bbi-resource-selector-add-button' + resourceId"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<span class="bbi-resource-selector-add-button-caption">\n\t\t\t\t\t\t\t\t{{ loc('BOOKING_BOOKING_INTERSECTION_BUTTON_MORE') }}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t\t<template v-else>\n\t\t\t\t<span\n\t\t\t\t\tref="selectorButton"\n\t\t\t\t\tclass="bbi-resource-selector-item bbi-resource-selector-add-button"\n\t\t\t\t\t@click="showSelector"\n\t\t\t\t\t:data-id="'bbi-resource-selector-add-button' + resourceId"\n\t\t\t\t>\n\t\t\t\t\t<span class="bbi-resource-selector-add-button-caption">\n\t\t\t\t\t\t{{ loc('BOOKING_BOOKING_INTERSECTION_BUTTON_MSGVER_1') }}\n\t\t\t\t\t</span>\n\t\t\t\t</span>\n\t\t\t</template>\n\t\t</div>\n\t`};const _i={emits:["change"],created(){this.selector=this.createSelector();if(!this.isFeatureEnabled){this.selector.lock()}},mounted(){this.mountSelector();ht.Event.EventEmitter.subscribe("BX.Main.Popup:onAfterClose",this.tryShowAhaMoment);ht.Event.EventEmitter.subscribe("BX.Main.Popup:onDestroy",this.tryShowAhaMoment)},beforeUnmount(){this.destroySelector()},computed:{...mt.mapGetters({isEditingBookingMode:`${Bt.Model.Interface}/isEditingBookingMode`,intersections:`${Bt.Model.Interface}/intersections`,isLoaded:`${Bt.Model.Interface}/isLoaded`,isFeatureEnabled:`${Bt.Model.Interface}/isFeatureEnabled`,resources:`${Bt.Model.Resources}/get`}),resourcesIds(){return this.resources.map((({id:t})=>t))}},methods:{createSelector(){return new ot.TagSelector({multiple:true,addButtonCaption:this.loc("BOOKING_BOOKING_ADD_INTERSECTION_MSGVER_1"),showCreateButton:false,maxHeight:50,dialogOptions:{header:this.loc("BOOKING_BOOKING_ADD_INTERSECTION_DIALOG_HEADER"),context:"bookingResourceIntersection",width:290,height:340,dropdownMode:true,enableSearch:true,cacheable:true,showAvatars:false,entities:[{id:Bt.EntitySelectorEntity.Resource,dynamicLoad:true,dynamicSearch:true}],searchOptions:{allowCreateItem:false,footerOptions:{label:this.loc("BOOKING_BOOKING_ADD_INTERSECTION_DIALOG_SEARCH_FOOTER")}}},events:{onAfterTagAdd:this.onSelectorChange,onAfterTagRemove:this.onSelectorChange}})},onSelectorChange(){const t=this.selector.getDialog().getSelectedItems().map((({id:t})=>t));this.$emit("change",t)},mountSelector(){this.selector.renderTo(this.$refs.intersectionField)},destroySelector(){this.selector.getDialog().destroy();this.selector=null;this.$refs.intersectionField.innerHTML=""},getResource(t){return this.$store.getters["resources/getById"](t)},getResourceType(t){return this.$store.getters["resourceTypes/getById"](t)},tryShowAhaMoment(){if(bt.ahaMoments.shouldShow(Bt.AhaMoment.ResourceIntersection)&&this.selector){ht.Event.EventEmitter.unsubscribe("BX.Main.Popup:onAfterClose",this.tryShowAhaMoment);ht.Event.EventEmitter.unsubscribe("BX.Main.Popup:onDestroy",this.tryShowAhaMoment);void this.showAhaMoment()}},async showAhaMoment(){await bt.ahaMoments.show({id:"booking-resource-intersection",title:this.loc("BOOKING_AHA_RESOURCE_INTERSECTION_TITLE"),text:this.loc("BOOKING_AHA_RESOURCE_INTERSECTION_TEXT"),article:Bt.HelpDesk.AhaResourceIntersection,target:this.selector.getAddButton()});bt.ahaMoments.setShown(Bt.AhaMoment.ResourceIntersection)},click(){if(!this.isFeatureEnabled){void it.limit.show()}}},watch:{intersections(t){var e;if(!this.isEditingBookingMode){return}const o=(e=t[0])!=null?e:[];o.forEach((t=>{const e=this.getResource(t);this.selector.getDialog().addItem({id:e.id,entityId:Bt.EntitySelectorEntity.Resource,title:e.name,subtitle:this.getResourceType(e.typeId).name,selected:true})}))},isLoaded(){this.tryShowAhaMoment()},resourcesIds(t,e){if(t.join(",")===e.join(",")){return}const o=e.filter((e=>!t.includes(e)));const i=t.filter((t=>!e.includes(t)));o.forEach((t=>{const e=this.selector.getDialog().getItem([Bt.EntitySelectorEntity.Resource,t]);this.selector.getDialog().removeItem(e);const o=this.selector.getTags().find((e=>e.getId()===t));o==null?void 0:o.remove()}));i.forEach((t=>{const e=this.$store.getters[`${Bt.Model.Resources}/getById`](t);if(!e||e.isDeleted){return}const o=this.$store.getters[`${Bt.Model.ResourceTypes}/getById`](e.typeId);this.selector.getDialog().addItem({id:t,entityId:Bt.EntitySelectorEntity.Resource,title:e.name,subtitle:o.name,tabs:Bt.EntitySelectorTab.Recent})}));this.onSelectorChange();this.tryShowAhaMoment()},resources:{handler(){this.selector.getDialog().getItems().forEach((t=>{const e=this.$store.getters[`${Bt.Model.Resources}/getById`](t.getId());if(!e){return}const o=this.$store.getters[`${Bt.Model.ResourceTypes}/getById`](e.typeId);t.setTitle(e.name);t.setSubtitle(o.name)}));this.selector.getTags().forEach((t=>{const e=this.$store.getters[`${Bt.Model.Resources}/getById`](t.getId());if(!e){return}t.setTitle(e.name);t.render()}))},deep:true}},template:`\n\t\t<div\n\t\t\tref="intersectionField"\n\t\t\tclass="booking-booking-intersections-line"\n\t\t\tdata-id="booking-booking-intersections-line"\n\t\t\t@click="click"\n\t\t></div>\n\t`};const Ni={components:{Icon:Z.BIcon,Multiple:Ri,Single:_i},data(){return{IconSet:Z.Set,intersectionModeMenuItemId:"booking-intersection-menu-mode"}},mounted(){this.menu=ft.MenuManager.create("booking-intersection-menu",this.$refs.intersectionMenu,this.getMenuItems(),{closeByEsc:true,autoHide:true,cacheable:true})},unmounted(){this.menu.destroy();this.menu=null},methods:{showMenu(){if(this.isFeatureEnabled){this.menu.show()}else{void it.limit.show()}},getMenuItems(){return[this.getIntersectionForAllItem(),{delimiter:true},this.getHelpDeskItem()]},getIntersectionForAllItem(){return{id:this.intersectionModeMenuItemId,dataset:{id:this.intersectionModeMenuItemId},text:this.loc("BOOKING_BOOKING_INTERSECTION_MENU_ALL"),className:this.isIntersectionForAll?"menu-popup-item menu-popup-item-accept":"menu-popup-item menu-popup-no-icon",onclick:()=>{this.menu.close();const t=!this.isIntersectionForAll;void this.$store.dispatch(`${Bt.Model.Interface}/setIntersectionMode`,t);void J.optionService.setBool(Bt.Option.IntersectionForAll,t)}}},getHelpDeskItem(){return{id:"booking-intersection-menu-info",dataset:{id:"booking-intersection-menu-info"},text:this.loc("BOOKING_BOOKING_INTERSECTION_MENU_HOW"),onclick:()=>{tt.helpDesk.show(Bt.HelpDesk.Intersection.code,Bt.HelpDesk.Intersection.anchorCode)}}},async showIntersections(t,e=0){const o={...e===0?{}:this.intersections,[e]:t};await this.$store.dispatch(`${Bt.Model.Interface}/setIntersections`,o);await et.busySlots.loadBusySlots()},toggleMenuItemActivityState(t){ht.Dom.toggleClass(t.getContainer(),"menu-popup-item-accept");ht.Dom.toggleClass(t.getContainer(),"menu-popup-no-icon")},updateScroll(){if(this.$refs.inner){this.$refs.inner.scrollLeft=this.scroll}}},watch:{async isIntersectionForAll(){await this.$store.dispatch(`${Bt.Model.Interface}/setIntersections`,{});this.updateScroll();await et.busySlots.loadBusySlots();this.toggleMenuItemActivityState(this.menu.getMenuItem(this.intersectionModeMenuItemId))},scroll(){this.updateScroll()}},computed:{...mt.mapGetters({resourcesIds:`${Bt.Model.Interface}/resourcesIds`,isFilterMode:`${Bt.Model.Filter}/isFilterMode`,isEditingBookingMode:`${Bt.Model.Interface}/isEditingBookingMode`,intersections:`${Bt.Model.Interface}/intersections`,isIntersectionForAll:`${Bt.Model.Interface}/isIntersectionForAll`,scroll:`${Bt.Model.Interface}/scroll`,isLoaded:`${Bt.Model.Interface}/isLoaded`,isFeatureEnabled:`${Bt.Model.Interface}/isFeatureEnabled`}),hasIntersections(){return Object.values(this.intersections).some((t=>t.length>0))},disabled(){return!this.isLoaded||this.isFilterMode||this.isEditingBookingMode}},template:`\n\t\t<div class="booking-booking-intersections" :class="{'--disabled': disabled}">\n\t\t\t<div\n\t\t\t\tref="intersectionMenu"\n\t\t\t\tclass="booking-booking-intersections-left-panel"\n\t\t\t\t:class="{'--active': hasIntersections}"\n\t\t\t\t@click="showMenu"\n\t\t\t\tdata-id="booking-intersections-left-panel-menu"\n\t\t\t>\n\t\t\t\t<div class="ui-icon-set --double-rhombus"></div>\n\t\t\t\t<div v-if="!isFeatureEnabled" class="booking-lock-icon-container">\n\t\t\t\t\t<Icon :name="IconSet.LOCK"/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<Single v-if="isIntersectionForAll" @change="showIntersections"/>\n\t\t\t<template v-else>\n\t\t\t\t<div\n\t\t\t\t\tref="inner"\n\t\t\t\t\tclass="booking-booking-intersections-inner"\n\t\t\t\t\t@scroll="$store.dispatch('interface/setScroll', $refs.inner.scrollLeft)"\n\t\t\t\t>\n\t\t\t\t\t<div class="booking-booking-intersections-row">\n\t\t\t\t\t\t<div class="booking-booking-intersections-row-inner">\n\t\t\t\t\t\t\t<template v-for="resourceId of resourcesIds" :key="resourceId">\n\t\t\t\t\t\t\t\t<Multiple :resourceId="resourceId" @change="showIntersections"/>\n\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="booking-booking-intersections-inner-blank"></div>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t</div>\n\t`};const Ai={data(){return{DateTimeFormat:at.DateTimeFormat}},computed:mt.mapGetters({fromHour:"interface/fromHour",toHour:"interface/toHour",zoom:"interface/zoom"}),components:{Header:$i,Intersections:Ni,Grid:hi},template:`\n\t\t<div\n\t\t\tid="booking-content"\n\t\t\tclass="booking --ui-context-content-light"\n\t\t\t:style="{\n\t\t\t\t'--from-hour': fromHour,\n\t\t\t\t'--to-hour': toHour,\n\t\t\t\t'--zoom': zoom,\n\t\t\t}"\n\t\t\t:class="{\n\t\t\t\t'--zoom-is-less-than-07': zoom < 0.7,\n\t\t\t\t'--zoom-is-less-than-08': zoom < 0.8,\n\t\t\t\t'--am-pm-mode': DateTimeFormat.isAmPmMode(),\n\t\t\t}"\n\t\t>\n\t\t\t<Header/>\n\t\t\t<Intersections/>\n\t\t\t<Grid/>\n\t\t</div>\n\t`};const Hi={name:"BookingMultipleButton",emits:["book"],props:{fetching:Boolean},computed:{text(){return this.loc("BOOKING_MULTI_BUTTON_LABEL")},size(){return Tt.ButtonSize.SMALL},color(){return Tt.ButtonColor.SUCCESS}},components:{UiButton:Tt.Button},template:`\n\t\t<UiButton\n\t\t\t:text\n\t\t\t:size\n\t\t\t:color\n\t\t\t:waiting="fetching"\n\t\t\t@click="$emit('book')"\n\t\t/>\n\t`};const zi={name:"MultiBookingItem",components:{UiButton:Tt.Button},emits:["remove-selected"],props:{id:{type:String,required:true},fromTs:{type:Number,required:true},toTs:{type:Number,required:true},resourceId:{type:Number,required:true}},computed:{...mt.mapGetters({offset:`${Bt.Model.Interface}/offset`}),label(){return this.loc("BOOKING_MULTI_ITEM_TITLE",{"#DATE#":at.DateTimeFormat.format("d M H:i",(this.fromTs+this.offset)/1e3),"#DURATION#":new lt.Duration(this.toTs-this.fromTs).format()})},buttonColor(){return Tt.ButtonColor.LINK},buttonSize(){return Tt.ButtonSize.EXTRA_SMALL}},template:`\n\t\t<div class="booking--multi-booking--book">\n\t\t\t<label>\n\t\t\t\t{{ label }}\n\t\t\t</label>\n\t\t\t<button\n\t\t\t\t:class="[buttonSize, buttonColor, 'ui-btn ui-icon-set --cross-20']"\n\t\t\t\ttype="button"\n\t\t\t\t@click="$emit('remove-selected', this.id)">\n\t\t\t</button>\n\t\t</div>\n\t`};const Gi={name:"MultiBookingItemsList",components:{MultiBookingItem:zi},emits:["remove-selected"],computed:{selectedCells(){return this.$store.getters[`${Bt.Model.Interface}/selectedCells`]},selectedCellsCount(){return Object.keys(this.selectedCells).length}},mounted(){this.ears=new rt.Ears({container:this.$refs.wrapper,smallSize:true,className:"booking--multi-booking--items-ears",noScrollbar:true}).init()},watch:{selectedCellsCount:{handler(){setTimeout((()=>this.ears.toggleEars()),0)}}},template:`\n\t\t<div class="booking--multi-booking--book-list">\n\t\t\t<div ref="wrapper" class="booking--multi-booking--books-wrapper">\n\t\t\t\t<MultiBookingItem\n\t\t\t\t\tv-for="cell in selectedCells"\n\t\t\t\t\t:key="cell.id"\n\t\t\t\t\t:id="cell.id"\n\t\t\t\t\t:from-ts="cell.fromTs"\n\t\t\t\t\t:to-ts="cell.toTs"\n\t\t\t\t\t:resource-id="cell.resourceId"\n\t\t\t\t\t@remove-selected="$emit('remove-selected', $event)"/>\n\t\t\t</div>\n\t\t</div>\n\t`};const xi={name:"AddClientButton",emits:["update:model-value"],props:{modelValue:{type:Array,required:true}},data(){return{isPopupShown:false}},computed:{...mt.mapGetters({getByClientData:`${Bt.Model.Clients}/getByClientData`}),color(){return Tt.ButtonColor.LINK},size(){return Tt.ButtonSize.EXTRA_SMALL},label(){var t;if(this.modelValue.length===0){return this.loc("BOOKING_MULTI_CLIENT")}return this.loc("BOOKING_MULTI_CLIENT_WHIT_NAME",{"#NAME#":((t=this.modelValue.find((t=>t.name)))==null?void 0:t.name)||""})},currentClient(){if(this.modelValue.length===0){return null}return{contact:this.findClientByType(Bt.CrmEntity.Contact),company:this.findClientByType(Bt.CrmEntity.Company)}}},methods:{createClients(t){const e=t.map((t=>this.getByClientData(t)));this.$emit("update:model-value",e)},findClientByType(t){return this.modelValue.find((({type:e})=>e.code===t))}},components:{ClientPopup:dt.ClientPopup},template:`\n\t\t<button\n\t\t\t:class="['ui-btn', 'booking--multi-booking--client-button', color, size]"\n\t\t\ttype="button"\n\t\t\tref="button"\n\t\t\t@click="isPopupShown = !isPopupShown"\n\t\t>\n\t\t\t<i class="ui-icon-set --customer-card"></i>\n\t\t\t<span>{{ label }}</span>\n\t\t</button>\n\t\t<ClientPopup\n\t\t\tv-if="isPopupShown"\n\t\t\t:bind-element="$refs.button"\n\t\t\t:currentClient\n\t\t\t@create="createClients"\n\t\t\t@close="isPopupShown = false"/>\n\t`};const Ki={name:"CancelButton",emits:["click"],setup(){return{color:Tt.ButtonColor.LINK,size:Tt.ButtonSize.EXTRA_SMALL}},template:`\n\t\t<button\n\t\t\t:class="['ui-btn', 'booking--multi-booking--cancel-button', color, size]"\n\t\t\ttype="button"\n\t\t\tref="button"\n\t\t\t@click="$emit('click')"\n\t\t>\n\t\t\t<i\n\t\t\t\tclass="ui-icon-set --cross-25"\n\t\t\t\tstyle="--ui-icon-set__icon-base-color: rgba(var(--ui-color-palette-white-base-rgb), 0.3);--ui-icon-set__icon-size: var(--ui-size-2xl)"></i>\n\t\t</button>\n\t`};const Wi={name:"MultiBooking",data(){return{fetching:false,clients:[],externalData:[]}},async beforeMount(){this.clients=[];this.externalData=[];if(this.embedItems.length===0){return}const t=this.embedItems.find((t=>t.entityTypeId===Bt.CrmEntity.Contact));const e=this.embedItems.find((t=>t.entityTypeId===Bt.CrmEntity.Company));const o=this.embedItems.find((t=>t.entityTypeId===Bt.CrmEntity.Deal));if(t){const e=await nt.clientService.getContactById(Number(t.value));if(e){this.clients.push(e)}}if(e){const t=await nt.clientService.getCompanyById(Number(e.value));if(t){this.clients.push(t)}}if(o){this.externalData.push(o)}},computed:{...mt.mapGetters({selectedCells:`${Bt.Model.Interface}/selectedCells`,timezone:`${Bt.Model.Interface}/timezone`,embedItems:`${Bt.Model.Interface}/embedItems`,intersections:`${Bt.Model.Interface}/intersections`})},methods:{removeSelected(t){if(Object.hasOwnProperty.call(this.selectedCells,t)){this.$store.dispatch(`${Bt.Model.Interface}/removeSelectedCell`,this.selectedCells[t])}},async book(){const t=this.getBookings();if(t.length===0){return}this.fetching=true;const e=await st.bookingService.addList(t);ct.BookingAnalytics.sendAddMultiBookings(e.map((({id:t})=>t)));this.fetching=false;this.showNotification(e);await this.closeMultiBooking()},getBookings(){return Object.values(this.selectedCells).map((t=>{var e,o;return{id:`tmp-id-${Date.now()}-${Math.random()}`,dateFromTs:t.fromTs,dateToTs:t.toTs,resourcesIds:[...new Set([t.resourceId,...(e=this.intersections[0])!=null?e:[],...(o=this.intersections[t.resourceId])!=null?o:[]])],timezoneFrom:this.timezone,timezoneTo:this.timezone,externalData:this.externalData,clients:this.clients}}))},showNotification(t){const e=t.length;const o=BX.UI.Notification.Center.notify({id:ht.Text.getRandom(),content:ht.Loc.getMessagePlural("BOOKING_MULTI_CREATED",e,{"#QUANTITY#":e}),actions:[{title:this.loc("BOOKING_MULTI_CREATED_CANCEL"),events:{click:()=>this.reset(t,o)}}]})},async reset(t,e){await st.bookingService.deleteList(t.map((({id:t})=>t)));e==null?void 0:e.close()},async closeMultiBooking(){await this.$store.dispatch(`${Bt.Model.Interface}/clearSelectedCells`)}},components:{BookingMultipleButton:Hi,MultiBookingItemsList:Gi,AddClientButton:xi,CancelButton:Ki},template:`\n\t\t<Teleport to="#uiToolbarContainer" defer>\n\t\t\t<div class="booking--multi-booking--bar">\n\t\t\t\t<BookingMultipleButton :fetching @book="book"/>\n\t\t\t\t<MultiBookingItemsList @remove-selected="removeSelected"/>\n\t\t\t\t<div class="booking--multi-booking--divider-vertical"></div>\n\t\t\t\t<AddClientButton v-model="clients"/>\n\t\t\t\t<div class="booking--multi-booking--space"></div>\n\t\t\t\t<div class="booking--multi-booking--close">\n\t\t\t\t\t<div class="booking--multi-booking--divider-vertical"></div>\n\t\t\t\t\t<CancelButton @click="closeMultiBooking"/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</Teleport>\n\t`};const Ui={data(){return{isBannerShown:false,bannerComponent:null}},computed:{...mt.mapGetters({canTurnOnDemo:`${Bt.Model.Interface}/canTurnOnDemo`})},mounted(){if(bt.ahaMoments.shouldShow(Bt.AhaMoment.Banner)){void this.showBanner()}},methods:{async showBanner(){pt.BannerDispatcher.critical.toQueue((async t=>{const{PromoBanner:e}=await ht.Runtime.loadExtension("booking.component.promo-banner");this.bannerComponent=vt.shallowRef(e);this.isBannerShown=true;this.setShown();this.bannerClosed=new gt.Resolvable;await this.bannerClosed;t()}))},closeBanner(){this.isBannerShown=false;this.bannerClosed.resolve()},setShown(){bt.ahaMoments.setShown(Bt.AhaMoment.Banner);ct.BannerAnalytics.sendShowPopup()},buttonClick(){ct.BannerAnalytics.sendClickEnable()}},template:`\n\t\t<component\n\t\t\tv-if="isBannerShown"\n\t\t\t:is="bannerComponent"\n\t\t\t:canTurnOnDemo="canTurnOnDemo"\n\t\t\t@buttonClick="buttonClick"\n\t\t\t@close="closeBanner"\n\t\t/>\n\t`};const qi={data(){return{isBannerShown:false,bannerComponent:null}},watch:{isShownTrialPopup(){if(bt.ahaMoments.shouldShow(Bt.AhaMoment.TrialBanner)){if(!ut.AutoLauncher.isEnabled()){ut.AutoLauncher.enable()}void this.showBanner()}}},computed:{...mt.mapGetters({isShownTrialPopup:`${Bt.Model.Interface}/isShownTrialPopup`})},methods:{async showBanner(){pt.BannerDispatcher.critical.toQueue((async t=>{const{TrialBanner:e}=await ht.Runtime.loadExtension("booking.component.trial-banner");this.bannerComponent=vt.shallowRef(e);this.isBannerShown=true;this.bannerClosed=new gt.Resolvable;await this.bannerClosed;t()}))},closeBanner(){this.isBannerShown=false;bt.ahaMoments.setShown(Bt.AhaMoment.TrialBanner);this.bannerClosed.resolve()}},template:`\n\t\t<component v-if="isBannerShown" :is="bannerComponent" @close="closeBanner"/>\n\t`};const Xi={name:"CrmFormsPopupLayout",components:{HelpDeskLoc:kt.HelpDeskLoc},setup(){const t=Bt.HelpDesk.CrmFormsPopup;return{helpDesk:t}},template:`\n\t\t<div class="booking--booking--crm-forms-popup__wrapper">\n\t\t\t<div class="booking--booking--crm-forms-popup__header">\n\t\t\t\t<span class="booking--booking--crm-forms-popup__header-title">\n\t\t\t\t\t{{ loc('BOOKING_OPEN_CRM_FORMS_POPUP_TITLE') }}\n\t\t\t\t</span>\n\t\t\t\t<div class="booking--booking--crm-forms-popup__header-description">\n\t\t\t\t\t<HelpDeskLoc\n\t\t\t\t\t\t:message="loc('BOOKING_OPEN_CRM_FORMS_POPUP_DESCRIPTION')"\n\t\t\t\t\t\t:code="helpDesk.code"\n\t\t\t\t\t\t:anchor="helpDesk.anchorCode"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="booking--booking--crm-forms-popup__toolbar">\n\t\t\t\t<slot name="toolbar"/>\n\t\t\t</div>\n\t\t\t<div class="booking--booking-crm-forms-popup__list-wrapper">\n\t\t\t\t<slot/>\n\t\t\t</div>\n\t\t\t<div class="booking--booking-crm-forms-popup__footer">\n\t\t\t\t<slot name="footer"/>\n\t\t\t</div>\n\t\t</div>\n\t`};const Vi={name:"CrmFormItemSkeleton",template:`\n\t\t<div class="booking--booking--crm-forms-popup--item-skeleton">\n\t\t\t<div class="booking--booking--crm-forms-popup--item-skeleton__circle"></div>\n\t\t\t<div class="booking--booking--crm-forms-popup--item-skeleton__line"></div>\n\t\t\t<div class="booking--booking--crm-forms-popup--item-skeleton__space"></div>\n\t\t\t<div class="booking--booking--crm-forms-popup--item-skeleton__line --thin"></div>\n\t\t\t<div class="booking--booking--crm-forms-popup--item-skeleton__circle"></div>\n\t\t</div>\n\t`};const ji={name:"CrmFormListEmpty",components:{CrmFormItemSkeleton:Vi},template:`\n\t\t<CrmFormItemSkeleton v-for="i in 4" :key="i"/>\n\t\t<div class="booking--booking--crm-forms-popup--list__placeholder-bg"></div>\n\t\t<div class="booking--booking--crm-forms-popup--list__placeholder">\n\t\t\t<span>{{ loc('BOOKING_OPEN_CRM_FORMS_POPUP_FORMS_LIST_PLACEHOLDER') }}</span>\n\t\t</div>\n\t`};function Yi(t,{slots:e}){if(t.canEdit&&t.editUrl){return vt.h("a",{href:t.editUrl,target:"_blank"},e.default())}return e.default()}const Zi=["canEdit","editUrl"];Yi.props=Zi;const Qi={name:"CrmFormsListItem",components:{CrmFormsListItemNameLink:Yi},props:{item:{type:Object,required:true},canEdit:Boolean},setup(){return{AirButtonStyle:Tt.AirButtonStyle}},data(){return{copedPopupTimeoutId:null}},methods:{copyLink(){if(!BX.clipboard.isCopySupported()){return}BX.clipboard.copy(this.item.publicUrl);this.showCopedPopup()},showCopedPopup(){var t;(t=this.popup)==null?void 0:t.destroy();this.popup=new BX.PopupWindow(`booking_open_crm_forms_popup_item_${this.item.id}_clipboard_copy`,this.$refs.copy,{content:this.loc("BOOKING_OPEN_CRM_FORMS_POPUP_FORMS_LIST_ITEM_LINK_COPED"),darkMode:true,autoHide:true,zIndex:1e3,angle:true,offsetLeft:20,bindOptions:{position:"top"}});this.popup.show();this.copedPopupTimeoutId=setTimeout((()=>{var t;this.popup.close();(t=this.popup)==null?void 0:t.destroy()}),1200)}},template:`\n\t\t<div class="booking--booking--crm-forms-popup--item">\n\t\t\t<div class="ui-icon-set --o-form booking--booking--crm-forms-popup--item__icon"></div>\n\t\t\t<div\n\t\t\t\tclass="booking--booking--crm-forms-popup--item__name"\n\t\t\t\t:title="item.name"\n\t\t\t>\n\t\t\t\t<CrmFormsListItemNameLink :canEdit :editUrl="item.editUrl">\n\t\t\t\t\t<span>{{ item.name }}</span>\n\t\t\t\t</CrmFormsListItemNameLink>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tref="copy"\n\t\t\t\t:class="['booking--booking--crm-forms-popup--item__copy-btn', AirButtonStyle.OUTLINE_NO_ACCENT]"\n\t\t\t\trole="button"\n\t\t\t\ttabindex="0"\n\t\t\t\t@click="copyLink"\n\t\t\t>\n\t\t\t\t{{ loc('BOOKING_OPEN_CRM_FORMS_POPUP_FORMS_LIST_ITEM_COPY_LINK_BUTTON_LABEL') }}\n\t\t\t\t<div class="ui-icon-set --o-copy booking--booking--crm-forms-popup--item__copy-btn-icon"></div>\n\t\t\t</div>\n\t\t</div>\n\t`};const Ji={name:"CrmFormsList",components:{CrmFormListEmpty:ji,CrmFormsListItem:Qi},computed:{canEdit(){return this.$store.state[Bt.Model.FormsMenu].canEdit},formList(){return this.$store.getters[`${Bt.Model.FormsMenu}/formList`]}},template:`\n\t\t<div class="booking--booking--crm-forms-popup--list__container">\n\t\t\t<div class="booking--booking--crm-forms-popup--list-items">\n\t\t\t\t<template v-if="formList.length === 0">\n\t\t\t\t\t<CrmFormListEmpty />\n\t\t\t\t</template>\n\t\t\t\t<template v-else>\n\t\t\t\t\t<CrmFormsListItem\n\t\t\t\t\t\tv-for="item in formList"\n\t\t\t\t\t\t:key="item.id"\n\t\t\t\t\t\t:item="item"\n\t\t\t\t\t\t:canEdit\n\t\t\t\t\t/>\n\t\t\t\t</template>\n\t\t\t</div>\n\t\t</div>\n\t`};const ts={name:"CrmFormsToolbar",template:`\n\t\t<div class="booking--booking--crm-forms-popup-sort">\n\t\t\t<span>{{ loc('BOOKING_OPEN_CRM_FORMS_POPUP_SORT_LATEST_CREATED_LABEL') }}</span>\n\t\t\t<div class="ui-icon-set --o-change-order-2 booking--booking--crm-forms-popup--sort-icon"></div>\n\t\t</div>\n\t`};const es={name:"AddCrmFormButton",components:{UiButton:Tt.Button},setup(){return{ButtonColor:Tt.ButtonColor,ButtonSize:Tt.ButtonSize,ButtonStyle:Tt.ButtonStyle}},computed:{createFormLink(){return this.$store.state[Bt.Model.FormsMenu].createFormLink},addBtnLabel(){return this.loc("BOOKING_OPEN_CRM_FORMS_POPUP_ADD_FORM_BUTTON_LABEL").replace("[plus]","+")}},template:`\n\t\t<a :href="createFormLink" target="_blank">\n\t\t\t<UiButton\n\t\t\t\t:text="addBtnLabel"\n\t\t\t\t:color="ButtonColor.LIGHT_BORDER"\n\t\t\t\t:size="ButtonSize.SMALL"\n\t\t\t\t:buttonClass="['--air', ButtonStyle.NO_CAPS]"\n\t\t\t/>\n\t\t</a>\n\t`};const os={name:"AllCrmFormsButton",components:{UiButton:Tt.Button},setup(){return{AirButtonStyle:Tt.AirButtonStyle,ButtonColor:Tt.ButtonColor,ButtonSize:Tt.ButtonSize,ButtonStyle:Tt.ButtonStyle}},template:`\n\t\t<a href="/crm/webform/" target="_blank">\n\t\t\t<UiButton\n\t\t\t\t:text="loc('BOOKING_OPEN_CRM_FORMS_POPUP_ALL_FORMS_BUTTON_LABEL')"\n\t\t\t\t:color="ButtonColor.LIGHT_BORDER"\n\t\t\t\t:size="ButtonSize.SMALL"\n\t\t\t\t:buttonClass="['--air', AirButtonStyle.OUTLINE_NO_ACCENT, ButtonStyle.NO_CAPS]"\n\t\t\t/>\n\t\t</a>\n\t`};const is={name:"CrmFormsPopup",components:{HelpDeskLoc:kt.HelpDeskLoc,Popup:It.Popup,CrmFormsList:Ji,CrmFormsPopupLayout:Xi,CrmFormsToolbar:ts,AddCrmFormButton:es,AllCrmFormsButton:os},props:{visible:{type:Boolean,default:false},bindElement:{type:HTMLElement,required:true}},emits:["update:visible"],computed:{config(){return{className:"booking--booking--crm-forms-popup",bindElement:this.bindElement,offsetTop:10,padding:24,minHeight:376,minWidth:488,maxWidth:500,bindOptions:{forceBindPosition:true,position:"bottom"},angle:{offset:this.bindElement.offsetWidth/2}}}},methods:{closePopup(){this.$emit("update:visible",false)}},template:`\n\t\t<Popup\n\t\t\tref="popup"\n\t\t\tid="booking-crm-forms-popup"\n\t\t\t:config\n\t\t\t@close="closePopup"\n\t\t>\n\t\t\t<CrmFormsPopupLayout>\n\t\t\t\t<template #toolbar>\n\t\t\t\t\t<CrmFormsToolbar />\n\t\t\t\t</template>\n\t\t\t\t<CrmFormsList />\n\t\t\t\t<template #footer>\n\t\t\t\t\t<div class="booking--booking--crm-forms-popup--footer-buttons-bar">\n\t\t\t\t\t\t<AllCrmFormsButton />\n\t\t\t\t\t\t<AddCrmFormButton />\n\t\t\t\t\t</div>\n\t\t\t\t</template>\n\t\t\t</CrmFormsPopupLayout>\n\t\t</Popup>\n\t`};const ss={name:"CrmFormsButton",components:{CrmFormsPopup:is,UiButton:Tt.Button},props:{container:{type:HTMLElement,required:true}},setup(){const t=vt.ref(false);const e=()=>{t.value=true};return{isPopupShown:t,AirButtonStyle:Tt.AirButtonStyle,ButtonColor:Tt.ButtonColor,ButtonSize:Tt.ButtonSize,ButtonStyle:Tt.ButtonStyle,openMenu:e}},computed:{label(){return this.loc("BOOKING_OPEN_CRM_FORMS_BUTTON_LABEL")}},mounted(){this.container.replaceWith(this.$refs.button.$el)},template:`\n\t\t<UiButton\n\t\t\tref="button"\n\t\t\t:buttonClass="['--air', ButtonStyle.NO_CAPS, AirButtonStyle.OUTLINE_NO_ACCENT]"\n\t\t\t:text="label"\n\t\t\t:color="ButtonColor.LIGHT_BORDER"\n\t\t\t:size="ButtonSize.SMALL"\n\t\t\t@click="openMenu"\n\t\t/>\n\t\t<CrmFormsPopup\n\t\t\tv-if="isPopupShown"\n\t\t\tv-model:visible="isPopupShown"\n\t\t\t:bindElement="$refs.button.$el"\n\t\t/>\n\t`};const ns={name:"BookingApp",components:{BaseComponent:Ai,AfterTitle:Yt,BookingFilter:Kt,CountersPanel:Ut,MultiBooking:Wi,Banner:Ui,Trial:qi,CrmFormsButton:ss,EmptyFilterResultsPopup:i.EmptyFilterResultsPopup},props:{afterTitleContainer:HTMLElement,counterPanelContainer:HTMLElement,settingsButtonContainer:HTMLElement,filterId:{type:String,required:true}},data(){return{loadingFilter:false,loader:new o.Loader}},computed:{...mt.mapGetters({selectedDateTs:`${Bt.Model.Interface}/selectedDateTs`,viewDateTs:`${Bt.Model.Interface}/viewDateTs`,isFilterMode:`${Bt.Model.Filter}/isFilterMode`,isDeletingResourceFilterMode:`${Bt.Model.Filter}/isDeletingResourceFilterMode`,deletingResource:`${Bt.Model.Filter}/deletingResource`,filteredBookingsIds:`${Bt.Model.Filter}/filteredBookingsIds`,selectedCells:`${Bt.Model.Interface}/selectedCells`,resourcesIds:`${Bt.Model.Favorites}/get`,extraResourcesIds:`${Bt.Model.Interface}/extraResourcesIds`,bookings:`${Bt.Model.Bookings}/get`,getBookingsByIds:`${Bt.Model.Bookings}/getByIds`,getFutureBookingsByResourceId:`${Bt.Model.Bookings}/getFutureByResourceId`,intersections:`${Bt.Model.Interface}/intersections`,editingBookingId:`${Bt.Model.Interface}/editingBookingId`,fetchingNextDate:`${Bt.Model.Filter}/fetchingNextDate`,datesCount:`${Bt.Model.Filter}/datesCount`,requestFields:`${Bt.Model.Filter}/requestFields`}),hasSelectedCells(){return Object.keys(this.selectedCells).length>0},editingBooking(){var t;return(t=this.$store.getters["bookings/getById"](this.editingBookingId))!=null?t:null}},watch:{selectedDateTs(){if(this.isFilterMode){void this.applyFilter()}else if(this.isDeletingResourceFilterMode){void this.applyDeletingResourceFilter(this.deletingResource)}else{void this.fetchPage(this.selectedDateTs/1e3)}},filteredBookingsIds(){if(this.isFilterMode){this.showResourcesWithBookings()}},isFilterMode(t){if(!t){void this.fetchPage(this.selectedDateTs/1e3)}},isDeletingResourceFilterMode(t){if(t){a.deletingResourceFilterResultCountActualizer.subscribe()}else{a.deletingResourceFilterResultCountActualizer.unsubscribe();void this.clearDeletingResourceFilter();void this.fetchPage(this.selectedDateTs/1e3)}},viewDateTs(){void this.updateMarks()},resourcesIds(t){if(this.isDeletingResourceFilterMode){if(t.includes(this.deletingResource.id)){this.$store.dispatch(`${Bt.Model.Interface}/setPinnedResourceIds`,[...t])}else{void this.clearDeletingResourceFilter()}}void this.updateMarks()},intersections(){void this.updateMarks()},editingBooking(t){var e,o;const i=(e=t==null?void 0:(o=t.resourcesIds)==null?void 0:o.slice(1))!=null?e:[];if(i.length>0){void this.$store.dispatch(`${Bt.Model.Interface}/setIntersections`,{0:i})}},fetchingNextDate(t){if(t){this.showLoader()}else{this.hideLoader()}},deletingResource(t){if(t!==null){void this.applyDeletingResourceFilter(t,true)}}},beforeMount(){f.mousePosition.init()},async mounted(){this.showLoader();Ht.setExpanded(true);this.addAfterTitle();ct.SectionAnalytics.sendOpenSection();await Promise.all([n.dictionaryService.fetchData(),this.fetchPage(this.editingBookingId>0?0:this.selectedDateTs/1e3)]);void this.$store.dispatch(`${Bt.Model.Interface}/setIsLoaded`,true)},beforeUnmount(){f.mousePosition.destroy()},methods:{async fetchPage(t=0){this.showLoader();await s.mainPageService.fetchData(t);if(this.extraResourcesIds.length>0){await V.resourceDialogService.loadByIds(this.extraResourcesIds,this.selectedDateTs/1e3)}this.hideLoader()},onActiveItem(t){if(this.ignoreConterPanel){return}const e=this.getFilterFieldsByCounterItem(t);this.$refs.filter.setFields(e)},getFilterFields(){const t=this.$refs.filter.getFields();if(this.isDeletingResourceFilterMode&&"RESOURCE"in t&&Object.keys(t).length===1){return{RESOURCE:this.$store.getters[`${Bt.Model.Interface}/resourcesIds`]}}return this.$refs.filter.getFields()},async applyFilter({fromFilter:t=false}={}){const e=this.$refs.filter.getFields();this.setCounterItem(this.getCounterItemByFilterFields(e));this.showLoader();await this.$store.dispatch(`${Bt.Model.Filter}/setFilterFields`,this.$refs.filter.getFields());await Promise.all([this.$store.dispatch(`${Bt.Model.Filter}/setFilterMode`,true),this.updateMarks(),st.bookingService.filter(this.requestFields)]);if(t&&(this.filteredBookingsIds.length===0||Date.now()>this.selectedDateTs)){await this.tryNavigateToOptimalFilterResult()}this.hideLoader()},async applyDeletingResourceFilter(t,e=false){if(!e&&this.isDeletingResourceFilterMode&&!this.isDeletionResourceFilterFields(this.$refs.filter.getFields())){await this.$store.dispatch(`${Bt.Model.Filter}/setFilterMode`,true);await this.clearDeletingResourceFilter(true);await this.applyFilter({fromFilter:true});return}const o={RESOURCE:[t.id.toString()],RESOURCE_label:[t.name]};if(e){this.$refs.filter.setFields(o)}const i=this.getFilterFields();this.showLoader();await Promise.all([this.$store.dispatch(`${Bt.Model.Filter}/setFilterFields`,o),this.$store.dispatch(`${Bt.Model.Filter}/setDeletionResourceFilterFields`,i),this.$store.dispatch(`${Bt.Model.Interface}/setPinnedResourceIds`,i.RESOURCE)]);await Promise.all([this.updateMarks(),st.bookingService.filter(this.requestFields)]);if(e&&this.getFutureBookingsByResourceId(t.id).length===0){await this.tryNavigateToOptimalFilterResult(true)}this.hideLoader()},isDeletionResourceFilterFields(t){return Object.keys(t).length===1&&"RESOURCE"in t&&t.RESOURCE.length===1&&t.RESOURCE[0]===this.deletingResource.id.toString()},setCounterItem(t){this.ignoreConterPanel=true;setTimeout((()=>{this.ignoreConterPanel=false}),0);this.$refs.countersPanel.setItem(t)},getCounterItemByFilterFields(t){return{[xt.AwaitConfirmation]:Wt.AwaitConfirmation,[xt.Delayed]:Wt.Delayed}[t.REQUIRE_ATTENTION]},async tryNavigateToOptimalFilterResult(t=false){const e=await a.filterResultNavigator.getOptimalFilterDateTs(t);if(e&&e!==this.selectedDateTs){await this.$store.dispatch(`${Bt.Model.Interface}/setSelectedDateTs`,e)}},getFilterFieldsByCounterItem(t){const e=this.$refs.filter.getFields();e.REQUIRE_ATTENTION={[Wt.AwaitConfirmation]:xt.AwaitConfirmation,[Wt.Delayed]:xt.Delayed}[t];return e},async clearFilter(){this.setCounterItem(null);r.calendarService.clearFilterCache();st.bookingService.clearFilterCache();await Promise.all([this.$store.dispatch(`${Bt.Model.Interface}/setResourcesIds`,this.resourcesIds),this.$store.dispatch(`${Bt.Model.Filter}/setFilterMode`,false),this.$store.dispatch(`${Bt.Model.Filter}/setFilteredBookingsIds`,[]),this.$store.dispatch(`${Bt.Model.Filter}/setFilteredMarks`,[]),this.$store.dispatch(`${Bt.Model.Filter}/clearFilter`,{}),this.$store.dispatch(`${Bt.Model.Interface}/setPinnedResourceIds`,[])]);this.hideLoader()},async clearDeletingResourceFilter(t=false){await Promise.all([this.$store.dispatch(`${Bt.Model.Filter}/setDeletingResourceFilter`,null),this.$store.dispatch(`${Bt.Model.Interface}/setPinnedResourceIds`,[])]);if(this.isFilterMode||t){return}this.$refs.filter.setFields({RESOURCE:[],RESOURCE_label:[]});await this.clearFilter()},clearDeletingResourceFilterFields(){if(this.isDeletionResourceFilterFields(this.$refs.filter.getFields())){this.$refs.filter.setFields({RESOURCE:[],RESOURCE_label:[]})}},addAfterTitle(){this.afterTitleContainer.append(this.$refs.afterTitle.$el)},showResourcesWithBookings(){const t=this.$store.getters[`${Bt.Model.Bookings}/getByDateAndIds`](this.selectedDateTs,this.filteredBookingsIds).map((t=>t.resourcesIds[0])).filter(((t,e,o)=>o.indexOf(t)===e));void this.$store.dispatch(`${Bt.Model.Interface}/setResourcesIds`,t)},async updateMarks(){if(this.isFilterMode||this.isDeletingResourceFilterMode){await Promise.all([this.updateFilterBookingsCount(),this.updateFilterMarks()])}else{await Promise.all([this.updateFreeMarks(),this.updateCounterMarks()])}},async updateFreeMarks(){const t=this.resourcesIds.map((t=>{var e,o;return[t,...(e=this.intersections[0])!=null?e:[],...(o=this.intersections[t])!=null?o:[]]}));await this.$store.dispatch(`${Bt.Model.Interface}/setFreeMarks`,[]);await r.calendarService.loadMarks(this.viewDateTs,t)},async updateFilterMarks(){const t=this.$refs.filter.getFields();await this.$store.dispatch(`${Bt.Model.Filter}/setFilteredMarks`,[]);await r.calendarService.loadFilterMarks(t,this.isDeletingResourceFilterMode)},async updateCounterMarks(){await r.calendarService.loadCounterMarks(this.viewDateTs)},async updateFilterBookingsCount(){const t=this.$refs.filter.getFields();await r.calendarService.loadBookingsDateCount(t,this.isDeletingResourceFilterMode)},showLoader(){this.loadingFilter=true;void this.loader.show(this.$refs.baseComponent.$el)},hideLoader(){this.loadingFilter=false;void this.loader.hide()}},template:`\n\t\t<div>\n\t\t\t<MultiBooking v-if="hasSelectedCells"/>\n\t\t\t<AfterTitle ref="afterTitle"/>\n\t\t\t<CrmFormsButton :container="settingsButtonContainer"/>\n\t\t\t<BookingFilter\n\t\t\t\t:filterId="filterId"\n\t\t\t\tref="filter"\n\t\t\t\t@apply="isDeletingResourceFilterMode ? applyDeletingResourceFilter(deletingResource) : applyFilter({ fromFilter: true })"\n\t\t\t\t@clear="clearFilter"\n\t\t\t/>\n\t\t\t<EmptyFilterResultsPopup\n\t\t\t\tv-if="isFilterMode && !isDeletingResourceFilterMode && !loadingFilter && !fetchingNextDate && datesCount.count === 0"\n\t\t\t/>\n\t\t\t<CountersPanel\n\t\t\t\t:target="counterPanelContainer"\n\t\t\t\tref="countersPanel"\n\t\t\t\t@activeItem="onActiveItem"\n\t\t\t/>\n\t\t\t<BaseComponent ref="baseComponent"/>\n\t\t\t<Banner/>\n\t\t\t<Trial/>\n\t\t</div>\n\t`};var rs=babelHelpers.classPrivateFieldLooseKey("mountApplication");class as{constructor(t){Object.defineProperty(this,rs,{value:ls});C.Core.setParams(t);void babelHelpers.classPrivateFieldLooseBase(this,rs)[rs]()}}async function ls(){await C.Core.init();const t=vt.BitrixVue.createApp(ns,C.Core.getParams());t.mixin(e.locMixin);t.use(C.Core.getStore());t.mount(C.Core.getParams().container)}t.Booking=as})(this.BX.Booking=this.BX.Booking||{},BX.Booking.Component.Mixin,BX,BX.Booking.Component,BX.Booking.Provider.Service,BX.Booking.Provider.Service,BX.Booking.Provider.Service,BX.Booking.Lib,BX.UI,BX.UI,BX.Event,BX.Booking.Lib,BX.UI.Vue3.Components,BX.UI.NotificationManager,BX.Booking.Provider.Service,BX.Booking.Component,BX.Vue3.Directives,BX.Booking.Lib,BX.Booking.Component,BX.Booking.Component,BX.UI.IconSet,BX,BX.Booking.Component,BX.Booking.Lib,BX.Booking.Lib,BX.Booking.Lib,BX.Booking.Lib,BX.Booking,BX.UI.DatePicker,BX.Booking.Component,BX.Booking.Lib,BX.UI.Dialogs,BX.Booking.Component,BX.Booking.Component,BX.Booking.Lib,BX.Booking.Model,BX.Booking.Model,BX.Booking.Provider.Service,BX.Booking.Lib,BX.Booking.Lib,BX.UI,BX.Booking.Lib,BX.Booking.Component,BX,BX.Booking.Lib,BX,BX.Booking.Lib,BX.Booking,BX.Booking.Provider.Service,BX.Booking.Lib,BX.Booking.Lib,BX.UI.IconSet,BX,BX.Booking.Provider.Service,BX.Booking.Lib,BX.Booking.Lib,BX.UI.EntitySelector,BX.Booking.Lib,BX.Booking.Provider.Service,BX.Booking.Provider.Service,BX.UI,BX.Main,BX.Booking.Lib,BX.Booking.Component,BX.Booking.Lib,BX.UI.AutoLaunch,BX.Vue3.Vuex,BX,BX.UI,BX.Booking.Lib,BX.Booking.Lib,BX.Main,BX.Booking.Component,BX.Booking.Component,BX.Vue3,BX.Booking.Const,BX.Booking.Component);
//# sourceMappingURL=booking.bundle.map.js