this.BX=this.BX||{};(function(t,e,o,i,s,n,r,a,l,d,c,u,h,p,g,m,b,f,k,I,v,T,B,y,M,E,S,C,w,O,P,D,F,$,R,H,N,L,_,A,z,x,G,K,U,X,q,V,j,W,Y,Z,Q,J,tt,et,ot,it,st,nt,rt,at,lt,dt,ct,ut,ht){"use strict";const pt=50;const gt="--booking-off-hours-cell-height";const mt="--booking-booking-collapse";const bt="--booking-booking-expand";var ft=babelHelpers.classPrivateFieldLooseKey("animation");var kt=babelHelpers.classPrivateFieldLooseKey("container");var It=babelHelpers.classPrivateFieldLooseKey("content");var vt=babelHelpers.classPrivateFieldLooseKey("gridWrap");var Tt=babelHelpers.classPrivateFieldLooseKey("fromHour");var Bt=babelHelpers.classPrivateFieldLooseKey("toHour");class yt{constructor(){Object.defineProperty(this,Bt,{get:wt,set:void 0});Object.defineProperty(this,Tt,{get:Ct,set:void 0});Object.defineProperty(this,vt,{get:St,set:void 0});Object.defineProperty(this,It,{get:Et,set:void 0});Object.defineProperty(this,kt,{get:Mt,set:void 0});Object.defineProperty(this,ft,{writable:true,value:void 0})}expand({keepScroll:t}){at.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,kt)[kt],mt);at.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,kt)[kt],bt);this.animate(0,pt,t)}collapse(){at.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,kt)[kt],bt);at.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,kt)[kt],mt);this.animate(pt,0,true)}animate(t,e,o=false){var i;const s=babelHelpers.classPrivateFieldLooseBase(this,vt)[vt].scrollTop;const n=babelHelpers.classPrivateFieldLooseBase(this,vt)[vt].scrollHeight;const r=babelHelpers.classPrivateFieldLooseBase(this,Tt)[Tt]/(24-(babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt]-babelHelpers.classPrivateFieldLooseBase(this,Tt)[Tt]));(i=babelHelpers.classPrivateFieldLooseBase(this,ft)[ft])==null?void 0:i.stop();babelHelpers.classPrivateFieldLooseBase(this,ft)[ft]=new BX.easing({duration:200,start:{height:t},finish:{height:e},step:({height:t})=>{at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,It)[It],gt,`calc(var(--zoom) * ${t}px)`);if(o){const t=babelHelpers.classPrivateFieldLooseBase(this,vt)[vt].scrollHeight-n;babelHelpers.classPrivateFieldLooseBase(this,vt)[vt].scrollTop=s+t*r}}});babelHelpers.classPrivateFieldLooseBase(this,ft)[ft].animate()}setExpanded(t){const e=babelHelpers.classPrivateFieldLooseBase(this,vt)[vt].scrollTop;const o=babelHelpers.classPrivateFieldLooseBase(this,vt)[vt].scrollHeight;const i=babelHelpers.classPrivateFieldLooseBase(this,Tt)[Tt]/(24-(babelHelpers.classPrivateFieldLooseBase(this,Bt)[Bt]-babelHelpers.classPrivateFieldLooseBase(this,Tt)[Tt]));const s=t?pt:0;const n=t?bt:mt;at.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,kt)[kt],[mt,bt]);at.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,kt)[kt],n);at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,It)[It],gt,`calc(var(--zoom) * ${s}px)`);const r=babelHelpers.classPrivateFieldLooseBase(this,vt)[vt].scrollHeight-o;babelHelpers.classPrivateFieldLooseBase(this,vt)[vt].scrollTop=e+r*i;void P.Core.getStore().dispatch(`${ut.Model.Interface}/setOffHoursExpanded`,t)}}function Mt(){return P.Core.getParams().container}function Et(){return BX("booking-content")}function St(){return BX("booking-booking-grid-wrap")}function Ct(){return P.Core.getStore().getters["interface/fromHour"]}function wt(){return P.Core.getStore().getters["interface/toHour"]}const Ot=new yt;const Pt=Object.freeze({NotConfirmed:"booking-filter-preset-unconfirmed",Delayed:"booking-filter-preset-delayed",CreatedByMe:"booking-filter-preset-created-by-me"});const Dt=Object.freeze({CreatedBy:"CREATED_BY",Contact:"CONTACT",Company:"COMPANY",Resource:"RESOURCE",Confirmed:"CONFIRMED",Delayed:"DELAYED"});const Ft={emits:["apply","clear"],props:{filterId:{type:String,required:true}},data(){return{filter:null}},created(){this.filter=BX.Main.filterManager.getById(this.filterId);r.EventEmitter.subscribe("BX.Main.Filter:beforeApply",this.onBeforeApply)},methods:{onBeforeApply(t){const[e]=t.getData();if(e!==this.filterId){return}if(this.isFilterEmpty()){this.$emit("clear")}else{this.$emit("apply")}},setPresetId(t){if(this.getPresetId()===t){return}this.filter.getApi().setFilter({preset_id:t})},getPresetId(){const t=this.filter.getPreset().getCurrentPresetId();return t==="tmp_filter"?null:t},isFilterEmpty(){return Object.keys(this.getFields()).length===0},getFields(){const t=[Dt.Confirmed,Dt.Delayed];const e=[Dt.Company,Dt.Contact,Dt.CreatedBy,Dt.Resource];const o=this.filter.getFilterFieldsValues();const i=t.filter((t=>["Y","N"].includes(o[t]))).reduce(((t,e)=>({...t,[e]:o[e]})),{});e.forEach((t=>{var e;if(((e=o[t])==null?void 0:e.length)>0){i[t]=o[t]}}));return i}},template:`\n\t\t<div></div>\n\t`};const $t=Object.freeze({NotConfirmed:"not-confirmed",Delayed:"delayed"});const Rt={emits:["activeItem"],props:{target:HTMLElement},mounted(){this.addCounterPanel();r.EventEmitter.subscribe("BX.UI.CounterPanel.Item:activate",this.onActiveItem);r.EventEmitter.subscribe("BX.UI.CounterPanel.Item:deactivate",this.onActiveItem)},computed:rt.mapGetters({counters:"counters/get"}),methods:{setItem(t){if(this.getActiveItem()===t){return}Object.values($t).forEach((t=>this.counterPanel.getItemById(t).deactivate()));const e=this.counterPanel.getItemById(t);e==null?void 0:e.activate()},addCounterPanel(){this.counterPanel=new a.CounterPanel({target:this.target,items:[{id:$t.NotConfirmed,title:this.loc("BOOKING_BOOKING_COUNTER_PANEL_NOT_CONFIRMED"),value:this.counters.unConfirmed,color:Ht(l.CounterColor,l.CounterColor.THEME)},{id:$t.Delayed,title:this.loc("BOOKING_BOOKING_COUNTER_PANEL_DELAYED"),value:this.counters.delayed}]});this.counterPanel.init()},onActiveItem(){this.$emit("activeItem",this.getActiveItem())},getActiveItem(){var t,e;return(t=(e=this.counterPanel.getItems().find((({isActive:t})=>t)))==null?void 0:e.id)!=null?t:null}},watch:{counters(t){this.counterPanel.getItems().forEach((e=>{if(e.id===$t.NotConfirmed){e.updateColor(Ht(l.CounterColor,l.CounterColor.DANGER));e.updateValue(t.unConfirmed)}if(e.id===$t.Delayed){e.updateColor(Ht(l.CounterColor,l.CounterColor.DANGER));e.updateValue(t.delayed)}}))}},template:`\n\t\t<div></div>\n\t`};const Ht=(t,e)=>Object.entries(t).find((([,t])=>t===e))[0];const Nt={props:{value:{type:Number,required:true},valueFormatted:{type:String,required:true},increasedValue:{type:Number,required:true},increasedValueFormatted:{type:String,required:true},popupId:{type:String,required:true},title:{type:String,required:true},rows:{type:Array,required:true},button:{type:Object,required:false}},data(){return{isPopupShown:false}},methods:{onMouseEnter(){this.clearTimeouts();this.showTimeout=setTimeout((()=>this.showPopup()),100)},onMouseLeave(){at.Event.unbind(document,"mouseover",this.updateHoverElement);at.Event.bind(document,"mouseover",this.updateHoverElement);this.clearTimeouts();if(!this.button){this.closePopup();return}this.closeTimeout=setTimeout((()=>{var t;this.popupContainer=document.getElementById(this.popupId);if(!((t=this.popupContainer)!=null&&t.contains(this.hoverElement))&&!this.$refs.container.contains(this.hoverElement)){this.closePopup()}if(this.popupContainer){at.Event.unbind(this.popupContainer,"mouseleave",this.onMouseLeave);at.Event.bind(this.popupContainer,"mouseleave",this.onMouseLeave)}}),100)},updateHoverElement(t){this.hoverElement=t.target},showPopup(){this.clearTimeouts();this.isPopupShown=true},closePopup(){this.clearTimeouts();this.isPopupShown=false;at.Event.unbind(this.popupContainer,"mouseleave",this.onMouseLeave);at.Event.unbind(document,"mouseover",this.updateHoverElement)},clearTimeouts(){clearTimeout(this.closeTimeout);clearTimeout(this.showTimeout)},close(){this.closePopup();this.$emit("close")}},watch:{value(){var t;(t=this.$refs.animation)==null?void 0:t.replaceWith(this.$refs.animation)}},components:{StatisticsPopup:R.StatisticsPopup},template:`\n\t\t<div class="booking-toolbar-after-title-info-profit-container" ref="container">\n\t\t\t<div\n\t\t\t\tv-html="valueFormatted"\n\t\t\t\tclass="booking-toolbar-after-title-info-profit"\n\t\t\t\t@click="showPopup"\n\t\t\t\t@mouseenter="onMouseEnter"\n\t\t\t\t@mouseleave="onMouseLeave"\n\t\t\t></div>\n\t\t\t<div\n\t\t\t\tv-if="increasedValue > 0"\n\t\t\t\tv-html="increasedValueFormatted"\n\t\t\t\tclass="booking-toolbar-after-title-profit-increased"\n\t\t\t\tref="animation"\n\t\t\t></div>\n\t\t</div>\n\t\t<StatisticsPopup\n\t\t\tv-if="isPopupShown"\n\t\t\t:popupId="popupId"\n\t\t\t:bindElement="$refs.container"\n\t\t\t:title="title"\n\t\t\t:rows="rows"\n\t\t\t:button="button"\n\t\t\t@close="close"\n\t\t/>\n\t`};const Lt={data(){return{increasedValue:0}},computed:{...rt.mapGetters({totalNewClientsToday:`${ut.Model.Interface}/totalNewClientsToday`,totalClients:`${ut.Model.Interface}/totalClients`}),popupId(){return"booking-booking-after-title-clients-popup"},title(){return this.loc("BOOKING_BOOKING_AFTER_TITLE_CLIENTS_POPUP_TITLE")},rows(){return[{title:this.loc("BOOKING_BOOKING_AFTER_TITLE_CLIENTS_POPUP_TOTAL_CLIENTS_TODAY"),value:`+${this.totalNewClientsToday}`},{title:this.loc("BOOKING_BOOKING_AFTER_TITLE_CLIENTS_POPUP_TOTAL_CLIENTS"),value:`<div>${this.totalClients}</div>`}]},button(){return{title:this.loc("BOOKING_BOOKING_CLIENTS_LIST"),click:()=>BX.SidePanel.Instance.open("/crm/contact/list/")}},clientsProfitFormatted(){return at.Loc.getMessagePlural("BOOKING_BOOKING_PLUS_NUM_CLIENTS",this.totalNewClientsToday,{"#NUM#":this.totalNewClientsToday})},increasedValueFormatted(){return at.Loc.getMessagePlural("BOOKING_BOOKING_PLUS_NUM_CLIENTS",this.increasedValue,{"#NUM#":this.increasedValue})}},watch:{totalNewClientsToday(t,e){this.increasedValue=t-e}},components:{Statistics:Nt},template:`\n\t\t<Statistics\n\t\t\t:value="totalNewClientsToday"\n\t\t\t:valueFormatted="clientsProfitFormatted"\n\t\t\t:increasedValue="increasedValue"\n\t\t\t:increasedValueFormatted="increasedValueFormatted"\n\t\t\t:popupId="popupId"\n\t\t\t:title="title"\n\t\t\t:rows="rows"\n\t\t\t:button="button"\n\t\t/>\n\t`};const _t={data(){return{increasedValue:0}},computed:{...rt.mapGetters({moneyStatistics:`${ut.Model.Interface}/moneyStatistics`}),popupId(){return"booking-booking-after-title-profit-popup"},title(){return this.loc("BOOKING_BOOKING_AFTER_TITLE_PROFIT_POPUP_TITLE")},rows(){var t,e,o,i;const s=(t=(e=this.moneyStatistics)==null?void 0:(o=e.month)==null?void 0:(i=o.filter((({currencyId:t})=>t!==this.baseCurrencyId)))==null?void 0:i.map((({currencyId:t})=>t)))!=null?t:[];return[this.getTodayRow(this.baseCurrencyId),...s.map((t=>this.getTodayRow(t))),this.getMonthRow(this.baseCurrencyId),...s.map((t=>this.getMonthRow(t)))]},todayProfit(){return this.getTodayProfit(this.moneyStatistics)},todayProfitFormatted(){return this.formatTodayProfit(this.todayProfit)},increasedValueFormatted(){return this.formatTodayProfit(this.increasedValue)},baseCurrencyId(){return $.currencyFormat.getBaseCurrencyId()}},methods:{getTodayRow(t){const e=this.loc("BOOKING_BOOKING_AFTER_TITLE_PROFIT_POPUP_TOTAL_TODAY");return{title:t===this.baseCurrencyId?e:"",value:`+${this.getTodayProfitFormatted(t)}`}},getMonthRow(t){const e=this.loc("BOOKING_BOOKING_AFTER_TITLE_PROFIT_POPUP_MONTH",{"#MONTH#":tt.DateTimeFormat.format("f")});return{title:t===this.baseCurrencyId?e:"",value:`<div>${this.getMonthProfitFormatted(t)}</div>`}},getTodayProfitFormatted(t){var e,o,i;const s=(e=this.moneyStatistics)==null?void 0:(o=e.today)==null?void 0:o.find((({currencyId:e})=>e===t));const n=(i=s==null?void 0:s.opportunity)!=null?i:0;return $.currencyFormat.format(t,n)},getMonthProfitFormatted(t){var e,o,i;const s=(e=this.moneyStatistics)==null?void 0:(o=e.month)==null?void 0:o.find((({currencyId:e})=>e===t));const n=(i=s==null?void 0:s.opportunity)!=null?i:0;return $.currencyFormat.format(t,n)},getTodayProfit(t){var e,o;const i=t==null?void 0:(e=t.today)==null?void 0:e.find((({currencyId:t})=>t===this.baseCurrencyId));return(o=i==null?void 0:i.opportunity)!=null?o:0},formatTodayProfit(t){return`+ <span>${$.currencyFormat.format(this.baseCurrencyId,t)}</span>`}},watch:{moneyStatistics(t,e){this.increasedValue=this.getTodayProfit(t)-this.getTodayProfit(e)}},components:{Statistics:Nt},template:`\n\t\t<Statistics\n\t\t\t:value="todayProfit"\n\t\t\t:valueFormatted="todayProfitFormatted"\n\t\t\t:increasedValue="increasedValue"\n\t\t\t:increasedValueFormatted="increasedValueFormatted"\n\t\t\t:popupId="popupId"\n\t\t\t:title="title"\n\t\t\t:rows="rows"\n\t\t/>\n\t`};const At={computed:{dateFormatted(){const t=tt.DateTimeFormat.getFormat("DAY_SHORT_MONTH_FORMAT");return tt.DateTimeFormat.format(t,Date.now()/1e3)}},components:{Clients:Lt,Profit:_t},template:`\n\t\t<div class="booking-toolbar-after-title">\n\t\t\t<div class="booking-toolbar-after-title-date" ref="date">\n\t\t\t\t{{ dateFormatted }}\n\t\t\t</div>\n\t\t\t<div class="booking-toolbar-after-title-info">\n\t\t\t\t<Clients/>\n\t\t\t\t<Profit/>\n\t\t\t</div>\n\t\t</div>\n\t`};const zt={props:{bottom:{type:Boolean,default:false}},computed:{...rt.mapGetters({offHoursHover:"interface/offHoursHover",offHoursExpanded:"interface/offHoursExpanded",fromHour:"interface/fromHour",toHour:"interface/toHour"}),fromFormatted(){if(this.bottom){return this.formatHour(this.toHour)}return this.formatHour(0)},toFormatted(){if(this.bottom){return this.formatHour(24)}return this.formatHour(this.fromHour)}},methods:{formatHour(t){const e=tt.DateTimeFormat.getFormat("SHORT_TIME_FORMAT");const o=(new Date).setHours(t,0)/1e3;return tt.DateTimeFormat.format(e,o)},animateOffHours({keepScroll:t}){if(this.offHoursExpanded){Ot.collapse()}else{Ot.expand({keepScroll:t})}void this.$store.dispatch("interface/setOffHoursExpanded",!this.offHoursExpanded)}},template:`\n\t\t<div\n\t\t\tclass="booking-booking-off-hours"\n\t\t\t:class="{'--hover': offHoursHover, '--bottom': bottom, '--top': !bottom}"\n\t\t\t@click="animateOffHours({ keepScroll: bottom })"\n\t\t\t@mouseenter="$store.dispatch('interface/setOffHoursHover', true)"\n\t\t\t@mouseleave="$store.dispatch('interface/setOffHoursHover', false)"\n\t\t>\n\t\t\t<div class="booking-booking-off-hours-border"></div>\n\t\t\t<span>{{ fromFormatted }}</span>\n\t\t\t<span>{{ toFormatted }}</span>\n\t\t</div>\n\t`};const xt={name:"HelpPopup",components:{RichLoc:d.RichLoc,StickyPopup:y.StickyPopup},emits:["close"],props:{bindElement:{type:HTMLElement,required:true}},computed:{popupId(){return"booking-quick-filter-help-popup"},config(){return{className:"booking-quick-filter-help-popup",bindElement:this.bindElement,offsetLeft:this.bindElement.offsetWidth,offsetTop:this.bindElement.offsetHeight,maxWidth:220}}},methods:{closePopup(){this.$emit("close")}},template:`\n\t\t<StickyPopup\n\t\t\t:id="popupId"\n\t\t\t:config="config"\n\t\t\t@close="closePopup"\n\t\t>\n\t\t\t<div class="booking-quick-filter-help-popup-content">\n\t\t\t\t<div class="booking-quick-filter-help-popup-icon-container">\n\t\t\t\t\t<div class="booking-quick-filter-help-popup-icon"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class="booking-quick-filter-help-popup-description">\n\t\t\t\t\t<RichLoc :text="loc('BOOKING_QUICK_FILTER_HELP_MSGVER_1')" placeholder="[bold]">\n\t\t\t\t\t\t<template #bold="{ text }">\n\t\t\t\t\t\t\t<span>{{ text }}</span>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t</RichLoc>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</StickyPopup>\n\t`};const Gt={props:{hour:{type:Number,required:true}},data(){return{IconSet:U.Set,isHelpPopupShown:false}},computed:{active(){return this.hour in this.$store.getters[`${ut.Model.Interface}/quickFilter`].active},hovered(){return this.hour in this.$store.getters[`${ut.Model.Interface}/quickFilter`].hovered}},methods:{onClick(){this.closeHelpPopup();if(this.active){void this.$store.dispatch(`${ut.Model.Interface}/deactivateQuickFilter`,this.hour)}else{void this.$store.dispatch(`${ut.Model.Interface}/activateQuickFilter`,this.hour)}},hover(){this.helpPopupTimeout=setTimeout((()=>this.showHelpPopup()),1e3);void this.$store.dispatch(`${ut.Model.Interface}/hoverQuickFilter`,this.hour)},flee(){this.closeHelpPopup();void this.$store.dispatch(`${ut.Model.Interface}/fleeQuickFilter`,this.hour)},showHelpPopup(){this.isHelpPopupShown=true},closeHelpPopup(){clearTimeout(this.helpPopupTimeout);this.isHelpPopupShown=false}},components:{Icon:U.BIcon,HelpPopup:xt},template:`\n\t\t<div\n\t\t\tclass="booking-booking-quick-filter-container"\n\t\t\t:class="{'--hover': hovered || active, '--active': active}"\n\t\t>\n\t\t\t<div\n\t\t\t\tclass="booking-booking-quick-filter"\n\t\t\t\t@mouseenter="hover"\n\t\t\t\t@mouseleave="flee"\n\t\t\t\t@click="onClick"\n\t\t\t>\n\t\t\t\t<Icon :name="active ? IconSet.CROSS_25 : IconSet.FUNNEL"/>\n\t\t\t</div>\n\t\t\t<HelpPopup\n\t\t\t\tv-if="isHelpPopupShown"\n\t\t\t\t:bindElement="$el"\n\t\t\t\t@close="closeHelpPopup"\n\t\t\t/>\n\t\t</div>\n\t`};const Kt={computed:{...rt.mapGetters({offHoursHover:"interface/offHoursHover",offHoursExpanded:"interface/offHoursExpanded",fromHour:"interface/fromHour",toHour:"interface/toHour"}),panelHours(){const t=tt.DateTimeFormat.getFormat("SHORT_TIME_FORMAT");const e=this.offHoursExpanded?24:this.toHour;return O.range(0,24).map((o=>{const i=(new Date).setHours(o,0)/1e3;return{value:o,formatted:tt.DateTimeFormat.format(t,i),offHours:o<this.fromHour||o>=this.toHour,last:o===e}}))}},components:{OffHours:zt,QuickFilter:Gt},template:`\n\t\t<div class="booking-booking-grid-left-panel-container">\n\t\t\t<div class="booking-booking-grid-left-panel">\n\t\t\t\t<OffHours/>\n\t\t\t\t<OffHours :bottom="true"/>\n\t\t\t\t<template v-for="hour of panelHours" :key="hour.value">\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="hour.last"\n\t\t\t\t\t\tclass="booking-booking-grid-left-panel-time-text"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ hour.formatted }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="hour.value !== 24"\n\t\t\t\t\t\tclass="booking-booking-grid-left-panel-time"\n\t\t\t\t\t\t:class="{'--off-hours': hour.offHours}"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div class="booking-booking-grid-left-panel-time-text">\n\t\t\t\t\t\t\t{{ hour.formatted }}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<QuickFilter :hour="hour.value"/>\n\t\t\t\t\t</div>\n\t\t\t\t</template>\n\t\t\t</div>\n\t\t</div>\n\t`};const Ut={data(){return{visible:true}},mounted(){this.updateNowLine();setInterval((()=>this.updateNowLine()),1e3)},computed:rt.mapGetters({zoom:`${ut.Model.Interface}/zoom`,selectedDateTs:`${ut.Model.Interface}/selectedDateTs`,offHoursExpanded:`${ut.Model.Interface}/offHoursExpanded`,fromHour:`${ut.Model.Interface}/fromHour`,toHour:`${ut.Model.Interface}/toHour`,offset:`${ut.Model.Interface}/offset`}),methods:{setVisible(t){this.visible=t;this.updateNowLine()},updateNowLine(){const t=new Date(Date.now()+this.offset);const e=50*this.zoom;const o=this.fromHour*60;const i=t.getHours()*60+t.getMinutes();const s=this.offHoursExpanded?24:this.toHour;const n=Math.min(s*60+21,i);const r=(n-o)*(e/60);at.Dom.style(this.$refs.nowLine,"top",`${r}px`);const a=tt.DateTimeFormat.getFormat("SHORT_TIME_FORMAT");const l=tt.DateTimeFormat.format(a,t.getTime()/1e3);if(l!==this.$refs.nowText.innerText){this.$refs.nowText.innerText=l}const d=new Date(this.selectedDateTs+this.offset);const c=this.visible&&Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())===Date.UTC(t.getFullYear(),t.getMonth(),t.getDate());at.Dom.style(this.$refs.nowLine,"display",c?"":"none")}},watch:{selectedDateTs(){this.updateNowLine()},zoom(){this.updateNowLine()},offHoursExpanded(t){const e=new Date;const o=e.getHours()*60+e.getMinutes();if(o<this.toHour*60){return}this.setVisible(!t);setTimeout((()=>this.setVisible(true)),200)}},template:`\n\t\t<div class="booking-booking-grid-now-line" ref="nowLine">\n\t\t\t<div class="booking-booking-grid-now-line-text" ref="nowText"></div>\n\t\t</div>\n\t`};const Xt={name:"BookingActionsPopupClient",emits:["freeze","unfreeze"],props:{bookingId:{type:[Number,String],required:true}},computed:{booking(){return this.$store.getters["bookings/getById"](this.bookingId)}},methods:{async addClients({clients:t}){await Z.bookingService.update({id:this.booking.id,clients:t})},async updateClients({clients:t}){await Z.bookingService.update({id:this.booking.id,clients:t})},async updateNote({note:t}){await Z.bookingService.update({id:this.booking.id,note:t})}},components:{Client:g.Client},template:`\n\t\t<Client\n\t\t\t:id="bookingId"\n\t\t\t:clients="booking.clients"\n\t\t\t:primaryClientData="booking.primaryClient"\n\t\t\t:note="booking.note"\n\t\t\t:dataId="bookingId"\n\t\t\tdataElementPrefix="booking"\n\t\t\t@freeze="$emit('freeze')"\n\t\t\t@unfreeze="$emit('unfreeze')"\n\t\t\t@addClients="addClients"\n\t\t\t@updateClients="updateClients"\n\t\t\t@updateNote="updateNote"\n\t\t/>\n\t`};const qt={name:"BookingActionsPopupDeal",emits:["freeze","unfreeze"],props:{bookingId:{type:[Number,String],required:true}},setup(t){const e=new v.DealHelper(t.bookingId);return{dealHelper:e}},computed:{booking(){return this.$store.getters[`${ut.Model.Bookings}/getById`](this.bookingId)},deal(){var t,e;return(t=(e=this.booking.externalData)==null?void 0:e.find((t=>t.entityTypeId===ut.CrmEntity.Deal)))!=null?t:null}},components:{Deal:g.Deal},template:`\n\t\t<Deal\n\t\t\t:deal="deal"\n\t\t\t:dealHelper="dealHelper"\n\t\t\t:dataId="booking.id"\n\t\t\tdataElementPrefix="booking"\n\t\t\t@freeze="$emit('freeze')"\n\t\t\t@unfreeze="$emit('unfreeze')"\n\t\t/>\n\t`};const Vt={name:"BookingActionsPopupDocument",props:{bookingId:{type:[Number,String],required:true}},data(){return{isLoading:true}},async mounted(){await h.bookingActionsService.getDocData();this.isLoading=false},components:{Document:g.Document},template:`\n\t\t<Document\n\t\t\t:id="bookingId"\n\t\t\t:loading="isLoading"\n\t\t\tdisabled\n\t\t/>\n\t`};const jt={name:"BookingActionsPopupMessage",emits:["freeze","unfreeze"],props:{bookingId:{type:Number,required:true}},data(){return{isLoading:true,isPrimaryClientIdUpdated:false}},mounted(){void this.fetchMessageData()},computed:{...rt.mapGetters({isCurrentSenderAvailable:`${ut.Model.Interface}/isCurrentSenderAvailable`}),menuId(){return`booking-message-menu-${this.bookingId}`},booking(){return this.$store.getters["bookings/getById"](this.bookingId)},client(){const t=this.booking.primaryClient;return t?this.$store.getters["clients/getByClientData"](t):null},clientId(){var t;return(t=this.booking.primaryClient)==null?void 0:t.id},updatedAt(){return this.booking.updatedAt}},watch:{clientId(){this.isPrimaryClientIdUpdated=true},updatedAt(){if(this.isPrimaryClientIdUpdated&&this.isCurrentSenderAvailable){void this.fetchMessageData();this.isPrimaryClientIdUpdated=false}}},methods:{async sendMessage({notificationType:t}){try{await h.bookingActionsService.sendMessage(this.bookingId,t);void this.fetchMessageData()}catch(t){if(at.Type.isArrayFilled(t.errors)){u.Notifier.notify({id:"booking-message-send-error",text:t.errors[0].message})}}},async fetchMessageData(){this.isLoading=true;await h.bookingActionsService.getMessageData(this.bookingId);this.isLoading=false}},components:{Message:g.Message},template:`\n\t\t<Message\n\t\t\t:id="bookingId"\n\t\t\t:clientData="booking.primaryClient"\n\t\t\t:loading="isLoading"\n\t\t\t:dataId="bookingId"\n\t\t\tdataElementPrefix="booking"\n\t\t\t@open="$emit('freeze')"\n\t\t\t@close="$emit('unfreeze')"\n\t\t\t@updateNotificationType="sendMessage"\n\t\t/>\n\t`};const Wt={emits:["freeze","unfreeze"],name:"BookingActionsPopupConfirmation",props:{bookingId:{type:[Number,String],required:true}},computed:{booking(){return this.$store.getters[`${ut.Model.Bookings}/getById`](this.bookingId)}},methods:{updateConfirmationStatus({isConfirmed:t}){void Z.bookingService.update({id:this.booking.id,isConfirmed:t})}},components:{Confirmation:g.Confirmation},template:`\n\t\t<Confirmation\n\t\t\t:id="bookingId"\n\t\t\t:isConfirmed="booking.isConfirmed"\n\t\t\t:counters="booking.counters"\n\t\t\t:dataId="booking.id"\n\t\t\tdataElementPrefix="booking"\n\t\t\t@open="$emit('freeze')"\n\t\t\t@close="$emit('unfreeze')"\n\t\t\t@updateConfirmationStatus="updateConfirmationStatus"\n\t\t/>\n\t`};const Yt={emits:["freeze","unfreeze"],name:"BookingActionsPopupVisit",props:{bookingId:{type:[Number,String],required:true}},computed:{booking(){return this.$store.getters[`${ut.Model.Bookings}/getById`](this.bookingId)}},methods:{updateVisitStatus({visitStatus:t}){void Z.bookingService.update({id:this.booking.id,visitStatus:t})}},components:{Icon:U.BIcon,Loader:p.Loader,Visit:g.Visit},template:`\n\t\t<Visit\n\t\t\t:id="booking.id"\n\t\t\t:visitStatus="booking.visitStatus"\n\t\t\t:dataId="booking.id"\n\t\t\tdataElementPrefix="booking"\n\t\t\t:hasClients="booking.clients.length > 0"\n\t\t\t@freeze="$emit('freeze')"\n\t\t\t@unfreeze="$emit('unfreeze')"\n\t\t\t@update:visitStatus="updateVisitStatus"\n\t\t/>\n\t`};const Zt={name:"BookingActionsPopupOverbooking",components:{Icon:U.BIcon},directives:{hint:k.hint},emits:["close"],props:{bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true},disabled:{type:Boolean,default:false}},setup(){const t=U.Set.PLUS_20;const e=20;const o="var(--ui-color-palette-gray-20)";return{plusIcon:t,plusIconSize:e,plusIconColor:o}},computed:{...rt.mapGetters({getBookingById:`${ut.Model.Bookings}/getById`,dictionary:`${ut.Model.Dictionary}/getBookingVisitStatuses`,isFeatureEnabled:`${ut.Model.Interface}/isFeatureEnabled`,timezone:`${ut.Model.Interface}/timezone`,embedItems:`${ut.Model.Interface}/embedItems`}),booking(){return this.getBookingById(this.bookingId)},hasOverbookingHint(){if(!this.disabled){return undefined}return{text:this.loc("BB_ACTIONS_POPUP_OVERBOOKING_DISABLED_HINT")}},clients(){const t=this.embedItems.filter((t=>t.entityTypeId==="CONTACT"||t.entityTypeId==="COMPANY"));return t.map((t=>({id:t.value,type:{code:t.entityTypeId,module:t.moduleId}})))}},methods:{async addOverbooking(){if(this.disabled){return}if(!this.isFeatureEnabled){Y.limit.show();return}const t={...this.booking,id:at.Text.getRandom(10),clients:this.clients,counter:0,counters:[],createdAt:Date.now(),externalData:this.embedItems,isConfirmed:false,name:null,note:null,resourcesIds:[this.resourceId],primaryClient:undefined,rrule:null,timezoneFrom:this.timezone,timezoneTo:this.timezone,updatedAt:Date.now(),visitStatus:this.dictionary.Unknown};delete t.name;await this.addCreatedFromEmbedBooking(t.id);const e=await Z.bookingService.add(t);if(e.success&&e.booking){st.BookingAnalytics.sendAddBooking({isOverbooking:true});await this.addCreatedFromEmbedBooking(e.booking.id)}this.$emit("close")},async addCreatedFromEmbedBooking(t){await this.$store.dispatch(`${ut.Model.Interface}/addCreatedFromEmbedBooking`,t)}},template:`\n\t\t<div\n\t\t\tv-hint="hasOverbookingHint"\n\t\t\tclass="booking-actions-popup__item-overbooking-button"\n\t\t\t:class="{'--disabled': disabled}"\n\t\t\trole="button"\n\t\t\ttabindex="0"\n\t\t\t@click="addOverbooking"\n\t\t>\n\t\t\t<Icon :name="plusIcon" :size="plusIconSize" :color="plusIconColor"/>\n\t\t\t<div class="booking-actions-popup__item-overbooking-label">\n\t\t\t\t{{ loc('BB_ACTIONS_POPUP_OVERBOOKING_LABEL') }}\n\t\t\t</div>\n\t\t</div>\n\t`};const Qt={name:"BookingActionsPopupWaitlist",props:{bookingId:{type:[Number,String],required:true}},components:{Icon:U.BIcon},computed:{clockIcon(){return U.Set.BLACK_CLOCK},clockIconSize(){return 20},clockIconColor(){return"var(--ui-color-palette-gray-20)"}},template:`\n\t\t<div class="booking-actions-popup__item-waitlist-icon --end">\n\t\t\t<Icon :name="clockIcon" :size="clockIconSize" :color="clockIconColor"/>\n\t\t\t<div class="booking-actions-popup__item-waitlist-label">\n\t\t\t\t{{loc('BB_ACTIONS_POPUP_OVERBOOKING_LIST')}}\n\t\t\t</div>\n\t\t</div>\n\t`};function Jt(t,{emit:e}){const o=t.bookingId;const i=()=>{e("close");new F.RemoveBooking(o)};return lt.h(g.RemoveButton,{dataId:o,dataElementPrefix:"booking",onRemove:i})}const te=["bookingId"];Jt.props=te;Jt.emits=["close"];const ee=Object.freeze({client:"client",confirmation:"confirmation",deal:"deal",document:"document",fullForm:"fullForm",message:"message",visit:"visit",overbooking:"overbooking",remove:"remove",waitList:"waitList"});const oe={name:"BookingActionsPopup",emits:["close"],props:{bindElement:{type:HTMLElement,required:true},bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true},options:{type:Object,default:null}},data(){return{soonTmp:false}},computed:{config(){return{offsetLeft:this.bindElement.offsetWidth,offsetTop:-200}},contentStructure(){return[{id:ee.client,props:{bookingId:this.bookingId},component:Xt},[{id:ee.deal,props:{bookingId:this.bookingId},component:qt},{id:ee.document,props:{bookingId:this.bookingId},component:Vt}],{id:ee.message,props:{bookingId:this.bookingId},component:jt},{id:ee.confirmation,props:{bookingId:this.bookingId},component:Wt},{id:ee.visit,props:{bookingId:this.bookingId},component:Yt},{id:ee.fullForm,props:{bookingId:this.bookingId},component:g.FullForm}]},booking(){return this.$store.getters["bookings/getById"](this.bookingId)}},components:{ActionsPopup:g.ActionsPopup,BookingClient:Xt,BookingDeal:qt,BookingDocument:Vt,BookingMessage:jt,BookingConfirmation:Wt,BookingVisit:Yt,FullForm:g.FullForm,Overbooking:Zt,Waitlist:Qt,BookingRemoveBtn:Jt},template:`\n\t\t<ActionsPopup\n\t\t\t:popupId="bookingId"\n\t\t\t:bindElement="bindElement"\n\t\t\t:contentStructure="contentStructure"\n\t\t\t:popupOptions="config"\n\t\t\t@close="$emit('close')"\n\t\t>\n\t\t\t<template #footer>\n\t\t\t\t<Overbooking\n\t\t\t\t\tv-if="!options?.overbooking?.hidden"\n\t\t\t\t\t:bookingId\n\t\t\t\t\t:resourceId\n\t\t\t\t\t:disabled="Boolean(options?.overbooking?.disabled)"\n\t\t\t\t\t@close="$emit('close')"\n\t\t\t\t/>\n\t\t\t\t<template v-if="soonTmp">\n\t\t\t\t\t<Waitlist :bookingId/>\n\t\t\t\t</template>\n\t\t\t\t<BookingRemoveBtn :bookingId @close="$emit('close')"/>\n\t\t\t</template>\n\t\t</ActionsPopup>\n\t`};const ie={name:"BookingActions",props:{bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true},actionsPopupOptions:{type:Object,default:null}},data(){return{showPopup:false}},mounted(){if(this.isEditingBookingMode&&this.editingBookingId===this.bookingId){this.showPopup=true}},computed:rt.mapGetters({editingBookingId:`${ut.Model.Interface}/editingBookingId`,isEditingBookingMode:`${ut.Model.Interface}/isEditingBookingMode`}),methods:{clickHandler(){this.showPopup=true}},components:{BookingActionsPopup:oe},template:`\n\t\t<div \n\t\t\tref="node"\n\t\t\tclass="booking-booking-booking-actions"\n\t\t\tdata-element="booking-booking-actions-button"\n\t\t\t:data-id="bookingId"\n\t\t\t:data-resource-id="resourceId"\n\t\t\t@click="clickHandler"\n\t\t>\n\t\t\t<div class="booking-booking-booking-actions-inner">\n\t\t\t\t<div class="ui-icon-set --chevron-down"></div>\n\t\t\t</div>\n\t\t</div>\n\t\t<BookingActionsPopup\n\t\t\tv-if="showPopup"\n\t\t\t:bookingId\n\t\t\t:bindElement="this.$refs.node"\n\t\t\t:resourceId\n\t\t\t:options="actionsPopupOptions"\n\t\t\t@close="showPopup = false"\n\t\t/>\n\t`};const se={props:{bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true},expired:{type:Boolean,default:false}},data(){return{showPopup:false}},mounted(){if(B.isRealId(this.bookingId)){ht.ahaMoments.setBookingForAhaMoment(this.bookingId)}if(ht.ahaMoments.shouldShow(ut.AhaMoment.AddClient,{bookingId:this.bookingId})){void this.showAhaMoment()}},computed:rt.mapGetters({providerModuleId:`${ut.Model.Clients}/providerModuleId`,isFeatureEnabled:`${ut.Model.Interface}/isFeatureEnabled`}),methods:{clickHandler(){if(!this.isFeatureEnabled){Y.limit.show();return}this.showPopup=true},async addClientsToBook(t){const e=this.$store.getters[`${ut.Model.Bookings}/getById`](this.bookingId);await Z.bookingService.update({id:e.id,clients:t})},async showAhaMoment(){await ht.ahaMoments.show({id:"booking-add-client",title:this.loc("BOOKING_AHA_ADD_CLIENT_TITLE"),text:this.loc("BOOKING_AHA_ADD_CLIENT_TEXT"),article:ut.HelpDesk.AhaAddClient,target:this.$refs.button});ht.ahaMoments.setShown(ut.AhaMoment.AddClient)}},components:{ClientPopup:ot.ClientPopup},template:`\n\t\t<div\n\t\t\tv-if="providerModuleId"\n\t\t\tclass="booking-booking-booking-add-client"\n\t\t\t:class="{ '--expired': expired }"\n\t\t\tdata-element="booking-add-client-button"\n\t\t\t:data-id="bookingId"\n\t\t\t:data-resource-id="resourceId"\n\t\t\tref="button"\n\t\t\t@click="clickHandler"\n\t\t>\n\t\t\t{{ loc('BOOKING_BOOKING_PLUS_CLIENT') }}\n\t\t</div>\n\t\t<ClientPopup\n\t\t\tv-if="showPopup"\n\t\t\t:bindElement="this.$refs.button"\n\t\t\t:offset-top="-100"\n\t\t\t:offset-left="this.$refs.button.offsetWidth + 10"\n\t\t\t@create="addClientsToBook"\n\t\t\t@close="showPopup = false"\n\t\t/>\n\t`};const ne={name:"ChangeTimePopup",emits:["close"],props:{bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true},targetNode:{type:HTMLElement,required:true}},data(){return{ButtonSize:it.ButtonSize,ButtonColor:it.ButtonColor,ButtonIcon:it.ButtonIcon,fromTs:0,toTs:0,duration:0}},created(){this.fromTs=this.booking.dateFromTs;this.toTs=this.booking.dateToTs;this.duration=this.toTs-this.fromTs},mounted(){at.Event.bind(document,"scroll",this.adjustPosition,true)},beforeUnmount(){at.Event.unbind(document,"scroll",this.adjustPosition,true)},computed:{...rt.mapGetters({selectedDateTs:`${ut.Model.Interface}/selectedDateTs`}),popupId(){return`booking-change-time-popup-${this.bookingId}`},config(){return{className:"booking-booking-change-time-popup",bindElement:this.targetNode,offsetTop:-10,bindOptions:{forceBindPosition:true,position:"top"},angle:{offset:this.targetNode.offsetWidth/2}}},isBusy(){const t=this.bookingId;const e=this.bookings.filter((({id:e,dateToTs:o,dateFromTs:i})=>{if(e!==t&&this.overbookingMap.has(e)){var s;const o=this.overbookingMap.get(e);const i=o.items.find((t=>t.resourceId===this.resourceId));const n=(i==null?void 0:(s=i.intersections)==null?void 0:s.filter((e=>e.id!==t&&e.dateToTs>this.fromTs&&this.toTs>e.dateFromTs)))||[];if(i&&n.length===0){return false}}return e!==t&&o>this.fromTs&&this.toTs>i}));return e.length>0},bookings(){return this.$store.getters[`${ut.Model.Bookings}/getByDateAndResources`](this.selectedDateTs,this.booking.resourcesIds)},booking(){return this.$store.getters["bookings/getById"](this.bookingId)},overbookingMap(){return this.$store.getters[`${ut.Model.Bookings}/overbookingMap`]}},methods:{adjustPosition(){this.$refs.popup.adjustPosition();this.$refs.timeFrom.adjustMenuPosition();this.$refs.timeTo.adjustMenuPosition()},closePopup(){const t=this.booking.dateFromTs!==this.fromTs||this.booking.dateToTs!==this.toTs;if(!this.isBusy&&t){void Z.bookingService.update({id:this.booking.id,dateFromTs:this.fromTs,dateToTs:this.toTs,timezoneFrom:this.booking.timezoneFrom,timezoneTo:this.booking.timezoneTo})}this.$emit("close")},freeze(){this.$refs.popup.getPopupInstance().setAutoHide(false)},unfreeze(){this.$refs.popup.getPopupInstance().setAutoHide(true)}},watch:{fromTs(){this.toTs=this.fromTs+this.duration},toTs(){if(this.toTs<=this.fromTs){this.fromTs=this.toTs-this.duration}this.duration=this.toTs-this.fromTs},isBusy(){setTimeout((()=>this.adjustPosition()),0)}},components:{Popup:y.Popup,TimeSelector:b.TimeSelector,Button:it.Button},template:`\n\t\t<Popup\n\t\t\t:id="popupId"\n\t\t\t:config="config"\n\t\t\t@close="closePopup"\n\t\t\tref="popup"\n\t\t>\n\t\t\t<div class="booking-booking-change-time-popup-content">\n\t\t\t\t<div class="booking-booking-change-time-popup-main">\n\t\t\t\t\t<TimeSelector\n\t\t\t\t\t\tv-model="fromTs"\n\t\t\t\t\t\t:hasError="isBusy"\n\t\t\t\t\t\tdata-element="booking-change-time-from"\n\t\t\t\t\t\t:data-ts="fromTs"\n\t\t\t\t\t\t:data-booking-id="bookingId"\n\t\t\t\t\t\tref="timeFrom"\n\t\t\t\t\t\t@freeze="freeze"\n\t\t\t\t\t\t@unfreeze="unfreeze"\n\t\t\t\t\t\t@enterSave="closePopup"\n\t\t\t\t\t/>\n\t\t\t\t\t<div class="booking-booking-change-time-popup-separator"></div>\n\t\t\t\t\t<TimeSelector\n\t\t\t\t\t\tv-model="toTs"\n\t\t\t\t\t\t:hasError="isBusy"\n\t\t\t\t\t\t:minTs="fromTs"\n\t\t\t\t\t\tdata-element="booking-change-time-to"\n\t\t\t\t\t\t:data-ts="toTs"\n\t\t\t\t\t\t:data-booking-id="bookingId"\n\t\t\t\t\t\tref="timeTo"\n\t\t\t\t\t\t@freeze="freeze"\n\t\t\t\t\t\t@unfreeze="unfreeze"\n\t\t\t\t\t\t@enterSave="closePopup"\n\t\t\t\t\t/>\n\t\t\t\t\t<Button\n\t\t\t\t\t\tclass="booking-booking-change-time-popup-button"\n\t\t\t\t\t\t:size="ButtonIcon.MEDIUM"\n\t\t\t\t\t\t:color="ButtonColor.PRIMARY"\n\t\t\t\t\t\t:icon="ButtonIcon.DONE"\n\t\t\t\t\t\t:disabled="isBusy"\n\t\t\t\t\t\t@click="closePopup"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<div v-if="isBusy" class="booking-booking-change-time-popup-error">\n\t\t\t\t\t{{ loc('BOOKING_BOOKING_TIME_IS_NOT_AVAILABLE') }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</Popup>\n\t`};const re={props:{bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true},dateFromTs:{type:Number,required:true},dateToTs:{type:Number,required:true}},data(){return{showPopup:false}},computed:{...rt.mapGetters({offset:`${ut.Model.Interface}/offset`,isFeatureEnabled:`${ut.Model.Interface}/isFeatureEnabled`}),booking(){return this.$store.getters["bookings/getById"](this.bookingId)},timeFormatted(){const t=tt.DateTimeFormat.getFormat("SHORT_TIME_FORMAT");return this.loc("BOOKING_BOOKING_TIME_RANGE",{"#FROM#":tt.DateTimeFormat.format(t,(this.dateFromTs+this.offset)/1e3),"#TO#":tt.DateTimeFormat.format(t,(this.dateToTs+this.offset)/1e3)})}},methods:{clickHandler(){if(!this.isFeatureEnabled){return}this.showPopup=true},closePopup(){this.showPopup=false}},components:{ChangeTimePopup:ne},template:`\n\t\t<div\n\t\t\tclass="booking-booking-booking-time"\n\t\t\t:class="{'--lock': !isFeatureEnabled}"\n\t\t\tdata-element="booking-booking-time"\n\t\t\t:data-booking-id="bookingId"\n\t\t\t:data-resource-id="resourceId"\n\t\t\t:data-from="booking.dateFromTs"\n\t\t\t:data-to="booking.dateToTs"\n\t\t\tref="time"\n\t\t\t@click="clickHandler"\n\t\t>\n\t\t\t{{ timeFormatted }}\n\t\t</div>\n\t\t<ChangeTimePopup\n\t\t\tv-if="showPopup"\n\t\t\t:bookingId="bookingId"\n\t\t\t:resourceId="resourceId"\n\t\t\t:targetNode="$refs.time"\n\t\t\t@close="closePopup"\n\t\t/>\n\t`};const ae={props:{bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true}},computed:{booking(){return this.$store.getters[`${ut.Model.Bookings}/getById`](this.bookingId)},client(){const t=this.booking.primaryClient;return t?this.$store.getters[`${ut.Model.Clients}/getByClientData`](t):null},bookingName(){var t;return((t=this.client)==null?void 0:t.name)||this.booking.name||this.loc("BOOKING_BOOKING_DEFAULT_BOOKING_NAME")}},template:`\n\t\t<div\n\t\t\tclass="booking-booking-booking-name"\n\t\t\t:title="bookingName"\n\t\t\tdata-element="booking-booking-name"\n\t\t\t:data-id="bookingId"\n\t\t\t:data-resource-id="resourceId"\n\t\t>\n\t\t\t{{ bookingName }}\n\t\t</div>\n\t`};const le={props:{bookingId:{type:[Number,String],required:true},bindElement:{type:Function,required:true}},data(){return{isPopupShown:false,isEditMode:false}},computed:{...rt.mapGetters({isFeatureEnabled:`${ut.Model.Interface}/isFeatureEnabled`}),booking(){return this.$store.getters[`${ut.Model.Bookings}/getById`](this.bookingId)},hasNote(){return Boolean(this.booking.note)}},methods:{showViewPopup(){if(this.isPopupShown||!this.hasNote){return}this.isEditMode=false;this.isPopupShown=true},closeViewPopup(){if(this.isEditMode){return}this.isPopupShown=false},showEditPopup(){this.isEditMode=true;this.isPopupShown=true},closeEditPopup(){if(!this.isEditMode){return}this.isPopupShown=false},async saveBookingNote({note:t}){await Z.bookingService.update({id:this.booking.id,note:t})}},components:{NotePopup:f.NotePopup},template:`\n\t\t<div class="booking-booking-booking-note">\n\t\t\t<div\n\t\t\t\tclass="booking-booking-booking-note-button"\n\t\t\t\t:class="{'--has-note': hasNote}"\n\t\t\t\tdata-element="booking-booking-note-button"\n\t\t\t\t:data-id="bookingId"\n\t\t\t\t@click="showEditPopup"\n\t\t\t>\n\t\t\t\t<div class="ui-icon-set --note"></div>\n\t\t\t</div>\n\t\t</div>\n\t\t<NotePopup\n\t\t\tv-if="isPopupShown"\n\t\t\t:isEditMode="isEditMode && isFeatureEnabled"\n\t\t\t:id="bookingId"\n\t\t\t:text="booking.note"\n\t\t\t:bindElement="bindElement"\n\t\t\t:dataId="bookingId"\n\t\t\tdataElementPrefix="booking"\n\t\t\t@close="closeEditPopup"\n\t\t\t@save="saveBookingNote"\n\t\t/>\n\t`};const de={props:{bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true}},computed:{booking(){return this.$store.getters[`${ut.Model.Bookings}/getById`](this.bookingId)},deal(){var t,e;return(t=(e=this.booking.externalData)==null?void 0:e.find((t=>t.entityTypeId===ut.CrmEntity.Deal)))!=null?t:null}},template:`\n\t\t<div\n\t\t\tv-if="deal"\n\t\t\tclass="booking-booking-booking-profit"\n\t\t\tdata-element="booking-booking-profit"\n\t\t\t:data-id="bookingId"\n\t\t\t:data-resource-id="resourceId"\n\t\t\t:data-profit="deal.data.opportunity"\n\t\t\tv-html="deal.data.formattedOpportunity"\n\t\t></div>\n\t`};const ce={name:"BookingCommunication",directives:{hint:k.hint},components:{Icon:U.BIcon},setup(){return{IconSet:U.Set}},computed:{soonHint(){return{text:this.loc("BOOKING_BOOKING_SOON_HINT"),popupOptions:{offsetLeft:-60}}}},template:`\n\t\t<div v-hint="soonHint" class="booking-booking-booking-communication">\n\t\t\t<Icon :name="IconSet.TELEPHONY_HANDSET_1"/>\n\t\t\t<Icon :name="IconSet.CHATS_2"/>\n\t\t</div>\n\t`};const ue={props:{bookingId:[Number,String],required:true},data(){return{IconSet:U.Set}},created(){this.dealHelper=new v.DealHelper(this.bookingId)},computed:{hasDeal(){return this.dealHelper.hasDeal()},isFeatureEnabled(){return this.$store.getters[`${ut.Model.Interface}/isFeatureEnabled`]}},methods:{onClick(){if(!this.isFeatureEnabled){void Y.limit.show();return}if(this.hasDeal){this.dealHelper.openDeal()}else{this.dealHelper.createDeal()}}},components:{Icon:U.BIcon},template:`\n\t\t<Icon\n\t\t\t:name="IconSet.CRM_LETTERS"\n\t\t\tclass="booking-booking-booking-crm-button"\n\t\t\t:class="{'--no-deal': !hasDeal}"\n\t\t\tdata-element="booking-crm-button"\n\t\t\t:data-booking-id="bookingId"\n\t\t\t@click="onClick"\n\t\t/>\n\t`};const he={props:{bookingId:{type:[Number,String],required:true}},computed:{booking(){return this.$store.getters[`${ut.Model.Bookings}/getById`](this.bookingId)},counterOptions(){return Object.freeze({color:T.CounterColor.DANGER,size:T.CounterSize.LARGE})}},components:{UiCounter:T.Counter},template:`\n\t\t<UiCounter\n\t\t\tv-if="booking.counter > 0"\n\t\t\t:value="booking.counter"\n\t\t\t:color="counterOptions.color"\n\t\t\t:size="counterOptions.size"\n\t\t\tborder\n\t\t\tcounter-class="booking--counter"\n\t\t/>\n\t`};const pe={emits:["close"],props:{bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true},bindElement:{type:Function,required:true}},mounted(){this.adjustPosition();setTimeout((()=>this.closePopup()),3e3);at.Event.bind(document,"scroll",this.adjustPosition,true)},beforeUnmount(){at.Event.unbind(document,"scroll",this.adjustPosition,true)},computed:{popupId(){return`booking-booking-disabled-popup-${this.bookingId}-${this.resourceId}`},config(){return{className:"booking-booking-disabled-popup",bindElement:this.bindElement(),width:this.bindElement().offsetWidth,offsetTop:-10,bindOptions:{forceBindPosition:true,position:"top"},autoHide:true,darkMode:true}}},methods:{adjustPosition(){this.$refs.popup.adjustPosition()},closePopup(){this.$emit("close")}},components:{Popup:y.Popup},template:`\n\t\t<Popup\n\t\t\t:id="popupId"\n\t\t\t:config="config"\n\t\t\tref="popup"\n\t\t\t@close="closePopup"\n\t\t>\n\t\t\t<div class="booking-booking-disabled-popup-content">\n\t\t\t\t{{ loc('BOOKING_BOOKING_YOU_CANNOT_EDIT_THIS_BOOKING') }}\n\t\t\t</div>\n\t\t</Popup>\n\t`};const ge=Object.freeze({From:-1,None:0,To:1});const me=et.Duration.getUnitDurations().i*5;const be=et.Duration.getUnitDurations().i*15;const fe={name:"BookingResize",props:{bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true}},setup(){const t=null;const e=null;return{tooltipTop:t,tooltipBottom:e}},data(){return{resizeDirection:ge.None,resizeFromTs:null,resizeToTs:null}},computed:{...rt.mapGetters({selectedDateTs:`${ut.Model.Interface}/selectedDateTs`,overbookingMap:`${ut.Model.Bookings}/overbookingMap`}),booking(){return this.$store.getters[`${ut.Model.Bookings}/getById`](this.bookingId)},limits(){return{fromTs:new Date(this.selectedDateTs).setHours(0,0,0,0),toTs:new Date(this.selectedDateTs).setHours(24,0,0,0)}},initialHeight(){return C.grid.calculateHeight(this.booking.dateFromTs,this.booking.dateToTs)},initialDuration(){return Math.max(this.booking.dateToTs-this.booking.dateFromTs,be)},dateFromTsRounded(){return this.roundTimestamp(this.resizeFromTs)},dateToTsRounded(){return this.roundTimestamp(this.resizeToTs)},closestOnFrom(){return this.colliding.reduce(((t,{toTs:e})=>t<e&&e<=this.booking.dateFromTs?e:t),0)},closestOnTo(){return this.colliding.reduce(((t,{fromTs:e})=>this.booking.dateToTs<=e&&e<t?e:t),Infinity)},excludeBookings(){const t=this.overbookingMap;return e=>{if(e.id===this.bookingId){return true}const o=t.get(e.id);const i=this.booking.resourcesIds;return!o||o.items.every((t=>!i.includes(t.resourceId)))}},colliding(){return this.$store.getters[`${ut.Model.Interface}/getColliding`](this.booking.resourcesIds,this.excludeBookings)},hasIntersections(){return this.booking.resourcesIds.length>1}},methods:{createPopup(t){return new K.Popup({autoHide:true,cacheable:true,darkMode:true,...t})},showTooltipTop(t){if(!this.tooltipTop){this.tooltipTop=this.createPopup({id:`resize-top-${this.bookingId}-${this.resourceId}`,bindElement:this.$refs.bookingResizeTop,bindOptions:{position:"bottom"},offsetLeft:this.$refs.bookingResizeTop.offsetWidth/2,content:this.loc("BOOKING_RESIZE_GRID_LIMIT"),...t})}else if(t!=null&&t.content){this.tooltipTop.setContent(t.content)}this.tooltipTop.show()},showTooltipBottom(t){if(!this.tooltipBottom){this.tooltipBottom=this.createPopup({id:`resize-bottom-${this.bookingId}-${this.resourceId}`,bindElement:this.$refs.bookingResizeBottom,bindOptions:{position:"bottom"},offsetLeft:this.$refs.bookingResizeBottom.offsetWidth/2,content:this.loc("BOOKING_RESIZE_GRID_LIMIT"),...t})}else if(t!=null&&t.content){this.tooltipBottom.setContent(t.content)}this.tooltipBottom.show()},hideTooltips(){var t,e;(t=this.tooltipTop)==null?void 0:t.close==null?void 0:t.close();(e=this.tooltipBottom)==null?void 0:e.close==null?void 0:e.close()},onMouseDown(t){const e=at.Dom.hasClass(t.target,"--from")?ge.From:ge.To;void this.startResize(e)},async startResize(t=ge.To){at.Dom.style(document.body,"user-select","none");at.Event.bind(window,"mouseup",this.endResize);at.Event.bind(window,"pointermove",this.resize);this.resizeDirection=t;void this.updateIds(this.bookingId,this.resourceId)},resize(t){if(!this.resizeDirection){return}const e=this.resizeDirection===ge.To?t.clientY-this.$el.getBoundingClientRect().top:this.$el.getBoundingClientRect().bottom-t.clientY;const o=e*this.initialDuration/this.initialHeight;const i=Math.max(o,me);if(this.resizeDirection===ge.To){const t=this.booking.dateFromTs+i;const e=Math.min(t,this.limits.toTs);this.manageToLimitNotification(t,e);this.resizeFromTs=this.booking.dateFromTs;this.resizeToTs=Math.min(e,this.closestOnTo)}else{const t=this.booking.dateToTs-i;const e=Math.max(t,this.limits.fromTs);this.manageFromLimitNotification(t,e);this.resizeFromTs=Math.max(e,this.closestOnFrom);this.resizeToTs=this.booking.dateToTs}this.$emit("update",this.resizeFromTs,this.resizeToTs)},async endResize(){this.resizeBooking();this.hideTooltips();at.Dom.style(document.body,"user-select","");at.Event.unbind(window,"mouseup",this.endResize);at.Event.unbind(window,"pointermove",this.resize);this.$emit("update",null,null);await this.updateIds(null,null)},manageFromLimitNotification(t,e){const o=this.colliding.filter((({toTs:t})=>t===this.closestOnFrom));if(t<this.limits.fromTs){this.showTooltipTop({content:this.loc("BOOKING_RESIZE_GRID_LIMIT")});return}if(e<this.closestOnFrom){if(this.checkClosestByIntersection(o)){this.showTooltipTop({content:this.loc("BOOKING_RESIZE_INTERSECTIONS_LIMIT")});return}this.showTooltipTop({content:this.loc("BOOKING_RESIZE_LIMIT")});return}this.hideTooltips()},manageToLimitNotification(t,e){const o=this.colliding.filter((({fromTs:t})=>t===this.closestOnTo));if(t>this.limits.toTs){this.showTooltipBottom({content:this.loc("BOOKING_RESIZE_GRID_LIMIT")});return}if(e>this.closestOnTo){if(this.checkClosestByIntersection(o)){this.showTooltipBottom({content:this.loc("BOOKING_RESIZE_INTERSECTIONS_LIMIT")});return}this.showTooltipBottom({content:this.loc("BOOKING_RESIZE_LIMIT")});return}this.hideTooltips()},checkClosestByIntersection(t){return this.hasIntersections&&(t.length===1||t.filter((t=>t.resourcesIds[0]!==this.resourceId)).length>=2)},async updateIds(t,e){await Promise.all([this.$store.dispatch(`${ut.Model.Interface}/setResizedBookingId`,t),this.$store.dispatch(`${ut.Model.Interface}/setDraggedBookingResourceId`,e)]);void j.busySlots.loadBusySlots()},resizeBooking(){if(!this.dateFromTsRounded||!this.dateToTsRounded){return}if(this.dateFromTsRounded===this.booking.dateFromTs&&this.dateToTsRounded===this.booking.dateToTs){return}const t=this.bookingId;const e={id:t,dateFromTs:this.dateFromTsRounded,dateToTs:this.dateToTsRounded,timezoneFrom:this.booking.timezoneFrom,timezoneTo:this.booking.timezoneTo};if(!B.isRealId(this.bookingId)){void this.$store.dispatch(`${ut.Model.Bookings}/update`,{id:t,booking:e});return}void Z.bookingService.update({id:t,...e})},roundTimestamp(t){const e=et.Duration.getUnitDurations().i*5;return Math.round(t/e)*e}},template:`\n\t\t<div>\n\t\t\t<div ref="bookingResizeTop" class="booking-booking-resize --from" @mousedown="onMouseDown"></div>\n\t\t\t<div ref="bookingResizeBottom" class="booking-booking-resize --to" @mousedown="onMouseDown"></div>\n\t\t</div>\n\t`};const ke=280;const Ie={name:"BookingBase",props:{bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true},nowTs:{type:Number,required:true},width:{type:Number,default:ke},leftOffset:{type:Number,default:0},bookingClass:{type:[String,Object,Array],default:""},bookingStyle:{type:[String,Object,Array],default:""}},data(){return{visible:true,isDisabledPopupShown:false,resizeFromTs:null,resizeToTs:null}},mounted(){this.updateVisibility();this.updateVisibilityDuringTransition();setTimeout((()=>{if(!this.isReal&&m.mousePosition.isMousePressed()){void this.$refs.resize.startResize()}}),200)},beforeUnmount(){var t;if(this.deletingBookings[this.bookingId]||!((t=this.booking)!=null&&t.resourcesIds.includes(this.resourceId))){this.$el.remove()}},computed:{...rt.mapGetters({resourcesIds:`${ut.Model.Interface}/resourcesIds`,zoom:`${ut.Model.Interface}/zoom`,scroll:`${ut.Model.Interface}/scroll`,draggedBookingId:`${ut.Model.Interface}/draggedBookingId`,editingBookingId:`${ut.Model.Interface}/editingBookingId`,isEditingBookingMode:`${ut.Model.Interface}/isEditingBookingMode`,deletingBookings:`${ut.Model.Interface}/deletingBookings`}),isReal(){return B.isRealId(this.bookingId)},booking(){return this.$store.getters[`${ut.Model.Bookings}/getById`](this.bookingId)},client(){const t=this.booking.primaryClient;return t?this.$store.getters[`${ut.Model.Clients}/getByClientData`](t):null},left(){return C.grid.calculateLeft(this.resourceId)},top(){return C.grid.calculateTop(this.dateFromTs)},height(){return C.grid.calculateHeight(this.dateFromTs,this.dateToTs)},realHeight(){return C.grid.calculateRealHeight(this.dateFromTs,this.dateToTs)},dateFromTs(){var t;return(t=this.resizeFromTs)!=null?t:this.booking.dateFromTs},dateToTs(){var t;return(t=this.resizeToTs)!=null?t:this.booking.dateToTs},dateFromTsRounded(){var t;return(t=this.roundTimestamp(this.resizeFromTs))!=null?t:this.dateFromTs},dateToTsRounded(){var t;return(t=this.roundTimestamp(this.resizeToTs))!=null?t:this.dateToTs},disabled(){return this.isEditingBookingMode&&this.editingBookingId!==this.bookingId},counterOptions(){return Object.freeze({color:T.CounterColor.DANGER,size:T.CounterSize.LARGE})},bookingOffset(){return this.leftOffset*this.zoom},isExpiredBooking(){return this.booking.dateToTs<this.nowTs}},methods:{updateVisibilityDuringTransition(){var t;(t=this.animation)==null?void 0:t.stop();this.animation=new BX.easing({duration:200,start:{},finish:{},step:this.updateVisibility});this.animation.animate()},updateVisibility(){if(!this.$el){return}const t=this.$el.getBoundingClientRect();this.visible=t.right>0&&t.left<window.innerWidth},onNoteMouseEnter(){this.showNoteTimeout=setTimeout((()=>this.$refs.note.showViewPopup()),100)},onNoteMouseLeave(){clearTimeout(this.showNoteTimeout);this.$refs.note.closeViewPopup()},onClick(t){if(this.disabled){this.isDisabledPopupShown=true;t.stopPropagation()}},resizeUpdate(t,e){this.resizeFromTs=t;this.resizeToTs=e},roundTimestamp(t){const e=et.Duration.getUnitDurations().i*5;return t?Math.round(t/e)*e:null}},watch:{scroll(){this.updateVisibility()},zoom(){this.updateVisibility()},resourcesIds(){this.updateVisibilityDuringTransition()},visible(t){if(t){return}setTimeout((()=>{this.updateVisibility()}),2e3)}},components:{AddClient:se,BookingTime:re,Actions:ie,Name:ae,Note:le,Profit:de,Communication:ce,CrmButton:ue,Counter:he,DisabledPopup:pe,Resize:fe},template:`\n\t\t<div\n\t\t\tclass="booking-booking-booking"\n\t\t\tdata-element="booking-booking"\n\t\t\t:data-id="bookingId"\n\t\t\t:data-resource-id="resourceId"\n\t\t\t:style="[bookingStyle, {\n\t\t\t\t'--left': left + bookingOffset + 'px',\n\t\t\t\t'--top': top + 'px',\n\t\t\t\t'--height': height + 'px',\n\t\t\t\t'--width': width + 'px',\n\t\t\t}].flat(1)"\n\t\t\t:class="[bookingClass, {\n\t\t\t\t'--not-real': !isReal,\n\t\t\t\t'--zoom-is-less-than-08': zoom < 0.8,\n\t\t\t\t'--compact-mode': realHeight < 40 || zoom < 0.8,\n\t\t\t\t'--small': realHeight <= 15,\n\t\t\t\t'--long': realHeight >= 65,\n\t\t\t\t'--disabled': disabled,\n\t\t\t\t'--confirmed': booking.isConfirmed,\n\t\t\t\t'--expired': isExpiredBooking,\n\t\t\t\t'--resizing': resizeFromTs && resizeToTs,\n\t\t\t\t'--no-pointer-events': draggedBookingId > 0 && draggedBookingId !== bookingId,\n\t\t\t}].flat(1)"\n\t\t\t@click.capture="onClick"\n\t\t>\n\t\t\t<div v-if="visible" class="booking-booking-booking-padding">\n\t\t\t\t<div class="booking-booking-booking-inner">\n\t\t\t\t\t<div class="booking-booking-booking-content">\n\t\t\t\t\t\t<div class="booking-booking-booking-content-row">\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tclass="booking-booking-booking-name-container"\n\t\t\t\t\t\t\t\t@mouseenter="onNoteMouseEnter"\n\t\t\t\t\t\t\t\t@mouseleave="onNoteMouseLeave"\n\t\t\t\t\t\t\t\t@click="$refs.note.showViewPopup()"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<Name :bookingId="bookingId" :resourceId="resourceId"/>\n\t\t\t\t\t\t\t\t<Note\n\t\t\t\t\t\t\t\t\t:bookingId="bookingId"\n\t\t\t\t\t\t\t\t\t:bindElement="() => $el"\n\t\t\t\t\t\t\t\t\tref="note"\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<BookingTime\n\t\t\t\t\t\t\t\t:bookingId="bookingId"\n\t\t\t\t\t\t\t\t:resourceId="resourceId"\n\t\t\t\t\t\t\t\t:dateFromTs="dateFromTsRounded"\n\t\t\t\t\t\t\t\t:dateToTs="dateToTsRounded"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<Profit :bookingId="bookingId" :resourceId="resourceId"/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="booking-booking-booking-content-row --lower">\n\t\t\t\t\t\t\t<BookingTime\n\t\t\t\t\t\t\t\t:bookingId="bookingId"\n\t\t\t\t\t\t\t\t:resourceId="resourceId"\n\t\t\t\t\t\t\t\t:dateFromTs="dateFromTsRounded"\n\t\t\t\t\t\t\t\t:dateToTs="dateToTsRounded"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<div v-if="client" class="booking-booking-booking-buttons">\n\t\t\t\t\t\t\t\t<Communication/>\n\t\t\t\t\t\t\t\t<CrmButton :bookingId="bookingId"/>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<AddClient\n\t\t\t\t\t\t\t\tv-else\n\t\t\t\t\t\t\t\t:bookingId="bookingId"\n\t\t\t\t\t\t\t\t:resourceId="resourceId"\n\t\t\t\t\t\t\t\t:expired="isExpiredBooking"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<slot name="actions">\n\t\t\t\t\t\t<Actions :bookingId="bookingId" :resourceId="resourceId"/>\n\t\t\t\t\t</slot>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<Resize\n\t\t\t\tv-if="!disabled"\n\t\t\t\t:bookingId="bookingId"\n\t\t\t\t:resourceId="resourceId"\n\t\t\t\tref="resize"\n\t\t\t\t@update="resizeUpdate"\n\t\t\t/>\n\t\t\t<Counter :bookingId="bookingId"/>\n\t\t\t<DisabledPopup\n\t\t\t\tv-if="isDisabledPopupShown"\n\t\t\t\t:bookingId="bookingId"\n\t\t\t\t:resourceId="resourceId"\n\t\t\t\t:bindElement="() => $el"\n\t\t\t\t@close="isDisabledPopupShown = false"\n\t\t\t/>\n\t\t\t<slot/>\n\t\t</div>\n\t`};function ve({booking:t,colliding:e,selectedDateTs:o,draggedBookingResourcesIds:i}){const s=new Date(o).setHours(0,0,0,0);const n=new Date(o).setHours(24,0,0,0);const r={fromTs:s,toTs:n};if(i.length>1){const o=e.find((({fromTs:e})=>e===t.dateFromTs));if(o&&i.every((t=>o.resourcesIds.includes(t)))){return null}}for(const{fromTs:o,toTs:i}of e){if(i<=t.dateFromTs){r.fromTs=Math.max(r.fromTs,i)}if(t.dateToTs<=o){r.toTs=Math.min(r.toTs,o)}}if(r.fromTs===s&&r.toTs===n){return null}return r}function Te(t,e,o){const i=o.dateToTs-o.dateFromTs;if(e.dateFromTs>=t.fromTs&&e.dateFromTs+i<=t.toTs){return{dateFromTs:e.dateFromTs,dateToTs:e.dateFromTs+i}}if(e.dateToTs-i>=t.fromTs&&e.dateToTs<=t.toTs){return{dateFromTs:e.dateToTs-i,dateToTs:e.dateToTs}}return{dateFromTs:t.fromTs,dateToTs:t.fromTs+i}}function Be(t){const e=t.length>0?t.length:1;return ke/e}function ye({bookingId:t,bookingWidth:e,overlappingBookings:o}){let i=o.indexOf(t);if(i===-1){i=0}return e*i}const Me={name:"Booking",props:{bookingId:{type:[Number,String],required:true},resourceId:{type:Number,required:true},nowTs:{type:Number,required:true},bookingUiGroups:{type:Array,default:()=>[]}},data(){return{dropArea:false,freeSpace:null}},computed:{...rt.mapGetters({getBookingById:`${ut.Model.Bookings}/getById`,overbookingMap:`${ut.Model.Bookings}/overbookingMap`,selectedDateTs:`${ut.Model.Interface}/selectedDateTs`,deletingBookings:`${ut.Model.Interface}/deletingBookings`,draggedBookingId:`${ut.Model.Interface}/draggedBookingId`,editingBookingId:`${ut.Model.Interface}/editingBookingId`,isBookingCreatedFromEmbed:`${ut.Model.Interface}/isBookingCreatedFromEmbed`}),booking(){return this.getBookingById(this.bookingId)},deletingBookings(){return Object.values(this.$store.getters[`${ut.Model.Interface}/deletingBookings`])},overbooking(){return this.overbookingMap.get(this.bookingId)||null},overbookingInResource(){var t,e;return((t=this.overbooking)==null?void 0:(e=t.items)==null?void 0:e.find((t=>t.resourceId===this.resourceId)))||null},hasOverbooking(){var t;return(((t=this.overbookingInResource)==null?void 0:t.intersections)||[]).some((({id:t})=>!this.deletingBookings.includes(t)))},isShifted(){return this.hasOverbooking&&at.Type.isPlainObject(this.overbookingInResource)&&this.overbookingInResource.shifted},overlappingBookings(){var t;const e=!this.isShifted||!this.hasOverbooking?this.bookingId:this.overbookingDependencies[0];return((t=this.bookingUiGroups.find((({bookingIds:t})=>t.includes(e))))==null?void 0:t.bookingIds)||[]},overbookingDependencies(){var t;return(((t=this.overbookingInResource)==null?void 0:t.intersections)||[]).map((({id:t})=>t))},bookingWidth(){if(this.hasOverbooking){return Be(this.overlappingBookings)/2}return Be(this.overlappingBookings)},leftOffset(){if(this.isShifted){const t=this.overbookingDependencies[0];const e=ye({bookingId:t,bookingWidth:this.bookingWidth,overlappingBookings:this.overlappingBookings});return e*2+this.bookingWidth}return ye({bookingId:this.booking.id,bookingWidth:this.hasOverbooking?this.bookingWidth*2:this.bookingWidth,overlappingBookings:this.overlappingBookings})},actionsPopupOptions(){return{overbooking:{disabled:this.overbooking!==null}}},realBooking(){return at.Type.isNumber(this.bookingId)},hasAccent(){return this.editingBookingId===this.bookingId||this.isBookingCreatedFromEmbed(this.bookingId)}},methods:{dragMouseEnter(){if(this.dropArea){return}const t=this.draggedBookingId;if(t===null){return}const e=this.getBookingById(t);const o=this.booking.dateToTs-this.booking.dateFromTs;const i=e.dateToTs-e.dateFromTs;if(o>=i&&e.resourcesIds.length<=1){this.freeSpace={fromTs:this.booking.dateFromTs,toTs:this.booking.dateToTs,resourcesIds:this.booking.resourcesIds};this.dropArea=true;return}const s=t=>{if(t.id===this.draggedBookingId){return true}const e=this.overbookingMap.get(t.id);const o=this.resourceId;return!e||e.items.some((t=>t.resourceId===o))};const n=this.$store.getters[`${ut.Model.Interface}/getColliding`](this.resourceId,s);if(n.length===0){this.freeSpace={fromTs:this.booking.dateFromTs,toTs:this.booking.dateToTs,resourcesIds:this.booking.resourcesIds};this.dropArea=true;return}const r=ve({booking:this.booking,colliding:n,selectedDateTs:this.selectedDateTs,draggedBookingResourcesIds:e.resourcesIds});this.freeSpace=r;this.dropArea=r&&r.toTs-r.fromTs>=i},dragMouseLeave(){this.dropArea=false;this.freeSpace=null},dropBooking(){const t=this.draggedBookingId;if(!t||!this.freeSpace){return}const e=this.getBookingById(t);const{dateFromTs:o,dateToTs:i}=Te(this.freeSpace,this.booking,e);const s={id:t,dateFromTs:o,dateToTs:i,timezoneFrom:e.timezoneFrom,timezoneTo:e.timezoneTo,resourcesIds:[...new Set([this.resourceId,...e.resourcesIds.slice(1,e.resourcesIds.length)])]};if(!B.isRealId(t)){void this.$store.dispatch(`${ut.Model.Bookings}/update`,{id:t,booking:s});return}void Z.bookingService.update({id:t,...s})},startDropHandler(){at.Event.bind(this.$el,"mousemove",this.dragMouseEnter,{capture:true});at.Event.bind(this.$el,"mouseleave",this.dragMouseLeave,{capture:true});at.Event.bind(this.$el,"mouseup",this.dropBooking,{capture:true})},stopDropHandler(){this.dropArea=false;this.freeSpace=null;at.Event.unbind(this.$el,"mousemove",this.dragMouseEnter,{capture:true});at.Event.unbind(this.$el,"mouseleave",this.dragMouseLeave,{capture:true});at.Event.unbind(this.$el,"mouseup",this.dropBooking,{capture:true})}},watch:{draggedBookingId(t){if(t===this.bookingId||this.hasOverbooking){return}if(t===null){this.stopDropHandler()}else{this.startDropHandler()}}},components:{BookingBase:Ie,Actions:ie},template:`\n\t\t<BookingBase\n\t\t\t:bookingId\n\t\t\t:resourceId\n\t\t\t:nowTs\n\t\t\t:leftOffset\n\t\t\t:bookingClass="{\n\t\t\t\t'--short': overlappingBookings.length > 1,\n\t\t\t\t'--overbooking': hasOverbooking,\n\t\t\t\t'--shifted': isShifted && !realBooking,\n\t\t\t\t'--drop-area': dropArea,\n\t\t\t\t'--accent': hasAccent,\n\t\t\t}"\n\t\t\t:width="bookingWidth"\n\t\t>\n\t\t\t<template #actions>\n\t\t\t\t<Actions\n\t\t\t\t\t:bookingId\n\t\t\t\t\t:resourceId\n\t\t\t\t\t:actionsPopupOptions\n\t\t\t\t/>\n\t\t\t</template>\n\t\t\t<div class="booking--booking-pseudo-overbooking"></div>\n\t\t</BookingBase>\n\t`};const Ee={emits:["close"],props:{busySlot:{type:Object,required:true}},computed:{...rt.mapGetters({offset:`${ut.Model.Interface}/offset`,mousePosition:`${ut.Model.Interface}/mousePosition`}),resource(){const t=this.busySlot.type===ut.BusySlot.Intersection?this.busySlot.intersectingResourceId:this.busySlot.resourceId;return this.$store.getters[`${ut.Model.Resources}/getById`](t)},popupId(){return`booking-booking-busy-popup-${this.busySlot.resourceId}`},config(){const t=200;const e=K.Popup.getOption("angleMinBottom");const o=t/2-e;return{bindElement:this.mousePosition,width:t,background:"#2878ca",offsetTop:-5,offsetLeft:-o+e,bindOptions:{forceBindPosition:true,position:"top"},angle:{offset:o,position:"bottom"},angleBorderRadius:"4px 0",autoHide:false}},textFormatted(){const t=tt.DateTimeFormat.getFormat("SHORT_TIME_FORMAT");const e=this.busySlot.type===ut.BusySlot.Intersection?"BOOKING_BOOKING_INTERSECTING_RESOURCE_IS_BUSY":"BOOKING_BOOKING_RESOURCE_IS_BUSY";return this.loc(e,{"#RESOURCE#":this.resource.name,"#TIME_FROM#":tt.DateTimeFormat.format(t,(this.busySlot.fromTs+this.offset)/1e3),"#TIME_TO#":tt.DateTimeFormat.format(t,(this.busySlot.toTs+this.offset)/1e3)})}},methods:{adjustPosition(){var t;const e=(t=this.$refs.popup)==null?void 0:t.getPopupInstance();if(!e){return}e.setBindElement(this.mousePosition);e.adjustPosition()},closePopup(){this.$emit("close")}},watch:{mousePosition:{handler(){this.adjustPosition()},deep:true}},components:{Popup:y.Popup},template:`\n\t\t<Popup\n\t\t\t:id="popupId"\n\t\t\t:config="config"\n\t\t\tref="popup"\n\t\t\t@close="closePopup"\n\t\t>\n\t\t\t<div class="booking-booking-busy-popup">\n\t\t\t\t{{ textFormatted }}\n\t\t\t</div>\n\t\t</Popup>\n\t`};const{mapGetters:Se}=rt.createNamespacedHelpers(ut.Model.Interface);const Ce="booking-booking-busy-slot";const we={name:"BusySlot",props:{busySlot:{type:Object,required:true}},setup(){return{BookingBusySlotClassName:Ce}},data(){return{isPopupShown:false}},computed:{...Se({disabledBusySlots:"disabledBusySlots",isFilterMode:"isFilterMode",isEditingBookingMode:"isEditingBookingMode",isDragMode:"isDragMode"}),isDisabled(){const t=this.isDragMode&&this.busySlot.type===ut.BusySlot.OffHours;if(this.isFilterMode||t){return true}return this.busySlot.id in this.disabledBusySlots},left(){return C.grid.calculateLeft(this.busySlot.resourceId)},top(){return C.grid.calculateTop(this.busySlot.fromTs)},height(){return C.grid.calculateHeight(this.busySlot.fromTs,this.busySlot.toTs)}},methods:{onClick(){if(this.isFilterMode||this.isEditingBookingMode||this.busySlot.type===ut.BusySlot.Intersection){return}void this.$store.dispatch(`${ut.Model.Interface}/addDisabledBusySlot`,this.busySlot)},onMouseEnter(){clearTimeout(this.showTimeout);this.showTimeout=setTimeout((()=>this.showPopup()),300);at.Event.unbind(document,"mousemove",this.onMouseMove);at.Event.bind(document,"mousemove",this.onMouseMove)},onMouseMove(t){if(this.cursorInsideContainer(t.target)){this.updatePopup(t)}else{at.Event.unbind(document,"mousemove",this.onMouseMove);this.closePopup()}},onMouseLeave(t){var e,o;if((e=t.relatedTarget)!=null&&(o=e.closest(".popup-window"))!=null&&o.querySelector(".booking-booking-busy-popup")){return}at.Event.unbind(document,"mousemove",this.onMouseMove);this.closePopup()},cursorInsideContainer(t){return!at.Type.isNull(t)&&at.Dom.hasClass(t,this.BookingBusySlotClassName)},updatePopup(t){var e,o;const i=(e=this.$refs.container)==null?void 0:e.getBoundingClientRect();if(this.isDragMode||!i||t.clientY>i.top+i.height||t.clientY<i.top||t.clientX<i.left||t.clientX>i.left+i.width){this.closePopup();return}(o=this.showTimeout)!=null?o:this.showTimeout=setTimeout((()=>this.showPopup()),300)},showPopup(){this.isPopupShown=true},closePopup(){clearTimeout(this.showTimeout);this.showTimeout=null;this.isPopupShown=false}},components:{BusyPopup:Ee},template:`\n\t\t<div\n\t\t\tv-if="left >= 0"\n\t\t\t:class="[BookingBusySlotClassName, {\n\t\t\t\t'--disabled': isDisabled,\n\t\t\t}]"\n\t\t\t:style="{\n\t\t\t\t'--left': left + 'px',\n\t\t\t\t'--top': top + 'px',\n\t\t\t\t'--height': height + 'px',\n\t\t\t}"\n\t\t\tdata-element="booking-busy-slot"\n\t\t\t:data-id="busySlot.resourceId"\n\t\t\t:data-from="busySlot.fromTs"\n\t\t\t:data-to="busySlot.toTs"\n\t\t\tref="container"\n\t\t\t@click.stop="onClick"\n\t\t\t@mouseenter.stop="onMouseEnter"\n\t\t\t@mouseleave.stop="onMouseLeave"\n\t\t></div>\n\t\t<BusyPopup\n\t\t\tv-if="isPopupShown"\n\t\t\t:busySlot="busySlot"\n\t\t\t@close="closePopup"\n\t\t/>\n\t`};const Oe={props:{cell:{type:Object,required:true},className:{type:[String,Object],default:""}},components:{Icon:U.BIcon},data(){return{IconSet:U.Set}},computed:{...rt.mapGetters({selectedCells:`${ut.Model.Interface}/selectedCells`,zoom:`${ut.Model.Interface}/zoom`,intersections:`${ut.Model.Interface}/intersections`,timezone:`${ut.Model.Interface}/timezone`,offset:`${ut.Model.Interface}/offset`,isFeatureEnabled:`${ut.Model.Interface}/isFeatureEnabled`,draggedBookingId:`${ut.Model.Interface}/draggedBookingId`,embedItems:`${ut.Model.Interface}/embedItems`}),selected(){return this.cell.id in this.selectedCells},hasSelectedCells(){return Object.keys(this.selectedCells).length>0},timeFormatted(){const t=tt.DateTimeFormat.getFormat("SHORT_TIME_FORMAT");return this.loc("BOOKING_BOOKING_TIME_RANGE",{"#FROM#":tt.DateTimeFormat.format(t,(this.cell.fromTs+this.offset)/1e3),"#TO#":tt.DateTimeFormat.format(t,(this.cell.toTs+this.offset)/1e3)})},height(){return C.grid.calculateRealHeight(this.cell.fromTs,this.cell.toTs)},externalData(){return this.embedItems},clients(){const t=this.embedItems.filter((t=>t.entityTypeId==="CONTACT"||t.entityTypeId==="COMPANY"));return t.map((t=>({id:t.value,type:{code:t.entityTypeId,module:t.moduleId}})))}},methods:{onCellSelected({target:{checked:t}}){if(!this.isFeatureEnabled){Y.limit.show();return}if(t){this.$store.dispatch(`${ut.Model.Interface}/addSelectedCell`,this.cell)}else{this.$store.dispatch(`${ut.Model.Interface}/removeSelectedCell`,this.cell)}},onMouseDown(){var t,e;if(!this.isFeatureEnabled){void Y.limit.show();return}void this.$store.dispatch(`${ut.Model.Interface}/setHoveredCell`,null);this.creatingBookingId=`tmp-id-${Date.now()}-${Math.random()}`;void this.$store.dispatch(`${ut.Model.Interface}/addQuickFilterIgnoredBookingId`,this.creatingBookingId);void this.$store.dispatch(`${ut.Model.Bookings}/add`,{id:this.creatingBookingId,dateFromTs:this.cell.fromTs,dateToTs:this.cell.toTs,resourcesIds:[...new Set([this.cell.resourceId,...(t=this.intersections[0])!=null?t:[],...(e=this.intersections[this.cell.resourceId])!=null?e:[]])],timezoneFrom:this.timezone,timezoneTo:this.timezone,externalData:this.externalData,clients:this.clients});void this.addCreatedFromEmbedBooking(this.creatingBookingId);at.Event.bind(window,"mouseup",this.addBooking)},addBooking(){at.Event.unbind(window,"mouseup",this.addBooking);if(!this.isFeatureEnabled){void Y.limit.show();return}setTimeout((async()=>{const t=this.$store.getters[`${ut.Model.Bookings}/getById`](this.creatingBookingId);const e=await Z.bookingService.add(t);if(e.success&&e.booking){const t=this.$store.getters[`${ut.Model.Bookings}/overbookingMap`];st.BookingAnalytics.sendAddBooking({isOverbooking:Boolean(t==null?void 0:t.has==null?void 0:t.has(e.booking.id))});await this.addCreatedFromEmbedBooking(e.booking.id)}}))},async addCreatedFromEmbedBooking(t){await this.$store.dispatch(`${ut.Model.Interface}/addCreatedFromEmbedBooking`,t)}},template:`\n\t\t<div\n\t\t\tclass="booking-booking-base-cell"\n\t\t\t:class="[className, {\n\t\t\t\t'--selected': selected,\n\t\t\t\t'--bounded-to-bottom': cell.boundedToBottom,\n\t\t\t\t'--height-is-less-than-40': height < 40,\n\t\t\t\t'--compact-mode': height < 40 || zoom < 0.8,\n\t\t\t\t'--small': height <= 12.5,\n\t\t\t}]"\n\t\t\t:style="{\n\t\t\t\t'--height': height + 'px',\n\t\t\t}"\n\t\t\tdata-element="booking-base-cell"\n\t\t\t:data-resource-id="cell.resourceId"\n\t\t\t:data-from="cell.fromTs"\n\t\t\t:data-to="cell.toTs"\n\t\t\t:data-selected="selected"\n\t\t>\n\t\t\t<div class="booking-booking-grid-cell-padding">\n\t\t\t\t<div class="booking-booking-grid-cell-inner">\n\t\t\t\t\t<label\n\t\t\t\t\t\tclass="booking-booking-grid-cell-time"\n\t\t\t\t\t\tdata-element="booking-grid-cell-select-label"\n\t\t\t\t\t>\n\t\t\t\t\t\t<span class="booking-booking-grid-cell-time-inner">\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\tv-if="!draggedBookingId"\n\t\t\t\t\t\t\t\tclass="booking-booking-grid-cell-checkbox"\n\t\t\t\t\t\t\t\ttype="checkbox"\n\t\t\t\t\t\t\t\t:checked="selected"\n\t\t\t\t\t\t\t\t@change="onCellSelected"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<span data-element="booking-grid-cell-time">\n\t\t\t\t\t\t\t\t{{ timeFormatted }}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</label>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="!hasSelectedCells && !draggedBookingId"\n\t\t\t\t\t\tclass="booking-booking-grid-cell-select-button-container"\n\t\t\t\t\t\tref="button"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tclass="booking-booking-grid-cell-select-button"\n\t\t\t\t\t\t\t:class="{'--lock': !isFeatureEnabled}"\n\t\t\t\t\t\t\tdata-element="booking-grid-cell-add-button"\n\t\t\t\t\t\t\t@mousedown="onMouseDown"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div class="booking-booking-grid-cell-select-button-text">\n\t\t\t\t\t\t\t\t{{ loc('BOOKING_BOOKING_SELECT') }}\n\t\t\t\t\t\t\t\t<Icon v-if="!isFeatureEnabled" :name="IconSet.LOCK" />\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="ui-icon-set --chevron-right"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const Pe={props:{cell:{type:Object,required:true}},computed:{...rt.mapGetters({overbookingMap:`${ut.Model.Bookings}/overbookingMap`}),overbookingPositionsInCell(){const t=this.cell.resourceId;const e={dateFromTs:this.cell.fromTs,dateToTs:this.cell.toTs};const o=[];for(const[,i]of this.overbookingMap){const s=i.items.find((e=>e.resourceId===t));if(s&&M.checkBookingIntersection(i.booking,e)&&!o.includes(s==null?void 0:s.shifted)){o.push(s==null?void 0:s.shifted)}if(o.length>2){break}}return o},left(){const t=C.grid.calculateLeft(this.cell.resourceId);const e=this.overbookingPositionsInCell;if(e.length>1){return-1}if(e.length===0||e[0]){return t}return t+C.grid.calculateWidth(this.width)},top(){return C.grid.calculateTop(this.cell.fromTs)},height(){return C.grid.calculateHeight(this.cell.fromTs,this.cell.toTs)},width(){return this.overbookingPositionsInCell.length===0?280:280/2}},components:{BaseCell:Oe},template:`\n\t\t<div\n\t\t\tv-if="left >= 0"\n\t\t\tclass="booking-booking-selected-cell"\n\t\t\t:style="{\n\t\t\t\t'--left': left + 'px',\n\t\t\t\t'--top': top + 'px',\n\t\t\t\t'--height': height + 'px',\n\t\t\t\t'--width': width + 'px',\n\t\t\t}"\n\t\t\t@mouseleave="$store.dispatch('interface/setHoveredCell', null)"\n\t\t>\n\t\t\t<BaseCell\n\t\t\t\t:cell="cell"\n\t\t\t\t:className="{ '--overbooking': overbookingPositionsInCell.length > 0 }"\n\t\t\t/>\n\t\t</div>\n\t`};const De={props:{hour:{type:Number,required:true}},computed:{...rt.mapGetters({selectedDateTs:`${ut.Model.Interface}/selectedDateTs`,resourcesIds:`${ut.Model.Interface}/resourcesIds`}),top(){return C.grid.calculateTop(this.fromTs)},width(){return this.resourcesIds.length*280},fromTs(){return new Date(this.selectedDateTs).setHours(this.hour)}},template:`\n\t\t<div\n\t\t\tclass="booking-booking-quick-filter-line"\n\t\t\t:style="{\n\t\t\t\t'--top': top + 'px',\n\t\t\t\t'--width': width + 'px',\n\t\t\t}"\n\t\t></div>\n\t`};const Fe=15*60*1e3;function $e({dateFromTs:t,dateToTs:e}){const o=e-t;return[t,o<Fe?t+Fe:e]}function Re(t,e,o){var i;return{...e,resourcesIds:[t],uiSlot:$e(e),overbooking:o==null?void 0:(i=o.items)==null?void 0:i.some((e=>e.resourceId===t&&e.shifted))}}function He(t){const e=new Map;for(const i of t){var o;const t=((o=i.resourcesIds)==null?void 0:o[0])||0;let s=[];if(e.has(t)){s=e.get(t)||[]}s.push(i);e.set(t,s)}return e}function Ne(t){const e=[];if(t.length===0){return e}let o={slot:[0,0],bookingIds:[]};t.filter((t=>!t.overbooking)).map((t=>({id:t.id,uiSlot:t.uiSlot}))).sort(((t,e)=>t.uiSlot[0]-e.uiSlot[0])).forEach((t=>{if(o.bookingIds.length===0){o.slot=[t.uiSlot[0],t.uiSlot[1]]}else if(w.inInterval(t.uiSlot[0],o.slot)){o.slot[1]=t.uiSlot[1]}else{e.push(o);o={slot:[t.uiSlot[0],t.uiSlot[1]],bookingIds:[]}}o.bookingIds.push(t.id)}));e.push(o);return e}function Le(t){const e=new Map;if(t instanceof Map){[...t.keys()].forEach((o=>{const i=Ne(t.get(o)||[]);e.set(o,i)}))}return e}const{mapGetters:_e}=rt.createNamespacedHelpers(ut.Model.Bookings);const{mapGetters:Ae}=rt.createNamespacedHelpers(ut.Model.Interface);const ze={name:"Bookings",data(){return{nowTs:Date.now()}},computed:{..._e({overbookingMap:"overbookingMap"}),...Ae({resourcesIds:"resourcesIds",selectedDateTs:"selectedDateTs",isFilterMode:"isFilterMode",filteredBookingsIds:"filteredBookingsIds",selectedCells:"selectedCells",hoveredCell:"hoveredCell",busySlots:"busySlots",quickFilter:"quickFilter",isFeatureEnabled:"isFeatureEnabled",editingBookingId:"editingBookingId",embedItems:"embedItems"}),resourcesHash(){const t=this.$store.getters[`${ut.Model.Resources}/getByIds`](this.resourcesIds).map((({id:t,slotRanges:e})=>({id:t,slotRanges:e})));return JSON.stringify(t)},bookingsHash(){const t=this.bookings.map((({id:t,dateFromTs:e,dateToTs:o})=>({id:t,dateFromTs:e,dateToTs:o})));return JSON.stringify(t)},bookings(){const t=this.selectedDateTs;let e=[];if(this.isFilterMode){e=this.$store.getters[`${ut.Model.Bookings}/getByDateAndIds`](t,this.filteredBookingsIds)}else{e=this.$store.getters[`${ut.Model.Bookings}/getByDateAndResources`](t,this.resourcesIds)}return e.flatMap((t=>t.resourcesIds.filter((t=>this.resourcesIds.includes(t))).map((e=>Re(e,t,this.overbookingMap.get(t.id))))))},cells(){const t=[...Object.values(this.selectedCells),this.hoveredCell];const e=this.selectedDateTs;const o=new Date(e).setDate(new Date(e).getDate()+1);return t.filter((t=>t&&t.toTs>e&&o>t.fromTs))},quickFilterHours(){const t=new Set(Object.values(this.quickFilter.active));return Object.values(this.quickFilter.hovered).filter((e=>!t.has(e)))},resourceBookings(){return He(this.bookings)},resourceBookingsUiGroupsMap(){return Le(this.resourceBookings)},embedEditingMode(){var t,e;return this.isFeatureEnabled&&(this.editingBookingId>0||((t=(e=this.embedItems)==null?void 0:e.length)!=null?t:0)>0)}},mounted(){this.startInterval();if(this.isFeatureEnabled){const t=this.editingBookingId?`[data-id="${this.editingBookingId}"]`:"";this.dragManager=new c.Drag({container:this.$el.parentElement,draggable:`.booking-booking-booking${t}`})}},beforeUnmount(){var t;(t=this.dragManager)==null?void 0:t.destroy()},methods:{generateBookingKey(t){return`${t.id}-${t.resourcesIds[0]}`},getBookingUiGroupsByResourceId(t){return this.resourceBookingsUiGroupsMap.get(t)||[]},startInterval(){setInterval((()=>{this.nowTs=Date.now()}),5*1e3)}},watch:{selectedDateTs(){void j.busySlots.loadBusySlots()},bookingsHash(){void j.busySlots.loadBusySlots()},resourcesHash(){void j.busySlots.loadBusySlots()},overbookingMap(){void j.busySlots.loadBusySlots()}},components:{Booking:Me,BusySlot:we,Cell:Pe,QuickFilterLine:De},template:`\n\t\t<div\n\t\t\tclass="booking-booking-bookings"\n\t\t\t:class="{\n\t\t\t\t'embed-editing-mode': embedEditingMode,\n\t\t\t}"\n\t\t>\n\t\t\t<TransitionGroup name="booking-transition-booking">\n\t\t\t\t<template v-for="booking of bookings" :key="generateBookingKey(booking)">\n\t\t\t\t\t<Booking\n\t\t\t\t\t\t:bookingId="booking.id"\n\t\t\t\t\t\t:resourceId="booking.resourcesIds[0]"\n\t\t\t\t\t\t:nowTs\n\t\t\t\t\t\t:bookingUiGroups="getBookingUiGroupsByResourceId(booking.resourcesIds[0])"\n\t\t\t\t\t/>\n\t\t\t\t</template>\n\t\t\t</TransitionGroup>\n\t\t\t<template v-for="busySlot of busySlots" :key="busySlot.id">\n\t\t\t\t<BusySlot\n\t\t\t\t\t:busySlot="busySlot"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t\t<template v-for="cell of cells" :key="cell.id">\n\t\t\t\t<Cell\n\t\t\t\t\t:cell="cell"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t\t<template v-for="hour of quickFilterHours" :key="hour">\n\t\t\t\t<QuickFilterLine\n\t\t\t\t\t:hour="hour"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t</div>\n\t`};const xe=30*60*1e3;const Ge={name:"Cell",props:{cell:{type:Object,required:true}},data(){return{halfOffset:0}},computed:{...rt.mapGetters({overbookingMap:`${ut.Model.Bookings}/overbookingMap`,isFilterMode:`${ut.Model.Interface}/isFilterMode`,isEditingBookingMode:`${ut.Model.Interface}/isEditingBookingMode`,draggedBookingId:`${ut.Model.Interface}/draggedBookingId`,resizedBookingId:`${ut.Model.Interface}/resizedBookingId`,quickFilter:`${ut.Model.Interface}/quickFilter`}),isAvailable(){if(this.isFilterMode||this.resizedBookingId||this.isEditingBookingMode&&!this.draggedBookingId){return false}const{fromTs:t,toTs:e}=this.freeSpace;const o=this.cell.fromTs;const i=this.cell.fromTs+xe;return(e>o||e>i)&&e-t>=this.duration},fromTs(){return Math.min(this.freeSpace.toTs-this.duration,this.cell.fromTs)+this.halfOffset},toTs(){return this.fromTs+this.duration},duration(){if(this.draggedBooking){return this.draggedBooking.dateToTs-this.draggedBooking.dateFromTs}return this.cell.toTs-this.cell.fromTs},draggedBooking(){var t;return(t=this.$store.getters[`${ut.Model.Bookings}/getById`](this.draggedBookingId))!=null?t:null},freeSpace(){let t=0;let e=Infinity;for(const{fromTs:o,toTs:i}of this.colliding){if(this.cell.fromTs+xe>o&&this.cell.fromTs+xe<i){t=i;e=o;break}if(i<=this.cell.fromTs+xe){t=Math.max(t,i)}if(o>=this.cell.fromTs+xe){e=Math.min(e,o)}}return{fromTs:t,toTs:e}},colliding(){return this.$store.getters[`${ut.Model.Interface}/getColliding`](this.cell.resourceId,this.excludeBookingColliding)},quickFilterHovered(){return this.cell.minutes/60 in this.quickFilter.hovered},quickFilterActive(){return this.cell.minutes/60 in this.quickFilter.active}},methods:{excludeBookingColliding(t){if(t.id===this.draggedBookingId){return true}const e=this.cell.resourceId;const o=this.overbookingMap.get(t.id);return o&&o.items.some((t=>t.resourceId===e))},mouseEnterHandler(t){this.updateHalfHour(t)},mouseLeaveHandler(t){var e,o;const i=(e=t.relatedTarget)==null?void 0:e.closest(".booking-booking-base-cell");if(!i||(i==null?void 0:(o=i.dataset)==null?void 0:o.selected)==="true"){void this.$store.dispatch(`${ut.Model.Interface}/setHoveredCell`,null)}},mouseMoveHandler(t){this.updateHalfHour(t)},updateHalfHour(t){var e;if((e=this.$refs.button)!=null&&e.contains(t.target)){return}this.halfOffset=0;const o=t.clientY-window.scrollY;const i=this.$el.getBoundingClientRect();const s=o>(i.top+i.top+i.height)/2;const n=this.fromTs>=this.freeSpace.fromTs;const r=this.toTs+xe<=this.freeSpace.toTs;if(s&&r||!s&&!n){this.halfOffset=xe}if(!s&&!n&&this.freeSpace.fromTs-this.cell.fromTs>0){this.halfOffset=this.freeSpace.fromTs-this.cell.fromTs}if(!s&&n||s&&!r){this.halfOffset=0}const a=s===(this.halfOffset===0);if(this.duration<=xe&&a){this.clearCell(t);return}this.hoverCell({id:`${this.cell.resourceId}-${this.fromTs}-${this.toTs}`,fromTs:this.fromTs,toTs:this.toTs,resourceId:this.cell.resourceId,boundedToBottom:this.toTs===this.freeSpace.toTs})},clearCell(t){var e,o;const i=(e=t.relatedTarget)==null?void 0:e.closest(".booking-booking-base-cell");if(!i||(i==null?void 0:(o=i.dataset)==null?void 0:o.selected)==="true"){void this.$store.dispatch(`${ut.Model.Interface}/setHoveredCell`,null)}},hoverCell(t){void this.$store.dispatch(`${ut.Model.Interface}/setHoveredCell`,null);if(this.isAvailable){void this.$store.dispatch(`${ut.Model.Interface}/setHoveredCell`,t)}}},watch:{draggedBookingId(){if(!this.draggedBookingId){void this.$store.dispatch(`${ut.Model.Interface}/setHoveredCell`,null)}}},template:`\n\t\t<div\n\t\t\tclass="booking-booking-grid-cell"\n\t\t\t:class="{\n\t\t\t\t'--quick-filter-hovered': quickFilterHovered,\n\t\t\t\t'--quick-filter-active': quickFilterActive,\n\t\t\t}"\n\t\t\tdata-element="booking-grid-cell"\n\t\t\t:data-resource-id="cell.resourceId"\n\t\t\t:data-from="cell.fromTs"\n\t\t\t:data-to="cell.toTs"\n\t\t\t@mouseenter="mouseEnterHandler"\n\t\t\t@mouseleave="mouseLeaveHandler"\n\t\t\t@mousemove="mouseMoveHandler"\n\t\t></div>\n\t`};const Ke={props:{bottom:{type:Boolean,default:false}},computed:rt.mapGetters({offHoursHover:`${ut.Model.Interface}/offHoursHover`,offHoursExpanded:`${ut.Model.Interface}/offHoursExpanded`}),methods:{animateOffHours({keepScroll:t}){if(this.offHoursExpanded){Ot.collapse()}else{Ot.expand({keepScroll:t})}void this.$store.dispatch(`${ut.Model.Interface}/setOffHoursExpanded`,!this.offHoursExpanded)}},template:`\n\t\t<div class="booking-booking-grid-padding">\n\t\t\t<div\n\t\t\t\tclass="booking-booking-column-off-hours"\n\t\t\t\t:class="{'--bottom': bottom, '--hover': offHoursHover}"\n\t\t\t\t@click="animateOffHours({ keepScroll: bottom })"\n\t\t\t\t@mouseenter="$store.dispatch('interface/setOffHoursHover', true)"\n\t\t\t\t@mouseleave="$store.dispatch('interface/setOffHoursHover', false)"\n\t\t\t></div>\n\t\t</div>\n\t`};const{mapGetters:Ue}=rt.createNamespacedHelpers(ut.Model.Interface);const Xe={props:{resourceId:Number},data(){return{visible:true}},mounted(){this.updateVisibility();this.updateVisibilityDuringTransition()},computed:{...Ue({resourcesIds:"resourcesIds",zoom:"zoom",scroll:"scroll",selectedDateTs:"selectedDateTs",offHoursHover:"offHoursHover",offHoursExpanded:"offHoursExpanded",fromHour:"fromHour",toHour:"toHour",offset:"offset"}),resource(){return this.$store.getters["resources/getById"](this.resourceId)},fromMinutes(){return this.fromHour*60},toMinutes(){return this.toHour*60},slotSize(){var t,e;return(t=(e=this.resource.slotRanges[0])==null?void 0:e.slotSize)!=null?t:60},offHoursTopCells(){return this.cells.filter((t=>t.minutes<this.fromMinutes))},workTimeCells(){return this.cells.filter((t=>t.minutes>=this.fromMinutes&&t.minutes<this.toMinutes))},offHoursBottomCells(){return this.cells.filter((t=>t.minutes>=this.toMinutes))},cells(){const t=3600*1e3;const e=this.selectedDateTs;const o=new Date(e).setDate(new Date(e).getDate()+1);return O.range(e,o-t,t).map((t=>{const e=t+this.slotSize*60*1e3;return{id:`${this.resource.id}-${t}-${e}`,fromTs:t,toTs:e,minutes:new Date(t+this.offset).getHours()*60,resourceId:this.resource.id}}))}},methods:{updateVisibilityDuringTransition(){var t;(t=this.animation)==null?void 0:t.stop();this.animation=new BX.easing({duration:200,start:{},finish:{},step:this.updateVisibility});this.animation.animate()},updateVisibility(){const t=this.$el.getBoundingClientRect();this.visible=t.right>0&&t.left<window.innerWidth}},watch:{scroll(){this.updateVisibility()},zoom(){this.updateVisibility()},resourcesIds(){this.updateVisibilityDuringTransition()}},components:{Cell:Ge,OffHours:Ke},template:`\n\t\t<div\n\t\t\tclass="booking-booking-grid-column"\n\t\t\tdata-element="booking-grid-column"\n\t\t\t:data-id="resourceId"\n\t\t>\n\t\t\t<template v-if="visible">\n\t\t\t\t<OffHours/>\n\t\t\t\t<div class="booking-booking-grid-off-hours-cells">\n\t\t\t\t\t<Cell v-for="cell of offHoursTopCells" :key="cell.id" :cell="cell"/>\n\t\t\t\t</div>\n\t\t\t\t<Cell v-for="cell of workTimeCells" :key="cell.id" :cell="cell"/>\n\t\t\t\t<div class="booking-booking-grid-off-hours-cells --bottom">\n\t\t\t\t\t<Cell v-for="cell of offHoursBottomCells" :key="cell.id" :cell="cell"/>\n\t\t\t\t</div>\n\t\t\t\t<OffHours :bottom="true"/>\n\t\t\t</template>\n\t\t</div>\n\t`};let qe=t=>t,Ve;const je=200;const We="ui-counter-panel__scope";const Ye="bitrix24-dark-theme";var Ze=babelHelpers.classPrivateFieldLooseKey("slider");var Qe=babelHelpers.classPrivateFieldLooseKey("overlay");var Je=babelHelpers.classPrivateFieldLooseKey("handleSliderClose");var to=babelHelpers.classPrivateFieldLooseKey("renderOverlay");var eo=babelHelpers.classPrivateFieldLooseKey("appContainer");var oo=babelHelpers.classPrivateFieldLooseKey("appHeader");var io=babelHelpers.classPrivateFieldLooseKey("counterPanel");var so=babelHelpers.classPrivateFieldLooseKey("appContent");var no=babelHelpers.classPrivateFieldLooseKey("appContentPaddingBottomElement");var ro=babelHelpers.classPrivateFieldLooseKey("imBar");var ao=babelHelpers.classPrivateFieldLooseKey("imBarWidth");var lo=babelHelpers.classPrivateFieldLooseKey("isExpanded");var co=babelHelpers.classPrivateFieldLooseKey("getInset");var uo=babelHelpers.classPrivateFieldLooseKey("animate");var ho=babelHelpers.classPrivateFieldLooseKey("applyMaximizedStyles");var po=babelHelpers.classPrivateFieldLooseKey("applyMinimizedStyles");class go{constructor({onOverlayClick:t}){Object.defineProperty(this,po,{value:wo});Object.defineProperty(this,ho,{value:Co});Object.defineProperty(this,uo,{value:So});Object.defineProperty(this,co,{value:Eo});Object.defineProperty(this,lo,{get:Mo,set:void 0});Object.defineProperty(this,ao,{get:yo,set:void 0});Object.defineProperty(this,ro,{get:Bo,set:void 0});Object.defineProperty(this,no,{get:To,set:void 0});Object.defineProperty(this,so,{get:vo,set:void 0});Object.defineProperty(this,io,{get:Io,set:void 0});Object.defineProperty(this,oo,{get:ko,set:void 0});Object.defineProperty(this,eo,{get:fo,set:void 0});Object.defineProperty(this,to,{value:bo});Object.defineProperty(this,Je,{value:mo});Object.defineProperty(this,Ze,{writable:true,value:void 0});Object.defineProperty(this,Qe,{writable:true,value:void 0});this.onOverlayClick=t;babelHelpers.classPrivateFieldLooseBase(this,Ze)[Ze]=new(BX.SidePanel.Manager.getSliderClass())("");babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe]=babelHelpers.classPrivateFieldLooseBase(this,to)[to]();if(top.BX){this.handleSliderClose=babelHelpers.classPrivateFieldLooseBase(this,Je)[Je].bind(this);top.BX.Event.EventEmitter.subscribe("SidePanel.Slider:onCloseComplete",this.handleSliderClose);top.BX.Event.EventEmitter.subscribe("SidePanel.Slider:onDestroy",this.handleSliderClose)}}async maximize(){await P.Core.getStore().dispatch(`${ut.Model.Interface}/setExpanded`,true);babelHelpers.classPrivateFieldLooseBase(this,Ze)[Ze].applyHacks();BX.SidePanel.Instance.disablePageScrollbar();const t=babelHelpers.classPrivateFieldLooseBase(this,co)[co](babelHelpers.classPrivateFieldLooseBase(this,eo)[eo]);at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,eo)[eo],"position","fixed");at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,eo)[eo],"inset","0 0 0 0");const e=babelHelpers.classPrivateFieldLooseBase(this,co)[co](babelHelpers.classPrivateFieldLooseBase(this,eo)[eo]);babelHelpers.classPrivateFieldLooseBase(this,ho)[ho]();at.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe],"--closing");at.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe],"--opening");at.Dom.append(babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe],document.body);await babelHelpers.classPrivateFieldLooseBase(this,uo)[uo](t,e)}async minimize(){await P.Core.getStore().dispatch(`${ut.Model.Interface}/setExpanded`,false);babelHelpers.classPrivateFieldLooseBase(this,Ze)[Ze].resetHacks();BX.SidePanel.Instance.enablePageScrollbar();const t=babelHelpers.classPrivateFieldLooseBase(this,co)[co](babelHelpers.classPrivateFieldLooseBase(this,eo)[eo]);at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,eo)[eo],"position",null);const e=babelHelpers.classPrivateFieldLooseBase(this,co)[co](babelHelpers.classPrivateFieldLooseBase(this,eo)[eo]);babelHelpers.classPrivateFieldLooseBase(this,po)[po]();at.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe],"--opening");at.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe],"--closing");at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,eo)[eo],"position","fixed");await babelHelpers.classPrivateFieldLooseBase(this,uo)[uo](t,e);at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,eo)[eo],"position",null);at.Dom.remove(babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe])}}function mo(){if(babelHelpers.classPrivateFieldLooseBase(this,lo)[lo]){babelHelpers.classPrivateFieldLooseBase(this,Ze)[Ze].applyHacks();BX.SidePanel.Instance.disablePageScrollbar()}}function bo(){return at.Tag.render(Ve||(Ve=qe`
			<div class="booking-booking-overlay" onclick="${0}"></div>
		`),this.onOverlayClick)}function fo(){return BX("content-table")}function ko(){return document.querySelector(".page-header")}function Io(){return P.Core.getParams().counterPanelContainer.firstElementChild}function vo(){return BX("workarea-content")}function To(){var t;return(t=BX("workarea"))==null?void 0:t.parentElement}function Bo(){return BX("bx-im-bar")}function yo(){return window.innerWidth-babelHelpers.classPrivateFieldLooseBase(this,ro)[ro].getBoundingClientRect().left}function Mo(){return P.Core.getStore().getters[`${ut.Model.Interface}/expanded`]}function Eo(t){const e=t.getBoundingClientRect();return{left:e.left,top:e.top,right:window.innerWidth-(e.left+e.width),bottom:window.innerHeight-(e.top+e.height)}}function So(t,e){return new Promise((o=>new BX.easing({duration:je,start:t,finish:e,step:({top:t,right:e,bottom:o,left:i})=>{at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,eo)[eo],"inset",`${t}px ${e}px ${o}px ${i}px`)},complete:o}).animate()))}function Co(){at.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,io)[io],We);at.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,eo)[eo],Ye);at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,eo)[eo],"height","initial");at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,eo)[eo],"position","fixed");at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,eo)[eo],"clip-path",`inset(0 ${babelHelpers.classPrivateFieldLooseBase(this,ao)[ao]}px 0 0)`);at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,eo)[eo],"background","var(--ui-color-palette-white-base)");at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,oo)[oo],"border-bottom","1px solid var(--ui-color-base-10)");at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,oo)[oo],"max-width","100%");at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,oo)[oo].parentElement,"padding-right",`${babelHelpers.classPrivateFieldLooseBase(this,ao)[ao]}px`);at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,so)[so],"margin",0);at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,so)[so],"border-radius",0);at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,no)[no],"padding-bottom",0);at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,no)[no],"padding-right",`${babelHelpers.classPrivateFieldLooseBase(this,ao)[ao]}px`);at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe],"--right",`${babelHelpers.classPrivateFieldLooseBase(this,ao)[ao]}px`);BX.ZIndexManager.register(babelHelpers.classPrivateFieldLooseBase(this,eo)[eo],{overlay:babelHelpers.classPrivateFieldLooseBase(this,Qe)[Qe]})}function wo(){at.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,io)[io],We);at.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,eo)[eo],Ye);at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,eo)[eo],"position",null);at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,eo)[eo],"clip-path",null);at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,eo)[eo],"background",null);at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,oo)[oo],"border-bottom",null);at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,oo)[oo],"max-width",null);at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,oo)[oo].parentElement,"padding-right",null);at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,so)[so],"margin",null);at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,so)[so],"border-radius",null);at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,no)[no],"padding-bottom",null);at.Dom.style(babelHelpers.classPrivateFieldLooseBase(this,no)[no],"padding-right",null);BX.ZIndexManager.unregister(babelHelpers.classPrivateFieldLooseBase(this,eo)[eo])}const Oo={props:{getColumnsContainer:Function},data(){return{isSlider:P.Core.getParams().isSlider,maximize:new go({onOverlayClick:()=>this.collapse()}),desiredZoom:this.$store.getters["interface/zoom"],minZoom:.5,maxZoom:1}},mounted(){if(location.hash==="#maximize"){void this.maximize.maximize()}},computed:{...rt.mapGetters({zoom:"interface/zoom",expanded:"interface/expanded"}),zoomFormatted(){return this.loc("BOOKING_BOOKING_ZOOM_PERCENT",{"#PERCENT#":Math.round(this.zoom*100)})}},methods:{expand(t){if(location.hash==="#maximize"||this.isAnyModifierKeyPressed(t)){void this.maximize.maximize()}else{window.open(`${location.href}#maximize`,"_blank").focus()}},isAnyModifierKeyPressed(t){return t.altKey||t.shiftKey||t.ctrlKey||t.metaKey},collapse(){void this.maximize.minimize()},fitToScreen(){const t=260;const e=this.getColumnsContainer();const o=(e.offsetWidth-t)/(e.scrollWidth-t);const i=Math.floor(this.zoom*o*10)/10;this.zoomInto(i)},zoomInto(t){var e;if(Number.isNaN(t)){return}const o="--booking-booking-no-transition";const i=P.Core.getParams().container;const s=400;this.desiredZoom=Math.max(this.minZoom,Math.min(this.maxZoom,t));if(this.zoom===this.desiredZoom){return}(e=this.animation)==null?void 0:e.stop();at.Dom.addClass(i,o);this.animation=new BX.easing({duration:Math.abs(this.zoom-this.desiredZoom)/this.minZoom*s,start:{zoom:this.zoom*100},finish:{zoom:this.desiredZoom*100},step:({zoom:t})=>this.$store.dispatch("interface/setZoom",t/100),complete:()=>at.Dom.removeClass(i,o)});this.animation.animate()},async onMouseDown(t){at.Event.unbind(window,"mouseup",this.onMouseUp);at.Event.bind(window,"mouseup",this.onMouseUp);this.mouseDown=true;await new Promise((t=>setTimeout(t,50)));if(this.mouseDown){clearInterval(this.zoomInterval);this.zoomInterval=setInterval((()=>this.zoomInto(this.desiredZoom+t*.1)),40)}},onMouseUp(){this.mouseDown=false;if(this.desiredZoom>this.zoom){this.desiredZoom=Math.ceil(this.zoom*10)/10}if(this.desiredZoom<this.zoom){this.desiredZoom=Math.floor(this.zoom*10)/10}this.zoomInto(this.desiredZoom);clearInterval(this.zoomInterval);at.Event.unbind(window,"mouseup",this.onMouseUp)},async showAhaMoment(){ht.ahaMoments.setPopupShown(ut.AhaMoment.ExpandGrid);await ht.ahaMoments.show({id:"booking-expand-grid",title:this.loc("BOOKING_AHA_EXPAND_GRID_TITLE"),text:this.loc("BOOKING_AHA_EXPAND_GRID_TEXT"),article:ut.HelpDesk.AhaExpandGrid,target:this.$refs.expand,top:true});ht.ahaMoments.setShown(ut.AhaMoment.ExpandGrid)}},template:`\n\t\t<div class="booking-booking-grid-scale-panel">\n\t\t\t<div v-if="!isSlider" class="booking-booking-grid-scale-panel-full-screen" ref="expand">\n\t\t\t\t<div v-if="expanded" class="ui-icon-set --collapse-diagonal" @click="collapse"></div>\n\t\t\t\t<div v-else class="ui-icon-set --expand-diagonal" @click="expand"></div>\n\t\t\t</div>\n\t\t\t<div class="booking-booking-grid-scale-panel-fit-to-screen">\n\t\t\t\t<div class="booking-booking-grid-scale-panel-fit-to-screen-text" @click="fitToScreen">\n\t\t\t\t\t{{ loc('BOOKING_BOOKING_SHOW_ALL') }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="booking-booking-grid-scale-panel-change">\n\t\t\t\t<div\n\t\t\t\t\tclass="ui-icon-set --minus-30"\n\t\t\t\t\t:class="{'--disabled': zoom <= minZoom}"\n\t\t\t\t\t@click="zoomInto(desiredZoom - 0.1)"\n\t\t\t\t\t@mousedown="onMouseDown(-1)"\n\t\t\t\t></div>\n\t\t\t\t<div v-html="zoomFormatted" class="booking-booking-grid-scale-panel-zoom"></div>\n\t\t\t\t<div\n\t\t\t\t\tclass="ui-icon-set --plus-30"\n\t\t\t\t\t:class="{'--disabled': zoom >= maxZoom}"\n\t\t\t\t\t@click="zoomInto(desiredZoom + 0.1)"\n\t\t\t\t\t@mousedown="onMouseDown(1)"\n\t\t\t\t></div>\n\t\t\t</div>\n\t\t</div>\n\t`};const{mapGetters:Po}=rt.createNamespacedHelpers(ut.Model.Interface);const Do={data(){return{expanded:true}},created(){this.datePicker=new D.DatePicker({selectedDates:[this.selectedDateTs],inline:true,hideHeader:true});this.setViewDate();this.datePicker.subscribe(D.DatePickerEvent.SELECT,(t=>{const e=t.getData().date;const o=this.createDateFromUtc(e);void this.$store.dispatch(`${ut.Model.Interface}/setSelectedDateTs`,o.getTime());this.setViewDate()}))},mounted(){this.datePicker.setTargetNode(this.$refs.datePicker);this.datePicker.show()},beforeUnmount(){this.datePicker.destroy()},computed:{...Po({filteredMarks:"filteredMarks",freeMarks:"freeMarks",isFilterMode:"isFilterMode",getCounterMarks:"getCounterMarks",offset:"offset"}),selectedDateTs(){return this.$store.getters[`${ut.Model.Interface}/selectedDateTs`]+this.offset},viewDateTs(){return this.$store.getters[`${ut.Model.Interface}/viewDateTs`]+this.offset},counterMarks(){if(this.isFilterMode){return this.getCounterMarks(this.filteredMarks)}return this.getCounterMarks()},formattedDate(){const t=this.expanded?this.loc("BOOKING_MONTH_YEAR_FORMAT"):tt.DateTimeFormat.getFormat("LONG_DATE_FORMAT");const e=this.expanded?this.viewDateTs/1e3:this.selectedDateTs/1e3;return tt.DateTimeFormat.format(t,e)}},methods:{onCollapseClick(){this.expanded=!this.expanded},onPreviousClick(){if(this.expanded){this.previousMonth()}else{this.previousDate()}},onNextClick(){if(this.expanded){this.nextMonth()}else{this.nextDate()}},previousDate(){const t=this.datePicker.getSelectedDate()||this.datePicker.getToday();this.datePicker.selectDate(D.getNextDate(t,"day",-1));this.setViewDate()},nextDate(){const t=this.datePicker.getSelectedDate()||this.datePicker.getToday();this.datePicker.selectDate(D.getNextDate(t,"day"));this.setViewDate()},previousMonth(){const t=this.datePicker.getViewDate();this.datePicker.setViewDate(D.getNextDate(t,"month",-1));this.setViewDate()},nextMonth(){const t=this.datePicker.getViewDate();this.datePicker.setViewDate(D.getNextDate(t,"month"));this.setViewDate()},setViewDate(){const t=this.createDateFromUtc(this.datePicker.getViewDate());const e=t.setDate(1);void this.$store.dispatch(`${ut.Model.Interface}/setViewDateTs`,e)},createDateFromUtc(t){return new Date(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate())},updateMarks(){if(this.isFilterMode){this.setFilterMarks()}else{this.setFreeMarks()}this.setCounterMarks()},setFreeMarks(){const t="rgba(var(--ui-color-background-success-rgb), 0.7)";const e=this.prepareDates(this.freeMarks);this.datePicker.setDayColors([{matcher:e,bgColor:t}])},setFilterMarks(){const t="rgba(var(--ui-color-primary-rgb), 0.20)";const e=this.prepareDates(this.filteredMarks);this.datePicker.setDayColors([{matcher:e,bgColor:t}])},setCounterMarks(){const t=this.prepareDates(this.counterMarks);this.datePicker.setDayMarks([{matcher:t,bgColor:"red"}])},prepareDates(t){return t.map((t=>{const e=tt.DateTimeFormat.parse(t,false,ut.DateFormat.ServerParse);return this.prepareTimestamp(e.getTime())}))},prepareTimestamp(t){const e=tt.DateTimeFormat.getFormat("FORMAT_DATE");return tt.DateTimeFormat.format(e,t/1e3)}},watch:{selectedDateTs(t){this.datePicker.selectDate(D.createDate(t));this.updateMarks()},filteredMarks(){this.updateMarks()},freeMarks(){this.updateMarks()},counterMarks(){this.setCounterMarks()},isFilterMode(){this.updateMarks()}},template:`\n\t\t<div class="booking-booking-sidebar-calendar">\n\t\t\t<div class="booking-booking-sidebar-calendar-header">\n\t\t\t\t<div class="booking-booking-sidebar-calendar-button" @click="onPreviousClick">\n\t\t\t\t\t<div class="ui-icon-set --chevron-left"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class="booking-booking-sidebar-calendar-title">\n\t\t\t\t\t{{ formattedDate }}\n\t\t\t\t</div>\n\t\t\t\t<div class="booking-booking-sidebar-calendar-button" @click="onNextClick">\n\t\t\t\t\t<div class="ui-icon-set --chevron-right"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class="booking-booking-sidebar-calendar-button --collapse" @click="onCollapseClick">\n\t\t\t\t\t<div v-if="expanded" class="ui-icon-set --collapse"></div>\n\t\t\t\t\t<div v-else class="ui-icon-set --expand-1"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tclass="booking-booking-sidebar-calendar-date-picker"\n\t\t\t\t:class="{'--expanded': expanded}"\n\t\t\t\tref="datePicker"\n\t\t\t></div>\n\t\t</div>\n\t`};const Fo={components:{Calendar:Do},template:`\n\t\t<div class="booking-booking-sidebar">\n\t\t\t<Calendar/>\n\t\t</div>\n\t`};const $o={data(){return{IconSet:U.Set}},computed:rt.mapGetters({draggedBookingId:`${ut.Model.Interface}/draggedBookingId`}),methods:{onMouseUp(){new F.RemoveBooking(this.draggedBookingId)}},components:{Icon:U.BIcon},template:`\n\t\t<div v-if="draggedBookingId" class="booking-booking-drag-delete">\n\t\t\t<div\n\t\t\t\tclass="booking-booking-drag-delete-button"\n\t\t\t\tdata-element="booking-drag-delete"\n\t\t\t\t@mouseup.capture="onMouseUp"\n\t\t\t>\n\t\t\t\t<Icon :name="IconSet.TRASH_BIN"/>\n\t\t\t\t<div class="booking-booking-drag-delete-button-text">\n\t\t\t\t\t{{ loc('BOOKING_BOOKING_DRAG_DELETE') }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const Ro={data(){return{scrolledToBooking:false}},mounted(){this.ears=new J.Ears({container:this.$refs.columnsContainer,smallSize:true,className:"booking-booking-grid-columns-ears"}).init();at.Event.EventEmitter.subscribe("BX.Main.Popup:onAfterClose",this.tryShowAhaMoment);at.Event.EventEmitter.subscribe("BX.Main.Popup:onDestroy",this.tryShowAhaMoment)},computed:{...rt.mapGetters({resourcesIds:`${ut.Model.Interface}/resourcesIds`,scroll:`${ut.Model.Interface}/scroll`,editingBookingId:`${ut.Model.Interface}/editingBookingId`}),editingBooking(){var t;return(t=this.$store.getters["bookings/getById"](this.editingBookingId))!=null?t:null}},methods:{updateEars(){this.ears.toggleEars();this.tryShowAhaMoment()},areEarsShown(){const t="ui-ear-show";return at.Dom.hasClass(this.ears.getRightEar(),t)||at.Dom.hasClass(this.ears.getLeftEar(),t)},scrollToEditingBooking(){if(!this.editingBooking||this.scrolledToBooking){return}const t=C.grid.calculateTop(this.editingBooking.dateFromTs);const e=C.grid.calculateHeight(this.editingBooking.dateFromTs,this.editingBooking.dateToTs);this.$refs.inner.scrollTop=t+e/2+this.$refs.inner.offsetHeight/2;this.scrolledToBooking=true},tryShowAhaMoment(){if(this.areEarsShown()&&ht.ahaMoments.shouldShow(ut.AhaMoment.ExpandGrid)){at.Event.EventEmitter.unsubscribe("BX.Main.Popup:onAfterClose",this.tryShowAhaMoment);at.Event.EventEmitter.unsubscribe("BX.Main.Popup:onDestroy",this.tryShowAhaMoment);void this.$refs.scalePanel.showAhaMoment()}}},watch:{scroll(t){this.$refs.columnsContainer.scrollLeft=t},editingBooking(){this.scrollToEditingBooking()}},components:{LeftPanel:Kt,NowLine:Ut,Column:Xe,Bookings:ze,ScalePanel:Oo,Sidebar:Fo,DragDelete:$o},template:`\n\t\t<div class="booking-booking-grid">\n\t\t\t<div\n\t\t\t\tid="booking-booking-grid-wrap"\n\t\t\t\tclass="booking-booking-grid-inner --vertical-scroll-bar"\n\t\t\t\tref="inner"\n\t\t\t>\n\t\t\t\t<LeftPanel/>\n\t\t\t\t<NowLine/>\n\t\t\t\t<div\n\t\t\t\t\tid="booking-booking-grid-columns"\n\t\t\t\t\tclass="booking-booking-grid-columns --horizontal-scroll-bar"\n\t\t\t\t\tref="columnsContainer"\n\t\t\t\t\t@scroll="$store.dispatch('interface/setScroll', $refs.columnsContainer.scrollLeft)"\n\t\t\t\t>\n\t\t\t\t\t<Bookings/>\n\t\t\t\t\t<TransitionGroup\n\t\t\t\t\t\tname="booking-transition-resource"\n\t\t\t\t\t\t@after-leave="updateEars"\n\t\t\t\t\t\t@after-enter="updateEars"\n\t\t\t\t\t>\n\t\t\t\t\t\t<template v-for="resourceId of resourcesIds" :key="resourceId">\n\t\t\t\t\t\t\t<Column :resourceId="resourceId"/>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t</TransitionGroup>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<ScalePanel\n\t\t\t\t:getColumnsContainer="() => $refs.columnsContainer"\n\t\t\t\tref="scalePanel"\n\t\t\t/>\n\t\t\t<DragDelete/>\n\t\t</div>\n\t\t<Sidebar/>\n\t`};const Ho=0;const No=12;const Lo="var(--ui-color-primary-alt)";const _o="var(--ui-color-background-secondary)";const Ao=14;const zo=27;const xo={name:"BatteryIcon",props:{percent:{type:Number,default:0},dataId:{type:[String,Number],default:""},height:{type:Number,default:Ao},width:{type:Number,default:zo}},mounted(){this.repaint()},methods:{getCharge(t){if(t<=0){return Ho}if(t>=100){return No}return Math.round(t*No*.01)},repaint(){var t;const e=((t=this.$refs["icon-battery-charge"])==null?void 0:t.children)||[];const o=this.getCharge(this.percent);let i=1;for(const t of e){t.setAttribute("fill",i>o?_o:Lo);i++}}},watch:{percent:{handler(){this.repaint()}}},template:`\n\t\t<div :data-id="dataId" :data-percent="percent" data-element="booking-resource-workload-percent">\n\t\t\t<svg id="booking--battery-icon" :width="width" :height="height" viewBox="0 0 27 14" fill="none"\n\t\t\t\t xmlns="http://www.w3.org/2000/svg">\n\t\t\t\t<rect width="23.2875" height="13.8" rx="4" fill="white"/>\n\t\t\t\t<rect x="22.6871" y="0.6" width="12.6" height="22.0875" rx="3.4" transform="rotate(90 22.6871 0.6)" stroke="#C9CCD0" stroke-width="1.2"/>\n\t\t\t\t<g ref="icon-battery-charge" id="booking--battery-icon-charge" clip-path="url(#clip0_5003_187951)">\n\t\t\t\t\t<rect x="2.58789" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t\t<rect x="4.09766" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t\t<rect x="5.60547" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t\t<rect x="7.11523" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t\t<rect x="8.625" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t\t<rect x="10.1328" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t\t<rect x="11.6426" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t\t<rect x="13.1523" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t\t<rect x="14.6621" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t\t<rect x="16.1699" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t\t<rect x="17.6797" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t\t<rect x="19.1895" y="2.5875" width="1.50917" height="10" fill="#EDEEF0"/>\n\t\t\t\t</g>\n\t\t\t\t<g clip-path="url(#clip1_5003_187951)">\n\t\t\t\t\t<ellipse cx="23.102" cy="6.89999" rx="2.9" ry="3.48" transform="rotate(90 23.102 6.89999)" fill="#C9CCD0"/>\n\t\t\t\t</g>\n\t\t\t\t<defs>\n\t\t\t\t\t<clipPath id="clip0_5003_187951">\n\t\t\t\t\t\t<rect x="2.58789" y="2.5875" width="18.1125" height="8.625" rx="1.5" fill="white"/>\n\t\t\t\t\t</clipPath>\n\t\t\t\t\t<clipPath id="clip1_5003_187951">\n\t\t\t\t\t\t<rect width="6.9" height="2.15625" fill="white" transform="translate(26.7383 3.45) rotate(90)"/>\n\t\t\t\t\t</clipPath>\n\t\t\t\t</defs>\n\t\t\t</svg>\n\t\t</div>\n\t`};const Go={emits:["close"],props:{resourceId:{type:Number,required:true},slotsCount:{type:Number,required:true},bookingCount:{type:Number,required:true},workLoadPercent:{type:Number,required:true},bindElement:{type:HTMLElement,required:true}},computed:{popupId(){return"booking-booking-resource-workload-popup"},title(){return this.loc("BOOKING_BOOKING_RESOURCE_WORKLOAD_POPUP_TITLE")},rows(){return[{title:this.loc("BOOKING_BOOKING_RESOURCE_WORKLOAD_SLOTS_BOOKED"),value:this.slotsBookedFormatted,dataset:{element:"booking-resource-workload-popup-count",resourceId:this.resourceId,bookedCount:this.bookingCount,totalCount:this.slotsCount}},{title:this.loc("BOOKING_BOOKING_RESOURCE_WORKLOAD"),value:this.workLoadPercentFormatted,dataset:{element:"booking-resource-workload-popup-percent",resourceId:this.resourceId,percent:this.workLoadPercent}}]},slotsBookedFormatted(){return this.loc("BOOKING_BOOKING_RESOURCE_WORKLOAD_BOOKED_FROM_SLOTS_COUNT",{"#BOOKED#":this.bookingCount,"#SLOTS_COUNT#":this.slotsCount})},workLoadPercentFormatted(){return this.loc("BOOKING_BOOKING_RESOURCE_WORKLOAD_PERCENT",{"#PERCENT#":this.workLoadPercent})}},components:{StatisticsPopup:R.StatisticsPopup},template:`\n\t\t<StatisticsPopup\n\t\t\t:popupId="popupId"\n\t\t\t:bindElement="bindElement"\n\t\t\t:title="title"\n\t\t\t:rows="rows"\n\t\t\t:dataset="{\n\t\t\t\tid: resourceId,\n\t\t\t\telement: 'booking-resource-workload-popup',\n\t\t\t}"\n\t\t\t@close="$emit('close')"\n\t\t/>\n\t`};const Ko={name:"ResourceWorkload",props:{resourceId:{type:Number,required:true},scale:{type:Number,default:1},isGrid:{type:Boolean,default:false}},data(){return{isPopupShown:false}},computed:{...rt.mapGetters({selectedDateTs:"interface/selectedDateTs",fromHour:"interface/fromHour",toHour:"interface/toHour"}),workLoadPercent(){if(this.slotsCount===0){return 0}return Math.round(this.bookingCount/this.slotsCount*100)},bookingCount(){return this.bookings.length},slotsCount(){var t;const e=new Date(this.selectedDateTs);const o=ut.DateFormat.WeekDays[e.getDay()];const i=j.busySlots.filterSlotRanges(this.resource.slotRanges.filter((t=>t.weekDays.includes(o))));const s=(t=this.resource.slotRanges[0].slotSize)!=null?t:60;return Math.floor(i.reduce(((t,e)=>t+(e.to-e.from)/s),0))},bookings(){const t=this.selectedDateTs;return this.$store.getters[`${ut.Model.Bookings}/getByDateAndResources`](t,[this.resourceId])},resource(){return this.$store.getters["resources/getById"](this.resourceId)},batteryIconOptions(){return{height:Math.round(Ao*this.scale),width:Math.round(zo*this.scale)}},bookingsCount(){return this.bookings.length}},methods:{onMouseEnter(){this.showTimeout=setTimeout((()=>this.showPopup()),100)},onMouseLeave(){clearTimeout(this.showTimeout);this.closePopup()},showPopup(){this.isPopupShown=true},closePopup(){this.isPopupShown=false},async showAhaMoment(){ht.ahaMoments.setPopupShown(ut.AhaMoment.ResourceWorkload);await ht.ahaMoments.show({id:"booking-resource-workload",title:this.loc("BOOKING_AHA_RESOURCE_WORKLOAD_TITLE"),text:this.loc("BOOKING_AHA_RESOURCE_WORKLOAD_TEXT"),article:ut.HelpDesk.AhaResourceWorkload,target:this.$refs.container});ht.ahaMoments.setShown(ut.AhaMoment.ResourceWorkload)}},watch:{bookingsCount(t,e){if(this.isGrid&&t>e&&ht.ahaMoments.shouldShow(ut.AhaMoment.ResourceWorkload)){void this.showAhaMoment()}}},components:{BatteryIcon:xo,WorkloadPopup:Go},template:`\n\t\t<div\n\t\t\tclass="booking-booking-header-resource-workload"\n\t\t\tdata-element="booking-resource-workload"\n\t\t\t:data-id="resourceId"\n\t\t\tref="container"\n\t\t\t@click="showPopup"\n\t\t\t@mouseenter="onMouseEnter"\n\t\t\t@mouseleave="onMouseLeave"\n\t\t>\n\t\t\t<BatteryIcon \n\t\t\t\t:percent="workLoadPercent"\n\t\t\t\t:data-id="resourceId"\n\t\t\t\t:height="batteryIconOptions.height"\n\t\t\t\t:width="batteryIconOptions.width"\n\t\t\t/>\n\t\t</div>\n\t\t<WorkloadPopup\n\t\t\tv-if="isPopupShown"\n\t\t\t:resourceId="resourceId"\n\t\t\t:slotsCount="slotsCount"\n\t\t\t:bookingCount="bookingCount"\n\t\t\t:workLoadPercent="workLoadPercent"\n\t\t\t:bindElement="$refs.container"\n\t\t\t@close="closePopup"\n\t\t/>\n\t`};const Uo={name:"ResourceMenu",props:{resourceId:{type:Number,required:true}},data(){return{menuPopup:null}},computed:{...rt.mapGetters({favoritesIds:`${ut.Model.Favorites}/get`,isEditingBookingMode:`${ut.Model.Interface}/isEditingBookingMode`,isFeatureEnabled:`${ut.Model.Interface}/isFeatureEnabled`}),popupId(){return`resource-menu-${this.resourceId||"new"}`}},created(){this.hint=BX.UI.Hint.createInstance({popupParameters:{}})},unmounted(){if(this.menuPopup){this.destroy()}},methods:{openMenu(){var t,e;if((t=this.menuPopup)!=null&&(e=t.popupWindow)!=null&&e.isShown()){this.destroy();return}const o=this.$refs["menu-button"];this.menuPopup=K.MenuManager.create(this.popupId,o,this.getMenuItems(),{className:"booking-resource-menu-popup",closeByEsc:true,autoHide:true,offsetTop:-3,offsetLeft:o.offsetWidth-6,angle:true,cacheable:true,events:{onDestroy:()=>this.unbindScrollEvent()}});this.menuPopup.show();this.bindScrollEvent()},getMenuItems(){return[{html:`<span>${this.loc("BOOKING_RESOURCE_MENU_EDIT_RESOURCE")}</span>`,className:this.isFeatureEnabled?"menu-popup-item menu-popup-no-icon":"menu-popup-item --lock",onclick:async()=>{if(!this.isFeatureEnabled){Y.limit.show();return}const t=new A.ResourceCreationWizard;this.editResource(this.resourceId,t);this.destroy()}},{html:`<span>${this.loc("BOOKING_RESOURCE_MENU_HIDE")}</span>`,onclick:async()=>{this.destroy();await this.hideResource(this.resourceId)}},{html:`<span class="alert-text">${this.loc("BOOKING_RESOURCE_MENU_DELETE")}</span>`,onclick:async()=>{this.destroy();await this.deleteResource(this.resourceId)}}]},destroy(){K.MenuManager.destroy(this.popupId);this.unbindScrollEvent()},bindScrollEvent(){at.Event.bind(document,"scroll",this.adjustPosition,{capture:true})},unbindScrollEvent(){at.Event.unbind(document,"scroll",this.adjustPosition,{capture:true})},adjustPosition(){var t,e;(t=this.menuPopup)==null?void 0:(e=t.popupWindow)==null?void 0:e.adjustPosition()},async editResource(t,e){e.open(t)},async hideResource(t){const e=[...this.favoritesIds];const o=this.favoritesIds.indexOf(t);if(o===-1){return}e.splice(o,1);await x.hideResources(e)},async deleteResource(t){const e=await this.confirmDelete(t);if(e){await L.resourceService.delete(t)}},async confirmDelete(t){const e=await L.resourceService.hasBookings(t);return new Promise((t=>{const o=H.MessageBox.create({message:at.Loc.getMessage("BOOKING_RESOURCE_CONFIRM_DELETE"),yesCaption:at.Loc.getMessage("BOOKING_RESOURCE_CONFIRM_DELETE_YES"),modal:true,buttons:H.MessageBoxButtons.YES_CANCEL,onYes:()=>{o.close();t(true)},onCancel:()=>{o.close();t(false)}});if(e){const t=o.getPopupWindow();t.subscribe("onAfterShow",(()=>{const t=o.getYesButton();t.setDisabled(true);at.Event.bind(t.getContainer(),"mouseenter",(()=>{this.hint.show(t.getContainer(),at.Loc.getMessage("BOOKING_RESOURCE_CONFIRM_DELETE_HINT"),true)}));at.Event.bind(t.getContainer(),"mouseleave",(()=>{this.hint.hide(t.getContainer())}))}))}o.show()}))}},template:`\n\t\t<button ref="menu-button" class="ui-icon-set --more" @click="openMenu"></button>\n\t`};const Xo={props:{resourceId:{type:Number,required:true}},data(){return{visible:true}},mounted(){this.updateVisibility();this.updateVisibilityDuringTransition()},computed:{...rt.mapGetters({resourcesIds:`${ut.Model.Interface}/resourcesIds`,zoom:`${ut.Model.Interface}/zoom`,scroll:`${ut.Model.Interface}/scroll`,selectedDateTs:`${ut.Model.Interface}/selectedDateTs`}),resource(){return this.$store.getters[`${ut.Model.Resources}/getById`](this.resourceId)},resourceType(){return this.$store.getters[`${ut.Model.ResourceTypes}/getById`](this.resource.typeId)},profit(){const t=$.currencyFormat.getBaseCurrencyId();const e=this.bookings.map((({externalData:t})=>{var e;return(e=t==null?void 0:t.find((t=>t.entityTypeId===ut.CrmEntity.Deal)))!=null?e:null})).filter((e=>{var o;return(e==null?void 0:(o=e.data)==null?void 0:o.currencyId)===t}));if(e.length===0){return""}const o=[...new Map(e.map((t=>[t.value,t]))).values()];const i=o.reduce(((t,e)=>t+e.data.opportunity),0);return $.currencyFormat.format(t,i)},bookings(){return this.$store.getters[`${ut.Model.Bookings}/getByDateAndResources`](this.selectedDateTs,[this.resourceId])}},methods:{updateVisibilityDuringTransition(){var t;(t=this.animation)==null?void 0:t.stop();this.animation=new BX.easing({duration:200,start:{},finish:{},step:this.updateVisibility});this.animation.animate()},updateVisibility(){if(!this.$refs.container){return}const t=this.$refs.container.getBoundingClientRect();this.visible=t.right>0&&t.left<window.innerWidth}},watch:{scroll(){this.updateVisibility()},zoom(){this.updateVisibility()},resourcesIds(){this.updateVisibilityDuringTransition()}},components:{ResourceMenu:Uo,ResourceWorkload:Ko},template:`\n\t\t<div\n\t\t\tclass="booking-booking-header-resource"\n\t\t\tdata-element="booking-resource"\n\t\t\t:data-id="resourceId"\n\t\t\tref="container"\n\t\t>\n\t\t\t<template v-if="visible">\n\t\t\t\t<ResourceWorkload\n\t\t\t\t\t:resourceId="resourceId"\n\t\t\t\t\t:scale="zoom"\n\t\t\t\t\t:isGrid="true"\n\t\t\t\t/>\n\t\t\t\t<div class="booking-booking-header-resource-title">\n\t\t\t\t\t<div class="booking-booking-header-resource-name" :title="resource.name">\n\t\t\t\t\t\t{{ resource.name }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="booking-booking-header-resource-type" :title="resourceType.name">\n\t\t\t\t\t\t{{ resourceType.name }}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="booking-booking-header-resource-profit" v-html="profit"></div>\n\t\t\t\t<div class="booking-booking-header-resource-actions">\n\t\t\t\t\t<ResourceMenu :resource-id/>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t</div>\n\t`};const qo={data(){return{IconSet:U.Set,hovered:false}},computed:rt.mapGetters({isLoaded:`${ut.Model.Interface}/isLoaded`,isFeatureEnabled:`${ut.Model.Interface}/isFeatureEnabled`}),methods:{async addResource(){if(!this.isFeatureEnabled){await Y.limit.show();return}(new A.ResourceCreationWizard).open();st.RcwAnalytics.sendClickAddResource()},async showAhaMoment(){await ht.ahaMoments.show({id:"booking-add-resource",title:this.loc("BOOKING_AHA_ADD_RESOURCES_TITLE"),text:this.loc("BOOKING_AHA_ADD_RESOURCES_TEXT"),article:ut.HelpDesk.AhaAddResource,target:this.$refs.button});ht.ahaMoments.setShown(ut.AhaMoment.AddResource)}},watch:{isLoaded(){if(ht.ahaMoments.shouldShow(ut.AhaMoment.AddResource)){void this.showAhaMoment()}}},components:{Icon:U.BIcon},template:`\n\t\t<div\n\t\t\tclass="booking-booking-header-add-resource-icon-container"\n\t\t\t:class="{ '--hover': hovered }"\n\t\t\t@click="addResource"\n\t\t\t@mouseenter="hovered = true"\n\t\t\t@mouseleave="hovered = false"\n\t\t>\n\t\t\t<div\n\t\t\t\tclass="booking-booking-header-add-resource-icon"\n\t\t\t\t:class="{'--lock': !isFeatureEnabled}"\n\t\t\t>\n\t\t\t\t<Icon v-if="isFeatureEnabled" :name="IconSet.PLUS_20"/>\n\t\t\t\t<Icon v-else :name="IconSet.LOCK" :size="16"/>\n\t\t\t</div>\n\t\t</div>\n\t\t<div\n\t\t\tclass="booking-booking-header-add-resource"\n\t\t\t:class="{ '--hover': hovered }"\n\t\t\tref="button"\n\t\t\t@click="addResource"\n\t\t\t@mouseenter="hovered = true"\n\t\t\t@mouseleave="hovered = false"\n\t\t>\n\t\t\t<div class="booking-booking-header-add-resource-text">\n\t\t\t\t{{ loc('BOOKING_BOOKING_ADD_RESOURCE') }}\n\t\t\t</div>\n\t\t</div>\n\t`};class Vo extends W.BaseHeader{constructor(...t){super(...t);this.getContainer()}render(){return this.options.content}}const jo={emits:["update:modelValue"],data(){return{selectedTypes:{}}},computed:rt.mapGetters({resourceTypes:"resourceTypes/get"}),methods:{selectAll(){Object.keys(this.selectedTypes).forEach((t=>{this.selectedTypes[t]=true}))},deselectAll(){Object.keys(this.selectedTypes).forEach((t=>{this.selectedTypes[t]=false}))}},watch:{resourceTypes(t){t.forEach((t=>{var e,o,i;(i=(e=this.selectedTypes)[o=t.id])!=null?i:e[o]=true}))},selectedTypes:{handler(){this.$emit("update:modelValue",this.selectedTypes)},deep:true}},template:`\n\t\t<div class="booking-booking-resources-dialog-header-types">\n\t\t\t<div class="booking-booking-resources-dialog-header-header">\n\t\t\t\t<div class="booking-booking-resources-dialog-header-title">\n\t\t\t\t\t{{ loc('BOOKING_BOOKING_RESOURCES_DIALOG_RESOURCE_TYPES') }}\n\t\t\t\t</div>\n\t\t\t\t<div\n\t\t\t\t\tclass="booking-booking-resources-dialog-header-button"\n\t\t\t\t\tdata-element="booking-resources-dialog-select-all-types-button"\n\t\t\t\t\t@click="selectAll"\n\t\t\t\t>\n\t\t\t\t\t{{ loc('BOOKING_BOOKING_RESOURCES_DIALOG_SELECT_ALL') }}\n\t\t\t\t</div>\n\t\t\t\t<div\n\t\t\t\t\tclass="booking-booking-resources-dialog-header-button"\n\t\t\t\t\tdata-element="booking-resources-dialog-deselect-all-types-button"\n\t\t\t\t\t@click="deselectAll"\n\t\t\t\t>\n\t\t\t\t\t{{ loc('BOOKING_BOOKING_RESOURCES_DIALOG_DESELECT_ALL') }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="booking-booking-resources-dialog-header-items">\n\t\t\t\t<template v-for="resourceType of resourceTypes" :key="resourceType.id">\n\t\t\t\t\t<label\n\t\t\t\t\t\tclass="booking-booking-resources-dialog-header-item"\n\t\t\t\t\t\tdata-element="booking-resources-dialog-type"\n\t\t\t\t\t\t:data-id="resourceType.id"\n\t\t\t\t\t\t:data-selected="selectedTypes[resourceType.id]"\n\t\t\t\t\t>\n\t\t\t\t\t\t<span\n\t\t\t\t\t\t\tclass="booking-booking-resources-dialog-header-item-text"\n\t\t\t\t\t\t\tdata-element="booking-resources-dialog-type-name"\n\t\t\t\t\t\t\t:data-id="resourceType.id"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{{ resourceType.name }}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<input type="checkbox" v-model="selectedTypes[resourceType.id]">\n\t\t\t\t\t</label>\n\t\t\t\t</template>\n\t\t\t</div>\n\t\t</div>\n\t`};const Wo={emits:["startResize","endResize"],props:{getNode:{type:Function,required:true}},data(){return{isResized:false,startMouseY:0,startHeight:0}},methods:{startResize(t){this.$emit("startResize");at.Dom.style(document.body,"user-select","none");at.Event.bind(window,"mouseup",this.endResize);at.Event.bind(window,"pointermove",this.resize);this.isResized=true;this.startMouseY=t.clientY;this.startHeight=this.getNode().offsetHeight},resize(t){if(!this.isResized){return}t.preventDefault();const e=110;const o=180;const i=this.startHeight+t.clientY-this.startMouseY;const s=Math.min(o,Math.max(i,e));at.Dom.style(this.getNode(),"max-height",`${s}px`)},endResize(){this.$emit("endResize");at.Dom.style(document.body,"user-select","");at.Event.unbind(window,"mouseup",this.endResize);at.Event.unbind(window,"pointermove",this.resize);this.isResized=false}},template:`\n\t\t<div\n\t\t\tclass="booking-booking-resources-dialog-header-resize"\n\t\t\t@mousedown="startResize"\n\t\t></div>\n\t`};const Yo={emits:["search"],data(){return{searchDebounced:at.Runtime.debounce(this.search,200,this),query:""}},computed:{searchIcon(){return U.Set.SEARCH_2}},methods:{onInput(t){const e=t.target.value;this.query=e;if(at.Type.isStringFilled(e)){this.searchDebounced(e)}else{this.search(e)}},search(t){if(this.query===t){this.$emit("search",t)}}},components:{Icon:U.BIcon},template:`\n\t\t<div class="booking-booking-resources-dialog-header-input-container">\n\t\t\t<input\n\t\t\t\tclass="booking-booking-resources-dialog-header-input"\n\t\t\t\t:placeholder="loc('BOOKING_BOOKING_RESOURCES_DIALOG_SEARCH')"\n\t\t\t\tdata-element="booking-resources-dialog-search-input"\n\t\t\t\t@input="onInput"\n\t\t\t>\n\t\t\t<div class="booking-booking-resources-dialog-header-input-icon">\n\t\t\t\t<Icon :name="searchIcon"/>\n\t\t\t</div>\n\t\t</div>\n\t`};const Zo={emits:["update:modelValue","search","startResize","endResize","selectAll","deselectAll"],data(){return{selectedTypes:{}}},computed:rt.mapGetters({resources:"resources/get"}),watch:{selectedTypes:{handler(){this.$emit("update:modelValue",this.selectedTypes)},deep:true}},components:{ResourceTypes:jo,Resize:Wo,Search:Yo},template:`\n\t\t<div class="booking-booking-resources-dialog-header" ref="header">\n\t\t\t<ResourceTypes\n\t\t\t\tref="resourceTypes"\n\t\t\t\tv-model="selectedTypes"\n\t\t\t/>\n\t\t\t<Resize\n\t\t\t\t:getNode="() => this.$refs.resourceTypes.$el"\n\t\t\t\t@startResize="$emit('startResize')"\n\t\t\t\t@endResize="$emit('endResize')"\n\t\t\t/>\n\t\t\t<div class="booking-booking-resources-dialog-header-resources">\n\t\t\t\t<div class="booking-booking-resources-dialog-header-header">\n\t\t\t\t\t<div class="booking-booking-resources-dialog-header-title">\n\t\t\t\t\t\t{{ loc('BOOKING_BOOKING_RESOURCES_DIALOG_RESOURCES') }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="booking-booking-resources-dialog-header-button"\n\t\t\t\t\t\tdata-element="booking-resources-dialog-select-all-button"\n\t\t\t\t\t\t@click="$emit('selectAll')"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ loc('BOOKING_BOOKING_RESOURCES_DIALOG_SELECT_ALL') }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="booking-booking-resources-dialog-header-button"\n\t\t\t\t\t\tdata-element="booking-resources-dialog-deselect-all-button"\n\t\t\t\t\t\t@click="$emit('deselectAll')"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ loc('BOOKING_BOOKING_RESOURCES_DIALOG_DESELECT_ALL') }}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<Search @search="(query) => this.$emit('search', query)"/>\n\t\t\t</div>\n\t\t</div>\n\t`};class Qo extends W.BaseFooter{constructor(...t){super(...t);this.getContainer()}render(){return this.options.content}}const Jo={name:"DialogFooter",emits:["reset"],computed:{buttonSettings(){return Object.freeze({size:it.ButtonSize.SMALL,color:it.ButtonColor.LINK})},buttonLabel(){return this.loc("BOOKING_BOOKING_RESOURCES_DIALOG_RESET")}},components:{UiButton:it.Button},template:`\n\t\t<div class="booking--booking--select-resources-dialog-footer">\n\t\t\t<UiButton\n\t\t\t\t:size="buttonSettings.size"\n\t\t\t\t:color="buttonSettings.color"\n\t\t\t\t:text="buttonLabel"\n\t\t\t\tbutton-class="booking--booking--select-resources-dialog-footer__button"\n\t\t\t\t@click="$emit('reset')"\n\t\t\t/>\n\t\t</div>\n\t`};const ti={data(){return{dialogFilled:false,query:"",saveItemsDebounce:at.Runtime.debounce(this.saveItems,10,this),workloadRefs:{},selectedTypes:{}}},mounted(){this.dialog=new W.Dialog({context:"BOOKING",targetNode:this.$refs.button,width:340,height:Math.min(window.innerHeight-280,600),offsetLeft:4,dropdownMode:true,preselectedItems:this.favoritesIds.map((t=>[ut.EntitySelectorEntity.Resource,t])),items:this.resources.map((t=>this.getItemOptions(t))),entities:[{id:ut.EntitySelectorEntity.Resource}],events:{onShow:this.onShow,"Item:onSelect":this.saveItemsDebounce,"Item:onDeselect":this.saveItemsDebounce},header:Vo,headerOptions:{content:this.$refs.dialogHeader.$el},footer:Qo,footerOptions:{content:this.$refs.dialogFooter.$el}});at.Event.bind(this.dialog.getRecentTab().getContainer(),"scroll",this.loadOnScroll);at.Event.EventEmitter.subscribe("BX.Main.Popup:onAfterClose",this.tryShowAhaMoment);at.Event.EventEmitter.subscribe("BX.Main.Popup:onDestroy",this.tryShowAhaMoment)},computed:{...rt.mapGetters({selectedDateTs:`${ut.Model.Interface}/selectedDateTs`,favoritesIds:`${ut.Model.Favorites}/get`,resources:`${ut.Model.Resources}/get`,isFilterMode:`${ut.Model.Interface}/isFilterMode`,isEditingBookingMode:`${ut.Model.Interface}/isEditingBookingMode`,isLoaded:`${ut.Model.Interface}/isLoaded`,mainResources:`${ut.Model.MainResources}/resources`}),mainResourceIds(){return new Set(this.mainResources)},isDefaultState(){return this.mainResourceIds.size===this.favoritesIds.length&&this.favoritesIds.every((t=>this.mainResourceIds.has(t)))}},methods:{showDialog(){this.updateItems();void this.loadMainResources();this.dialog.show()},async onShow(){if(this.dialogFilled){void this.loadOnScroll();return}this.dialogFilled=true;await z.resourceDialogService.fillDialog(this.selectedDateTs/1e3)},async loadOnScroll(){const t=this.dialog.getRecentTab().getContainer();const e=t.scrollTop;const o=t.scrollHeight-t.offsetHeight;if(e+10>=o){const t=G.resourcesDateCache.getIdsByDateTs(this.selectedDateTs/1e3);const e=this.resources.map((t=>t.id));const o=e.filter((e=>!t.includes(e))).slice(0,ut.Limit.ResourcesDialog);await z.resourceDialogService.loadByIds(o,this.selectedDateTs/1e3);this.updateItems()}},async loadMainResources(){await z.resourceDialogService.getMainResources()},updateItems(){this.dialog.getItems().forEach((t=>{const e=t.getId();const o=this.workloadRefs[e];const i=this.isItemHidden(e);const s=this.isItemSelected(e);t.getNodes().forEach((t=>{const e=t.getAvatarContainer();at.Dom.style(e,"width","max-content");at.Dom.style(e,"height","max-content");at.Dom.append(o,e)}));t.setHidden(i);if(!t.isSelected()&&s){t.select()}if(t.isSelected()&&!s){t.deselect()}}))},saveItems(){void x.hideResources(this.dialog.getSelectedItems().map((t=>t.id)))},addItems(t){const e=t.reduce(((t,e)=>({...t,[e.id]:this.getItemOptions(e)})),{});Object.values(e).forEach((t=>this.dialog.addItem(t)));const o=this.dialog.getItems().map((t=>t.getId())).filter((t=>e[t]));this.dialog.removeItems();o.forEach((t=>this.dialog.addItem(e[t])));const i=this.dialog.getActiveTab();if(i){i.getContainer().append(i.getRootNode().getChildrenContainer());i.render()}this.updateItems();if(at.Type.isStringFilled(this.query)){void this.search(this.query)}},getItemOptions(t){return{id:t.id,entityId:ut.EntitySelectorEntity.Resource,title:t.name,subtitle:this.getResourceType(t.typeId).name,avatarOptions:{bgImage:"none",borderRadius:"0"},tabs:ut.EntitySelectorTab.Recent,selected:this.isItemSelected(t.id),hidden:this.isItemHidden(t.id),nodeAttributes:{"data-id":t.id,"data-element":"booking-select-resources-dialog-item"}}},isItemSelected(t){return this.favoritesIds.includes(t)},isItemHidden(t){const e=G.resourcesDateCache.getIdsByDateTs(this.selectedDateTs/1e3);const o=this.getResource(t);const i=e.includes(t)&&o&&this.selectedTypes[o.typeId];return!i},getResource(t){return this.$store.getters["resources/getById"](t)},getResourceType(t){return this.$store.getters["resourceTypes/getById"](t)},async search(t){this.query=t;this.dialog.search(this.query);this.updateItems();this.dialog.getSearchTab().getStub().hide();this.dialog.getSearchTab().getSearchLoader().show();await z.resourceDialogService.doSearch(this.query,this.selectedDateTs/1e3);this.dialog.search(this.query);this.updateItems();this.dialog.getSearchTab().getSearchLoader().hide();if(this.dialog.getSearchTab().isEmptyResult()){this.dialog.getSearchTab().getStub().show()}},startResize(){this.dialog.freeze()},endResize(){setTimeout((()=>this.dialog.unfreeze()))},selectAll(){this.dialog.getItems().forEach((t=>{if(!t.isHidden()){t.select()}}))},deselectAll(){this.dialog.getItems().forEach((t=>{if(!t.isHidden()){t.deselect()}}))},setWorkloadRef(t,e){this.workloadRefs[e]=t},tryShowAhaMoment(){if(ht.ahaMoments.shouldShow(ut.AhaMoment.SelectResources)){at.Event.EventEmitter.unsubscribe("BX.Main.Popup:onAfterClose",this.tryShowAhaMoment);at.Event.EventEmitter.unsubscribe("BX.Main.Popup:onDestroy",this.tryShowAhaMoment);void this.showAhaMoment()}},async showAhaMoment(){await ht.ahaMoments.show({id:"booking-select-resources",title:this.loc("BOOKING_AHA_SELECT_RESOURCES_TITLE"),text:this.loc("BOOKING_AHA_SELECT_RESOURCES_TEXT"),article:ut.HelpDesk.AhaSelectResources,target:this.$refs.button});ht.ahaMoments.setShown(ut.AhaMoment.SelectResources)},reset(){const t=this.mainResourceIds;this.dialog.getItems().forEach((e=>{if(t.has(e.id)){e.select()}else{e.deselect()}}))}},watch:{favoritesIds(){this.updateItems()},resources:{handler(t){setTimeout((()=>this.addItems(t)));z.resourceDialogService.clearMainResourcesCache()},deep:true},selectedTypes:{handler(){this.updateItems()},deep:true},isLoaded(){this.tryShowAhaMoment()}},components:{DialogHeader:Zo,DialogFooter:Jo,ResourceWorkload:Ko},template:`\n\t\t<div\n\t\t\tclass="booking-booking-select-resources"\n\t\t\t:class="{'--disabled': isFilterMode}"\n\t\t\tdata-element="booking-select-resources"\n\t\t\tref="button"\n\t\t\t@click="showDialog"\n\t\t>\n\t\t\t<div class="ui-icon-set --funnel"></div>\n\t\t</div>\n\t\t<DialogHeader\n\t\t\tref="dialogHeader"\n\t\t\tv-model="selectedTypes"\n\t\t\t@search="search"\n\t\t\t@startResize="startResize"\n\t\t\t@endResize="endResize"\n\t\t\t@selectAll="selectAll"\n\t\t\t@deselectAll="deselectAll"\n\t\t/>\n\t\t<DialogFooter\n\t\t\tv-show="dialogFilled && !isDefaultState"\n\t\t\tref="dialogFooter"\n\t\t\t@reset="reset"\n\t\t/>\n\t\t<div class="booking-booking-select-resources-workload-container">\n\t\t\t<template v-for="resource of resources">\n\t\t\t\t<span class="booking-booking-select-resources-workload" :ref="(el) => setWorkloadRef(el, resource.id)">\n\t\t\t\t\t<ResourceWorkload :resourceId="resource.id"/>\n\t\t\t\t</span>\n\t\t\t</template>\n\t\t</div>\n\t`};const ei={computed:rt.mapGetters({resourcesIds:`${ut.Model.Interface}/resourcesIds`,scroll:`${ut.Model.Interface}/scroll`,isEditingBookingMode:`${ut.Model.Interface}/isEditingBookingMode`}),watch:{scroll(t){this.$refs.inner.scrollLeft=t}},components:{Resource:Xo,AddResourceButton:qo,SelectResources:ti},template:`\n\t\t<div class="booking-booking-header">\n\t\t\t<SelectResources/>\n\t\t\t<div\n\t\t\t\tclass="booking-booking-header-inner"\n\t\t\t\tref="inner"\n\t\t\t\t@scroll="$store.dispatch('interface/setScroll', $refs.inner.scrollLeft)"\n\t\t\t>\n\t\t\t\t<TransitionGroup name="booking-transition-resource">\n\t\t\t\t\t<template v-for="resourceId of resourcesIds" :key="resourceId">\n\t\t\t\t\t\t<Resource :resourceId="resourceId"/>\n\t\t\t\t\t</template>\n\t\t\t\t</TransitionGroup>\n\t\t\t\t<AddResourceButton v-if="!isEditingBookingMode"/>\n\t\t\t</div>\n\t\t</div>\n\t`};const oi={emits:["change"],props:{resourceId:{type:Number,required:true}},data(){return{isSelected:false,selectedItems:[]}},mounted(){this.selector=this.createSelector()},unmounted(){this.selector.destroy();this.selector=null},methods:{createSelector(){var t;const e=(t=this.intersections[this.resourceId])!=null?t:[];return new W.Dialog({id:`booking-intersection-selector-resource-${this.resourceId}`,targetNode:this.$refs.intersectionField,preselectedItems:e.map((t=>[ut.EntitySelectorEntity.Resource,t])),width:400,enableSearch:true,dropdownMode:true,context:"bookingResourceIntersection",multiple:true,cacheable:true,showAvatars:false,entities:[{id:ut.EntitySelectorEntity.Resource,dynamicLoad:true,dynamicSearch:true}],searchOptions:{allowCreateItem:false,footerOptions:{label:this.loc("BOOKING_BOOKING_ADD_INTERSECTION_DIALOG_SEARCH_FOOTER")}},events:{onHide:this.changeSelected.bind(this),onLoad:this.changeSelected.bind(this)}})},showSelector(){if(this.isFeatureEnabled){this.selector.show()}else{void Y.limit.show()}},changeSelected(){this.selectedItems=this.selector.getSelectedItems();this.isSelected=this.selectedItems.length>0;const t=this.selectedItems.map((t=>t.id));this.$emit("change",t,this.resourceId)},handleRemove(t){this.selector.getItem([ut.EntitySelectorEntity.Resource,t]).deselect();this.changeSelected()}},computed:{...rt.mapGetters({intersections:`${ut.Model.Interface}/intersections`,isFeatureEnabled:`${ut.Model.Interface}/isFeatureEnabled`,resources:`${ut.Model.Resources}/get`}),resourcesIds(){return this.resources.map((({id:t})=>t))},firstItemTitle(){return this.selectedItems.length>0?this.selectedItems[0].title:""},remainingItemsCount(){return this.selectedItems.length>1?this.selectedItems.length-1:0}},watch:{resourcesIds(t,e){if(t.join(",")===e.join(",")){return}const o=e.filter((e=>!t.includes(e)));const i=t.filter((t=>!e.includes(t)));o.forEach((t=>{const e=this.selector.getItem([ut.EntitySelectorEntity.Resource,t]);this.selector.removeItem(e)}));i.forEach((t=>{const e=this.$store.getters[`${ut.Model.Resources}/getById`](t);const o=this.$store.getters[`${ut.Model.ResourceTypes}/getById`](e.typeId);this.selector.addItem({id:t,entityId:ut.EntitySelectorEntity.Resource,title:e.name,subtitle:o.name,tabs:ut.EntitySelectorTab.Recent})}));this.changeSelected()},resources:{handler(){this.selector.getItems().forEach((t=>{const e=this.$store.getters[`${ut.Model.Resources}/getById`](t.getId());if(!e){return}const o=this.$store.getters[`${ut.Model.ResourceTypes}/getById`](e.typeId);t.setTitle(e.name);t.setSubtitle(o.name)}));this.selector.getTagSelector().getTags().forEach((t=>{const e=this.$store.getters[`${ut.Model.Resources}/getById`](t.getId());if(!e){return}t.setTitle(e.name);t.render()}));this.selectedItems=this.selector.getSelectedItems()},deep:true}},template:`\n\t\t<div\n\t\t\tref="intersectionField"\n\t\t\tclass="booking-booking-intersections-resource"\n\t\t\t:data-id="'booking-booking-intersections-resource-' + resourceId"\n\t\t>\n\t\t\t<template v-if="isSelected">\n\t\t\t\t<div\n\t\t\t\t\tref="selectorItemContainer"\n\t\t\t\t\tclass="booking-booking-intersections-resource-container"\n\t\t\t\t>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="selectedItems.length > 0"\n\t\t\t\t\t\tclass="bbi-resource-selector-item bbi-resource-selector-tag"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div class="bbi-resource-selector-tag-content" :title="firstItemTitle">\n\t\t\t\t\t\t\t<div class="bbi-resource-selector-tag-title">{{ firstItemTitle }}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div \n\t\t\t\t\t\t\tclass="bbi-resource-selector-tag-remove"\n\t\t\t\t\t\t\t@click="handleRemove(selectedItems[0].id)"\n\t\t\t\t\t\t\t:data-id="'bbi-resource-selector-tag-remove-' + resourceId"\n\t\t\t\t\t\t></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="remainingItemsCount > 0"\n\t\t\t\t\t\tclass="bbi-resource-selector-item bbi-resource-selector-tag --count"\n\t\t\t\t\t\t@click="showSelector"\n\t\t\t\t\t\t:data-id="'bbi-resource-selector-tag-count-' + resourceId"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div class="bbi-resource-selector-tag-content">\n\t\t\t\t\t\t\t<div class="bbi-resource-selector-tag-title --count">+{{ remainingItemsCount }}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<span\n\t\t\t\t\t\t\tclass="bbi-resource-selector-item bbi-resource-selector-add-button"\n\t\t\t\t\t\t\t@click="showSelector"\n\t\t\t\t\t\t\t:data-id="'bbi-resource-selector-add-button' + resourceId"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<span class="bbi-resource-selector-add-button-caption">\n\t\t\t\t\t\t\t\t{{ loc('BOOKING_BOOKING_INTERSECTION_BUTTON_MORE') }}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t\t<template v-else>\n\t\t\t\t<span\n\t\t\t\t\tref="selectorButton"\n\t\t\t\t\tclass="bbi-resource-selector-item bbi-resource-selector-add-button"\n\t\t\t\t\t@click="showSelector"\n\t\t\t\t\t:data-id="'bbi-resource-selector-add-button' + resourceId"\n\t\t\t\t>\n\t\t\t\t\t<span class="bbi-resource-selector-add-button-caption">\n\t\t\t\t\t\t{{ loc('BOOKING_BOOKING_INTERSECTION_BUTTON') }}\n\t\t\t\t\t</span>\n\t\t\t\t</span>\n\t\t\t</template>\n\t\t</div>\n\t`};const ii={emits:["change"],created(){this.selector=this.createSelector();if(!this.isFeatureEnabled){this.selector.lock()}},mounted(){this.mountSelector();at.Event.EventEmitter.subscribe("BX.Main.Popup:onAfterClose",this.tryShowAhaMoment);at.Event.EventEmitter.subscribe("BX.Main.Popup:onDestroy",this.tryShowAhaMoment)},beforeUnmount(){this.destroySelector()},computed:{...rt.mapGetters({isEditingBookingMode:`${ut.Model.Interface}/isEditingBookingMode`,intersections:`${ut.Model.Interface}/intersections`,isLoaded:`${ut.Model.Interface}/isLoaded`,isFeatureEnabled:`${ut.Model.Interface}/isFeatureEnabled`,resources:`${ut.Model.Resources}/get`}),resourcesIds(){return this.resources.map((({id:t})=>t))}},methods:{createSelector(){return new W.TagSelector({multiple:true,addButtonCaption:this.loc("BOOKING_BOOKING_ADD_INTERSECTION"),showCreateButton:false,maxHeight:50,dialogOptions:{header:this.loc("BOOKING_BOOKING_ADD_INTERSECTION_DIALOG_HEADER"),context:"bookingResourceIntersection",width:290,height:340,dropdownMode:true,enableSearch:true,cacheable:true,showAvatars:false,entities:[{id:ut.EntitySelectorEntity.Resource,dynamicLoad:true,dynamicSearch:true}],searchOptions:{allowCreateItem:false,footerOptions:{label:this.loc("BOOKING_BOOKING_ADD_INTERSECTION_DIALOG_SEARCH_FOOTER")}}},events:{onAfterTagAdd:this.onSelectorChange,onAfterTagRemove:this.onSelectorChange}})},onSelectorChange(){const t=this.selector.getDialog().getSelectedItems().map((({id:t})=>t));this.$emit("change",t)},mountSelector(){this.selector.renderTo(this.$refs.intersectionField)},destroySelector(){this.selector.getDialog().destroy();this.selector=null;this.$refs.intersectionField.innerHTML=""},getResource(t){return this.$store.getters["resources/getById"](t)},getResourceType(t){return this.$store.getters["resourceTypes/getById"](t)},tryShowAhaMoment(){if(ht.ahaMoments.shouldShow(ut.AhaMoment.ResourceIntersection)&&this.selector){at.Event.EventEmitter.unsubscribe("BX.Main.Popup:onAfterClose",this.tryShowAhaMoment);at.Event.EventEmitter.unsubscribe("BX.Main.Popup:onDestroy",this.tryShowAhaMoment);void this.showAhaMoment()}},async showAhaMoment(){await ht.ahaMoments.show({id:"booking-resource-intersection",title:this.loc("BOOKING_AHA_RESOURCE_INTERSECTION_TITLE"),text:this.loc("BOOKING_AHA_RESOURCE_INTERSECTION_TEXT"),article:ut.HelpDesk.AhaResourceIntersection,target:this.selector.getAddButton()});ht.ahaMoments.setShown(ut.AhaMoment.ResourceIntersection)},click(){if(!this.isFeatureEnabled){void Y.limit.show()}}},watch:{intersections(t){var e;if(!this.isEditingBookingMode){return}const o=(e=t[0])!=null?e:[];o.forEach((t=>{const e=this.getResource(t);this.selector.getDialog().addItem({id:e.id,entityId:ut.EntitySelectorEntity.Resource,title:e.name,subtitle:this.getResourceType(e.typeId).name,selected:true})}))},isLoaded(){this.tryShowAhaMoment()},resourcesIds(t,e){if(t.join(",")===e.join(",")){return}const o=e.filter((e=>!t.includes(e)));const i=t.filter((t=>!e.includes(t)));o.forEach((t=>{const e=this.selector.getDialog().getItem([ut.EntitySelectorEntity.Resource,t]);this.selector.getDialog().removeItem(e);const o=this.selector.getTags().find((e=>e.getId()===t));o==null?void 0:o.remove()}));i.forEach((t=>{const e=this.$store.getters[`${ut.Model.Resources}/getById`](t);const o=this.$store.getters[`${ut.Model.ResourceTypes}/getById`](e.typeId);this.selector.getDialog().addItem({id:t,entityId:ut.EntitySelectorEntity.Resource,title:e.name,subtitle:o.name,tabs:ut.EntitySelectorTab.Recent})}));this.onSelectorChange();this.tryShowAhaMoment()},resources:{handler(){this.selector.getDialog().getItems().forEach((t=>{const e=this.$store.getters[`${ut.Model.Resources}/getById`](t.getId());if(!e){return}const o=this.$store.getters[`${ut.Model.ResourceTypes}/getById`](e.typeId);t.setTitle(e.name);t.setSubtitle(o.name)}));this.selector.getTags().forEach((t=>{const e=this.$store.getters[`${ut.Model.Resources}/getById`](t.getId());if(!e){return}t.setTitle(e.name);t.render()}))},deep:true}},template:`\n\t\t<div\n\t\t\tref="intersectionField"\n\t\t\tclass="booking-booking-intersections-line"\n\t\t\tdata-id="booking-booking-intersections-line"\n\t\t\t@click="click"\n\t\t></div>\n\t`};const si={components:{Icon:U.BIcon,Multiple:oi,Single:ii},data(){return{IconSet:U.Set,intersectionModeMenuItemId:"booking-intersection-menu-mode"}},mounted(){this.menu=K.MenuManager.create("booking-intersection-menu",this.$refs.intersectionMenu,this.getMenuItems(),{closeByEsc:true,autoHide:true,cacheable:true})},unmounted(){this.menu.destroy();this.menu=null},methods:{showMenu(){if(this.isFeatureEnabled){this.menu.show()}else{void Y.limit.show()}},getMenuItems(){return[this.getIntersectionForAllItem(),{delimiter:true},this.getHelpDeskItem()]},getIntersectionForAllItem(){return{id:this.intersectionModeMenuItemId,dataset:{id:this.intersectionModeMenuItemId},text:this.loc("BOOKING_BOOKING_INTERSECTION_MENU_ALL"),className:this.isIntersectionForAll?"menu-popup-item menu-popup-item-accept":"menu-popup-item menu-popup-no-icon",onclick:()=>{this.menu.close();const t=!this.isIntersectionForAll;void this.$store.dispatch(`${ut.Model.Interface}/setIntersectionMode`,t);void q.optionService.setBool(ut.Option.IntersectionForAll,t)}}},getHelpDeskItem(){return{id:"booking-intersection-menu-info",dataset:{id:"booking-intersection-menu-info"},text:this.loc("BOOKING_BOOKING_INTERSECTION_MENU_HOW"),onclick:()=>{V.helpDesk.show(ut.HelpDesk.Intersection.code,ut.HelpDesk.Intersection.anchorCode)}}},async showIntersections(t,e=0){const o={...e===0?{}:this.intersections,[e]:t};await this.$store.dispatch(`${ut.Model.Interface}/setIntersections`,o);await j.busySlots.loadBusySlots()},toggleMenuItemActivityState(t){at.Dom.toggleClass(t.getContainer(),"menu-popup-item-accept");at.Dom.toggleClass(t.getContainer(),"menu-popup-no-icon")},updateScroll(){if(this.$refs.inner){this.$refs.inner.scrollLeft=this.scroll}}},watch:{async isIntersectionForAll(){await this.$store.dispatch(`${ut.Model.Interface}/setIntersections`,{});this.updateScroll();await j.busySlots.loadBusySlots();this.toggleMenuItemActivityState(this.menu.getMenuItem(this.intersectionModeMenuItemId))},scroll(){this.updateScroll()}},computed:{...rt.mapGetters({resourcesIds:`${ut.Model.Interface}/resourcesIds`,isFilterMode:`${ut.Model.Interface}/isFilterMode`,isEditingBookingMode:`${ut.Model.Interface}/isEditingBookingMode`,intersections:`${ut.Model.Interface}/intersections`,isIntersectionForAll:`${ut.Model.Interface}/isIntersectionForAll`,scroll:`${ut.Model.Interface}/scroll`,isLoaded:`${ut.Model.Interface}/isLoaded`,isFeatureEnabled:`${ut.Model.Interface}/isFeatureEnabled`}),hasIntersections(){return Object.values(this.intersections).some((t=>t.length>0))},disabled(){return!this.isLoaded||this.isFilterMode||this.isEditingBookingMode}},template:`\n\t\t<div class="booking-booking-intersections" :class="{'--disabled': disabled}">\n\t\t\t<div\n\t\t\t\tref="intersectionMenu"\n\t\t\t\tclass="booking-booking-intersections-left-panel"\n\t\t\t\t:class="{'--active': hasIntersections}"\n\t\t\t\t@click="showMenu"\n\t\t\t\tdata-id="booking-intersections-left-panel-menu"\n\t\t\t>\n\t\t\t\t<div class="ui-icon-set --double-rhombus"></div>\n\t\t\t\t<div v-if="!isFeatureEnabled" class="booking-lock-icon-container">\n\t\t\t\t\t<Icon :name="IconSet.LOCK"/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<Single v-if="isIntersectionForAll" @change="showIntersections"/>\n\t\t\t<template v-else>\n\t\t\t\t<div\n\t\t\t\t\tref="inner"\n\t\t\t\t\tclass="booking-booking-intersections-inner"\n\t\t\t\t\t@scroll="$store.dispatch('interface/setScroll', $refs.inner.scrollLeft)"\n\t\t\t\t>\n\t\t\t\t\t<div class="booking-booking-intersections-row">\n\t\t\t\t\t\t<div class="booking-booking-intersections-row-inner">\n\t\t\t\t\t\t\t<template v-for="resourceId of resourcesIds" :key="resourceId">\n\t\t\t\t\t\t\t\t<Multiple :resourceId="resourceId" @change="showIntersections"/>\n\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="booking-booking-intersections-inner-blank"></div>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t</div>\n\t`};const ni={data(){return{DateTimeFormat:tt.DateTimeFormat}},computed:rt.mapGetters({fromHour:"interface/fromHour",toHour:"interface/toHour",zoom:"interface/zoom"}),components:{Header:ei,Intersections:si,Grid:Ro},template:`\n\t\t<div\n\t\t\tid="booking-content"\n\t\t\tclass="booking"\n\t\t\t:style="{\n\t\t\t\t'--from-hour': fromHour,\n\t\t\t\t'--to-hour': toHour,\n\t\t\t\t'--zoom': zoom,\n\t\t\t}"\n\t\t\t:class="{\n\t\t\t\t'--zoom-is-less-than-07': zoom < 0.7,\n\t\t\t\t'--zoom-is-less-than-08': zoom < 0.8,\n\t\t\t\t'--am-pm-mode': DateTimeFormat.isAmPmMode(),\n\t\t\t}"\n\t\t>\n\t\t\t<Header/>\n\t\t\t<Intersections/>\n\t\t\t<Grid/>\n\t\t</div>\n\t`};const ri={name:"BookingMultipleButton",emits:["book"],props:{fetching:Boolean},computed:{text(){return this.loc("BOOKING_MULTI_BUTTON_LABEL")},size(){return it.ButtonSize.SMALL},color(){return it.ButtonColor.SUCCESS}},components:{UiButton:it.Button},template:`\n\t\t<UiButton\n\t\t\t:text\n\t\t\t:size\n\t\t\t:color\n\t\t\t:waiting="fetching"\n\t\t\t@click="$emit('book')"\n\t\t/>\n\t`};const ai={name:"MultiBookingItem",components:{UiButton:it.Button},emits:["remove-selected"],props:{id:{type:String,required:true},fromTs:{type:Number,required:true},toTs:{type:Number,required:true},resourceId:{type:Number,required:true}},computed:{...rt.mapGetters({offset:`${ut.Model.Interface}/offset`}),label(){return this.loc("BOOKING_MULTI_ITEM_TITLE",{"#DATE#":tt.DateTimeFormat.format("d M H:i",(this.fromTs+this.offset)/1e3),"#DURATION#":new et.Duration(this.toTs-this.fromTs).format()})},buttonColor(){return it.ButtonColor.LINK},buttonSize(){return it.ButtonSize.EXTRA_SMALL}},template:`\n\t\t<div class="booking--multi-booking--book">\n\t\t\t<label>\n\t\t\t\t{{ label }}\n\t\t\t</label>\n\t\t\t<button\n\t\t\t\t:class="[buttonSize, buttonColor, 'ui-btn ui-icon-set --cross-20']"\n\t\t\t\ttype="button"\n\t\t\t\t@click="$emit('remove-selected', this.id)">\n\t\t\t</button>\n\t\t</div>\n\t`};const li={name:"MultiBookingItemsList",components:{MultiBookingItem:ai},emits:["remove-selected"],computed:{selectedCells(){return this.$store.getters[`${ut.Model.Interface}/selectedCells`]},selectedCellsCount(){return Object.keys(this.selectedCells).length}},mounted(){this.ears=new J.Ears({container:this.$refs.wrapper,smallSize:true,className:"booking--multi-booking--items-ears",noScrollbar:true}).init()},watch:{selectedCellsCount:{handler(){setTimeout((()=>this.ears.toggleEars()),0)}}},template:`\n\t\t<div class="booking--multi-booking--book-list">\n\t\t\t<div ref="wrapper" class="booking--multi-booking--books-wrapper">\n\t\t\t\t<MultiBookingItem\n\t\t\t\t\tv-for="cell in selectedCells"\n\t\t\t\t\t:key="cell.id"\n\t\t\t\t\t:id="cell.id"\n\t\t\t\t\t:from-ts="cell.fromTs"\n\t\t\t\t\t:to-ts="cell.toTs"\n\t\t\t\t\t:resource-id="cell.resourceId"\n\t\t\t\t\t@remove-selected="$emit('remove-selected', $event)"/>\n\t\t\t</div>\n\t\t</div>\n\t`};const di={name:"AddClientButton",emits:["update:model-value"],props:{modelValue:{type:Array,required:true}},data(){return{isPopupShown:false}},computed:{...rt.mapGetters({getByClientData:`${ut.Model.Clients}/getByClientData`}),color(){return it.ButtonColor.LINK},size(){return it.ButtonSize.EXTRA_SMALL},label(){var t;if(this.modelValue.length===0){return this.loc("BOOKING_MULTI_CLIENT")}return this.loc("BOOKING_MULTI_CLIENT_WHIT_NAME",{"#NAME#":((t=this.modelValue.find((t=>t.name)))==null?void 0:t.name)||""})},currentClient(){if(this.modelValue.length===0){return null}return{contact:this.findClientByType(ut.CrmEntity.Contact),company:this.findClientByType(ut.CrmEntity.Company)}}},methods:{createClients(t){const e=t.map((t=>this.getByClientData(t)));this.$emit("update:model-value",e)},findClientByType(t){return this.modelValue.find((({type:e})=>e.code===t))}},components:{ClientPopup:ot.ClientPopup},template:`\n\t\t<button\n\t\t\t:class="['ui-btn', 'booking--multi-booking--client-button', color, size]"\n\t\t\ttype="button"\n\t\t\tref="button"\n\t\t\t@click="isPopupShown = !isPopupShown"\n\t\t>\n\t\t\t<i class="ui-icon-set --customer-card"></i>\n\t\t\t<span>{{ label }}</span>\n\t\t</button>\n\t\t<ClientPopup\n\t\t\tv-if="isPopupShown"\n\t\t\t:bind-element="$refs.button"\n\t\t\t:currentClient\n\t\t\t@create="createClients"\n\t\t\t@close="isPopupShown = false"/>\n\t`};const ci={name:"CancelButton",emits:["click"],setup(){return{color:it.ButtonColor.LINK,size:it.ButtonSize.EXTRA_SMALL}},template:`\n\t\t<button\n\t\t\t:class="['ui-btn', 'booking--multi-booking--cancel-button', color, size]"\n\t\t\ttype="button"\n\t\t\tref="button"\n\t\t\t@click="$emit('click')"\n\t\t>\n\t\t\t<i\n\t\t\t\tclass="ui-icon-set --cross-25"\n\t\t\t\tstyle="--ui-icon-set__icon-base-color: rgba(var(--ui-color-palette-white-base-rgb), 0.3);--ui-icon-set__icon-size: var(--ui-size-2xl)"></i>\n\t\t</button>\n\t`};const ui={name:"MultiBooking",data(){return{fetching:false,clients:[],externalData:[]}},async beforeMount(){this.clients=[];this.externalData=[];if(this.embedItems.length===0){return}const t=this.embedItems.find((t=>t.entityTypeId===ut.CrmEntity.Contact));const e=this.embedItems.find((t=>t.entityTypeId===ut.CrmEntity.Company));const o=this.embedItems.find((t=>t.entityTypeId===ut.CrmEntity.Deal));if(t){const e=await Q.clientService.getContactById(Number(t.value));if(e){this.clients.push(e)}}if(e){const t=await Q.clientService.getCompanyById(Number(e.value));if(t){this.clients.push(t)}}if(o){this.externalData.push(o)}},computed:{...rt.mapGetters({selectedCells:`${ut.Model.Interface}/selectedCells`,timezone:`${ut.Model.Interface}/timezone`,embedItems:`${ut.Model.Interface}/embedItems`})},methods:{removeSelected(t){if(Object.hasOwnProperty.call(this.selectedCells,t)){this.$store.dispatch(`${ut.Model.Interface}/removeSelectedCell`,this.selectedCells[t])}},async book(){const t=this.getBookings();if(t.length===0){return}this.fetching=true;await this.addCreatedFromEmbedBooking(t);const e=await Z.bookingService.addList(t);st.BookingAnalytics.sendAddMultiBookings(e.map((({id:t})=>t)));await this.addCreatedFromEmbedBooking(e);this.fetching=false;this.showNotification(e);await this.closeMultiBooking()},getBookings(){return Object.values(this.selectedCells).map((t=>({id:`tmp-id-${Date.now()}-${Math.random()}`,dateFromTs:t.fromTs,dateToTs:t.toTs,resourcesIds:[t.resourceId],timezoneFrom:this.timezone,timezoneTo:this.timezone,externalData:this.externalData,clients:this.clients})))},showNotification(t){const e=t.length;const o=BX.UI.Notification.Center.notify({id:at.Text.getRandom(),content:at.Loc.getMessagePlural("BOOKING_MULTI_CREATED",e,{"#QUANTITY#":e}),actions:[{title:this.loc("BOOKING_MULTI_CREATED_CANCEL"),events:{click:()=>this.reset(t,o)}}]})},async reset(t,e){await Z.bookingService.deleteList(t.map((({id:t})=>t)));e==null?void 0:e.close()},async closeMultiBooking(){await this.$store.dispatch(`${ut.Model.Interface}/clearSelectedCells`)},addCreatedFromEmbedBooking(t){this.$store.dispatch(`${ut.Model.Interface}/addCreatedFromEmbedBooking`,t.map((({id:t})=>t)))}},components:{BookingMultipleButton:ri,MultiBookingItemsList:li,AddClientButton:di,CancelButton:ci},template:`\n\t\t<Teleport to="#uiToolbarContainer" defer>\n\t\t\t<div class="booking--multi-booking--bar">\n\t\t\t\t<BookingMultipleButton :fetching @book="book"/>\n\t\t\t\t<MultiBookingItemsList @remove-selected="removeSelected"/>\n\t\t\t\t<div class="booking--multi-booking--divider-vertical"></div>\n\t\t\t\t<AddClientButton v-model="clients"/>\n\t\t\t\t<div class="booking--multi-booking--space"></div>\n\t\t\t\t<div class="booking--multi-booking--close">\n\t\t\t\t\t<div class="booking--multi-booking--divider-vertical"></div>\n\t\t\t\t\t<CancelButton @click="closeMultiBooking"/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</Teleport>\n\t`};const hi={data(){return{isBannerShown:false,bannerComponent:null}},computed:{...rt.mapGetters({canTurnOnDemo:`${ut.Model.Interface}/canTurnOnDemo`})},mounted(){if(ht.ahaMoments.shouldShow(ut.AhaMoment.Banner)){void this.showBanner()}},methods:{async showBanner(){dt.BannerDispatcher.critical.toQueue((async t=>{const{PromoBanner:e}=await at.Runtime.loadExtension("booking.component.promo-banner");this.bannerComponent=lt.shallowRef(e);this.isBannerShown=true;this.setShown();this.bannerClosed=new ct.Resolvable;await this.bannerClosed;t()}))},closeBanner(){this.isBannerShown=false;this.bannerClosed.resolve()},setShown(){ht.ahaMoments.setShown(ut.AhaMoment.Banner);st.BannerAnalytics.sendShowPopup()},buttonClick(){st.BannerAnalytics.sendClickEnable()}},template:`\n\t\t<component\n\t\t\tv-if="isBannerShown"\n\t\t\t:is="bannerComponent"\n\t\t\t:canTurnOnDemo="canTurnOnDemo"\n\t\t\t@buttonClick="buttonClick"\n\t\t\t@close="closeBanner"\n\t\t/>\n\t`};const pi={data(){return{isBannerShown:false,bannerComponent:null}},watch:{isShownTrialPopup(){if(ht.ahaMoments.shouldShow(ut.AhaMoment.TrialBanner)){if(!nt.AutoLauncher.isEnabled()){nt.AutoLauncher.enable()}void this.showBanner()}}},computed:{...rt.mapGetters({isShownTrialPopup:`${ut.Model.Interface}/isShownTrialPopup`})},methods:{async showBanner(){dt.BannerDispatcher.critical.toQueue((async t=>{const{TrialBanner:e}=await at.Runtime.loadExtension("booking.component.trial-banner");this.bannerComponent=lt.shallowRef(e);this.isBannerShown=true;this.bannerClosed=new ct.Resolvable;await this.bannerClosed;t()}))},closeBanner(){this.isBannerShown=false;ht.ahaMoments.setShown(ut.AhaMoment.TrialBanner);this.bannerClosed.resolve()}},template:`\n\t\t<component v-if="isBannerShown" :is="bannerComponent" @close="closeBanner"/>\n\t`};const gi={name:"BookingApp",props:{afterTitleContainer:HTMLElement,counterPanelContainer:HTMLElement,filterId:String},data(){return{loader:new o.Loader}},beforeMount(){m.mousePosition.init()},async mounted(){this.showLoader();Ot.setExpanded(true);this.addAfterTitle();st.SectionAnalytics.sendOpenSection();await Promise.all([s.dictionaryService.fetchData(),this.fetchPage(this.isEditingBookingMode?0:this.selectedDateTs/1e3)]);void this.$store.dispatch(`${ut.Model.Interface}/setIsLoaded`,true)},beforeUnmount(){m.mousePosition.destroy()},computed:{...rt.mapGetters({selectedDateTs:`${ut.Model.Interface}/selectedDateTs`,viewDateTs:`${ut.Model.Interface}/viewDateTs`,isFilterMode:`${ut.Model.Interface}/isFilterMode`,filteredBookingsIds:`${ut.Model.Interface}/filteredBookingsIds`,selectedCells:`${ut.Model.Interface}/selectedCells`,resourcesIds:`${ut.Model.Favorites}/get`,extraResourcesIds:`${ut.Model.Interface}/extraResourcesIds`,bookings:`${ut.Model.Bookings}/get`,intersections:`${ut.Model.Interface}/intersections`,editingBookingId:`${ut.Model.Interface}/editingBookingId`,isEditingBookingMode:`${ut.Model.Interface}/isEditingBookingMode`,offset:`${ut.Model.Interface}/offset`}),hasSelectedCells(){return Object.keys(this.selectedCells).length>0},editingBooking(){var t;return(t=this.$store.getters["bookings/getById"](this.editingBookingId))!=null?t:null}},methods:{async fetchPage(t=0){this.showLoader();await i.mainPageService.fetchData(t);if(this.extraResourcesIds.length>0){await z.resourceDialogService.loadByIds(this.extraResourcesIds,this.selectedDateTs/1e3)}this.hideLoader()},onActiveItem(t){if(this.ignoreConterPanel){return}this.$refs.filter.setPresetId(this.getPresetIdByCounterItem(t))},async applyFilter(){const t=this.$refs.filter.getPresetId();const e=this.$refs.filter.getFields();this.setCounterItem(this.getCounterItemByPresetId(t));this.showLoader();await Promise.all([this.$store.dispatch(`${ut.Model.Interface}/setFilterMode`,true),this.updateMarks(),Z.bookingService.filter(e)]);this.hideLoader()},async clearFilter(){this.setCounterItem(null);n.calendarService.clearFilterCache();Z.bookingService.clearFilterCache();void Promise.all([this.$store.dispatch(`${ut.Model.Interface}/setResourcesIds`,this.resourcesIds),this.$store.dispatch(`${ut.Model.Interface}/setFilterMode`,false),this.$store.dispatch(`${ut.Model.Interface}/setFilteredBookingsIds`,[]),this.$store.dispatch(`${ut.Model.Interface}/setFilteredMarks`,[])]);this.hideLoader()},setCounterItem(t){this.ignoreConterPanel=true;setTimeout((()=>{this.ignoreConterPanel=false}),0);this.$refs.countersPanel.setItem(t)},getCounterItemByPresetId(t){return{[Pt.NotConfirmed]:$t.NotConfirmed,[Pt.Delayed]:$t.Delayed}[t]},getPresetIdByCounterItem(t){return{[$t.NotConfirmed]:Pt.NotConfirmed,[$t.Delayed]:Pt.Delayed}[t]},addAfterTitle(){this.afterTitleContainer.append(this.$refs.afterTitle.$el)},showResourcesWithBookings(){const t=this.$store.getters[`${ut.Model.Bookings}/getByDateAndIds`](this.selectedDateTs,this.filteredBookingsIds).map((t=>t.resourcesIds[0])).filter(((t,e,o)=>o.indexOf(t)===e));void this.$store.dispatch(`${ut.Model.Interface}/setResourcesIds`,t)},async updateMarks(){if(this.isFilterMode){await this.updateFilterMarks()}else{await Promise.all([this.updateFreeMarks(),this.updateCounterMarks()])}},async updateFreeMarks(){const t=this.resourcesIds.map((t=>{var e,o;return[t,...(e=this.intersections[0])!=null?e:[],...(o=this.intersections[t])!=null?o:[]]}));await this.$store.dispatch(`${ut.Model.Interface}/setFreeMarks`,[]);await n.calendarService.loadMarks(this.viewDateTs,t)},async updateFilterMarks(){const t=this.$refs.filter.getFields();await this.$store.dispatch(`${ut.Model.Interface}/setFilteredMarks`,[]);await n.calendarService.loadFilterMarks(t)},async updateCounterMarks(){await n.calendarService.loadCounterMarks(this.viewDateTs)},showLoader(){void this.loader.show(this.$refs.baseComponent.$el)},hideLoader(){void this.loader.hide()}},watch:{selectedDateTs(){if(this.isFilterMode){void this.applyFilter()}else{void this.fetchPage(this.selectedDateTs/1e3)}},filteredBookingsIds(){if(this.isFilterMode){this.showResourcesWithBookings()}},isFilterMode(t){if(!t){void this.fetchPage(this.selectedDateTs/1e3)}},viewDateTs(){void this.updateMarks()},resourcesIds(){void this.updateMarks()},intersections(){void this.updateMarks()},editingBooking(t){var e,o;const i=(e=t==null?void 0:(o=t.resourcesIds)==null?void 0:o.slice(1))!=null?e:[];if(i.length>0){void this.$store.dispatch(`${ut.Model.Interface}/setIntersections`,{0:i})}}},components:{BaseComponent:ni,AfterTitle:At,Filter:Ft,CountersPanel:Rt,MultiBooking:ui,Banner:hi,Trial:pi},template:`\n\t\t<div>\n\t\t\t<MultiBooking v-if="hasSelectedCells"/>\n\t\t\t<AfterTitle ref="afterTitle"/>\n\t\t\t<Filter\n\t\t\t\t:filterId="filterId"\n\t\t\t\tref="filter"\n\t\t\t\t@apply="applyFilter"\n\t\t\t\t@clear="clearFilter"\n\t\t\t/>\n\t\t\t<CountersPanel\n\t\t\t\t:target="counterPanelContainer"\n\t\t\t\tref="countersPanel"\n\t\t\t\t@activeItem="onActiveItem"\n\t\t\t/>\n\t\t\t<BaseComponent ref="baseComponent"/>\n\t\t\t<Banner/>\n\t\t\t<Trial/>\n\t\t</div>\n\t`};var mi=babelHelpers.classPrivateFieldLooseKey("mountApplication");class bi{constructor(t){Object.defineProperty(this,mi,{value:fi});P.Core.setParams(t);void babelHelpers.classPrivateFieldLooseBase(this,mi)[mi]()}}async function fi(){await P.Core.init();const t=lt.BitrixVue.createApp(gi,P.Core.getParams());t.mixin(e.locMixin);t.use(P.Core.getStore());t.mount(P.Core.getParams().container)}t.Booking=bi})(this.BX.Booking=this.BX.Booking||{},BX.Booking.Component.Mixin,BX,BX.Booking.Provider.Service,BX.Booking.Provider.Service,BX.Booking.Provider.Service,BX.Event,BX.UI,BX.UI,BX.UI.Vue3.Components,BX.Booking.Lib,BX.UI.NotificationManager,BX.Booking.Provider.Service,BX.Booking.Component,BX.Booking.Component,BX.Booking.Lib,BX.Booking.Component,BX.Booking.Component,BX.Vue3.Directives,BX,BX.Booking.Lib,BX.Booking.Component,BX.Booking.Lib,BX.Booking.Component,BX.Booking.Lib,BX.Booking.Model,BX.Booking.Model,BX.Booking.Lib,BX.Booking.Lib,BX.Booking.Lib,BX.Booking,BX.UI.DatePicker,BX.Booking.Lib,BX.Booking.Lib,BX.Booking.Component,BX.UI.Dialogs,BX,BX.Booking.Provider.Service,BX,BX.Booking,BX.Booking.Provider.Service,BX.Booking.Lib,BX.Booking.Lib,BX.Main,BX.UI.IconSet,BX,BX.Booking.Provider.Service,BX.Booking.Lib,BX.Booking.Lib,BX.UI.EntitySelector,BX.Booking.Lib,BX.Booking.Provider.Service,BX.Booking.Provider.Service,BX.UI,BX.Main,BX.Booking.Lib,BX.Booking.Component,BX.Booking.Component,BX.Booking.Lib,BX.UI.AutoLaunch,BX.Vue3.Vuex,BX,BX.Vue3,BX.UI,BX.Booking.Lib,BX.Booking.Const,BX.Booking.Lib);
//# sourceMappingURL=booking.bundle.map.js